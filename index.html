<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Producción - Operaciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        turquoise: { 50:'#f0fdfa', 100:'#ccfbf1', 200:'#99f6e4', 300:'#5eead4', 400:'#2dd4bf', 500:'#14b8a6', 600:'#0d9488', 700:'#0f766e', 800:'#115e59', 900:'#134e4a' },
                        clinical: { 50:'#f0fdf4', 100:'#dcfce7', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#15803d' }
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(20, 184, 166, 0.15)', glow: '0 0 15px rgba(45, 212, 191, 0.3)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdfa; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .row-hover-effect { transition: all 0.2s ease-out; border-left: 3px solid transparent; }
        .row-hover-effect:hover { background-color: white; transform: scale(1.005); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left-color: #0d9488; z-index: 10; position: relative; }

        .group-box { @apply border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4; }
        .group-title { @apply text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1; }

        /* Animaciones */
        @keyframes ekgPulse { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .animate-ekg { animation: ekgPulse 2s infinite ease-in-out; }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-turquoise-200 selection:text-turquoise-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, getDocs, enableIndexedDbPersistence, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            Users: (p) => <Icon {...p} path={<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            LogOut: (p) => <Icon {...p} path={<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Settings: (p) => <Icon {...p} path={<circle cx="12" cy="12" r="3"></circle>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash: (p) => <Icon {...p} path={<polyline points="3 6 5 6 21 6"></polyline>} />,
            Printer: (p) => <Icon {...p} path={<polyline points="6 9 6 2 18 2 18 9"></polyline>} />,
            ChevronsRight: (p) => <Icon {...p} path={<polyline points="13 17 18 12 13 7"></polyline>} />,
            UserCog: (p) => <Icon {...p} path={<circle cx="12" cy="7" r="4"></circle>} />,
            Menu: (p) => <Icon {...p} path={<line x1="3" y1="12" x2="21" y2="12"></line>} />,
            X: (p) => <Icon {...p} path={<line x1="18" y1="6" x2="6" y2="18"></line>} />,
            FileText: (p) => <Icon {...p} path={<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            Minus: (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"></line>} />,
            Folder: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></>} />,
            LayoutDashboard: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Bot: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>} />,
            FolderPlus: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
        };

        // --- FIREBASE CONFIG (bitacora-217cf) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHrnTnsXg4P6faYSfP51gORVKPy-ExEw4",
            authDomain: "bitacora-217cf.firebaseapp.com",
            projectId: "bitacora-217cf",
            storageBucket: "bitacora-217cf.firebasestorage.app",
            messagingSenderId: "1080043869360",
            appId: "1:1080043869360:web:5932f72c30d8bb376cd775"
        };

        let app, auth, db;
        try { 
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app); 
            db = getFirestore(app); 
            enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err.code));
        } catch (err) { console.error("Firebase Init Error:", err); }

        // --- COMPONENTS ---

        const AnimatedCounter = ({ value }) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0; const end = parseInt(value, 10);
                if (isNaN(end)) return;
                if (start === end) { setCount(end); return; }
                const duration = 1000; const incrementTime = 20; const stepAmount = Math.ceil(end / (duration / incrementTime));
                let timer = setInterval(() => {
                    start += stepAmount;
                    if (start >= end) { setCount(end); clearInterval(timer); } else { setCount(start); }
                }, incrementTime);
                return () => clearInterval(timer);
            }, [value]);
            return <span>{count}</span>;
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[95vh] modal-animate`}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col modal-animate p-6 text-center">
                        <h3 className="text-lg font-medium text-slate-900 mb-2">{title}</h3>
                        <p className="text-sm text-slate-500 mb-6">{message}</p>
                        <div className="flex justify-center gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-sm">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- BLOCK: LOGIN (MODIFICADO - CON INDICADOR DE CONEXIÓN) ---
        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            // Listener de estado de conexión
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            const handleLogin = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                const userKey = username.trim().toLowerCase();
                
                if (userKey === 'superadmin' && password === 'superadmin') { 
                    proceedLogin('superadmin', 'Super Usuario', 'Operaciones'); return; 
                }
                
                try {
                    const q = query(collection(db, 'prod_users'), where('username', '==', userKey));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                             proceedLogin(userData.role, userData.nombre || userData.username, 'Operaciones');
                        } else { setError("Contraseña incorrecta."); setLoading(false); }
                    } else { setError("Usuario no encontrado."); setLoading(false); }
                } catch (err) { 
                    console.error(err);
                    setError("Error de conexión. Verifique su red."); setLoading(false); 
                }
            };
            
            const proceedLogin = async (role, name, dept) => {
                 try { await addDoc(collection(db, 'prod_access_logs'), { username: name, role: role, timestamp: serverTimestamp() }); } catch (e) {}
                 onLogin(role, name, dept);
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6 relative">
                    {/* Indicador de Conexión */}
                    <div className={`absolute top-6 right-6 px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-sm transition-all ${isOnline ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                        {isOnline ? <Icons.Wifi size={16}/> : <Icons.WifiOff size={16}/>}
                        {isOnline ? 'Conectado' : 'Sin Conexión'}
                    </div>

                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50 relative z-10">
                        <div className="text-center mb-10">
                            <div className="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-ekg"><Icons.Activity size={40} /></div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font">Bitácora <span className="text-turquoise-600">Producción</span></h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Dpto. Operaciones</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold border border-red-100">{error}</div>}
                            <div className="space-y-4">
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Usuario</label><input type="text" className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" value={username} onChange={(e) => setUsername(e.target.value)} required /></div>
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contraseña</label><input type="password" className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" value={password} onChange={(e) => setPassword(e.target.value)} required /></div>
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-turquoise-500 to-clinical-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect">{loading ? 'Verificando...' : 'Iniciar Sesión'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- BLOCK: CONFIGURACION (INTACTO) ---
        const ConfigBlock = ({ medicines, onAddList }) => {
            const [rawText, setRawText] = useState('');
            const processText = () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const uniqueMeds = [...new Set(lines)];
                if(uniqueMeds.length > 0) { onAddList(uniqueMeds); setRawText(''); alert(`Se procesaron ${uniqueMeds.length} medicamentos.`); }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"><Icons.Settings size={24} /></div>
                        <div><h3 className="font-bold text-xl text-slate-800 brand-font">Configuración</h3><p className="text-xs font-semibold text-turquoise-600">Catálogo de Medicamentos</p></div>
                    </div>
                    <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto">
                        <div>
                            <h4 className="font-bold text-slate-700 mb-2">Carga Masiva</h4>
                            <p className="text-xs text-slate-400 mb-4">Pegue la lista de medicamentos (uno por línea) desde Excel o CSV.</p>
                            <textarea className="w-full h-64 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-turquoise-400" placeholder="AMOXICILINA 500MG&#10;PARACETAMOL&#10;..." value={rawText} onChange={e => setRawText(e.target.value)}></textarea>
                            <button onClick={processText} className="mt-4 bg-turquoise-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-turquoise-700 w-full btn-hover-effect flex justify-center gap-2 items-center"><Icons.Upload size={16}/> Procesar Lista</button>
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-700 mb-2">Catálogo Actual ({medicines.length})</h4>
                            <div className="h-64 overflow-y-auto border rounded-xl bg-white p-2 space-y-1">
                                {medicines.map((m, i) => <div key={i} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0">{m.name}</div>)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- BLOCK: USUARIOS (MODIFICADO - EDICIÓN Y MODAL) ---
        const UserManagementBlock = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [formData, setFormData] = useState({ username: '', password: '', role: 'digitador', nombre: '' });
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);

            const openNew = () => { setEditingId(null); setFormData({ username: '', password: '', role: 'digitador', nombre: '' }); setShowModal(true); };
            const openEdit = (u) => { setEditingId(u.id); setFormData(u); setShowModal(true); };
            const closeModal = () => { setShowModal(false); setEditingId(null); };

            const handleSubmit = (e) => {
                e.preventDefault();
                const uData = {...formData, departamento: 'Operaciones'};
                if (editingId) {
                    onUpdateUser(editingId, uData);
                } else {
                    onAddUser(uData);
                }
                closeModal();
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"><Icons.UserCog size={24} /></div>
                            <div><h3 className="font-bold text-xl text-slate-800 brand-font">Usuarios</h3><p className="text-xs font-semibold text-turquoise-600">{users.length} Activos</p></div>
                        </div>
                        <button onClick={openNew} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"><Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo Usuario</span></button>
                    </div>

                    <Modal isOpen={showModal} onClose={closeModal} title={editingId ? "Editar Usuario" : "Nuevo Usuario"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" value={formData.nombre} onChange={e=>setFormData({...formData, nombre:e.target.value})} required /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Usuario (Login)</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" value={formData.username} onChange={e=>setFormData({...formData, username:e.target.value.toLowerCase()})} required /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Contraseña</label><input type="password" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" value={formData.password} onChange={e=>setFormData({...formData, password:e.target.value})} placeholder={editingId ? "Dejar vacío para mantener" : ""} required={!editingId} /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Rol</label><select className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" value={formData.role} onChange={e=>setFormData({...formData, role:e.target.value})}><option value="digitador">Digitador</option><option value="admin">Administrador</option><option value="superadmin">Super Admin</option></select></div>
                            <button type="submit" className="w-full bg-turquoise-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-turquoise-700 btn-hover-effect mt-4">{editingId ? 'Actualizar' : 'Crear Usuario'}</button>
                        </form>
                    </Modal>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        <div className="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
                            {users.map(u => (
                                <div key={u.id} className="p-4 rounded-xl border border-slate-200 flex flex-col gap-3 bg-white hover:shadow-md transition-shadow relative group">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${u.role === 'digitador' ? 'bg-clinical-500' : 'bg-turquoise-600'}`}>{u.username.substring(0,2).toUpperCase()}</div>
                                        <div><div className="font-bold text-sm text-slate-800">{u.nombre || u.username}</div><div className="text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded w-fit mt-1">@{u.username} • {u.role}</div></div>
                                    </div>
                                    <div className="border-t border-slate-100 pt-2 flex justify-end gap-2">
                                        <button onClick={() => openEdit(u)} className="p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Editar"><Icons.Edit size={18}/></button>
                                        <button onClick={() => setConfirmData({ title: 'Eliminar Usuario', msg: `¿Desea eliminar a ${u.username}?`, action: () => onDeleteUser(u.id) })} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar"><Icons.Trash size={18}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- BLOCK: DASHBOARD (INTACTO) ---
        const DashboardBlock = ({ setView, stats, userName }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(()=>setTime(new Date()),1000); return ()=>clearInterval(t); }, []);
            
            const cards = [
                { id: 'reports', label: 'Reportes y Carpetas', icon: Icons.List, color: 'bg-amber-500', desc: 'Ver kits por fecha' },
                { id: 'pacientes', label: 'Gestión de Pacientes', icon: Icons.Users, color: 'bg-turquoise-500', desc: 'Crear kits por DH' },
            ];

            return (
                <div className="w-full max-w-6xl mx-auto space-y-8 animate-in">
                    <div className="bg-gradient-to-r from-turquoise-600 to-clinical-600 rounded-3xl p-8 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10"><h1 className="text-3xl font-bold brand-font mb-2">¡Hola, {userName}!</h1><p className="opacity-90 text-sm font-medium uppercase tracking-wider">Operaciones - Bitácora de Producción</p></div>
                        <div className="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform origin-bottom-right"></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex flex-col justify-center items-center text-center">
                            <div className="text-5xl font-mono font-bold text-slate-700 tracking-widest mb-2">{time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <div className="text-sm text-slate-400 font-medium uppercase">{time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'})}</div>
                        </div>
                        <div className="md:col-span-2 grid grid-cols-2 gap-4">
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-turquoise-50 text-turquoise-600 rounded-2xl"><Icons.Box size={32}/></div>
                                <div><div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.totalKits}/></div><div className="text-xs text-slate-400 font-bold uppercase">Kits Totales</div></div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-clinical-50 text-clinical-600 rounded-2xl"><Icons.Calendar size={32}/></div>
                                <div><div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.todayKits}/></div><div className="text-xs text-slate-400 font-bold uppercase">Armados Hoy</div></div>
                            </div>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-700 brand-font mt-8">Accesos Directos</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        {cards.map(c => (
                            <button key={c.id} onClick={() => setView(c.id)} className="group relative bg-white p-6 rounded-3xl shadow-soft border border-slate-100 hover:shadow-xl transition-all duration-300 text-left hover:-translate-y-1 overflow-hidden">
                                <div className={`absolute top-0 right-0 w-24 h-24 ${c.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                <div className={`w-12 h-12 rounded-2xl ${c.color} flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`}><c.icon size={24} /></div>
                                <h4 className="font-bold text-lg text-slate-800 mb-1 group-hover:text-turquoise-600 transition-colors">{c.label}</h4>
                                <p className="text-xs text-slate-400">{c.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- BLOCK: PACIENTES (INTACTO) ---
        const PatientManagementBlock = ({ patients, kits, medicines, onAddPatient, onUpdatePatient, onDeletePatient, onSaveKit, onDeleteKit, currentUser, userRole }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [showPatientForm, setShowPatientForm] = useState(false);
            const [editingPatientId, setEditingPatientId] = useState(null);
            
            // Kit Form State
            const initialKit = { dni: '', nombre: '', telefono1: '', telefonoRef: '', fechaArmado: new Date().toISOString().split('T')[0], fechaEntrega: '', horaOperaciones: '', fechaEnvio: '', contactCenter: '', triggerMeds: '', medicamentos: [] };
            const [kitData, setKitData] = useState(initialKit);
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);
            const [viewingKit, setViewingKit] = useState(null);
            const [confirmData, setConfirmData] = useState(null);

            // Patient Form State
            const initialPatient = { nombres: '', apellidos: '', dni: '', nAfiliacion: '', fechaNacimiento: '', edad: '', patrono: '', tipoSeguro: 'Asegurado', sexo: 'M', domicilio: '', telefonos: '' };
            const [patientForm, setPatientForm] = useState(initialPatient);

            const filteredPatients = patients.filter(p => (p.nombres?.toLowerCase().includes(searchTerm.toLowerCase()) || p.apellidos?.toLowerCase().includes(searchTerm.toLowerCase()) || p.dni?.includes(searchTerm)));
            const patientKits = selectedPatient ? kits.filter(k => k.patientId === selectedPatient.id) : [];

            // Handlers
            const handlePatientSubmit = (e) => { e.preventDefault(); if (editingPatientId) onUpdatePatient(editingPatientId, patientForm); else onAddPatient(patientForm); closePatientForm(); };
            const closePatientForm = () => { setPatientForm(initialPatient); setEditingPatientId(null); setShowPatientForm(false); };
            const openEditPatient = (e, p) => { e.stopPropagation(); setPatientForm(p); setEditingPatientId(p.id); setShowPatientForm(true); };

            const handleKitSubmit = (e) => {
                e.preventDefault();
                const finalData = { ...kitData, digitador: currentUser.name };
                if (!editingKitId && !finalData.horaOperaciones) {
                    finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
                }
                
                if (editingKitId) onSaveKit(editingKitId, finalData, selectedPatient.id, true);
                else onSaveKit(null, finalData, selectedPatient.id, false);
                closeKitForm();
            };
            const closeKitForm = () => { setKitData(initialKit); setEditingKitId(null); setShowKitForm(false); };
            const openNewKit = () => {
                setKitData({ ...initialKit, dni: selectedPatient.dni, nombre: `${selectedPatient.nombres} ${selectedPatient.apellidos}`, telefono1: selectedPatient.telefonos, fechaArmado: new Date().toISOString().split('T')[0] });
                setShowKitForm(true);
            };
            const openEditKit = (k) => { setKitData(k); setEditingKitId(k.id); setShowKitForm(true); };

            const handleMedChange = (idx, field, val) => {
                const newMeds = [...kitData.medicamentos];
                newMeds[idx] = { ...newMeds[idx], [field]: val };
                setKitData({...kitData, medicamentos: newMeds});
            };
            const handleTriggerMeds = (val) => {
                const parsed = parseInt(val, 10);
                const count = isNaN(parsed) ? 0 : parsed;
                const safeCount = Math.min(Math.max(count, 0), 30);
                const currentMeds = kitData.medicamentos || [];
                let newMeds = [];
                if (safeCount > currentMeds.length) {
                    newMeds = [...currentMeds, ...Array(safeCount - currentMeds.length).fill({ nombre: '', idReceta: '', cantidad: '', refrigerado: false, cantRefri: '' })];
                } else {
                    newMeds = currentMeds.slice(0, safeCount);
                }
                setKitData({...kitData, triggerMeds: val, medicamentos: newMeds});
            };

            const calculateAge = (birthDate) => {
                if (!birthDate) return '';
                const today = new Date(); const birth = new Date(birthDate);
                let age = today.getFullYear() - birth.getFullYear();
                const m = today.getMonth() - birth.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
                return age >= 0 ? age : 0;
            };

            if (selectedPatient) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft h-full flex flex-col animate-in border-0 bg-white">
                        <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setSelectedPatient(null)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect"><Icons.ArrowLeft size={20} /></button>
                                <div><h3 className="font-bold text-lg text-slate-800 brand-font leading-none">{selectedPatient.nombres} {selectedPatient.apellidos}</h3><p className="text-[10px] text-slate-400 font-mono mt-0.5">DNI: {selectedPatient.dni}</p></div>
                            </div>
                            <button onClick={openNewKit} className="flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect bg-turquoise-600 hover:bg-turquoise-700 text-white"><Icons.FolderPlus size={16}/> Nuevo Kit</button>
                        </div>

                        <Modal isOpen={showKitForm} onClose={closeKitForm} title={editingKitId ? "Editar Kit" : "Nuevo Kit de Producción"} maxWidth="max-w-4xl">
                            <form onSubmit={handleKitSubmit} className="space-y-6">
                                <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                    <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Grupo 1: Datos Generales</h5>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI</label><input type="text" className="w-full p-2 border rounded text-sm bg-white" value={kitData.dni} onChange={e=>setKitData({...kitData, dni:e.target.value})} required /></div>
                                        <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre</label><input type="text" className="w-full p-2 border rounded text-sm bg-white" value={kitData.nombre} onChange={e=>setKitData({...kitData, nombre:e.target.value})} required /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Teléfono 1</label><input type="text" className="w-full p-2 border rounded text-sm bg-white" value={kitData.telefono1} onChange={e=>setKitData({...kitData, telefono1:e.target.value})} /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Teléfono Ref</label><input type="text" className="w-full p-2 border rounded text-sm bg-white" value={kitData.telefonoRef} onChange={e=>setKitData({...kitData, telefonoRef:e.target.value})} /></div>
                                    </div>
                                </div>
                                <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                    <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Grupo 2: Logística</h5>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Armado</label><input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaArmado} onChange={e=>setKitData({...kitData, fechaArmado:e.target.value})} required /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Entrega</label><input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntrega} onChange={e=>setKitData({...kitData, fechaEntrega:e.target.value})} /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Hora Operaciones</label><input type="time" className="w-full p-2 border rounded text-sm bg-white" value={kitData.horaOperaciones} onChange={e=>setKitData({...kitData, horaOperaciones:e.target.value})} /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center</label><select className="w-full p-2 border rounded text-sm bg-white" value={kitData.contactCenter} onChange={e=>setKitData({...kitData, contactCenter:e.target.value})}><option value="">Seleccione...</option><option value="Agente 1">Agente 1</option><option value="Agente 2">Agente 2</option></select></div>
                                        <div className="md:col-span-4"><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Digitador</label><input type="text" className="w-full p-2 border rounded text-sm bg-slate-200 text-slate-500" value={currentUser.name} disabled /></div>
                                    </div>
                                </div>
                                <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                    <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-1">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Grupo 3: Medicamentos</h5>
                                        <div className="flex items-center gap-2"><label className="text-xs font-bold text-slate-500">% Medicamentos:</label><input type="text" className="w-20 p-1 border rounded text-center font-bold bg-white" value={kitData.triggerMeds} onChange={e=>handleTriggerMeds(e.target.value)} placeholder="Ej: 6/9" /></div>
                                    </div>
                                    <div className="space-y-3">
                                        {kitData.medicamentos.map((med, idx) => (
                                            <div key={idx} className="bg-white p-3 rounded-lg border shadow-sm flex flex-col md:flex-row gap-2 items-end">
                                                <div className="flex-1 w-full"><label className="text-[10px] font-bold text-slate-400 block">Medicamento</label><input list="medsList" className="w-full p-1.5 border rounded text-xs" value={med.nombre} onChange={e => handleMedChange(idx, 'nombre', e.target.value)} placeholder="Buscar..." /></div>
                                                <div className="w-24"><label className="text-[10px] font-bold text-slate-400 block">ID Receta</label><input type="text" className="w-full p-1.5 border rounded text-xs" value={med.idReceta} onChange={e => handleMedChange(idx, 'idReceta', e.target.value)} /></div>
                                                <div className="w-20"><label className="text-[10px] font-bold text-slate-400 block">Cant.</label><input type="number" className="w-full p-1.5 border rounded text-xs" value={med.cantidad} onChange={e => handleMedChange(idx, 'cantidad', e.target.value)} /></div>
                                                <div className="flex items-center gap-1 h-8 bg-slate-50 px-2 rounded border"><input type="checkbox" checked={med.refrigerado} onChange={e => handleMedChange(idx, 'refrigerado', e.target.checked)} /><span className="text-[10px] font-bold text-slate-500">Refri</span></div>
                                                {med.refrigerado && (<div className="w-20"><label className="text-[10px] font-bold text-slate-400 block">Cant. Ref</label><input type="number" className="w-full p-1.5 border rounded text-xs bg-blue-50 border-blue-200" value={med.cantRefri} onChange={e => handleMedChange(idx, 'cantRefri', e.target.value)} /></div>)}
                                            </div>
                                        ))}
                                        {kitData.medicamentos.length === 0 && <div className="text-center text-xs text-slate-400 italic py-4">Ingrese cantidad (ej: 6 o 6/9) para agregar líneas.</div>}
                                    </div>
                                </div>
                                <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar Kit</button>
                            </form>
                            <datalist id="medsList">{medicines.map((m, i) => <option key={i} value={m.name} />)}</datalist>
                        </Modal>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 p-5 relative z-10">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3"><h2 className="text-xl font-bold text-slate-800">Historial de Producción</h2><div className="text-2xl font-bold text-turquoise-600">{patientKits.length} <span className="text-sm text-slate-400 font-normal">Kits</span></div></div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div><span className="text-[10px] font-bold text-slate-400 block">Afiliación</span>{selectedPatient.nAfiliacion}</div>
                                    <div className="md:col-span-3"><span className="text-[10px] font-bold text-slate-400 block">Domicilio</span>{selectedPatient.domicilio}</div>
                                </div>
                            </div>
                            <div className="grid gap-3">
                                {patientKits.map(kit => (
                                    <div key={kit.id} className="p-4 rounded-xl border border-slate-100 bg-white shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4">
                                        <div className="flex-1">
                                            <div className="flex flex-wrap items-center gap-2 mb-2">
                                                <span className="bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold border border-turquoise-100"><Icons.Calendar size={12} className="inline mr-1"/> {kit.fechaArmado}</span>
                                                <span className="bg-slate-100 text-slate-500 px-2 py-1 rounded text-xs font-bold">Meds: {kit.triggerMeds}</span>
                                                <span className="text-xs text-slate-400 font-mono">Hora Ops: {kit.horaOperaciones || '--:--'}</span>
                                            </div>
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {kit.medicamentos?.slice(0,4).map((m,i) => <span key={i} className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border">{m.nombre} ({m.cantidad})</span>)}
                                                {(kit.medicamentos?.length > 4) && <span className="text-[10px] text-slate-400 px-1">...</span>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end sm:justify-center items-start">
                                            <button onClick={() => openEditKit(kit)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect"><Icons.Edit size={18}/></button>
                                            <button onClick={() => {if(confirm("¿Eliminar Kit?")) onDeleteKit(kit.id);}} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect"><Icons.Trash size={18}/></button>
                                        </div>
                                    </div>
                                ))}
                                {patientKits.length === 0 && <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">No hay kits registrados para este paciente.</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/50 backdrop-blur-md">
                        <div className="flex items-center gap-4 w-full md:w-auto"><div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"><Icons.Users size={24}/></div><div><h3 className="font-bold text-xl text-slate-800 brand-font">Gestión de Pacientes</h3><p className="text-xs font-semibold text-turquoise-600">{filteredPatients.length} Registros</p></div></div>
                        <div className="flex gap-3 w-full md:w-auto items-center">
                            <div className="relative w-full sm:w-64"><div className="absolute left-3 top-2.5 text-slate-400"><Icons.Search size={16}/></div><input type="text" placeholder="Buscar DNI o Nombre..." className="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:border-turquoise-200 transition-all focus:shadow-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                            <button onClick={()=>setShowPatientForm(true)} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"><Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo</span></button>
                        </div>
                    </div>
                    <Modal isOpen={showPatientForm} onClose={closePatientForm} title={editingPatientId ? "Editar Paciente" : "Nuevo Derechohabiente"} maxWidth="max-w-2xl">
                        <form onSubmit={handlePatientSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">DNI <span className="text-red-500">*</span></label><input type="text" required className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.dni} onChange={e=>setPatientForm({...patientForm, dni:e.target.value})} maxLength={13} /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">N° Afiliación</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.nAfiliacion} onChange={e=>setPatientForm({...patientForm, nAfiliacion:e.target.value})} /></div></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombres <span className="text-red-500">*</span></label><input type="text" required className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.nombres} onChange={e=>setPatientForm({...patientForm, nombres:e.target.value.toUpperCase()})} /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Apellidos <span className="text-red-500">*</span></label><input type="text" required className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.apellidos} onChange={e=>setPatientForm({...patientForm, apellidos:e.target.value.toUpperCase()})} /></div></div>
                            <div className="grid grid-cols-3 gap-4"><div className="col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Fecha Nacimiento</label><input type="date" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.fechaNacimiento} onChange={e=>setPatientForm({...patientForm, fechaNacimiento:e.target.value, edad: calculateAge(e.target.value)})} /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Edad</label><input type="text" readOnly className="w-full p-2.5 rounded-xl border border-slate-200 bg-slate-100 text-center font-bold text-sm" value={patientForm.edad} /></div></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Sexo</label><select className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white" value={patientForm.sexo} onChange={e=>setPatientForm({...patientForm, sexo:e.target.value})}><option value="M">Masculino</option><option value="F">Femenino</option></select></div><div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tipo Seguro</label><select className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white" value={patientForm.tipoSeguro} onChange={e=>setPatientForm({...patientForm, tipoSeguro:e.target.value})}><option value="Asegurado">Asegurado</option><option value="Beneficiario">Beneficiario</option><option value="Jubilado">Jubilado</option></select></div></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Patrono</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.patrono} onChange={e=>setPatientForm({...patientForm, patrono:e.target.value})} /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Domicilio</label><textarea rows="2" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm resize-none" value={patientForm.domicilio} onChange={e=>setPatientForm({...patientForm, domicilio:e.target.value})}></textarea></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Teléfonos</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.telefonos} onChange={e=>setPatientForm({...patientForm, telefonos:e.target.value})} /></div>
                            <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg mt-2 btn-hover-effect">{editingPatientId ? 'Actualizar' : 'Guardar'}</button>
                        </form>
                    </Modal>
                    <div className="h-full overflow-y-auto bg-white p-6"><div className="overflow-x-auto"><table className="w-full text-left border-collapse min-w-[800px]"><thead className="bg-slate-50/80 sticky top-0 z-10"><tr className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100"><th className="px-6 py-4 pl-8">Paciente</th><th className="px-6 py-4">Identificación</th><th className="px-6 py-4">Edad / Sexo</th><th className="px-6 py-4 text-right pr-8">Acción</th></tr></thead><tbody className="divide-y divide-slate-50">{filteredPatients.map(p=>(<tr key={p.id} onClick={() => setSelectedPatient(p)} className={`row-hover-effect cursor-pointer`}><td className="px-6 py-5 pl-8"><div className="font-bold text-base text-slate-800 tracking-tight">{p.nombres} {p.apellidos}</div><div className="text-xs text-turquoise-600 font-medium mt-1 flex items-center gap-1">Ver Kits <Icons.ChevronsRight size={14}/></div></td><td className="px-6 py-5"><div className="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit mb-1 font-bold">{p.dni}</div><div className="text-xs text-slate-400">Afiliación: {p.nAfiliacion}</div></td><td className="px-6 py-5 text-sm font-semibold text-slate-600">{p.edad} Años / {p.sexo}</td><td className="px-6 py-5 text-right pr-8" onClick={(e)=>e.stopPropagation()}><div className="flex justify-end gap-2"><button onClick={(e) => openEditPatient(e, p)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect"><Icons.Edit size={20}/></button>{(userRole==='superadmin'||userRole==='admin') && <button onClick={()=>setConfirmData({ title: 'Eliminar', msg: `¿Eliminar a ${p.nombres}?`, action: () => onDeletePatient(p.id) })} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect"><Icons.Trash size={20}/></button>}</div></td></tr>))}</tbody></table></div></div>
                </div>
            );
        };

        // --- BLOCK: REPORTES (INTACTO) ---
        const ReportsBlock = ({ kits, patients }) => {
            const [selectedDate, setSelectedDate] = useState(null);
            const dates = useMemo(() => {
                const map = {};
                kits.forEach(k => { const d = k.fechaArmado || 'Sin Fecha'; if(!map[d]) map[d]=0; map[d]++; });
                return Object.entries(map).sort((a,b) => b[0].localeCompare(a[0]));
            }, [kits]);
            const currentList = selectedDate ? kits.filter(k => k.fechaArmado === selectedDate) : [];

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <button onClick={() => selectedDate ? setSelectedDate(null) : null} className={`p-2 rounded-xl transition-colors ${selectedDate ? 'hover:bg-slate-100 text-slate-500' : 'opacity-0 pointer-events-none'}`}><Icons.ArrowLeft size={20}/></button>
                        <div><h3 className="font-bold text-xl text-slate-800 brand-font">{selectedDate ? `Kits del ${selectedDate}` : 'Reportes y Carpetas'}</h3><p className="text-xs font-semibold text-turquoise-600">{selectedDate ? `${currentList.length} Registros` : 'Organizado por Fecha'}</p></div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {!selectedDate ? (
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                {dates.map(([date, count]) => (
                                    <div key={date} onClick={() => setSelectedDate(date)} className="bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer flex flex-col items-center text-center gap-3 transition-all group">
                                        <div className="bg-amber-100 p-3 rounded-full text-amber-600 group-hover:scale-110 transition-transform"><Icons.Folder size={32}/></div>
                                        <div><h4 className="font-bold text-sm text-slate-700">{date}</h4><p className="text-[10px] text-slate-400 mt-1">{count} Kits</p></div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="overflow-x-auto bg-white rounded-xl border border-slate-100 shadow-sm">
                                <table className="w-full text-left border-collapse min-w-[800px]">
                                    <thead className="bg-slate-50 border-b border-slate-200"><tr className="text-xs font-bold text-slate-500 uppercase"><th className="px-6 py-3">Paciente</th><th className="px-6 py-3">DNI</th><th className="px-6 py-3">Digitador</th><th className="px-6 py-3">Meds</th><th className="px-6 py-3 text-right">Hora</th></tr></thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {currentList.map(k => (
                                            <tr key={k.id} className="hover:bg-slate-50">
                                                <td className="px-6 py-3 font-bold text-slate-700 text-sm">{k.nombre}</td>
                                                <td className="px-6 py-3 text-xs font-mono">{k.dni}</td>
                                                <td className="px-6 py-3 text-xs italic text-slate-500">{k.digitador}</td>
                                                <td className="px-6 py-3"><span className="bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold">{k.triggerMeds}</span></td>
                                                <td className="px-6 py-3 text-right text-xs font-mono">{k.horaOperaciones || '--:--'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [view, setView] = useState('dashboard');
            
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [users, setUsers] = useState([]);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            const handleLogout = () => { signOut(auth); sessionStorage.clear(); setRole(null); setUserName(null); };
            const handleLogin = (r, n) => { setRole(r); setUserName(n); sessionStorage.setItem('leq_role', r); sessionStorage.setItem('leq_username', n); };

            useEffect(() => {
                if (!role || !db) return;
                const unsubPatients = onSnapshot(collection(db, 'prod_patients'), s => setPatients(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0))));
                const unsubKits = onSnapshot(collection(db, 'prod_kits'), s => setKits(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> new Date(b.fechaArmado) - new Date(a.fechaArmado))));
                const unsubMeds = onSnapshot(collection(db, 'prod_medicines'), s => setMedicines(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.name.localeCompare(b.name))));
                let unsubUsers = () => {}; if (role === 'admin' || role === 'superadmin') unsubUsers = onSnapshot(collection(db, 'prod_users'), s => setUsers(s.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => { unsubPatients(); unsubKits(); unsubMeds(); unsubUsers(); };
            }, [role]);

            const addPatient = async (d) => await addDoc(collection(db, 'prod_patients'), {...d, createdAt:serverTimestamp()});
            const updatePatient = async (id, d) => await updateDoc(doc(db, 'prod_patients', id), d);
            const deletePatient = async (id) => await deleteDoc(doc(db, 'prod_patients', id));
            
            const saveKit = async (id, data, pid, isUpdate) => {
                if(isUpdate) await updateDoc(doc(db, 'prod_kits', id), data);
                else await addDoc(collection(db, 'prod_kits'), {...data, patientId: pid, createdAt: serverTimestamp()});
            };
            const deleteKit = async (id) => await deleteDoc(doc(db, 'prod_kits', id));
            const addMedsList = async (list) => { for(const name of list) await addDoc(collection(db, 'prod_medicines'), { name }); };
            
            const addUser = async (u) => await addDoc(collection(db, 'prod_users'), u);
            const updateUser = async (id, u) => await updateDoc(doc(db, 'prod_users', id), u); // Added update function
            const deleteUser = async (id) => await deleteDoc(doc(db, 'prod_users', id));

            if (!role) return <LoginBlock onLogin={handleLogin} />;

            const NavItem = ({ id, label, icon: Icon }) => (
                <button onClick={() => { setView(id); setMobileMenuOpen(false); }} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold group relative overflow-hidden btn-hover-effect ${view === id ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`}>
                    <Icon size={20} className={view === id ? 'text-white' : 'text-turquoise-400 group-hover:text-white'} /><span className={`whitespace-nowrap transition-opacity duration-300 ${sidebarCollapsed ? 'hidden opacity-0 w-0' : 'block opacity-100'}`}>{label}</span>
                </button>
            );

            const stats = { totalKits: kits.length, todayKits: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length };

            return (
                <div className="flex h-screen bg-[#f0fdfa] font-sans overflow-hidden">
                    {/* Mobile Header */}
                    {mobileMenuOpen && ( <div className="fixed inset-0 z-50 bg-turquoise-900/95 backdrop-blur-sm flex flex-col md:hidden animate-in"><div className="p-4 flex justify-between items-center border-b border-turquoise-800"><div className="font-bold text-white text-xl flex items-center gap-2 brand-font"><Icons.Activity/> LEQ Móvil</div><button onClick={() => setMobileMenuOpen(false)} className="text-white p-2 bg-turquoise-800 rounded-full btn-hover-effect"><Icons.X size={24}/></button></div><div className="p-6 space-y-4"><NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} /><NavItem id="reports" label="Reportes" icon={Icons.List} /><NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />{(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuración" icon={Icons.Settings} />}{(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}<div className="pt-8 border-t border-turquoise-800"><button onClick={handleLogout} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl bg-turquoise-800 text-white font-bold btn-hover-effect"><Icons.LogOut size={20}/> Desconectar</button></div></div></div> )}
                    
                    {/* Sidebar */}
                    <aside className={`${sidebarCollapsed ? 'w-24' : 'w-72'} bg-turquoise-900 text-turquoise-100 flex-col shadow-2xl z-20 hidden md:flex relative transition-all duration-300 ease-in-out`}>
                        <div className={`p-6 pb-2 relative z-10 flex ${sidebarCollapsed ? 'justify-center' : 'justify-between'} items-center`}>{!sidebarCollapsed && <div className="flex items-center gap-3 text-white"><div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg"><Icons.Activity size={24} className="text-white"/></div><span className="font-bold text-2xl brand-font animate-in">Bitácora</span></div>}{sidebarCollapsed && <div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg mb-2"><Icons.Activity size={24} className="text-white"/></div>}<button onClick={() => setSidebarCollapsed(!sidebarCollapsed)} className="text-turquoise-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-turquoise-800 absolute right-4 top-6 btn-hover-effect" style={sidebarCollapsed ? { right: 'auto', top: 'auto', marginTop: '10px', position: 'static' } : {}}>{sidebarCollapsed ? <Icons.ChevronsRight size={20}/> : <Icons.ArrowLeft size={20}/>}</button></div>
                        {!sidebarCollapsed && <div className="text-xs font-bold text-turquoise-400 uppercase tracking-widest pl-14 mb-4 animate-in">Producción</div>}
                        <nav className="flex-1 px-4 py-4 space-y-2 relative z-10 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                            <NavItem id="reports" label="Reportes" icon={Icons.List} />
                            <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuración" icon={Icons.Settings} />}
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                        </nav>
                        <div className="p-4 mx-4 mb-4 rounded-2xl bg-turquoise-800/50 border border-turquoise-700/50 relative z-10">
                            <div className={`flex items-center gap-3 mb-4 ${sidebarCollapsed ? 'justify-center flex-col' : ''}`}><div className="w-10 h-10 rounded-full bg-gradient-to-br from-clinical-400 to-clinical-600 flex items-center justify-center font-bold text-white text-sm shrink-0">{role==='admin'?'AD':'OP'}</div>{!sidebarCollapsed && <div className="overflow-hidden"><div className="text-sm font-bold text-white capitalize truncate">{userName}</div><div className="text-[10px] text-turquoise-300 truncate">En línea</div></div>}</div>
                            <button onClick={handleLogout} className={`w-full flex items-center gap-2 text-xs font-bold text-turquoise-200 hover:text-white py-2.5 rounded-xl hover:bg-turquoise-700 transition-colors btn-hover-effect ${sidebarCollapsed ? 'justify-center' : 'justify-center'}`} title="Desconectar"><Icons.LogOut size={16}/> {!sidebarCollapsed && <span>Salir</span>}</button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden bg-[#f0fdfa] relative transition-all duration-300">
                        <div className="md:hidden bg-white/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center z-20"><button onClick={() => setMobileMenuOpen(true)} className="text-slate-600 p-1 btn-hover-effect"><Icons.Menu size={24}/></button><div className="font-bold text-slate-800 flex items-center gap-2 brand-font"><Icons.Activity size={18} className="text-turquoise-600"/> LEQ Móvil</div><div className="w-8"></div></div>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative z-10">
                            {view === 'dashboard' && <DashboardBlock setView={setView} stats={stats} userName={userName} />}
                            {view === 'reports' && <ReportsBlock kits={kits} patients={patients} />}
                            {view === 'pacientes' && <PatientManagementBlock patients={patients} kits={kits} medicines={medicines} onAddPatient={addPatient} onUpdatePatient={updatePatient} onDeletePatient={deletePatient} onSaveKit={saveKit} onDeleteKit={deleteKit} currentUser={{name: userName, role: role}} userRole={role} />}
                            {view === 'config' && (role === 'admin' || role === 'superadmin') && <ConfigBlock medicines={medicines} onAddList={addMedsList} />}
                            {view === 'users' && (role === 'admin' || role === 'superadmin') && <UserManagementBlock users={users} onAddUser={addUser} onUpdateUser={updateUser} onDeleteUser={deleteUser} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
