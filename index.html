<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="icon" href="data:,">
    <title>IHSS A TU CASA - Plataforma de Dispensaci√≥n</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (Para Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- QRCode.js LOCAL (offline) - Implementaci√≥n standalone sin CDN -->
    <script>
    /**
     * M√≥dulo QR Local - Generaci√≥n offline de c√≥digos QR
     * Reemplaza la dependencia de CDN con implementaci√≥n local
     */
    (function() {
        'use strict';
        
        // Implementaci√≥n ligera de QR Code usando qrcode-generator
        // Basado en qrcode-generator (https://github.com/kazuhikoarase/qrcode-generator)
        // Versi√≥n minificada y adaptada para funcionar offline
        
        // Tabla de generaci√≥n de polinomios para correcci√≥n de errores
        const QR_MATH = {
            glog: function(n) {
                if (n < 1) throw new Error("glog(" + n + ")");
                return QR_MATH.LOG_TABLE[n];
            },
            gexp: function(n) {
                while (n < 0) n += 255;
                while (n >= 256) n -= 255;
                return QR_MATH.EXP_TABLE[n];
            },
            EXP_TABLE: new Array(256),
            LOG_TABLE: new Array(256)
        };
        
        for (let i = 0; i < 8; i++) QR_MATH.EXP_TABLE[i] = 1 << i;
        for (let i = 8; i < 256; i++) QR_MATH.EXP_TABLE[i] = QR_MATH.EXP_TABLE[i - 4] ^ QR_MATH.EXP_TABLE[i - 5] ^ QR_MATH.EXP_TABLE[i - 6] ^ QR_MATH.EXP_TABLE[i - 8];
        for (let i = 0; i < 255; i++) QR_MATH.LOG_TABLE[QR_MATH.EXP_TABLE[i]] = i;
        
        const QR_UTIL = {
            getBCHDigit: function(data) {
                let digit = 0;
                while (data !== 0) { digit++; data >>>= 1; }
                return digit;
            },
            getBCHTypeInfo: function(data) {
                let d = data << 10;
                while (QR_UTIL.getBCHDigit(d) - QR_UTIL.getBCHDigit(0x537) >= 0) {
                    d ^= (0x537 << (QR_UTIL.getBCHDigit(d) - QR_UTIL.getBCHDigit(0x537)));
                }
                return ((data << 10) | d) ^ 0x5412;
            },
            getBCHTypeNumber: function(data) {
                let d = data << 12;
                while (QR_UTIL.getBCHDigit(d) - QR_UTIL.getBCHDigit(0x1f25) >= 0) {
                    d ^= (0x1f25 << (QR_UTIL.getBCHDigit(d) - QR_UTIL.getBCHDigit(0x1f25)));
                }
                return (data << 12) | d;
            },
            getPatternPosition: function(typeNumber) {
                return QR_UTIL.PATTERN_POSITION_TABLE[typeNumber - 1];
            },
            getMask: function(maskPattern, i, j) {
                switch (maskPattern) {
                    case 0: return (i + j) % 2 === 0;
                    case 1: return i % 2 === 0;
                    case 2: return j % 3 === 0;
                    case 3: return (i + j) % 3 === 0;
                    case 4: return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 === 0;
                    case 5: return (i * j) % 2 + (i * j) % 3 === 0;
                    case 6: return ((i * j) % 2 + (i * j) % 3) % 2 === 0;
                    case 7: return ((i * j) % 3 + (i + j) % 2) % 2 === 0;
                    default: throw new Error("bad maskPattern:" + maskPattern);
                }
            },
            getErrorCorrectPolynomial: function(errorCorrectLength) {
                let a = new QR_POLYNOMIAL([1], 0);
                for (let i = 0; i < errorCorrectLength; i++) {
                    a = a.multiply(new QR_POLYNOMIAL([1, QR_MATH.gexp(i)], 0));
                }
                return a;
            },
            getLengthInBits: function(mode, type) {
                if (1 <= type && type < 10) {
                    switch (mode) {
                        case 4: return 8;
                        case 8: return 16;
                        default: return 10;
                    }
                } else if (type < 27) {
                    switch (mode) {
                        case 4: return 16;
                        case 8: return 16;
                        default: return 12;
                    }
                } else if (type < 41) {
                    switch (mode) {
                        case 4: return 16;
                        case 8: return 16;
                        default: return 14;
                    }
                } else {
                    throw new Error("type:" + type);
                }
            },
            getLostPoint: function(qrCode) {
                const moduleCount = qrCode.getModuleCount();
                let lostPoint = 0;
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        let sameCount = 0;
                        const dark = qrCode.isDark(row, col);
                        for (let r = -1; r <= 1; r++) {
                            if (row + r < 0 || moduleCount <= row + r) continue;
                            for (let c = -1; c <= 1; c++) {
                                if (col + c < 0 || moduleCount <= col + c) continue;
                                if (r === 0 && c === 0) continue;
                                if (dark === qrCode.isDark(row + r, col + c)) sameCount++;
                            }
                        }
                        if (sameCount > 5) lostPoint += (3 + sameCount - 5);
                    }
                }
                for (let row = 0; row < moduleCount - 1; row++) {
                    for (let col = 0; col < moduleCount - 1; col++) {
                        let count = 0;
                        if (qrCode.isDark(row, col)) count++;
                        if (qrCode.isDark(row + 1, col)) count++;
                        if (qrCode.isDark(row, col + 1)) count++;
                        if (qrCode.isDark(row + 1, col + 1)) count++;
                        if (count === 0 || count === 4) lostPoint += 3;
                    }
                }
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount - 6; col++) {
                        if (qrCode.isDark(row, col) && !qrCode.isDark(row, col + 1) && qrCode.isDark(row, col + 2) && qrCode.isDark(row, col + 3) && qrCode.isDark(row, col + 4) && !qrCode.isDark(row, col + 5) && qrCode.isDark(row, col + 6)) {
                            lostPoint += 40;
                        }
                    }
                }
                for (let col = 0; col < moduleCount; col++) {
                    for (let row = 0; row < moduleCount - 6; row++) {
                        if (qrCode.isDark(row, col) && !qrCode.isDark(row + 1, col) && qrCode.isDark(row + 2, col) && qrCode.isDark(row + 3, col) && qrCode.isDark(row + 4, col) && !qrCode.isDark(row + 5, col) && qrCode.isDark(row + 6, col)) {
                            lostPoint += 40;
                        }
                    }
                }
                let darkCount = 0;
                for (let col = 0; col < moduleCount; col++) {
                    for (let row = 0; row < moduleCount; row++) {
                        if (qrCode.isDark(row, col)) darkCount++;
                    }
                }
                const ratio = Math.abs(100 * darkCount / moduleCount / moduleCount - 50) / 5;
                lostPoint += ratio * 10;
                return lostPoint;
            },
            PATTERN_POSITION_TABLE: [
                [],
                [6, 18],
                [6, 22],
                [6, 26],
                [6, 30],
                [6, 34],
                [6, 22, 38],
                [6, 24, 42],
                [6, 26, 46],
                [6, 28, 50],
                [6, 30, 54],
                [6, 32, 58],
                [6, 34, 62],
                [6, 26, 46, 66],
                [6, 26, 48, 70],
                [6, 26, 50, 74],
                [6, 30, 54, 78],
                [6, 30, 56, 82],
                [6, 30, 58, 86],
                [6, 34, 62, 90],
                [6, 28, 50, 72, 94],
                [6, 26, 50, 74, 98],
                [6, 30, 54, 78, 102],
                [6, 28, 54, 80, 106],
                [6, 32, 58, 84, 110],
                [6, 30, 58, 86, 114],
                [6, 34, 62, 90, 118],
                [6, 26, 50, 74, 98, 122],
                [6, 30, 54, 78, 102, 126],
                [6, 26, 52, 78, 104, 130],
                [6, 30, 56, 82, 108, 134],
                [6, 34, 60, 86, 112, 138],
                [6, 30, 58, 86, 114, 142],
                [6, 34, 62, 90, 118, 146],
                [6, 30, 54, 78, 102, 126, 150],
                [6, 24, 50, 76, 102, 128, 154],
                [6, 28, 54, 80, 106, 132, 158],
                [6, 32, 58, 84, 110, 136, 162],
                [6, 26, 54, 82, 110, 138, 166],
                [6, 30, 58, 86, 114, 142, 170]
            ],
            G15: (1 << 10) | (1 << 8) | (1 << 5) | (1 << 4) | (1 << 2) | (1 << 1) | (1 << 0),
            G18: (1 << 12) | (1 << 11) | (1 << 10) | (1 << 9) | (1 << 8) | (1 << 5) | (1 << 2) | (1 << 0),
            G15_MASK: (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1)
        };
        
        function QR_POLYNOMIAL(num, shift) {
            if (num.length === undefined) throw new Error(num.length + "/" + shift);
            let offset = 0;
            while (offset < num.length && num[offset] === 0) offset++;
            this.num = new Array(num.length - offset + shift);
            for (let i = 0; i < num.length - offset; i++) this.num[i] = num[i + offset];
        }
        
        QR_POLYNOMIAL.prototype = {
            get: function(index) { return this.num[index]; },
            getLength: function() { return this.num.length; },
            multiply: function(e) {
                const num = new Array(this.getLength() + e.getLength() - 1);
                for (let i = 0; i < this.getLength(); i++) {
                    for (let j = 0; j < e.getLength(); j++) {
                        num[i + j] ^= QR_MATH.gexp(QR_MATH.glog(this.get(i)) + QR_MATH.glog(e.get(j)));
                    }
                }
                return new QR_POLYNOMIAL(num, 0);
            },
            mod: function(e) {
                if (this.getLength() - e.getLength() < 0) return this;
                const ratio = QR_MATH.glog(this.get(0)) - QR_MATH.glog(e.get(0));
                const num = new Array(this.getLength());
                for (let i = 0; i < this.getLength(); i++) num[i] = this.num[i];
                for (let i = 0; i < e.getLength(); i++) num[i] ^= QR_MATH.gexp(QR_MATH.glog(e.get(i)) + ratio);
                return (new QR_POLYNOMIAL(num, 0)).mod(e);
            }
        };
        
        function QR_RS_BLOCK(totalCount, dataCount) {
            this.totalCount = totalCount;
            this.dataCount = dataCount;
        }
        
        const QR_RS_BLOCK_TABLE = [
            [1, 26, 19], [1, 26, 16], [1, 26, 13], [1, 26, 9], [1, 44, 34], [1, 44, 28], [1, 44, 22], [1, 44, 16],
            [1, 70, 55], [1, 70, 44], [2, 35, 17], [2, 35, 13], [1, 100, 80], [2, 50, 32], [2, 50, 24], [4, 25, 9],
            [1, 134, 108], [2, 67, 43], [2, 33, 15, 2, 34, 16], [2, 33, 11, 2, 34, 12], [2, 86, 68], [4, 43, 27],
            [4, 43, 19], [4, 43, 15], [2, 98, 78], [4, 49, 31], [2, 32, 14, 4, 33, 15], [4, 39, 13, 1, 40, 14],
            [2, 121, 97], [2, 60, 38, 2, 61, 39], [4, 40, 18, 2, 41, 19], [4, 40, 14, 2, 41, 15], [2, 146, 116],
            [3, 58, 36, 2, 59, 37], [4, 36, 16, 4, 37, 17], [4, 36, 12, 4, 37, 13], [2, 86, 68, 2, 87, 69],
            [4, 69, 43, 1, 70, 44], [6, 43, 19, 2, 44, 20], [6, 43, 15, 2, 44, 16], [4, 101, 81], [1, 80, 50, 4, 81, 51],
            [4, 50, 22, 4, 51, 23], [3, 36, 12, 8, 37, 13], [2, 116, 92, 2, 117, 93], [6, 58, 36, 2, 59, 37],
            [4, 46, 20, 6, 47, 21], [7, 42, 14, 4, 43, 15], [4, 133, 107], [8, 59, 37, 1, 60, 38],
            [8, 44, 20, 4, 45, 21], [12, 33, 11, 4, 34, 12], [3, 145, 115, 1, 146, 116], [4, 64, 40, 5, 65, 41],
            [11, 36, 16, 5, 37, 17], [11, 36, 12, 5, 37, 13], [5, 109, 87, 1, 110, 88], [5, 65, 41, 5, 66, 42],
            [5, 54, 24, 7, 55, 25], [11, 36, 12], [5, 122, 98, 1, 123, 99], [7, 73, 45, 3, 74, 46],
            [15, 43, 19, 2, 44, 20], [3, 45, 15, 13, 46, 16], [1, 135, 107, 5, 136, 108], [10, 74, 46, 1, 75, 47],
            [1, 50, 22, 15, 51, 23], [2, 42, 14, 17, 43, 15], [5, 150, 120, 1, 151, 121], [9, 69, 43, 4, 70, 44],
            [17, 50, 22, 1, 51, 23], [2, 42, 14, 19, 43, 15], [3, 141, 113, 4, 142, 114], [3, 70, 44, 11, 71, 45],
            [17, 47, 21, 4, 48, 22], [9, 39, 13, 16, 40, 14], [3, 135, 107, 5, 136, 108], [3, 67, 41, 13, 68, 42],
            [15, 54, 24, 5, 55, 25], [15, 43, 15, 10, 44, 16], [4, 144, 116, 4, 145, 117], [17, 68, 42],
            [17, 50, 22, 6, 51, 23], [19, 46, 16, 6, 47, 17], [2, 139, 111, 7, 140, 112], [17, 74, 46],
            [7, 54, 24, 16, 55, 25], [34, 37, 13], [4, 151, 121, 5, 152, 122], [4, 75, 47, 14, 76, 48],
            [11, 54, 24, 14, 55, 25], [16, 45, 15, 14, 46, 16], [6, 147, 117, 4, 148, 118], [6, 73, 45, 14, 74, 46],
            [11, 54, 24, 16, 55, 25], [30, 46, 16, 2, 47, 17], [8, 132, 106, 4, 133, 107], [8, 75, 47, 13, 76, 48],
            [7, 54, 24, 22, 55, 25], [22, 45, 15, 13, 46, 16], [10, 142, 114, 2, 143, 115], [19, 74, 46, 4, 75, 47],
            [28, 50, 22, 6, 51, 23], [33, 46, 16, 4, 47, 17], [8, 152, 122, 4, 153, 123], [22, 73, 45, 3, 74, 46],
            [8, 53, 23, 26, 54, 24], [12, 45, 15, 28, 46, 16], [3, 147, 117, 10, 148, 118], [3, 73, 45, 23, 74, 46],
            [4, 53, 23, 31, 54, 24], [11, 45, 15, 31, 46, 16], [7, 146, 116, 7, 147, 117], [21, 73, 45, 7, 74, 46],
            [1, 53, 23, 37, 54, 24], [19, 45, 15, 26, 46, 16], [5, 145, 115, 10, 146, 116], [19, 75, 47, 10, 76, 48],
            [15, 54, 24, 25, 55, 25], [23, 45, 15, 25, 46, 16], [13, 145, 115, 3, 146, 116], [2, 74, 46, 29, 75, 47],
            [42, 54, 24, 1, 55, 25], [23, 45, 15, 28, 46, 16], [17, 145, 115, 10, 146, 116], [10, 74, 46, 23, 75, 47],
            [10, 54, 24, 35, 55, 25], [19, 45, 15, 35, 46, 16], [17, 145, 115, 19, 146, 116], [14, 74, 46, 21, 75, 47],
            [29, 54, 24, 19, 55, 25], [11, 45, 15, 46, 46, 16], [13, 145, 115, 2, 146, 116], [14, 74, 46, 23, 75, 47],
            [44, 54, 24, 7, 55, 25], [59, 46, 16, 1, 47, 17], [21, 145, 115, 19, 146, 116], [12, 151, 121, 26, 152, 122],
            [39, 54, 24, 14, 55, 25], [22, 45, 15, 41, 46, 16], [6, 145, 115, 34, 146, 116], [6, 151, 121, 34, 152, 122],
            [46, 54, 24, 10, 55, 25], [2, 45, 15, 64, 46, 16], [29, 145, 115, 14, 146, 116], [17, 152, 122, 4, 153, 123],
            [49, 54, 24, 10, 55, 25], [24, 45, 15, 46, 46, 16], [13, 145, 115, 32, 146, 116], [4, 152, 122, 18, 153, 123],
            [48, 54, 24, 14, 55, 25], [42, 45, 15, 32, 46, 16], [40, 145, 115, 7, 146, 116], [20, 147, 117, 4, 148, 118],
            [43, 54, 24, 22, 55, 25], [10, 45, 15, 67, 46, 16], [18, 151, 121, 19, 152, 122], [19, 148, 118, 6, 149, 119],
            [34, 50, 22, 34, 51, 23], [20, 45, 15, 61, 46, 16], [20, 151, 121, 15, 152, 122], [15, 148, 118, 11, 149, 119]
        ];
        
        function QRCode(typeNumber, errorCorrectLevel) {
            this.typeNumber = typeNumber;
            this.errorCorrectLevel = errorCorrectLevel;
            this.modules = null;
            this.moduleCount = 0;
            this.dataCache = null;
            this.dataList = new Array();
        }
        
        QRCode.prototype = {
            addData: function(data) {
                const newData = new QR_8BIT_BYTE(data);
                this.dataList.push(newData);
                this.dataCache = null;
            },
            isDark: function(row, col) {
                if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) {
                    throw new Error(row + "," + col);
                }
                return this.modules[row][col];
            },
            getModuleCount: function() {
                return this.moduleCount;
            },
            make: function() {
                this.makeImpl(false, this.getBestMaskPattern());
            },
            makeImpl: function(test, maskPattern) {
                this.moduleCount = this.typeNumber * 4 + 17;
                this.modules = new Array(this.moduleCount);
                for (let row = 0; row < this.moduleCount; row++) {
                    this.modules[row] = new Array(this.moduleCount);
                    for (let col = 0; col < this.moduleCount; col++) {
                        this.modules[row][col] = null;
                    }
                }
                this.setupPositionProbePattern(0, 0);
                this.setupPositionProbePattern(this.moduleCount - 7, 0);
                this.setupPositionProbePattern(0, this.moduleCount - 7);
                this.setupPositionAdjustPattern();
                this.setupTimingPattern();
                this.setupTypeInfo(test, maskPattern);
                if (this.typeNumber >= 7) {
                    this.setupTypeNumber(test);
                }
                if (this.dataCache === null) {
                    this.dataCache = QRCode.createData(this.typeNumber, this.errorCorrectLevel, this.dataList);
                }
                this.mapData(this.dataCache, maskPattern);
            },
            setupPositionProbePattern: function(row, col) {
                for (let r = -1; r <= 7; r++) {
                    if (row + r <= -1 || this.moduleCount <= row + r) continue;
                    for (let c = -1; c <= 7; c++) {
                        if (col + c <= -1 || this.moduleCount <= col + c) continue;
                        if ((0 <= r && r <= 6 && (c === 0 || c === 6)) || (0 <= c && c <= 6 && (r === 0 || r === 6)) || (2 <= r && r <= 4 && 2 <= c && c <= 4)) {
                            this.modules[row + r][col + c] = true;
                        } else {
                            this.modules[row + r][col + c] = false;
                        }
                    }
                }
            },
            getBestMaskPattern: function() {
                let minLostPoint = 0;
                let pattern = 0;
                for (let i = 0; i < 8; i++) {
                    this.makeImpl(true, i);
                    const lostPoint = QR_UTIL.getLostPoint(this);
                    if (i === 0 || minLostPoint > lostPoint) {
                        minLostPoint = lostPoint;
                        pattern = i;
                    }
                }
                return pattern;
            },
            createMovieClip: function(target_mc, instance_name, depth) {
                const qr_mc = target_mc.createEmptyMovieClip(instance_name, depth);
                const cs = 1;
                this.make();
                for (let row = 0; row < this.modules.length; row++) {
                    const y = row * cs;
                    for (let col = 0; col < this.modules[row].length; col++) {
                        const x = col * cs;
                        const dark = this.modules[row][col];
                        if (dark) {
                            qr_mc.beginFill(0, 100);
                            qr_mc.moveTo(x, y);
                            qr_mc.lineTo(x + cs, y);
                            qr_mc.lineTo(x + cs, y + cs);
                            qr_mc.lineTo(x, y + cs);
                            qr_mc.endFill();
                        }
                    }
                }
                return qr_mc;
            },
            setupTimingPattern: function() {
                for (let r = 8; r < this.moduleCount - 8; r++) {
                    if (this.modules[r][6] !== null) continue;
                    this.modules[r][6] = (r % 2 === 0);
                }
                for (let c = 8; c < this.moduleCount - 8; c++) {
                    if (this.modules[6][c] !== null) continue;
                    this.modules[6][c] = (c % 2 === 0);
                }
            },
            setupPositionAdjustPattern: function() {
                const pos = QR_UTIL.getPatternPosition(this.typeNumber);
                for (let i = 0; i < pos.length; i++) {
                    for (let j = 0; j < pos.length; j++) {
                        const row = pos[i];
                        const col = pos[j];
                        if (this.modules[row][col] !== null) continue;
                        for (let r = -2; r <= 2; r++) {
                            for (let c = -2; c <= 2; c++) {
                                if (r === -2 || r === 2 || c === -2 || c === 2 || (r === 0 && c === 0)) {
                                    this.modules[row + r][col + c] = true;
                                } else {
                                    this.modules[row + r][col + c] = false;
                                }
                            }
                        }
                    }
                }
            },
            setupTypeNumber: function(test) {
                const bits = QR_UTIL.getBCHTypeNumber(this.typeNumber);
                for (let i = 0; i < 18; i++) {
                    const mod = (!test && ((bits >> i) & 1) === 1);
                    this.modules[Math.floor(i / 3)][i % 3 + this.moduleCount - 8 - 3] = mod;
                }
                for (let i = 0; i < 18; i++) {
                    const mod = (!test && ((bits >> i) & 1) === 1);
                    this.modules[i % 3 + this.moduleCount - 8 - 3][Math.floor(i / 3)] = mod;
                }
            },
            setupTypeInfo: function(test, maskPattern) {
                const data = (this.errorCorrectLevel << 3) | maskPattern;
                const bits = QR_UTIL.getBCHTypeInfo(data);
                for (let i = 0; i < 15; i++) {
                    const mod = (!test && ((bits >> i) & 1) === 1);
                    if (i < 6) {
                        this.modules[i][8] = mod;
                    } else if (i < 8) {
                        this.modules[i + 1][8] = mod;
                    } else {
                        this.modules[this.moduleCount - 15 + i][8] = mod;
                    }
                }
                for (let i = 0; i < 15; i++) {
                    const mod = (!test && ((bits >> i) & 1) === 1);
                    if (i < 8) {
                        this.modules[8][this.moduleCount - i - 1] = mod;
                    } else if (i < 9) {
                        this.modules[8][15 - i - 1 + 1] = mod;
                    } else {
                        this.modules[8][15 - i - 1] = mod;
                    }
                }
                this.modules[this.moduleCount - 8][8] = (!test);
            },
            mapData: function(data, maskPattern) {
                let inc = -1;
                let row = this.moduleCount - 1;
                let bitIndex = 7;
                let byteIndex = 0;
                for (let col = this.moduleCount - 1; col > 0; col -= 2) {
                    if (col === 6) col--;
                    while (true) {
                        for (let c = 0; c < 2; c++) {
                            if (this.modules[row][col - c] === null) {
                                let dark = false;
                                if (byteIndex < data.length) {
                                    dark = (((data[byteIndex] >>> bitIndex) & 1) === 1);
                                }
                                const mask = QR_UTIL.getMask(maskPattern, row, col - c);
                                if (mask) {
                                    dark = !dark;
                                }
                                this.modules[row][col - c] = dark;
                                bitIndex--;
                                if (bitIndex === -1) {
                                    byteIndex++;
                                    bitIndex = 7;
                                }
                            }
                        }
                        row += inc;
                        if (row < 0 || this.moduleCount <= row) {
                            row -= inc;
                            inc = -inc;
                            break;
                        }
                    }
                }
            }
        };
        
        QRCode.PAD0 = 0xEC;
        QRCode.PAD1 = 0x11;
        
        QRCode.createData = function(typeNumber, errorCorrectLevel, dataList) {
            const rsBlocks = QRCode.getRSBlocks(typeNumber, errorCorrectLevel);
            const buffer = new QR_BIT_BUFFER();
            for (let i = 0; i < dataList.length; i++) {
                const data = dataList[i];
                buffer.put(data.mode, 4);
                buffer.put(data.getLength(), QR_UTIL.getLengthInBits(data.mode, typeNumber));
                data.write(buffer);
            }
            let totalDataCount = 0;
            for (let i = 0; i < rsBlocks.length; i++) {
                totalDataCount += rsBlocks[i].dataCount;
            }
            if (buffer.getLengthInBits() > totalDataCount * 8) {
                throw new Error("code length overflow. (" + buffer.getLengthInBits() + ">" + totalDataCount * 8 + ")");
            }
            if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) {
                buffer.put(0, 4);
            }
            while (buffer.getLengthInBits() % 8 !== 0) {
                buffer.putBit(false);
            }
            while (true) {
                if (buffer.getLengthInBits() >= totalDataCount * 8) {
                    break;
                }
                buffer.put(QRCode.PAD0, 8);
                if (buffer.getLengthInBits() >= totalDataCount * 8) {
                    break;
                }
                buffer.put(QRCode.PAD1, 8);
            }
            return QRCode.createBytes(buffer, rsBlocks);
        };
        
        QRCode.getRSBlocks = function(typeNumber, errorCorrectLevel) {
            const rsBlock = QR_RS_BLOCK_TABLE[(typeNumber - 1) * 4 + errorCorrectLevel];
            if (rsBlock === undefined) {
                throw new Error("bad rs block @ typeNumber:" + typeNumber + "/errorCorrectLevel:" + errorCorrectLevel);
            }
            const length = rsBlock.length / 3;
            const list = new Array();
            for (let i = 0; i < length; i++) {
                const count = rsBlock[i * 3 + 0];
                const totalCount = rsBlock[i * 3 + 1];
                const dataCount = rsBlock[i * 3 + 2];
                for (let j = 0; j < count; j++) {
                    list.push(new QR_RS_BLOCK(totalCount, dataCount));
                }
            }
            return list;
        };
        
        QRCode.createBytes = function(buffer, rsBlocks) {
            let offset = 0;
            let maxDcCount = 0;
            let maxEcCount = 0;
            const dcdata = new Array(rsBlocks.length);
            const ecdata = new Array(rsBlocks.length);
            for (let r = 0; r < rsBlocks.length; r++) {
                const dcCount = rsBlocks[r].dataCount;
                const ecCount = rsBlocks[r].totalCount - dcCount;
                maxDcCount = Math.max(maxDcCount, dcCount);
                maxEcCount = Math.max(maxEcCount, ecCount);
                dcdata[r] = new Array(dcCount);
                for (let i = 0; i < dcdata[r].length; i++) {
                    dcdata[r][i] = 0xff & buffer.buffer[i + offset];
                }
                offset += dcCount;
                const rsPoly = QR_UTIL.getErrorCorrectPolynomial(ecCount);
                const rawPoly = new QR_POLYNOMIAL(dcdata[r], rsPoly.getLength() - 1);
                const modPoly = rawPoly.mod(rsPoly);
                ecdata[r] = new Array(rsPoly.getLength() - 1);
                for (let i = 0; i < ecdata[r].length; i++) {
                    const modIndex = i + modPoly.getLength() - ecdata[r].length;
                    ecdata[r][i] = (modIndex >= 0) ? modPoly.get(modIndex) : 0;
                }
            }
            let totalCodeCount = 0;
            for (let i = 0; i < rsBlocks.length; i++) {
                totalCodeCount += rsBlocks[i].totalCount;
            }
            const data = new Array(totalCodeCount);
            let index = 0;
            for (let i = 0; i < maxDcCount; i++) {
                for (let r = 0; r < rsBlocks.length; r++) {
                    if (i < dcdata[r].length) {
                        data[index++] = dcdata[r][i];
                    }
                }
            }
            for (let i = 0; i < maxEcCount; i++) {
                for (let r = 0; r < rsBlocks.length; r++) {
                    if (i < ecdata[r].length) {
                        data[index++] = ecdata[r][i];
                    }
                }
            }
            return data;
        };
        
        function QR_8BIT_BYTE(data) {
            this.mode = 4;
            this.data = data;
        }
        
        QR_8BIT_BYTE.prototype = {
            getLength: function(buffer) {
                return this.data.length;
            },
            write: function(buffer) {
                for (let i = 0; i < this.data.length; i++) {
                    buffer.put(this.data.charCodeAt(i), 8);
                }
            }
        };
        
        function QR_BIT_BUFFER() {
            this.buffer = new Array();
            this.length = 0;
        }
        
        QR_BIT_BUFFER.prototype = {
            get: function(index) {
                const bufIndex = Math.floor(index / 8);
                return ((this.buffer[bufIndex] >>> (7 - index % 8)) & 1) === 1;
            },
            put: function(num, length) {
                for (let i = 0; i < length; i++) {
                    this.putBit(((num >>> (length - i - 1)) & 1) === 1);
                }
            },
            getLengthInBits: function() {
                return this.length;
            },
            putBit: function(bit) {
                const bufIndex = Math.floor(this.length / 8);
                if (this.buffer.length <= bufIndex) {
                    this.buffer.push(0);
                }
                if (bit) {
                    this.buffer[bufIndex] |= (0x80 >>> (this.length % 8));
                }
                this.length++;
            }
        };
        
        // API compatible con qrcode.js (npm)
        // Wrapper para mantener compatibilidad con QRCode.toDataURL
        if (typeof window !== 'undefined') {
            window.QRCode = window.QRCode || {};
            
            // Funci√≥n principal para generar QR como DataURL
            window.QRCode.toDataURL = function(text, opts, cb) {
                if (typeof opts === 'function') {
                    cb = opts;
                    opts = {};
                }
                opts = opts || {};
                
                try {
                    const typeNumber = opts.typeNumber || 0;
                    const errorCorrectLevel = opts.errorCorrectLevel || 'M';
                    const width = opts.width || 250;
                    const margin = opts.margin || 2;
                    const colorDark = opts.color?.dark || '#000000';
                    const colorLight = opts.color?.light || '#FFFFFF';
                    
                    // Mapear nivel de correcci√≥n de errores
                    let errorLevel = 1; // M por defecto
                    if (errorCorrectLevel === 'L') errorLevel = 0;
                    else if (errorCorrectLevel === 'M') errorLevel = 1;
                    else if (errorCorrectLevel === 'Q') errorLevel = 2;
                    else if (errorCorrectLevel === 'H') errorLevel = 3;
                    
                    // Calcular tipo de QR autom√°ticamente si no se especifica
                    let qrType = typeNumber;
                    if (qrType === 0) {
                        // Calcular tipo m√≠nimo necesario
                        const dataLength = text.length;
                        for (let t = 1; t <= 40; t++) {
                            const rsBlocks = QRCode.getRSBlocks(t, errorLevel);
                            let totalDataCount = 0;
                            for (let i = 0; i < rsBlocks.length; i++) {
                                totalDataCount += rsBlocks[i].dataCount;
                            }
                            if (dataLength <= totalDataCount - 3) {
                                qrType = t;
                                break;
                            }
                        }
                        if (qrType === 0) qrType = 10; // Fallback
                    }
                    
                    // Crear QR code
                    const qr = new QRCode(qrType, errorLevel);
                    qr.addData(text);
                    qr.make();
                    
                    // Crear canvas
                    const canvas = document.createElement('canvas');
                    const moduleCount = qr.getModuleCount();
                    const cellSize = Math.floor((width - margin * 2) / moduleCount);
                    const qrSize = cellSize * moduleCount + margin * 2;
                    canvas.width = qrSize;
                    canvas.height = qrSize;
                    const ctx = canvas.getContext('2d');
                    
                    // Fondo
                    ctx.fillStyle = colorLight;
                    ctx.fillRect(0, 0, qrSize, qrSize);
                    
                    // Dibujar m√≥dulos
                    ctx.fillStyle = colorDark;
                    const offset = margin;
                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(
                                    offset + col * cellSize,
                                    offset + row * cellSize,
                                    cellSize,
                                    cellSize
                                );
                            }
                        }
                    }
                    
                    // Convertir a DataURL
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    if (cb) {
                        cb(null, dataUrl);
                    } else {
                        return dataUrl;
                    }
                } catch (error) {
                    if (cb) {
                        cb(error, null);
                    } else {
                        throw error;
                    }
                }
            };
            
            console.log('‚úÖ QRCode library local cargada correctamente (offline)');
        }
    })();
    </script>
    
    <!-- Mammoth.js (Para importar plantillas desde Word .docx) -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.11.0/mammoth.browser.min.js"></script>
    
    <!-- PDF.js para leer y renderizar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Google Generative AI (Gemini) SDK Loader - Singleton robusto con fallback ESM/UMD -->
    <script>
        /**
         * Loader singleton para Google Generative AI SDK
         * Maneja carga UMD y ESM, evita duplicados, y proporciona fallback robusto
         */
        (function() {
            'use strict';
            
            // Estado del loader (singleton)
            const loaderState = {
                promise: null,
                sdk: null,
                error: null,
                loading: false
            };
            
            // Timeout configurable (30 segundos por defecto)
            const LOAD_TIMEOUT = 30000;
            
            /**
             * Verifica si el SDK est√° disponible en alguna de las formas posibles
             */
            const checkSDKAvailable = () => {
                // Forma 1: window.GoogleGenerativeAI (UMD est√°ndar)
                if (typeof window.GoogleGenerativeAI !== 'undefined') {
                    return window.GoogleGenerativeAI;
                }
                // Forma 2: window.google.generativeAi.GoogleGenerativeAI
                if (window.google?.generativeAi?.GoogleGenerativeAI) {
                    return window.google.generativeAi.GoogleGenerativeAI;
                }
                // Forma 3: Variable global directa
                if (typeof GoogleGenerativeAI !== 'undefined') {
                    return GoogleGenerativeAI;
                }
                // Forma 4: window.google.generativeai (min√∫sculas)
                if (window.google?.generativeai?.GoogleGenerativeAI) {
                    return window.google.generativeai.GoogleGenerativeAI;
                }
                return null;
            };
            
            /**
             * Carga el SDK usando UMD (script tag)
             */
            const loadUMD = (url, cdnName) => {
                return new Promise((resolve, reject) => {
                    // Verificar si ya existe un script con esta URL
                    const existingScript = document.querySelector(`script[src="${url}"]`);
                    if (existingScript) {
                        // Si ya existe, esperar a que termine de cargar
                        if (existingScript.hasAttribute('data-loaded')) {
                            const sdk = checkSDKAvailable();
                            if (sdk) {
                                resolve(sdk);
                            } else {
                                reject(new Error(`Script de ${cdnName} cargado pero SDK no disponible`));
                            }
                            return;
                        }
                        
                        // Script existe pero a√∫n no termin√≥, enganchar eventos
                        existingScript.addEventListener('load', () => {
                            setTimeout(() => {
                                const sdk = checkSDKAvailable();
                                if (sdk) {
                                    existingScript.setAttribute('data-loaded', 'true');
                                    resolve(sdk);
                                } else {
                                    reject(new Error(`Script de ${cdnName} cargado pero SDK no disponible`));
                                }
                            }, 500);
                        });
                        existingScript.addEventListener('error', () => {
                            reject(new Error(`Error cargando script de ${cdnName}`));
                        });
                        return;
                    }
                    
                    // Crear nuevo script
                    const script = document.createElement('script');
                    script.src = url;
                    script.async = true;
                    script.setAttribute('data-cdn', cdnName);
                    
                    script.onload = () => {
                        setTimeout(() => {
                            const sdk = checkSDKAvailable();
                            if (sdk) {
                                script.setAttribute('data-loaded', 'true');
                                console.log(`‚úÖ Google Generative AI SDK cargado desde ${cdnName}`);
                                resolve(sdk);
                            } else {
                                reject(new Error(`SDK cargado desde ${cdnName} pero no disponible globalmente`));
                            }
                        }, 500);
                    };
                    
                    script.onerror = () => {
                        reject(new Error(`Error de red cargando desde ${cdnName}`));
                    };
                    
                    document.head.appendChild(script);
                });
            };
            
            /**
             * Carga el SDK usando ESM (import din√°mico)
             */
            const loadESM = async () => {
                try {
                    // Intentar con jsDelivr +esm
                    const module = await import('https://cdn.jsdelivr.net/npm/@google/generative-ai@0.21.0/+esm');
                    if (module?.GoogleGenerativeAI) {
                        console.log('‚úÖ Google Generative AI SDK cargado v√≠a ESM (jsDelivr)');
                        return module.GoogleGenerativeAI;
                    }
                    throw new Error('M√≥dulo ESM no expone GoogleGenerativeAI');
                } catch (esmError) {
                    console.warn('‚ö†Ô∏è ESM fall√≥, intentando UMD:', esmError.message);
                    throw esmError; // Propagar para intentar UMD
                }
            };
            
            /**
             * Funci√≥n principal de carga (singleton)
             */
            window.loadGoogleGenerativeAI = async function(options = {}) {
                const { timeout = LOAD_TIMEOUT, preferESM = false } = options;
                
                // Si ya est√° cargado, retornar inmediatamente
                const existingSDK = checkSDKAvailable();
                if (existingSDK) {
                    return existingSDK;
                }
                
                // Si hay una carga en curso, retornar la misma Promise
                if (loaderState.promise) {
                    return loaderState.promise;
                }
                
                // Si hubo un error previo y no se fuerza reintento, retornar error
                if (loaderState.error && !options.forceRetry) {
                    throw loaderState.error;
                }
                
                // Crear nueva Promise de carga
                loaderState.loading = true;
                loaderState.promise = Promise.race([
                    (async () => {
                        try {
                            // Intentar ESM primero si est√° disponible y preferido
                            // Nota: No podemos verificar 'typeof import' directamente, as√≠ que intentamos y capturamos el error
                            if (preferESM) {
                                try {
                                    return await loadESM();
                                } catch (esmError) {
                                    console.warn('ESM no disponible, usando UMD:', esmError.message);
                                }
                            }
                            
                            // Intentar UMD desde m√∫ltiples CDNs
                            const cdns = [
                                { url: 'https://cdn.jsdelivr.net/npm/@google/generative-ai@0.21.0/dist/index.umd.js', name: 'jsDelivr' },
                                { url: 'https://unpkg.com/@google/generative-ai@0.21.0/dist/index.umd.js', name: 'unpkg' }
                            ];
                            
                            let lastError = null;
                            for (const cdn of cdns) {
                                try {
                                    const sdk = await loadUMD(cdn.url, cdn.name);
                                    loaderState.sdk = sdk;
                                    loaderState.loading = false;
                                    return sdk;
                                } catch (err) {
                                    lastError = err;
                                    console.warn(`‚ö†Ô∏è Fall√≥ ${cdn.name}, intentando siguiente...`);
                                }
                            }
                            
                            throw lastError || new Error('Todos los CDNs fallaron');
                        } catch (error) {
                            loaderState.error = error;
                            loaderState.loading = false;
                            throw error;
                        }
                    })(),
                    new Promise((_, reject) => {
                        setTimeout(() => {
                            reject(new Error(`Timeout cargando SDK despu√©s de ${timeout}ms`));
                        }, timeout);
                    })
                ]);
                
                return loaderState.promise;
            };
            
            // Exponer funci√≥n de verificaci√≥n
            window.isGoogleGenerativeAIAvailable = () => checkSDKAvailable() !== null;
            
            console.log('üîß Google Generative AI SDK Loader inicializado (singleton)');
        })();
    </script>

    <!-- Firebase (Versi√≥n COMPAT - Compatible con API global firebase.*) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        turquoise: { 50:'#f0fdfa', 100:'#ccfbf1', 200:'#99f6e4', 300:'#5eead4', 400:'#2dd4bf', 500:'#14b8a6', 600:'#0d9488', 700:'#0f766e', 800:'#115e59', 900:'#134e4a' },
                        clinical: { 50:'#f0fdf4', 100:'#dcfce7', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#15803d' }
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(20, 184, 166, 0.15)', glow: '0 0 15px rgba(45, 212, 191, 0.3)' }
                }
            }
        }
    </script>

    <style>
        html, body { overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        body { font-family: 'Inter', sans-serif; background-color: #f0fdfa; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        @media (max-width: 767px) {
            .mobile-header-height { height: 56px; min-height: 56px; }
            .mobile-content-pt { padding-top: calc(56px + env(safe-area-inset-top, 0px)) !important; }
        }
        /* M√≥vil horizontal: adaptar a viewport reducido en altura */
        @media (max-width: 767px) and (orientation: landscape) {
            html, body {
                height: 100vh;
                height: 100dvh;
                min-height: 100vh;
                min-height: 100dvh;
                max-height: 100vh;
                max-height: 100dvh;
                overflow: hidden;
                -webkit-overflow-scrolling: touch;
            }
            #root { height: 100%; min-height: 0; }
            .app-layout {
                height: 100% !important;
                min-height: 0 !important;
                max-height: 100% !important;
            }
            .mobile-header-height { height: 44px; min-height: 44px; }
            .mobile-content-pt { padding-top: calc(44px + env(safe-area-inset-top, 0px)) !important; }
            .main-col { min-height: 0 !important; }
            .mobile-content-area { min-height: 0 !important; }
            .mobile-modal-top { top: 44px !important; }
        }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .row-hover-effect { transition: all 0.2s ease-out; border-left: 3px solid transparent; }
        .row-hover-effect:hover { background-color: white; transform: scale(1.005); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left-color: #0d9488; z-index: 10; position: relative; }

        .group-box { @apply border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4; }
        .group-title { @apply text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1; }

        /* Animaciones */
        @keyframes ekgPulse { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .animate-ekg { animation: ekgPulse 2s infinite ease-in-out; }
        
        /* Impresi√≥n espec√≠fica */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; padding: 0; margin: 0; }
        }
        
        /* Estilos para diferentes orientaciones */
        .print-vertical { width: 71mm; height: 210mm; }
        .print-horizontal { width: 210mm; height: 71mm; }
        
        /* Animaciones para men√∫s flotantes */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-in {
            animation: slideInUp 0.3s ease-out;
        }
        
        /* Estilos para botones flotantes estilo Canva */
        .fab-menu {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .fab-button {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgb(0, 0, 0);
        }
        
        .fab-menu-item {
            margin-bottom: 0.75rem;
            animation: slideInUp 0.2s ease-out;
        }
        
        /* Iconos elegantes: trazo refinado y antialiasing */
        .icon-elegant {
            stroke-width: 1.75;
            -webkit-font-smoothing: antialiased;
        }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-turquoise-200 selection:text-turquoise-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        // CONFIGURACI√ìN DE FIREBASE - NUEVA BASE DE DATOS
        const firebaseConfig = {
            apiKey: "AIzaSyBJYFlJFJgrGNKuxshG79zvMifPn57m5X8",
            authDomain: "dataoperativa-c0c3e.firebaseapp.com",
            projectId: "dataoperativa-c0c3e",
            storageBucket: "dataoperativa-c0c3e.firebasestorage.app",
            messagingSenderId: "1041657828353",
            appId: "1:1041657828353:web:99b67aaedd93e583f51c00"
        };

        // Inicializar Firebase - Versi√≥n robusta y funcional
        let app, auth, db, storage;
        let firebaseInitialized = false;
        let firebaseConnectionError = null;
        let firebaseConnectionStatus = 'initializing';
        let firebaseInitPromise = null; // Singleton promise para evitar doble inicializaci√≥n
        
        // Smoke test para verificar conexi√≥n real a Firestore
        // Usa getDoc en lugar de limit(0) porque limit(0) no es v√°lido en Firestore
        const smokeTestFirestore = async (firestoreDb) => {
            try {
                // Test robusto: intentar leer un documento que probablemente no existe
                // Si el doc no existe, NO es error: significa que Firestore respondi√≥ correctamente
                const testDocRef = firestoreDb.collection('_health').doc('ping');
                const testDoc = await testDocRef.get();
                
                // Si llegamos aqu√≠, Firestore est√° conectado (exista o no el documento)
                return { success: true, error: null, isPermissionDenied: false, isNetworkError: false };
            } catch (error) {
                // Clasificar el error seg√∫n su c√≥digo
                if (error.code === 'permission-denied') {
                    // Firebase est√° conectado pero las reglas bloquean
                    console.warn("‚ö†Ô∏è Smoke test: Permisos restringidos (normal en modo prueba)");
                    return { success: true, error: null, isPermissionDenied: true, isNetworkError: false };
                }
                
                // Errores de red reales
                if (error.code === 'unavailable' || error.code === 'network-request-failed' || error.code === 'deadline-exceeded') {
                    console.error("‚ùå Smoke test: Error de red", error.code);
                    return { success: false, error, isPermissionDenied: false, isNetworkError: true };
                }
                
                // failed-precondition (offline persistence) - warning, no error fatal
                if (error.code === 'failed-precondition') {
                    console.warn("‚ö†Ô∏è Smoke test: Persistencia offline no disponible, pero Firebase est√° conectado");
                    return { success: true, error: null, isPermissionDenied: false, isNetworkError: false };
                }
                
                // Otros errores pueden ser de configuraci√≥n, pero no necesariamente de conexi√≥n
                console.warn("‚ö†Ô∏è Smoke test: Error inesperado", error.code, error.message);
                return { success: false, error, isPermissionDenied: false, isNetworkError: false };
            }
        };
        
        // Funci√≥n para inicializar Firebase cuando est√© disponible (singleton)
        const initializeFirebase = async () => {
            // Si ya hay una inicializaci√≥n en curso, retornar esa promise
            if (firebaseInitPromise) {
                return firebaseInitPromise;
            }
            
            // Si ya est√° inicializado, retornar inmediatamente
            if (firebaseInitialized && app && db && auth && storage) {
                return { app, auth, db, storage };
            }
            
            // Crear nueva promise de inicializaci√≥n
            firebaseInitPromise = (async () => {
            try {
                // Verificar que Firebase est√© disponible
                if (typeof firebase === 'undefined') {
                    throw new Error("firebase object no est√° disponible. Verifica que los scripts se carguen correctamente.");
                }
                
                // Verificar servicios necesarios
                if (typeof firebase.initializeApp === 'undefined') {
                    throw new Error("firebase.initializeApp no est√° disponible. Scripts incompletos.");
                }
                if (typeof firebase.firestore === 'undefined') {
                    throw new Error("firebase.firestore no est√° disponible. Scripts incompletos.");
                }
                if (typeof firebase.auth === 'undefined') {
                    throw new Error("firebase.auth no est√° disponible. Scripts incompletos.");
                }
                
                // Verificar si ya existe una app inicializada (evitar doble inicializaci√≥n)
                let existingApp = null;
                if (firebase.apps && Array.isArray(firebase.apps) && firebase.apps.length > 0) {
                    existingApp = firebase.apps.find(a => a.name === '[DEFAULT]');
                }
                
                // Inicializar o usar existente
                if (existingApp) {
                    app = existingApp;
                    console.log("‚úÖ Usando instancia existente de Firebase");
                } else {
                    app = firebase.initializeApp(firebaseConfig);
                    console.log("üöÄ Firebase app inicializada");
                }
                
                // Obtener servicios
                auth = firebase.auth();
                db = firebase.firestore();
                    storage = firebase.storage();
                
                if (!db) {
                    throw new Error("Firestore no se pudo inicializar");
                }
                    if (!storage) {
                        throw new Error("Storage no se pudo inicializar");
                    }
                    
                    // CR√çTICO: Habilitar persistencia ANTES de cualquier uso de Firestore
                    // Esto debe hacerse inmediatamente despu√©s de crear db, antes de cualquier query
                    console.log("üì¶ Habilitando persistencia offline...");
                    if (db && db.enablePersistence) {
                        try {
                            await db.enablePersistence();
                            console.log("‚úÖ Persistencia offline habilitada");
                        } catch (persistenceError) {
                            // Manejar errores de persistencia sin tumbar la inicializaci√≥n
                            if (persistenceError.code === 'failed-precondition') {
                                // M√∫ltiples tabs abiertos - solo uno puede tener persistencia
                                console.warn("‚ö†Ô∏è Persistencia offline no disponible: m√∫ltiples pesta√±as abiertas (normal)");
                            } else if (persistenceError.code === 'unimplemented') {
                                // Navegador no soporta IndexedDB
                                console.warn("‚ö†Ô∏è Persistencia offline no disponible: navegador no soporta IndexedDB");
                            } else {
                                // Otro error de persistencia
                                console.warn("‚ö†Ô∏è Persistencia offline no disponible:", persistenceError.code || persistenceError.message);
                            }
                            // NO lanzar error - la app puede funcionar sin persistencia
                        }
                    } else {
                        console.warn("‚ö†Ô∏è enablePersistence no est√° disponible en esta versi√≥n de Firestore");
                    }
                    
                    // AHORA S√ç: ejecutar smoke test DESPU√âS de habilitar persistencia
                console.log("üîç Ejecutando smoke test de Firestore...");
                const smokeTest = await smokeTestFirestore(db);
                
                if (!smokeTest.success) {
                        // Solo lanzar error si es un problema de red real
                        if (smokeTest.isNetworkError) {
                            throw new Error(`Error de red al conectar con Firestore: ${smokeTest.error?.code || 'network-error'}`);
                        }
                        
                        // Si el error NO es de red ni de permisos, verificar si Firebase est√° realmente inicializado
                        if (!smokeTest.isPermissionDenied) {
                            // Verificar si realmente tenemos acceso a Firebase
                            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                                throw new Error("Firebase no est√° completamente inicializado. Los scripts pueden no haberse cargado correctamente.");
                            }
                            // Si Firebase est√° inicializado pero el smoke test fall√≥ por otra raz√≥n,
                            // considerar como √©xito (puede ser un problema temporal o de configuraci√≥n)
                            console.warn("‚ö†Ô∏è Smoke test fall√≥ pero Firebase est√° inicializado. Continuando...");
                        }
                    }
                    
                    // Si es permission-denied, mostrar advertencia pero continuar (√©xito)
                    if (smokeTest.isPermissionDenied) {
                        console.warn("‚ö†Ô∏è Firestore conectado pero reglas de seguridad bloquean acceso. Esto es normal si las reglas est√°n restringidas.");
                    }
                    
                    // Si llegamos aqu√≠, el smoke test pas√≥ o fue no cr√≠tico
                    console.log("‚úÖ Smoke test completado exitosamente");
                
                // Si llegamos aqu√≠, Firebase est√° completamente conectado
                firebaseInitialized = true;
                firebaseConnectionStatus = 'connected';
                firebaseConnectionError = null;
                console.log("‚úÖ Firebase completamente inicializado y conectado");
                console.log("‚úÖ Auth:", !!auth);
                console.log("‚úÖ Firestore:", !!db);
                    console.log("‚úÖ Storage:", !!storage);
                
                // Disparar evento personalizado
                window.dispatchEvent(new CustomEvent('firebaseInitialized', { 
                        detail: { app, auth, db, storage } 
                }));
                
                    return { app, auth, db, storage };
                
            } catch (error) {
                console.error("‚ùå Error al inicializar Firebase:", error);
                firebaseInitialized = false;
                firebaseConnectionStatus = 'error';
                firebaseConnectionError = {
                    code: error.code || 'initialization-error',
                    message: error.message || 'Error desconocido al inicializar Firebase',
                    details: error.toString()
                };
                
                window.dispatchEvent(new CustomEvent('firebaseError', { 
                    detail: firebaseConnectionError 
                }));
                    
                    // Limpiar promise para permitir reintento
                    firebaseInitPromise = null;
                    throw error;
                }
            })();
            
            return firebaseInitPromise;
        };
        
        // Funci√≥n de diagn√≥stico para detectar problemas de carga
        const runFirebaseDiagnostics = async () => {
            const diagnostics = {
                online: navigator.onLine,
                firebaseGlobal: typeof firebase !== 'undefined',
                firebaseApps: typeof firebase !== 'undefined' && firebase.apps ? firebase.apps.length : 0,
                scriptsLoaded: [],
                networkTest: null,
                timestamp: new Date().toISOString()
            };
            
            // Verificar recursos de Firebase cargados
            try {
                const resources = performance.getEntriesByType('resource');
                const firebaseResources = resources.filter(r => 
                    r.name.includes('firebasejs') || r.name.includes('gstatic.com/firebasejs')
                );
                diagnostics.scriptsLoaded = firebaseResources.map(r => ({
                    url: r.name,
                    duration: r.duration,
                    status: r.responseStatus || 'unknown',
                    loaded: r.duration > 0
                }));
            } catch (e) {
                diagnostics.scriptsLoaded = [{ error: 'No se pudo verificar recursos' }];
            }
            
            // Test de red a los scripts reales de Firebase (no a la ra√≠z que da 404)
            // Verificar que los scripts espec√≠ficos se cargaron correctamente
            try {
                const testStart = performance.now();
                // Test a uno de los scripts reales que se cargan (firebase-app-compat.js)
                const scriptUrl = 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js';
                const response = await fetch(scriptUrl, { 
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                diagnostics.networkTest = {
                    success: true,
                    duration: performance.now() - testStart,
                    testedUrl: scriptUrl
                };
            } catch (e) {
                diagnostics.networkTest = {
                    success: false,
                    error: e.message || 'Error de red',
                    testedUrl: 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js'
                };
            }
            
            return diagnostics;
        };
        
        // Funci√≥n mejorada para esperar Firebase con timeout robusto y reintento
        let waitAttempts = 0;
        let retryCount = 0;
        const MAX_WAIT_ATTEMPTS = 120; // 12 segundos (120 * 100ms)
        const MAX_RETRIES = 1; // 1 reintento adicional
        
        const waitForFirebase = async (isRetry = false) => {
            waitAttempts++;
            
            // Verificar que Firebase est√© disponible (COMPAT API)
            const isFirebaseReady = typeof firebase !== 'undefined' && 
                typeof firebase.initializeApp !== 'undefined' && 
                typeof firebase.firestore !== 'undefined' &&
                typeof firebase.auth !== 'undefined' &&
                firebase.apps !== undefined;
            
            if (isFirebaseReady) {
                // Verificar que firebase.apps est√© disponible
                if (firebase.apps && Array.isArray(firebase.apps)) {
                    console.log("‚úÖ Firebase scripts detectados correctamente");
                // Firebase est√° listo, inicializar
                    await initializeFirebase();
                    return;
                }
            }
            
            if (waitAttempts >= MAX_WAIT_ATTEMPTS) {
                // Timeout alcanzado - intentar reintento si no es un reintento
                if (!isRetry && retryCount < MAX_RETRIES) {
                    retryCount++;
                    waitAttempts = 0;
                    console.log(`üîÑ Reintentando carga de Firebase (intento ${retryCount + 1}/${MAX_RETRIES + 1})...`);
                    setTimeout(() => waitForFirebase(true), 1000);
                    return;
                }
                
                // Timeout final - ejecutar diagn√≥stico
                console.error("‚ùå Timeout esperando scripts de Firebase");
                const diagnostics = await runFirebaseDiagnostics();
                console.error("üìä Diagn√≥stico:", diagnostics);
                
                // Determinar causa del error
                let errorMessage = 'Los scripts de Firebase no se cargaron en el tiempo esperado';
                let errorDetails = 'Verifica tu conexi√≥n a internet y que los scripts se est√©n cargando correctamente desde gstatic.com';
                
                if (!diagnostics.online) {
                    errorMessage = 'Sin conexi√≥n a internet';
                    errorDetails = 'Tu dispositivo no est√° conectado a internet. Verifica tu conexi√≥n de red.';
                } else if (diagnostics.networkTest && !diagnostics.networkTest.success) {
                    errorMessage = 'Error de red al conectar con Firebase';
                    errorDetails = `No se pudo conectar con los servidores de Firebase (gstatic.com). Posibles causas:\n- Bloqueador de anuncios activo\n- Firewall o proxy bloqueando\n- DNS no resuelve gstatic.com\n\nPrueba en ventana inc√≥gnito o desactiva bloqueadores de anuncios.`;
                } else if (diagnostics.scriptsLoaded.length === 0) {
                    errorMessage = 'Scripts de Firebase no se cargaron';
                    errorDetails = 'Los scripts de Firebase no aparecen en los recursos cargados. Verifica la consola del navegador para errores de red.';
                }
                
                firebaseConnectionStatus = 'error';
                firebaseConnectionError = {
                    code: 'scripts-timeout',
                    message: errorMessage,
                    details: errorDetails,
                    diagnostics: diagnostics
                };
                window.dispatchEvent(new CustomEvent('firebaseError', { 
                    detail: firebaseConnectionError 
                }));
            } else {
                // Reintentar
                setTimeout(() => waitForFirebase(isRetry), 100);
            }
        };
        
        // Iniciar cuando el DOM est√© listo
        const startFirebaseInit = () => {
            // Esperar un poco para que los scripts se carguen
            setTimeout(() => waitForFirebase(false), 500);
        };
        
        if (document.readyState === 'loading') {
            window.addEventListener('load', startFirebaseInit);
        } else {
            startFirebaseInit();
        }
        
        // Funci√≥n global para reintentar manualmente
        window.retryFirebaseConnection = () => {
            waitAttempts = 0;
            retryCount = 0;
            firebaseConnectionStatus = 'initializing';
            firebaseConnectionError = null;
            firebaseInitPromise = null; // Limpiar promise para permitir reinicializaci√≥n
            firebaseInitialized = false; // Resetear estado
            startFirebaseInit();
        };
        
        // Funci√≥n global para ejecutar diagn√≥stico
        window.runFirebaseDiagnostics = runFirebaseDiagnostics;

        // Verificar conexi√≥n a Firestore (smoke test real)
        const checkFirestoreConnection = async () => {
            // Esperar hasta que Firebase est√© inicializado (m√°ximo 3 segundos)
            let attempts = 0;
            while (!firebaseInitialized && attempts < 30) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!firebaseInitialized || !db) {
                return false;
            }
            
            // Smoke test real: usar getDoc en lugar de limit(0) (limit(0) no es v√°lido)
            try {
                const testDocRef = db.collection('_health').doc('ping');
                await testDocRef.get();
                // Si llegamos aqu√≠, Firestore est√° conectado (exista o no el documento)
                return true;
            } catch (error) {
                // Si es error de permisos, Firebase est√° conectado (las reglas est√°n funcionando)
                if (error.code === 'permission-denied') {
                    return true; // Consideramos conectado, las reglas funcionan
                }
                // Errores de red son cr√≠ticos
                if (error.code === 'unavailable' || error.code === 'network-request-failed') {
                    console.warn("‚ö†Ô∏è Smoke test: Error de red", error.code);
                return false;
                }
                // Otros errores pueden ser no cr√≠ticos (persistencia offline, etc.)
                console.warn("‚ö†Ô∏è Smoke test fall√≥:", error.code, "pero Firebase est√° inicializado");
                return true; // Consideramos conectado si Firebase est√° inicializado
            }
        };

        const { useState, useEffect, useMemo } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.75" strokeLinecap="round" strokeLinejoin="round" className={`icon-elegant ${className || "w-5 h-5"}`.trim()} style={{ flexShrink: 0 }}>{path}</svg>;
        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Settings: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />,
            Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8" rx="1"></rect></>} />,
            ChevronsRight: (p) => <Icon {...p} path={<polyline points="13 17 18 12 13 7"></polyline>} />,
            UserCog: (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />,
            Menu: (p) => <Icon {...p} path={<><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="18" x2="20" y2="18"></line></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            Undo: (p) => <Icon {...p} path={<><polyline points="3 7 3 1 9 1"></polyline><path d="M21 12v6a2 2 0 0 1-2 2H3"></path><path d="M3 12l9-9 9 9"></path></>} />,
            Redo: (p) => <Icon {...p} path={<><polyline points="21 7 21 1 15 1"></polyline><path d="M3 12v6a2 2 0 0 0 2 2h16"></path><path d="M21 12l-9-9-9 9"></path></>} />,
            Minus: (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"></line>} />,
            Folder: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></>} />,
            LayoutDashboard: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="9" rx="1"></rect><rect x="14" y="3" width="7" height="9" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Bot: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>} />,
            FolderPlus: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1 2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            FileSpreadsheet: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />,
            Layout: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></>} />,
            Type: (p) => <Icon {...p} path={<><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></>} />,
            Image: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></>} />,
            Grid: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></>} />,
            QrCode: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect></>} />,
            AlignLeft: (p) => <Icon {...p} path={<><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></>} />,
            AlignCenter: (p) => <Icon {...p} path={<><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></>} />,
            AlignRight: (p) => <Icon {...p} path={<><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            XCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></>} />,
            UserCheck: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></>} />,
            ChevronsLeft: (p) => <Icon {...p} path={<><polyline points="11 17 6 12 11 7"></polyline><polyline points="18 17 13 12 18 7"></polyline></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></>} />
        };

        // --- COMPONENTS ---

        const AnimatedCounter = ({ value }) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0; const end = parseInt(value, 10);
                if (isNaN(end)) return;
                if (start === end) { setCount(end); return; }
                const duration = 1000; const incrementTime = 20; const stepAmount = Math.ceil(end / (duration / incrementTime));
                let timer = setInterval(() => {
                    start += stepAmount;
                    if (start >= end) { setCount(end); clearInterval(timer); } else { setCount(start); }
                }, incrementTime);
                return () => clearInterval(timer);
            }, [value]);
            return <span>{count}</span>;
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            useEffect(() => {
                if (!isOpen) return;
                const handler = (e) => { if (e.key === 'Escape') onClose(); };
                document.addEventListener('keydown', handler);
                return () => document.removeEventListener('keydown', handler);
            }, [isOpen, onClose]);
            if (!isOpen) return null;
            return (
                <div className="mobile-modal-top fixed left-0 right-0 bottom-0 top-14 md:top-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in overflow-y-auto">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[85vh] md:max-h-[90vh] modal-animate my-auto`}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            useEffect(() => {
                if (!isOpen) return;
                const handler = (e) => { if (e.key === 'Escape') onClose(); };
                document.addEventListener('keydown', handler);
                return () => document.removeEventListener('keydown', handler);
            }, [isOpen, onClose]);
            if (!isOpen) return null;
            return (
                <div className="mobile-modal-top fixed left-0 right-0 bottom-0 top-14 md:top-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col modal-animate p-6 text-center">
                        <h3 className="text-lg font-medium text-slate-900 mb-2">{title}</h3>
                        <p className="text-sm text-slate-500 mb-6">{message}</p>
                        <div className="flex justify-center gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-sm">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SISTEMA DE CACHE MEJORADO ---
        class CacheManager {
            constructor() {
                this.PATIENT_CACHE_PREFIX = 'patient_cache_';
                this.PATIENT_LIST_CACHE_KEY = 'patient_list_cache';
                this.MEDICINES_CACHE_KEY = 'medicines_cache';
                this.CONTACTS_CACHE_KEY = 'contacts_cache';
                this.USERS_CACHE_KEY = 'users_cache';
                this.KITS_CACHE_KEY = 'kits_cache';
                this.CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
            }
            
            getFromCache(key) {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;
                    
                    const { data, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    
                    if (now - timestamp > this.CACHE_DURATION) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error reading cache:', error);
                    return null;
                }
            }
            
            saveToCache(key, data) {
                try {
                    const cacheData = {
                        data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(key, JSON.stringify(cacheData));
                } catch (error) {
                    console.error('Error saving to cache:', error);
                }
            }
            
            clearCache(key) {
                localStorage.removeItem(key);
            }
            
            clearPatientCache(patientId = null) {
                if (patientId) {
                    localStorage.removeItem(`${this.PATIENT_CACHE_PREFIX}${patientId}`);
                } else {
                    localStorage.removeItem(this.PATIENT_LIST_CACHE_KEY);
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(this.PATIENT_CACHE_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                }
            }
            
            getPatient(patientId) {
                return this.getFromCache(`${this.PATIENT_CACHE_PREFIX}${patientId}`);
            }
            
            savePatient(patientId, patientData) {
                this.saveToCache(`${this.PATIENT_CACHE_PREFIX}${patientId}`, patientData);
            }
            
            getPatientList() {
                return this.getFromCache(this.PATIENT_LIST_CACHE_KEY);
            }
            
            savePatientList(patientList) {
                this.saveToCache(this.PATIENT_LIST_CACHE_KEY, patientList);
            }
            
            getMedicines() {
                return this.getFromCache(this.MEDICINES_CACHE_KEY);
            }
            
            saveMedicines(medicines) {
                this.saveToCache(this.MEDICINES_CACHE_KEY, medicines);
            }
            
            getContacts() {
                return this.getFromCache(this.CONTACTS_CACHE_KEY);
            }
            
            saveContacts(contacts) {
                this.saveToCache(this.CONTACTS_CACHE_KEY, contacts);
            }
            
            getUsers() {
                return this.getFromCache(this.USERS_CACHE_KEY);
            }
            
            saveUsers(users) {
                this.saveToCache(this.USERS_CACHE_KEY, users);
            }
            
            getKits() {
                return this.getFromCache(this.KITS_CACHE_KEY);
            }
            
            saveKits(kits) {
                this.saveToCache(this.KITS_CACHE_KEY, kits);
            }
            
            isValid(key) {
                const cached = localStorage.getItem(key);
                if (!cached) return false;
                
                try {
                    const { timestamp } = JSON.parse(cached);
                    return Date.now() - timestamp < this.CACHE_DURATION;
                } catch {
                    return false;
                }
            }
        }

        // --- BLOCK: LOGIN ---
        // --- FIREBASE CONNECTION SCREEN ---
        const FirebaseConnectionScreen = () => {
            const [status, setStatus] = useState(firebaseConnectionStatus);
            const [error, setError] = useState(firebaseConnectionError);
            
            useEffect(() => {
                const handleInitialized = () => {
                    setStatus('connected');
                    setError(null);
                };
                
                const handleError = (e) => {
                    setStatus('error');
                    setError(e.detail);
                };
                
                window.addEventListener('firebaseInitialized', handleInitialized);
                window.addEventListener('firebaseError', handleError);
                
                // Verificar estado inicial
                if (firebaseInitialized) {
                    setStatus('connected');
                }
                
                return () => {
                    window.removeEventListener('firebaseInitialized', handleInitialized);
                    window.removeEventListener('firebaseError', handleError);
                };
            }, []);
            
            if (status === 'connected') {
                return null;
            }
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6">
                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-md border-white/50 text-center">
                        <div className="mb-8">
                            {status === 'initializing' ? (
                                <div className="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-pulse">
                                    <Icons.Activity size={40} />
                                </div>
                            ) : (
                                <div className="bg-gradient-to-tr from-red-500 to-orange-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white">
                                    <Icons.AlertCircle size={40} />
                                </div>
                            )}
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font mb-2">
                                {status === 'initializing' ? 'Conectando...' : 'Error de Conexi√≥n'}
                            </h1>
                            <p className="text-sm text-slate-500">
                                {status === 'initializing' 
                                    ? 'Inicializando Firebase...' 
                                    : 'No se pudo conectar con la base de datos'}
                            </p>
                        </div>
                        
                        {status === 'initializing' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-center gap-2 text-sm text-slate-600">
                                    <div className="w-2 h-2 bg-turquoise-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                    <div className="w-2 h-2 bg-turquoise-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                    <div className="w-2 h-2 bg-turquoise-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                </div>
                                <p className="text-xs text-slate-400">Por favor espera...</p>
                            </div>
                        )}
                        
                        {status === 'error' && error && (
                            <div className="space-y-4 text-left">
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="font-bold text-red-700 mb-2">‚ùå Error de conexi√≥n</div>
                                    <div className="text-xs text-red-600 whitespace-pre-line">
                                        {error.message || error.details || 'Error desconocido'}
                                    </div>
                                </div>
                                
                                {error.code && (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                        <div className="text-xs font-mono text-slate-600">
                                            <div><strong>C√≥digo:</strong> {error.code}</div>
                                        </div>
                                    </div>
                                )}
                                
                                {error.diagnostics && (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 max-h-48 overflow-y-auto">
                                        <div className="text-xs font-mono text-slate-600">
                                            <div className="font-bold mb-2">üìä Diagn√≥stico:</div>
                                            <div><strong>Online:</strong> {error.diagnostics.online ? '‚úÖ S√≠' : '‚ùå No'}</div>
                                            <div><strong>Firebase Global:</strong> {error.diagnostics.firebaseGlobal ? '‚úÖ S√≠' : '‚ùå No'}</div>
                                            <div><strong>Apps Inicializadas:</strong> {error.diagnostics.firebaseApps}</div>
                                            <div><strong>Scripts Cargados:</strong> {error.diagnostics.scriptsLoaded.length}</div>
                                            {error.diagnostics.networkTest && (
                                                <div><strong>Test de Red:</strong> {error.diagnostics.networkTest.success ? '‚úÖ OK' : '‚ùå Fall√≥'}</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => {
                                            if (window.retryFirebaseConnection) {
                                                window.retryFirebaseConnection();
                                            } else {
                                                window.location.reload();
                                            }
                                        }}
                                        className="flex-1 bg-gradient-to-r from-turquoise-500 to-clinical-400 text-white px-6 py-3 rounded-xl font-bold text-sm hover:shadow-lg transition-all"
                                    >
                                        üîÑ Reintentar
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            if (window.runFirebaseDiagnostics) {
                                                const diag = await window.runFirebaseDiagnostics();
                                                console.log("üìä Diagn√≥stico completo:", diag);
                                                alert(`Diagn√≥stico:\n\nOnline: ${diag.online ? 'S√≠' : 'No'}\nFirebase Global: ${diag.firebaseGlobal ? 'S√≠' : 'No'}\nScripts Cargados: ${diag.scriptsLoaded.length}\nTest de Red: ${diag.networkTest?.success ? 'OK' : 'Fall√≥'}\n\nVer consola para m√°s detalles.`);
                                            } else {
                                                alert("Funci√≥n de diagn√≥stico no disponible. Ver consola del navegador.");
                                            }
                                        }}
                                        className="flex-1 bg-gradient-to-r from-slate-500 to-slate-600 text-white px-6 py-3 rounded-xl font-bold text-sm hover:shadow-lg transition-all"
                                    >
                                        üîç Diagn√≥stico
                                    </button>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="flex-1 bg-slate-200 text-slate-700 px-6 py-2 rounded-xl font-bold text-xs hover:bg-slate-300 transition-all"
                                    >
                                        üîÉ Recargar P√°gina
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [firebaseStatus, setFirebaseStatus] = useState('Conectando...');

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // Verificar estado de Firebase peri√≥dicamente hasta que est√© listo
                let isChecking = false;
                let checkCount = 0;
                const checkFirebase = async () => {
                    if (isChecking) return;
                    
                    checkCount++;
                    try {
                        isChecking = true;
                        
                        // Verificaci√≥n directa del estado
                        if (firebaseInitialized && db) {
                            setFirebaseStatus('Conectado');
                            if (checkCount === 1) {
                                console.log("‚úÖ Firebase conectado correctamente");
                                console.log("‚ÑπÔ∏è Las colecciones se crear√°n autom√°ticamente al guardar datos");
                            }
                            isChecking = false;
                            return;
                        }
                        
                        // Si no est√° inicializado, intentar verificaci√≥n completa
                        const isConnected = await checkFirestoreConnection();
                        if (isConnected) {
                            setFirebaseStatus('Conectado');
                            console.log("‚úÖ Firebase conectado correctamente");
                            console.log("‚ÑπÔ∏è Las colecciones se crear√°n autom√°ticamente al guardar datos");
                            isChecking = false;
                        } else {
                            setFirebaseStatus('Conectando...');
                            isChecking = false;
                            // Reintentar despu√©s de 500ms (m√°ximo 20 intentos = 10 segundos)
                            if (checkCount < 20) {
                                setTimeout(checkFirebase, 500);
                            } else {
                                setFirebaseStatus('Error de conexi√≥n');
                                console.error("‚ùå No se pudo conectar a Firebase despu√©s de m√∫ltiples intentos");
                            }
                        }
                    } catch (err) {
                        console.warn("‚ö†Ô∏è Error verificando Firebase:", err);
                        setFirebaseStatus('Conectando...');
                        isChecking = false;
                        // Reintentar despu√©s de 1 segundo
                        if (checkCount < 20) {
                            setTimeout(checkFirebase, 1000);
                        } else {
                            setFirebaseStatus('Error de conexi√≥n');
                        }
                    }
                };
                
                // Escuchar evento de inicializaci√≥n de Firebase
                const handleFirebaseReady = () => {
                    setFirebaseStatus('Conectado');
                    console.log("‚úÖ Firebase detectado como inicializado");
                };
                window.addEventListener('firebaseInitialized', handleFirebaseReady);
                
                // Iniciar verificaci√≥n inmediatamente
                checkFirebase();
                
                // Verificar peri√≥dicamente cada 2 segundos
                const checkInterval = setInterval(() => {
                    if (firebaseStatus !== 'Conectado') {
                        checkFirebase();
                    }
                }, 2000);
                
                // Limpiar al desmontar
                return () => {
                    clearInterval(checkInterval);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    window.removeEventListener('firebaseInitialized', handleFirebaseReady);
                };
            }, []);
            
            const handleLogin = async (e) => {
                e.preventDefault(); 
                setError(''); 
                setLoading(true);
                
                // Usuario admin de emergencia
                if (username.trim().toLowerCase() === 'admin' && password === 'superadmin') { 
                    onLogin('superadmin', 'Super Usuario'); 
                    setLoading(false);
                    return; 
                }
                
                // Verificar si Firebase est√° disponible
                if (!firebaseInitialized || !db) {
                    setError('No se pudo conectar con la base de datos. Por favor, recarga la p√°gina.');
                    setLoading(false);
                    return;
                }
                
                const userKey = username.trim().toLowerCase();
                
                try {
                    const querySnapshot = await db.collection('prod_users')
                        .where('username', '==', userKey)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                            // Validar restricci√≥n de horario si est√° activa
                            if (userData.restriccionHorario) {
                                const ahora = new Date();
                                const diaActual = ahora.getDay(); // 0 = domingo, 1 = lunes, etc.
                                const horaActual = ahora.getHours() * 100 + ahora.getMinutes(); // Formato HHMM
                                
                                // Mapear d√≠a de JavaScript a nuestros d√≠as
                                const diasMap = {
                                    0: 'domingo',
                                    1: 'lunes',
                                    2: 'martes',
                                    3: 'miercoles',
                                    4: 'jueves',
                                    5: 'viernes',
                                    6: 'sabado'
                                };
                                
                                const diaNombre = diasMap[diaActual];
                                const diasPermitidos = userData.diasPermitidos || {};
                                
                                // Verificar si el d√≠a actual est√° permitido
                                if (!diasPermitidos[diaNombre]) {
                                    const diasLabels = {
                                        lunes: 'Lunes',
                                        martes: 'Martes',
                                        miercoles: 'Mi√©rcoles',
                                        jueves: 'Jueves',
                                        viernes: 'Viernes',
                                        sabado: 'S√°bado',
                                        domingo: 'Domingo'
                                    };
                                    setError(`Acceso denegado: Este usuario no tiene permitido acceder los ${diasLabels[diaNombre]}.`);
                                    setLoading(false);
                                    return;
                                }
                                
                                // Verificar si la hora actual est√° dentro del rango permitido
                                if (userData.horaInicio && userData.horaFin) {
                                    const [hInicio, mInicio] = userData.horaInicio.split(':').map(Number);
                                    const [hFin, mFin] = userData.horaFin.split(':').map(Number);
                                    const horaInicio = hInicio * 100 + mInicio;
                                    const horaFin = hFin * 100 + mFin;
                                    
                                    if (horaActual < horaInicio || horaActual > horaFin) {
                                        setError(`Acceso denegado: El horario permitido es de ${userData.horaInicio} a ${userData.horaFin}.`);
                                        setLoading(false);
                                        return;
                                    }
                                }
                            }
                            
                            // Recalcular el rol del sistema desde los roles del departamento si est√°n disponibles
                            // Esto asegura que el rol est√© siempre sincronizado
                            const getSystemRoleFromRoles = (roles) => {
                                if (!roles || roles.length === 0) return 'digitador';
                                if (roles.includes('superadmin')) return 'superadmin';
                                if (roles.includes('admin')) return 'admin';
                                if (roles.some(r => r.includes('supervisor'))) return 'supervisor';
                                return 'digitador';
                            };
                            
                            const calculatedRole = userData.rolesDepartamento && userData.rolesDepartamento.length > 0
                                ? getSystemRoleFromRoles(userData.rolesDepartamento)
                                : (userData.role || 'digitador');
                            
                            // Si el rol calculado es diferente al guardado, actualizar en la base de datos
                            if (calculatedRole !== userData.role && userData.rolesDepartamento && userData.rolesDepartamento.length > 0) {
                                console.log('‚ö†Ô∏è Rol desincronizado detectado. Actualizando rol de', userData.role, 'a', calculatedRole);
                                // Actualizar el rol en la base de datos de forma as√≠ncrona (no bloquear el login)
                                db.collection('prod_users').doc(querySnapshot.docs[0].id).update({ role: calculatedRole })
                                    .catch(err => console.error('Error actualizando rol:', err));
                            }
                            
                            // Pasar informaci√≥n completa del usuario incluyendo departamento y roles
                            onLogin(calculatedRole, userData.nombre || userData.username, {
                                id: querySnapshot.docs[0].id,
                                ...userData,
                                role: calculatedRole // Asegurar que el rol est√© actualizado
                            });
                        } else { 
                            setError("Contrase√±a incorrecta."); 
                            setLoading(false); 
                        }
                    } else { 
                        setError("Usuario no encontrado."); 
                        setLoading(false); 
                    }
                } catch (err) { 
                    console.error('‚ùå Error en login:', err);
                    console.error('Error code:', err.code);
                    console.error('Error message:', err.message);
                    
                    // Manejar errores espec√≠ficos sin congelar la app
                    if (err.code === 'permission-denied') {
                        setError('‚ö†Ô∏è Error de permisos: Las reglas de seguridad de Firestore est√°n bloqueando el acceso. Verifica las reglas en Firebase Console.'); 
                    } else if (err.code === 'unavailable' || err.code === 'deadline-exceeded') {
                        setError('‚ö†Ô∏è Error de conexi√≥n: No se pudo conectar con Firebase. Verifica tu conexi√≥n a internet.'); 
                    } else if (err.code === 'failed-precondition') {
                        setError('‚ö†Ô∏è Error: La base de datos no est√° disponible en este momento.'); 
                    } else {
                        setError(`‚ö†Ô∏è Error de conexi√≥n: ${err.message || 'Error desconocido'}`); 
                    }
                    setLoading(false); 
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6 relative">
                    <div className="absolute top-6 right-6 flex flex-col gap-2">
                        <div className={`px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-sm transition-all ${isOnline ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                            {isOnline ? <Icons.Wifi size={16}/> : <Icons.WifiOff size={16}/>}
                            {isOnline ? 'Conectado a Internet' : 'Sin Conexi√≥n'}
                        </div>
                        <div className={`px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 ${firebaseStatus === 'Conectado' ? 'bg-green-100 text-green-700 border border-green-200' : firebaseStatus === 'Conectando...' ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                            {firebaseStatus === 'Conectado' ? '‚úÖ Base de datos' : firebaseStatus === 'Conectando...' ? 'üîÑ Conectando...' : '‚ùå Base de datos'}
                        </div>
                    </div>

                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50 relative z-10">
                        <div className="text-center mb-10">
                            <div className="w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow overflow-hidden bg-white">
                                <img 
                                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" 
                                    alt="IHSS Logo" 
                                    className="w-full h-full object-contain"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.parentElement.innerHTML = '<div class="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center shadow-glow text-white animate-ekg"><svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.384l-4.614-1.76a1 1 0 00-.836 1.838l7 3a1 1 0 00.788 0l7-3a1 1 0 00-.836-1.838L14.394 7.667a.999.999 0 01-.356.384l4.614 1.76a1 1 0 00.836-1.838l-7-3zM3.5 10.5a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1zm5 0a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1zm5 0a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1z"/></svg></div>';
                                    }}
                                />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font">IHSS <span className="text-turquoise-600">A TU CASA</span></h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Plataforma de Dispensaci√≥n</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold border border-red-100">{error}</div>}
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Usuario</label>
                                    <input 
                                        type="text" 
                                        className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contrase√±a</label>
                                    <input 
                                        type="password" 
                                        className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        required 
                                    />
                                </div>
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full bg-gradient-to-r from-turquoise-500 to-clinical-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect"
                            >
                                {loading ? 'Verificando...' : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- BLOCK: DASHBOARD ---
        const DashboardBlock = ({ setView, stats, userName, role, kits, currentUser, patients = [], users = [], permissions }) => { 
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(()=>setTime(new Date()),1000); return ()=>clearInterval(t); }, []);
            const userDept = (currentUser?.departamento || '').toLowerCase();
            const userRoles = currentUser?.rolesDepartamento || [];
            const { showCalendario, showDespacho, showOperaciones, canViewReports, canViewConfig, canViewPacientes, showBitacoraTrabajo } = permissions || {};
            const allCards = [
                { id: 'reports', label: 'Reportes y Carpetas', icon: Icons.List, color: 'bg-amber-500', desc: 'Ver kits por fecha', allow: () => !!canViewReports && (role === 'admin' || role === 'superadmin') },
                { id: 'reports', label: 'Reportes de mi Departamento', icon: Icons.List, color: 'bg-amber-500', desc: 'Generar reportes de tu departamento', allow: () => !!canViewReports && role === 'supervisor' },
                { id: 'bitacora', label: 'Bit√°cora de trabajo', icon: Icons.Activity, color: 'bg-violet-600', desc: 'Mi trabajo del d√≠a en Contact Center', allow: () => !!showBitacoraTrabajo },
                { id: 'calendario', label: 'Calendario', icon: Icons.Calendar, color: 'bg-emerald-500', desc: 'Ver programaci√≥n y sem√°foros', allow: () => !!showCalendario },
                { id: 'despacho', label: 'Lista de espera', icon: Icons.Box, color: 'bg-violet-500', desc: 'Kits de Revisi√≥n y asignaci√≥n', allow: () => !!showDespacho },
                { id: 'operaciones', label: 'Lista de espera Operaciones', icon: Icons.Box, color: 'bg-amber-600', desc: 'Kits enviados por Despacho', allow: () => !!showOperaciones },
                { id: 'pacientes', label: 'Gesti√≥n de Pacientes', icon: Icons.Users, color: 'bg-turquoise-500', desc: 'Crear kits por DH', allow: () => !!canViewPacientes },
                { id: 'config', label: 'Configuraci√≥n', icon: Icons.Settings, color: 'bg-slate-500', desc: 'Cat√°logos del Sistema', allow: () => !!canViewConfig },
                { id: 'users', label: 'Gesti√≥n de Usuarios', icon: Icons.UserCog, color: 'bg-indigo-500', desc: 'Control de accesos', allow: () => !!canViewConfig },
            ];

            const visibleCards = allCards.filter(c => c.allow());

            // Calcular estad√≠sticas seg√∫n el rol
            const today = new Date().toISOString().split('T')[0];
            let userStats = { workToday: 0, label: '' };
            
            if (role === 'admin' || role === 'superadmin') {
                // Para admin: kits que llegaron a log√≠stica hoy
                const kitsLogisticaHoy = kits.filter(k => {
                    if (!k.fechaEntregaLogistica) return false;
                    const fechaLog = new Date(k.fechaEntregaLogistica).toISOString().split('T')[0];
                    return fechaLog === today;
                });
                userStats = {
                    workToday: kitsLogisticaHoy.length,
                    label: 'Kits en Log√≠stica Hoy'
                };
            } else {
                // Para usuarios normales: kits creados hoy por el usuario
                const userKitsToday = kits.filter(k => {
                    if (!k.fechaArmado) return false;
                    const fechaArm = new Date(k.fechaArmado).toISOString().split('T')[0];
                    const digitadorMatch = k.digitador && k.digitador.toLowerCase().includes(userName.toLowerCase());
                    return fechaArm === today && digitadorMatch;
                });
                userStats = {
                    workToday: userKitsToday.length,
                    label: 'Mi Trabajo Hoy'
                };
            }

            return (
                <div className="w-full min-w-0 max-w-6xl mx-auto space-y-6 md:space-y-8 animate-in px-0">
                    <div className="bg-gradient-to-r from-turquoise-600 to-clinical-600 rounded-2xl md:rounded-3xl p-5 md:p-8 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10">
                            <h1 className="text-3xl font-bold brand-font mb-2">¬°Hola, {userName}!</h1>
                            <p className="opacity-90 text-sm font-medium uppercase tracking-wider">Plataforma de Dispensaci√≥n</p>
                            {(userDept || role || (userRoles && userRoles.length > 0)) && (
                                <div className="mt-3 flex flex-wrap gap-3 text-sm">
                                    {userDept && <span className="bg-white/20 px-3 py-1 rounded-full font-semibold">Departamento: {userDept}</span>}
                                    {userRoles && userRoles.length > 0 ? (
                                        <span className="bg-white/20 px-3 py-1 rounded-full font-semibold">
                                            {userRoles.length === 1 ? 'Cargo: ' : 'Cargos: '}
                                            {userRoles.map(r => (r && r.charAt(0).toUpperCase() + r.slice(1)) || r).join(', ')}
                                        </span>
                                    ) : (
                                        <span className="bg-white/20 px-3 py-1 rounded-full font-semibold">Rol: {role === 'superadmin' ? 'Super Admin' : role === 'supervisor' ? 'Supervisor' : role === 'admin' ? 'Administrador' : role === 'digitador' ? 'Digitador' : role}</span>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform origin-bottom-right"></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex flex-col justify-center items-center text-center">
                            <div className="text-5xl font-mono font-bold text-slate-700 tracking-widest mb-2">{time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <div className="text-sm text-slate-400 font-medium uppercase">{time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'})}</div>
                        </div>
                        <div className="md:col-span-2">
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-turquoise-50 text-turquoise-600 rounded-2xl"><Icons.Box size={32}/></div>
                                <div>
                                    <div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={userStats.workToday}/></div>
                                    <div className="text-xs text-slate-400 font-bold uppercase">{userStats.label}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-700 brand-font mt-8">Accesos Directos</h3>
                    {userRoles.length > 1 && (
                        <p className="text-sm text-slate-500 -mt-4 mb-2">La interfaz se adapta a todos tus cargos en la credencial.</p>
                    )}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {visibleCards.map(c => (
                            <button 
                                key={c.id} 
                                onClick={() => setView(c.id)} 
                                className="group relative bg-white p-5 md:p-6 rounded-2xl md:rounded-3xl shadow-soft border border-slate-100 hover:shadow-xl transition-all duration-300 text-left hover:-translate-y-1 overflow-hidden touch-manipulation min-h-[100px]"
                            >
                                <div className={`absolute top-0 right-0 w-24 h-24 ${c.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                <div className={`w-12 h-12 rounded-2xl ${c.color} flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`}>
                                    <c.icon size={24} />
                                </div>
                                <h4 className="font-bold text-lg text-slate-800 mb-1 group-hover:text-turquoise-600 transition-colors">{c.label}</h4>
                                <p className="text-xs text-slate-400">{c.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- BLOCK: CALENDARIO ---
        const getKitCalendarDate = (k) => {
            const raw = (k.fechaConfirmacionContactCenter || k.fechaEntregaKit || k.fechaArmado || '').toString().trim();
            if (!raw) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
            try {
                const x = new Date(raw);
                return isNaN(x.getTime()) ? '' : x.toISOString().split('T')[0];
            } catch { return ''; }
        };

        const nextMonthWorkday = (y, m, d) => {
            const next = new Date(y, m, d);
            const day = next.getDay();
            if (day === 0) next.setDate(next.getDate() + 1);
            if (day === 6) next.setDate(next.getDate() - 1);
            return next.toISOString().split('T')[0];
        };

        const CALENDAR_OMITTED_KEY = 'calendar_omitted';

        const CalendarioBlock = ({ kits, patients, setView, currentUser, users = [], role, onSaveKit, permissions = {} }) => {
            const userDept = (currentUser?.departamento || '').toLowerCase();
            const userRoles = currentUser?.rolesDepartamento || [];
            const isRev = userDept === 'farmacia' && userRoles.includes('revision y asignacion');
            const isCC = userDept === 'contact center' && userRoles.includes('agente contact center');
            const isAdmin = role === 'admin' || role === 'superadmin';
            const [calendarView, setCalendarView] = useState('years');
            const [selectedYear, setSelectedYear] = useState(Math.max(2026, new Date().getFullYear()));
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
            const [selectedDay, setSelectedDay] = useState(null);
            const [semaphoreFilter, setSemaphoreFilter] = useState('all');
            const [omitted, setOmitted] = useState(() => {
                try {
                    const v = localStorage.getItem(CALENDAR_OMITTED_KEY);
                    return v ? JSON.parse(v) : {};
                } catch { return {}; }
            });
            const [suggestionModal, setSuggestionModal] = useState(null);

            const fieldToCheck = isCC ? 'agenteContactCenter' : 'usuarioRevisionAsignacion';
            const currentUserName = (currentUser?.name || currentUser?.username || '').trim().toLowerCase();
            const availableUserNames = useMemo(() => {
                const out = [currentUserName];
                if (!isRev && !isCC) return out;
                (users || []).forEach(u => {
                    if (u.id === currentUser?.id) return;
                    const n = (u.nombre || u.username || '').trim().toLowerCase();
                    if (!n) return;
                    if (isCC && u.departamento === 'contact center' && u.rolesDepartamento?.includes('agente contact center') && u.trabajoCompartido) out.push(n);
                    if (isRev && u.departamento === 'farmacia' && u.rolesDepartamento?.includes('revision y asignacion') && u.trabajoCompartido) out.push(n);
                });
                return out;
            }, [users, currentUser, isRev, isCC, currentUserName]);

            const getSemaphoreForPatient = (p, klist) => {
                const list = (klist || kits.filter(k => k.patientId === p.id && !k._suggestion)).filter(Boolean);
                if (isRev) {
                    if (list.length === 0) return 'green';
                    const sorted = [...list].sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
                    const latest = sorted[0];
                    const sent = !!(latest.contactCenter && String(latest.contactCenter).trim());
                    if (sent && !latest.devueltoPorContactCenter) return 'orange';
                    if (latest.devueltoPorContactCenter && !latest.recetaImpresa) return 'red';
                    return 'green';
                }
                if (isCC) {
                    if (list.length === 0) return 'green';
                    return list.some(k => !k.confirmadoPorContactCenter) ? 'red' : 'green';
                }
                if (isAdmin) {
                    if (list.length === 0) return 'green';
                    const sorted = [...list].sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
                    const latest = sorted[0];
                    const sent = !!(latest.contactCenter && String(latest.contactCenter).trim());
                    if (sent && !latest.devueltoPorContactCenter) return 'orange';
                    if (latest.devueltoPorContactCenter && !latest.recetaImpresa) return 'red';
                    return latest.confirmadoPorContactCenter ? 'green' : 'red';
                }
                return 'green';
            };

            const kitsForRole = useMemo(() => {
                if (isAdmin) return kits;
                return kits.filter(k => {
                    const pt = patients.find(p => p.id === k.patientId);
                    if (!pt) return false;
                    const assignee = (pt[fieldToCheck] || '').trim().toLowerCase();
                    return availableUserNames.some(n => n && assignee === n);
                });
            }, [kits, patients, isAdmin, fieldToCheck, availableUserNames]);

            const suggestions = useMemo(() => {
                const out = [];
                const base = isAdmin ? kits : kitsForRole;
                base.forEach(k => {
                    const fe = (k.fechaEntregaKit || '').toString().trim();
                    if (!fe || !/^\d{4}-\d{2}-\d{2}$/.test(fe)) return;
                    const [y, m, d] = fe.split('-').map(Number);
                    const nextY = m === 12 ? y + 1 : y;
                    const nextM = m === 12 ? 1 : m + 1;
                    const suggested = nextMonthWorkday(nextY, nextM - 1, d);
                    const key = `${k.patientId}_${k.id}_${suggested}`;
                    if (omitted[key]) return;
                    const pt = patients.find(p => p.id === k.patientId);
                    if (!pt) return;
                    if (!isAdmin) {
                        const assignee = (pt[fieldToCheck] || '').trim().toLowerCase();
                        if (!availableUserNames.some(n => n && assignee === n)) return;
                    }
                    out.push({
                        _suggestion: true,
                        _sourceKit: k,
                        _key: key,
                        patientId: k.patientId,
                        patient: pt,
                        suggestedDate: suggested,
                        medicamentos: (k.medicamentos || []).map(m => ({ ...m })),
                        id: 'sug_' + key,
                    });
                });
                return out;
            }, [isAdmin, kits, kitsForRole, patients, fieldToCheck, availableUserNames, omitted]);

            const suggestionsByDate = useMemo(() => {
                const map = {};
                suggestions.forEach(s => {
                    const d = s.suggestedDate;
                    if (!map[d]) map[d] = [];
                    map[d].push(s);
                });
                return map;
            }, [suggestions]);

            const kitsByDate = useMemo(() => {
                const map = {};
                kitsForRole.forEach(k => {
                    const d = getKitCalendarDate(k);
                    if (!d) return;
                    if (!map[d]) map[d] = [];
                    map[d].push(k);
                });
                Object.entries(suggestionsByDate || {}).forEach(([d, arr]) => {
                    if (!map[d]) map[d] = [];
                    map[d].push(...arr);
                });
                return map;
            }, [kitsForRole, suggestionsByDate]);

            const daySemaphore = (dateStr) => {
                const dayKits = (kitsByDate[dateStr] || []).filter(k => !k._suggestion);
                const daySug = (suggestionsByDate[dateStr] || []).filter(s => !omitted[s._key]);
                if (daySug.length > 0 && dayKits.length === 0) return 'blue';
                if (dayKits.length === 0) return 'green';
                let red = false, orange = false;
                const seen = new Set();
                dayKits.forEach(k => {
                    const pt = patients.find(p => p.id === k.patientId);
                    if (!pt || seen.has(pt.id)) return;
                    seen.add(pt.id);
                    const patientKits = kitsForRole.filter(kk => kk.patientId === pt.id);
                    const sem = getSemaphoreForPatient(pt, patientKits);
                    if (sem === 'red') red = true;
                    if (sem === 'orange') orange = true;
                });
                if (red) return 'red';
                if (orange) return 'orange';
                return 'green';
            };

            const dayDetailData = useMemo(() => {
                if (!selectedDay) return { patients: [], kits: [], suggestions: [], bySem: {} };
                const dayKits = (kitsByDate[selectedDay] || []).filter(k => !k._suggestion);
                const daySug = (suggestionsByDate[selectedDay] || []).filter(s => !omitted[s._key]);
                const seen = new Set();
                const out = [];
                dayKits.forEach(k => {
                    const pt = patients.find(p => p.id === k.patientId);
                    if (!pt || seen.has(pt.id)) return;
                    seen.add(pt.id);
                    const patientKits = kitsForRole.filter(kk => kk.patientId === pt.id);
                    const sem = getSemaphoreForPatient(pt, patientKits);
                    out.push({ patient: pt, semaphore: sem, kits: dayKits.filter(kk => kk.patientId === pt.id), suggestion: null });
                });
                daySug.forEach(s => {
                    out.push({ patient: s.patient, semaphore: 'blue', kits: [], suggestion: s });
                });
                const bySem = { red: out.filter(x => x.semaphore === 'red'), orange: out.filter(x => x.semaphore === 'orange'), green: out.filter(x => x.semaphore === 'green'), blue: out.filter(x => x.semaphore === 'blue') };
                return { patients: out, kits: dayKits, suggestions: daySug, bySem };
            }, [selectedDay, kitsByDate, suggestionsByDate, patients, kitsForRole, omitted]);

            const filteredDayDetail = useMemo(() => {
                const { patients: list } = dayDetailData;
                if (semaphoreFilter === 'all') return list;
                return list.filter(x => x.semaphore === semaphoreFilter);
            }, [dayDetailData, semaphoreFilter]);

            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
            const days = [];
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayKits = (kitsByDate[dateStr] || []).filter(k => !k._suggestion);
                const daySug = (suggestionsByDate[dateStr] || []).filter(s => !omitted[s._key]);
                const status = daySemaphore(dateStr);
                const count = dayKits.length + daySug.length;
                days.push({ day: d, dateStr, count, status });
            }

            const handleOmitSuggestion = (s) => {
                setOmitted(prev => {
                    const next = { ...prev, [s._key]: true };
                    try { localStorage.setItem(CALENDAR_OMITTED_KEY, JSON.stringify(next)); } catch (_) {}
                    return next;
                });
                setSuggestionModal(null);
            };

            const handleAcceptSuggestion = async (s) => {
                if (!onSaveKit || !s.patient) return;
                const suggestedDate = s.suggestionModalDate || s.suggestedDate;
                const payload = {
                    fechaArmado: suggestedDate,
                    medicamentos: (s.medicamentos || []).map(m => ({ ...m })),
                    dni: s.patient.dni,
                    nombre: s.patient.nombre,
                    patientId: s.patient.id,
                    digitador: (currentUser?.name || currentUser?.username || '').trim(),
                    deliveryMode: (s._sourceKit?.deliveryMode || 'ventanilla'),
                    triggerMeds: (s.medicamentos || []).length ? `${(s.medicamentos || []).length}/${(s.medicamentos || []).length}` : '',
                };
                if ((s._sourceKit?.deliveryMode || '').toLowerCase() === 'ventanilla') {
                    payload.recetaImpresa = true;
                    payload.fechaImpresionReceta = new Date().toISOString().split('T')[0];
                }
                try {
                    await onSaveKit(null, payload, s.patient.id, false);
                    setOmitted(prev => {
                        const next = { ...prev, [s._key]: true };
                        try { localStorage.setItem(CALENDAR_OMITTED_KEY, JSON.stringify(next)); } catch (_) {}
                        return next;
                    });
                    setSuggestionModal(null);
                } catch (e) {
                    alert('Error al crear kit: ' + (e?.message || e));
                }
            };

            const openDayModal = (dateStr) => {
                setSelectedDay(dateStr);
            };
            const closeDayModal = () => {
                setSelectedDay(null);
                setSuggestionModal(null);
            };

            const { showCalidad, showBitacoraTrabajo, showOperaciones } = permissions || {};
            const goToPatientKit = (patient, kit, opts = {}) => {
                try {
                    if (opts.openPatientOnly) {
                        sessionStorage.setItem('editKitFromReports', JSON.stringify({
                            patientId: patient.id,
                            patient: patient,
                            openPatientOnly: true,
                        }));
                    } else {
                        sessionStorage.setItem('editKitFromReports', JSON.stringify({
                            kitId: kit?.id,
                            patientId: patient.id,
                            kitData: kit || {},
                            patient: patient,
                            viewOnly: true,
                        }));
                    }
                } catch (_) {}
                setView('pacientes');
                closeDayModal();
            };
            const goToTrabajar = (patient, pKits, dateStr) => {
                try {
                    if (isCC && showBitacoraTrabajo) {
                        sessionStorage.setItem('trabajarFromCalendar', JSON.stringify({ area: 'cc', date: dateStr, patientId: patient.id }));
                        setView('bitacora');
                    } else if (isRev && (showOperaciones || showCalidad)) {
                        const kit = (pKits && pKits[0]) || null;
                        if (!kit) { alert('No hay kit para trabajar para este paciente en este d√≠a.'); return; }
                        sessionStorage.setItem('trabajarFromCalendar', JSON.stringify({ area: 'rev', kitId: kit.id, patientId: patient.id }));
                        setView(showOperaciones ? 'operaciones' : 'calidad');
                    } else {
                        alert('No tienes acceso al formulario de trabajo para tu √°rea.');
                        return;
                    }
                } catch (_) {}
                closeDayModal();
            };

            const yearOptions = useMemo(() => {
                const start = 2026;
                const end = Math.max(2032, new Date().getFullYear() + 2);
                return Array.from({ length: end - start + 1 }, (_, i) => start + i);
            }, []);

            return (
                <div className="w-full min-w-0 max-w-6xl mx-auto space-y-6 animate-in">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-2xl md:text-3xl font-bold text-slate-800 brand-font tracking-tight">Calendario</h2>
                        <button onClick={() => setView('pacientes')} className="px-4 py-2.5 rounded-xl border border-slate-200 hover:border-turquoise-300 hover:bg-turquoise-50 text-sm font-bold text-slate-600 flex items-center gap-2 transition-all">
                            <Icons.Users size={18}/> Ir a Pacientes
                        </button>
                    </div>
                    <div className="bg-white/80 backdrop-blur rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                        {calendarView === 'years' && (
                            <div className="p-6 md:p-8">
                                <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Seleccione el a√±o</h4>
                                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                    {yearOptions.map(year => (
                                        <button key={year} onClick={() => { setSelectedYear(year); setCalendarView('months'); }} className="p-4 md:p-5 rounded-2xl border-2 border-slate-200 hover:border-turquoise-400 hover:bg-turquoise-50/80 transition-all text-center font-bold text-slate-700 hover:text-turquoise-600 text-lg">
                                            {year}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        {calendarView === 'months' && (
                            <div className="p-6 md:p-8">
                                <div className="flex justify-between items-center mb-6">
                                    <button onClick={() => setCalendarView('years')} className="text-slate-400 hover:text-slate-600 flex items-center gap-2 text-sm font-bold"><Icons.ArrowLeft size={18}/> A√±os</button>
                                    <h4 className="font-bold text-xl text-slate-800">{selectedYear}</h4>
                                    <div className="w-24" />
                                </div>
                                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                                    {['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'].map((m, i) => (
                                        <button key={i} onClick={() => { setSelectedMonth(i + 1); setCalendarView('days'); }} className="p-4 rounded-2xl border-2 border-slate-200 hover:border-turquoise-400 hover:bg-turquoise-50/80 transition-all text-center font-bold text-slate-700 hover:text-turquoise-600">
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        {calendarView === 'days' && (
                            <div className="p-6 md:p-8">
                                <div className="flex justify-between items-center mb-6">
                                    <button onClick={() => setCalendarView('months')} className="text-slate-400 hover:text-slate-600 flex items-center gap-2 text-sm font-bold"><Icons.ArrowLeft size={18}/> Meses</button>
                                    <h4 className="font-bold text-xl text-slate-800">
                                        {['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][selectedMonth - 1]} {selectedYear}
                                    </h4>
                                    <div className="flex gap-2">
                                        <span className="text-xs font-bold text-slate-400 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"/> Verde</span>
                                        <span className="text-xs font-bold text-slate-400 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-amber-500"/> Naranja</span>
                                        <span className="text-xs font-bold text-slate-400 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"/> Rojo</span>
                                        <span className="text-xs font-bold text-slate-400 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"/> Sugerencia</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 gap-1.5 md:gap-2 mb-2">
                                    {['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'].map(l => <div key={l} className="text-center text-xs font-bold text-slate-500 py-2">{l}</div>)}
                                </div>
                                <div className="grid grid-cols-7 gap-1.5 md:gap-2">
                                    {Array.from({ length: new Date(selectedYear, selectedMonth - 1, 1).getDay() }, (_, i) => <div key={`e${i}`} />)}
                                    {days.map(({ day, dateStr, count, status }) => (
                                        <button
                                            key={day}
                                            onClick={() => openDayModal(dateStr)}
                                            className={`p-2.5 md:p-3 rounded-xl border-2 transition-all text-center font-bold text-sm ${
                                                status === 'red' ? 'bg-red-50 border-red-200 text-red-700 hover:bg-red-100' :
                                                status === 'orange' ? 'bg-amber-50 border-amber-200 text-amber-700 hover:bg-amber-100' :
                                                status === 'blue' ? 'bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100' :
                                                'bg-green-50 border-green-200 text-green-700 hover:bg-green-100'
                                            } ${selectedDay === dateStr ? 'ring-2 ring-offset-2 ring-turquoise-500' : ''}`}
                                        >
                                            <div>{day}</div>
                                            {count > 0 && (
                                                <div className="flex items-center justify-center gap-1 mt-0.5">
                                                    <span className={`w-1.5 h-1.5 rounded-full ${status === 'red' ? 'bg-red-500' : status === 'orange' ? 'bg-amber-500' : status === 'blue' ? 'bg-blue-500' : 'bg-green-500'}`} />
                                                    <span className="text-[10px] md:text-xs">{count}</span>
                                                </div>
                                            )}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {selectedDay && (
                        <Modal isOpen={!!selectedDay} onClose={closeDayModal} title={`${new Date(selectedDay + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`} maxWidth="max-w-2xl">
                            <div className="space-y-4">
                                <div className="flex flex-wrap gap-2">
                                    {['all','red','orange','green','blue'].map(s => (
                                        <button key={s} onClick={() => setSemaphoreFilter(s)} className={`px-3 py-1.5 rounded-xl text-xs font-bold transition-all ${
                                            semaphoreFilter === s ? (s === 'all' ? 'bg-slate-600 text-white' : s === 'red' ? 'bg-red-600 text-white' : s === 'orange' ? 'bg-amber-600 text-white' : s === 'green' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white') :
                                            s === 'all' ? 'bg-slate-200 text-slate-600' : s === 'red' ? 'bg-red-100 text-red-700' : s === 'orange' ? 'bg-amber-100 text-amber-700' : s === 'green' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'
                                        }`}>
                                            {s === 'all' ? 'Todos' : s === 'red' ? 'Rojo' : s === 'orange' ? 'Naranja' : s === 'green' ? 'Verde' : 'Sugerencias'}
                                        </button>
                                    ))}
                                </div>
                                <div className="space-y-2 max-h-[50vh] overflow-y-auto">
                                    {filteredDayDetail.length === 0 ? (
                                        <p className="text-sm text-slate-500 py-4 text-center">No hay registros para este d√≠a.</p>
                                    ) : (
                                        filteredDayDetail.map(({ patient, semaphore, kits: pKits, suggestion }) => (
                                            <div key={suggestion ? suggestion._key : patient.id} className={`flex items-center gap-3 p-3 rounded-xl border-2 ${
                                                semaphore === 'red' ? 'bg-red-50 border-red-200' : semaphore === 'orange' ? 'bg-amber-50 border-amber-200' : semaphore === 'blue' ? 'bg-blue-50 border-blue-200' : 'bg-green-50 border-green-200'
                                            }`}>
                                                <span className={`w-4 h-4 rounded-full flex-shrink-0 ${semaphore === 'red' ? 'bg-red-500' : semaphore === 'orange' ? 'bg-amber-500' : semaphore === 'blue' ? 'bg-blue-500' : 'bg-green-500'}`} />
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-semibold text-slate-800">{patient.nombre}</div>
                                                    <div className="text-xs text-slate-500">{patient.dni}{suggestion ? ' ¬∑ Sugerencia' : ''}</div>
                                                </div>
                                                {suggestion ? (
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setSuggestionModal({ ...suggestion, suggestionModalDate: suggestion.suggestedDate })} className="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-bold hover:bg-blue-700">Aceptar / Omitir</button>
                                                    </div>
                                                ) : (
                                                    <div className="flex gap-2">
                                                        <button onClick={() => goToPatientKit(patient, (pKits || [])[0], { openPatientOnly: true })} className="px-3 py-1.5 rounded-lg bg-turquoise-600 text-white text-xs font-bold hover:bg-turquoise-700">Ver</button>
                                                        {((isCC && showBitacoraTrabajo) || (isRev && (showOperaciones || showCalidad))) && (
                                                            <button onClick={() => goToTrabajar(patient, pKits || [], selectedDay)} className="px-3 py-1.5 rounded-lg bg-amber-600 text-white text-xs font-bold hover:bg-amber-700">Trabajar</button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>
                                <div className="pt-2 flex justify-end">
                                    <button onClick={closeDayModal} className="px-5 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700">Cerrar</button>
                                </div>
                            </div>
                        </Modal>
                    )}

                    {suggestionModal && (
                        <Modal isOpen={true} onClose={() => setSuggestionModal(null)} title="Sugerencia de kit" maxWidth="max-w-lg">
                            <div className="space-y-4">
                                <p className="text-sm text-slate-600">Se sugiere crear un kit para <strong>{suggestionModal.patient?.nombre}</strong> el <strong>{suggestionModal.suggestionModalDate || suggestionModal.suggestedDate}</strong> con los mismos medicamentos del kit dispensado anteriormente.</p>
                                <div className="p-3 bg-slate-50 rounded-xl">
                                    <label className="text-xs font-bold text-slate-500 block mb-1">Fecha sugerida</label>
                                    <input type="date" value={suggestionModal.suggestionModalDate || suggestionModal.suggestedDate || ''} onChange={e => setSuggestionModal({ ...suggestionModal, suggestionModalDate: e.target.value })} className="w-full p-2 border rounded-lg text-sm" />
                                </div>
                                {(suggestionModal.medicamentos || []).length > 0 && (
                                    <div className="p-3 bg-slate-50 rounded-xl">
                                        <div className="text-xs font-bold text-slate-500 mb-2">Medicamentos</div>
                                        <ul className="text-sm text-slate-700 space-y-1">
                                            {(suggestionModal.medicamentos || []).slice(0, 8).map((m, i) => <li key={i}>{m.nombre} √ó {m.cantidad}</li>)}
                                            {(suggestionModal.medicamentos || []).length > 8 && <li className="text-slate-500">‚Ä¶ y {(suggestionModal.medicamentos || []).length - 8} m√°s</li>}
                                        </ul>
                                    </div>
                                )}
                                <div className="flex gap-3">
                                    <button onClick={() => handleAcceptSuggestion(suggestionModal)} className="flex-1 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700">Aceptar</button>
                                    <button onClick={() => handleOmitSuggestion(suggestionModal)} className="flex-1 py-3 rounded-xl bg-slate-500 text-white font-bold hover:bg-slate-600">Omitir</button>
                                </div>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        const formatAgenteContactCenterDisplay = (agenteName, users) => {
            const name = (agenteName || '').trim();
            if (!name) return '‚Äî';
            const u = (users || []).find(x => {
                const n = (x.nombre || x.username || x.name || '').trim().toLowerCase();
                return n && n === name.toLowerCase();
            });
            if (!u) return name;
            const tel = (u.telefono || '').toString().trim();
            return tel ? `${u.nombre || u.username || u.name || name} ------ ${tel}` : (u.nombre || u.username || u.name || name);
        };

        // --- BLOCK: DESPACHO LISTA DE ESPERA ---
        const DespachoListaEsperaBlock = ({ kits, patients, onSaveKit, currentUser, users = [] }) => {
            const listaKits = useMemo(() => {
                const user = (currentUser?.name || '').trim();
                return (kits || []).filter(k => {
                    if (!k.recetaImpresa) return false;
                    const esComplemento = !!k.complemento;
                    if (esComplemento) {
                        if (!!k.complementoEnviadoAOperaciones) return false;
                        const worker = (k.usuarioDespachoMedicamentos || '').trim();
                        if (!worker || user !== worker) return false;
                        return true;
                    }
                    return !k.enviadoAOperaciones;
                }).sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
            }, [kits, currentUser?.name]);
            const listaKitsVentanilla = useMemo(() => listaKits.filter(k => (k.deliveryMode || '').toLowerCase() === 'ventanilla'), [listaKits]);
            const listaKitsRuta = useMemo(() => listaKits.filter(k => (k.deliveryMode || '').toLowerCase() === 'ruta'), [listaKits]);
            const bitacoraPorDia = useMemo(() => {
                const porFecha = {};
                (kits || []).forEach(k => {
                    const feOp = (k.fechaEnvioOperaciones || '').trim();
                    const feComp = (k.fechaEnvioComplemento || '').trim();
                    if (k.enviadoAOperaciones && feOp) {
                        porFecha[feOp] = porFecha[feOp] || {};
                        porFecha[feOp][k.id] = { ...k, _bitacoraTipo: 'envio' };
                    }
                    if (k.complementoEnviadoAOperaciones && feComp) {
                        porFecha[feComp] = porFecha[feComp] || {};
                        const existing = porFecha[feComp][k.id];
                        if (existing) {
                            porFecha[feComp][k.id] = { ...existing, _bitacoraAmbos: true };
                        } else {
                            porFecha[feComp][k.id] = { ...k, _bitacoraTipo: 'complemento' };
                        }
                    }
                });
                return Object.entries(porFecha)
                    .map(([f, map]) => {
                        const arr = Object.values(map);
                        return { fecha: f, kits: arr, count: arr.length };
                    })
                    .sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits]);
            const [listaEsperaTab, setListaEsperaTab] = useState('ventanilla');
            const [listaEsperaSearch, setListaEsperaSearch] = useState('');
            const [bitacoraFechaAbierta, setBitacoraFechaAbierta] = useState(null);
            const [bitacoraModalSearch, setBitacoraModalSearch] = useState('');
            const [bitacoraCarpetasSearch, setBitacoraCarpetasSearch] = useState('');
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);
            const [kitData, setKitData] = useState({});
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [formViewOnly, setFormViewOnly] = useState(false);
            const toUpper = (v) => (v != null && v !== '' ? String(v).toUpperCase() : v);
            const medsCounter = useMemo(() => {
                const m = kitData.medicamentos || [];
                const total = m.length;
                const dispensados = m.filter(x => x.dispensar !== false).length;
                return { dispensados, total, str: total ? `${dispensados}/${total}` : '0/0' };
            }, [kitData.medicamentos]);
            const handleMedChange = (idx, field, val) => {
                const v = (field === 'nombre' || field === 'observaciones' || field === 'idReceta') ? toUpper(val) : val;
                const newMeds = [...(kitData.medicamentos || [])];
                newMeds[idx] = { ...newMeds[idx], [field]: v };
                setKitData({ ...kitData, medicamentos: newMeds });
            };
            const openKitForm = (kit, viewOnly) => {
                const patient = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                if (!patient) {
                    alert('No se encontr√≥ el paciente asociado a este kit.');
                    return;
                }
                const meds = (kit.medicamentos || []).map(m => ({
                    ...m,
                    dispensar: m.dispensar !== false,
                    observaciones: m.observaciones || '',
                    recetaFisicaVerificada: !!m.recetaFisicaVerificada
                }));
                setKitData({
                    ...kit,
                    medicamentos: meds,
                    recetaImpresa: !!kit.recetaImpresa,
                    complemento: !!kit.complemento
                });
                setSelectedPatient(patient);
                setEditingKitId(kit.id);
                setFormViewOnly(!!viewOnly);
                setShowKitForm(true);
            };
            const handleVerKit = (kit) => openKitForm(kit, false);
            const handleVisualizarKit = (kit) => openKitForm(kit, true);
            const closeForm = () => {
                setShowKitForm(false);
                setEditingKitId(null);
                setKitData({});
                setSelectedPatient(null);
                setFormViewOnly(false);
            };
            const handleDespachoSubmit = async (e) => {
                e.preventDefault();
                if (!editingKitId || !selectedPatient || !onSaveKit) return;
                try {
                    const m = kitData.medicamentos || [];
                    const total = m.length;
                    const dispensados = m.filter(x => x.dispensar !== false).length;
                    const esComplemento = !!kitData.complemento;
                    const payload = {
                        medicamentos: kitData.medicamentos,
                        triggerMeds: total ? `${dispensados}/${total}` : '',
                        digitador: kitData.digitador || currentUser?.name,
                        dni: selectedPatient.dni,
                        nombre: selectedPatient.nombre,
                        patientId: selectedPatient.id,
                        recetasVerificadasEnDespacho: esComplemento ? (kitData.recetasVerificadasEnDespacho || false) : true,
                        usuarioDespachoMedicamentos: kitData.usuarioDespachoMedicamentos || currentUser?.name || ''
                    };
                    if (esComplemento) payload.complementoVerificadoEnDespacho = true;
                    await onSaveKit(editingKitId, payload, selectedPatient.id, true);
                    closeForm();
                } catch (err) {
                    alert('Error al guardar kit: ' + (err?.message || err));
                }
            };
            const handleEnviarAOperaciones = async (kit) => {
                const esComplemento = !!kit.complemento;
                try {
                    const data = esComplemento
                        ? { complementoEnviadoAOperaciones: true, fechaEnvioComplemento: new Date().toISOString().split('T')[0] }
                        : { enviadoAOperaciones: true, fechaEnvioOperaciones: new Date().toISOString().split('T')[0] };
                    await onSaveKit(kit.id, data, kit.patientId, true);
                } catch (e) {
                    alert('Error al enviar ' + (esComplemento ? 'complemento' : 'a Operaciones') + ': ' + (e?.message || e));
                }
            };
            const formatearFechaBitacora = (f) => {
                if (!f) return '';
                const d = new Date(f + 'T12:00:00');
                return d.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });
            };
            const renderKitRow = (kit, desdeBitacora) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                const esComplemento = !!kit.complemento;
                const puedeEditar = !kit.recetasVerificadasEnDespacho || !kit.usuarioDespachoMedicamentos || (currentUser?.name && String(currentUser.name).trim() === String(kit.usuarioDespachoMedicamentos || '').trim());
                const puedeEditarComplemento = esComplemento && (currentUser?.name && String(currentUser.name).trim() === String(kit.usuarioDespachoMedicamentos || '').trim());
                const mostrarEditar = esComplemento ? puedeEditarComplemento : puedeEditar;
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                                {!!kit._bitacoraAmbos && <span className="px-2 py-0.5 rounded-lg bg-violet-100 text-violet-800 text-xs font-bold">Enviado + complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">{kit.fechaArmado || '‚Äî'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>
                                    {kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}
                                </span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                                {kit.digitador && <span>Imprimi√≥ recetas: {kit.digitador}</span>}
                                {kit.usuarioDespachoMedicamentos && <span>Arm√≥: {kit.usuarioDespachoMedicamentos}</span>}
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {mostrarEditar ? (
                                <button onClick={() => handleVerKit(kit)} className="px-4 py-2 rounded-xl bg-turquoise-600 text-white font-bold text-sm hover:bg-turquoise-700 transition-colors btn-hover-effect flex items-center gap-2">
                                    <Icons.Box size={16}/> Ver / Editar
                                </button>
                            ) : esComplemento ? null : (
                                <button onClick={() => handleVisualizarKit(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                                    <Icons.Eye size={16}/> Visualizar
                                </button>
                            )}
                            {!desdeBitacora && (
                                (() => {
                                    const puedeEnviar = esComplemento ? !!kit.complementoVerificadoEnDespacho : !!kit.recetasVerificadasEnDespacho;
                                    const labelEnviar = esComplemento ? 'Enviar complemento' : 'Enviar a Operaciones';
                                    const titleEnviar = puedeEnviar
                                        ? (esComplemento ? 'Enviar complemento a Operaciones' : 'Enviar kit a Operaciones')
                                        : 'Abra el kit, verifique que las recetas f√≠sicas coincidan con el sistema y guarde antes de enviar.';
                                    return (
                                        <button
                                            onClick={() => puedeEnviar && handleEnviarAOperaciones(kit)}
                                            disabled={!puedeEnviar}
                                            title={titleEnviar}
                                            className={`px-4 py-2 rounded-xl font-bold text-sm btn-hover-effect transition-colors flex items-center gap-2 ${puedeEnviar ? 'bg-violet-600 text-white hover:bg-violet-700 cursor-pointer' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}
                                        >
                                            {labelEnviar}
                                        </button>
                                    );
                                })()
                            )}
                        </div>
                    </div>
                );
            };
            const listadoParaTab = listaEsperaTab === 'ventanilla' ? listaKitsVentanilla : listaKitsRuta;
            const listadoFiltrado = useMemo(() => {
                const t = (listaEsperaSearch || '').trim().toLowerCase();
                if (!t) return listadoParaTab;
                return listadoParaTab.filter(kit => {
                    const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                    const nombre = (kit.nombre || pt?.nombre || '').toLowerCase();
                    const dni = (kit.dni || pt?.dni || '').toString().toLowerCase();
                    return nombre.includes(t) || dni.includes(t);
                });
            }, [listadoParaTab, patients, listaEsperaSearch]);

            useEffect(() => {
                if (listaEsperaTab === 'bitacora') return;
                if (listaEsperaTab === 'ventanilla' && listaKitsVentanilla.length === 0 && listaKitsRuta.length > 0) setListaEsperaTab('ruta');
                else if (listaEsperaTab === 'ruta' && listaKitsRuta.length === 0 && listaKitsVentanilla.length > 0) setListaEsperaTab('ventanilla');
            }, [listaEsperaTab, listaKitsVentanilla.length, listaKitsRuta.length]);

            return (
                <div className="w-full min-w-0 max-w-5xl mx-auto space-y-6 animate-in">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-2xl font-bold text-slate-800 brand-font">Lista de espera ‚Äî Despacho de medicamentos</h2>
                        <p className="text-sm text-slate-500">Kits que vienen de Revisi√≥n y asignaci√≥n</p>
                    </div>
                    <div className="flex gap-2 p-1.5 bg-slate-100 rounded-2xl w-fit">
                        <button onClick={() => setListaEsperaTab('ventanilla')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'ventanilla' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Ventanilla</button>
                        <button onClick={() => setListaEsperaTab('ruta')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'ruta' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Ruta</button>
                        <button onClick={() => setListaEsperaTab('bitacora')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'bitacora' ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Bit√°cora</button>
                    </div>
                    {listaEsperaTab !== 'bitacora' ? (
                    <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                            <div className="flex flex-wrap items-center justify-between gap-3">
                                <span className="font-bold text-slate-700">{listadoFiltrado.length}{listadoParaTab.length !== listadoFiltrado.length ? ` de ${listadoParaTab.length}` : ''} kit(s) en espera ‚Äî {listaEsperaTab === 'ventanilla' ? 'Ventanilla' : 'Ruta'}</span>
                                <div className="relative w-full sm:w-64">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                    <input type="text" placeholder="Buscar por nombre o DNI..." value={listaEsperaSearch} onChange={e=>setListaEsperaSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-violet-300 focus:ring-1 focus:ring-violet-200" />
                                </div>
                            </div>
                        </div>
                        <div className="divide-y divide-slate-100 max-h-[60vh] overflow-y-auto">
                            {listadoFiltrado.length === 0 ? (
                                <div className="p-12 text-center text-slate-500">
                                    <Icons.Box size={48} className="mx-auto mb-3 opacity-40"/>
                                    <p className="font-medium">{listadoParaTab.length === 0 ? 'No hay kits en lista de espera' : 'Sin resultados para la b√∫squeda'}</p>
                                    <p className="text-sm mt-1">{listadoParaTab.length === 0 ? 'Los kits marcados impresos por Revisi√≥n y asignaci√≥n, o complementos pendientes, aparecer√°n aqu√≠ filtrados por ' + (listaEsperaTab === 'ventanilla' ? 'Ventanilla' : 'Ruta') + '.' : 'Pruebe otro t√©rmino.'}</p>
                                </div>
                            ) : (
                                listadoFiltrado.map(kit => renderKitRow(kit, false))
                            )}
                        </div>
                    </div>
                    ) : (
                    <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                            <div className="flex flex-wrap items-center justify-between gap-3">
                                <span className="font-bold text-slate-700">Bit√°cora Lista de Despacho ‚Äî Env√≠os a Operaciones por fecha</span>
                                <div className="relative w-full sm:w-56">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                    <input type="text" placeholder="Buscar por fecha (ej. 2025-01, ene)..." value={bitacoraCarpetasSearch} onChange={e=>setBitacoraCarpetasSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                </div>
                            </div>
                        </div>
                        <div className="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                            {(() => {
                                const t = (bitacoraCarpetasSearch || '').trim().toLowerCase();
                                const filtered = !t ? bitacoraPorDia : bitacoraPorDia.filter(({ fecha }) => {
                                    const fmt = formatearFechaBitacora(fecha).toLowerCase();
                                    return fmt.includes(t) || (fecha || '').toLowerCase().includes(t);
                                });
                                if (filtered.length === 0) return (
                                    <div className="col-span-full p-12 text-center text-slate-500">
                                        <Icons.Folder size={48} className="mx-auto mb-3 opacity-40"/>
                                        <p className="font-medium">{bitacoraPorDia.length === 0 ? 'No hay registros en bit√°cora' : 'Sin resultados para la b√∫squeda'}</p>
                                        <p className="text-sm mt-1">{bitacoraPorDia.length === 0 ? 'Los env√≠os a Operaciones aparecer√°n aqu√≠ organizados por d√≠a.' : 'Pruebe otro t√©rmino (ej. a√±o-mes o nombre del mes).'}</p>
                                    </div>
                                );
                                return filtered.map(({ fecha, kits: ks, count }) => (
                                    <button key={fecha} onClick={() => setBitacoraFechaAbierta(fecha)} className="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-200 hover:border-amber-400 hover:bg-amber-50/50 transition-all text-left btn-hover-effect group">
                                        <div className="p-2.5 rounded-xl bg-amber-100 text-amber-700 group-hover:bg-amber-200"><Icons.Folder size={24}/></div>
                                        <div className="min-w-0 flex-1">
                                            <div className="font-bold text-slate-800 truncate">{formatearFechaBitacora(fecha)}</div>
                                            <div className="text-xs text-slate-500">{count} kit(s) enviado(s)</div>
                                        </div>
                                    </button>
                                ));
                            })()}
                        </div>
                    </div>
                    )}
                    {bitacoraFechaAbierta && (
                        <Modal isOpen={true} onClose={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} title={`Bit√°cora ‚Äî ${formatearFechaBitacora(bitacoraFechaAbierta)}`} maxWidth="max-w-4xl">
                            <div className="space-y-4">
                                <p className="text-sm text-slate-500">Kits enviados a Operaciones este d√≠a. Visualizar o Ver/Editar seg√∫n restricciones.</p>
                                <div className="flex flex-wrap items-center gap-3">
                                    <div className="relative flex-1 min-w-[180px]">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por nombre o DNI..." value={bitacoraModalSearch} onChange={e=>setBitacoraModalSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                    </div>
                                    <span className="text-sm text-slate-500">
                                        {(() => {
                                            const kitsDia = bitacoraPorDia.find(d => d.fecha === bitacoraFechaAbierta)?.kits || [];
                                            const t = (bitacoraModalSearch || '').trim().toLowerCase();
                                            const filtered = !t ? kitsDia : kitsDia.filter(k => {
                                                const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                                const n = (k.nombre || pt?.nombre || '').toLowerCase();
                                                const d = (k.dni || pt?.dni || '').toString().toLowerCase();
                                                return n.includes(t) || d.includes(t);
                                            });
                                            return filtered.length !== kitsDia.length ? `${filtered.length} de ${kitsDia.length}` : `${kitsDia.length} kit(s)`;
                                        })()}
                                    </span>
                                </div>
                                <div className="divide-y divide-slate-100 max-h-[50vh] overflow-y-auto rounded-xl border border-slate-100">
                                    {(() => {
                                        const kitsDia = bitacoraPorDia.find(d => d.fecha === bitacoraFechaAbierta)?.kits || [];
                                        const t = (bitacoraModalSearch || '').trim().toLowerCase();
                                        const filtered = !t ? kitsDia : kitsDia.filter(k => {
                                            const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                            const n = (k.nombre || pt?.nombre || '').toLowerCase();
                                            const d = (k.dni || pt?.dni || '').toString().toLowerCase();
                                            return n.includes(t) || d.includes(t);
                                        });
                                        return filtered.map(kit => <div key={kit.id}>{renderKitRow(kit, true)}</div>);
                                    })()}
                                </div>
                                <div className="flex justify-end pt-2">
                                    <button onClick={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} className="px-6 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                </div>
                            </div>
                        </Modal>
                    )}
                    {showKitForm && (
                        <Modal isOpen={true} onClose={closeForm} title={formViewOnly ? (kitData.complemento ? 'Ver complemento ‚Äî Despacho de medicamentos' : 'Ver kit ‚Äî Despacho de medicamentos') : (kitData.complemento ? 'Complemento ‚Äî Despacho de medicamentos ‚Äî Verificar recetas' : 'Despacho de medicamentos ‚Äî Verificar recetas')} maxWidth="max-w-4xl">
                            <form onSubmit={(e) => { e.preventDefault(); if (!formViewOnly) handleDespachoSubmit(e); }} className="space-y-5">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI</label>
                                        <input type="text" value={selectedPatient?.dni || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre</label>
                                        <input type="text" value={selectedPatient?.nombre || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center asignado</label>
                                        <input type="text" value={formatAgenteContactCenterDisplay(selectedPatient?.agenteContactCenter, users)} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario que imprimi√≥ recetas (Revisi√≥n y asignaci√≥n)</label>
                                        <input type="text" value={kitData.digitador || selectedPatient?.usuarioRevisionAsignacion || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario que lo arma (Despacho de medicamentos)</label>
                                        <input type="text" value={formViewOnly ? (kitData.usuarioDespachoMedicamentos || '‚Äî') : (currentUser?.name || '‚Äî')} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                    <div className="flex items-center justify-between mb-3">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase">Medicamentos asignados</h5>
                                        <span className="text-lg font-bold text-turquoise-600 tabular-nums">{medsCounter.str}</span>
                                    </div>
                                    <div className="space-y-2 mb-4">
                                        {(kitData.medicamentos || []).map((med, idx) => {
                                            const va = med.dispensar !== false;
                                            return (
                                            <div key={idx} className={`p-3 rounded-lg border-2 flex flex-wrap items-center gap-3 ${va ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                <div className="flex-1 min-w-0">
                                                    <span className={`font-semibold ${va ? 'text-green-800' : 'text-red-800'}`}>{med.nombre || '‚Äî'}</span>
                                                    <span className={`ml-2 font-mono text-sm ${va ? 'text-green-600' : 'text-red-600'}`}>√ó {med.cantidad || '‚Äî'}</span>
                                                    <span className={`ml-2 text-xs font-bold ${va ? 'text-green-600' : 'text-red-600'}`}>{va ? '‚úì S√≠ va' : '‚úó No va'}</span>
                                                    {med.observaciones && <p className={`text-xs mt-1 ${va ? 'text-green-700' : 'text-red-700'}`}>Obs: {med.observaciones}</p>}
                                                </div>
                                                {va && (
                                                    <label className={`flex items-center gap-2 shrink-0 ${formViewOnly ? 'cursor-default' : 'cursor-pointer'}`}>
                                                        <input type="checkbox" checked={!!med.recetaFisicaVerificada} onChange={() => !formViewOnly && handleMedChange(idx, 'recetaFisicaVerificada', !med.recetaFisicaVerificada)} disabled={formViewOnly} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                        <span className="text-xs font-bold text-slate-600">Receta f√≠sica verificada</span>
                                                    </label>
                                                )}
                                            </div>
                                            );
                                        })}
                                    </div>
                                    {kitData.observacionesContactCenter && <p className="text-xs text-slate-500">Obs. Rev. y asignaci√≥n: {kitData.observacionesContactCenter}</p>}
                                </div>
                                {!formViewOnly && <p className="text-xs text-slate-500 border-t border-slate-200 pt-4">Verifique que las recetas f√≠sicas coincidan con el sistema. Al actualizar se cierra esta ventana y se habilita ¬´{kitData.complemento ? 'Enviar complemento' : 'Enviar a Operaciones'}¬ª para este kit.</p>}
                                <div className="flex gap-3 pt-4 border-t border-slate-200">
                                    {!formViewOnly && <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Actualizar kit</button>}
                                    <button type="button" onClick={closeForm} className={formViewOnly ? 'flex-1 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect' : 'px-6 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect'}>Cerrar</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        };

        // --- BLOCK: OPERACIONES LISTA DE ESPERA ---
        const OperacionesListaEsperaBlock = ({ kits, patients, onSaveKit, currentUser, users = [], printRutaVignette, printVentanillaVignette, printRefrigeradoVignette }) => {
            const [vistaPrincipal, setVistaPrincipal] = useState('operaciones'); // 'despacho' | 'operaciones'
            const [listaEsperaTab, setListaEsperaTab] = useState('ventanilla');
            const [listaEsperaSearch, setListaEsperaSearch] = useState('');
            const [bitacoraCarpetasSearch, setBitacoraCarpetasSearch] = useState('');
            const [bitacoraFechaAbierta, setBitacoraFechaAbierta] = useState(null);
            const [bitacoraModalSearch, setBitacoraModalSearch] = useState('');
            const [showVerModal, setShowVerModal] = useState(false);
            const [showTrabajarForm, setShowTrabajarForm] = useState(false);
            const [verKit, setVerKit] = useState(null);
            const [trabajarKit, setTrabajarKit] = useState(null);
            const [trabajarData, setTrabajarData] = useState({
                fechaArmado: '',
                horaOperaciones: '',
                isRefrigerated: false,
                cantRefriGlobal: ''
            });
            const [trabajarGuardado, setTrabajarGuardado] = useState(false);
            const [trabajarKitActualizado, setTrabajarKitActualizado] = useState(null);
            const [vi√±etasImpresas, setVi√±etasImpresas] = useState(false);
            const [editandoDesdeBitacora, setEditandoDesdeBitacora] = useState(false);

            useEffect(() => {
                setBitacoraFechaAbierta(null);
                setBitacoraModalSearch('');
                if (vistaPrincipal === 'despacho') setListaEsperaTab('ventanilla');
            }, [vistaPrincipal]);

            const toDateInputValue = (v) => {
                if (!v) return '';
                const s = typeof v === 'string' ? v : new Date(v).toISOString();
                return s.slice(0, 10);
            };

            const toUpper = (v) => (v != null && v !== '' ? String(v).toUpperCase() : v);

            const safeNumber = (v) => {
                const n = parseInt(String(v || '0'), 10);
                return isNaN(n) ? '' : n;
            };

            const calcularMedCounter = (meds) => {
                const m = meds || [];
                const total = m.length;
                const dispensados = m.filter(x => x.dispensar !== false).length;
                return { dispensados, total, str: total ? `${dispensados}/${total}` : '0/0' };
            };

            const formatearFechaBitacora = (f) => {
                if (!f) return '';
                const d = new Date(f + 'T12:00:00');
                return d.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            // Lista Despacho (solo lectura): mismos kits que Despacho ‚Äî Ventanilla/Ruta/Bit√°cora
            const listaKitsDespacho = useMemo(() => {
                return (kits || []).filter(k => {
                    if (!k.recetaImpresa) return false;
                    if (!!k.complemento) return !k.complementoEnviadoAOperaciones;
                    return !k.enviadoAOperaciones;
                }).sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
            }, [kits]);
            const listaDespachoVentanilla = useMemo(() => listaKitsDespacho.filter(k => (k.deliveryMode || '').toLowerCase() === 'ventanilla'), [listaKitsDespacho]);
            const listaDespachoRuta = useMemo(() => listaKitsDespacho.filter(k => (k.deliveryMode || '').toLowerCase() === 'ruta'), [listaKitsDespacho]);
            const bitacoraDespacho = useMemo(() => {
                const porFecha = {};
                (kits || []).forEach(k => {
                    const feOp = (k.fechaEnvioOperaciones || '').trim();
                    const feComp = (k.fechaEnvioComplemento || '').trim();
                    if (k.enviadoAOperaciones && feOp) {
                        porFecha[feOp] = porFecha[feOp] || {};
                        porFecha[feOp][k.id] = { ...k, _bitacoraTipo: 'envio' };
                    }
                    if (k.complementoEnviadoAOperaciones && feComp) {
                        porFecha[feComp] = porFecha[feComp] || {};
                        const ex = porFecha[feComp][k.id];
                        porFecha[feComp][k.id] = ex ? { ...ex, _bitacoraAmbos: true } : { ...k, _bitacoraTipo: 'complemento' };
                    }
                });
                return Object.entries(porFecha).map(([f, map]) => ({ fecha: f, kits: Object.values(map), count: Object.keys(map).length })).sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits]);

            // Mi lista Operaciones: enviados por Despacho, pendientes de trabajar (!fechaArmado)
            const listaKitsOps = useMemo(() => {
                return (kits || []).filter(k => {
                    const enviado = !!k.enviadoAOperaciones || !!k.complementoEnviadoAOperaciones;
                    return enviado && !k.trabajadoOperaciones;
                }).sort((a, b) => new Date(b.fechaEnvioOperaciones || b.fechaEnvioComplemento || 0) - new Date(a.fechaEnvioOperaciones || a.fechaEnvioComplemento || 0));
            }, [kits]);
            const listaOpsVentanilla = useMemo(() => listaKitsOps.filter(k => (k.deliveryMode || '').toLowerCase() === 'ventanilla'), [listaKitsOps]);
            const listaOpsRuta = useMemo(() => listaKitsOps.filter(k => (k.deliveryMode || '').toLowerCase() === 'ruta'), [listaKitsOps]);
            const bitacoraOps = useMemo(() => {
                const porFecha = {};
                (kits || []).forEach(k => {
                    if (!k.trabajadoOperaciones) return;
                    const fa = (k.fechaArmado || '').toString().trim();
                    if (!fa) return;
                    porFecha[fa] = porFecha[fa] || [];
                    porFecha[fa].push(k);
                });
                return Object.entries(porFecha).map(([f, arr]) => ({ fecha: f, kits: arr, count: arr.length })).sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits]);

            const listadoDespacho = listaEsperaTab === 'ventanilla' ? listaDespachoVentanilla : listaDespachoRuta;
            const listadoOps = listaEsperaTab === 'ventanilla' ? listaOpsVentanilla : listaOpsRuta;
            const listadoDespachoFiltrado = useMemo(() => {
                const t = (listaEsperaSearch || '').trim().toLowerCase();
                if (!t) return listadoDespacho;
                return listadoDespacho.filter(k => {
                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const n = (k.nombre || pt?.nombre || '').toLowerCase();
                    const d = (k.dni || pt?.dni || '').toString().toLowerCase();
                    return n.includes(t) || d.includes(t);
                });
            }, [listadoDespacho, patients, listaEsperaSearch]);
            const listadoOpsFiltrado = useMemo(() => {
                const t = (listaEsperaSearch || '').trim().toLowerCase();
                if (!t) return listadoOps;
                return listadoOps.filter(k => {
                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const n = (k.nombre || pt?.nombre || '').toLowerCase();
                    const d = (k.dni || pt?.dni || '').toString().toLowerCase();
                    return n.includes(t) || d.includes(t);
                });
            }, [listadoOps, patients, listaEsperaSearch]);

            const abrirVer = (kit) => { setVerKit(kit); setShowVerModal(true); };
            const cerrarVer = () => { setVerKit(null); setShowVerModal(false); };
            const abrirTrabajar = (kit, desdeBitacora = false) => {
                setTrabajarKit(kit);
                setTrabajarGuardado(false);
                setTrabajarKitActualizado(null);
                setEditandoDesdeBitacora(!!desdeBitacora);
                const today = new Date().toISOString().split('T')[0];
                const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                const fa = (kit.fechaArmado || '').toString().slice(0, 10) || today;
                const ho = (kit.horaOperaciones || '').toString().trim() || now;
                setTrabajarData({
                    fechaArmado: desdeBitacora ? fa : today,
                    horaOperaciones: desdeBitacora ? ho : now,
                    isRefrigerated: !!kit.isRefrigerated,
                    cantRefriGlobal: kit.cantRefriGlobal != null ? String(kit.cantRefriGlobal) : ''
                });
                setShowTrabajarForm(true);
            };
            const cerrarTrabajar = () => {
                setTrabajarKit(null);
                setTrabajarKitActualizado(null);
                setTrabajarGuardado(false);
                setVi√±etasImpresas(false);
                setEditandoDesdeBitacora(false);
                setTrabajarData({ fechaArmado: '', horaOperaciones: '', isRefrigerated: false, cantRefriGlobal: '' });
                setShowTrabajarForm(false);
            };
            useEffect(() => {
                try {
                    const raw = sessionStorage.getItem('trabajarFromCalendar');
                    if (!raw) return;
                    const data = JSON.parse(raw);
                    if ((data.area || '') !== 'rev' || !data.kitId) return;
                    sessionStorage.removeItem('trabajarFromCalendar');
                    const kit = (kits || []).find(k => k.id === data.kitId);
                    if (kit) abrirTrabajar(kit);
                } catch (_) {}
            }, [kits]);
            const handleTrabajarSubmit = async (e) => {
                e.preventDefault();
                if (!trabajarKit || !onSaveKit) return;
                const today = new Date().toISOString().split('T')[0];
                const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                const payload = {
                    fechaArmado: trabajarData.fechaArmado,
                    horaOperaciones: trabajarData.horaOperaciones,
                    trabajadoOperaciones: true,
                    fechaEntregaCalidad: today,
                    horaEntregaCalidad: now,
                    isRefrigerated: !!trabajarData.isRefrigerated,
                    cantRefriGlobal: trabajarData.isRefrigerated ? (trabajarData.cantRefriGlobal && parseInt(trabajarData.cantRefriGlobal, 10) > 0 ? parseInt(trabajarData.cantRefriGlobal, 10) : 1) : '',
                    usuarioOperaciones: (currentUser?.name || currentUser?.nombre || currentUser?.username || '').trim() || '',
                    medicamentos: trabajarKit.medicamentos || []
                };
                try {
                    await onSaveKit(trabajarKit.id, payload, trabajarKit.patientId, true);
                    const updated = { ...trabajarKit, ...payload };
                    setTrabajarKitActualizado(updated);
                    setTrabajarGuardado(true);
                } catch (err) {
                    alert('Error al guardar: ' + (err?.message || err));
                }
            };

            const renderRowDespacho = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">{kit.fechaArmado || '‚Äî'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                            </div>
                        </div>
                        <button onClick={() => abrirVer(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                            <Icons.Eye size={16}/> Visualizar
                        </button>
                    </div>
                );
            };

            const renderRowOps = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">Enviado: {kit.fechaEnvioOperaciones || kit.fechaEnvioComplemento || '‚Äî'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                            </div>
                        </div>
                        <button onClick={() => abrirTrabajar(kit)} className="px-4 py-2 rounded-xl bg-amber-600 text-white font-bold text-sm hover:bg-amber-700 transition-colors btn-hover-effect flex items-center gap-2">
                            <Icons.Box size={16}/> Trabajar
                        </button>
                    </div>
                );
            };

            const esOperadorQueTrabajo = (kit) => {
                const u = (kit.usuarioOperaciones || '').trim().toLowerCase();
                const c = (currentUser?.name || currentUser?.nombre || currentUser?.username || '').trim().toLowerCase();
                return !!u && !!c && u === c;
            };

            const renderRowBitacoraOps = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                const isRuta = (kit.deliveryMode || '').toLowerCase() === 'ruta';
                const isVentanilla = (kit.deliveryMode || '').toLowerCase() === 'ventanilla';
                const hasRefri = !!kit.isRefrigerated || !!(kit.cantRefriGlobal && parseInt(kit.cantRefriGlobal, 10) > 0);
                const puedeEditar = esOperadorQueTrabajo(kit);
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">Hora Ops: {kit.horaOperaciones || '--:--'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2">
                            {puedeEditar && (
                                <button 
                                    type="button" 
                                    onClick={() => abrirTrabajar(kit, true)} 
                                    className="px-3 py-2 rounded-xl bg-amber-600 text-white font-bold text-xs hover:bg-amber-700 transition-colors btn-hover-effect flex items-center gap-1.5"
                                    title="Editar kit (solo el operador que lo trabaj√≥)"
                                >
                                    <Icons.Edit size={14}/> Editar
                                </button>
                            )}
                            {isRuta && printRutaVignette && (
                                <button 
                                    type="button" 
                                    onClick={() => printRutaVignette(kit, pt || {}).catch(err => { console.error(err); alert('Error al imprimir.'); })} 
                                    className="px-3 py-2 rounded-xl bg-emerald-600 text-white font-bold text-xs hover:bg-emerald-700 transition-colors btn-hover-effect flex items-center gap-1.5"
                                    title="Imprimir vi√±eta de Ruta"
                                >
                                    <Icons.Printer size={14}/> Ruta
                                </button>
                            )}
                            {isVentanilla && printVentanillaVignette && (
                                <button 
                                    type="button" 
                                    onClick={() => printVentanillaVignette(kit, pt || {}).catch(err => { console.error(err); alert('Error al imprimir.'); })} 
                                    className="px-3 py-2 rounded-xl bg-indigo-600 text-white font-bold text-xs hover:bg-indigo-700 transition-colors btn-hover-effect flex items-center gap-1.5"
                                    title="Imprimir vi√±eta de Ventanilla"
                                >
                                    <Icons.Printer size={14}/> Ventanilla
                                </button>
                            )}
                            {hasRefri && printRefrigeradoVignette && (
                                <button 
                                    type="button" 
                                    onClick={() => printRefrigeradoVignette(kit, pt || {}).catch(err => { console.error(err); alert('Error al imprimir.'); })} 
                                    className="px-3 py-2 rounded-xl bg-blue-600 text-white font-bold text-xs hover:bg-blue-700 transition-colors btn-hover-effect flex items-center gap-1.5"
                                    title="Imprimir vi√±eta de Refrigerado"
                                >
                                    <Icons.Printer size={14}/> Refrigerado
                                </button>
                            )}
                            <button onClick={() => abrirVer(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                                <Icons.Eye size={16}/> Visualizar
                            </button>
                        </div>
                    </div>
                );
            };

            const bitacoraActual = vistaPrincipal === 'despacho' ? bitacoraDespacho : bitacoraOps;
            const bitacoraCarpetasFiltradas = useMemo(() => {
                const t = (bitacoraCarpetasSearch || '').trim().toLowerCase();
                if (!t) return bitacoraActual;
                return bitacoraActual.filter(({ fecha }) => formatearFechaBitacora(fecha).toLowerCase().includes(t) || (fecha || '').toLowerCase().includes(t));
            }, [bitacoraActual, bitacoraCarpetasSearch]);

            const kitsBitacoraDia = bitacoraFechaAbierta ? (bitacoraActual.find(d => d.fecha === bitacoraFechaAbierta)?.kits || []) : [];
            const kitsBitacoraDiaFiltrados = useMemo(() => {
                const t = (bitacoraModalSearch || '').trim().toLowerCase();
                if (!t) return kitsBitacoraDia;
                return kitsBitacoraDia.filter(k => {
                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                    const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                    return n.includes(t) || d.includes(t);
                });
            }, [kitsBitacoraDia, patients, bitacoraModalSearch]);

            const isDespacho = vistaPrincipal === 'despacho';

            useEffect(() => {
                if (listaEsperaTab === 'bitacora') return;
                const ventanilla = isDespacho ? listaDespachoVentanilla : listaOpsVentanilla;
                const ruta = isDespacho ? listaDespachoRuta : listaOpsRuta;
                if (listaEsperaTab === 'ventanilla' && ventanilla.length === 0 && ruta.length > 0) setListaEsperaTab('ruta');
                else if (listaEsperaTab === 'ruta' && ruta.length === 0 && ventanilla.length > 0) setListaEsperaTab('ventanilla');
            }, [listaEsperaTab, vistaPrincipal, isDespacho, listaDespachoVentanilla.length, listaDespachoRuta.length, listaOpsVentanilla.length, listaOpsRuta.length]);

            return (
                <div className="w-full min-w-0 max-w-5xl mx-auto space-y-6 animate-in">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-2xl font-bold text-slate-800 brand-font">Operaciones ‚Äî Lista de espera</h2>
                        <p className="text-sm text-slate-500">{isDespacho ? 'Vista solo lectura: kits en Despacho de medicamentos' : 'Mi lista de espera y bit√°cora del departamento'}</p>
                    </div>
                    <div className="flex flex-wrap gap-3">
                        <div className="flex gap-2 p-1.5 bg-slate-100 rounded-2xl">
                            <button onClick={() => setVistaPrincipal('despacho')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${isDespacho ? 'bg-white text-violet-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Lista Despacho (solo lectura)</button>
                            <button onClick={() => setVistaPrincipal('operaciones')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${!isDespacho ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Mi lista Operaciones</button>
                        </div>
                        <div className="flex gap-2 p-1.5 bg-slate-100 rounded-2xl w-fit">
                            <button onClick={() => setListaEsperaTab('ventanilla')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'ventanilla' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Ventanilla</button>
                            <button onClick={() => setListaEsperaTab('ruta')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'ruta' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Ruta</button>
                            {!isDespacho && (
                                <button onClick={() => setListaEsperaTab('bitacora')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'bitacora' ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Bit√°cora</button>
                            )}
                        </div>
                    </div>

                    {listaEsperaTab !== 'bitacora' ? (
                        <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                            <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                                <div className="flex flex-wrap items-center justify-between gap-3">
                                    <span className="font-bold text-slate-700">
                                        {(isDespacho ? listadoDespachoFiltrado : listadoOpsFiltrado).length}
                                        {(isDespacho ? listadoDespacho : listadoOps).length !== (isDespacho ? listadoDespachoFiltrado : listadoOpsFiltrado).length ? ` de ${(isDespacho ? listadoDespacho : listadoOps).length}` : ''} kit(s) ‚Äî {listaEsperaTab === 'ventanilla' ? 'Ventanilla' : 'Ruta'}
                                    </span>
                                    <div className="relative w-full sm:w-64">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por nombre o DNI..." value={listaEsperaSearch} onChange={e=>setListaEsperaSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                    </div>
                                </div>
                            </div>
                            <div className="divide-y divide-slate-100 max-h-[60vh] overflow-y-auto">
                                {isDespacho ? (
                                    listadoDespachoFiltrado.length === 0 ? (
                                        <div className="p-12 text-center text-slate-500">
                                            <Icons.Box size={48} className="mx-auto mb-3 opacity-40"/>
                                            <p className="font-medium">{listadoDespacho.length === 0 ? 'No hay kits en Despacho' : 'Sin resultados para la b√∫squeda'}</p>
                                        </div>
                                    ) : listadoDespachoFiltrado.map(k => renderRowDespacho(k))
                                ) : listadoOpsFiltrado.length === 0 ? (
                                    <div className="p-12 text-center text-slate-500">
                                        <Icons.Box size={48} className="mx-auto mb-3 opacity-40"/>
                                        <p className="font-medium">{listadoOps.length === 0 ? 'No hay kits pendientes de trabajar' : 'Sin resultados para la b√∫squeda'}</p>
                                    </div>
                                ) : listadoOpsFiltrado.map(k => renderRowOps(k))
                                }
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                            <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                                <div className="flex flex-wrap items-center justify-between gap-3">
                                    <span className="font-bold text-slate-700">Bit√°cora ‚Äî {isDespacho ? 'Enviados por Despacho a Operaciones' : 'Trabajados en Operaciones'} por d√≠a</span>
                                    <div className="relative w-full sm:w-56">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por fecha..." value={bitacoraCarpetasSearch} onChange={e=>setBitacoraCarpetasSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                    </div>
                                </div>
                            </div>
                            <div className="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                                {bitacoraCarpetasFiltradas.length === 0 ? (
                                    <div className="col-span-full p-12 text-center text-slate-500">
                                        <Icons.Folder size={48} className="mx-auto mb-3 opacity-40"/>
                                        <p className="font-medium">{bitacoraActual.length === 0 ? 'No hay registros en bit√°cora' : 'Sin resultados'}</p>
                                    </div>
                                ) : bitacoraCarpetasFiltradas.map(({ fecha, kits: ks, count }) => (
                                    <button key={fecha} onClick={() => setBitacoraFechaAbierta(fecha)} className="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-200 hover:border-amber-400 hover:bg-amber-50/50 transition-all text-left btn-hover-effect group">
                                        <div className="p-2.5 rounded-xl bg-amber-100 text-amber-700 group-hover:bg-amber-200"><Icons.Folder size={24}/></div>
                                        <div className="min-w-0 flex-1">
                                            <div className="font-bold text-slate-800 truncate">{formatearFechaBitacora(fecha)}</div>
                                            <div className="text-xs text-slate-500">{count} kit(s)</div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {bitacoraFechaAbierta && (
                        <Modal isOpen={true} onClose={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} title={`Bit√°cora ‚Äî ${formatearFechaBitacora(bitacoraFechaAbierta)}`} maxWidth="max-w-4xl">
                            <div className="space-y-4">
                                <p className="text-sm text-slate-500">{isDespacho ? 'Kits enviados a Operaciones este d√≠a.' : 'Kits trabajados en Operaciones este d√≠a.'}</p>
                                <div className="flex flex-wrap items-center gap-3">
                                    <div className="relative flex-1 min-w-[180px]">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por nombre o DNI..." value={bitacoraModalSearch} onChange={e=>setBitacoraModalSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                    </div>
                                    <span className="text-sm text-slate-500">{kitsBitacoraDiaFiltrados.length !== kitsBitacoraDia.length ? `${kitsBitacoraDiaFiltrados.length} de ${kitsBitacoraDia.length}` : `${kitsBitacoraDia.length} kit(s)`}</span>
                                </div>
                                <div className="divide-y divide-slate-100 max-h-[50vh] overflow-y-auto rounded-xl border border-slate-100">
                                    {kitsBitacoraDiaFiltrados.map(k => isDespacho ? renderRowDespacho(k) : renderRowBitacoraOps(k))}
                                </div>
                                <div className="flex justify-end pt-2">
                                    <button onClick={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} className="px-6 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                </div>
                            </div>
                        </Modal>
                    )}

                    {showVerModal && verKit && (
                        <Modal isOpen={true} onClose={cerrarVer} title="Ver kit" maxWidth="max-w-2xl">
                            {(() => {
                                const pt = (patients || []).find(p => p.id === verKit.patientId || (p.dni && verKit.dni && String(p.dni).trim() === String(verKit.dni).trim()));
                                return (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl">
                                            <div><span className="text-[10px] font-bold text-slate-400 block">DNI</span><span className="font-mono">{verKit.dni || pt?.dni || '‚Äî'}</span></div>
                                            <div><span className="text-[10px] font-bold text-slate-400 block">Nombre</span><span>{verKit.nombre || pt?.nombre || '‚Äî'}</span></div>
                                            <div><span className="text-[10px] font-bold text-slate-400 block">Modo</span><span>{verKit.deliveryMode === 'ruta' ? 'Ruta' : verKit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span></div>
                                            <div><span className="text-[10px] font-bold text-slate-400 block">Medicamentos</span><span>{(verKit.medicamentos || []).length}</span></div>
                                        </div>
                                        {(verKit.medicamentos || []).length > 0 && (
                                            <div className="p-4 bg-slate-50 rounded-xl">
                                                <h5 className="text-xs font-bold text-slate-500 mb-2">Medicamentos</h5>
                                                <ul className="text-sm text-slate-700 space-y-1">
                                                    {(verKit.medicamentos || []).slice(0, 12).map((m, i) => <li key={i}>{m.nombre} √ó {m.cantidad}</li>)}
                                                    {(verKit.medicamentos || []).length > 12 && <li className="text-slate-500">‚Ä¶ y {(verKit.medicamentos || []).length - 12} m√°s</li>}
                                                </ul>
                                            </div>
                                        )}
                                        <button onClick={cerrarVer} className="w-full py-3 bg-slate-600 text-white font-bold rounded-xl hover:bg-slate-700">Cerrar</button>
                                    </div>
                                );
                            })()}
                        </Modal>
                    )}

                    {showTrabajarForm && trabajarKit && (
                        <Modal isOpen={true} onClose={cerrarTrabajar} title={trabajarGuardado ? (editandoDesdeBitacora ? "Cambios guardados" : "Kit guardado ‚Äî Imprimir vi√±etas") : (editandoDesdeBitacora ? "Editar kit ‚Äî Operaciones" : "Trabajar kit ‚Äî Operaciones")} maxWidth="max-w-4xl">
                            {trabajarGuardado ? (
                                editandoDesdeBitacora ? (
                                    <div className="space-y-4">
                                        <p className="text-sm text-slate-600">Los cambios se guardaron. La informaci√≥n del kit se actualiz√≥ y se ver√° reflejada en los siguientes departamentos sin necesidad de reenviar.</p>
                                        <button type="button" onClick={cerrarTrabajar} className="w-full py-3 bg-slate-600 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                    </div>
                                ) : (() => {
                                    const k = trabajarKitActualizado || trabajarKit;
                                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                    const isRuta = (k.deliveryMode || '').toLowerCase() === 'ruta';
                                    const isVentanilla = (k.deliveryMode || '').toLowerCase() === 'ventanilla';
                                    const hasRefri = !!k.isRefrigerated || !!(k.cantRefriGlobal && parseInt(k.cantRefriGlobal, 10) > 0);
                                    return (
                                        <div className="space-y-4">
                                            <p className="text-sm text-slate-600">Se guard√≥ fecha/hora de salida a Calidad. Imprima las vi√±etas seg√∫n corresponda.</p>
                                            <div className="flex flex-wrap gap-3">
                                                {isRuta && printRutaVignette && (
                                                    <button type="button" onClick={async () => {
                                                        try {
                                                            await printRutaVignette(k, pt);
                                                            setVi√±etasImpresas(true);
                                                        } catch (err) {
                                                            console.error(err);
                                                            alert('Error al imprimir.');
                                                        }
                                                    }} className="flex items-center gap-2 px-4 py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700">
                                                        <Icons.Printer size={18}/> Imprimir Ruta
                                                    </button>
                                                )}
                                                {isVentanilla && printVentanillaVignette && (
                                                    <button type="button" onClick={async () => {
                                                        try {
                                                            await printVentanillaVignette(k, pt);
                                                            setVi√±etasImpresas(true);
                                                        } catch (err) {
                                                            console.error(err);
                                                            alert('Error al imprimir.');
                                                        }
                                                    }} className="flex items-center gap-2 px-4 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700">
                                                        <Icons.Printer size={18}/> Imprimir Ventanilla
                                                    </button>
                                                )}
                                                {hasRefri && printRefrigeradoVignette && (
                                                    <button type="button" onClick={async () => {
                                                        try {
                                                            await printRefrigeradoVignette(k, pt);
                                                            setVi√±etasImpresas(true);
                                                        } catch (err) {
                                                            console.error(err);
                                                            alert('Error al imprimir.');
                                                        }
                                                    }} className="flex items-center gap-2 px-4 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">
                                                        <Icons.Printer size={18}/> Imprimir Refrigerado
                                                    </button>
                                                )}
                                            </div>
                                            {vi√±etasImpresas && (
                                                <div className="pt-4 border-t border-slate-200 space-y-3">
                                                    <p className="text-sm text-green-600 font-semibold">‚úì Vi√±etas impresas. El kit est√° listo para enviar a Calidad.</p>
                                                    <button 
                                                        type="button" 
                                                        onClick={async () => {
                                                            try {
                                                                const today = new Date().toISOString().split('T')[0];
                                                                const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                                                await onSaveKit(k.id, { 
                                                                    enviadoACalidad: true,
                                                                    fechaEnvioCalidad: today,
                                                                    horaEnvioCalidad: now,
                                                                    ...(k.deliveryMode && { deliveryMode: k.deliveryMode })
                                                                }, k.patientId, true);
                                                                alert('Kit enviado a Calidad exitosamente.');
                                                                cerrarTrabajar();
                                                            } catch (err) {
                                                                alert('Error al enviar a Calidad: ' + (err?.message || err));
                                                            }
                                                        }} 
                                                        className="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-colors btn-hover-effect flex items-center justify-center gap-2"
                                                    >
                                                        ‚úì Enviar a Calidad
                                                    </button>
                                                </div>
                                            )}
                                            <div className="pt-4 border-t border-slate-200">
                                                <button type="button" onClick={cerrarTrabajar} className="w-full py-3 bg-slate-600 text-white font-bold rounded-xl hover:bg-slate-700">Cerrar</button>
                                            </div>
                                        </div>
                                    );
                                })()
                            ) : (
                                <form onSubmit={handleTrabajarSubmit} className="space-y-5">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-white rounded-xl border border-slate-100">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI del Paciente</label>
                                            <input type="text" value={trabajarKit.dni || ''} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Paciente</label>
                                            <input type="text" value={(patients || []).find(p => p.id === trabajarKit.patientId)?.nombre || trabajarKit.nombre || '‚Äî'} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario que imprimi√≥ recetas (Revisi√≥n y asignaci√≥n)</label>
                                            <input type="text" value={trabajarKit.digitador || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center asignado</label>
                                            <input type="text" value={(() => {
                                                const agenteName = ((patients || []).find(p => p.id === trabajarKit.patientId))?.agenteContactCenter || trabajarKit.agenteContactCenter || '';
                                                const name = (agenteName || '').trim();
                                                if (!name) return '‚Äî';
                                                const u = (users || []).find(x => {
                                                    const n = (x.nombre || x.username || x.name || '').trim().toLowerCase();
                                                    return n && n === name.toLowerCase();
                                                });
                                                return u ? (u.nombre || u.username || u.name || name) : name;
                                            })()} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center (Tel√©fono)</label>
                                            <input type="text" value={(() => {
                                                const agenteName = ((patients || []).find(p => p.id === trabajarKit.patientId))?.agenteContactCenter || trabajarKit.agenteContactCenter || '';
                                                const name = (agenteName || '').trim();
                                                if (!name) return '‚Äî';
                                                const u = (users || []).find(x => {
                                                    const n = (x.nombre || x.username || x.name || '').trim().toLowerCase();
                                                    return n && n === name.toLowerCase();
                                                });
                                                if (!u) return '‚Äî';
                                                const tel = (u.telefono || '').toString().trim();
                                                return tel || '‚Äî';
                                            })()} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario que lo arma (Despacho)</label>
                                            <input type="text" value={trabajarKit.usuarioDespachoMedicamentos || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Operaciones</label>
                                            <input type="text" value={currentUser?.name || currentUser?.nombre || currentUser?.username || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-amber-50 text-amber-800 font-semibold" />
                                        </div>
                                    </div>
                                    {(trabajarKit.confirmadoPorContactCenter || trabajarKit.contactCenter) && (
                                        <div className="p-4 bg-violet-50 rounded-xl border border-violet-200">
                                            <h5 className="text-xs font-bold text-violet-700 uppercase mb-3 border-b border-violet-200 pb-1">Datos confirmados por Contact Center (solo vista)</h5>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {trabajarKit.contactCenter && (() => {
                                                    const cc = trabajarKit.contactCenter || '';
                                                    const parts = cc.split(' --- ');
                                                    const ccName = parts.length > 0 ? parts[0].trim() : (cc.includes('---') ? cc.split('---')[0]?.trim() : cc);
                                                    const ccPhone = parts.length > 1 ? parts[1].trim() : (cc.includes('---') ? cc.split('---')[1]?.trim() : '‚Äî');
                                                    return (
                                                        <>
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Contact Center (Nombre)</label>
                                                                <input type="text" value={ccName} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-medium" />
                                                            </div>
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Contact Center (Tel√©fono)</label>
                                                                <input type="text" value={ccPhone} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-medium" />
                                                            </div>
                                                        </>
                                                    );
                                                })()}
                                                {(trabajarKit.direccionEntrega || trabajarKit.direccionAlternativa) && (
                                                    <div className="md:col-span-2">
                                                        <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Direcci√≥n entrega</label>
                                                        <input type="text" value={trabajarKit.direccionEntrega || trabajarKit.direccionAlternativa || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-medium" />
                                                    </div>
                                                )}
                                                {(trabajarKit.observacionesEntrega || trabajarKit.observations) && (
                                                    <div className="md:col-span-2">
                                                        <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Observaciones</label>
                                                        <textarea value={trabajarKit.observacionesEntrega || trabajarKit.observations || '‚Äî'} disabled rows="2" className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-medium resize-none" />
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase">Medicamentos asignados</h5>
                                            <span className="text-lg font-bold text-turquoise-600 tabular-nums">{calcularMedCounter(trabajarKit.medicamentos).str}</span>
                                        </div>
                                        <div className="space-y-3 max-h-60 overflow-y-auto">
                                            {(trabajarKit.medicamentos || []).map((m, i) => {
                                                const va = m.dispensar !== false;
                                                return (
                                                    <div key={i} className={`p-3 rounded-lg border-2 ${va ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                        <div className="flex items-start justify-between gap-3 mb-2">
                                                            <div className="flex-1">
                                                                <span className={`font-semibold ${va ? 'text-green-800' : 'text-red-800'}`}>{m.nombre || '‚Äî'}</span>
                                                                {m.observaciones && <p className={`text-xs mt-1 ${va ? 'text-green-700' : 'text-red-700'}`}>Obs: {m.observaciones}</p>}
                                                            </div>
                                                            <span className={`text-xs font-bold ${va ? 'text-green-600' : 'text-red-600'}`}>{va ? '‚úì S√≠ va' : '‚úó No va'}</span>
                                                        </div>
                                                        {va && (
                                                            <div className="grid grid-cols-2 gap-3 mt-2 pt-2 border-t border-green-300">
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-green-700 uppercase block mb-1">Cantidad</label>
                                                                    <input 
                                                                        type="text" 
                                                                        className="w-full p-2 border-2 border-green-300 rounded-lg text-sm bg-white text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-green-400" 
                                                                        value={m.cantidad || ''} 
                                                                        onChange={e => {
                                                                            const newMeds = [...(trabajarKit.medicamentos || [])];
                                                                            newMeds[i] = { ...newMeds[i], cantidad: e.target.value };
                                                                            setTrabajarKit({ ...trabajarKit, medicamentos: newMeds });
                                                                        }}
                                                                        placeholder="Ej: 6"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-[10px] font-bold text-green-700 uppercase block mb-1">ID Receta (8 d√≠gitos)</label>
                                                                    <input 
                                                                        type="text" 
                                                                        className="w-full p-2 border-2 border-green-300 rounded-lg text-sm bg-white text-slate-700 font-bold focus:outline-none focus:ring-2 focus:ring-green-400" 
                                                                        value={m.idReceta || ''} 
                                                                        onChange={e => {
                                                                            const value = e.target.value.replace(/\D/g, '').slice(0, 8);
                                                                            const newMeds = [...(trabajarKit.medicamentos || [])];
                                                                            newMeds[i] = { ...newMeds[i], idReceta: value };
                                                                            setTrabajarKit({ ...trabajarKit, medicamentos: newMeds });
                                                                        }}
                                                                        placeholder="12345678"
                                                                        maxLength={8}
                                                                    />
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                            {(trabajarKit.medicamentos || []).length === 0 && <p className="text-slate-400 text-sm">Sin medicamentos</p>}
                                        </div>
                                    </div>
                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Operaciones</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Armado</label>
                                                <input type="text" className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" value={trabajarData.fechaArmado || ''} disabled />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Hora Operaciones</label>
                                                <input type="text" className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" value={trabajarData.horaOperaciones || ''} disabled />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase mb-3">Refrigerado</h5>
                                        <div className="flex flex-wrap items-center gap-4">
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-xs overflow-hidden">
                                                <div 
                                                    className="absolute inset-y-1 bg-white rounded-full shadow-sm transition-all duration-300 ease-in-out"
                                                    style={{
                                                        left: trabajarData.isRefrigerated ? 'calc(50% + 0.125rem)' : '0.25rem',
                                                        width: 'calc(50% - 0.25rem)',
                                                        backgroundColor: trabajarData.isRefrigerated ? '#fef3c7' : '#ffffff'
                                                    }}
                                                />
                                                <button
                                                    type="button"
                                                    onClick={() => setTrabajarData({ ...trabajarData, isRefrigerated: false, cantRefriGlobal: '' })}
                                                    className={`
                                                        relative z-10 flex-1 px-6 py-2.5 text-sm font-bold uppercase rounded-full transition-colors duration-300 ease-in-out
                                                        ${!trabajarData.isRefrigerated ? 'text-slate-700' : 'text-slate-500'}
                                                        focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-2
                                                    `}
                                                >
                                                    {!trabajarData.isRefrigerated ? '‚úì NO' : 'NO'}
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => setTrabajarData({ ...trabajarData, isRefrigerated: true, cantRefriGlobal: trabajarData.cantRefriGlobal || '1' })}
                                                    className={`
                                                        relative z-10 flex-1 px-6 py-2.5 text-sm font-bold uppercase rounded-full transition-colors duration-300 ease-in-out
                                                        ${trabajarData.isRefrigerated ? 'text-amber-700' : 'text-slate-500'}
                                                        focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-offset-2
                                                    `}
                                                >
                                                    {trabajarData.isRefrigerated ? '‚úì S√ç' : 'S√ç'}
                                                </button>
                                            </div>
                                            {trabajarData.isRefrigerated && (
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500">Cantidad:</label>
                                                    <input type="number" min={1} className="w-20 p-2 border rounded-lg text-sm bg-white border-slate-200" value={trabajarData.cantRefriGlobal} onChange={e => setTrabajarData({ ...trabajarData, cantRefriGlobal: e.target.value })} placeholder="1" />
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <p className="text-xs text-slate-500">Al guardar se registran autom√°ticamente la fecha y hora de salida de Operaciones y entrega a Calidad.</p>
                                    <div className="flex gap-3 pt-2">
                                        <button type="submit" className="flex-1 py-3 bg-amber-600 text-white font-bold rounded-xl hover:bg-amber-700">Guardar</button>
                                        <button type="button" onClick={cerrarTrabajar} className="px-6 py-3 bg-slate-600 text-white font-bold rounded-xl hover:bg-slate-700">Cancelar</button>
                                    </div>
                                </form>
                            )}
                        </Modal>
                    )}
                </div>
            );
        };

        // --- BLOCK: CALIDAD LISTA DE ESPERA ---
        const CalidadListaEsperaBlock = ({ kits, patients, onSaveKit, onRefreshKits, currentUser, users = [] }) => {
            const [vistaPrincipal, setVistaPrincipal] = useState('calidad'); // 'despacho' | 'operaciones' | 'calidad'
            const [listaEsperaTab, setListaEsperaTab] = useState('ventanilla'); // 'ventanilla' | 'ruta'
            const [listaEsperaSearch, setListaEsperaSearch] = useState('');
            const [showVerModal, setShowVerModal] = useState(false);
            const [verKit, setVerKit] = useState(null);
            const [showTrabajarForm, setShowTrabajarForm] = useState(false);
            const [trabajarKit, setTrabajarKit] = useState(null);
            const [trabajarKitLocal, setTrabajarKitLocal] = useState(null); // copia editable para meds
            const [trabajarData, setTrabajarData] = useState({
                observacionesCalidad: '',
                btp: '',
                btg: '',
                tipoBolsaVerde: 'GRANDE',
                tipoDespachoRefrigerado: '',
                incidenciasActivo: false,
                incidencias: [] // [{ tipo: 'medicamento', medIdx: number } | { tipo: 'otra', texto: string }]
            });
            const [trabajarGuardado, setTrabajarGuardado] = useState(false);
            const [trabajarEnviadoLogistica, setTrabajarEnviadoLogistica] = useState(false);
            const [incidenciaMedIdx, setIncidenciaMedIdx] = useState(null);
            const [incidenciaTipoSel, setIncidenciaTipoSel] = useState('error_cantidad');
            const [incidenciaOtraTexto, setIncidenciaOtraTexto] = useState('');
            const [bitacoraCarpetasSearch, setBitacoraCarpetasSearch] = useState('');
            const [bitacoraFechaAbierta, setBitacoraFechaAbierta] = useState(null);
            const [bitacoraModalSearch, setBitacoraModalSearch] = useState('');

            const formatearFechaBitacora = (f) => {
                if (!f) return '';
                const d = new Date(f + 'T12:00:00');
                return d.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });
            };

            useEffect(() => {
                setBitacoraFechaAbierta(null);
                setBitacoraModalSearch('');
                if (vistaPrincipal === 'despacho' || vistaPrincipal === 'operaciones') setListaEsperaTab('ventanilla');
                if (vistaPrincipal === 'despacho' || vistaPrincipal === 'operaciones') setBitacoraCarpetasSearch('');
            }, [vistaPrincipal]);

            const toUpper = (v) => (v != null && v !== '' ? String(v).toUpperCase() : v);
            const safeNumber = (v) => { const n = parseInt(String(v || '0'), 10); return isNaN(n) ? '' : n; };
            const calcularMedCounter = (meds) => {
                const m = meds || [];
                const total = m.length;
                const dispensados = m.filter(x => x.dispensar !== false).length;
                return { dispensados, total, str: total ? `${dispensados}/${total}` : '0/0' };
            };

            const abrirVer = (kit) => { setVerKit(kit); setShowVerModal(true); };
            const cerrarVer = () => { setVerKit(null); setShowVerModal(false); };
            const abrirTrabajar = (kit) => {
                const meds = (kit.medicamentos || []).map(m => ({
                    ...m,
                    dispensar: m.dispensar !== false,
                    observaciones: m.observaciones || '',
                    dispensacionParcial: !!m.dispensacionParcial,
                    tipo: m.tipo || 'no cronico',
                    cantidadReceta: m.cantidadReceta ?? m.cantidad
                }));
                const k = { ...kit, medicamentos: meds };
                setTrabajarKit(k);
                setTrabajarKitLocal(JSON.parse(JSON.stringify(k)));
                setTrabajarGuardado(false);
                setTrabajarEnviadoLogistica(false);
                const hasRefri = !!(kit.isRefrigerated || (kit.cantRefriGlobal && parseInt(String(kit.cantRefriGlobal), 10) > 0));
                setTrabajarData({
                    observacionesCalidad: (kit.observacionesCalidad || '').trim(),
                    btp: (kit.btp != null && kit.btp !== '') ? String(kit.btp) : '',
                    btg: (kit.btg != null && kit.btg !== '') ? String(kit.btg) : '',
                    tipoBolsaVerde: kit.tipoBolsaVerde === 'PEQUE√ëA' ? 'PEQUE√ëA' : kit.tipoBolsaVerde === 'NINGUNA' ? 'NINGUNA' : 'GRANDE',
                    tipoDespachoRefrigerado: hasRefri ? (kit.tipoDespachoRefrigerado === 'KIT + REFRIGERADO' ? 'KIT + REFRIGERADO' : 'SOLO REFRIGERADO') : 'SOLO KIT',
                    incidenciasActivo: false,
                    incidencias: Array.isArray(kit.incidenciasCalidad) ? [...kit.incidenciasCalidad] : []
                });
                setShowTrabajarForm(true);
            };
            const cerrarTrabajar = () => {
                setTrabajarKit(null);
                setTrabajarKitLocal(null);
                setTrabajarGuardado(false);
                setTrabajarEnviadoLogistica(false);
                setTrabajarData({ observacionesCalidad: '', btp: '', btg: '', tipoBolsaVerde: 'GRANDE', tipoDespachoRefrigerado: '', incidenciasActivo: false, incidencias: [] });
                setIncidenciaMedIdx(null);
                setIncidenciaTipoSel('error_cantidad');
                setIncidenciaOtraTexto('');
                setShowTrabajarForm(false);
            };
            const handleTrabajarSubmit = async (e) => {
                e.preventDefault();
                if (!trabajarKit || !trabajarKitLocal || !onSaveKit) return;
                const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                const today = new Date().toISOString().split('T')[0];
                const payload = {
                    revisadoCalidad: true,
                    fechaRevisionCalidad: today,
                    horaRevisionCalidad: now,
                    usuarioCalidad: (currentUser?.name || currentUser?.nombre || currentUser?.username || '').trim() || '',
                    observacionesCalidad: (trabajarData.observacionesCalidad || '').trim() || (trabajarKit.observacionesCalidad || ''),
                    medicamentos: trabajarKitLocal.medicamentos || [],
                    btp: trabajarData.btp.trim() || null,
                    btg: trabajarData.btg.trim() || null,
                    tipoBolsaVerde: trabajarData.tipoBolsaVerde || 'GRANDE',
                    incidenciasCalidad: (trabajarData.incidencias || []).length ? trabajarData.incidencias : null,
                    tipoDespachoRefrigerado: (trabajarData.tipoDespachoRefrigerado || '').trim() || null
                };
                try {
                    await onSaveKit(trabajarKit.id, payload, trabajarKit.patientId, true);
                    setTrabajarKit(prev => prev ? { ...prev, ...payload } : null);
                    setTrabajarKitLocal(prev => prev ? { ...prev, ...payload } : null);
                    setTrabajarGuardado(true);
                } catch (err) {
                    alert('Error al guardar: ' + (err?.message || err));
                }
            };
            const handleEnviarALogistica = async () => {
                if (!trabajarKit || !onSaveKit) return;
                const today = new Date().toISOString().split('T')[0];
                try {
                    await onSaveKit(trabajarKit.id, { fechaEntregaLogistica: today }, trabajarKit.patientId, true);
                    setTrabajarEnviadoLogistica(true);
                    setTimeout(cerrarTrabajar, 600);
                } catch (err) {
                    alert('Error al enviar a log√≠stica: ' + (err?.message || err));
                }
            };

            useEffect(() => {
                try {
                    const raw = sessionStorage.getItem('trabajarFromCalendar');
                    if (!raw) return;
                    const data = JSON.parse(raw);
                    if ((data.area || '') !== 'rev' || !data.kitId) return;
                    sessionStorage.removeItem('trabajarFromCalendar');
                    const kit = (kits || []).find(k => k.id === data.kitId);
                    if (kit) abrirTrabajar(kit);
                } catch (_) {}
            }, [kits]);

            // Lista Despacho (solo lectura): kits con receta impresa, no enviados a Operaciones
            const listaKitsDespacho = useMemo(() => {
                return (kits || []).filter(k => {
                    if (!k.recetaImpresa) return false;
                    if (!!k.complemento) return !k.complementoEnviadoAOperaciones;
                    return !k.enviadoAOperaciones;
                }).sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
            }, [kits]);
            const listaDespachoVentanilla = useMemo(() => listaKitsDespacho.filter(k => (k.deliveryMode || '').toLowerCase() === 'ventanilla'), [listaKitsDespacho]);
            const listaDespachoRuta = useMemo(() => listaKitsDespacho.filter(k => (k.deliveryMode || '').toLowerCase() === 'ruta'), [listaKitsDespacho]);

            // Lista Operaciones (solo lectura): lista de espera de Operaciones ‚Äî kits enviados a Ops, pendientes de trabajar (vienen en camino a Calidad)
            const listaKitsOperaciones = useMemo(() => {
                return (kits || []).filter(k => {
                    const enviado = !!k.enviadoAOperaciones || !!k.complementoEnviadoAOperaciones;
                    return enviado && !k.trabajadoOperaciones;
                }).sort((a, b) => new Date(b.fechaEnvioOperaciones || b.fechaEnvioComplemento || 0) - new Date(a.fechaEnvioOperaciones || a.fechaEnvioComplemento || 0));
            }, [kits]);
            const listaOpsVentanilla = useMemo(() => listaKitsOperaciones.filter(k => (k.deliveryMode || '').toLowerCase() === 'ventanilla'), [listaKitsOperaciones]);
            const listaOpsRuta = useMemo(() => listaKitsOperaciones.filter(k => (k.deliveryMode || '').toLowerCase() === 'ruta'), [listaKitsOperaciones]);

            // Mi lista Calidad: kits enviados desde Operaciones, pendientes de revisar (!revisadoCalidad)
            const listaKitsCalidad = useMemo(() => {
                return (kits || []).filter(k => {
                    const enviado = !!(k.enviadoACalidad || k.fechaEnvioCalidad);
                    return enviado && !k.revisadoCalidad;
                }).sort((a, b) => {
                    const fechaA = a.fechaEnvioCalidad || a.fechaEntregaCalidad || '';
                    const fechaB = b.fechaEnvioCalidad || b.fechaEntregaCalidad || '';
                    return new Date(fechaB) - new Date(fechaA);
                });
            }, [kits]);
            const listaCalidadVentanilla = useMemo(() => listaKitsCalidad.filter(k => (k.deliveryMode || '').toLowerCase() === 'ventanilla'), [listaKitsCalidad]);
            const listaCalidadRuta = useMemo(() => listaKitsCalidad.filter(k => (k.deliveryMode || '').toLowerCase() !== 'ventanilla'), [listaKitsCalidad]);

            const listadoDespacho = listaEsperaTab === 'ventanilla' ? listaDespachoVentanilla : listaDespachoRuta;
            const listadoOps = listaEsperaTab === 'ventanilla' ? listaOpsVentanilla : listaOpsRuta;
            const listadoCalidad = listaEsperaTab === 'ventanilla' ? listaCalidadVentanilla : listaCalidadRuta;

            useEffect(() => {
                if (listaEsperaTab === 'bitacora') return;
                const ventanilla = vistaPrincipal === 'despacho' ? listaDespachoVentanilla : vistaPrincipal === 'operaciones' ? listaOpsVentanilla : listaCalidadVentanilla;
                const ruta = vistaPrincipal === 'despacho' ? listaDespachoRuta : vistaPrincipal === 'operaciones' ? listaOpsRuta : listaCalidadRuta;
                if (listaEsperaTab === 'ventanilla' && ventanilla.length === 0 && ruta.length > 0) setListaEsperaTab('ruta');
                else if (listaEsperaTab === 'ruta' && ruta.length === 0 && ventanilla.length > 0) setListaEsperaTab('ventanilla');
            }, [listaEsperaTab, vistaPrincipal, listaDespachoVentanilla.length, listaDespachoRuta.length, listaOpsVentanilla.length, listaOpsRuta.length, listaCalidadVentanilla.length, listaCalidadRuta.length]);

            const bitacoraCalidad = useMemo(() => {
                const porFecha = {};
                (kits || []).forEach(k => {
                    if (!k.revisadoCalidad) return;
                    const fa = (k.fechaRevisionCalidad || '').toString().trim();
                    if (!fa) return;
                    porFecha[fa] = porFecha[fa] || [];
                    porFecha[fa].push(k);
                });
                return Object.entries(porFecha).map(([f, arr]) => ({ fecha: f, kits: arr, count: arr.length })).sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits]);
            const bitacoraCalidadFiltrada = useMemo(() => {
                const t = (bitacoraCarpetasSearch || '').trim().toLowerCase();
                if (!t) return bitacoraCalidad;
                return bitacoraCalidad.filter(({ fecha }) => formatearFechaBitacora(fecha).toLowerCase().includes(t) || (fecha || '').toLowerCase().includes(t));
            }, [bitacoraCalidad, bitacoraCarpetasSearch]);
            const kitsBitacoraCalidadDia = bitacoraFechaAbierta ? (bitacoraCalidad.find(d => d.fecha === bitacoraFechaAbierta)?.kits || []) : [];
            const kitsBitacoraCalidadDiaFiltrados = useMemo(() => {
                const t = (bitacoraModalSearch || '').trim().toLowerCase();
                if (!t) return kitsBitacoraCalidadDia;
                return kitsBitacoraCalidadDia.filter(k => {
                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                    const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                    return n.includes(t) || d.includes(t);
                });
            }, [kitsBitacoraCalidadDia, patients, bitacoraModalSearch]);

            const renderRowDespacho = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">Fecha armado: {kit.fechaArmado || '‚Äî'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                            </div>
                        </div>
                        <button onClick={() => abrirVer(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                            <Icons.Eye size={16}/> Visualizar
                        </button>
                    </div>
                );
            };

            const renderRowOperaciones = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">Enviado a Ops: {kit.fechaEnvioOperaciones || kit.fechaEnvioComplemento || '‚Äî'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                            </div>
                        </div>
                        <button onClick={() => abrirVer(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                            <Icons.Eye size={16}/> Visualizar
                        </button>
                    </div>
                );
            };

            const renderRowCalidad = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">Enviado desde Ops: {kit.fechaEnvioCalidad || kit.fechaEntregaCalidad || '‚Äî'}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2">
                            <button onClick={() => abrirTrabajar(kit)} className="px-4 py-2 rounded-xl bg-green-600 text-white font-bold text-sm hover:bg-green-700 transition-colors btn-hover-effect flex items-center gap-2">
                                <Icons.Box size={16}/> Trabajar
                            </button>
                            <button onClick={() => abrirVer(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                                <Icons.Eye size={16}/> Visualizar
                            </button>
                        </div>
                    </div>
                );
            };

            const renderRowBitacoraCalidad = (kit) => {
                const pt = (patients || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                const yaLogistica = !!(kit.fechaEntregaLogistica && String(kit.fechaEntregaLogistica).trim());
                return (
                    <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-0">
                            <div className="flex flex-wrap items-center gap-2">
                                <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                                {yaLogistica && <span className="px-2 py-0.5 rounded-lg bg-emerald-100 text-emerald-800 text-xs font-bold">Enviado a log√≠stica</span>}
                            </div>
                            <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                <span className="font-mono">Revisi√≥n: {kit.fechaRevisionCalidad || '‚Äî'} {kit.horaRevisionCalidad || ''}</span>
                                <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                <span>{(kit.medicamentos || []).length} med(s)</span>
                            </div>
                        </div>
                        <div className="flex flex-wrap items-center gap-2">
                            <button onClick={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); abrirTrabajar(kit); }} className="px-4 py-2 rounded-xl bg-green-600 text-white font-bold text-sm hover:bg-green-700 transition-colors btn-hover-effect flex items-center gap-2">
                                <Icons.Edit size={16}/> Modificar
                            </button>
                            <button onClick={() => abrirVer(kit)} className="px-4 py-2 rounded-xl bg-slate-500 text-white font-bold text-sm hover:bg-slate-600 transition-colors btn-hover-effect flex items-center gap-2">
                                <Icons.Eye size={16}/> Visualizar
                            </button>
                        </div>
                    </div>
                );
            };

            const listaActual = vistaPrincipal === 'despacho' ? listadoDespacho : vistaPrincipal === 'operaciones' ? listadoOps : listadoCalidad;
            const listaFiltrada = useMemo(() => {
                const t = (listaEsperaSearch || '').trim().toLowerCase();
                if (!t) return listaActual;
                return listaActual.filter(k => {
                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                    const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                    return n.includes(t) || d.includes(t);
                });
            }, [listaActual, patients, listaEsperaSearch]);
            const isDespacho = vistaPrincipal === 'despacho';
            const isOps = vistaPrincipal === 'operaciones';
            const isCalidad = vistaPrincipal === 'calidad';

            return (
                <div className="w-full min-w-0 max-w-5xl mx-auto space-y-6 animate-in">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-2xl font-bold text-slate-800 brand-font">Calidad ‚Äî Lista de espera</h2>
                        <p className="text-sm text-slate-500">Despacho y Operaciones en solo lectura (kits en camino). En Mi lista trabajas y revisas.</p>
                    </div>
                    <div className="flex flex-wrap gap-3">
                        <div className="flex gap-2 p-1.5 bg-slate-100 rounded-2xl">
                            <button onClick={() => setVistaPrincipal('despacho')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${isDespacho ? 'bg-white text-violet-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Lista Despacho (solo lectura)</button>
                            <button onClick={() => setVistaPrincipal('operaciones')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${isOps ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Lista Operaciones (solo lectura)</button>
                            <button onClick={() => { setVistaPrincipal('calidad'); if (onRefreshKits) onRefreshKits(); }} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${isCalidad ? 'bg-white text-green-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Mi lista Calidad (trabajar)</button>
                        </div>
                        <div className="flex gap-2 p-1.5 bg-slate-100 rounded-2xl w-fit">
                            <button onClick={() => setListaEsperaTab('ventanilla')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'ventanilla' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Ventanilla</button>
                            <button onClick={() => setListaEsperaTab('ruta')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'ruta' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Ruta</button>
                            {isCalidad && (
                                <button onClick={() => setListaEsperaTab('bitacora')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all btn-hover-effect ${listaEsperaTab === 'bitacora' ? 'bg-white text-green-700 shadow-sm' : 'text-slate-600 hover:bg-white/60'}`}>Bit√°cora</button>
                            )}
                        </div>
                    </div>

                    {listaEsperaTab !== 'bitacora' ? (
                        <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                            <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                                <div className="flex flex-wrap items-center justify-between gap-3">
                                    <span className="font-bold text-slate-700">
                                        {listaFiltrada.length}{listaActual.length !== listaFiltrada.length ? ` de ${listaActual.length}` : ''} kit(s) ‚Äî {listaEsperaTab === 'ventanilla' ? 'Ventanilla' : 'Ruta'}
                                        {isDespacho ? ' (Despacho)' : isOps ? ' (Operaciones)' : ' (Calidad)'}
                                    </span>
                                    <div className="flex flex-wrap items-center gap-2">
                                        {onRefreshKits && (
                                            <button type="button" onClick={() => onRefreshKits()} className="flex items-center gap-1.5 px-3 py-2 rounded-xl bg-green-100 text-green-700 hover:bg-green-200 font-bold text-sm transition-colors btn-hover-effect" title="Refrescar lista desde Firebase">
                                                <Icons.RefreshCw size={16}/> Refrescar
                                            </button>
                                        )}
                                        <div className="relative w-full sm:w-64">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                            <input type="text" placeholder="Buscar por nombre o DNI..." value={listaEsperaSearch} onChange={e=>setListaEsperaSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-green-300 focus:ring-1 focus:ring-green-200" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="divide-y divide-slate-100 max-h-[60vh] overflow-y-auto">
                                {listaFiltrada.length === 0 ? (
                                    <div className="p-12 text-center text-slate-500">
                                        <Icons.Box size={48} className="mx-auto mb-3 opacity-40"/>
                                        <p className="font-medium">{listaActual.length === 0 ? (isDespacho ? 'No hay kits en Despacho' : isOps ? 'No hay kits en Operaciones' : 'No hay kits pendientes de revisar en Calidad') : 'Sin resultados para la b√∫squeda'}</p>
                                        {isCalidad && listaActual.length === 0 && onRefreshKits && (
                                            <p className="text-sm mt-2">Si acaba de enviar kits desde Operaciones, pulse <button type="button" onClick={() => onRefreshKits()} className="font-bold text-green-600 hover:underline">Refrescar</button>.</p>
                                        )}
                                    </div>
                                ) : isDespacho ? listaFiltrada.map(k => renderRowDespacho(k)) :
                                  isOps ? listaFiltrada.map(k => renderRowOperaciones(k)) :
                                  listaFiltrada.map(k => renderRowCalidad(k))
                                }
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                            <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                                <div className="flex flex-wrap items-center justify-between gap-3">
                                    <span className="font-bold text-slate-700">Bit√°cora ‚Äî Revisados en Calidad por d√≠a</span>
                                    <div className="relative w-full sm:w-56">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por fecha..." value={bitacoraCarpetasSearch} onChange={e=>setBitacoraCarpetasSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-green-300 focus:ring-1 focus:ring-green-200" />
                                    </div>
                                </div>
                            </div>
                            <div className="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                                {bitacoraCalidadFiltrada.length === 0 ? (
                                    <div className="col-span-full p-12 text-center text-slate-500">
                                        <Icons.Folder size={48} className="mx-auto mb-3 opacity-40"/>
                                        <p className="font-medium">{bitacoraCalidad.length === 0 ? 'No hay registros en bit√°cora' : 'Sin resultados'}</p>
                                    </div>
                                ) : bitacoraCalidadFiltrada.map(({ fecha, kits: ks, count }) => (
                                    <button key={fecha} onClick={() => setBitacoraFechaAbierta(fecha)} className="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-200 hover:border-green-400 hover:bg-green-50/50 transition-all text-left btn-hover-effect group">
                                        <div className="p-2.5 rounded-xl bg-green-100 text-green-700 group-hover:bg-green-200"><Icons.Folder size={24}/></div>
                                        <div className="min-w-0 flex-1">
                                            <div className="font-bold text-slate-800 truncate">{formatearFechaBitacora(fecha)}</div>
                                            <div className="text-xs text-slate-500">{count} kit(s)</div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {bitacoraFechaAbierta && (
                        <Modal isOpen={true} onClose={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} title={`Bit√°cora Calidad ‚Äî ${formatearFechaBitacora(bitacoraFechaAbierta)}`} maxWidth="max-w-4xl">
                            <div className="space-y-4">
                                <p className="text-sm text-slate-500">Kits revisados en Calidad este d√≠a. Puedes modificar aunque ya se hayan enviado a log√≠stica.</p>
                                <div className="flex flex-wrap items-center gap-3">
                                    <div className="relative flex-1 min-w-[180px]">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por nombre o DNI..." value={bitacoraModalSearch} onChange={e=>setBitacoraModalSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-sm outline-none focus:border-green-300 focus:ring-1 focus:ring-green-200" />
                                    </div>
                                    <span className="text-sm text-slate-500">{kitsBitacoraCalidadDiaFiltrados.length !== kitsBitacoraCalidadDia.length ? `${kitsBitacoraCalidadDiaFiltrados.length} de ${kitsBitacoraCalidadDia.length}` : `${kitsBitacoraCalidadDia.length} kit(s)`}</span>
                                </div>
                                <div className="divide-y divide-slate-100 max-h-[50vh] overflow-y-auto rounded-xl border border-slate-100">
                                    {kitsBitacoraCalidadDiaFiltrados.map(k => renderRowBitacoraCalidad(k))}
                                </div>
                                <div className="flex justify-end pt-2">
                                    <button onClick={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} className="px-6 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                </div>
                            </div>
                        </Modal>
                    )}

                    {showVerModal && verKit && (
                        <Modal isOpen={true} onClose={cerrarVer} title="Ver kit" maxWidth="max-w-2xl">
                            {(() => {
                                const pt = (patients || []).find(p => p.id === verKit.patientId || (p.dni && verKit.dni && String(p.dni).trim() === String(verKit.dni).trim()));
                                return (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl">
                                            <div><span className="text-[10px] font-bold text-slate-400 block">DNI</span><span className="font-mono">{verKit.dni || pt?.dni || '‚Äî'}</span></div>
                                            <div><span className="text-[10px] font-bold text-slate-400 block">Nombre</span><span>{verKit.nombre || pt?.nombre || '‚Äî'}</span></div>
                                            <div><span className="text-[10px] font-bold text-slate-400 block">Modo</span><span>{verKit.deliveryMode === 'ruta' ? 'Ruta' : verKit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span></div>
                                            <div><span className="text-[10px] font-bold text-slate-400 block">Medicamentos</span><span>{(verKit.medicamentos || []).length}</span></div>
                                        </div>
                                        {(verKit.medicamentos || []).length > 0 && (
                                            <div className="p-4 bg-slate-50 rounded-xl">
                                                <h5 className="text-xs font-bold text-slate-500 mb-2">Medicamentos</h5>
                                                <ul className="text-sm text-slate-700 space-y-1">
                                                    {(verKit.medicamentos || []).slice(0, 12).map((m, i) => <li key={i}>{m.nombre} √ó {m.cantidad}</li>)}
                                                    {(verKit.medicamentos || []).length > 12 && <li className="text-slate-500">‚Ä¶ y {(verKit.medicamentos || []).length - 12} m√°s</li>}
                                                </ul>
                                            </div>
                                        )}
                                        <button onClick={cerrarVer} className="w-full py-3 bg-slate-600 text-white font-bold rounded-xl hover:bg-slate-700">Cerrar</button>
                                    </div>
                                );
                            })()}
                        </Modal>
                    )}

                    {showTrabajarForm && trabajarKit && (
                        <Modal isOpen={true} onClose={cerrarTrabajar} title={trabajarGuardado ? (trabajarEnviadoLogistica ? "Enviado a log√≠stica" : "Revisi√≥n guardada ‚Äî Calidad") : "Trabajar kit ‚Äî Calidad"} maxWidth="max-w-4xl">
                            {trabajarEnviadoLogistica ? (
                                <div className="text-center py-8">
                                    <div className="w-14 h-14 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-4"><Icons.CheckCircle size={28} className="text-emerald-600"/></div>
                                    <p className="font-bold text-emerald-800 text-lg">Kit enviado a log√≠stica</p>
                                    <div className="pt-4"><button type="button" onClick={cerrarTrabajar} className="px-6 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700">Cerrar</button></div>
                                </div>
                            ) : trabajarGuardado ? (
                                <div className="space-y-4">
                                    <div className="text-center py-4">
                                        <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-3"><Icons.CheckCircle size={28} className="text-green-600"/></div>
                                        <p className="font-bold text-green-800 text-lg">{(trabajarKit?.fechaEntregaLogistica && String(trabajarKit.fechaEntregaLogistica).trim()) ? 'Revisi√≥n actualizada correctamente' : 'Revisi√≥n registrada correctamente'}</p>
                                        <p className="text-sm text-slate-500 mt-1">{(trabajarKit?.fechaEntregaLogistica && String(trabajarKit.fechaEntregaLogistica).trim()) ? 'El kit ya fue enviado a log√≠stica. Los cambios se guardaron.' : 'El kit sale de tu lista de espera. Env√≠a a log√≠stica para continuar.'}</p>
                                    </div>
                                    {(!trabajarKit?.fechaEntregaLogistica || !String(trabajarKit.fechaEntregaLogistica).trim()) ? (
                                        <button type="button" onClick={handleEnviarALogistica} className="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 flex items-center justify-center gap-2">
                                            ‚úì Enviar a log√≠stica
                                        </button>
                                    ) : null}
                                    <div className="pt-2"><button type="button" onClick={cerrarTrabajar} className="w-full py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700">Cerrar</button></div>
                                </div>
                            ) : (
                                <form onSubmit={handleTrabajarSubmit} className="space-y-5">
                                    {(() => {
                                        const pt = (patients || []).find(p => p.id === trabajarKit.patientId || (p.dni && trabajarKit.dni && String(p.dni).trim() === String(trabajarKit.dni).trim()));
                                        const k = trabajarKitLocal || trabajarKit;
                                        const meds = k.medicamentos || [];
                                        const horaRevision = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                        return (
                                            <>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-white rounded-xl border border-slate-100">
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI</label><input type="text" value={trabajarKit.dni || pt?.dni || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-700" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre</label><input type="text" value={(pt?.nombre || trabajarKit.nombre || '‚Äî')} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-700" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario impresi√≥n (Rev. y asignaci√≥n)</label><input type="text" value={trabajarKit.digitador || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-600" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center asignado</label><input type="text" value={(()=>{const n=(pt?.agenteContactCenter||trabajarKit.agenteContactCenter||'').trim(); if(!n)return '‚Äî'; const u=(users||[]).find(x=>((x.nombre||x.username||'').trim().toLowerCase())===n.toLowerCase()); return u?(u.nombre||u.username||n):n;})()} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-600" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Despacho</label><input type="text" value={trabajarKit.usuarioDespachoMedicamentos || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-600" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Operaciones</label><input type="text" value={trabajarKit.usuarioOperaciones || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-600" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Calidad</label><input type="text" value={(currentUser?.name||currentUser?.nombre||currentUser?.username||'‚Äî')} disabled className="w-full p-2.5 border rounded-lg text-sm bg-green-50 text-green-800 font-semibold" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha marcado impreso</label><input type="text" value={trabajarKit.fechaRecetaImpresa || trabajarKit.fechaArmado || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-600" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha env√≠o kit (Ops ‚Üí Calidad)</label><input type="text" value={trabajarKit.fechaEnvioCalidad || trabajarKit.fechaEntregaCalidad || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-50 text-slate-600" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Hora revisi√≥n (autom√°tica)</label><input type="text" value={horaRevision} disabled className="w-full p-2.5 border rounded-lg text-sm bg-green-50 text-green-800 font-mono" /></div>
                                                </div>
                                                {(trabajarKit.deliveryMode || '').toLowerCase() === 'ruta' && (trabajarKit.direccionEntrega || trabajarKit.direccionAlternativa) && (
                                                    <div className="p-4 bg-violet-50 rounded-xl border border-violet-200">
                                                        <h5 className="text-xs font-bold text-violet-700 uppercase mb-2">Direcci√≥n confirmada (ruta)</h5>
                                                        <input type="text" value={trabajarKit.direccionEntrega || trabajarKit.direccionAlternativa || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700" />
                                                    </div>
                                                )}
                                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                                    <div className="flex items-center justify-between mb-3"><h5 className="text-xs font-bold text-slate-500 uppercase">Medicamentos asignados</h5><span className="text-lg font-bold text-turquoise-600 tabular-nums">{calcularMedCounter(meds).str}</span></div>
                                                    <div className="space-y-3 max-h-60 overflow-y-auto">
                                                        {meds.map((m, i) => {
                                                            const va = m.dispensar !== false;
                                                            const parcial = !!m.dispensacionParcial;
                                                            const bg = !va ? 'bg-red-50 border-red-200' : parcial ? 'bg-amber-50 border-amber-200' : 'bg-green-50 border-green-200';
                                                            const label = !va ? 'No dispensado' : parcial ? 'Dispensaci√≥n parcial' : 'Dispensaci√≥n completa';
                                                            const tipoStr = (m.tipo || 'no cronico').toLowerCase();
                                                            return (
                                                                <div key={i} className={`p-3 rounded-lg border-2 ${bg}`}>
                                                                    <div className="flex items-start justify-between gap-3 mb-2">
                                                                        <div className="flex-1">
                                                                            <span className={`font-semibold ${!va?'text-red-800':parcial?'text-amber-800':'text-green-800'}`}>{m.nombre || '‚Äî'}</span>
                                                                            <span className="ml-2 text-base font-bold text-slate-800 uppercase">{tipoStr}</span>
                                                                            {m.observaciones && <p className={`text-xs mt-1 ${!va?'text-red-700':'text-slate-600'}`}>Obs: {m.observaciones}</p>}
                                                                        </div>
                                                                        <span className={`text-xs font-bold ${!va?'text-red-600':parcial?'text-amber-600':'text-green-600'}`}>{label}</span>
                                                                    </div>
                                                                    <div className="mt-2 pt-2 border-t border-slate-200 space-y-2">
                                                                        <div className="flex flex-wrap items-center gap-3">
                                                                            <div className="px-3 py-2 rounded-lg bg-slate-100 border border-slate-200">
                                                                                <span className="text-[10px] font-bold text-slate-500 uppercase block">ID Receta / Cantidad receta</span>
                                                                                <span className="font-mono text-sm text-slate-700">{m.idReceta || '‚Äî'} / {m.cantidadReceta ?? m.cantidad ?? '‚Äî'}</span>
                                                                            </div>
                                                                            <div>
                                                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-0.5">Cantidad registrada</label>
                                                                                <input type="text" value={m.cantidad || ''} onChange={e=>{const nm=[...(k.medicamentos||[])]; nm[i]={...nm[i], cantidad:e.target.value}; setTrabajarKitLocal({...k, medicamentos:nm});}} className="w-20 p-2 border rounded-lg text-sm bg-white border-slate-200 font-mono" placeholder="‚Äî" />
                                                                            </div>
                                                                        </div>
                                                                        {va && (
                                                                            <div className="flex flex-wrap items-center gap-3">
                                                                                <span className="text-[10px] font-bold text-slate-500 uppercase">Dispensaci√≥n parcial</span>
                                                                                <div className="flex gap-1">
                                                                                    <button type="button" onClick={()=>{const nm=[...(k.medicamentos||[])]; nm[i]={...nm[i], dispensacionParcial:false}; setTrabajarKitLocal({...k, medicamentos:nm});}} className={`px-3 py-1 rounded-lg text-xs font-bold ${!parcial?'bg-slate-200 text-slate-700':'bg-slate-100 text-slate-500'}`}>No</button>
                                                                                    <button type="button" onClick={()=>{const nm=[...(k.medicamentos||[])]; nm[i]={...nm[i], dispensacionParcial:true}; setTrabajarKitLocal({...k, medicamentos:nm});}} className={`px-3 py-1 rounded-lg text-xs font-bold ${parcial?'bg-amber-200 text-amber-800':'bg-slate-100 text-slate-500'}`}>S√≠</button>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                        {meds.length === 0 && <p className="text-slate-400 text-sm">Sin medicamentos</p>}
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                                    <div><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">BTP</label><input type="text" value={trabajarData.btp} onChange={e=>setTrabajarData({...trabajarData, btp:e.target.value})} className="w-full p-2.5 border rounded-lg text-sm bg-white" placeholder="Cantidad" /></div>
                                                    <div><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">BTG</label><input type="text" value={trabajarData.btg} onChange={e=>setTrabajarData({...trabajarData, btg:e.target.value})} className="w-full p-2.5 border rounded-lg text-sm bg-white" placeholder="Cantidad" /></div>
                                                    <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tipo bolsa verde</label><select value={trabajarData.tipoBolsaVerde} onChange={e=>setTrabajarData({...trabajarData, tipoBolsaVerde:e.target.value})} className="w-full p-2.5 border rounded-lg text-sm bg-white"><option value="GRANDE">GRANDE</option><option value="PEQUE√ëA">PEQUE√ëA</option><option value="NINGUNA">NINGUNA</option></select></div>
                                                </div>
                                                <div className="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <h5 className="text-xs font-bold text-amber-800 uppercase">Incidencias</h5>
                                                        <button type="button" onClick={()=>{ setTrabajarData({...trabajarData, incidenciasActivo:!trabajarData.incidenciasActivo}); setIncidenciaMedIdx(null); }} className={`px-4 py-2 rounded-xl text-sm font-bold ${trabajarData.incidenciasActivo?'bg-amber-600 text-white':'bg-amber-100 text-amber-800'}`}>{trabajarData.incidenciasActivo ? 'Activado' : 'Activar'}</button>
                                                    </div>
                                                    {trabajarData.incidenciasActivo && (
                                                        <div className="space-y-3">
                                                            <div className="flex flex-wrap gap-2">
                                                                {meds.map((m, idx)=>(
                                                                    <button key={idx} type="button" onClick={()=>{ setIncidenciaMedIdx(idx); setIncidenciaTipoSel('error_cantidad'); setIncidenciaOtraTexto(''); }} className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${incidenciaMedIdx===idx?'bg-amber-200 border-amber-500 ring-2 ring-amber-400':'bg-white border-amber-300 text-amber-800'}`}>+ {m.nombre||'Med '+(idx+1)}</button>
                                                                ))}
                                                                <button type="button" onClick={()=>{const t=prompt('Descripci√≥n incidencia (otra):'); if(t&&t.trim()) setTrabajarData({...trabajarData, incidencias:[...(trabajarData.incidencias||[]), {tipo:'otra', texto:t.trim()}]});}} className="px-3 py-1.5 rounded-lg bg-amber-200 text-amber-900 text-xs font-bold">+ Otra</button>
                                                            </div>
                                                            {incidenciaMedIdx !== null && meds[incidenciaMedIdx] && (
                                                                <div className="p-3 rounded-xl bg-white border-2 border-amber-300 space-y-2">
                                                                    <p className="text-xs font-bold text-amber-800">Qu√© incidencia pas√≥ en <span className="font-bold text-base uppercase">{(meds[incidenciaMedIdx].tipo||'no cronico')}</span> ‚Äî {meds[incidenciaMedIdx].nombre || 'Med '+(incidenciaMedIdx+1)}</p>
                                                                    <div className="flex flex-wrap items-center gap-2">
                                                                        <select value={incidenciaTipoSel} onChange={e=>setIncidenciaTipoSel(e.target.value)} className="p-2 rounded-lg border border-amber-300 text-sm font-medium bg-white">
                                                                            <option value="error_cantidad">Error de cantidad de medicamentos</option>
                                                                            <option value="falta_stock">Falta de stock</option>
                                                                            <option value="daniado">Da√±ado</option>
                                                                            <option value="otro">Otro</option>
                                                                        </select>
                                                                        {incidenciaTipoSel === 'otro' && <input type="text" value={incidenciaOtraTexto} onChange={e=>setIncidenciaOtraTexto(e.target.value)} placeholder="Describe..." className="p-2 rounded-lg border border-amber-300 text-sm flex-1 min-w-[120px]" />}
                                                                        <button type="button" disabled={incidenciaTipoSel==='otro'&&!incidenciaOtraTexto.trim()} onClick={()=>{const med=meds[incidenciaMedIdx]; const inc={tipo:'medicamento', medIdx:incidenciaMedIdx, medicamento:med.nombre, tipoMed:med.tipo||'no cronico', incidenciaTipo:incidenciaTipoSel, incidenciaTexto:incidenciaTipoSel==='otro'?incidenciaOtraTexto.trim():null}; setTrabajarData({...trabajarData, incidencias:[...((trabajarData.incidencias||[]).filter(x=>!(x.tipo==='medicamento'&&x.medIdx===incidenciaMedIdx))), inc]}); setIncidenciaMedIdx(null); setIncidenciaOtraTexto(''); }} className="px-4 py-2 rounded-lg bg-amber-600 text-white text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed">A√±adir</button>
                                                                        <button type="button" onClick={()=>{ setIncidenciaMedIdx(null); setIncidenciaOtraTexto(''); }} className="px-3 py-2 rounded-lg bg-slate-200 text-slate-700 text-sm font-bold">Cancelar</button>
                                                                    </div>
                                                                </div>
                                                            )}
                                                            {(trabajarData.incidencias||[]).length>0 && (
                                                                <ul className="text-sm text-slate-700 space-y-2">
                                                                    {(trabajarData.incidencias||[]).map((inc,j)=>(
                                                                        <li key={j} className="flex items-center justify-between gap-2 p-2 rounded-lg bg-white/80 border border-amber-200">
                                                                            <span className="flex-1 min-w-0">
                                                                                {inc.tipo==='medicamento' ? (
                                                                                    <><span className="font-bold text-base text-slate-800">{(inc.tipoMed||'no cronico').toUpperCase()}</span> ‚Äî {inc.medicamento}{inc.incidenciaTipo ? <span className="text-amber-700 font-medium"> ¬∑ {inc.incidenciaTipo==='error_cantidad'?'Error de cantidad':inc.incidenciaTipo==='falta_stock'?'Falta de stock':inc.incidenciaTipo==='daniado'?'Da√±ado':inc.incidenciaTexto||'Otro'}</span> : null}</>
                                                                                ) : (
                                                                                    <span>{inc.texto}</span>
                                                                                )}
                                                                            </span>
                                                                            <button type="button" onClick={()=>setTrabajarData({...trabajarData, incidencias:(trabajarData.incidencias||[]).filter((_,i)=>i!==j)})} className="text-red-600 hover:underline text-xs font-bold shrink-0">Quitar</button>
                                                                        </li>
                                                                    ))}
                                                                </ul>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="p-4 bg-green-50 rounded-xl border border-green-200">
                                                    <label className="text-[10px] font-bold text-green-800 uppercase block mb-2">Observaciones calidad</label>
                                                    <textarea className="w-full p-3 border border-green-200 rounded-xl text-sm bg-white focus:ring-2 focus:ring-green-300 outline-none" rows={2} value={trabajarData.observacionesCalidad||''} onChange={e=>setTrabajarData({...trabajarData, observacionesCalidad:e.target.value})} placeholder="Observaciones de la revisi√≥n..." />
                                                </div>
                                                {(() => {
                                                    const hasRefri = !!(k.isRefrigerated || (k.cantRefriGlobal && parseInt(String(k.cantRefriGlobal), 10) > 0));
                                                    const opciones = hasRefri ? ['SOLO REFRIGERADO', 'KIT + REFRIGERADO'] : ['SOLO KIT'];
                                                    const valor = trabajarData.tipoDespachoRefrigerado && opciones.includes(trabajarData.tipoDespachoRefrigerado) ? trabajarData.tipoDespachoRefrigerado : opciones[0];
                                                    return (
                                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                                            <label className="text-[10px] font-bold text-slate-600 uppercase block mb-2">Tipo despacho {hasRefri ? '(refrigerado)' : '(kit)'}</label>
                                                            <select value={valor} onChange={e=>setTrabajarData({...trabajarData, tipoDespachoRefrigerado:e.target.value})} className="w-full p-3 border border-slate-200 rounded-xl text-sm bg-white focus:ring-2 focus:ring-turquoise-300 outline-none">
                                                                {opciones.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                            </select>
                                                        </div>
                                                    );
                                                })()}
                                                <p className="text-xs text-slate-500">Hora de revisi√≥n autom√°tica. Al guardar se registra la revisi√≥n y el kit sale de tu lista. Luego puedes enviar a log√≠stica.</p>
                                                <div className="flex gap-3 pt-2">
                                                    <button type="submit" className="flex-1 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700">Guardar</button>
                                                    <button type="button" onClick={cerrarTrabajar} className="px-6 py-3 bg-slate-600 text-white font-bold rounded-xl hover:bg-slate-700">Cancelar</button>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </form>
                            )}
                        </Modal>
                    )}
                </div>
            );
        };

        // --- BLOCK: REPORTES ---
        const ReportsBlock = ({ kits, patients, userRole, userName, setView, currentUser, users = [] }) => {
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedDay, setSelectedDay] = useState(null);
            const [selectedKit, setSelectedKit] = useState(null);
            const [showKitModal, setShowKitModal] = useState(false);
            const [kitToEdit, setKitToEdit] = useState(null);

            const userDept = currentUser?.departamento || '';
            const filteredKits = useMemo(() => {
                if (userRole !== 'supervisor' || !userDept || !users.length) return kits;
                const deptNames = users
                    .filter(u => (u.departamento || '').toLowerCase() === userDept.toLowerCase())
                    .flatMap(u => [(u.nombre || '').trim(), (u.username || '').trim()].filter(Boolean))
                    .map(n => n.toLowerCase());
                return kits.filter(k => {
                    const d = (k.digitador || '').trim().toLowerCase();
                    if (!d) return false;
                    return deptNames.some(n => n && (d === n || d.includes(n)));
                });
            }, [kits, userRole, userDept, users]);
            
            const groupedByMonth = useMemo(() => {
                const groups = {};
                filteredKits.forEach(kit => {
                    if (!kit.fechaArmado) return;
                    const date = new Date(kit.fechaArmado);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const dayKey = kit.fechaArmado;
                    
                    if (!groups[monthKey]) {
                        groups[monthKey] = {
                            name: monthKey,
                            display: date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }),
                            days: {}
                        };
                    }
                    
                    if (!groups[monthKey].days[dayKey]) {
                        groups[monthKey].days[dayKey] = {
                            date: dayKey,
                            display: date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }),
                            kits: []
                        };
                    }
                    
                    groups[monthKey].days[dayKey].kits.push(kit);
                });
                return groups;
            }, [filteredKits]);

            const downloadDayExcel = (dayKits) => {
                if (!dayKits || dayKits.length === 0) {
                    alert('No hay kits para este d√≠a');
                    return;
                }

                const excelData = dayKits.map(kit => ({
                    'DNI/ID': kit.dni || '',
                    'Nombre': kit.nombre || '',
                    'Cantidad Medicamentos': kit.medicamentos?.length || 0,
                    'Cantidad Refrigerados': kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    'Fecha Armado Kit': kit.fechaArmado || '',
                    'Digitador': kit.digitador || '',
                    'Fecha Entrega Kit': kit.fechaEntregaKit || '',
                    'Modo Entrega': kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla',
                    'Contact Center': kit.contactCenter || '',
                    'GPS': kit.gpsStatus || 'SIN GPS'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Kits del D√≠a");
                
                const fileName = `kits_${selectedDay}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            const handleBack = () => {
                if (selectedKit) {
                    setSelectedKit(null);
                } else if (selectedDay) {
                    setSelectedDay(null);
                } else if (selectedMonth) {
                    setSelectedMonth(null);
                }
            };

            const handleEditKitFromReports = (kit) => {
                setKitToEdit(kit);
                const patient = patients.find(p => p.dni === kit.dni);
                if (patient) {
                    sessionStorage.setItem('editKitFromReports', JSON.stringify({
                        kitId: kit.id,
                        patientId: patient.id,
                        kitData: kit
                    }));
                    setView('pacientes');
                } else {
                    alert('No se encontr√≥ el paciente asociado a este kit');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={handleBack} className={`p-2 rounded-xl transition-colors ${selectedMonth ? 'hover:bg-slate-100 text-slate-500' : 'opacity-0 pointer-events-none'}`}>
                                <Icons.ArrowLeft size={20}/>
                            </button>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">
                                    {selectedKit ? 'Detalle del Kit' : 
                                     selectedDay ? `Kits del ${selectedDay}` :
                                     selectedMonth ? groupedByMonth[selectedMonth]?.display :
                                     (userRole === 'supervisor' ? 'Reportes de mi Departamento' : 'Reportes y Carpetas')}
                                </h3>
                                <p className="text-xs font-semibold text-turquoise-600">
                                    {selectedKit ? 'Informaci√≥n completa' :
                                     selectedDay ? `${groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.length || 0} Kits` :
                                     selectedMonth ? `${Object.keys(groupedByMonth[selectedMonth]?.days || {}).length} d√≠as` :
                                     `${Object.keys(groupedByMonth).length} meses, ${filteredKits.length} kits totales`}
                                    {userRole === 'supervisor' && userDept && ` ¬∑ ${userDept}`}
                                </p>
                            </div>
                        </div>
                        
                        {(userRole === 'admin' || userRole === 'superadmin' || userRole === 'supervisor') && selectedDay && (
                            <button 
                                onClick={() => downloadDayExcel(groupedByMonth[selectedMonth]?.days[selectedDay]?.kits)} 
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect"
                            >
                                <Icons.Download size={16}/> Descargar Excel
                            </button>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {selectedKit ? (
                            <div className="text-center py-10 text-slate-400">
                                Redirigiendo a modal de detalles...
                            </div>
                        ) : selectedDay ? (
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.map(kit => (
                                        <div 
                                            key={kit.id} 
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:shadow-md transition-all"
                                        >
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="font-bold text-slate-800 text-sm truncate">{kit.nombre}</div>
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${kit.deliveryMode === 'ruta' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla'}
                                                </span>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                <div className="text-xs text-slate-500 flex items-center gap-2">
                                                    <span className="font-mono bg-slate-100 px-2 py-0.5 rounded">{kit.dni}</span>
                                                    <span className="text-turquoise-600 font-bold">{kit.medicamentos?.length || 0} meds</span>
                                                </div>
                                                <div className="text-xs text-slate-400 flex justify-between">
                                                    <span>{kit.horaOperaciones || '--:--'}</span>
                                                    <span>{kit.digitador}</span>
                                                </div>
                                                {kit.isRefrigerated && (
                                                    <div className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado: {kit.cantRefriGlobal || 1}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 pt-2 border-t border-slate-100">
                                                <button 
                                                    onClick={() => { setSelectedKit(kit); setShowKitModal(true); }}
                                                    className="flex-1 bg-slate-100 text-slate-700 py-1.5 rounded text-xs font-medium hover:bg-slate-200 transition-colors"
                                                >
                                                    Ver
                                                </button>
                                                {(userRole === 'admin' || userRole === 'superadmin') && (
                                                    <button 
                                                        onClick={() => handleEditKitFromReports(kit)}
                                                        className="flex-1 bg-orange-600 text-white py-1.5 rounded text-xs font-medium hover:bg-orange-700 transition-colors flex items-center justify-center gap-1"
                                                    >
                                                        <Icons.Edit size={12}/> Editar
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : selectedMonth ? (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    {Object.entries(groupedByMonth[selectedMonth]?.days || {}).sort((a, b) => b[0].localeCompare(a[0])).map(([date, dayData]) => (
                                        <div 
                                            key={date} 
                                            onClick={() => setSelectedDay(date)}
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer flex flex-col items-center text-center gap-3 transition-all group"
                                        >
                                            <div className="bg-turquoise-100 p-3 rounded-full text-turquoise-600 group-hover:scale-110 transition-transform">
                                                <Icons.Calendar size={24}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-sm text-slate-700">{dayData.display}</h4>
                                                <p className="text-[10px] text-slate-400 mt-1">{dayData.kits.length} Kits</p>
                                            </div>
                                            {(userRole === 'admin' || userRole === 'superadmin' || userRole === 'supervisor') && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); downloadDayExcel(dayData.kits); }}
                                                    className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full hover:bg-green-200 transition-colors"
                                                >
                                                    <Icons.Download size={10}/> Excel
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                    {Object.entries(groupedByMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([monthKey, monthData]) => (
                                        <div 
                                            key={monthKey} 
                                            onClick={() => setSelectedMonth(monthKey)}
                                            className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-turquoise-400 hover:shadow-lg cursor-pointer flex flex-col items-center text-center gap-4 transition-all group"
                                        >
                                            <div className="bg-gradient-to-br from-turquoise-500 to-clinical-500 p-4 rounded-2xl text-white group-hover:scale-110 transition-transform">
                                                <Icons.Folder size={32}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-lg text-slate-800">{monthData.display}</h4>
                                                <p className="text-sm text-slate-400 mt-1">
                                                    {Object.keys(monthData.days).length} d√≠as ‚Ä¢ {Object.values(monthData.days).reduce((acc, day) => acc + day.kits.length, 0)} kits
                                                </p>
                                            </div>
                                            <div className="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                                {monthKey === `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}` ? 'MES ACTUAL' : 'HIST√ìRICO'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENT: ASIGNACI√ìN MASIVA ---
        const MassAssignForm = ({ users, onAssign }) => {
            const [selectedDept, setSelectedDept] = useState('');
            const [selectedRole, setSelectedRole] = useState('');
            const [selectedUser, setSelectedUser] = useState('');
            const [dnisText, setDnisText] = useState('');
            
            const availableUsers = users.filter(u => {
                if (!selectedDept || !selectedRole) return false;
                if (selectedDept === 'contact center' && selectedRole === 'agente contact center') {
                    return u.departamento === 'contact center' && u.rolesDepartamento?.includes('agente contact center');
                }
                if (selectedDept === 'farmacia' && selectedRole === 'revision y asignacion') {
                    return u.departamento === 'farmacia' && u.rolesDepartamento?.includes('revision y asignacion');
                }
                return false;
            });
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedDept || !selectedRole || !selectedUser || !dnisText.trim()) {
                    alert('Por favor complete todos los campos');
                    return;
                }
                onAssign(selectedDept, selectedRole, selectedUser, dnisText);
            };
            
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Departamento</label>
                        <select 
                            className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                            value={selectedDept} 
                            onChange={e => {
                                setSelectedDept(e.target.value);
                                setSelectedRole('');
                                setSelectedUser('');
                            }}
                            required
                        >
                            <option value="">Seleccione departamento</option>
                            <option value="farmacia">Farmacia</option>
                            <option value="contact center">Contact Center</option>
                        </select>
                    </div>
                    
                    {selectedDept && (
                        <div>
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Rol</label>
                            <select 
                                className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                value={selectedRole} 
                                onChange={e => {
                                    setSelectedRole(e.target.value);
                                    setSelectedUser('');
                                }}
                                required
                            >
                                <option value="">Seleccione rol</option>
                                {selectedDept === 'farmacia' && <option value="revision y asignacion">Revisi√≥n y Asignaci√≥n</option>}
                                {selectedDept === 'contact center' && <option value="agente contact center">Agente Contact Center</option>}
                            </select>
                        </div>
                    )}
                    
                    {selectedRole && (
                        <div>
                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Usuario</label>
                            <select 
                                className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                value={selectedUser} 
                                onChange={e => setSelectedUser(e.target.value)}
                                required
                            >
                                <option value="">Seleccione usuario</option>
                                {availableUsers.map(u => (
                                    <option key={u.id} value={u.id}>
                                        {u.nombre || u.username}
                                    </option>
                                ))}
                            </select>
                        </div>
                    )}
                    
                    <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">DNIs (uno por l√≠nea)</label>
                        <textarea 
                            className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500 h-40 font-mono" 
                            value={dnisText} 
                            onChange={e => setDnisText(e.target.value)}
                            placeholder="0801199012345&#10;0801199012346&#10;0801199012347"
                            required
                        />
                        <p className="text-xs text-slate-500 mt-1">Pegue los DNIs, uno por l√≠nea</p>
                    </div>
                    
                    <button type="submit" className="w-full bg-purple-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-purple-700 btn-hover-effect">
                        Asignar Pacientes
                    </button>
                </form>
            );
        };

        // --- BLOCK: BIT√ÅCORA DE TRABAJO (CONTACT CENTER) ---
        const BitacoraTrabajoBlock = ({ kits, patients, currentUser }) => {
            const u = (currentUser?.name || currentUser?.nombre || currentUser?.username || '').trim().toLowerCase();
            const formatearFechaBitacoraCC = (f) => {
                if (!f) return '';
                const d = new Date(f + 'T12:00:00');
                return d.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });
            };
            const confirmadosPorDia = useMemo(() => {
                if (!u) return [];
                const porFecha = {};
                (kits || []).forEach(k => {
                    const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const cc = (k.contactCenter || pt?.agenteContactCenter || '').trim().toLowerCase();
                    if (!cc || cc !== u) return;
                    const fc = (k.fechaConfirmacionContactCenter || '').toString().slice(0, 10);
                    if (!fc) return;
                    if (!porFecha[fc]) porFecha[fc] = [];
                    porFecha[fc].push(k);
                });
                return Object.entries(porFecha)
                    .map(([f, arr]) => ({ fecha: f, kits: arr.sort((a, b) => new Date(b.fechaConfirmacionContactCenter || 0) - new Date(a.fechaConfirmacionContactCenter || 0)), count: arr.length }))
                    .sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits, patients, currentUser?.name, currentUser?.nombre, currentUser?.username]);
            const [bitacoraFechaAbierta, setBitacoraFechaAbierta] = useState(null);
            const [bitacoraModalSearch, setBitacoraModalSearch] = useState('');
            const [bitacoraCarpetasSearch, setBitacoraCarpetasSearch] = useState('');
            useEffect(() => {
                try {
                    const raw = sessionStorage.getItem('trabajarFromCalendar');
                    if (!raw) return;
                    const data = JSON.parse(raw);
                    if ((data.area || '') !== 'cc' || !data.date) return;
                    sessionStorage.removeItem('trabajarFromCalendar');
                    setBitacoraFechaAbierta(data.date);
                } catch (_) {}
            }, []);
            return (
                <div className="w-full min-w-0 max-w-5xl mx-auto space-y-6 animate-in">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <h2 className="text-2xl font-bold text-slate-800 brand-font">Bit√°cora de trabajo ‚Äî Contact Center</h2>
                        <p className="text-sm text-slate-500">Carpetas por d√≠a trabajado</p>
                    </div>
                    <div className="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                            <div className="flex flex-wrap items-center justify-between gap-3">
                                <span className="font-bold text-slate-700">D√≠as con kits confirmados</span>
                                <div className="relative w-full sm:w-64">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                    <input type="text" placeholder="Buscar por fecha (ej. 2025-01, ene)..." value={bitacoraCarpetasSearch} onChange={e=>setBitacoraCarpetasSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-violet-300 focus:ring-1 focus:ring-violet-200" />
                                </div>
                            </div>
                        </div>
                        <div className="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                            {(() => {
                                const t = (bitacoraCarpetasSearch || '').trim().toLowerCase();
                                const filtered = !t ? confirmadosPorDia : confirmadosPorDia.filter(({ fecha }) => {
                                    const fmt = formatearFechaBitacoraCC(fecha).toLowerCase();
                                    return fmt.includes(t) || (fecha || '').toLowerCase().includes(t);
                                });
                                if (filtered.length === 0) return (
                                    <div className="col-span-full p-12 text-center text-slate-500">
                                        <Icons.Folder size={48} className="mx-auto mb-3 opacity-40"/>
                                        <p className="font-medium">{confirmadosPorDia.length === 0 ? 'No hay d√≠as con kits confirmados' : 'Sin resultados para la b√∫squeda'}</p>
                                        <p className="text-sm mt-1">{confirmadosPorDia.length === 0 ? 'Los kits que confirmes en Contact Center aparecer√°n agrupados por d√≠a.' : 'Pruebe otro t√©rmino (ej. a√±o-mes o nombre del mes).'}</p>
                                    </div>
                                );
                                return filtered.map(({ fecha, kits: ks, count }) => (
                                    <button key={fecha} onClick={() => setBitacoraFechaAbierta(fecha)} className="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-200 hover:border-violet-400 hover:bg-violet-50/50 transition-all text-left btn-hover-effect group">
                                        <div className="p-2.5 rounded-xl bg-violet-100 text-violet-700 group-hover:bg-violet-200"><Icons.Folder size={24}/></div>
                                        <div className="min-w-0 flex-1">
                                            <div className="font-bold text-slate-800 truncate">{formatearFechaBitacoraCC(fecha)}</div>
                                            <div className="text-xs text-slate-500">{count} kit(s) confirmado(s)</div>
                                        </div>
                                    </button>
                                ));
                            })()}
                        </div>
                    </div>
                    {bitacoraFechaAbierta && (
                        <Modal isOpen={true} onClose={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} title={`Bit√°cora CC ‚Äî ${formatearFechaBitacoraCC(bitacoraFechaAbierta)}`} maxWidth="max-w-4xl">
                            <div className="space-y-4">
                                <p className="text-sm text-slate-500">Kits confirmados este d√≠a.</p>
                                <div className="flex flex-wrap items-center gap-3">
                                    <div className="relative flex-1 min-w-[180px]">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                        <input type="text" placeholder="Buscar por nombre o DNI..." value={bitacoraModalSearch} onChange={e=>setBitacoraModalSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-sm outline-none focus:border-violet-300 focus:ring-1 focus:ring-violet-200" />
                                    </div>
                                    <span className="text-sm text-slate-500">
                                        {(() => {
                                            const kitsDia = confirmadosPorDia.find(d => d.fecha === bitacoraFechaAbierta)?.kits || [];
                                            const t = (bitacoraModalSearch || '').trim().toLowerCase();
                                            const filtered = !t ? kitsDia : kitsDia.filter(k => {
                                                const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                                const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                                                const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                                                return n.includes(t) || d.includes(t);
                                            });
                                            return filtered.length !== kitsDia.length ? `${filtered.length} de ${kitsDia.length}` : `${kitsDia.length} kit(s)`;
                                        })()}
                                    </span>
                                </div>
                                <div className="divide-y divide-slate-100 max-h-[50vh] overflow-y-auto rounded-xl border border-slate-100">
                                    {(() => {
                                        const kitsDia = confirmadosPorDia.find(d => d.fecha === bitacoraFechaAbierta)?.kits || [];
                                        const t = (bitacoraModalSearch || '').trim().toLowerCase();
                                        const filtered = !t ? kitsDia : kitsDia.filter(k => {
                                            const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                            const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                                            const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                                            return n.includes(t) || d.includes(t);
                                        });
                                        return filtered.map(k => {
                                            const pt = (patients || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                            return (
                                                <div key={k.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex flex-wrap items-center gap-2">
                                                            <span className="font-bold text-slate-800">{k.nombre || pt?.nombre || '‚Äî'}</span>
                                                            {!!k.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                                                        </div>
                                                        <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                                            <span>DNI: {k.dni || pt?.dni || '‚Äî'}</span>
                                                            <span className="font-mono">{k.fechaConfirmacionContactCenter || '‚Äî'}</span>
                                                            <span className={k.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{k.deliveryMode === 'ruta' ? 'Ruta' : k.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                                            <span>{(k.medicamentos || []).length} med(s)</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        });
                                    })()}
                                </div>
                                <div className="flex justify-end pt-2">
                                    <button onClick={() => { setBitacoraFechaAbierta(null); setBitacoraModalSearch(''); }} className="px-6 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                </div>
                            </div>
                        </Modal>
                    )}
                </div>
            );
        };

        // --- BLOCK: PACIENTES ---
        const PatientManagementBlock = ({ patients: patientsProp, kits: kitsProp, medicines, onAddPatient, onUpdatePatient, onDeletePatient, onSaveKit, onDeleteKit, currentUser, userRole, contacts, printRutaVignette, users = [] }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [selectedPatientFullData, setSelectedPatientFullData] = useState(null);
            const [showPatientForm, setShowPatientForm] = useState(false);
            const [editingPatientId, setEditingPatientId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            const [activePatientTab, setActivePatientTab] = useState('general'); // 'general' | 'asignados' | 'bitacora'
            const [bitacoraRevTab, setBitacoraRevTab] = useState('creados');
            const [bitacoraRevCarpetasSearch, setBitacoraRevCarpetasSearch] = useState('');
            const [bitacoraRevFechaAbierta, setBitacoraRevFechaAbierta] = useState(null);
            const [bitacoraRevModalSearch, setBitacoraRevModalSearch] = useState('');
            const [showMassAssignModal, setShowMassAssignModal] = useState(false);
            const [selectedFolderKey, setSelectedFolderKey] = useState(null); // null = lista carpetas; userName = detalle carpeta
            const [carteraSearch, setCarteraSearch] = useState('');
            const [carteraSemFilter, setCarteraSemFilter] = useState('all'); // 'all' | 'green' | 'orange' | 'red'
            const [assignedUserFilter, setAssignedUserFilter] = useState(''); // '' = todos; normalized name = filtrar por usuario asignado (admin)
            
            // Determinar si el usuario necesita pesta√±as
            const userDept = currentUser?.departamento || '';
            const userDeptLower = (userDept || '').toLowerCase();
            const userRoles = currentUser?.rolesDepartamento || [];
            const isAgenteContactCenter = userDeptLower === 'contact center' && userRoles.includes('agente contact center');
            const isRevisionAsignacion = userDeptLower === 'farmacia' && userRoles.includes('revision y asignacion');
            const needsTabs = isAgenteContactCenter || isRevisionAsignacion;
            const canCreateKits = isRevisionAsignacion; // Solo farmacia revisi√≥n y asignaci√≥n crean kits
            const canCreatePatients = userRole === 'admin' || userRole === 'superadmin';
            const isAdminOrSuperadmin = userRole === 'admin' || userRole === 'superadmin';
            const isDespacho = userDeptLower === 'farmacia' && userRoles.includes('despacho medicamentos');
            const isOperaciones = userDeptLower === 'operaciones' && (userRoles.includes('operador de empaque') || userRoles.includes('supervisor'));
            const isCalidad = userDeptLower === 'calidad' && (userRoles.includes('agente de calidad') || userRoles.includes('supervisor'));
            const isLogistica = userDeptLower === 'logistica' && (userRoles.includes('asignador de rutas despacho logistica') || userRoles.includes('supervisor'));
            const isDelivery = userDeptLower === 'delivery' && (userRoles.includes('motorista') || userRoles.includes('supervisor'));

            const KIT_SECTIONS = { REV_ASIG: 'rev_asig', CONTACT_CENTER: 'contact_center', DESPACHO: 'despacho', OPERACIONES: 'operaciones', CALIDAD: 'calidad', LOGISTICA: 'logistica', DELIVERY: 'delivery' };
            const sectionUnlocked = (section, kit) => {
                if (!kit || !editingKitId) return section === KIT_SECTIONS.REV_ASIG;
                const k = kit.id ? kit : { ...kitData, ...kit };
                switch (section) {
                    case KIT_SECTIONS.REV_ASIG: return true;
                    case KIT_SECTIONS.CONTACT_CENTER: return !!(k.contactCenter && String(k.contactCenter).trim());
                    case KIT_SECTIONS.DESPACHO: return !!k.confirmadoPorContactCenter;
                    case KIT_SECTIONS.OPERACIONES: return !!k.confirmadoPorContactCenter;
                    case KIT_SECTIONS.LOGISTICA: return !!k.recetaImpresa;
                    case KIT_SECTIONS.CALIDAD: return !!(k.fechaEntregaLogistica && String(k.fechaEntregaLogistica).trim());
                    case KIT_SECTIONS.DELIVERY: return !!(k.fechaEntregaLogistica && String(k.fechaEntregaLogistica).trim());
                    default: return false;
                }
            };
            const userCanEditSection = (section) => {
                if (isAdminOrSuperadmin) return true;
                switch (section) {
                    case KIT_SECTIONS.REV_ASIG: return isRevisionAsignacion;
                    case KIT_SECTIONS.CONTACT_CENTER: return isAgenteContactCenter;
                    case KIT_SECTIONS.DESPACHO: return isDespacho;
                    case KIT_SECTIONS.OPERACIONES: return isOperaciones;
                    case KIT_SECTIONS.CALIDAD: return isCalidad;
                    case KIT_SECTIONS.LOGISTICA: return isLogistica;
                    case KIT_SECTIONS.DELIVERY: return isDelivery;
                    default: return false;
                }
            };
            const canEditSection = (section) => {
                const kitRef = editingKitId ? { ...kitData, id: editingKitId } : null;
                return userCanEditSection(section) && (section === KIT_SECTIONS.REV_ASIG || !editingKitId || sectionUnlocked(section, kitRef));
            };
            const editableFieldsForSubmit = () => {
                if (isAdminOrSuperadmin) return null;
                const fields = new Set();
                if (canEditSection(KIT_SECTIONS.REV_ASIG)) {
                    ['deliveryMode', 'contactCenter', 'digitador', 'recetaImpresa'].forEach(f => fields.add(f));
                }
                if (canEditSection(KIT_SECTIONS.CONTACT_CENTER)) {
                    ['confirmadoPorContactCenter', 'devueltoPorContactCenter', 'fechaConfirmacionContactCenter', 'deliveryMode', 'fechaEntregaKit', 'tipoTelefonoCC', 'phoneHighlight', 'esUbicacionPrincipal', 'direccionAlternativa', 'direccionEntrega', 'observacionesEntregaEnabled', 'observacionesEntrega', 'gpsStatus', 'gpsValue', 'observacionesRegresoEnabled', 'observacionesRegresoFarmacia'].forEach(f => fields.add(f));
                }
                if (canEditSection(KIT_SECTIONS.DESPACHO)) {
                    ['medicamentos', 'isRefrigerated', 'cantRefriGlobal', 'triggerMeds'].forEach(f => fields.add(f));
                }
                if (canEditSection(KIT_SECTIONS.OPERACIONES)) {
                    ['horaOperaciones', 'fechaArmado'].forEach(f => fields.add(f));
                }
                if (canEditSection(KIT_SECTIONS.CALIDAD)) {
                    ['observacionesCalidad'].forEach(f => fields.add(f));
                }
                if (canEditSection(KIT_SECTIONS.LOGISTICA)) {
                    ['fechaEntregaLogistica', 'direccionEntrega', 'phoneHighlight', 'gpsStatus', 'gpsValue', 'observationsEnabled', 'observations'].forEach(f => fields.add(f));
                }
                if (canEditSection(KIT_SECTIONS.DELIVERY)) {
                    ['fechaEntregaKit', 'observacionesDelivery'].forEach(f => fields.add(f));
                }
                return fields.size ? fields : null;
            };
            const hasAnyEditableSection = () => {
                if (isAdminOrSuperadmin) return true;
                if (!editingKitId) return isRevisionAsignacion;
                return Object.values(KIT_SECTIONS).some(s => canEditSection(s));
            };
            const sectionDisabled = (s) => !!editingKitId && !canEditSection(s);
            const [currentPage, setCurrentPage] = useState(1);
            const [patientsPerPage] = useState(50);
            const [loadingPatients, setLoadingPatients] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [patients, setPatients] = useState([]);
            const [hasNextPage, setHasNextPage] = useState(false);
            const [pageCursors, setPageCursors] = useState({ 1: null }); // cursor de inicio por p√°gina (page -> { dni, id } o null)
            const [searchResults, setSearchResults] = useState(null); // null => no b√∫squeda remota / no resultados
            const [searching, setSearching] = useState(false);
            const [searchMode, setSearchMode] = useState(''); // '', 'cache', 'firebase'
            const kits = Array.isArray(kitsProp) ? kitsProp : [];
            const [patientCache] = useState(new CacheManager());
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [isViewMode, setIsViewMode] = useState(false);
            const [printTemplates, setPrintTemplates] = useState([]);
            const [selectedPrintTemplate, setSelectedPrintTemplate] = useState(null);
            const [kitData, setKitData] = useState({ 
                fechaArmado: new Date().toISOString().split('T')[0], 
                fechaEntregaLogistica: '', 
                fechaEntregaKit: '', 
                horaOperaciones: '', 
                contactCenter: '', 
                triggerMeds: '', 
                medicamentos: [],
                digitador: '',
                deliveryMode: '', 
                phoneHighlight: '', 
                direccionEntrega: '', 
                gpsStatus: 'SIN GPS',
                gpsValue: '', 
                observationsEnabled: false,
                observations: '',
                isRefrigerated: false, 
                cantRefriGlobal: '',
                recetaImpresa: false,
                observacionesContactCenter: '',
                devueltoPorContactCenter: false,
                confirmadoPorContactCenter: false,
                observacionesCalidad: '',
                observacionesDelivery: '',
                tipoTelefonoCC: '', 
                esUbicacionPrincipal: true, 
                direccionAlternativa: '', 
                observacionesEntregaEnabled: false, 
                observacionesEntrega: '', 
                observacionesRegresoEnabled: false, 
                observacionesRegresoFarmacia: ''
            });
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);
            const [showMarcarImpresoYDespacho, setShowMarcarImpresoYDespacho] = useState(false);
            const [patientSnapshotUnsubscribe, setPatientSnapshotUnsubscribe] = useState(null);
            const [patientForm, setPatientForm] = useState({ 
                dni: '', 
                nombre: '', 
                telefono: '', 
                familiar: '', 
                telefonoFamiliar: '', 
                nAfiliacion: '',
                agenteContactCenter: '',
                usuarioRevisionAsignacion: '',
                direccion: '',
                descripcionMunicipio: '',
                tipoAfiliado: 'AFILIADO DIRECTO'
            });

            // Cargar plantillas de impresi√≥n
            const loadPrintTemplates = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar plantillas de impresi√≥n');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_templates').get();
                    const templates = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setPrintTemplates(templates);
                    
                    // Si no hay plantillas, cargar las predeterminadas autom√°ticamente
                    if (templates.length === 0) {
                        const predeterminedTemplates = createPredeterminedTemplatesForPrint();
                        for (const template of predeterminedTemplates) {
                            const templateRef = db.collection('prod_templates').doc(template.id);
                            await templateRef.set({
                                ...template,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        }
                        // Recargar
                        const newSnapshot = await db.collection('prod_templates').get();
                        const newTemplates = newSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setPrintTemplates(newTemplates);
                    }
                } catch (error) {
                    console.error('Error cargando plantillas de impresi√≥n:', error);
                }
            };
            
            // Funci√≥n para crear las 3 plantillas PREDETERMINADAS (disponible en ambos bloques)
            const createPredeterminedTemplatesForPrint = () => {
                const mmToPx = 3.779; // Conversi√≥n mm a px
                
                // PLANTILLA 1: RUTA
                const plantillaRuta = {
                    id: 'plantilla_ruta',
                    name: 'Plantilla Ruta',
                    type: 'ruta',
                    orientation: 'horizontal',
                    elements: [
                        // Encabezado con logos y t√≠tulo
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_ruta', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_ruta', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, content: 'ENTREGA EN RUTA', fontSize: 5.5*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 21*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 25*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 32*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 36*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        { id: 'label_tel_principal', type: 'text', x: 2*mmToPx, y: 43*mmToPx, width: 45*mmToPx, height: 3.5*mmToPx, content: 'TEL PRINCIPAL', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_principal', type: 'text', x: 2*mmToPx, y: 47*mmToPx, width: 45*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefono' },
                        { id: 'label_tel_ref', type: 'text', x: 50*mmToPx, y: 43*mmToPx, width: 30*mmToPx, height: 3.5*mmToPx, content: 'TEL REF', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_ref', type: 'text', x: 50*mmToPx, y: 47*mmToPx, width: 30*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefonoRef' },
                        { id: 'label_gps', type: 'text', x: 83*mmToPx, y: 43*mmToPx, width: 25*mmToPx, height: 3.5*mmToPx, content: 'GPS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_gps', type: 'text', x: 83*mmToPx, y: 47*mmToPx, width: 25*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'gpsStatus' },
                        { id: 'label_meds', type: 'text', x: 110*mmToPx, y: 43*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: '# MEDICAMENTOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_meds', type: 'text', x: 110*mmToPx, y: 47*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantMedicamentos' },
                        { id: 'label_direccion', type: 'text', x: 2*mmToPx, y: 52*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'DIRECCI√ìN', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_direccion', type: 'text', x: 2*mmToPx, y: 56*mmToPx, width: 100*mmToPx, height: 8*mmToPx, content: '', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'direccion' },
                        { id: 'label_obs_ruta', type: 'text', x: 2*mmToPx, y: 65*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'OBSERVACIONES DE ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_obs_ruta', type: 'text', x: 2*mmToPx, y: 69*mmToPx, width: 100*mmToPx, height: 4*mmToPx, content: '', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'observaciones' },
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 52*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 56*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_refri', type: 'text', x: 160*mmToPx, y: 52*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'REFRIGERADO', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_refri', type: 'text', x: 160*mmToPx, y: 56*mmToPx, width: 48*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantRefrigerados' },
                        { id: 'label_extra_titulo', type: 'text', x: 105*mmToPx, y: 61*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'EXTRA RUTA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_extra_contenido', type: 'text', x: 105*mmToPx, y: 65*mmToPx, width: 103*mmToPx, height: 4*mmToPx, content: '', fontSize: 4*mmToPx, color: '#666666', fontFamily: 'Arial', isField: false }
                    ]
                };
                
                // PLANTILLA 2: VENTANILLA
                const plantillaVentanilla = {
                    id: 'plantilla_ventanilla',
                    name: 'Plantilla Ventanilla',
                    type: 'ventanilla',
                    orientation: 'horizontal',
                    elements: [
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_ventanilla', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_ventanilla', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, content: 'ENTREGA VENTANILLA', fontSize: 5.5*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 21*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 25*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 32*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 36*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        { id: 'label_tel_principal', type: 'text', x: 2*mmToPx, y: 43*mmToPx, width: 45*mmToPx, height: 3.5*mmToPx, content: 'TEL PRINCIPAL', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_principal', type: 'text', x: 2*mmToPx, y: 47*mmToPx, width: 45*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefono' },
                        { id: 'label_tel_ref', type: 'text', x: 50*mmToPx, y: 43*mmToPx, width: 30*mmToPx, height: 3.5*mmToPx, content: 'TEL REF', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_ref', type: 'text', x: 50*mmToPx, y: 47*mmToPx, width: 30*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefonoRef' },
                        { id: 'label_gps', type: 'text', x: 83*mmToPx, y: 43*mmToPx, width: 25*mmToPx, height: 3.5*mmToPx, content: 'GPS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_gps', type: 'text', x: 83*mmToPx, y: 47*mmToPx, width: 25*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'gpsStatus' },
                        { id: 'label_meds', type: 'text', x: 110*mmToPx, y: 43*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: '# MEDICAMENTOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_meds', type: 'text', x: 110*mmToPx, y: 47*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantMedicamentos' },
                        { id: 'campo_ventanilla', type: 'text', x: 2*mmToPx, y: 52*mmToPx, width: 100*mmToPx, height: 10*mmToPx, content: 'VENTANILLA', fontSize: 18*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_obs_ventanilla', type: 'text', x: 2*mmToPx, y: 63*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'OBSERVACIONES DE VENTANILLA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_obs_ventanilla', type: 'text', x: 2*mmToPx, y: 67*mmToPx, width: 100*mmToPx, height: 4*mmToPx, content: '', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'observaciones' },
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 52*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 56*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_refri', type: 'text', x: 160*mmToPx, y: 52*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'REFRIGERADO', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_refri', type: 'text', x: 160*mmToPx, y: 56*mmToPx, width: 48*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantRefrigerados' }
                    ]
                };
                
                // PLANTILLA 3: REFRIGERADOS
                const plantillaRefrigerados = {
                    id: 'plantilla_refrigerados',
                    name: 'Plantilla Refrigerados',
                    type: 'refrigerado',
                    orientation: 'horizontal',
                    elements: [
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_refri', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 8*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_refri', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 8*mmToPx, content: 'PRODUCTO REFRIGERADO', fontSize: 10*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 26*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 30*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 37*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 41*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 26*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA DESPACHO/ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 30*mmToPx, width: 50*mmToPx, height: 6*mmToPx, content: '', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_cant_refri', type: 'text', x: 160*mmToPx, y: 26*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'CANT REFRIGERADOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_cant_refri', type: 'text', x: 160*mmToPx, y: 30*mmToPx, width: 48*mmToPx, height: 12*mmToPx, content: '', fontSize: 20*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: true, fieldId: 'cantRefrigerados' }
                    ]
                };
                
                return [plantillaRuta, plantillaVentanilla, plantillaRefrigerados];
            };

            // Funci√≥n para cargar plantillas predeterminadas (desde el bloque de pacientes)
            const loadPredeterminedTemplatesFromPatientBlock = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        alert('Firebase no disponible');
                        return;
                    }
                    
                    const templates = createPredeterminedTemplatesForPrint();
                    
                    // Guardar o reemplazar las 3 plantillas con IDs fijos
                    for (const template of templates) {
                        const templateRef = db.collection('prod_templates').doc(template.id);
                        await templateRef.set({
                            ...template,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                    
                    // Recargar plantillas
                    await loadPrintTemplates();
                    
                    alert('Plantillas predeterminadas cargadas correctamente');
                } catch (error) {
                    console.error('Error cargando plantillas predeterminadas:', error);
                    alert('Error al cargar plantillas: ' + error.message);
                }
            };

            // Cache por p√°gina (evita re-leer 10,000 pacientes)
            const getPatientsPageCacheKey = (page) => `patient_page_cache_${page}`;

            const loadPatients = async (page = 1, forceRefresh = false) => {
                setLoadingPatients(true);
                setLoadingProgress(0);
                
                try {
                    // Si forceRefresh es false, intentar usar cache de la p√°gina primero
                    if (!forceRefresh) {
                        const cachedPage = patientCache.getFromCache(getPatientsPageCacheKey(page));
                        if (cachedPage && Array.isArray(cachedPage.patients)) {
                            setPatients(cachedPage.patients);
                            setHasNextPage(!!cachedPage.hasNextPage);
                            if (cachedPage.nextCursor) {
                                setPageCursors(prev => ({ ...prev, [page + 1]: cachedPage.nextCursor }));
                            }
                            setLoadingPatients(false);
                            return;
                        }
                    } else {
                        // Forzar recarga SOLO de la p√°gina solicitada (no borrar todo)
                        patientCache.clearCache(getPatientsPageCacheKey(page));
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }

                    // Paginaci√≥n real Firestore: orden estable por DNI + documentId
                    // (evita depender de createdAt, y soporta datos antiguos sin createdAt)
                    const docIdField = firebase.firestore.FieldPath.documentId();
                    let query = db.collection('prod_patients')
                        .orderBy('dni', 'asc')
                        .orderBy(docIdField, 'asc')
                        .limit(patientsPerPage);

                    // Cursor de inicio para p√°ginas > 1
                    if (page > 1) {
                        const startCursor = pageCursors[page];
                        if (!startCursor || !startCursor.dni || !startCursor.id) {
                            // Si no hay cursor (ej: salto directo), caer a p√°gina 1 para evitar lecturas masivas
                            console.warn('‚ö†Ô∏è Cursor no disponible para p√°gina', page, 'volviendo a p√°gina 1');
                            setCurrentPage(1);
                            return await loadPatients(1, forceRefresh);
                        }
                        query = query.startAfter(startCursor.dni, startCursor.id);
                    }
                    
                    const querySnapshot = await query.get();
                    
                    const pagePatients = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        dni: doc.data().dni || '',
                        nombre: doc.data().nombre || '',
                        tipoAfiliado: doc.data().tipoAfiliado || 'AFILIADO DIRECTO',
                        direccion: doc.data().direccion || '',
                        descripcionMunicipio: doc.data().descripcionMunicipio || '',
                        agenteContactCenter: doc.data().agenteContactCenter || '',
                        usuarioRevisionAsignacion: doc.data().usuarioRevisionAsignacion || '',
                        createdAt: doc.data().createdAt
                    }));

                    // Determinar si hay siguiente p√°gina (heur√≠stica: si vino lleno, probablemente hay m√°s)
                    const next = querySnapshot.docs.length === patientsPerPage;
                    setHasNextPage(next);

                    // Construir cursor para la siguiente p√°gina (dni + id del √∫ltimo doc)
                    let nextCursor = null;
                    if (querySnapshot.docs.length > 0) {
                        const lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                        const lastData = lastDoc.data() || {};
                        nextCursor = { dni: String(lastData.dni || ''), id: lastDoc.id };
                        if (nextCursor.dni && nextCursor.id) {
                            setPageCursors(prev => ({ ...prev, [page + 1]: nextCursor }));
                        }
                    }

                    // Guardar cache de ESTA p√°gina
                    patientCache.saveToCache(getPatientsPageCacheKey(page), {
                        patients: pagePatients,
                        hasNextPage: next,
                        nextCursor
                    });

                    setPatients(pagePatients);
                    
                } catch (error) {
                    console.error('Error cargando pacientes:', error);
                    alert('Error al cargar pacientes: ' + error.message);
                } finally {
                    setLoadingProgress(100);
                    setTimeout(() => setLoadingPatients(false), 500);
                }
            };

            // Funci√≥n para refrescar pacientes desde Firebase (fuerza recarga)
            const refreshPatients = async () => {
                await loadPatients(currentPage, true);
            };

            useEffect(() => {
                loadPatients(1);
                loadPrintTemplates();
            }, []);

            // B√∫squeda usando cach√© de p√°ginas (y fallback a Firestore solo si es DNI/prefijo)
            useEffect(() => {
                const termRaw = String(searchTerm || '').trim();
                if (!termRaw) {
                    setSearchResults(null);
                    setSearching(false);
                    setSearchMode('');
                    return;
                }

                // 1) Buscar en cach√© de p√°ginas ya visitadas
                const termLower = termRaw.toLowerCase();
                const cachedKeys = Object.keys(localStorage).filter(k => k.startsWith('patient_page_cache_'));
                const cachedPatients = [];
                for (const key of cachedKeys) {
                    const cached = patientCache.getFromCache(key);
                    if (cached && Array.isArray(cached.patients)) {
                        cachedPatients.push(...cached.patients);
                    }
                }
                const uniq = new Map();
                cachedPatients.forEach(p => {
                    if (p && p.id) uniq.set(p.id, p);
                });
                const cachedMatches = Array.from(uniq.values()).filter(p =>
                    (p.nombre || '').toLowerCase().includes(termLower) ||
                    String(p.dni || '').includes(termRaw)
                );

                if (cachedMatches.length > 0) {
                    setSearchResults(cachedMatches);
                    setSearchMode('cache');
                    setSearching(false);
                    return;
                }

                // 2) Si no hay match en cach√©, intentar Firestore SOLO para DNI/prefijo (limit 50)
                // Esto evita lecturas masivas por b√∫squeda general.
                const looksLikeDni = /^[0-9A-Za-z]{3,}$/.test(termRaw);
                if (!looksLikeDni || !firebaseInitialized || !db) {
                    setSearchResults([]); // sin resultados en cach√©, y sin b√∫squeda remota
                    setSearchMode('cache');
                    setSearching(false);
                    return;
                }

                let cancelled = false;
                (async () => {
                    try {
                        setSearching(true);
                        setSearchMode('firebase');
                        const docIdField = firebase.firestore.FieldPath.documentId();
                        const snap = await db.collection('prod_patients')
                            .orderBy('dni', 'asc')
                            .orderBy(docIdField, 'asc')
                            .startAt(termRaw)
                            .endAt(termRaw + '\uf8ff')
                            .limit(50)
                            .get();

                        if (cancelled) return;
                        const found = snap.docs.map(doc => ({
                            id: doc.id,
                            dni: doc.data().dni || '',
                            nombre: doc.data().nombre || '',
                            tipoAfiliado: doc.data().tipoAfiliado || 'AFILIADO DIRECTO',
                            direccion: doc.data().direccion || '',
                            descripcionMunicipio: doc.data().descripcionMunicipio || '',
                            agenteContactCenter: doc.data().agenteContactCenter || '',
                            usuarioRevisionAsignacion: doc.data().usuarioRevisionAsignacion || '',
                            createdAt: doc.data().createdAt
                        }));
                        setSearchResults(found);
                    } catch (err) {
                        console.warn('‚ö†Ô∏è B√∫squeda Firestore fall√≥, usando solo cach√©:', err);
                        if (!cancelled) setSearchResults([]);
                    } finally {
                        if (!cancelled) setSearching(false);
                    }
                })();

                return () => { cancelled = true; };
            }, [searchTerm]);

            useEffect(() => {
                const editKitData = sessionStorage.getItem('editKitFromReports');
                if (editKitData) {
                    try {
                        const parsed = JSON.parse(editKitData);
                        const { kitData, patientId, patient: storedPatient, viewOnly, openPatientOnly } = parsed;
                        const patient = storedPatient || patients.find(p => p.id === patientId);
                        if (patient) {
                            handleSelectPatient(patient);
                            if (kitData && !openPatientOnly) {
                                const meds = (kitData.medicamentos || []).map(m => ({
                                    ...m,
                                    dispensar: m.dispensar !== false,
                                    observaciones: m.observaciones || '',
                                    recetaFisicaVerificada: !!m.recetaFisicaVerificada
                                }));
                                setKitData({
                                    ...kitData,
                                    medicamentos: meds,
                                    phoneHighlight: kitData.phoneHighlight || '',
                                    direccionEntrega: kitData.direccionEntrega || '',
                                    gpsValue: kitData.gpsValue || '',
                                    recetaImpresa: !!kitData.recetaImpresa
                                });
                                setEditingKitId(kitData.id);
                                setIsViewMode(!!viewOnly);
                                setShowKitForm(true);
                            }
                        }
                    } finally {
                        sessionStorage.removeItem('editKitFromReports');
                    }
                }
            }, [patients]);

            const loadPatientFullData = async (patientId) => {
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                }
                
                try {
                    const cachedPatient = patientCache.getPatient(patientId);
                    if (cachedPatient) {
                        setSelectedPatientFullData(cachedPatient);
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const patientDoc = await db.collection('prod_patients').doc(patientId).get();
                    if (patientDoc.exists) {
                        const fullData = { id: patientDoc.id, ...patientDoc.data() };
                        setSelectedPatientFullData(fullData);
                        patientCache.savePatient(patientId, fullData);
                        
                        const unsubscribe = db.collection('prod_patients').doc(patientId)
                            .onSnapshot((doc) => {
                                if (doc.exists) {
                                    const updatedData = { id: doc.id, ...doc.data() };
                                    setSelectedPatientFullData(updatedData);
                                    patientCache.savePatient(patientId, updatedData);
                                }
                            });
                        
                        setPatientSnapshotUnsubscribe(() => unsubscribe);
                    }
                } catch (error) {
                    console.error("Error cargando datos del paciente:", error);
                }
            };

            const handleSelectPatient = async (patient) => {
                setSelectedPatient(patient);
                await loadPatientFullData(patient.id);
            };

            useEffect(() => {
                return () => {
                    if (patientSnapshotUnsubscribe) {
                        patientSnapshotUnsubscribe();
                    }
                };
            }, [patientSnapshotUnsubscribe]);

            // Todos los usuarios del mismo rol (para una carpeta por usuario, siempre una carpeta por nombre)
            const allUsersForRole = useMemo(() => {
                if (!needsTabs) return [];
                const base = users.filter(u => {
                    if (isAgenteContactCenter) {
                        return u.departamento === 'contact center' && u.rolesDepartamento?.includes('agente contact center');
                    }
                    if (isRevisionAsignacion) {
                        return u.departamento === 'farmacia' && u.rolesDepartamento?.includes('revision y asignacion');
                    }
                    return false;
                });
                const hasCurrent = base.some(u => (u.id && u.id === currentUser?.id) || ((u.nombre || u.username || u.name || '').trim().toLowerCase() === (currentUser?.name || currentUser?.username || currentUser?.nombre || '').trim().toLowerCase()));
                if (!hasCurrent && currentUser) {
                    const name = (currentUser.name || currentUser.nombre || currentUser.username || '').trim();
                    return [{ id: currentUser.id, nombre: name, username: currentUser.username || name, ...currentUser }, ...base];
                }
                return base;
            }, [users, needsTabs, isAgenteContactCenter, isRevisionAsignacion, currentUser]);

            // Usuarios con trabajo compartido activo (solo sus carpetas permiten crear kits a otros)
            const getAvailableUsersForRole = useMemo(() => {
                if (!needsTabs) return [];
                return users.filter(u => {
                    if (u.id === currentUser?.id) return false;
                    if (isAgenteContactCenter) {
                        return u.departamento === 'contact center' && 
                               u.rolesDepartamento?.includes('agente contact center') &&
                               u.trabajoCompartido === true;
                    }
                    if (isRevisionAsignacion) {
                        return u.departamento === 'farmacia' && 
                               u.rolesDepartamento?.includes('revision y asignacion') &&
                               u.trabajoCompartido === true;
                    }
                    return false;
                });
            }, [users, needsTabs, isAgenteContactCenter, isRevisionAsignacion, currentUser]);

            // Estado para todos los pacientes (necesario para filtrado por usuario)
            const [allPatients, setAllPatients] = useState([]);
            
            // Cargar todos los pacientes cuando se necesita para filtrado
            useEffect(() => {
                if (needsTabs && activePatientTab === 'asignados') {
                    const loadAllPatients = async () => {
                        try {
                            if (!firebaseInitialized || !db) return;
                            
                            const querySnapshot = await db.collection('prod_patients')
                                .orderBy('dni', 'asc')
                                .get();
                            
                            const allPats = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            setAllPatients(allPats);
                        } catch (error) {
                            console.error('Error cargando todos los pacientes:', error);
                        }
                    };
                    loadAllPatients();
                } else {
                    setAllPatients([]);
                }
            }, [needsTabs, activePatientTab, firebaseInitialized, db]);
            
            // Organizar pacientes por usuario: una carpeta por usuario, pacientes siempre en su carpeta
            const patientsByUser = useMemo(() => {
                if (!needsTabs || activePatientTab !== 'asignados') return {};
                
                const grouped = {};
                const currentUserName = (currentUser?.name || currentUser?.username || currentUser?.nombre || '').trim().toLowerCase();
                const sharedNames = new Set(getAvailableUsersForRole.map(u => (u?.nombre || u?.username || '').trim().toLowerCase()).filter(Boolean));
                const patientsToFilter = allPatients.length > 0 ? allPatients : patients;
                
                allUsersForRole.forEach(user => {
                    const userName = (user?.nombre || user?.username || user?.name || '').trim().toLowerCase();
                    if (!userName) return;
                    
                    const userPatients = patientsToFilter.filter(p => {
                        if (isAgenteContactCenter) {
                            return p.agenteContactCenter && p.agenteContactCenter.trim().toLowerCase() === userName;
                        }
                        if (isRevisionAsignacion) {
                            return p.usuarioRevisionAsignacion && p.usuarioRevisionAsignacion.trim().toLowerCase() === userName;
                        }
                        return false;
                    });
                    
                    const isCurrentUser = userName === currentUserName;
                    const canCreateInFolder = isCurrentUser || sharedNames.has(userName);
                    
                    grouped[userName] = {
                        user,
                        patients: userPatients,
                        isCurrentUser,
                        canCreateInFolder
                    };
                });
                
                return grouped;
            }, [allPatients, patients, needsTabs, activePatientTab, isAgenteContactCenter, isRevisionAsignacion, currentUser, allUsersForRole, getAvailableUsersForRole]);

            const allowedAssigneeNames = useMemo(() => {
                if (!isRevisionAsignacion && !isAgenteContactCenter) return [];
                const names = [];
                const add = (u) => {
                    const n = (u?.nombre || u?.username || u?.name || '').trim().toLowerCase();
                    if (n && !names.includes(n)) names.push(n);
                };
                if (currentUser) add(currentUser);
                getAvailableUsersForRole.forEach(u => add(u));
                return names;
            }, [isRevisionAsignacion, isAgenteContactCenter, currentUser, getAvailableUsersForRole]);

            const canCreateKitForPatient = (p) => {
                if (!p) return false;
                if (!isRevisionAsignacion) return false; // Solo rev/asig crean kits
                const assignee = (p.usuarioRevisionAsignacion || '').trim().toLowerCase();
                if (!assignee) return false;
                return allowedAssigneeNames.some(n => n && assignee === n);
            };

            const folderSoloLectura = !!(needsTabs && activePatientTab === 'asignados' && selectedFolderKey && patientsByUser[selectedFolderKey] && !patientsByUser[selectedFolderKey].canCreateInFolder);

            const userDisplayRev = () => (currentUser?.name || currentUser?.nombre || currentUser?.username || '').trim().toLowerCase();
            const formatearFechaBitacoraRev = (f) => {
                if (!f) return '';
                const d = new Date(f + 'T12:00:00');
                return d.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });
            };
            const creadosPorDia = useMemo(() => {
                if (!isRevisionAsignacion) return [];
                const u = userDisplayRev();
                if (!u) return [];
                const plist = (allPatients && allPatients.length > 0) ? allPatients : patients;
                const porFecha = {};
                (kits || []).forEach(k => {
                    const fa = (k.fechaArmado || '').toString().slice(0, 10);
                    if (!fa) return;
                    const d = (k.digitador || '').trim().toLowerCase();
                    const pt = (plist || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                    const ra = (pt?.usuarioRevisionAsignacion || '').trim().toLowerCase();
                    if (d !== u && ra !== u) return;
                    if (!porFecha[fa]) porFecha[fa] = [];
                    porFecha[fa].push(k);
                });
                return Object.entries(porFecha)
                    .map(([f, arr]) => ({ fecha: f, kits: arr.sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0)), count: arr.length }))
                    .sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits, allPatients, patients, isRevisionAsignacion, currentUser?.name, currentUser?.nombre, currentUser?.username]);
            const impresosPorDia = useMemo(() => {
                if (!isRevisionAsignacion) return [];
                const u = userDisplayRev();
                if (!u) return [];
                const porFecha = {};
                (kits || []).forEach(k => {
                    const fi = (k.fechaImpresionReceta || '').toString().slice(0, 10);
                    if (!fi || !k.recetaImpresa) return;
                    const d = (k.digitador || '').trim().toLowerCase();
                    if (d !== u) return;
                    if (!porFecha[fi]) porFecha[fi] = [];
                    porFecha[fi].push(k);
                });
                return Object.entries(porFecha)
                    .map(([f, arr]) => ({ fecha: f, kits: arr.sort((a, b) => new Date(b.fechaImpresionReceta || 0) - new Date(a.fechaImpresionReceta || 0)), count: arr.length }))
                    .sort((a, b) => b.fecha.localeCompare(a.fecha));
            }, [kits, isRevisionAsignacion, currentUser?.name, currentUser?.nombre, currentUser?.username]);

            const assignableUsersForFilter = useMemo(() => {
                const out = [];
                const seen = new Set();
                (users || []).forEach(u => {
                    const d = (u.departamento || '').toLowerCase();
                    const roles = u.rolesDepartamento || [];
                    const isRev = d === 'farmacia' && roles.includes('revision y asignacion');
                    const isCC = d === 'contact center' && roles.includes('agente contact center');
                    if (!isRev && !isCC) return;
                    const name = (u.nombre || u.username || u.name || '').trim();
                    if (!name) return;
                    const norm = name.toLowerCase();
                    if (seen.has(norm)) return;
                    seen.add(norm);
                    out.push({ name, normalized: norm, role: isRev ? 'Rev. y asignaci√≥n' : 'Contact Center' });
                });
                return out.sort((a, b) => a.name.localeCompare(b.name, 'es'));
            }, [users]);

            const getPatientSemaphore = (p, patientKits) => {
                const klist = (patientKits || kits.filter(k => k.patientId === p.id)).filter(Boolean);
                if (isRevisionAsignacion) {
                    if (klist.length === 0) return 'green';
                    const sorted = [...klist].sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
                    const latest = sorted[0];
                    const sent = !!(latest.contactCenter && String(latest.contactCenter).trim());
                    if (sent && !latest.devueltoPorContactCenter) return 'orange';
                    if (latest.devueltoPorContactCenter && !latest.recetaImpresa) return 'red';
                    return 'green';
                }
                if (isAgenteContactCenter) {
                    if (klist.length === 0) return 'green';
                    const pending = klist.some(k => !k.confirmadoPorContactCenter);
                    return pending ? 'red' : 'green';
                }
                return 'green';
            };

            const getLastDeliveryDate = (p) => {
                const klist = kits.filter(k => k.patientId === p.id && k.fechaEntregaKit);
                if (klist.length === 0) return null;
                const sorted = [...klist].sort((a, b) => new Date(b.fechaEntregaKit) - new Date(a.fechaEntregaKit));
                const d = new Date(sorted[0].fechaEntregaKit);
                return isNaN(d.getTime()) ? null : d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
            };

            const filteredPatients = useMemo(() => {
                let basePatients = patients;
                const term = String(searchTerm || '').trim();
                
                // Si hay b√∫squeda activa, usamos resultados (cache o firebase)
                if (term) {
                    basePatients = Array.isArray(searchResults) ? searchResults : [];
                }
                
                // Si est√° en pesta√±a asignados y hay organizaci√≥n por carpetas, retornar todos los pacientes agrupados
                if (needsTabs && activePatientTab === 'asignados') {
                    const allAssignedPatients = Object.values(patientsByUser).flatMap(group => group.patients);
                    return allAssignedPatients;
                }
                
                // Filtro por usuario asignado (admin): aplica solo en lista general (Pacientes Generales / sin tabs)
                if (isAdminOrSuperadmin && assignedUserFilter) {
                    const norm = assignedUserFilter.toLowerCase();
                    basePatients = basePatients.filter(p => {
                        const rev = (p.usuarioRevisionAsignacion || '').trim().toLowerCase();
                        const cc = (p.agenteContactCenter || '').trim().toLowerCase();
                        return rev === norm || cc === norm;
                    });
                }
                
                return basePatients;
            }, [patients, searchTerm, searchResults, activePatientTab, needsTabs, patientsByUser, isAdminOrSuperadmin, assignedUserFilter]);

            // En paginaci√≥n real, `patients` ya es la p√°gina actual (m√°x 50)
            const currentPatients = filteredPatients;
            const indexOfFirstPatient = ((currentPage - 1) * patientsPerPage);
            const indexOfLastPatient = indexOfFirstPatient + currentPatients.length;

            const patientKits = selectedPatient ? kits.filter(k => k.patientId === selectedPatient.id) : [];

            const medsCounter = useMemo(() => {
                const m = kitData.medicamentos || [];
                const total = m.length;
                const dispensados = m.filter(x => x.dispensar !== false).length;
                return { dispensados, total, str: total ? `${dispensados}/${total}` : '0/0' };
            }, [kitData.medicamentos]);

            const isRevAsigFormView = isRevisionAsignacion && !isViewMode && showKitForm;
            const isCCFormView = isAgenteContactCenter && !isViewMode && showKitForm && !!editingKitId && canEditSection(KIT_SECTIONS.CONTACT_CENTER);
            const isDespachoFormView = isDespacho && !isViewMode && showKitForm && !!editingKitId && !!kitData.recetaImpresa;

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);
                    
                    let added = 0;
                    let skipped = 0;
                    let updated = 0;

                    for (const row of data) {
                        const dniValue = String(row['DNI'] || row['dni'] || '').trim();
                        
                        // Preparar solo los campos permitidos
                        const pData = {
                            dni: dniValue,
                            nombre: String(row['NOMBRE'] || row['nombre'] || '').toUpperCase().trim(),
                            telefono: String(row['TELEFONO'] || row['telefono'] || '').trim(),
                            familiar: String(row['FAMILIAR'] || row['familiar'] || '').toUpperCase().trim(),
                            telefonoFamiliar: String(row['TELEFONO_FAMILIAR'] || row['TELEFONOFAMILIAR'] || row['telefono_familiar'] || row['telefonofamiliar'] || '').trim(),
                            nAfiliacion: dniValue, // La afiliaci√≥n es la misma que el DNI
                            direccion: String(row['DIRECCION'] || row['DIRECCI√ìN'] || row['direccion'] || row['Direcci√≥n'] || row['direcci√≥n'] || '').trim(),
                            descripcionMunicipio: String(row['DESCRIPCION_MUNICIPIO'] || row['descripcion_municipio'] || row['DESCRIPCIONMUNICIPIO'] || row['descripcionmunicipio'] || row['MUNICIPIO'] || row['municipio'] || row['Municipio'] || '').trim(),
                            tipoAfiliado: String(row['TIPO_AFILIADO'] || row['tipo_afiliado'] || row['TIPOAFILIADO'] || row['tipoafiliado'] || row['TIPO AFILIADO'] || row['Tipo Afiliado'] || 'AFILIADO DIRECTO').toUpperCase().trim()
                        };
                        
                        // Validar que tipoAfiliado sea uno de los valores permitidos
                        const tiposPermitidos = ['JUBILADO', 'PENSIONADO', 'AFILIADO DIRECTO', 'BENEFICIARIA PADRE', 'BENEFICIARIA(O) COMPA√ëERA(O)', 'BENEFICIARIA(O) ESPOSA(O)', 'BENEFICIARIA(O) HIJO(A)'];
                        if (!tiposPermitidos.includes(pData.tipoAfiliado)) {
                            pData.tipoAfiliado = 'AFILIADO DIRECTO';
                        }

                        if (!pData.dni) continue;

                        const existingPatient = patients.find(p => p.dni === pData.dni);

                        if (existingPatient) {
                            let needsUpdate = false;
                            const updates = {};
                            
                            // Solo actualizar campos permitidos
                            const allowedFields = ['nombre', 'telefono', 'familiar', 'telefonoFamiliar', 'nAfiliacion', 'direccion', 'descripcionMunicipio', 'tipoAfiliado'];
                            const checkAndFill = (field) => {
                                if (!allowedFields.includes(field)) return; // Solo campos permitidos
                                
                                const dbValue = existingPatient[field];
                                const excelValue = pData[field];
                                if ((!dbValue || dbValue.trim() === '') && (excelValue && excelValue.trim() !== '')) {
                                    updates[field] = excelValue;
                                    needsUpdate = true;
                                } else if (excelValue && excelValue.trim() !== '' && dbValue !== excelValue) {
                                    updates[field] = excelValue;
                                    needsUpdate = true;
                                }
                            };
                            checkAndFill('nombre'); 
                            checkAndFill('telefono'); 
                            checkAndFill('familiar'); 
                            checkAndFill('telefonoFamiliar');
                            checkAndFill('direccion');
                            checkAndFill('descripcionMunicipio');
                            checkAndFill('tipoAfiliado');
                            
                            // Actualizar afiliaci√≥n siempre para asegurar que sea igual a DNI
                            if (pData.nAfiliacion && pData.nAfiliacion !== existingPatient.nAfiliacion) {
                                updates.nAfiliacion = pData.nAfiliacion;
                                needsUpdate = true;
                            }

                            if (needsUpdate) { 
                                await onUpdatePatient(existingPatient.id, updates); 
                                patientCache.clearPatientCache(existingPatient.id);
                                updated++; 
                            } else { skipped++; }
                        } else {
                            // Agregar nuevo paciente solo con campos permitidos
                            const result = await onAddPatient(pData);
                            patientCache.clearPatientCache();
                            added++;
                        }
                    }
                    
                    // Recargar SOLO la p√°gina actual (50) para ahorrar lecturas
                    await loadPatients(currentPage, true);
                    
                    alert(`Resumen de Carga:\n\n‚úÖ Pacientes Agregados: ${added}\nüîÑ Pacientes Modificados: ${updated}\n‚è≠Ô∏è Pacientes Omitidos: ${skipped}`);
                };
                reader.readAsBinaryString(file);
                e.target.value = null; 
            };

            const handlePatientSubmit = async (e) => { 
                e.preventDefault(); 
                try {
                    // Preparar solo los campos permitidos
                    const formData = {
                        dni: patientForm.dni || '',
                        nombre: patientForm.nombre || '',
                        telefono: patientForm.telefono || '',
                        familiar: patientForm.familiar || '',
                        telefonoFamiliar: patientForm.telefonoFamiliar || '',
                        nAfiliacion: patientForm.dni || patientForm.nAfiliacion || '', // Siempre igual a DNI
                        agenteContactCenter: patientForm.agenteContactCenter || '',
                        usuarioRevisionAsignacion: patientForm.usuarioRevisionAsignacion || '',
                        direccion: patientForm.direccion || '',
                        descripcionMunicipio: patientForm.descripcionMunicipio || '',
                        tipoAfiliado: patientForm.tipoAfiliado || 'AFILIADO DIRECTO'
                    };
                    
                    if (editingPatientId) {
                        await onUpdatePatient(editingPatientId, formData); 
                        patientCache.clearPatientCache(editingPatientId);
                    } else {
                        const created = await onAddPatient(formData);
                        patientCache.clearPatientCache();
                        // Al guardar manualmente: seleccionar paciente y abrir formulario de kits
                        const newId = (created && (created.id || created)) ? (created.id || created) : null;
                        closePatientForm();
                        if (newId) {
                            setSearchTerm('');
                            setCurrentPage(1);
                            setSelectedPatient({ id: newId, dni: formData.dni, nombre: formData.nombre, tipoAfiliado: 'AFILIADO DIRECTO' });
                            await loadPatientFullData(newId); // 1 lectura + en vivo (onSnapshot) solo para ese paciente
                            openNewKit();
                            return;
                        }
                    }
                    // Recargar SOLO la p√°gina actual (50) para ahorrar lecturas
                    await loadPatients(currentPage, true);
                    closePatientForm();
                } catch (error) {
                    alert('Error al guardar paciente: ' + error.message);
                }
            };
            
            const closePatientForm = () => { 
                setPatientForm({ 
                    dni: '', 
                    nombre: '', 
                    telefono: '', 
                    familiar: '', 
                    telefonoFamiliar: '', 
                    nAfiliacion: '',
                    agenteContactCenter: '',
                    usuarioRevisionAsignacion: '',
                    direccion: '',
                    descripcionMunicipio: '',
                    tipoAfiliado: 'AFILIADO DIRECTO'
                }); 
                setEditingPatientId(null); 
                setShowPatientForm(false); 
            };
            
            const openEditPatient = async (e, p) => { 
                e.stopPropagation();
                if (!canCreatePatients) {
                    alert('Solo el administrador puede editar la informaci√≥n general del paciente.');
                    return;
                }
                try {
                    const cachedPatient = patientCache.getPatient(p.id);
                    let patientData;
                    if (cachedPatient) {
                        patientData = cachedPatient;
                    } else {
                        if (!firebaseInitialized || !db) {
                            throw new Error("Base de datos no disponible");
                        }
                        const patientDoc = await db.collection('prod_patients').doc(p.id).get();
                        if (patientDoc.exists) {
                            patientData = { id: p.id, ...patientDoc.data() };
                        } else {
                            patientData = p;
                        }
                    }
                    // Asegurar que nAfiliacion est√© sincronizado con DNI
                    if (!patientData.nAfiliacion && patientData.dni) {
                        patientData.nAfiliacion = patientData.dni;
                    }
                    // Cargar solo los campos visibles en el formulario, pero mantener todos los datos del paciente
                    setPatientForm({
                        dni: patientData.dni || '',
                        nombre: patientData.nombre || '',
                        telefono: patientData.telefono || '',
                        familiar: patientData.familiar || '',
                        telefonoFamiliar: patientData.telefonoFamiliar || '',
                        nAfiliacion: patientData.nAfiliacion || patientData.dni || '',
                        agenteContactCenter: patientData.agenteContactCenter || '',
                        usuarioRevisionAsignacion: patientData.usuarioRevisionAsignacion || '',
                        direccion: patientData.direccion || '',
                        descripcionMunicipio: patientData.descripcionMunicipio || '',
                        tipoAfiliado: patientData.tipoAfiliado || 'AFILIADO DIRECTO'
                    });
                } catch (error) {
                    console.error("Error cargando paciente:", error);
                    const patientData = p;
                    setPatientForm({
                        dni: patientData.dni || '',
                        nombre: patientData.nombre || '',
                        telefono: patientData.telefono || '',
                        familiar: patientData.familiar || '',
                        telefonoFamiliar: patientData.telefonoFamiliar || '',
                        nAfiliacion: patientData.nAfiliacion || patientData.dni || ''
                    });
                }
                setEditingPatientId(p.id); 
                setShowPatientForm(true); 
            };

            const handleKitSubmit = async (e) => {
                e.preventDefault();
                if (isViewMode) { closeKitForm(); return; } 
                
                const patientForCheck = selectedPatientFullData || selectedPatient;
                if (canCreateKits && !editingKitId && !canCreateKitForPatient(patientForCheck)) {
                    alert('No puede crear kit para este paciente: no est√° asignado a su usuario. Solo puede crear kits para sus asignados o para pacientes de usuarios con trabajo compartido activado.');
                    return;
                }
                
                // Validar que medicamentos con dispensar === false tengan observaciones
                const medicamentosSinDispensar = (kitData.medicamentos || []).filter(m => m.dispensar === false);
                if (medicamentosSinDispensar.length > 0) {
                    const sinObservaciones = medicamentosSinDispensar.filter(m => !m.observaciones || !m.observaciones.trim());
                    if (sinObservaciones.length > 0) {
                        const nombres = sinObservaciones.map(m => m.nombre || 'Sin nombre').join(', ');
                        alert(`No se puede guardar el kit. Los siguientes medicamentos marcados como "No va" requieren una explicaci√≥n obligatoria:\n\n${nombres}\n\nPor favor, ingrese las observaciones explicando por qu√© no se dispensan estos medicamentos.`);
                        return;
                    }
                }
                
                try {
                    let finalData = { 
                        ...kitData, 
                        digitador: currentUser.name, 
                        dni: selectedPatient.dni, 
                        nombre: selectedPatient.nombre,
                        patientId: selectedPatient.id
                    }; 
                    
                    if (isRevAsigFormView) {
                        if (!(kitData.deliveryMode === 'ventanilla' || kitData.deliveryMode === 'ruta')) {
                            alert('Seleccione Ventanilla o Ruta antes de guardar.');
                            return;
                        }
                        if (!editingKitId) {
                            if (!finalData.fechaArmado) finalData.fechaArmado = new Date().toISOString().split('T')[0];
                            if (!finalData.horaOperaciones) finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        }
                        const m = finalData.medicamentos || [];
                        const total = m.length;
                        const dispensados = m.filter(x => x.dispensar !== false).length;
                        finalData.triggerMeds = total ? `${dispensados}/${total}` : '';
                        if (kitData.deliveryMode === 'ventanilla') {
                            finalData.recetaImpresa = true;
                            finalData.fechaImpresionReceta = new Date().toISOString().split('T')[0];
                        }
                    } else if (isCCFormView) {
                        if (!(kitData.deliveryMode === 'ventanilla' || kitData.deliveryMode === 'ruta')) {
                            alert('Confirme Ventanilla o Ruta antes de guardar.');
                            return;
                        }
                        finalData.phoneHighlight = kitData.tipoTelefonoCC === 'personal' ? 'personal' : kitData.tipoTelefonoCC === 'familiar' ? 'familiar' : '';
                        finalData.direccionEntrega = kitData.esUbicacionPrincipal ? (selectedPatientFullData?.direccion || selectedPatient?.direccion || '').trim() : (kitData.direccionAlternativa || '').trim();
                        finalData.observationsEnabled = !!kitData.observacionesEntregaEnabled || kitData.tipoTelefonoCC === 'otro';
                        finalData.observations = kitData.observacionesEntrega || '';
                        const yaConfirmado = !!kitData.confirmadoPorContactCenter;
                        if (!yaConfirmado) {
                            finalData.confirmadoPorContactCenter = true;
                            finalData.fechaConfirmacionContactCenter = new Date().toISOString().split('T')[0];
                        }
                        const ccFieldsEdit = ['deliveryMode','fechaEntregaKit','tipoTelefonoCC','phoneHighlight','esUbicacionPrincipal','direccionAlternativa','direccionEntrega','observacionesEntregaEnabled','observacionesEntrega','observationsEnabled','observations','gpsStatus','gpsValue','observacionesRegresoEnabled','observacionesRegresoFarmacia'];
                        const ccFieldsFirstConfirm = [...ccFieldsEdit, 'confirmadoPorContactCenter', 'fechaConfirmacionContactCenter'];
                        const ccFields = yaConfirmado ? ccFieldsEdit : ccFieldsFirstConfirm;
                        const filtered = {};
                        ccFields.forEach(f => { if (finalData[f] !== undefined) filtered[f] = finalData[f]; });
                        if (yaConfirmado) {
                            finalData = filtered;
                        } else {
                            finalData = { ...filtered, digitador: finalData.digitador, dni: finalData.dni, nombre: finalData.nombre, patientId: finalData.patientId, medicamentos: finalData.medicamentos };
                        }
                    } else if (isDespachoFormView) {
                        const m = kitData.medicamentos || [];
                        const total = m.length;
                        const dispensados = m.filter(x => x.dispensar !== false).length;
                        finalData = {
                            medicamentos: kitData.medicamentos,
                            triggerMeds: total ? `${dispensados}/${total}` : '',
                            digitador: kitData.digitador || currentUser.name,
                            dni: selectedPatient.dni,
                            nombre: selectedPatient.nombre,
                            patientId: selectedPatient.id
                        };
                    } else {
                        if (!editingKitId && !finalData.horaOperaciones) {
                            finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
                        }
                        if (editingKitId) {
                            const allowed = editableFieldsForSubmit();
                            if (allowed) {
                                if (allowed.size === 0) {
                                    alert('No tiene permiso para editar ning√∫n apartado de este kit.');
                                    return;
                                }
                                const filtered = {};
                                allowed.forEach(f => { if (finalData[f] !== undefined) filtered[f] = finalData[f]; });
                                finalData = filtered;
                            }
                            if (finalData.confirmadoPorContactCenter) {
                                finalData.fechaConfirmacionContactCenter = new Date().toISOString().split('T')[0];
                            }
                        }
                    }
                    
                    const kitId = await onSaveKit(editingKitId, finalData, selectedPatient.id, !!editingKitId);
                    
                    patientCache.clearPatientCache(selectedPatient.id);
                    patientCache.clearCache(patientCache.KITS_CACHE_KEY);
                    
                    if (editingKitId) {
                        ['ventanilla', 'ruta', 'refri'].forEach(mode => {
                            localStorage.removeItem(`vineta_${editingKitId}_${mode}`);
                        });
                    }
                    
                    if (isCCFormView && !finalData.devueltoPorContactCenter) {
                        if (!!kitData.confirmadoPorContactCenter) {
                            alert('Kit actualizado. Los cambios se reflejan en todos los departamentos del flujo.');
                            closeKitForm();
                            return;
                        }
                        setKitData(prev => ({ ...prev, confirmadoPorContactCenter: true }));
                        return;
                    }
                    if (isRevAsigFormView && editingKitId && kitData.devueltoPorContactCenter) {
                        setShowMarcarImpresoYDespacho(true);
                        return;
                    }
                    if (isDespachoFormView) {
                        closeKitForm();
                        return;
                    }
                    closeKitForm();
                } catch (error) {
                    alert('Error al guardar kit: ' + error.message);
                }
            };

            const handleMarcarImpresoYDespacho = async () => {
                if (!editingKitId || !selectedPatient) return;
                try {
                    const m = kitData.medicamentos || [];
                    const total = m.length;
                    const dispensados = m.filter(x => x.dispensar !== false).length;
                    const triggerMeds = total ? `${dispensados}/${total}` : '';
                    const today = new Date().toISOString().split('T')[0];
                    const payload = {
                        recetaImpresa: true,
                        fechaImpresionReceta: today,
                        medicamentos: kitData.medicamentos,
                        triggerMeds,
                        digitador: currentUser.name,
                        dni: selectedPatient.dni,
                        nombre: selectedPatient.nombre,
                        patientId: selectedPatient.id
                    };
                    await onSaveKit(editingKitId, payload, selectedPatient.id, true);
                    patientCache.clearPatientCache(selectedPatient.id);
                    patientCache.clearCache(patientCache.KITS_CACHE_KEY);
                    setShowMarcarImpresoYDespacho(false);
                    closeKitForm();
                } catch (e) {
                    alert('Error: ' + (e?.message || e));
                }
            };

            const handleRegresarARevisionAsignacion = async () => {
                if (!editingKitId || !selectedPatient) return;
                try {
                    const dirEntrega = kitData.esUbicacionPrincipal ? (selectedPatientFullData?.direccion || selectedPatient?.direccion || '').trim() : (kitData.direccionAlternativa || '').trim();
                    const obsEn = !!kitData.observacionesEntregaEnabled || kitData.tipoTelefonoCC === 'otro';
                    const obs = kitData.observacionesEntrega || '';
                    const payload = {
                        ...kitData,
                        devueltoPorContactCenter: true,
                        phoneHighlight: kitData.tipoTelefonoCC === 'personal' ? 'personal' : kitData.tipoTelefonoCC === 'familiar' ? 'familiar' : '',
                        direccionEntrega: dirEntrega,
                        observationsEnabled: obsEn,
                        observations: obs
                    };
                    const ccFields = ['devueltoPorContactCenter','deliveryMode','fechaEntregaKit','tipoTelefonoCC','phoneHighlight','esUbicacionPrincipal','direccionAlternativa','direccionEntrega','observacionesEntregaEnabled','observacionesEntrega','observationsEnabled','observations','gpsStatus','gpsValue','observacionesRegresoEnabled','observacionesRegresoFarmacia','confirmadoPorContactCenter','fechaConfirmacionContactCenter'];
                    const filtered = {};
                    ccFields.forEach(f => { if (payload[f] !== undefined) filtered[f] = payload[f]; });
                    const finalData = { ...filtered, digitador: currentUser.name, dni: selectedPatient.dni, nombre: selectedPatient.nombre, patientId: selectedPatient.id, medicamentos: kitData.medicamentos };
                    await onSaveKit(editingKitId, finalData, selectedPatient.id, true);
                    patientCache.clearPatientCache(selectedPatient.id);
                    patientCache.clearCache(patientCache.KITS_CACHE_KEY);
                    closeKitForm();
                } catch (e) {
                    alert('Error al regresar kit: ' + e.message);
                }
            };
            
            const closeKitForm = () => { 
                setKitData({ 
                    fechaArmado: new Date().toISOString().split('T')[0], 
                    fechaEntregaLogistica: '', 
                    fechaEntregaKit: '', 
                    horaOperaciones: '', 
                    contactCenter: '', 
                    triggerMeds: '', 
                    medicamentos: [],
                    digitador: '',
                    deliveryMode: '', 
                    phoneHighlight: '',
                    direccionEntrega: '',
                    gpsStatus: 'SIN GPS',
                    gpsValue: '',
                    observationsEnabled: false,
                    observations: '',
                    isRefrigerated: false, 
                    cantRefriGlobal: '',
                    recetaImpresa: false,
                    devueltoPorContactCenter: false,
                    confirmadoPorContactCenter: false,
                    observacionesCalidad: '',
                    observacionesDelivery: '',
                    observacionesContactCenter: '',
                    tipoTelefonoCC: '', 
                    esUbicacionPrincipal: true, 
                    direccionAlternativa: '', 
                    observacionesEntregaEnabled: false, 
                    observacionesEntrega: '', 
                    observacionesRegresoEnabled: false, 
                    observacionesRegresoFarmacia: ''
                }); 
                setEditingKitId(null); 
                setShowKitForm(false); 
                setIsViewMode(false);
                setShowMarcarImpresoYDespacho(false);
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };
            
            const openNewKit = () => {
                setKitData({ 
                    fechaArmado: new Date().toISOString().split('T')[0], 
                    fechaEntregaLogistica: '', 
                    fechaEntregaKit: '', 
                    horaOperaciones: '', 
                    contactCenter: '', 
                    triggerMeds: '', 
                    medicamentos: [],
                    digitador: currentUser.name,
                    deliveryMode: '', 
                    phoneHighlight: '',
                    direccionEntrega: '',
                    gpsStatus: 'SIN GPS',
                    gpsValue: '',
                    observationsEnabled: false,
                    observations: '',
                    isRefrigerated: false, 
                    cantRefriGlobal: '',
                    recetaImpresa: false,
                    devueltoPorContactCenter: false,
                    observacionesCalidad: '',
                    observacionesDelivery: '',
                    observacionesContactCenter: '',
                    confirmadoPorContactCenter: false,
                    tipoTelefonoCC: '', 
                    esUbicacionPrincipal: true, 
                    direccionAlternativa: '', 
                    observacionesEntregaEnabled: false, 
                    observacionesEntrega: '', 
                    observacionesRegresoEnabled: false, 
                    observacionesRegresoFarmacia: ''
                });
                setIsViewMode(false);
                setShowKitForm(true);
            };
            
            const openEditKit = (k, viewOnly = false) => { 
                const meds = (k.medicamentos || []).map(m => ({
                    ...m,
                    dispensar: m.dispensar !== false,
                    observaciones: m.observaciones || '',
                    recetaFisicaVerificada: !!m.recetaFisicaVerificada
                }));
                const pt = patients.find(p => p.id === k.patientId) || selectedPatient;
                const tc = k.tipoTelefonoCC || (k.phoneHighlight === 'personal' ? 'personal' : k.phoneHighlight === 'familiar' ? 'familiar' : 'ninguno');
                const mainAddr = (pt?.direccion || '').trim();
                const kitAddr = (k.direccionEntrega || '').trim();
                const esMain = k.esUbicacionPrincipal !== false && (!kitAddr || kitAddr === mainAddr);
                setKitData({
                    ...k,
                    medicamentos: meds,
                    phoneHighlight: k.phoneHighlight || '',
                    direccionEntrega: k.direccionEntrega || '',
                    gpsValue: k.gpsValue || '',
                    recetaImpresa: !!k.recetaImpresa,
                    devueltoPorContactCenter: !!k.devueltoPorContactCenter,
                    confirmadoPorContactCenter: !!k.confirmadoPorContactCenter,
                    observacionesCalidad: k.observacionesCalidad || '',
                    observacionesDelivery: k.observacionesDelivery || '',
                    observacionesContactCenter: k.observacionesContactCenter || '',
                    tipoTelefonoCC: tc,
                    esUbicacionPrincipal: esMain,
                    direccionAlternativa: k.direccionAlternativa || (esMain ? '' : kitAddr),
                    observacionesEntregaEnabled: !!k.observacionesEntregaEnabled || !!k.observationsEnabled,
                    observacionesEntrega: k.observacionesEntrega || k.observations || '',
                    observacionesRegresoEnabled: !!k.observacionesRegresoEnabled,
                    observacionesRegresoFarmacia: k.observacionesRegresoFarmacia || ''
                }); 
                setEditingKitId(k.id); 
                setIsViewMode(viewOnly);
                setShowKitForm(true); 
            };

            const addMedRow = () => {
                const base = kitData.medicamentos || [];
                setKitData({
                    ...kitData,
                    medicamentos: [...base, { nombre: '', idReceta: '', cantidad: '', cantRefri: '', dispensar: true, observaciones: '' }]
                });
            };

            const removeMedRow = (idx) => {
                const next = (kitData.medicamentos || []).filter((_, i) => i !== idx);
                setKitData({ ...kitData, medicamentos: next });
            };

            const handleMedChange = (idx, field, val) => {
                const v = (field === 'nombre' || field === 'observaciones' || field === 'idReceta') ? toUpper(val) : val;
                const newMeds = [...kitData.medicamentos];
                newMeds[idx] = { ...newMeds[idx], [field]: v };
                setKitData({...kitData, medicamentos: newMeds});
            };
            
            const handleTriggerMeds = (val) => {
                // Preservar el formato de texto completo (ej: "8/10", "6/9", "5")
                // Extraer el n√∫mero de la parte izquierda (antes del "/") para crear las l√≠neas
                let count = 0;
                if (val && val.trim()) {
                    // Si tiene "/", tomar la parte izquierda; si no, tomar el n√∫mero completo
                    const parts = String(val).split('/');
                    const leftPart = parts[0].trim();
                    const parsed = parseInt(leftPart, 10);
                    count = isNaN(parsed) ? 0 : parsed;
                }
                
                const safeCount = Math.min(Math.max(count, 0), 30);
                const currentMeds = kitData.medicamentos || [];
                let newMeds = [];
                
                // Siempre crear las l√≠neas seg√∫n el n√∫mero extra√≠do
                if (safeCount > 0) {
                    if (safeCount > currentMeds.length) {
                        // Agregar l√≠neas faltantes
                        newMeds = [...currentMeds, ...Array(safeCount - currentMeds.length).fill({ nombre: '', idReceta: '', cantidad: '', cantRefri: '' })];
                    } else if (safeCount < currentMeds.length) {
                        // Reducir l√≠neas si el n√∫mero es menor
                        newMeds = currentMeds.slice(0, safeCount);
                    } else {
                        // Mismo n√∫mero, mantener l√≠neas actuales
                        newMeds = currentMeds;
                    }
                } else {
                    // Si el n√∫mero es 0, limpiar las l√≠neas
                    newMeds = [];
                }
                
                // Guardar el valor de texto completo (preservando formato como "8/10")
                setKitData({...kitData, triggerMeds: val, medicamentos: newMeds});
            };

            const setPhoneHighlight = (type) => {
                setKitData({...kitData, phoneHighlight: type});
            };

            const handleBackToList = () => {
                setSelectedPatient(null);
                setSelectedPatientFullData(null);
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };

            const handleEnviarAContactCenter = async (kit) => {
                const p = selectedPatientFullData || selectedPatient;
                const agente = (p?.agenteContactCenter || '').trim();
                if (!agente) {
                    alert('Este paciente no tiene usuario de Contact Center asignado. Asigne uno desde la ficha del paciente.');
                    return;
                }
                try {
                    await onSaveKit(kit.id, { contactCenter: agente }, kit.patientId, true);
                    patientCache.clearPatientCache(kit.patientId);
                    patientCache.clearCache(patientCache.KITS_CACHE_KEY);
                } catch (e) {
                    alert('Error al enviar a Contact Center: ' + (e?.message || e));
                }
            };

            // Funci√≥n para imprimir vi√±eta
            const handlePrintVineta = (kit) => {
                // Actualizar kitData con los valores del kit actual para que los botones se habiliten correctamente
                // Si kit ya tiene deliveryMode e isRefrigerated, usarlos; si no, usar los valores de kitData actual
                const updatedKitData = {
                    ...kitData,
                    deliveryMode: kit.deliveryMode || kitData.deliveryMode || '',
                    isRefrigerated: kit.isRefrigerated !== undefined ? kit.isRefrigerated : (kitData.isRefrigerated || false),
                    cantRefriGlobal: kit.cantRefriGlobal || kitData.cantRefriGlobal || '',
                    cantRefrigerados: (kit.isRefrigerated || kitData.isRefrigerated) ? (kit.cantRefriGlobal || kitData.cantRefriGlobal || 1) : 0
                };
                
                setKitData(updatedKitData);
                
                // Filtrar plantillas seg√∫n el tipo de kit
                let availableTemplates = printTemplates;
                
                const deliveryMode = kit.deliveryMode || kitData.deliveryMode;
                const isRefrigerated = kit.isRefrigerated !== undefined ? kit.isRefrigerated : (kitData.isRefrigerated || false);
                
                if (deliveryMode === 'ruta') {
                    availableTemplates = printTemplates.filter(t => t.type === 'ruta');
                } else if (deliveryMode === 'ventanilla') {
                    availableTemplates = printTemplates.filter(t => t.type === 'ventanilla');
                }
                
                if (isRefrigerated) {
                    availableTemplates = printTemplates.filter(t => t.type === 'refrigerado');
                }
                
                setSelectedPrintTemplate(availableTemplates[0] || null);
                setShowPrintModal(true);
            };

            // Funci√≥n para generar contenido de impresi√≥n (con may√∫sculas y bindings correctos)
            const generatePrintContent = (kit, template) => {
                if (!template) return '';
                
                // Preparar datos en may√∫sculas
                const data = {
                    derechohabienteNombre: (kit.nombre || selectedPatientFullData?.nombre || '').toUpperCase(),
                    derechohabienteId: (kit.dni || selectedPatientFullData?.dni || '').toUpperCase(),
                    telefonoPrincipal: (selectedPatientFullData?.telefono || '').toUpperCase(),
                    telefonoRef: (selectedPatientFullData?.telefonoRef || '').toUpperCase(),
                    gpsStatus: (kit.gpsStatus || 'SIN GPS').toUpperCase(), // Literal: GPS, SIN GPS, GPS PENDIENTE
                    numMedicamentos: kit.medicamentos?.length || 0,
                    direccion: (selectedPatientFullData?.direccion || '').toUpperCase(),
                    observacionesEntrega: (kit.observations || kit.observacionesEntrega || '').toUpperCase(),
                    observacionesVentanilla: (kit.observacionesVentanilla || kit.observations || '').toUpperCase(),
                    fechaEntrega: (kit.fechaArmado || '').toUpperCase(),
                    refrigerado: kit.isRefrigerated ? 'S√ç' : 'NO',
                    cantRefrigerados: kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    contactoTexto: (kit.contactCenter || '').toUpperCase(),
                    digitador: (kit.digitador || '').toUpperCase(),
                    extraRutaTitulo: 'EXTRA RUTA',
                    extraRutaContenido: ''
                };
                
                // Reemplazar campos en los elementos
                const elementsWithData = template.elements.map(element => {
                    let content = element.content || '';
                    
                    // Reemplazar campos din√°micos
                    if (element.isField) {
                        switch(element.fieldId) {
                            case 'nombre':
                                content = data.derechohabienteNombre;
                                break;
                            case 'dni':
                                content = data.derechohabienteId;
                                break;
                            case 'direccion':
                                content = data.direccion;
                                break;
                            case 'telefono':
                                content = data.telefonoPrincipal;
                                break;
                            case 'telefonoRef':
                                content = data.telefonoRef;
                                break;
                            case 'fechaArmado':
                                content = data.fechaEntrega;
                                break;
                            case 'digitador':
                                content = data.digitador;
                                break;
                            case 'contactCenter':
                                content = data.contactoTexto;
                                break;
                            case 'gpsStatus':
                                content = data.gpsStatus; // Literal: GPS, SIN GPS, GPS PENDIENTE
                                break;
                            case 'cantMedicamentos':
                                content = data.numMedicamentos;
                                break;
                            case 'cantRefrigerados':
                                content = data.cantRefrigerados;
                                break;
                            case 'observaciones':
                                // Si es RUTA: observacionesEntrega, si es VENTANILLA: observacionesVentanilla
                                if (template.type === 'ruta') {
                                    content = data.observacionesEntrega;
                                } else if (template.type === 'ventanilla') {
                                    content = data.observacionesVentanilla;
                                } else {
                                    content = data.observacionesEntrega;
                                }
                                break;
                            case 'direccion':
                                // Solo mostrar direcci√≥n si es RUTA
                                if (template.type === 'ruta') {
                                    content = data.direccion;
                                } else {
                                    content = '';
                                }
                                break;
                            default:
                                content = element.content || '';
                        }
                    }
                    
                    // Aplicar may√∫sculas a todo el contenido
                    if (typeof content === 'string') {
                        content = content.toUpperCase();
                    }
                    
                    return {
                        ...element,
                        content: content.toString()
                    };
                });
                
                // Generar HTML para impresi√≥n (71mm x 210mm horizontal, m√°rgenes laterales 0.1cm)
                return `
                    <div class="print-area print-horizontal relative" style="
                        width: 210mm; 
                        height: 71mm; 
                        margin-left: 0.1cm; 
                        margin-right: 0.1cm;
                        font-family: Arial, sans-serif;
                        text-transform: uppercase;
                        position: relative;
                    ">
                        ${elementsWithData.map(element => {
                            // Ajustar tama√±o de fuente para legibilidad (campo grande)
                            let fontSize = element.fontSize || 12;
                            if (element.fieldId === 'direccion' || element.fieldId === 'observaciones') {
                                // Auto-ajustar entre 10px y 18px seg√∫n el tama√±o del contenedor
                                const containerHeight = element.height || 30;
                                fontSize = Math.max(10, Math.min(18, containerHeight * 0.4));
                            }
                            
                            return `
                            <div style="
                                position: absolute;
                                left: ${element.x}px;
                                top: ${element.y}px;
                                width: ${element.width || 'auto'}px;
                                height: ${element.height || 'auto'}px;
                                font-size: ${fontSize}px;
                                color: ${element.color || '#000000'};
                                font-family: ${element.fontFamily || 'Arial'};
                                font-weight: ${element.bold ? 'bold' : 'normal'};
                                font-style: ${element.italic ? 'italic' : 'normal'};
                                background-color: ${element.type === 'rectangle' ? element.color : 'transparent'};
                                border: ${element.type === 'line' ? `2px solid ${element.color}` : 
                                       element.type === 'rectangle' ? `${element.borderWidth || 1}px solid ${element.borderColor || '#000000'}` : 'none'};
                                display: flex;
                                align-items: center;
                                justify-content: ${element.align || 'left'};
                                text-transform: uppercase;
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                                white-space: pre-wrap;
                                overflow: hidden;
                            ">
                                ${element.type === 'text' ? element.content : ''}
                                ${element.type === 'barcode' ? `<div style="background: white; padding: 5px; text-align: center; width: 100%;">[C√ìDIGO DE BARRAS]<br/><small>${element.content}</small></div>` : ''}
                                ${element.type === 'qrcode' ? `<div style="background: white; padding: 5px; text-align: center; width: 100%;">[QR CODE]<br/><small>${element.content}</small></div>` : ''}
                                ${element.type === 'image' && element.url ? `<img src="${element.url}" alt="${element.alt}" style="max-width: 100%; max-height: 100%;">` : ''}
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            };

            // Funci√≥n helper para escapar HTML
            const escapeHtml = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            // Funci√≥n helper para auto-ajustar texto
            const autoFitText = (element, maxPx = 18, minPx = 8) => {
                if (!element) return;
                const container = element;
                const text = container.textContent || '';
                if (!text.trim()) return;
                
                let fontSize = maxPx;
                container.style.fontSize = fontSize + 'px';
                
                while (container.scrollHeight > container.clientHeight && fontSize > minPx) {
                    fontSize -= 0.5;
                    container.style.fontSize = fontSize + 'px';
                }
            };

            // Helper para construir ventana de impresi√≥n usando iframe (evita bloqueos de popups)
            const buildPrintWindow = (html, css, title = 'Imprimir Vi√±eta', onAfterPrintClose = true) => {
                let printWindow = null;
                let iframe = null;
                
                // Usar iframe directamente para evitar bloqueos de ventanas emergentes
                try {
                    iframe = document.createElement('iframe');
                    iframe.style.position = 'fixed';
                    iframe.style.right = '0';
                    iframe.style.bottom = '0';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = 'none';
                    document.body.appendChild(iframe);
                    printWindow = iframe.contentWindow;
                } catch (e) {
                    console.error('Error creando iframe:', e);
                }
                
                if (!printWindow) {
                    alert('No se pudo crear la ventana de impresi√≥n.');
                    return null;
                }

                // Construir HTML usando concatenaci√≥n (evita problemas con Babel)
                const escapedTitle = escapeHtml(title);
                const fullHtml = '<!DOCTYPE html>' +
'<html>' +
'<head>' +
'<meta charset="UTF-8">' +
'<title>' + escapedTitle + '</title>' +
'<style>' + css + '</style>' +
'</head>' +
'<body>' +
html +
'</body>' +
'</html>';

                try {
                    printWindow.document.open();
                    printWindow.document.write(fullHtml);
                    printWindow.document.close();
                } catch (e) {
                    console.error('Error escribiendo en ventana:', e);
                    alert('Error al preparar la impresi√≥n: ' + e.message);
                    return null;
                }

                // Bandera para evitar doble impresi√≥n
                let hasPrinted = false;
                const doPrint = () => {
                    if (hasPrinted || !iframe || !iframe.parentNode) return;
                    hasPrinted = true;
                    try {
                        if (printWindow) {
                            printWindow.focus();
                            printWindow.print();
                        }
                        if (onAfterPrintClose) {
                            setTimeout(() => {
                                try {
                                    if (iframe && iframe.parentNode) {
                                        document.body.removeChild(iframe);
                                    }
                                } catch (e) {
                                    console.error('Error eliminando iframe:', e);
                                }
                            }, 2000);
                        }
                    } catch (e) {
                        console.error('Error imprimiendo:', e);
                    }
                };

                // Disparar impresi√≥n desde el iframe
                setTimeout(doPrint, 500);

                return printWindow;
            };

            // URLs de logos
            const LOGO1_URL = 'https://raw.githubusercontent.com/jose50440/bita/6a46e7144ce075c219a382364b611fa576fc5e4b/img/logo1.png';
            const LOGO2_URL = 'https://raw.githubusercontent.com/jose50440/bita/6a46e7144ce075c219a382364b611fa576fc5e4b/img/logo2.png';

            // SISTEMA DE PLANTILLAS RUTA DESDE EXCEL (rutaTemplateCurrent / loadRutaTemplateCurrent en App)

            const fitText = (element, wMm, hMm, maxFont = 12, minFont = 7) => {
                if (!element) return;
                let fontSize = maxFont;
                element.style.fontSize = fontSize + 'pt';
                while (element.scrollHeight > (hMm * 2.83465) && fontSize > minFont) { // mm to pt conversion
                    fontSize -= 0.5;
                    element.style.fontSize = fontSize + 'pt';
                }
            };

            // Helpers para inputs
            const toDateInputValue = (dateValue) => {
                if (!dateValue) return '';
                if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) return dateValue;
                try {
                    const d = new Date(dateValue);
                    if (isNaN(d.getTime())) return '';
                    return d.toISOString().split('T')[0];
                } catch {
                    return '';
                }
            };
            const safeNumber = (value) => {
                if (value === null || value === undefined || value === '') return '';
                const num = Number(value);
                return isNaN(num) ? '' : num;
            };
            const toUpper = (v) => (v != null && v !== '' ? String(v).toUpperCase() : v);

            // CSS para vi√±eta horizontal (RUTA) - 210mm x 71mm estructura tipo Excel
            const getPrintVignetteCSSHorizontal = () => `
                @page { 
                    size: 210mm 71mm landscape; 
                    margin: 1mm; 
                }
                * { 
                    margin: 0; 
                    padding: 0; 
                    box-sizing: border-box; 
                }
                html, body { 
                    width: 210mm; 
                    height: 71mm; 
                    margin: 0; 
                    padding: 0; 
                    font-family: 'Arial', 'Helvetica', sans-serif;
                    text-transform: uppercase;
                }
                .sheet { 
                    box-sizing: border-box; 
                    width: 210mm; 
                    height: 71mm; 
                    padding: 0.5mm; 
                    overflow: hidden;
                    background: #ffffff;
                    position: relative;
                }
                .excel-table {
                    width: 100%;
                    height: 100%;
                    border-collapse: collapse;
                    table-layout: fixed;
                    font-size: 1.5mm;
                }
                .excel-table td {
                    border: 0.5px solid #000000;
                    padding: 0.2mm 0.4mm;
                    vertical-align: middle;
                    text-align: left;
                    font-weight: 900;
                    color: #000000;
                    overflow: hidden;
                    word-wrap: break-word;
                    background: #ffffff;
                }
                .excel-table .cell-empty {
                    border: none;
                    background: transparent;
                }
                .excel-table .cell-label {
                    font-size: 1.4mm;
                    font-weight: 900;
                    text-align: left;
                }
                .excel-table .cell-title {
                    font-size: 2mm;
                    font-weight: 900;
                    text-align: center;
                    border-bottom: 0.5px solid #000000;
                }
                .excel-table .cell-data {
                    font-size: 1.8mm;
                    font-weight: 900;
                    text-align: left;
                }
                .excel-table .cell-data-large {
                    font-size: 2.5mm;
                    font-weight: 900;
                    text-align: left;
                }
                .excel-table .cell-address {
                    font-size: 1.6mm;
                    font-weight: 900;
                    line-height: 1.3;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                .excel-table .cell-auto-fit {
                    font-size: 1.6mm;
                    font-weight: 900;
                    line-height: 1.3;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                .excel-table .cell-center {
                    text-align: center;
                }
                .excel-table .cell-footer {
                    font-size: 1.5mm;
                    font-weight: 900;
                    text-align: center;
                }
                .excel-table .cell-gps {
                    font-size: 1.4mm;
                    font-weight: 900;
                    text-align: center;
                }
                .excel-table .cell-gps.has-gps {
                    background: #000000;
                    color: #ffffff;
                }
                .excel-table .cell-logos {
                    text-align: right;
                    vertical-align: bottom;
                    padding: 0.5mm;
                }
                .excel-table .cell-logo {
                    height: 8mm;
                    width: auto;
                    max-width: 18mm;
                    object-fit: contain;
                    display: inline-block;
                    margin-left: 1mm;
                }
                .excel-table .cell-qr {
                    text-align: center;
                    vertical-align: middle;
                    padding: 0.3mm;
                }
                .excel-table .cell-qr img {
                    max-width: 100%;
                    max-height: 100%;
                    width: auto;
                    height: auto;
                    display: block;
                    margin: 0 auto;
                }
                /* Fila 1: T√≠tulo Principal (B1:G1) */
                .cell-title {
                    grid-column: 2 / 8;
                    grid-row: 1;
                    font-size: 2.2mm;
                    font-weight: 900;
                    text-align: center;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-bottom: 0.3mm solid #000000;
                    padding: 0.3mm;
                    letter-spacing: 0.1mm;
                }
                /* Fila 2: Informaci√≥n de Derechohabiente (B2:D2) */
                .cell-label-info {
                    grid-column: 2 / 5;
                    grid-row: 2;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                    border-bottom: 0.2mm dotted #000000;
                }
                /* Fila 3: Nombre del Derechohabiente (B3:D3) */
                .cell-label-nombre {
                    grid-column: 2 / 5;
                    grid-row: 3;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                }
                /* Filas 4-5: Nombre del Paciente (B4:D5 combinadas) */
                .cell-nombre {
                    grid-column: 2 / 5;
                    grid-row: 4 / 6;
                    border: 0.4mm solid #000000;
                    border-radius: 0.5mm;
                    padding: 0.6mm;
                    font-size: 3mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    word-wrap: break-word;
                    overflow: hidden;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                /* Fila 7: ID del Derechohabiente (B7:D7) */
                .cell-label-dni {
                    grid-column: 2 / 5;
                    grid-row: 7;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                    border-top: 0.2mm solid #000000;
                }
                /* Filas 8-9: DNI del Paciente (B8:D9 combinadas) */
                .cell-dni {
                    grid-column: 2 / 5;
                    grid-row: 8 / 10;
                    border: 0.4mm solid #000000;
                    border-radius: 0.5mm;
                    padding: 0.6mm;
                    font-size: 3mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    word-wrap: break-word;
                    overflow: hidden;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                /* Fila 10: Tel√©fono Contacto y # Medicamentos */
                .cell-label-tel {
                    grid-column: 2 / 4;
                    grid-row: 10;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                }
                .cell-gps-indicator {
                    grid-column: 4 / 5;
                    grid-row: 10;
                    font-size: 1.5mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border: 0.3mm solid #000000;
                    border-radius: 0.3mm;
                    padding: 0.2mm;
                }
                .cell-gps-indicator.has-gps {
                    background: #000000;
                    color: #ffffff;
                }
                .cell-label-meds {
                    grid-column: 5 / 6;
                    grid-row: 10;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                }
                .cell-meds-value {
                    grid-column: 6 / 7;
                    grid-row: 10;
                    border: 0.4mm solid #000000;
                    border-radius: 0.3mm;
                    padding: 0.4mm;
                    font-size: 2mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                /* Filas 11-12: Tel√©fonos (B11:B12) y Cantidad Meds (C12:D12) */
                .cell-telefonos {
                    grid-column: 2 / 4;
                    grid-row: 11 / 13;
                    border: 0.4mm solid #000000;
                    border-radius: 0.5mm;
                    padding: 0.6mm;
                    font-size: 2.2mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    word-wrap: break-word;
                    overflow: hidden;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                .cell-meds-cant {
                    grid-column: 4 / 5;
                    grid-row: 12;
                    border: 0.4mm solid #000000;
                    border-radius: 0.3mm;
                    padding: 0.4mm;
                    font-size: 2mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                /* Fila 14: Contactanos y Fecha de Entrega */
                .cell-label-contact {
                    grid-column: 2 / 4;
                    grid-row: 14;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                }
                .cell-contact-value {
                    grid-column: 4 / 7;
                    grid-row: 14 / 16;
                    border: 0.4mm solid #000000;
                    border-radius: 0.5mm;
                    padding: 0.6mm;
                    font-size: 2mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    word-wrap: break-word;
                    overflow: hidden;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                .cell-label-fecha {
                    grid-column: 7 / 9;
                    grid-row: 14;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    padding-left: 0.5mm;
                }
                .cell-fecha-value {
                    grid-column: 9 / 10;
                    grid-row: 14;
                    border: 0.4mm solid #000000;
                    border-radius: 0.3mm;
                    padding: 0.4mm;
                    font-size: 2mm;
                    font-weight: 900;
                    color: #000000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                /* Fila 16: Pie de p√°gina DIGITADO (A16:F16) */
                .cell-footer {
                    grid-column: 1 / 7;
                    grid-row: 16;
                    font-size: 1.6mm;
                    font-weight: 900;
                    color: #000000;
                    text-align: center;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                /* Secci√≥n Derecha: Direcci√≥n, Logos y Observaciones (E2:I13) */
                .cell-address-container {
                    grid-column: 5 / 10;
                    grid-row: 2 / 14;
                    border: 0.4mm solid #000000;
                    border-radius: 0.5mm;
                    padding: 0.6mm;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                    background: #ffffff;
                    position: relative;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                .cell-address-text {
                    font-size: 2.2mm;
                    font-weight: 900;
                    color: #000000;
                    line-height: 1.4;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                    flex: 1;
                    overflow: hidden;
                    padding-bottom: 0.5mm;
                }
                .cell-logos {
                    display: flex;
                    align-items: flex-end;
                    justify-content: flex-end;
                    gap: 1.5mm;
                    margin-top: auto;
                    padding-top: 0.5mm;
                    border-top: 0.2mm solid #000000;
                }
                .cell-logo {
                    height: 9mm;
                    width: auto;
                    max-width: 20mm;
                    object-fit: contain;
                    display: block;
                }
                /* QR Code (H14:I16) */
                .cell-qr {
                    grid-column: 8 / 10;
                    grid-row: 14 / 17;
                    border: 0.4mm solid #000000;
                    border-radius: 0.3mm;
                    padding: 0.4mm;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #ffffff;
                    box-shadow: inset 0 0 0.2mm rgba(0,0,0,0.1);
                }
                .cell-qr img {
                    max-width: 100%;
                    max-height: 100%;
                    width: auto;
                    height: auto;
                    display: block;
                }
                @media print { 
                    body * { visibility: hidden; } 
                    .sheet, .sheet * { visibility: visible; } 
                    .sheet { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                    } 
                }
            `;

            // CSS para vi√±eta vertical (VENTANILLA)
            const getPrintVignetteCSSVertical = () => `
                @page { 
                    size: 71mm 210mm; 
                    margin: 0; 
                }
                * { 
                    margin: 0; 
                    padding: 0; 
                    box-sizing: border-box; 
                }
                html, body { 
                    width: 71mm; 
                    height: 210mm; 
                    margin: 0; 
                    padding: 0; 
                    font-family: 'Segoe UI', Arial, sans-serif;
                    text-transform: uppercase;
                }
                .sheet { 
                    box-sizing: border-box; 
                    width: 71mm; 
                    height: 210mm; 
                    padding: 0.8mm 0.5mm; 
                    overflow: hidden;
                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
                    position: relative;
                    display: flex;
                    flex-direction: column;
                }
                .header { 
                    display: flex; 
                    flex-direction: column;
                    align-items: center; 
                    margin-bottom: 0.8mm; 
                    padding-bottom: 0.4mm;
                    border-bottom: 0.4mm solid #1a1a1a;
                }
                .header-logos {
                    display: flex;
                    justify-content: center;
                    gap: 2mm;
                    margin-bottom: 0.4mm;
                }
                .header-logo { 
                    width: 12mm; 
                    height: 7mm; 
                    object-fit: contain;
                }
                .header-title { 
                    font-size: 2.2mm; 
                    font-weight: 700; 
                    text-align: center; 
                    color: #1a1a1a;
                    letter-spacing: 0.05mm;
                    line-height: 1.3;
                }
                .banner { 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: #fff; 
                    padding: 1.2mm 0; 
                    text-align: center; 
                    font-weight: 700; 
                    font-size: 4.5mm; 
                    margin: 0.8mm 0;
                    border-radius: 1mm;
                    box-shadow: 0 0.2mm 0.5mm rgba(0,0,0,0.2);
                    letter-spacing: 0.2mm;
                }
                .section { 
                    border: 0.6mm solid #2c3e50; 
                    border-radius: 1.5mm; 
                    padding: 1.2mm; 
                    margin: 0.4mm 0;
                    background: #ffffff;
                    box-shadow: 0 0.2mm 0.5mm rgba(0,0,0,0.1);
                }
                .section-title { 
                    font-size: 2.4mm; 
                    font-weight: 700; 
                    margin-bottom: 0.6mm;
                    border-bottom: 0.25mm solid #3498db;
                    padding-bottom: 0.4mm;
                    color: #2c3e50;
                    letter-spacing: 0.05mm;
                }
                .field-row { 
                    display: flex; 
                    flex-direction: column;
                    gap: 0.3mm; 
                    margin: 0.4mm 0;
                }
                .field-label { 
                    font-size: 2mm; 
                    font-weight: 600; 
                    color: #34495e;
                }
                .field-value { 
                    font-size: 2.6mm; 
                    color: #1a1a1a;
                    word-wrap: break-word;
                }
                .field-value-large { 
                    font-size: 3.8mm; 
                    font-weight: 700;
                    color: #1a1a1a;
                    letter-spacing: 0.1mm;
                }
                .field-value-extra-large { 
                    font-size: 5mm; 
                    font-weight: 800;
                    color: #1a1a1a;
                    letter-spacing: 0.1mm;
                    line-height: 1.2;
                }
                .dashed-box { 
                    border: 0.8mm dashed #667eea; 
                    border-radius: 2mm; 
                    padding: 3mm 2mm; 
                    text-align: center; 
                    font-size: 10mm; 
                    font-weight: 800;
                    margin: 1.5mm 0;
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: #fff;
                    box-shadow: 0 0.3mm 0.8mm rgba(0,0,0,0.2);
                    letter-spacing: 0.3mm;
                }
                .refrigerado-box { 
                    border: 0.6mm dashed #16a085; 
                    border-radius: 1.5mm; 
                    padding: 0.8mm 1.5mm; 
                    margin-top: 0.6mm;
                    font-size: 2.4mm;
                    background: #ecf8f6;
                    font-weight: 600;
                    color: #138d75;
                }
                .footer { 
                    margin-top: auto; 
                    padding-top: 0.6mm;
                    font-size: 1.5mm; 
                    text-align: center; 
                    color: #7f8c8d;
                    font-weight: 500;
                    border-top: 0.2mm solid #ecf0f1;
                }
                .cantidad-box {
                    border: 0.8mm solid #1a1a1a;
                    border-radius: 2mm;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 16mm;
                    font-weight: 900;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: #fff;
                    box-shadow: 0 0.3mm 0.8mm rgba(0,0,0,0.3);
                    letter-spacing: 0.2mm;
                }
                @media print { 
                    body * { visibility: hidden; } 
                    .sheet, .sheet * { visibility: visible; } 
                    .sheet { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                    } 
                }
            `;

            // CSS espec√≠fico para vi√±eta REFRIGERADO (71mm x 180mm)
            const getPrintVignetteCSSRefrigerado = () => `
                @page { 
                    size: 71mm 180mm; 
                    margin: 0; 
                }
                * { 
                    margin: 0; 
                    padding: 0; 
                    box-sizing: border-box; 
                }
                html, body { 
                    width: 71mm; 
                    height: 180mm; 
                    margin: 0; 
                    padding: 0; 
                    font-family: 'Segoe UI', Arial, sans-serif;
                    text-transform: uppercase;
                }
                .sheet { 
                    box-sizing: border-box; 
                    width: 71mm; 
                    height: 180mm; 
                    padding: 1mm 0.8mm; 
                    overflow: hidden;
                    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                }
                .header { 
                    display: flex; 
                    flex-direction: column;
                    align-items: center; 
                    margin-bottom: 1mm; 
                    padding-bottom: 0.6mm;
                    border-bottom: 0.5mm solid #1a1a1a;
                }
                .header-logos {
                    display: flex;
                    justify-content: center;
                    gap: 3mm;
                    margin-bottom: 0.6mm;
                }
                .header-logo { 
                    width: 20mm; 
                    height: 12mm; 
                    object-fit: contain;
                }
                .header-title { 
                    font-size: 2.5mm; 
                    font-weight: 900; 
                    text-align: center; 
                    color: #000000;
                    letter-spacing: 0.08mm;
                    line-height: 1.3;
                }
                .banner { 
                    background: #ffffff;
                    color: #000000; 
                    padding: 1.5mm 0; 
                    text-align: center; 
                    font-weight: 900; 
                    font-size: 5.5mm; 
                    margin: 1mm 0;
                    border-radius: 1.5mm;
                    box-shadow: 0 0.3mm 0.8mm rgba(0,0,0,0.3);
                    letter-spacing: 0.3mm;
                    border: 0.8mm solid #000000;
                }
                .info-box {
                    border: 0.8mm solid #000000;
                    border-radius: 2.5mm;
                    padding: 1.5mm;
                    margin: 0.6mm 0;
                    background: #ffffff;
                    box-shadow: 0 0.4mm 1mm rgba(0, 0, 0, 0.2);
                    display: flex;
                    flex-direction: column;
                }
                .info-box-title {
                    font-size: 2.2mm;
                    font-weight: 900;
                    color: #000000;
                    margin-bottom: 0.8mm;
                    text-align: center;
                    border-bottom: 0.4mm solid #000000;
                    padding-bottom: 0.5mm;
                    letter-spacing: 0.1mm;
                }
                .info-box-content {
                    font-size: 5.5mm;
                    font-weight: 900;
                    color: #000000;
                    text-align: center;
                    line-height: 1.2;
                    letter-spacing: 0.15mm;
                    word-wrap: break-word;
                    padding: 0.5mm 0;
                }
                .info-box-content-large {
                    font-size: 7mm;
                    font-weight: 900;
                    color: #000000;
                    text-align: center;
                    line-height: 1.2;
                    letter-spacing: 0.2mm;
                    word-wrap: break-word;
                    padding: 0.5mm 0;
                }
                .info-box-content-date {
                    font-size: 4.5mm;
                    font-weight: 900;
                    color: #000000;
                    text-align: center;
                    line-height: 1.2;
                    letter-spacing: 0.1mm;
                    padding: 0.5mm 0;
                }
                .section { 
                    border: 0.7mm solid #2c3e50; 
                    border-radius: 2mm; 
                    padding: 2mm; 
                    margin: 0.8mm 0;
                    background: #ffffff;
                    box-shadow: 0 0.3mm 0.8mm rgba(0,0,0,0.15);
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                }
                .field-row { 
                    display: flex; 
                    flex-direction: column;
                    gap: 0.5mm; 
                    margin: 1mm 0;
                }
                .field-label { 
                    font-size: 2.8mm; 
                    font-weight: 900; 
                    color: #000000;
                    margin-bottom: 0.3mm;
                }
                .field-value { 
                    font-size: 4.5mm; 
                    color: #000000;
                    word-wrap: break-word;
                    font-weight: 900;
                }
                .field-value-large { 
                    font-size: 6.5mm; 
                    font-weight: 900;
                    color: #000000;
                    letter-spacing: 0.15mm;
                    line-height: 1.2;
                }
                .field-value-extra-large { 
                    font-size: 8mm; 
                    font-weight: 900;
                    color: #000000;
                    letter-spacing: 0.2mm;
                    line-height: 1.2;
                }
                .footer { 
                    margin-top: 1mm;
                    padding-top: 0.8mm;
                    font-size: 2mm; 
                    text-align: center; 
                    color: #000000;
                    font-weight: 900;
                    border-top: 0.3mm solid #000000;
                }
                .cantidad-box {
                    border: 1.5mm solid #000000;
                    border-radius: 3.5mm;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24mm;
                    font-weight: 900;
                    background: #ffffff;
                    color: #000000;
                    box-shadow: 0 0.6mm 1.5mm rgba(0, 0, 0, 0.3);
                    letter-spacing: 0.4mm;
                    min-height: 28mm;
                    width: 100%;
                }
                .cantidad-label {
                    font-size: 3.8mm;
                    font-weight: 900;
                    color: #000000;
                    text-align: center;
                    margin-bottom: 1.2mm;
                    letter-spacing: 0.2mm;
                }
                .info-grid {
                    display: flex;
                    flex-direction: column;
                    gap: 0.6mm;
                    margin: 0.8mm 0;
                }
                @media print { 
                    body * { visibility: hidden; } 
                    .sheet, .sheet * { visibility: visible; } 
                    .sheet { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                    } 
                }
            `;

            // CSS vi√±eta VENTANILLA ‚Äî 71mm x 145mm vertical, m√°rgenes 10mm arriba/abajo
            const getPrintVignetteCSSVentanilla = () => `
                @page { size: 71mm 145mm; margin: 10mm 0; }
                * { margin: 0; padding: 0; box-sizing: border-box; }
                html, body { width: 71mm; min-height: 125mm; height: 125mm; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, Helvetica, sans-serif; text-transform: uppercase; background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                .sheet { width: 71mm; min-height: 125mm; height: 125mm; padding: 0.8mm 0.9mm; overflow: hidden; background: #fff; position: relative; display: flex; flex-direction: column; gap: 1.1mm; }
                .v-logos-row { display: flex; align-items: center; justify-content: space-between; padding: 0.8mm 0.9mm; margin: 0; border: 0.4mm solid #000; border-radius: 2.5mm; background: #fff; }
                .v-logo { width: 32mm; height: 15mm; object-fit: contain; flex-shrink: 0; }
                .v-title-full { font-size: 2.9mm; font-weight: 800; text-align: center; color: #000; line-height: 1.25; letter-spacing: 0.06mm; padding: 0.9mm 0.8mm; margin: 0; border: 0.4mm solid #000; border-radius: 2.5mm; background: #f9f9f9; }
                .v-box { border: 0.4mm solid #000; border-radius: 2.5mm; padding: 0.7mm 0.9mm; margin: 0; }
                .v-name-box { font-family: 'Segoe UI', Arial Black, Arial, sans-serif; font-size: 7.5mm; font-weight: 900; color: #000; line-height: 1.15; letter-spacing: 0.08mm; word-wrap: break-word; text-align: center; background: #fafafa; }
                .v-dni-box { font-family: 'Segoe UI', Arial Black, Arial, sans-serif; font-size: 7.5mm; font-weight: 900; color: #000; line-height: 1.15; letter-spacing: 0.06mm; word-wrap: break-word; text-align: center; background: #fafafa; display: flex; flex-direction: column; gap: 0.3mm; }
                .v-dni-box .v-dni-head { display: flex; align-items: center; justify-content: center; gap: 0.5mm; }
                .v-dni-box .v-dni-label { font-size: 2mm; font-weight: 800; }
                .v-fecha-box, .v-cc-box { display: flex; flex-direction: column; gap: 0.25mm; }
                .v-fecha-box, .v-cc-box { align-items: center; text-align: center; }
                .v-fecha-box .v-box-head, .v-cc-box .v-box-head { justify-content: center; }
                .v-fecha-box .v-box-label, .v-cc-box .v-box-label { font-size: 1.8mm; font-weight: 800; color: #000; }
                .v-fecha-box .v-box-value { font-size: 4.2mm; font-weight: 700; color: #000; word-wrap: break-word; line-height: 1.15; text-align: center; }
                .v-cc-box .v-box-value { font-size: 3mm; font-weight: 700; color: #000; word-wrap: break-word; line-height: 1.15; text-align: center; }
                .v-fecha-box .v-box-head, .v-cc-box .v-box-head { display: flex; align-items: center; gap: 0.5mm; }
                .v-meds { display: flex; align-items: center; justify-content: center; gap: 0.7mm; font-size: 6mm; font-weight: 900; color: #000; }
                .v-meds .v-icon { width: 5mm; height: 5mm; flex-shrink: 0; stroke-width: 1.75; color: #000; }
                .v-refri { display: flex; align-items: center; justify-content: center; gap: 0.7mm; padding: 0.6mm 0.8mm; border: 0.4mm solid #000; border-radius: 2.5mm; margin: 0; background: #fff3cd; font-size: 2.8mm; font-weight: 900; }
                .v-refri-icon { width: 4mm; height: 4mm; flex-shrink: 0; stroke-width: 1.75; color: #000; }
                .v-ventanilla { border: 1.2mm solid #000; padding: 2mm 1.4mm; text-align: center; font-size: 7.5mm; font-weight: 900; color: #000; margin: 0; letter-spacing: 0.2mm; background: linear-gradient(to bottom, #f5f5f5 0%, #e8e8e8 100%); display: flex; align-items: center; justify-content: center; gap: 1.2mm; border-radius: 2.5mm; flex-shrink: 0; }
                .v-ventanilla.has-obs { padding: 1.4mm 1.2mm; font-size: 6mm; margin: 0; }
                .v-ventanilla .v-icon { width: 6mm; height: 6mm; margin: 0; }
                .v-ventanilla.has-obs .v-icon { width: 5mm; height: 5mm; }
                .v-obs { font-size: 1.8mm; font-weight: 700; color: #000; line-height: 1.3; word-wrap: break-word; padding: 0.7mm 0.9mm; margin: 0; border: 0.4mm solid #000; border-radius: 2.5mm; background: #fafafa; text-align: center; }
                .v-footer { margin-top: auto; padding: 2mm 1.2mm; font-size: 4.8mm; text-align: center; color: #000; font-weight: 700; border: 0.5mm solid #000; border-radius: 2.5mm; letter-spacing: 0.05mm; line-height: 1.3; }
                .v-icon { width: 3.5mm; height: 3.5mm; flex-shrink: 0; stroke-width: 1.75; color: #000; }
                @media print { body * { visibility: hidden; } .sheet, .sheet * { visibility: visible; } .sheet { position: absolute; left: 0; top: 0; } }
            `;

            // ============================================
            // M√ìDULO QR LOCAL - GENERACI√ìN OFFLINE
            // ============================================
            /**
             * Utilidades para generar QR √∫nico ligado a gpsValue
             * Formato payload: IHSS|KIT=<kitId>|GPS=<gpsValue>|DNI=<dni>|TS=<timestamp>|SIG=<hash>
             */
            // Definir QRUtils de forma m√°s directa y robusta
            (function() {
                'use strict';
                
                try {
                    console.log('[QR] Iniciando carga del m√≥dulo QRUtils...');
                    
                    // Definir el m√≥dulo
                    const QRUtilsModule = (function() {
                        'use strict';
                        
                        /**
                         * Genera hash SHA-256 de un string
                         * @param {string} str - String a hashear
                         * @returns {Promise<string>} Hash hexadecimal
                         */
                        function sha256(str) {
                            if (!str) return Promise.resolve('');
                            return new Promise(function(resolve, reject) {
                                try {
                                    if (typeof crypto !== 'undefined' && crypto.subtle && crypto.subtle.digest) {
                                        const encoder = new TextEncoder();
                                        const data = encoder.encode(str);
                                        crypto.subtle.digest('SHA-256', data).then(function(hashBuffer) {
                                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                                            const hash = hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
                                            resolve(hash);
                                        }).catch(function(error) {
                                            console.error('[QR] Error generando SHA-256:', error);
                                            // Fallback simple si crypto.subtle falla
                                            let hash = 0;
                                            for (let i = 0; i < str.length; i++) {
                                                const char = str.charCodeAt(i);
                                                hash = ((hash << 5) - hash) + char;
                                                hash = hash & hash;
                                            }
                                            resolve(Math.abs(hash).toString(16).padStart(64, '0'));
                                        });
                                    } else {
                                        // Fallback simple si crypto.subtle no est√° disponible
                                        let hash = 0;
                                        for (let i = 0; i < str.length; i++) {
                                            const char = str.charCodeAt(i);
                                            hash = ((hash << 5) - hash) + char;
                                            hash = hash & hash;
                                        }
                                        resolve(Math.abs(hash).toString(16).padStart(64, '0'));
                                    }
                                } catch (error) {
                                    console.error('[QR] Error generando SHA-256:', error);
                                    // Fallback simple
                                    let hash = 0;
                                    for (let i = 0; i < str.length; i++) {
                                        const char = str.charCodeAt(i);
                                        hash = ((hash << 5) - hash) + char;
                                        hash = hash & hash;
                                    }
                                    resolve(Math.abs(hash).toString(16).padStart(64, '0'));
                                }
                            });
                        }
                        
                        /**
                         * Construye el payload √∫nico del QR
                         * @param {Object} params - Par√°metros del kit
                         * @param {string} params.kitId - ID del kit
                         * @param {string} params.gpsValue - Valor GPS del kit (puede estar vac√≠o)
                         * @param {string} params.dni - DNI del paciente
                         * @param {number} [params.timestamp] - Timestamp opcional (se genera si no se proporciona)
                         * @returns {Promise<string>} Payload formateado
                         */
                        function buildQrPayload(params) {
                            return new Promise(function(resolve, reject) {
                                try {
                                    var kitId = params.kitId;
                                    var gpsValue = params.gpsValue;
                                    var dni = params.dni;
                                    var timestamp = params.timestamp;
                                    
                                    // Validar y normalizar valores
                                    var kit = String(kitId || '').trim() || 'UNKNOWN';
                                    var gps = String(gpsValue || '').trim() || 'EMPTY';
                                    var dniStr = String(dni || '').trim() || 'UNKNOWN';
                                    var ts = timestamp || Date.now();
                                    
                                    // Construir string base para hash
                                    var baseString = kit + '|' + gps + '|' + dniStr + '|' + ts;
                                    
                                    // Generar hash SHA-256
                                    sha256(baseString).then(function(sig) {
                                        // Construir payload final
                                        var payload = 'IHSS|KIT=' + kit + '|GPS=' + gps + '|DNI=' + dniStr + '|TS=' + ts + '|SIG=' + sig;
                                        
                                        console.log('[QR] Payload generado:', payload.substring(0, 100) + '...');
                                        resolve(payload);
                                    }).catch(function(error) {
                                        console.error('[QR] Error generando hash:', error);
                                        // Generar payload sin hash si falla
                                        var payload = 'IHSS|KIT=' + kit + '|GPS=' + gps + '|DNI=' + dniStr + '|TS=' + ts + '|SIG=ERROR';
                                        resolve(payload);
                                    });
                                } catch (error) {
                                    console.error('[QR] Error en buildQrPayload:', error);
                                    reject(error);
                                }
                            });
                        }
                        
                        /**
                         * Genera DataURL del QR code
                         * @param {string} payload - Payload a codificar en el QR
                         * @param {Object} [options] - Opciones de generaci√≥n
                         * @param {number} [options.size=250] - Tama√±o del QR en p√≠xeles
                         * @param {number} [options.margin=2] - Margen del QR
                         * @returns {Promise<string>} DataURL del QR (PNG)
                         */
                        function generateQrDataUrl(payload, options) {
                            return new Promise(function(resolve, reject) {
                                try {
                                    if (!payload) {
                                        reject(new Error('[QR] Payload vac√≠o'));
                                        return;
                                    }
                                    
                                    options = options || {};
                                    var size = options.size || 250;
                                    var margin = options.margin || 2;
                                    var errorCorrectionLevel = options.errorCorrectionLevel || 'H';
                                    var colorDark = (options.color && options.color.dark) ? options.color.dark : '#000000';
                                    var colorLight = (options.color && options.color.light) ? options.color.light : '#FFFFFF';
                                    
                                    // Verificar que QRCode est√© disponible
                                    if (typeof QRCode === 'undefined' || typeof QRCode.toDataURL !== 'function') {
                                        reject(new Error('[QR] QRCode library no est√° disponible'));
                                        return;
                                    }
                                    
                                    QRCode.toDataURL(payload, {
                                        width: size,
                                        margin: margin,
                                        errorCorrectionLevel: errorCorrectionLevel,
                                        color: {
                                            dark: colorDark,
                                            light: colorLight
                                        }
                                    }, function(err, url) {
                                        if (err) {
                                            console.error('[QR] Error generando QR:', err);
                                            reject(err);
                                        } else if (!url || url.length === 0) {
                                            reject(new Error('[QR] QR generado vac√≠o'));
                                        } else {
                                            console.log('[QR] QR generado exitosamente');
                                            resolve(url);
                                        }
                                    });
                                } catch (error) {
                                    console.error('[QR] Excepci√≥n generando QR:', error);
                                    reject(error);
                                }
                            });
                        }
                        
                        /**
                         * Renderiza el QR en el contenedor B2
                         * @param {HTMLElement} targetEl - Elemento contenedor donde insertar el QR
                         * @param {string} dataUrl - DataURL del QR generado
                         * @param {Object} [options] - Opciones de renderizado
                         */
                        function renderQrToB2(targetEl, dataUrl, options) {
                            return new Promise(function(resolve) {
                                try {
                                    if (!targetEl) {
                                        console.error('[QR] Contenedor B2 no encontrado');
                                        resolve(false);
                                        return;
                                    }
                                    
                                    // Limpiar contenido anterior
                                    targetEl.innerHTML = '';
                                    
                                    // Crear imagen del QR
                                    var img = document.createElement('img');
                                    img.src = dataUrl;
                                    img.alt = 'QR Code';
                                    img.style.maxWidth = '100%';
                                    img.style.maxHeight = '100%';
                                    img.style.width = 'auto';
                                    img.style.height = 'auto';
                                    img.style.display = 'block';
                                    img.style.objectFit = 'contain';
                                    
                                    // Insertar en el contenedor
                                    targetEl.appendChild(img);
                                    
                                    console.log('[QR] QR renderizado exitosamente en B2');
                                    resolve(true);
                                } catch (error) {
                                    console.error('[QR] Error renderizando QR:', error);
                                    // Insertar mensaje de error sin romper la impresi√≥n
                                    if (targetEl) {
                                        targetEl.innerHTML = '<div style="font-size:2mm;color:#999;text-align:center;padding:2mm;">QR NO DISPONIBLE</div>';
                                    }
                                    resolve(false);
                                }
                            });
                        }
                        
                        // API p√∫blica
                        return {
                            sha256,
                            buildQrPayload,
                            generateQrDataUrl,
                            renderQrToB2
                        };
                    })();
                    
                    // Asignar a window de forma expl√≠cita
                    if (typeof window !== 'undefined') {
                        window.QRUtils = QRUtilsModule;
                        console.log('[QR] ‚úÖ M√≥dulo QRUtils asignado a window.QRUtils');
                        
                        // Verificar que se asign√≥ correctamente
                        if (!window.QRUtils) {
                            console.error('[QR] ‚ùå ERROR: window.QRUtils es null/undefined despu√©s de asignaci√≥n');
                        } else if (typeof window.QRUtils.buildQrPayload !== 'function') {
                            console.error('[QR] ‚ùå ERROR: window.QRUtils.buildQrPayload no es una funci√≥n. Tipo:', typeof window.QRUtils.buildQrPayload);
                        } else {
                            console.log('[QR] ‚úÖ Verificaci√≥n exitosa - window.QRUtils tiene todas las funciones');
                        }
                    } else {
                        console.error('[QR] ‚ùå ERROR: window no est√° disponible');
                    }
                } catch (error) {
                    console.error('[QR] ‚ùå ERROR al definir QRUtils:', error);
                    console.error('[QR] Stack:', error.stack);
                    // Crear un objeto stub para evitar errores
                    if (typeof window !== 'undefined') {
                        window.QRUtils = {
                            sha256: async () => '',
                            buildQrPayload: async () => { throw new Error('QRUtils no disponible - error en carga'); },
                            generateQrDataUrl: async () => { throw new Error('QRUtils no disponible - error en carga'); },
                            renderQrToB2: async () => { return false; }
                        };
                        console.log('[QR] ‚ö†Ô∏è Objeto stub creado para QRUtils');
                    }
                }
            })();
            
            // Log inmediato de verificaci√≥n (s√≠ncrono)
            console.log('[QR] Verificaci√≥n inmediata - window existe:', typeof window !== 'undefined');
            console.log('[QR] Verificaci√≥n inmediata - window.QRUtils existe:', typeof window !== 'undefined' && !!window.QRUtils);
            if (typeof window !== 'undefined' && window.QRUtils) {
                console.log('[QR] Verificaci√≥n inmediata - M√©todos disponibles:', Object.keys(window.QRUtils));
                console.log('[QR] Verificaci√≥n inmediata - buildQrPayload es funci√≥n:', typeof window.QRUtils.buildQrPayload === 'function');
            } else {
                console.error('[QR] ‚ö†Ô∏è ADVERTENCIA: window.QRUtils NO est√° disponible despu√©s de la carga');
            }
            
            // Log final de verificaci√≥n (con delay para asegurar que se ejecute despu√©s de todo)
            setTimeout(() => {
                console.log('[QR] Verificaci√≥n final (100ms) - window.QRUtils existe:', typeof window !== 'undefined' && !!window.QRUtils);
                console.log('[QR] Verificaci√≥n final (100ms) - window.QRUtils.buildQrPayload existe:', typeof window !== 'undefined' && window.QRUtils && typeof window.QRUtils.buildQrPayload === 'function');
                if (typeof window !== 'undefined' && window.QRUtils) {
                    console.log('[QR] Verificaci√≥n final (100ms) - M√©todos disponibles:', Object.keys(window.QRUtils));
                } else {
                    console.error('[QR] ‚ùå CR√çTICO: window.QRUtils NO est√° disponible despu√©s de 100ms');
                }
            }, 100);
            
            // Funci√≥n de prueba para desarrollo
            window.testQrB2 = async function() {
                try {
                    console.log('[QR TEST] Iniciando prueba...');
                    
                    // Buscar contenedor B2
                    const b2Element = document.querySelector('.ruta-b2 .ruta-qr-container') || 
                                     document.querySelector('.ruta-b2');
                    
                    if (!b2Element) {
                        console.error('[QR TEST] Contenedor B2 no encontrado');
                        return;
                    }
                    
                    console.log('[QR TEST] Contenedor B2 encontrado:', b2Element);
                    
                    // Verificar que QRUtils est√© disponible
                    const QRUtils = window.QRUtils;
                    if (!QRUtils) {
                        console.error('[QR TEST] QRUtils no est√° disponible');
                        return;
                    }
                    
                    // Generar payload de prueba
                    const payload = await QRUtils.buildQrPayload({
                        kitId: 'TEST-KIT-123',
                        gpsValue: '14.0583,-87.2164',
                        dni: '0801199012345',
                        timestamp: Date.now()
                    });
                    
                    console.log('[QR TEST] Payload:', payload);
                    
                    // Generar QR
                    const dataUrl = await QRUtils.generateQrDataUrl(payload, {
                        size: 250,
                        margin: 2,
                        errorCorrectionLevel: 'H'
                    });
                    
                    console.log('[QR TEST] QR generado:', dataUrl.substring(0, 50) + '...');
                    
                    // Renderizar
                    const success = await QRUtils.renderQrToB2(b2Element, dataUrl);
                    
                    if (success) {
                        console.log('[QR TEST] ‚úÖ OK en B2');
                    } else {
                        console.error('[QR TEST] ‚ùå Error renderizando');
                    }
                } catch (error) {
                    console.error('[QR TEST] Error:', error);
                }
            };

            // Funci√≥n para generar QR Code de geolocalizaci√≥n
            const generateGeoQR = async (gpsValue) => {
                if (!gpsValue || !String(gpsValue).trim()) {
                    console.warn('GPS Value vac√≠o o inv√°lido');
                    return null;
                }
                
                try {
                    // Parsear coordenadas del formato gpsValue (puede ser "lat,lon" o "geo:lat,lon")
                    let lat, lon;
                    const cleanValue = String(gpsValue).trim().replace(/^geo:/, '');
                    const parts = cleanValue.split(',');
                    
                    if (parts.length >= 2) {
                        lat = parseFloat(parts[0].trim());
                        lon = parseFloat(parts[1].trim());
                        
                        if (isNaN(lat) || isNaN(lon)) {
                            console.warn('Coordenadas GPS inv√°lidas (NaN):', gpsValue, 'lat:', lat, 'lon:', lon);
                            return null;
                        }
                        
                        // Validar rango de coordenadas (lat: -90 a 90, lon: -180 a 180)
                        if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                            console.warn('Coordenadas GPS fuera de rango:', lat, lon);
                            return null;
                        }
                    } else {
                        console.warn('Formato GPS inv√°lido (menos de 2 partes):', gpsValue);
                        return null;
                    }
                    
                    // Formato geo URI est√°ndar
                    const geoUri = `geo:${lat},${lon}?q=${lat},${lon}`;
                    console.log('Generando QR para URI:', geoUri);
                    
                    // Verificar que QRCode est√© disponible
                    if (typeof QRCode === 'undefined') {
                        console.error('QRCode library no est√° disponible');
                        return null;
                    }
                    
                    // Generar QR usando qrcode.js
                    return new Promise((resolve, reject) => {
                        try {
                            QRCode.toDataURL(geoUri, {
                                errorCorrectionLevel: 'M',
                                type: 'image/png',
                                width: 150,
                                margin: 1,
                                color: {
                                    dark: '#000000',
                                    light: '#FFFFFF'
                                }
                            }, (err, url) => {
                                if (err) {
                                    console.error('Error generando QR:', err);
                                    reject(err);
                                } else {
                                    console.log('QR generado exitosamente');
                                    resolve(url);
                                }
                            });
                        } catch (error) {
                            console.error('Excepci√≥n al generar QR:', error);
                            reject(error);
                        }
                    });
                } catch (error) {
                    console.error('Error procesando GPS para QR:', error);
                    return null;
                }
            };

            // Funci√≥n para generar URL de Google Maps desde coordenadas
            const generateMapsUrl = (gpsValue) => {
                if (!gpsValue || !String(gpsValue).trim()) return null;
                
                try {
                    const cleanValue = String(gpsValue).trim().replace(/^geo:/, '');
                    const parts = cleanValue.split(',');
                    
                    if (parts.length >= 2) {
                        const lat = parseFloat(parts[0].trim());
                        const lon = parseFloat(parts[1].trim());
                        
                        if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                            return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                        }
                    }
                } catch (error) {
                    console.error('Error generando URL de Maps:', error);
                }
                return null;
            };


            // Funci√≥n para imprimir vi√±eta RUTA (movida dentro de App - ver m√°s abajo)

            // Funci√≥n para imprimir vi√±eta VENTANILLA ‚Äî 71mm x 180mm, vertical, profesional
            const printVentanillaVignette = async (kit, patient) => {
                let updatedKit = kit;
                let updatedPatient = patient || selectedPatientFullData || {};
                if (kit?.id && firebaseInitialized && db) {
                    try {
                        const d = await db.collection('prod_kits').doc(kit.id).get();
                        if (d.exists) updatedKit = { id: d.id, ...d.data() };
                    } catch (e) { console.warn('Kit actualizado no disponible:', e); }
                }
                if (updatedKit?.patientId && firebaseInitialized && db) {
                    try {
                        const d = await db.collection('prod_patients').doc(updatedKit.patientId).get();
                        if (d.exists) updatedPatient = { id: d.id, ...d.data() };
                    } catch (e) { console.warn('Paciente actualizado no disponible:', e); }
                }
                const pt = updatedPatient;
                const nombre = (updatedKit.nombre || pt.nombre || '').toUpperCase();
                const dni = (updatedKit.dni || pt.dni || '').toUpperCase();
                const fechaEntrega = updatedKit.fechaArmado || '';
                const contactCenterDisplay = formatAgenteContactCenterDisplay(pt.agenteContactCenter || updatedKit.agenteContactCenter, users);
                const observaciones = (updatedKit.observations || updatedKit.observacionesEntrega || '').trim().toUpperCase();
                const usuarioOperaciones = (updatedKit.usuarioOperaciones || currentUser?.name || currentUser?.email || 'OPERADOR').toUpperCase();
                const medicamentos = updatedKit.medicamentos || [];
                const totalMeds = medicamentos.length;
                const dispensadosMeds = medicamentos.filter(m => m.dispensar !== false).length;
                const cantidadMeds = totalMeds > 0 ? `${dispensadosMeds}/${totalMeds}` : '0/0';
                const isRefrigerado = updatedKit.isRefrigerated || false;
                const cantRefri = updatedKit.cantRefriGlobal || (isRefrigerado ? 1 : 0);
                const logo1Url = LOGO1_URL || '/assets/logo1.png';
                const logo2Url = LOGO2_URL || '/assets/logo2.png';
                const logo1Src = escapeHtml(logo1Url);
                const logo2Src = escapeHtml(logo2Url);
                const obsHtml = observaciones ? '<div class="v-obs">' + escapeHtml(observaciones) + '</div>' : '';
                const hasObs = !!observaciones;
                const iconId = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>';
                const iconCalendar = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>';
                const iconPhone = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>';
                const iconWindow = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>';
                const iconMeds = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>';
                const iconRefri = '<svg class="v-refri-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
                const ventanillaClass = hasObs ? 'v-ventanilla has-obs' : 'v-ventanilla';
                const nameHtml = '<div class="v-box v-name-box">' + escapeHtml(nombre) + '</div>';
                const dniHtml = '<div class="v-box v-dni-box"><div class="v-dni-head">' + iconId + '<span class="v-dni-label">DNI / AFILIACI√ìN</span></div><div>' + escapeHtml(dni) + '</div></div>';
                const fechaHtml = '<div class="v-box v-fecha-box"><div class="v-box-head">' + iconCalendar + '<span class="v-box-label">FECHA DE ENTREGA</span></div><div class="v-box-value">' + escapeHtml(fechaEntrega) + '</div></div>';
                const ccHtml = '<div class="v-box v-cc-box"><div class="v-box-head">' + iconPhone + '<span class="v-box-label">CONTACT CENTER</span></div><div class="v-box-value">' + escapeHtml(contactCenterDisplay) + '</div></div>';
                const medsBoxHtml = '<div class="v-box v-meds">' + iconMeds + '<span>MEDICAMENTOS: ' + escapeHtml(cantidadMeds) + '</span></div>';
                const refriBoxHtml = cantRefri > 0 ? '<div class="v-refri">' + iconRefri + '<span>REFRIGERADO: ' + escapeHtml(String(cantRefri)) + '</span></div>' : '';
                const html = '<div class="sheet">' +
                    '<div class="v-logos-row">' +
                    '<img src="' + logo1Src + '" alt="Logo 1" class="v-logo" onerror="this.style.display=\'none\'"/>' +
                    '<img src="' + logo2Src + '" alt="Logo 2" class="v-logo" onerror="this.style.display=\'none\'"/>' +
                    '</div>' +
                    '<div class="v-title-full">DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO</div>' +
                    nameHtml +
                    dniHtml +
                    fechaHtml +
                    ccHtml +
                    medsBoxHtml +
                    refriBoxHtml +
                    '<div class="' + ventanillaClass + '">' + iconWindow + ' VENTANILLA</div>' +
                    obsHtml +
                    '<div class="v-footer">OPERACIONES: ' + escapeHtml(usuarioOperaciones) + '</div>' +
                    '</div>';
                buildPrintWindow(html, getPrintVignetteCSSVentanilla(), 'Imprimir Vi√±eta Ventanilla');
            };

            // Funci√≥n para imprimir vi√±eta REFRIGERADO
            const printRefrigeradoVignette = async (kit, patient) => {
                // Obtener datos actualizados de la base de datos antes de imprimir
                let updatedKit = kit;
                let updatedPatient = patient || selectedPatientFullData || {};
                
                if (kit && kit.id && firebaseInitialized && db) {
                    try {
                        const kitDoc = await db.collection('prod_kits').doc(kit.id).get();
                        if (kitDoc.exists) {
                            updatedKit = { id: kitDoc.id, ...kitDoc.data() };
                            console.log('‚úÖ Kit actualizado desde base de datos (Refrigerado):', updatedKit);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è No se pudo obtener kit actualizado, usando datos locales:', error);
                    }
                }
                
                // Obtener datos actualizados del paciente si hay patientId
                if (updatedKit && updatedKit.patientId && firebaseInitialized && db) {
                    try {
                        const patientDoc = await db.collection('prod_patients').doc(updatedKit.patientId).get();
                        if (patientDoc.exists) {
                            updatedPatient = { id: patientDoc.id, ...patientDoc.data() };
                            console.log('‚úÖ Paciente actualizado desde base de datos (Refrigerado)');
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è No se pudo obtener paciente actualizado, usando datos locales:', error);
                    }
                }
                
                const patientData = updatedPatient;
                const operatorName = currentUser?.name || currentUser?.email || auth?.currentUser?.email || 'OPERADOR';
                const printedAt = new Date().toLocaleString('es-ES', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const data = {
                    nombre: (updatedKit.nombre || patientData.nombre || '').toUpperCase(),
                    dni: (updatedKit.dni || patientData.dni || '').toUpperCase(),
                    fechaEntrega: updatedKit.fechaArmado || '',
                    cantRefrigerados: updatedKit.isRefrigerated ? (updatedKit.cantRefriGlobal || 1) : 0,
                    operatorName: operatorName.toUpperCase(),
                    printedAt: printedAt.toUpperCase()
                };
                
                // Asegurar URLs de logos bien formadas (usar rutas absolutas si son locales)
                const logo1Url = LOGO1_URL || '/assets/logo1.png';
                const logo2Url = LOGO2_URL || '/assets/logo2.png';
                
                // Construir URLs de logos de forma segura
                const logo1Src = escapeHtml(logo1Url);
                const logo2Src = escapeHtml(logo2Url);
                
                // Construir HTML usando concatenaci√≥n (evita problemas con Babel y template literals)
                const html = '<div class="sheet">' +
'<div class="header">' +
'<div class="header-logos">' +
'<img src="' + logo1Src + '" alt="Logo 1" class="header-logo" onerror="this.style.display=\'none\'"/>' +
'<img src="' + logo2Src + '" alt="Logo 2" class="header-logo" onerror="this.style.display=\'none\'"/>' +
'</div>' +
'<div class="header-title">DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO</div>' +
'</div>' +
'<div class="banner">‚ùÑ PRODUCTO REFRIGERADO ‚ùÑ</div>' +
'<div class="info-grid">' +
'<div class="info-box">' +
'<div class="info-box-title">NOMBRE COMPLETO</div>' +
'<div class="info-box-content-large">' + escapeHtml(data.nombre) + '</div>' +
'</div>' +
'<div class="info-box">' +
'<div class="info-box-title">DNI / AFILIACI√ìN</div>' +
'<div class="info-box-content">' + escapeHtml(data.dni) + '</div>' +
'</div>' +
'<div class="info-box">' +
'<div class="info-box-title">FECHA DESPACHO</div>' +
'<div class="info-box-content-date">' + escapeHtml(data.fechaEntrega) + '</div>' +
'</div>' +
'<div style="margin-top: 1mm;">' +
'<div class="cantidad-label">CANTIDAD DE REFRIGERADOS</div>' +
'<div class="cantidad-box">' + escapeHtml(data.cantRefrigerados) + '</div>' +
'</div>' +
'</div>' +
'<div class="footer">OP: ' + escapeHtml(data.operatorName) + ' | ' + escapeHtml(data.printedAt) + '</div>' +
'</div>';
                
                buildPrintWindow(html, getPrintVignetteCSSRefrigerado(), 'Imprimir Vi√±eta Refrigerado');
            };

            // Funci√≥n para imprimir (mantener compatibilidad)
            const handlePrint = (kit, templateOverride = null) => {
                const template = templateOverride || selectedPrintTemplate;
                if (!template) {
                    alert('No hay plantilla seleccionada');
                    return;
                }
                
                const printContent = generatePrintContent(kit, template);
                
                // Usar iframe directamente para evitar bloqueos de ventanas emergentes
                let printWindow = null;
                let iframe = null;
                try {
                    iframe = document.createElement('iframe');
                    iframe.style.position = 'fixed';
                    iframe.style.right = '0';
                    iframe.style.bottom = '0';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = 'none';
                    document.body.appendChild(iframe);
                    printWindow = iframe.contentWindow;
                    
                    if (!printWindow) {
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                        throw new Error('No se pudo crear ventana de impresi√≥n.');
                    }
                } catch (error) {
                    console.error('Error creando iframe de impresi√≥n:', error);
                    alert('No se pudo crear la ventana de impresi√≥n.');
                    return;
                }
                
                const kitNombre = escapeHtml(kit.nombre || 'Vi√±eta');
                
                // HTML base SIN interpolar printContent (evita errores de Babel con template literals)
                const printHtmlBase = '<!DOCTYPE html>' +
                    '<html>' +
                    '<head>' +
                    '<meta charset="UTF-8">' +
                    '<title>Imprimir Vi√±eta - ' + kitNombre + '</title>' +
                    '<style>' +
                    '@page { size: 210mm 71mm landscape; margin: 0.1cm; }' +
                    'html, body { width: 210mm; height: 71mm; margin: 0; padding: 0; overflow: visible; }' +
                    '* { -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing: border-box; text-transform: uppercase; }' +
                    '.print-area { width: 210mm; height: 71mm; position: relative; overflow: visible; }' +
                    '@media print { ' +
                    '  body * { visibility: hidden; } ' +
                    '  .print-area, .print-area * { visibility: visible; } ' +
                    '  .print-area { position: absolute; left: 0; top: 0; padding: 0; margin: 0; } ' +
                    '}' +
                    '</style>' +
                    '</head>' +
                    '<body>' +
                    '<div id="print-root" class="print-area"></div>' +
                    '</body>' +
                    '</html>';
                
                try {
                    // Escribir HTML base en la ventana
                    printWindow.document.open();
                    printWindow.document.write(printHtmlBase);
                    printWindow.document.close();
                    
                    // Bandera para evitar doble impresi√≥n
                    let hasPrinted = false;
                    const doPrint = () => {
                        if (hasPrinted || !iframe || !iframe.parentNode) return;
                        hasPrinted = true;
                        try {
                            const printRoot = printWindow.document.getElementById('print-root');
                            if (printRoot) {
                                printRoot.innerHTML = printContent;
                                
                                // Disparar impresi√≥n desde el iframe
                                if (printWindow) {
                                    printWindow.focus();
                                    setTimeout(function() {
                                        if (printWindow) {
                                            printWindow.print();
                                            // Remover iframe despu√©s de imprimir
                                            setTimeout(function() {
                                                if (iframe && iframe.parentNode) {
                                                    document.body.removeChild(iframe);
                                                }
                                            }, 2000);
                                        }
                                    }, 250);
                                }
                            } else {
                                console.error('No se encontr√≥ #print-root en el documento');
                                alert('Error: No se pudo encontrar el contenedor de impresi√≥n');
                            }
                        } catch (error) {
                            console.error('Error inyectando contenido o imprimiendo:', error);
                            alert('Error al preparar la impresi√≥n: ' + error.message);
                        }
                    };
                    
                    // Esperar a que el DOM est√© listo antes de inyectar contenido
                    setTimeout(doPrint, 100);
                } catch (error) {
                    console.error('Error escribiendo en la ventana de impresi√≥n:', error);
                    alert('Error al abrir la ventana de impresi√≥n: ' + error.message);
                    if (iframe && iframe.parentNode) {
                        try {
                            document.body.removeChild(iframe);
                        } catch (e) {
                            // Ignorar errores al eliminar iframe
                        }
                    }
                }
            };

            if (loadingPatients) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                        <div className="flex-1 flex items-center justify-center">
                            <div className="text-center">
                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-turquoise-600 mb-4"></div>
                                <h3 className="text-lg font-bold text-slate-700 mb-2">Cargando pacientes...</h3>
                                <p className="text-sm text-slate-500 mb-4">Optimizando datos para mejor rendimiento</p>
                                <div className="w-64 bg-slate-200 rounded-full h-2 mx-auto">
                                    <div 
                                        className="bg-turquoise-600 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${loadingProgress}%` }}
                                    ></div>
                                </div>
                                <p className="text-xs text-slate-400 mt-2">{loadingProgress}% completado</p>
                            </div>
                        </div>
                    </div>
                );
            }


            if (selectedPatient) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft h-full flex flex-col animate-in border-0 bg-white">
                        
                        <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                        
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={handleBackToList} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect">
                                    <Icons.ArrowLeft size={20} />
                                </button>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 brand-font leading-none">{selectedPatient.nombre}</h3>
                                    <p className="text-[10px] text-slate-400 font-mono mt-0.5">DNI: {selectedPatient.dni}</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                {canCreateKits && !folderSoloLectura && (() => {
                                    const patientForCheck = selectedPatientFullData || selectedPatient;
                                    const allowed = canCreateKitForPatient(patientForCheck);
                                    return (
                                        <button 
                                            onClick={allowed ? openNewKit : () => alert('No puede crear kit para este paciente: no est√° asignado a su usuario. El admin debe activar trabajo compartido para el usuario que no asisti√≥.')} 
                                            className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect ${allowed ? 'bg-turquoise-600 hover:bg-turquoise-700 text-white' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}
                                            title={allowed ? 'Crear nuevo kit' : 'Solo puede crear kits para sus asignados o para pacientes de usuarios con trabajo compartido'}
                                        >
                                            <Icons.FolderPlus size={16}/> Nuevo Kit
                                        </button>
                                    );
                                })()}
                                {folderSoloLectura && <span className="text-xs text-amber-600 font-semibold px-3 py-2 bg-amber-50 rounded-xl">Solo visualizaci√≥n ‚Äî active Trabajo compartido para este usuario</span>}
                            </div>
                        </div>

                        {/* Modal para imprimir */}
                        <Modal isOpen={showPrintModal} onClose={() => setShowPrintModal(false)} title="Imprimir Vi√±eta" maxWidth="max-w-md">
                            <div className="space-y-4">
                                {!kitData.deliveryMode && (
                                    <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                                        Seleccione modo de env√≠o en el Kit (Ruta o Ventanilla)
                                    </div>
                                )}
                                
                                {/* Bot√≥n para cargar plantillas predeterminadas si no existen */}
                                {(printTemplates.length === 0 || !printTemplates.find(t => t.id === 'plantilla_ruta')) && (
                                    <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <p className="text-xs text-blue-800 mb-2">No se encontraron plantillas. Cargue las plantillas predeterminadas:</p>
                                        <button
                                            onClick={loadPredeterminedTemplatesFromPatientBlock}
                                            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-xs flex items-center justify-center gap-2"
                                        >
                                            <Icons.FolderPlus size={16}/> Cargar Plantillas Predeterminadas
                                        </button>
                                    </div>
                                )}
                                
                                <div className="space-y-2">
                                    <button
                                        onClick={() => {
                                            printRutaVignette(kitData, selectedPatientFullData).catch(err => {
                                                console.error('Error al imprimir vi√±eta Ruta:', err);
                                                alert('Error al generar la vi√±eta. Por favor, intente nuevamente.');
                                            });
                                        }}
                                        disabled={kitData.deliveryMode !== 'ruta'}
                                        className="w-full px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir Ruta
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            printVentanillaVignette(kitData, selectedPatientFullData).catch(err => {
                                                console.error('Error al imprimir vi√±eta Ventanilla:', err);
                                                alert('Error al generar la vi√±eta. Por favor, intente nuevamente.');
                                            });
                                        }}
                                        disabled={kitData.deliveryMode !== 'ventanilla'}
                                        className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir Ventanilla
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            printRefrigeradoVignette(kitData, selectedPatientFullData).catch(err => {
                                                console.error('Error al imprimir vi√±eta Refrigerado:', err);
                                                alert('Error al generar la vi√±eta. Por favor, intente nuevamente.');
                                            });
                                        }}
                                        disabled={!kitData.isRefrigerated && !(kitData.cantRefriGlobal && parseInt(kitData.cantRefriGlobal) > 0)}
                                        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir Refrigerados
                                    </button>
                                </div>
                                
                                <div className="flex justify-end gap-3 pt-4 border-t border-slate-200">
                                    <button
                                        onClick={() => setShowPrintModal(false)}
                                        className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </Modal>

                        <Modal isOpen={showKitForm} onClose={closeKitForm} title={isViewMode ? "Detalle del Kit" : isCCFormView ? (kitData.confirmadoPorContactCenter ? "Contact Center ‚Äî Actualizar kit" : "Contact Center ‚Äî Confirmar kit") : isDespachoFormView ? "Despacho de medicamentos ‚Äî Verificar recetas" : (editingKitId ? "Editar Kit" : "Nuevo Kit de Producci√≥n")} maxWidth="max-w-4xl">
                            <form onSubmit={handleKitSubmit} className="space-y-6">
                                <fieldset disabled={isViewMode} className="space-y-6">
                                    {isRevAsigFormView ? (
                                    <div className="space-y-5">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI</label>
                                                <input type="text" value={selectedPatient?.dni || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre</label>
                                                <input type="text" value={selectedPatient?.nombre || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Revisi√≥n y Asignaci√≥n</label>
                                                <input type="text" value={selectedPatientFullData?.usuarioRevisionAsignacion || selectedPatient?.usuarioRevisionAsignacion || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Contact Center</label>
                                                <input type="text" value={formatAgenteContactCenterDisplay(selectedPatientFullData?.agenteContactCenter || selectedPatient?.agenteContactCenter, users)} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                        </div>
                                        <div className="flex justify-center">
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-sm">
                                                <div className="absolute inset-y-1 bg-white rounded-full shadow-sm transition-all duration-300" style={{ left: kitData.deliveryMode === 'ruta' ? 'calc(50% + 0.125rem)' : '0.25rem', width: 'calc(50% - 0.25rem)', backgroundColor: kitData.deliveryMode === 'ruta' ? '#dcfce7' : '#e0e7ff' }} />
                                                <button type="button" onClick={() => setKitData({ ...kitData, deliveryMode: 'ventanilla', phoneHighlight: '', direccionEntrega: '', gpsStatus: 'SIN GPS', gpsValue: '', observationsEnabled: false, observations: '' })} className={`relative z-10 flex-1 px-6 py-2.5 text-sm font-extrabold uppercase rounded-full ${kitData.deliveryMode === 'ventanilla' ? 'text-indigo-700' : 'text-slate-600'}`}>‚úì VENTANILLA</button>
                                                <button type="button" onClick={() => setKitData({ ...kitData, deliveryMode: 'ruta' })} className={`relative z-10 flex-1 px-6 py-2.5 text-sm font-extrabold uppercase rounded-full ${kitData.deliveryMode === 'ruta' ? 'text-green-700' : 'text-slate-600'}`}>‚úì RUTA</button>
                                            </div>
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha de entrega del kit</label>
                                            <input type="date" className="w-full max-w-xs p-2.5 border rounded-lg text-sm bg-white" value={toDateInputValue(kitData.fechaEntregaKit)} onChange={e=>setKitData({...kitData, fechaEntregaKit: e.target.value || ''})} />
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                            <div className="flex items-center justify-between mb-3">
                                                <h5 className="text-xs font-bold text-slate-500 uppercase">Medicamentos</h5>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-lg font-bold text-turquoise-600 tabular-nums">{medsCounter.str}</span>
                                                    <button type="button" onClick={addMedRow} className="p-2 rounded-full bg-turquoise-500 text-white hover:bg-turquoise-600 transition-colors" title="Agregar medicamento"><span className="text-xl leading-none">+</span></button>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                {(kitData.medicamentos||[]).map((med, idx) => {
                                                    const va = med.dispensar !== false;
                                                    return (
                                                    <div key={idx} className={`p-3 rounded-lg border-2 shadow-sm space-y-2 transition-all ${va ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                        <div className="flex flex-wrap gap-2 items-end">
                                                            <div className="flex-1 min-w-[180px]">
                                                                <label className={`text-[10px] font-bold block ${va ? 'text-green-700' : 'text-red-700'}`}>Medicamento</label>
                                                                <input list="medsList" className={`w-full p-2 border-2 rounded text-sm ${va ? 'border-green-300 bg-white focus:border-green-500' : 'border-red-300 bg-white focus:border-red-500'}`} value={med.nombre} onChange={e=>handleMedChange(idx,'nombre',e.target.value)} placeholder="Buscar..." />
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className={`text-[10px] font-bold ${va ? 'text-green-700' : 'text-red-700'}`}>Dispensar</span>
                                                                <div className="relative inline-flex bg-slate-100 rounded-full p-0.5">
                                                                    <div className={`absolute inset-y-0.5 w-6 rounded-full shadow transition-all ${va ? 'bg-green-200' : 'bg-red-200'}`} style={{ left: va ? 'calc(100% - 1.25rem)' : '0.125rem' }} />
                                                                    <button type="button" onClick={()=>handleMedChange(idx,'dispensar',true)} className={`relative z-10 px-3 py-1 text-xs font-bold rounded-full ${va?'text-green-700':'text-slate-400'}`}>S√≠</button>
                                                                    <button type="button" onClick={()=>handleMedChange(idx,'dispensar',false)} className={`relative z-10 px-3 py-1 text-xs font-bold rounded-full ${!va?'text-red-600':'text-slate-400'}`}>No</button>
                                                                </div>
                                                            </div>
                                                            <button type="button" onClick={()=>removeMedRow(idx)} className="p-1.5 text-slate-400 hover:text-red-500 rounded" title="Quitar">√ó</button>
                                                        </div>
                                                        <div>
                                                            <label className={`text-[10px] font-bold block ${va ? 'text-green-700' : 'text-red-700'}`}>
                                                                Observaciones por medicamento {!va && <span className="text-red-600">*</span>}
                                                            </label>
                                                            <textarea 
                                                                className={`w-full p-2 border-2 rounded text-sm ${va ? 'border-green-300 bg-white focus:border-green-500' : 'border-red-300 bg-red-50 focus:border-red-500'}`} 
                                                                rows="2" 
                                                                value={med.observaciones||''} 
                                                                onChange={e=>handleMedChange(idx,'observaciones',e.target.value)} 
                                                                placeholder={va ? "Opcional" : "OBLIGATORIO: Explique por qu√© no se dispensa este medicamento"}
                                                                required={!va}
                                                            />
                                                            {!va && !med.observaciones && (
                                                                <p className="text-xs text-red-600 font-semibold mt-1">‚ö†Ô∏è Debe explicar por qu√© no se dispensa este medicamento</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                    );
                                                })}
                                            </div>
                                            <div className="mt-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Observaciones para Contact Center</label>
                                                <textarea className="w-full p-3 border rounded-lg text-sm bg-amber-50/50 border-amber-200" rows="2" value={kitData.observacionesContactCenter||''} onChange={e=>setKitData({...kitData, observacionesContactCenter:toUpper(e.target.value)})} placeholder="Indicaciones para el agente de Contact Center sobre el paciente..." />
                                            </div>
                                        </div>
                                        {kitData.devueltoPorContactCenter && (
                                            (() => {
                                                const tieneObsEntrega = (kitData.observacionesEntregaEnabled || kitData.observationsEnabled || (kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro')) && (kitData.observacionesEntrega || kitData.observations);
                                                const tieneObsRegreso = !!kitData.observacionesRegresoEnabled && !!((kitData.observacionesRegresoFarmacia || '').trim());
                                                if (!tieneObsEntrega && !tieneObsRegreso) return null;
                                                return (
                                                    <div className="p-4 bg-violet-50/80 rounded-xl border border-violet-200">
                                                        <h5 className="text-xs font-bold text-violet-700 uppercase tracking-wider mb-3 border-b border-violet-200 pb-1">Regresado de Contact Center ‚Äî Observaciones para Farmacia</h5>
                                                        {tieneObsEntrega && (
                                                            <div className={tieneObsRegreso ? 'mb-3' : ''}>
                                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Observaciones de entrega (habilitadas en Contact Center)</label>
                                                                <div className="p-3 rounded-lg bg-white border border-violet-100 text-sm text-slate-700">{kitData.observacionesEntrega || kitData.observations || '‚Äî'}</div>
                                                            </div>
                                                        )}
                                                        {tieneObsRegreso && (
                                                            <div>
                                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Observaciones de regreso a farmacia (Contact Center)</label>
                                                                <div className="p-3 rounded-lg bg-white border border-violet-100 text-sm text-slate-700">{kitData.observacionesRegresoFarmacia || '‚Äî'}</div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })()
                                        )}
                                    </div>
                                    ) : isCCFormView ? (
                                    <div className="space-y-5">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI</label>
                                                <input type="text" value={selectedPatient?.dni || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre</label>
                                                <input type="text" value={selectedPatient?.nombre || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center asignado</label>
                                                <input type="text" value={formatAgenteContactCenterDisplay(selectedPatientFullData?.agenteContactCenter || selectedPatient?.agenteContactCenter, users)} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario que imprimi√≥ recetas (Revisi√≥n y asignaci√≥n)</label>
                                                <input type="text" value={selectedPatientFullData?.usuarioRevisionAsignacion || selectedPatient?.usuarioRevisionAsignacion || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">Ventanilla / Ruta</label>
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-sm">
                                                <div className="absolute inset-y-1 bg-white rounded-full shadow-sm transition-all duration-300" style={{ left: kitData.deliveryMode === 'ruta' ? 'calc(50% + 0.125rem)' : '0.25rem', width: 'calc(50% - 0.25rem)', backgroundColor: kitData.deliveryMode === 'ruta' ? '#dcfce7' : '#e0e7ff' }} />
                                                <button type="button" onClick={() => setKitData({ ...kitData, deliveryMode: 'ventanilla' })} className={`relative z-10 flex-1 px-6 py-2.5 text-sm font-extrabold uppercase rounded-full ${kitData.deliveryMode === 'ventanilla' ? 'text-indigo-700' : 'text-slate-600'}`}>‚úì Ventanilla</button>
                                                <button type="button" onClick={() => setKitData({ ...kitData, deliveryMode: 'ruta' })} className={`relative z-10 flex-1 px-6 py-2.5 text-sm font-extrabold uppercase rounded-full ${kitData.deliveryMode === 'ruta' ? 'text-green-700' : 'text-slate-600'}`}>‚úì Ruta</button>
                                            </div>
                                            <p className="text-xs text-slate-500 mt-1">Confirme si sigue en Ruta o cambia a retiro por Ventanilla.</p>
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha de entrega del kit</label>
                                            <input type="date" className="w-full max-w-xs p-2.5 border rounded-lg text-sm bg-white" value={toDateInputValue(kitData.fechaEntregaKit)} onChange={e=>setKitData({...kitData, fechaEntregaKit: e.target.value || ''})} />
                                            <p className="text-xs text-slate-500 mt-1">Confirme o cambie la fecha.</p>
                                        </div>
                                        {kitData.deliveryMode === 'ruta' && (
                                        <>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">Tel√©fono confirmado</label>
                                            <div className="flex flex-wrap gap-2">
                                                {['personal','familiar','ninguno','otro'].map(t => (
                                                    <button key={t} type="button" onClick={()=>setKitData({...kitData, tipoTelefonoCC: t, phoneHighlight: t === 'personal' ? 'personal' : t === 'familiar' ? 'familiar' : ''})} className={`px-4 py-2 rounded-xl border-2 text-sm font-bold capitalize ${kitData.tipoTelefonoCC === t ? 'border-turquoise-500 bg-turquoise-50 text-turquoise-700' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}>
                                                        {t === 'personal' ? 'Personal' : t === 'familiar' ? 'Familiar' : t === 'ninguno' ? 'Ninguno' : 'Otro'}
                                                    </button>
                                                ))}
                                            </div>
                                            {kitData.tipoTelefonoCC === 'personal' && <p className="text-xs text-slate-500 mt-1">Personal: {selectedPatientFullData?.telefono || '‚Äî'}</p>}
                                            {kitData.tipoTelefonoCC === 'familiar' && <p className="text-xs text-slate-500 mt-1">Familiar: {selectedPatientFullData?.telefonoFamiliar || '‚Äî'}</p>}
                                            {kitData.tipoTelefonoCC === 'otro' && <p className="text-xs text-amber-600 mt-1">Si es otro, indique en Observaciones de entrega.</p>}
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">¬øEs la ubicaci√≥n principal?</label>
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-xs">
                                                <div className="absolute inset-y-1 w-12 bg-white rounded-full shadow-sm transition-all duration-300" style={{ left: kitData.esUbicacionPrincipal ? '0.25rem' : 'calc(100% - 3.25rem)' }} />
                                                <button type="button" onClick={()=>setKitData({...kitData, esUbicacionPrincipal: true, direccionEntrega: (selectedPatientFullData?.direccion || selectedPatient?.direccion || '').trim(), direccionAlternativa: ''})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${kitData.esUbicacionPrincipal ? 'text-green-700' : 'text-slate-500'}`}>S√≠</button>
                                                <button type="button" onClick={()=>setKitData({...kitData, esUbicacionPrincipal: false, direccionEntrega: kitData.direccionAlternativa || '', direccionAlternativa: kitData.direccionAlternativa || ''})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${!kitData.esUbicacionPrincipal ? 'text-amber-700' : 'text-slate-500'}`}>No</button>
                                            </div>
                                            {kitData.esUbicacionPrincipal && <p className="text-xs text-slate-500 mt-1">Direcci√≥n: {selectedPatientFullData?.direccion || selectedPatient?.direccion || '‚Äî'}</p>}
                                            {!kitData.esUbicacionPrincipal && (
                                                <div className="mt-2">
                                                    <label className="text-[10px] font-bold text-slate-400 block mb-1">Nueva direcci√≥n</label>
                                                    <textarea className="w-full p-2.5 border rounded-lg text-sm bg-white" rows="2" value={kitData.direccionAlternativa||''} onChange={e=>{ const u=toUpper(e.target.value); setKitData({...kitData, direccionAlternativa: u, direccionEntrega: u}); }} placeholder="Ingrese la direcci√≥n de entrega..." />
                                                </div>
                                            )}
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">GPS</label>
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-xs">
                                                <div className="absolute inset-y-1 w-12 bg-white rounded-full shadow-sm transition-all duration-300" style={{ left: kitData.gpsStatus === 'TIENE GPS' ? 'calc(100% - 3.25rem)' : '0.25rem' }} />
                                                <button type="button" onClick={()=>setKitData({...kitData, gpsStatus: 'SIN GPS', gpsValue: ''})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${kitData.gpsStatus !== 'TIENE GPS' ? 'text-slate-700' : 'text-slate-500'}`}>No</button>
                                                <button type="button" onClick={()=>setKitData({...kitData, gpsStatus: 'TIENE GPS'})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${kitData.gpsStatus === 'TIENE GPS' ? 'text-green-700' : 'text-slate-500'}`}>S√≠</button>
                                            </div>
                                            {kitData.gpsStatus === 'TIENE GPS' && (
                                                <input type="text" className="w-full mt-2 p-2.5 border rounded-lg text-sm bg-green-50 border-green-200" value={kitData.gpsValue||''} onChange={e=>setKitData({...kitData, gpsValue: e.target.value})} placeholder="Coordenadas (lat,lng) o enlace..." />
                                            )}
                                        </div>
                                        </>
                                        )}
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">Observaciones de entrega</label>
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-xs mb-2">
                                                <div className="absolute inset-y-1 w-12 bg-white rounded-full shadow-sm transition-all duration-300" style={{ left: (kitData.observacionesEntregaEnabled || (kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro')) ? 'calc(100% - 3.25rem)' : '0.25rem' }} />
                                                <button type="button" onClick={()=>setKitData({...kitData, observacionesEntregaEnabled: false})} disabled={kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro'} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${!(kitData.observacionesEntregaEnabled || (kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro')) ? 'text-slate-700' : 'text-slate-500'} disabled:opacity-50 disabled:cursor-not-allowed`}>No</button>
                                                <button type="button" onClick={()=>setKitData({...kitData, observacionesEntregaEnabled: true})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${(kitData.observacionesEntregaEnabled || (kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro')) ? 'text-amber-700' : 'text-slate-500'}`}>S√≠</button>
                                            </div>
                                            {(kitData.observacionesEntregaEnabled || (kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro')) && (
                                                <textarea className="w-full p-2.5 border rounded-lg text-sm bg-amber-50/50 border-amber-200" rows="2" value={kitData.observacionesEntrega||''} onChange={e=>setKitData({...kitData, observacionesEntrega: toUpper(e.target.value)})} placeholder={kitData.deliveryMode === 'ruta' && kitData.tipoTelefonoCC === 'otro' ? 'Especifique tel√©fono u otro dato...' : 'Instrucciones de entrega...'} />
                                            )}
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                            <div className="flex items-center justify-between mb-3">
                                                <h5 className="text-xs font-bold text-slate-500 uppercase">Medicamentos asignados</h5>
                                                <span className="text-lg font-bold text-turquoise-600 tabular-nums">{medsCounter.str}</span>
                                            </div>
                                            <div className="space-y-2 mb-4">
                                                {(kitData.medicamentos||[]).map((med, idx) => {
                                                    const va = med.dispensar !== false;
                                                    return (
                                                    <div key={idx} className={`p-3 rounded-lg border-2 ${va ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                        <div className="flex justify-between items-start gap-2">
                                                            <div>
                                                                <span className={`font-semibold ${va ? 'text-green-800' : 'text-red-800'}`}>{med.nombre || '‚Äî'}</span>
                                                                <span className={`ml-2 font-mono text-sm ${va ? 'text-green-600' : 'text-red-600'}`}>√ó {med.cantidad || '‚Äî'}</span>
                                                                <span className={`ml-2 text-xs font-bold ${va ? 'text-green-600' : 'text-red-600'}`}>{va ? '‚úì S√≠ va' : '‚úó No va'}</span>
                                                            </div>
                                                        </div>
                                                        {med.observaciones && <p className={`text-xs mt-1 ${va ? 'text-green-700' : 'text-red-700'}`}>Obs: {med.observaciones}</p>}
                                                    </div>
                                                    );
                                                })}
                                            </div>
                                            <p className="text-xs text-slate-500 mb-2">Rev. y asignaci√≥n: {kitData.observacionesContactCenter || '‚Äî'}</p>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">Observaciones de regreso a farmacia</label>
                                            <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-xs mb-2">
                                                <div className="absolute inset-y-1 w-12 bg-white rounded-full shadow-sm transition-all duration-300" style={{ left: kitData.observacionesRegresoEnabled ? 'calc(100% - 3.25rem)' : '0.25rem' }} />
                                                <button type="button" onClick={()=>setKitData({...kitData, observacionesRegresoEnabled: false, observacionesRegresoFarmacia: ''})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${!kitData.observacionesRegresoEnabled ? 'text-slate-700' : 'text-slate-500'}`}>No</button>
                                                <button type="button" onClick={()=>setKitData({...kitData, observacionesRegresoEnabled: true})} className={`relative z-10 flex-1 px-4 py-2 text-sm font-bold rounded-full ${kitData.observacionesRegresoEnabled ? 'text-turquoise-700' : 'text-slate-500'}`}>S√≠</button>
                                            </div>
                                            {kitData.observacionesRegresoEnabled && (
                                                <textarea className="w-full p-2.5 border rounded-lg text-sm bg-turquoise-50/50 border-turquoise-200" rows="4" value={kitData.observacionesRegresoFarmacia||''} onChange={e=>setKitData({...kitData, observacionesRegresoFarmacia: toUpper(e.target.value)})} placeholder="Observaciones para farmacia (revisi√≥n y asignaci√≥n)..." />
                                            )}
                                        </div>
                                    </div>
                                    ) : isDespachoFormView ? (
                                    <div className="space-y-5">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI</label>
                                                <input type="text" value={selectedPatient?.dni || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre</label>
                                                <input type="text" value={selectedPatient?.nombre || ''} disabled className="w-full p-2.5 border rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center asignado</label>
                                                <input type="text" value={formatAgenteContactCenterDisplay(selectedPatientFullData?.agenteContactCenter || selectedPatient?.agenteContactCenter, users)} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario que imprimi√≥ recetas (Revisi√≥n y asignaci√≥n)</label>
                                                <input type="text" value={kitData.digitador || selectedPatientFullData?.usuarioRevisionAsignacion || selectedPatient?.usuarioRevisionAsignacion || '‚Äî'} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                            <div className="flex items-center justify-between mb-3">
                                                <h5 className="text-xs font-bold text-slate-500 uppercase">Medicamentos asignados</h5>
                                                <span className="text-lg font-bold text-turquoise-600 tabular-nums">{medsCounter.str}</span>
                                            </div>
                                            <div className="space-y-2 mb-4">
                                                {(kitData.medicamentos||[]).map((med, idx) => {
                                                    const va = med.dispensar !== false;
                                                    return (
                                                    <div key={idx} className={`p-3 rounded-lg border-2 flex flex-wrap items-center gap-3 ${va ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                        <div className="flex-1 min-w-0">
                                                            <span className={`font-semibold ${va ? 'text-green-800' : 'text-red-800'}`}>{med.nombre || '‚Äî'}</span>
                                                            <span className={`ml-2 font-mono text-sm ${va ? 'text-green-600' : 'text-red-600'}`}>√ó {med.cantidad || '‚Äî'}</span>
                                                            <span className={`ml-2 text-xs font-bold ${va ? 'text-green-600' : 'text-red-600'}`}>{va ? '‚úì S√≠ va' : '‚úó No va'}</span>
                                                            {med.observaciones && <p className={`text-xs mt-1 ${va ? 'text-green-700' : 'text-red-700'}`}>Obs: {med.observaciones}</p>}
                                                        </div>
                                                        {va && (
                                                            <label className="flex items-center gap-2 cursor-pointer shrink-0">
                                                                <input type="checkbox" checked={!!med.recetaFisicaVerificada} onChange={()=>handleMedChange(idx,'recetaFisicaVerificada',!med.recetaFisicaVerificada)} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                                <span className="text-xs font-bold text-slate-600">Receta f√≠sica verificada</span>
                                                            </label>
                                                        )}
                                                    </div>
                                                    );
                                                })}
                                            </div>
                                            {kitData.observacionesContactCenter && <p className="text-xs text-slate-500">Obs. Rev. y asignaci√≥n: {kitData.observacionesContactCenter}</p>}
                                        </div>
                                    </div>
                                    ) : (
                                    <>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b border-slate-100 pb-4 bg-slate-50 p-4 rounded-xl">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI del Paciente</label>
                                            <input type="text" value={selectedPatient.dni} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Paciente</label>
                                            <input type="text" value={selectedPatient.nombre} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                    </div>

                                    <div className={`flex justify-center pb-4 border-b border-slate-100 transition-all ${sectionDisabled(KIT_SECTIONS.REV_ASIG) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <div className="relative inline-flex items-center bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-sm overflow-hidden">
                                            <div
                                                className="absolute inset-y-1 bg-white rounded-full shadow-sm transition-all duration-300 ease-in-out"
                                                style={{
                                                    left: kitData.deliveryMode === 'ruta' ? 'calc(50% + 0.125rem)' : '0.25rem',
                                                    width: 'calc(50% - 0.25rem)',
                                                    backgroundColor: kitData.deliveryMode === 'ruta' ? '#dcfce7' : '#e0e7ff'
                                                }}
                                            />
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    setKitData({
                                                        ...kitData,
                                                        deliveryMode: 'ventanilla',
                                                        phoneHighlight: '',
                                                        direccionEntrega: '',
                                                        gpsStatus: 'SIN GPS',
                                                        gpsValue: '',
                                                        observationsEnabled: false,
                                                        observations: ''
                                                    });
                                                }}
                                                className={`
                                                    relative z-10 flex-1 px-6 py-2.5 text-sm font-extrabold uppercase rounded-full transition-colors duration-300 ease-in-out
                                                    ${kitData.deliveryMode === 'ventanilla' ? 'text-indigo-700' : 'text-slate-600'}
                                                    focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2
                                                `}
                                            >
                                                {kitData.deliveryMode === 'ventanilla' ? '‚úì VENTANILLA' : 'VENTANILLA'}
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setKitData({ ...kitData, deliveryMode: 'ruta' })}
                                                className={`
                                                    relative z-10 flex-1 px-6 py-2.5 text-sm font-extrabold uppercase rounded-full transition-colors duration-300 ease-in-out
                                                    ${kitData.deliveryMode === 'ruta' ? 'text-green-700' : 'text-slate-600'}
                                                    focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2
                                                `}
                                            >
                                                {kitData.deliveryMode === 'ruta' ? '‚úì RUTA' : 'RUTA'}
                                            </button>
                                        </div>
                                    </div>

                                    <div className={`transition-all duration-300 ${kitData.deliveryMode === 'ventanilla' ? 'opacity-40 pointer-events-none grayscale' : sectionDisabled(KIT_SECTIONS.LOGISTICA) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Log√≠stica ‚Äì Ruta (Datos obligatorios)</h5>
                                            
                                            <div className="space-y-3 mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block">Tel√©fonos del paciente (se imprimen los 2; el seleccionado se marca en recuadro):</label>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => setPhoneHighlight(kitData.phoneHighlight === 'personal' ? '' : 'personal')}
                                                        className={`p-3 rounded-lg border text-left transition-all ${
                                                            kitData.phoneHighlight === 'personal'
                                                                ? 'bg-emerald-50 border-emerald-300 shadow-sm'
                                                                : 'bg-white border-slate-200 hover:border-slate-300'
                                                        }`}
                                                    >
                                                        <div className="text-[10px] font-bold text-slate-400 uppercase">Personal</div>
                                                        <div className="text-sm font-bold text-slate-800">{selectedPatientFullData?.telefono || 'No disponible'}</div>
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => setPhoneHighlight(kitData.phoneHighlight === 'familiar' ? '' : 'familiar')}
                                                        className={`p-3 rounded-lg border text-left transition-all ${
                                                            kitData.phoneHighlight === 'familiar'
                                                                ? 'bg-emerald-50 border-emerald-300 shadow-sm'
                                                                : 'bg-white border-slate-200 hover:border-slate-300'
                                                        }`}
                                                    >
                                                        <div className="text-[10px] font-bold text-slate-400 uppercase">Familiar</div>
                                                        <div className="text-sm font-bold text-slate-800">{selectedPatientFullData?.telefonoFamiliar || 'No disponible'}</div>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div className="mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Ubicaci√≥n de entrega (OBLIGATORIO)</label>
                                                <textarea
                                                    className="w-full p-2.5 border-2 rounded-lg text-sm bg-white font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-500 transition-all"
                                                    rows="2"
                                                    value={kitData.direccionEntrega || ''}
                                                    onChange={e=>setKitData({...kitData, direccionEntrega:toUpper(e.target.value)})}
                                                    placeholder="Ingrese la ubicaci√≥n exacta de entrega..."
                                                    required={kitData.deliveryMode === 'ruta'}
                                                    disabled={kitData.deliveryMode !== 'ruta'}
                                                />
                                            </div>
                                            
                                            <div className="mb-4">
                                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={kitData.observationsEnabled}
                                                        onChange={e=>setKitData({...kitData, observationsEnabled:e.target.checked})}
                                                        disabled={kitData.deliveryMode !== 'ruta'}
                                                    />
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Instrucciones de entrega</span>
                                                </label>
                                                {kitData.observationsEnabled && (
                                                    <textarea
                                                        className="w-full p-2 border rounded text-sm bg-amber-50 border-amber-200"
                                                        rows="2"
                                                        value={kitData.observations}
                                                        onChange={e=>setKitData({...kitData, observations:toUpper(e.target.value)})}
                                                        placeholder="Ej: Port√≥n negro, tocar timbre 2 veces..."
                                                        disabled={kitData.deliveryMode !== 'ruta'}
                                                    ></textarea>
                                                )}
                                            </div>
                                            
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-2">GPS</label>
                                                    
                                                    {/* Toggle Button S√≠/No con animaci√≥n */}
                                                    <div className="relative inline-flex items-center mb-3 bg-slate-100 rounded-full p-1 shadow-inner w-full max-w-xs overflow-hidden">
                                                        <div 
                                                            className="absolute inset-y-1 bg-white rounded-full shadow-sm transition-all duration-300 ease-in-out"
                                                            style={{
                                                                left: kitData.gpsStatus === 'TIENE GPS' ? 'calc(50% + 0.125rem)' : '0.25rem',
                                                                width: 'calc(50% - 0.25rem)',
                                                                backgroundColor: kitData.gpsStatus === 'TIENE GPS' ? '#dcfce7' : '#ffffff'
                                                            }}
                                                        />
                                                        <button
                                                            type="button"
                                                            onClick={() => {
                                                                const newStatus = kitData.gpsStatus === 'TIENE GPS' ? 'SIN GPS' : 'TIENE GPS';
                                                                setKitData({
                                                                    ...kitData,
                                                                    gpsStatus: newStatus,
                                                                    gpsValue: newStatus === 'SIN GPS' ? '' : kitData.gpsValue
                                                                });
                                                            }}
                                                            className={`
                                                                relative z-10 flex-1 px-6 py-2.5 text-sm font-bold uppercase rounded-full transition-colors duration-300 ease-in-out
                                                                ${kitData.gpsStatus === 'TIENE GPS'
                                                                    ? 'text-green-700'
                                                                    : 'text-slate-600'
                                                                }
                                                                focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2
                                                            `}
                                                        >
                                                            {kitData.gpsStatus === 'TIENE GPS' ? '‚úì S√ç' : '‚úó NO'}
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Campo de texto para GPS cuando est√° en S√ç */}
                                                    {kitData.gpsStatus === 'TIENE GPS' && (
                                                        <div className="mt-2 animate-in slide-in-from-top-2 duration-300">
                                                            <input
                                                                type="text"
                                                                className="w-full p-2.5 border-2 border-green-300 rounded-lg text-sm bg-green-50 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-500 transition-all duration-200"
                                                                value={kitData.gpsValue || ''}
                                                                onChange={e => setKitData({...kitData, gpsValue: e.target.value})}
                                                                placeholder="Ingrese coordenadas (lat,lng) o enlace de GPS..."
                                                                autoFocus
                                                            />
                                                        </div>
                                                    )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4 transition-all ${sectionDisabled(KIT_SECTIONS.REV_ASIG) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Revisi√≥n y asignaci√≥n</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center</label>
                                                <select className="w-full p-2 border rounded text-sm bg-white" value={kitData.contactCenter} onChange={e=>setKitData({...kitData, contactCenter:e.target.value})}>
                                                    <option value="">Seleccione...</option>
                                                    {contacts && contacts.map(c => (
                                                        <option key={c.id} value={`${c.name} --- ${c.phone}`}>{c.name} --- {c.phone}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Digitador</label>
                                                <input type="text" className="w-full p-2 border rounded text-sm bg-slate-200 text-slate-500" value={currentUser.name} disabled />
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4 transition-all ${sectionDisabled(KIT_SECTIONS.OPERACIONES) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Operaciones</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-white rounded-xl border border-slate-100 mb-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI del Paciente</label>
                                                <input type="text" value={selectedPatient?.dni || ''} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Paciente</label>
                                                <input type="text" value={selectedPatient?.nombre || ''} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center asignado</label>
                                                <input type="text" value={formatAgenteContactCenterDisplay(selectedPatientFullData?.agenteContactCenter || selectedPatient?.agenteContactCenter, users)} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center (Tel√©fono)</label>
                                                <input type="text" value={(() => {
                                                    const cc = kitData.contactCenter || '';
                                                    if (!cc) return '‚Äî';
                                                    const parts = cc.split(' --- ');
                                                    if (parts.length > 1) {
                                                        return parts[1].trim();
                                                    }
                                                    return cc.includes('---') ? cc.split('---')[1]?.trim() || '‚Äî' : '‚Äî';
                                                })()} disabled className="w-full p-2.5 border rounded-lg text-sm bg-slate-100 text-slate-600" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Armado</label>
                                                <input type="date" className="w-full p-2.5 border rounded-lg text-sm bg-white" value={toDateInputValue(kitData.fechaArmado)} onChange={e=>setKitData({...kitData, fechaArmado:e.target.value})} required />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Hora Operaciones</label>
                                                <input type="text" className="w-full p-2.5 border rounded-lg text-sm bg-white" value={kitData.horaOperaciones || ''} onChange={e=>setKitData({...kitData, horaOperaciones:toUpper(e.target.value)})} placeholder="08:00 AM" />
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4 transition-all ${sectionDisabled(KIT_SECTIONS.LOGISTICA) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Log√≠stica</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega a Log√≠stica</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={toDateInputValue(kitData.fechaEntregaLogistica)} onChange={e=>setKitData({...kitData, fechaEntregaLogistica:e.target.value})} />
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4 transition-all ${sectionDisabled(KIT_SECTIONS.CALIDAD) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Calidad</h5>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Observaciones calidad</label>
                                            <textarea className="w-full p-2 border rounded text-sm bg-white" rows="2" value={kitData.observacionesCalidad || ''} onChange={e=>setKitData({...kitData, observacionesCalidad:toUpper(e.target.value)})} placeholder="Observaciones del √°rea de calidad..." />
                                        </div>
                                    </div>

                                    <div className={`border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4 transition-all ${sectionDisabled(KIT_SECTIONS.DELIVERY) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Delivery</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega de Kit (Paciente)</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={toDateInputValue(kitData.fechaEntregaKit)} onChange={e=>setKitData({...kitData, fechaEntregaKit:e.target.value})} />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Observaciones delivery</label>
                                                <textarea className="w-full p-2 border rounded text-sm bg-white" rows="2" value={kitData.observacionesDelivery || ''} onChange={e=>setKitData({...kitData, observacionesDelivery:toUpper(e.target.value)})} placeholder="Observaciones de entrega..." />
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4 transition-all ${sectionDisabled(KIT_SECTIONS.DESPACHO) ? 'opacity-60 pointer-events-none' : ''}`}>
                                        <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-1">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Despacho medicamentos</h5>
                                            <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" checked={kitData.isRefrigerated} onChange={e=>setKitData({...kitData, isRefrigerated: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">Refrigerado</span>
                                                </label>
                                                {kitData.isRefrigerated && (
                                                    <input type="number" placeholder="Cant." className="w-16 p-1 border rounded text-center text-xs bg-blue-50 border-blue-200 text-blue-700 font-bold outline-none" value={safeNumber(kitData.cantRefriGlobal)} onChange={e=>setKitData({...kitData, cantRefriGlobal: e.target.value})} />
                                                )}
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500">% Medicamentos:</label>
                                                    <input type="text" className="w-20 p-1 border rounded text-center font-bold bg-white" value={kitData.triggerMeds} onChange={e=>handleTriggerMeds(e.target.value)} placeholder="Ej: 6/9" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            {kitData.medicamentos.map((med, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-lg border shadow-sm flex flex-col md:flex-row gap-2 items-end">
                                                    <div className="flex-1 w-full">
                                                        <label className="text-[10px] font-bold text-slate-400 block">Medicamento</label>
                                                        <input list="medsList" className="w-full p-1.5 border rounded text-xs" value={med.nombre} onChange={e => handleMedChange(idx, 'nombre', e.target.value)} placeholder="Buscar..." />
                                                    </div>
                                                </div>
                                            ))}
                                            {kitData.medicamentos.length === 0 && <div className="text-center text-xs text-slate-400 italic py-4">Use el bot√≥n + para agregar medicamentos.</div>}
                                        </div>
                                    </div>

                                    {editingKitId && (userCanEditSection(KIT_SECTIONS.REV_ASIG) || userCanEditSection(KIT_SECTIONS.CONTACT_CENTER)) && (
                                        <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Estado del flujo</h5>
                                            {userCanEditSection(KIT_SECTIONS.REV_ASIG) && (
                                                <div className={`space-y-2 transition-all ${sectionDisabled(KIT_SECTIONS.REV_ASIG) ? 'opacity-60 pointer-events-none' : ''}`}>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={!!kitData.recetaImpresa} onChange={e=>setKitData({...kitData, recetaImpresa: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                        <span className="text-sm font-medium text-slate-700">Receta impresa</span>
                                                    </label>
                                                    {kitData.devueltoPorContactCenter && (
                                                        <p className="text-xs text-slate-500">Devuelto por Contact Center</p>
                                                    )}
                                                </div>
                                            )}
                                            {userCanEditSection(KIT_SECTIONS.CONTACT_CENTER) && (
                                                <div className={`space-y-2 mt-3 transition-all ${sectionDisabled(KIT_SECTIONS.CONTACT_CENTER) ? 'opacity-60 pointer-events-none' : ''}`}>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={!!kitData.confirmadoPorContactCenter} onChange={e=>setKitData({...kitData, confirmadoPorContactCenter: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                        <span className="text-sm font-medium text-slate-700">Informaci√≥n confirmada</span>
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" checked={!!kitData.devueltoPorContactCenter} onChange={e=>setKitData({...kitData, devueltoPorContactCenter: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                        <span className="text-sm font-medium text-slate-700">Marcar devuelto a Revisi√≥n y Asignaci√≥n</span>
                                                    </label>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    </>
                                    )}
                                </fieldset>
                                
                                {!isViewMode ? (
                                    <div className="flex flex-wrap gap-3">
                                        {isRevAsigFormView ? (
                                            <>
                                                {showMarcarImpresoYDespacho ? (
                                                    <button type="button" onClick={handleMarcarImpresoYDespacho} className="flex-1 py-3 bg-amber-600 text-white font-bold rounded-xl shadow-lg hover:bg-amber-700 transition-colors btn-hover-effect">Marcar impreso y mandar a Despacho de medicamentos</button>
                                                ) : kitData.deliveryMode === 'ruta' ? (
                                                    <button type="submit" className="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-colors btn-hover-effect">Guardar kit</button>
                                                ) : (
                                                    <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar kit y marcar impreso</button>
                                                )}
                                            </>
                                        ) : isCCFormView ? (
                                            <>
                                                <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">{kitData.confirmadoPorContactCenter ? 'Actualizar kit' : 'Guardar kit'}</button>
                                                {kitData.confirmadoPorContactCenter && !kitData.devueltoPorContactCenter && (
                                                    <button type="button" onClick={handleRegresarARevisionAsignacion} className="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition-colors btn-hover-effect">Regresar a Revisi√≥n y Asignaci√≥n</button>
                                                )}
                                            </>
                                        ) : isDespachoFormView ? (
                                            <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar kit</button>
                                        ) : (
                                            <>
                                                {hasAnyEditableSection() && (
                                                    <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar Kit</button>
                                                )}
                                                {!hasAnyEditableSection() && (
                                                    <button type="button" onClick={closeKitForm} className="flex-1 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                                )}
                                            </>
                                        )}
                                    </div>
                                ) : (
                                    <div className="flex flex-wrap gap-3">
                                        {kitData.trabajadoOperaciones && (kitData.deliveryMode === 'ruta' || kitData.deliveryMode === 'ventanilla' || (!!kitData.isRefrigerated || !!(kitData.cantRefriGlobal && parseInt(kitData.cantRefriGlobal, 10) > 0))) && (
                                            <div className="flex flex-wrap gap-2 w-full">
                                                <span className="text-xs font-bold text-slate-500 w-full">Reimprimir vi√±etas:</span>
                                                {kitData.deliveryMode === 'ruta' && printRutaVignette && (
                                                    <button type="button" onClick={() => printRutaVignette(kitData, selectedPatientFullData || selectedPatient).catch(err => { console.error(err); alert('Error al imprimir.'); })} className="flex items-center gap-1.5 px-4 py-2 rounded-xl bg-emerald-600 text-white font-bold text-sm hover:bg-emerald-700">
                                                        <Icons.Printer size={16}/> Imprimir Ruta
                                                    </button>
                                                )}
                                                {kitData.deliveryMode === 'ventanilla' && printVentanillaVignette && (
                                                    <button type="button" onClick={() => printVentanillaVignette(kitData, selectedPatientFullData || selectedPatient).catch(err => { console.error(err); alert('Error al imprimir.'); })} className="flex items-center gap-1.5 px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold text-sm hover:bg-indigo-700">
                                                        <Icons.Printer size={16}/> Imprimir Ventanilla
                                                    </button>
                                                )}
                                                {(!!kitData.isRefrigerated || !!(kitData.cantRefriGlobal && parseInt(kitData.cantRefriGlobal, 10) > 0)) && printRefrigeradoVignette && (
                                                    <button type="button" onClick={() => printRefrigeradoVignette(kitData, selectedPatientFullData || selectedPatient).catch(err => { console.error(err); alert('Error al imprimir.'); })} className="flex items-center gap-1.5 px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-700">
                                                        <Icons.Printer size={16}/> Imprimir Refrigerado
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                        <button type="button" onClick={closeKitForm} className="flex-1 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                    </div>
                                )}
                            </form>
                            <datalist id="medsList">
                                {medicines.map((m, i) => <option key={i} value={m.name} />)}
                            </datalist>
                        </Modal>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 p-5 relative z-10">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                                    <h2 className="text-xl font-bold text-slate-800">Historial de Producci√≥n</h2>
                                    <div className="text-2xl font-bold text-turquoise-600">{patientKits.length} <span className="text-sm text-slate-400 font-normal">Kits</span></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span className="text-[10px] font-bold text-slate-400 block">Tipo Afiliado</span>
                                        {selectedPatientFullData?.tipoAfiliado || selectedPatient.tipoAfiliado}
                                    </div>
                                    <div className="md:col-span-3">
                                        <span className="text-[10px] font-bold text-slate-400 block">Domicilio</span>
                                        {selectedPatientFullData?.direccion || 'Cargando...'}
                                    </div>
                                    {getLastDeliveryDate(selectedPatient) && (
                                        <div className="md:col-span-2">
                                            <span className="text-[10px] font-bold text-slate-400 block">√öltima entrega kit</span>
                                            {getLastDeliveryDate(selectedPatient)}
                                        </div>
                                    )}
                                </div>
                                {selectedPatientFullData && (
                                    <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span className="text-[10px] font-bold text-slate-400 block">Tel√©fono</span>
                                            {selectedPatientFullData.telefono || 'No disponible'}
                                        </div>
                                        <div>
                                            <span className="text-[10px] font-bold text-slate-400 block">Tel. Familiar</span>
                                            {selectedPatientFullData.telefonoFamiliar || 'No disponible'}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="grid gap-3">
                                {patientKits.map(kit => {
                                    const sem = getPatientSemaphore(selectedPatient, patientKits);
                                    const semBorder = sem === 'red' ? 'border-l-4 border-l-red-500 bg-red-50/30' : sem === 'orange' ? 'border-l-4 border-l-amber-500 bg-amber-50/30' : 'border-l-4 border-l-green-500 bg-green-50/30';
                                    return (
                                    <div key={kit.id} className={`p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4 relative group ${semBorder}`}>
                                        <div className="flex-1">
                                            <div className="flex flex-wrap items-center gap-2 mb-2">
                                                <span className="bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold border border-turquoise-100">
                                                    <Icons.Calendar size={12} className="inline mr-1"/> {kit.fechaArmado}
                                                </span>
                                                <span className={`px-2 py-1 rounded text-xs font-bold border ${kit.deliveryMode==='ruta'?'bg-emerald-50 text-emerald-700 border-emerald-100':'bg-indigo-50 text-indigo-700 border-indigo-100'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA'}
                                                </span>
                                                <span className="text-xs text-slate-400 font-mono">Hora Ops: {kit.horaOperaciones || '--:--'}</span>
                                                {kit.isRefrigerated && (
                                                    <span className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado
                                                    </span>
                                                )}
                                            </div>
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {kit.medicamentos?.slice(0,4).map((m,i) => (
                                                    <span key={i} className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border">
                                                        {m.nombre} ({m.cantidad})
                                                    </span>
                                                ))}
                                                {(kit.medicamentos?.length > 4) && <span className="text-[10px] text-slate-400 px-1">...</span>}
                                            </div>
                                        </div>
                                        <div className="flex flex-wrap gap-2 justify-end sm:justify-center items-start">
                                            {(() => {
                                                const ccAsignado = (kit.contactCenter || '').trim().toLowerCase();
                                                const ccYo = (currentUser?.name || currentUser?.nombre || currentUser?.username || '').trim().toLowerCase();
                                                const esMiAsignado = !!ccAsignado && !!ccYo && ccAsignado === ccYo;
                                                const ccPuedeModificar = isAgenteContactCenter && esMiAsignado;
                                                const soloVisualizar = (folderSoloLectura || kit.trabajadoOperaciones) && !ccPuedeModificar;
                                                if (soloVisualizar) {
                                                    return (
                                                        <button onClick={() => openEditKit(kit, true)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-200 text-xs font-bold" title={kit.trabajadoOperaciones ? "Solo visualizaci√≥n y reimprimir vi√±etas" : "Solo visualizaci√≥n"}>
                                                            <Icons.Eye size={16}/> Visualizar
                                                        </button>
                                                    );
                                                }
                                                if (ccPuedeModificar && (folderSoloLectura || kit.trabajadoOperaciones)) {
                                                    return (
                                                        <button onClick={() => openEditKit(kit, false)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-violet-50 text-violet-700 hover:bg-violet-100 border border-violet-200 text-xs font-bold" title="Modificar informaci√≥n del kit (Contact Center)">
                                                            <Icons.Edit size={16}/> Modificar
                                                        </button>
                                                    );
                                                }
                                                return (
                                                <>
                                            <button onClick={() => openEditKit(kit, false)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect" title="Editar">
                                                <Icons.Edit size={18}/>
                                            </button>
                                            {isRevisionAsignacion && kit.deliveryMode === 'ruta' && !(kit.contactCenter && String(kit.contactCenter).trim()) && (
                                                <button onClick={() => handleEnviarAContactCenter(kit)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 hover:bg-emerald-100 border border-emerald-200 text-xs font-bold" title="Enviar a Contact Center">
                                                    Enviar a Contact Center
                                                </button>
                                            )}
                                            {isRevisionAsignacion && kit.deliveryMode === 'ventanilla' && (
                                                <button onClick={() => openEditKit(kit, false)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-turquoise-50 text-turquoise-700 hover:bg-turquoise-100 border border-turquoise-200 text-xs font-bold" title="Dispensar recetas">
                                                    <Icons.Box size={16}/> Dispensar recetas
                                                </button>
                                            )}
                                            {isRevisionAsignacion && kit.deliveryMode === 'ruta' && kit.devueltoPorContactCenter && (
                                                <button onClick={() => openEditKit(kit, false)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-turquoise-50 text-turquoise-700 hover:bg-turquoise-100 border border-turquoise-200 text-xs font-bold" title="Dispensar recetas">
                                                    <Icons.Box size={16}/> Dispensar recetas
                                                </button>
                                            )}
                                            {(userRole==='superadmin'||userRole==='admin') && (
                                                <button onClick={() => {if(confirm("¬øEliminar Kit?")) onDeleteKit(kit.id);}} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect">
                                                    <Icons.Trash size={18}/>
                                                </button>
                                            )}
                                                </>
                                                );
                                            })()}
                                        </div>
                                    </div>
                                    );
                                })}
                                {patientKits.length === 0 && (
                                    <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                                        No hay kits registrados para este paciente.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/50 backdrop-blur-md">
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                                <Icons.Users size={24}/>
                            </div>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Gesti√≥n de Pacientes</h3>
                                <p className="text-xs font-semibold text-turquoise-600">
                                    {filteredPatients.length} Registros
                                    {searchTerm.trim() && (
                                        <span className="text-slate-400 font-normal"> ‚Äî {searching ? 'buscando‚Ä¶' : (searchMode === 'firebase' ? 'resultado Firestore' : 'resultado cach√©')}</span>
                                    )}
                                    {assignedUserFilter && isAdminOrSuperadmin && (!needsTabs || activePatientTab === 'general') && (
                                        <span className="text-slate-400 font-normal"> ‚Äî filtro por usuario asignado</span>
                                    )}
                                </p>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-3 w-full md:w-auto items-center">
                            <div className="relative w-full sm:w-64">
                                <div className="absolute left-3 top-2.5 text-slate-400">
                                    <Icons.Search size={16}/>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar DNI o Nombre..." 
                                    className="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:border-turquoise-200 transition-all focus:shadow-sm" 
                                    value={searchTerm} 
                                    onChange={e=>setSearchTerm(e.target.value)} 
                                />
                            </div>
                            {isAdminOrSuperadmin && (!needsTabs || activePatientTab === 'general') && (
                                <select
                                    value={assignedUserFilter}
                                    onChange={e=>setAssignedUserFilter(e.target.value)}
                                    className="px-3 py-2.5 bg-slate-50 rounded-xl text-sm border border-slate-200 outline-none focus:border-turquoise-200 focus:ring-1 focus:ring-turquoise-100 min-w-[180px]"
                                    title="Filtrar por usuario asignado (Rev. y asignaci√≥n o Contact Center)"
                                >
                                    <option value="">Todos los usuarios asignados</option>
                                    {assignableUsersForFilter.map(u => (
                                        <option key={u.normalized} value={u.normalized}>{u.name} ({u.role})</option>
                                    ))}
                                </select>
                            )}
                            <button 
                                onClick={refreshPatients} 
                                disabled={loadingPatients}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"
                                title="Refrescar lista de pacientes desde Firebase"
                            >
                                <Icons.RefreshCw size={16} className={loadingPatients ? 'animate-spin' : ''}/> 
                                <span className="hidden sm:inline">Refrescar</span>
                            </button>
                            
                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                <div className="relative overflow-hidden">
                                    <button className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                        <Icons.FileSpreadsheet size={16}/> <span className="hidden sm:inline">Cargar DH</span>
                                    </button>
                                    <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                            )}

                            {canCreatePatients && (
                                <button onClick={()=>setShowPatientForm(true)} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                    <Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo</span>
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {needsTabs && (
                        <div className="border-b border-slate-100 px-6">
                            <div className="flex gap-4">
                                <button 
                                    onClick={() => { setActivePatientTab('general'); setSelectedFolderKey(null); setBitacoraRevFechaAbierta(null); setBitacoraRevModalSearch(''); }} 
                                    className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activePatientTab === 'general' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                                >
                                    Pacientes Generales
                                </button>
                                <button 
                                    onClick={() => { setActivePatientTab('asignados'); setSelectedFolderKey(null); setBitacoraRevFechaAbierta(null); setBitacoraRevModalSearch(''); }} 
                                    className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activePatientTab === 'asignados' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                                >
                                    Mis Asignados
                                </button>
                                {isRevisionAsignacion && (
                                    <button 
                                        onClick={() => { setActivePatientTab('bitacora'); setSelectedFolderKey(null); setSelectedPatient(null); setSelectedPatientFullData(null); }} 
                                        className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activePatientTab === 'bitacora' ? 'border-amber-500 text-amber-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                                    >
                                        Bit√°cora Rev.
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    <Modal isOpen={showPatientForm} onClose={closePatientForm} title={editingPatientId ? "Editar Paciente" : "Nuevo Derechohabiente"} maxWidth="max-w-2xl">
                        <form onSubmit={handlePatientSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">DNI <span className="text-red-500">*</span></label>
                                    <input 
                                        type="text" 
                                        required 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.dni} 
                                        onChange={e=>{ const u=toUpper(e.target.value); setPatientForm({...patientForm, dni:u, nAfiliacion:u}); }} 
                                        maxLength={15} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Afiliaci√≥n</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-slate-50" 
                                        value={patientForm.nAfiliacion} 
                                        readOnly
                                        title="La afiliaci√≥n es la misma que el DNI"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo <span className="text-red-500">*</span></label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                    value={patientForm.nombre} 
                                    onChange={e=>setPatientForm({...patientForm, nombre:toUpper(e.target.value)})} 
                                />
                            </div>
                            
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tel√©fono</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                    value={patientForm.telefono} 
                                    onChange={e=>setPatientForm({...patientForm, telefono:toUpper(e.target.value)})} 
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Familiar</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.familiar} 
                                        onChange={e=>setPatientForm({...patientForm, familiar:toUpper(e.target.value)})} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Tel. Familiar</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.telefonoFamiliar} 
                                        onChange={e=>setPatientForm({...patientForm, telefonoFamiliar:toUpper(e.target.value)})} 
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Direcci√≥n</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                    value={patientForm.direccion} 
                                    onChange={e=>setPatientForm({...patientForm, direccion:toUpper(e.target.value)})} 
                                />
                            </div>
                            
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Descripci√≥n Municipio</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                    value={patientForm.descripcionMunicipio} 
                                    onChange={e=>setPatientForm({...patientForm, descripcionMunicipio:toUpper(e.target.value)})} 
                                />
                            </div>
                            
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tipo de Afiliado</label>
                                <select 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                    value={patientForm.tipoAfiliado} 
                                    onChange={e=>setPatientForm({...patientForm, tipoAfiliado:e.target.value})}
                                >
                                    <option value="AFILIADO DIRECTO">AFILIADO DIRECTO</option>
                                    <option value="JUBILADO">JUBILADO</option>
                                    <option value="PENSIONADO">PENSIONADO</option>
                                    <option value="BENEFICIARIA PADRE">BENEFICIARIA PADRE</option>
                                    <option value="BENEFICIARIA(O) COMPA√ëERA(O)">BENEFICIARIA(O) COMPA√ëERA(O)</option>
                                    <option value="BENEFICIARIA(O) ESPOSA(O)">BENEFICIARIA(O) ESPOSA(O)</option>
                                    <option value="BENEFICIARIA(O) HIJO(A)">BENEFICIARIA(O) HIJO(A)</option>
                                </select>
                            </div>

                            {canCreatePatients && (
                                <>
                                    <div className="grid grid-cols-2 gap-4 pt-2 border-t border-slate-200">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Agente Contact Center</label>
                                            <select 
                                                className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                                value={patientForm.agenteContactCenter} 
                                                onChange={e=>setPatientForm({...patientForm, agenteContactCenter:toUpper(e.target.value)})}
                                            >
                                                <option value="">Seleccione un agente</option>
                                                {users
                                                    .filter(u => u.departamento === 'contact center' && u.rolesDepartamento?.includes('agente contact center'))
                                                    .map(u => (
                                                        <option key={u.id} value={u.nombre || u.username}>
                                                            {u.nombre || u.username}
                                                        </option>
                                                    ))
                                                }
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Usuario Revisi√≥n y Asignaci√≥n</label>
                                            <select 
                                                className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                                value={patientForm.usuarioRevisionAsignacion} 
                                                onChange={e=>setPatientForm({...patientForm, usuarioRevisionAsignacion:toUpper(e.target.value)})}
                                            >
                                                <option value="">Seleccione un usuario</option>
                                                {users
                                                    .filter(u => u.departamento === 'farmacia' && u.rolesDepartamento?.includes('revision y asignacion'))
                                                    .map(u => (
                                                        <option key={u.id} value={u.nombre || u.username}>
                                                            {u.nombre || u.username}
                                                        </option>
                                                    ))
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </>
                            )}

                            <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg mt-2 btn-hover-effect">
                                {editingPatientId ? 'Actualizar' : 'Guardar'}
                            </button>
                        </form>
                    </Modal>

                    <div className="h-full overflow-y-auto bg-white p-6">
                        {canCreatePatients && (
                            <div className="mb-4">
                                <button 
                                    onClick={() => setShowMassAssignModal(true)}
                                    className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"
                                >
                                    <Icons.Users size={16}/> Asignaci√≥n Masiva
                                </button>
                            </div>
                        )}
                        
                        {activePatientTab === 'bitacora' && isRevisionAsignacion ? (
                            <>
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                                <div className="p-4 border-b border-slate-100 bg-slate-50/50 space-y-3">
                                    <div className="flex flex-wrap items-center justify-between gap-3">
                                        <span className="font-bold text-slate-700">Bit√°cora ‚Äî Revisi√≥n y asignaci√≥n (carpetas por d√≠a trabajado)</span>
                                        <div className="flex gap-2 p-1.5 bg-amber-100 rounded-xl w-fit">
                                            <button onClick={() => { setBitacoraRevTab('creados'); setBitacoraRevFechaAbierta(null); }} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all btn-hover-effect ${bitacoraRevTab === 'creados' ? 'bg-white text-amber-800 shadow-sm' : 'text-amber-700 hover:bg-white/60'}`}>Creados y asignados</button>
                                            <button onClick={() => { setBitacoraRevTab('impresos'); setBitacoraRevFechaAbierta(null); }} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all btn-hover-effect ${bitacoraRevTab === 'impresos' ? 'bg-white text-amber-800 shadow-sm' : 'text-amber-700 hover:bg-white/60'}`}>Impresos</button>
                                        </div>
                                        <div className="relative w-full sm:w-64">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                            <input type="text" placeholder="Buscar por fecha (ej. 2025-01, ene)..." value={bitacoraRevCarpetasSearch} onChange={e=>setBitacoraRevCarpetasSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                                    {(() => {
                                        const porDia = bitacoraRevTab === 'creados' ? creadosPorDia : impresosPorDia;
                                        const t = (bitacoraRevCarpetasSearch || '').trim().toLowerCase();
                                        const filtered = !t ? porDia : porDia.filter(({ fecha }) => {
                                            const fmt = formatearFechaBitacoraRev(fecha).toLowerCase();
                                            return fmt.includes(t) || (fecha || '').toLowerCase().includes(t);
                                        });
                                        if (filtered.length === 0) return (
                                            <div className="col-span-full p-12 text-center text-slate-500">
                                                <Icons.Folder size={48} className="mx-auto mb-3 opacity-40"/>
                                                <p className="font-medium">{porDia.length === 0 ? (bitacoraRevTab === 'creados' ? 'No hay d√≠as con kits creados/asignados' : 'No hay d√≠as con kits impresos') : 'Sin resultados para la b√∫squeda'}</p>
                                                <p className="text-sm mt-1">{porDia.length === 0 ? (bitacoraRevTab === 'creados' ? 'Los kits que crees o asignes aparecer√°n agrupados por d√≠a.' : 'Los kits que imprimas aparecer√°n agrupados por d√≠a.') : 'Pruebe otro t√©rmino (ej. a√±o-mes o nombre del mes).'}</p>
                                            </div>
                                        );
                                        return filtered.map(({ fecha, kits: ks, count }) => (
                                            <button key={fecha} onClick={() => setBitacoraRevFechaAbierta(fecha)} className="flex items-center gap-3 p-4 rounded-2xl border-2 border-slate-200 hover:border-amber-400 hover:bg-amber-50/50 transition-all text-left btn-hover-effect group">
                                                <div className="p-2.5 rounded-xl bg-amber-100 text-amber-700 group-hover:bg-amber-200"><Icons.Folder size={24}/></div>
                                                <div className="min-w-0 flex-1">
                                                    <div className="font-bold text-slate-800 truncate">{formatearFechaBitacoraRev(fecha)}</div>
                                                    <div className="text-xs text-slate-500">{count} kit(s) {bitacoraRevTab === 'creados' ? 'creado(s)/asignado(s)' : 'impreso(s)'}</div>
                                                </div>
                                            </button>
                                        ));
                                    })()}
                                </div>
                            </div>
                            {bitacoraRevFechaAbierta && (
                                <Modal isOpen={true} onClose={() => { setBitacoraRevFechaAbierta(null); setBitacoraRevModalSearch(''); }} title={`Bit√°cora Rev. ‚Äî ${formatearFechaBitacoraRev(bitacoraRevFechaAbierta)} (${bitacoraRevTab === 'creados' ? 'Creados y asignados' : 'Impresos'})`} maxWidth="max-w-4xl">
                                    <div className="space-y-4">
                                        <p className="text-sm text-slate-500">Kits {bitacoraRevTab === 'creados' ? 'creados/asignados' : 'impresos'} este d√≠a. Ver / Editar para dispensar o revisar.</p>
                                        <div className="flex flex-wrap items-center gap-3">
                                            <div className="relative flex-1 min-w-[180px]">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                                <input type="text" placeholder="Buscar por nombre o DNI..." value={bitacoraRevModalSearch} onChange={e=>setBitacoraRevModalSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-sm outline-none focus:border-amber-300 focus:ring-1 focus:ring-amber-200" />
                                            </div>
                                            <span className="text-sm text-slate-500">
                                                {(() => {
                                                    const porDia = bitacoraRevTab === 'creados' ? creadosPorDia : impresosPorDia;
                                                    const kitsDia = porDia.find(d => d.fecha === bitacoraRevFechaAbierta)?.kits || [];
                                                    const plist = (allPatients && allPatients.length > 0) ? allPatients : patients;
                                                    const t = (bitacoraRevModalSearch || '').trim().toLowerCase();
                                                    const filtered = !t ? kitsDia : kitsDia.filter(k => {
                                                        const pt = (plist || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                                        const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                                                        const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                                                        return n.includes(t) || d.includes(t);
                                                    });
                                                    return filtered.length !== kitsDia.length ? `${filtered.length} de ${kitsDia.length}` : `${kitsDia.length} kit(s)`;
                                                })()}
                                            </span>
                                        </div>
                                        <div className="divide-y divide-slate-100 max-h-[50vh] overflow-y-auto rounded-xl border border-slate-100">
                                            {(() => {
                                                const porDia = bitacoraRevTab === 'creados' ? creadosPorDia : impresosPorDia;
                                                const kitsDia = porDia.find(d => d.fecha === bitacoraRevFechaAbierta)?.kits || [];
                                                const plist = (allPatients && allPatients.length > 0) ? allPatients : patients;
                                                const t = (bitacoraRevModalSearch || '').trim().toLowerCase();
                                                const filtered = !t ? kitsDia : kitsDia.filter(k => {
                                                    const pt = (plist || []).find(p => p.id === k.patientId || (p.dni && k.dni && String(p.dni).trim() === String(k.dni).trim()));
                                                    const n = (k.nombre || (pt?.nombre || '')).toLowerCase();
                                                    const d = (k.dni || (pt?.dni || '')).toString().toLowerCase();
                                                    return n.includes(t) || d.includes(t);
                                                });
                                                return filtered.map(kit => {
                                                    const pt = (plist || []).find(p => p.id === kit.patientId || (p.dni && kit.dni && String(p.dni).trim() === String(kit.dni).trim()));
                                                    return (
                                                        <div key={kit.id} className="p-4 hover:bg-slate-50/50 transition-colors flex flex-wrap items-center gap-4">
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex flex-wrap items-center gap-2">
                                                                    <span className="font-bold text-slate-800">{kit.nombre || pt?.nombre || '‚Äî'}</span>
                                                                    {!!kit.complemento && <span className="px-2 py-0.5 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold uppercase">Complemento</span>}
                                                                </div>
                                                                <div className="text-sm text-slate-500 flex flex-wrap gap-3 mt-1">
                                                                    <span>DNI: {kit.dni || pt?.dni || '‚Äî'}</span>
                                                                    <span className="font-mono">{kit.fechaArmado || '‚Äî'}</span>
                                                                    <span className={kit.deliveryMode === 'ruta' ? 'text-emerald-600 font-semibold' : 'text-indigo-600 font-semibold'}>{kit.deliveryMode === 'ruta' ? 'Ruta' : kit.deliveryMode === 'ventanilla' ? 'Ventanilla' : '‚Äî'}</span>
                                                                    <span>{(kit.medicamentos || []).length} med(s)</span>
                                                                    {kit.digitador && <span>Imprimi√≥: {kit.digitador}</span>}
                                                                </div>
                                                            </div>
                                                            <button onClick={() => openEditKit(kit, false)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-turquoise-50 text-turquoise-700 hover:bg-turquoise-100 border border-turquoise-200 text-xs font-bold" title="Ver / Editar kit">
                                                                <Icons.Edit size={16}/> Ver / Editar
                                                            </button>
                                                        </div>
                                                    );
                                                });
                                            })()}
                                        </div>
                                        <div className="flex justify-end pt-2">
                                            <button onClick={() => { setBitacoraRevFechaAbierta(null); setBitacoraRevModalSearch(''); }} className="px-6 py-2.5 rounded-xl bg-slate-600 text-white font-bold text-sm hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                        </div>
                                    </div>
                                </Modal>
                            )}
                            </>
                        ) : needsTabs && activePatientTab === 'asignados' && Object.keys(patientsByUser).length > 0 ? (
                            <div className="space-y-4">
                                {!selectedFolderKey ? (
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                        {Object.entries(patientsByUser).map(([userName, group]) => (
                                            <button
                                                key={userName}
                                                type="button"
                                                onClick={() => { setSelectedFolderKey(userName); setCarteraSearch(''); setCarteraSemFilter('all'); }}
                                                className={`bg-white p-6 rounded-2xl border-2 hover:border-turquoise-400 hover:shadow-lg cursor-pointer flex flex-col items-center text-center gap-4 transition-all group text-left ${group.canCreateInFolder ? 'border-slate-200' : 'border-slate-200 bg-slate-50/50'}`}
                                            >
                                                <div className={`p-4 rounded-2xl ${group.isCurrentUser ? 'bg-turquoise-500 text-white' : group.canCreateInFolder ? 'bg-slate-200 text-slate-600' : 'bg-slate-100 text-slate-400'} group-hover:scale-110 transition-transform`}>
                                                    <Icons.Folder size={32} />
                                                </div>
                                                <div className="w-full">
                                                    <h4 className="font-bold text-lg text-slate-800 truncate">
                                                        {group.user?.nombre || group.user?.username || group.user?.name || userName}
                                                        {group.isCurrentUser && <span className="ml-1 text-xs text-turquoise-600 font-normal">(Yo)</span>}
                                                    </h4>
                                                    <p className="text-sm text-slate-500 mt-1">{group.patients.length} paciente(s)</p>
                                                    <div className="mt-2 flex flex-wrap gap-1 justify-center">
                                                        {group.canCreateInFolder && !group.isCurrentUser && (
                                                            <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-semibold">Trabajo Compartido</span>
                                                        )}
                                                        {!group.canCreateInFolder && (
                                                            <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-semibold">Solo lectura</span>
                                                        )}
                                                    </div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                ) : (() => {
                                    const group = patientsByUser[selectedFolderKey];
                                    if (!group) return <div className="text-slate-400">Carpeta no encontrada.</div>;
                                    return (
                                        <div className="animate-in">
                                            <div className="flex items-center gap-4 mb-4">
                                                <button
                                                    type="button"
                                                    onClick={() => { setSelectedFolderKey(null); setSelectedPatient(null); setSelectedPatientFullData(null); setCarteraSearch(''); setCarteraSemFilter('all'); }}
                                                    className="p-2 rounded-xl hover:bg-slate-100 text-slate-500"
                                                >
                                                    <Icons.ArrowLeft size={20}/>
                                                </button>
                                                <div className="flex-1 flex items-center justify-between flex-wrap gap-3">
                                                    <div>
                                                        <h3 className="font-bold text-xl text-slate-800">
                                                            {group.user?.nombre || group.user?.username || group.user?.name || selectedFolderKey}
                                                            {group.isCurrentUser && <span className="ml-2 text-sm text-turquoise-600 font-normal">(Yo)</span>}
                                                        </h3>
                                                        <p className="text-sm text-slate-500">{group.patients.length} paciente(s)</p>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {group.canCreateInFolder && !group.isCurrentUser && <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-semibold">Trabajo Compartido</span>}
                                                        {!group.canCreateInFolder && <span className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-semibold">Solo lectura</span>}
                                                    </div>
                                                </div>
                                            </div>
                                            {(() => {
                                                const t = (carteraSearch || '').trim().toLowerCase();
                                                const semFilter = carteraSemFilter || 'all';
                                                const filtered = group.patients.filter(p => {
                                                    const sem = getPatientSemaphore(p);
                                                    if (semFilter !== 'all' && sem !== semFilter) return false;
                                                    if (!t) return true;
                                                    const nombre = (p.nombre || '').toLowerCase();
                                                    const dni = (p.dni || '').toString().toLowerCase();
                                                    return nombre.includes(t) || dni.includes(t);
                                                });
                                                return (
                                            <>
                                            <div className="flex flex-wrap items-center gap-3 mb-4">
                                                <div className="relative flex-1 min-w-[180px] max-w-xs">
                                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={16}/></span>
                                                    <input type="text" placeholder="Buscar por nombre o DNI..." value={carteraSearch} onChange={e=>setCarteraSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 bg-slate-50 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-300 focus:ring-1 focus:ring-turquoise-200" />
                                                </div>
                                                <div className="flex flex-wrap items-center gap-2">
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Sem√°foro:</span>
                                                    {['all','green','orange','red'].map(s => (
                                                        <button key={s} type="button" onClick={()=>setCarteraSemFilter(s)} className={`px-3 py-1.5 rounded-xl text-xs font-bold transition-all ${semFilter === s ? (s === 'all' ? 'bg-slate-200 text-slate-700' : s === 'green' ? 'bg-green-100 text-green-800' : s === 'orange' ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-800') : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                                            {s === 'all' ? 'Todos' : s === 'green' ? 'Verde' : s === 'orange' ? 'Naranja' : 'Rojo'}
                                                        </button>
                                                    ))}
                                                </div>
                                                <span className="text-sm text-slate-500">{filtered.length}{filtered.length !== group.patients.length ? ` de ${group.patients.length}` : ''}</span>
                                            </div>
                                            <div className="border border-slate-200 rounded-xl overflow-hidden bg-white">
                                                <table className="w-full">
                                                    <thead className="bg-slate-50 border-b border-slate-200">
                                                        <tr>
                                                            <th className="px-4 py-3 text-center text-xs font-bold text-slate-600 uppercase w-14">Estado</th>
                                                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase">Paciente</th>
                                                            <th className="px-6 py-3 text-left text-xs font-bold text-slate-600 uppercase">DNI</th>
                                                            <th className="px-6 py-3 text-center text-xs font-bold text-slate-600 uppercase">Kits</th>
                                                            <th className="px-6 py-3 text-right text-xs font-bold text-slate-600 uppercase">Acci√≥n</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-50">
                                                        {filtered.length === 0 ? (
                                                            <tr>
                                                                <td colSpan={5} className="px-6 py-8 text-center text-sm text-slate-400">{group.patients.length === 0 ? 'Sin pacientes asignados' : 'Sin resultados para b√∫squeda o filtro de sem√°foro'}</td>
                                                            </tr>
                                                        ) : (
                                                            filtered.map(p => {
                                                                const countKits = kits.filter(k => k.patientId === p.id).length;
                                                                const sem = getPatientSemaphore(p);
                                                                const titleRev = sem === 'green' ? 'Sin pendientes' : sem === 'orange' ? 'Esperando devoluci√≥n de Contact Center' : 'Devuelto por CC ‚Äì falta marcar receta impresa';
                                                                const titleCC = sem === 'red' ? 'Kit nuevo ‚Äì confirmar informaci√≥n' : 'Todo trabajado';
                                                                const title = isRevisionAsignacion ? titleRev : isAgenteContactCenter ? titleCC : '';
                                                                return (
                                                                    <tr key={p.id} onClick={() => handleSelectPatient(p)} className="row-hover-effect cursor-pointer">
                                                                        <td className="px-4 py-4 text-center" title={title}>
                                                                            <span className={`inline-flex w-3 h-3 rounded-full ${sem === 'green' ? 'bg-green-500' : sem === 'orange' ? 'bg-amber-500' : 'bg-red-500'}`} />
                                                                        </td>
                                                                        <td className="px-6 py-4">
                                                                            <div className="font-bold text-sm text-slate-800">{p.nombre}</div>
                                                                            {getLastDeliveryDate(p) && <div className="text-[10px] text-slate-400 mt-0.5">√ölt. entrega: {getLastDeliveryDate(p)}</div>}
                                                                        </td>
                                                                        <td className="px-6 py-4">
                                                                            <div className="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit">{p.dni}</div>
                                                                        </td>
                                                                        <td className="px-6 py-4 text-center">
                                                                            <span className="bg-blue-50 text-blue-600 px-2 py-1 rounded-full text-xs font-bold">{countKits}</span>
                                                                        </td>
                                                                        <td className="px-6 py-4 text-right" onClick={(e)=>e.stopPropagation()}>
                                                                            {canCreatePatients && !folderSoloLectura ? (
                                                                                <button onClick={(e) => openEditPatient(e, p)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect" title="Editar informaci√≥n del paciente (solo admin)">
                                                                                    <Icons.Edit size={18}/>
                                                                                </button>
                                                                            ) : (
                                                                                <span className="text-slate-300 p-2 inline-block cursor-not-allowed" title={folderSoloLectura ? 'Solo visualizaci√≥n. Active Trabajo compartido para este usuario.' : 'Solo el administrador puede editar la informaci√≥n del paciente'}>
                                                                                    <Icons.Edit size={18}/>
                                                                                </span>
                                                                            )}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                            </>
                                                );
                                            })()}
                                        </div>
                                    );
                                })()}
                            </div>
                        ) : (
                            <>
                                {(!searchTerm.trim()) && (
                                    <div className="mb-4 flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                                        <div className="text-sm text-slate-600">
                                            Mostrando {currentPatients.length ? (indexOfFirstPatient + 1) : 0}-{indexOfLastPatient} (P√°gina {currentPage}) ‚Äî {currentPatients.length} pacientes cargados
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={async () => {
                                                    if (currentPage === 1) return;
                                                    const prevPage = Math.max(1, currentPage - 1);
                                                    setCurrentPage(prevPage);
                                                    await loadPatients(prevPage);
                                                }}
                                                disabled={currentPage === 1}
                                                className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                            >
                                                Anterior
                                            </button>
                                            <span className="px-3 py-1 text-sm text-slate-700">
                                                P√°gina {currentPage}
                                            </span>
                                            <button
                                                onClick={async () => {
                                                    if (!hasNextPage) return;
                                                    const nextPage = currentPage + 1;
                                                    setCurrentPage(nextPage);
                                                    await loadPatients(nextPage);
                                                }}
                                                disabled={!hasNextPage}
                                                className={`px-3 py-1 rounded-lg text-sm font-medium ${!hasNextPage ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                            >
                                                Siguiente
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse min-w-[800px]">
                                        <thead className="bg-slate-50/80 sticky top-0 z-10">
                                            <tr className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                                <th className="px-6 py-4 pl-8">Paciente</th>
                                                <th className="px-6 py-4">Identificaci√≥n</th>
                                                <th className="px-6 py-4 text-center">N¬∞ Kits</th>
                                                <th className="px-6 py-4 text-right pr-8">Acci√≥n</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {currentPatients.map(p => {
                                                const countKits = kits.filter(k => k.patientId === p.id).length;
                                                return (
                                                    <tr key={p.id} onClick={() => handleSelectPatient(p)} className={`row-hover-effect cursor-pointer`}>
                                                        <td className="px-6 py-5 pl-8">
                                                            <div className="font-bold text-base text-slate-800 tracking-tight">{p.nombre}</div>
                                                            <div className="text-xs text-turquoise-600 font-medium mt-1 flex items-center gap-1">
                                                                Ver Detalle <Icons.ChevronsRight size={14}/>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5">
                                                            <div className="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit mb-1 font-bold">{p.dni}</div>
                                                            <div className="text-xs text-slate-400">{p.tipoAfiliado}</div>
                                                        </td>
                                                        <td className="px-6 py-5 text-center">
                                                            <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">{countKits}</span>
                                                        </td>
                                                        <td className="px-6 py-5 text-right pr-8" onClick={(e)=>e.stopPropagation()}>
                                                            <div className="flex justify-end gap-2">
                                                                {canCreatePatients ? (
                                                                    <button onClick={(e) => openEditPatient(e, p)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect" title="Editar informaci√≥n del paciente (solo admin)">
                                                                        <Icons.Edit size={20}/>
                                                                    </button>
                                                                ) : (
                                                                    <span className="text-slate-200 p-2 inline-block cursor-not-allowed" title="Solo el administrador puede editar la informaci√≥n del paciente">
                                                                        <Icons.Edit size={20}/>
                                                                    </span>
                                                                )}
                                                                {(userRole==='superadmin'||userRole==='admin') && (
                                                                    <button onClick={()=>setConfirmData({ title: 'Eliminar', msg: `¬øEliminar a ${p.nombre}?`, action: async () => { await onDeletePatient(p.id); await loadPatients(currentPage, true); } })} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect">
                                                                        <Icons.Trash size={20}/>
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </>
                        )}

                        {/* Paginaci√≥n num√©rica removida: ahora es paginaci√≥n real Firestore (Anterior/Siguiente) */}
                    </div>
                    
                    <Modal isOpen={showMassAssignModal} onClose={() => setShowMassAssignModal(false)} title="Asignaci√≥n Masiva de Pacientes" maxWidth="max-w-2xl">
                        <MassAssignForm 
                            users={users} 
                            onAssign={async (dept, role, userId, dnis) => {
                                try {
                                    if (!firebaseInitialized || !db) {
                                        throw new Error("Base de datos no disponible");
                                    }
                                    
                                    const targetUser = users.find(u => u.id === userId);
                                    if (!targetUser) {
                                        throw new Error("Usuario no encontrado");
                                    }
                                    
                                    const userName = targetUser.nombre || targetUser.username;
                                    let fieldToUpdate = '';
                                    if (dept === 'contact center' && role === 'agente contact center') {
                                        fieldToUpdate = 'agenteContactCenter';
                                    } else if (dept === 'farmacia' && role === 'revision y asignacion') {
                                        fieldToUpdate = 'usuarioRevisionAsignacion';
                                    } else {
                                        throw new Error("Combinaci√≥n de departamento y rol no v√°lida");
                                    }
                                    
                                    const dnisArray = dnis.split(/\r?\n/).map(d => d.trim()).filter(d => d);
                                    if (dnisArray.length === 0) {
                                        throw new Error("No se proporcionaron DNIs");
                                    }
                                    
                                    const batch = db.batch();
                                    let found = 0;
                                    let notFound = [];
                                    
                                    for (const dni of dnisArray) {
                                        const patientsSnapshot = await db.collection('prod_patients')
                                            .where('dni', '==', dni)
                                            .limit(1)
                                            .get();
                                        
                                        if (!patientsSnapshot.empty) {
                                            const patientDoc = patientsSnapshot.docs[0];
                                            batch.update(patientDoc.ref, { [fieldToUpdate]: userName });
                                            found++;
                                        } else {
                                            notFound.push(dni);
                                        }
                                    }
                                    
                                    await batch.commit();
                                    
                                    let message = `‚úÖ ${found} paciente(s) asignado(s) exitosamente a ${userName}`;
                                    if (notFound.length > 0) {
                                        message += `\n\n‚ö†Ô∏è ${notFound.length} DNI(s) no encontrado(s):\n${notFound.join(', ')}`;
                                    }
                                    
                                    alert(message);
                                    setShowMassAssignModal(false);
                                    // Recargar pacientes y actualizar allPatients si est√° en pesta√±a asignados
                                    await loadPatients(currentPage, true);
                                    if (needsTabs && activePatientTab === 'asignados') {
                                        const querySnapshot = await db.collection('prod_patients')
                                            .orderBy('dni', 'asc')
                                            .get();
                                        const allPats = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                                        setAllPatients(allPats);
                                    }
                                } catch (error) {
                                    alert('Error en asignaci√≥n masiva: ' + error.message);
                                }
                            }}
                        />
                    </Modal>
                </div>
            );
        };

        // --- BLOCK: CONFIGURACION ---
        const ConfigBlock = ({ medicines, onAddList, contacts, onAddContact, onDeleteContact, rutaTemplateCurrent, importRutaTemplateFromExcel, importRutaTemplateFromWord, importRutaTemplateFromPDF, saveRutaTemplate, loadRutaTemplateCurrent, onMedicinesUpdated }) => {
            const [rawText, setRawText] = useState('');
            const [newMedCodigo, setNewMedCodigo] = useState('');
            const [newMedNombre, setNewMedNombre] = useState('');
            const [newMedTipo, setNewMedTipo] = useState('no cronico');
            const [activeTab, setActiveTab] = useState('medicamentos');
            const [localRutaTemplate, setLocalRutaTemplate] = useState(rutaTemplateCurrent);
            
            // Sincronizar con prop cuando cambie
            useEffect(() => {
                setLocalRutaTemplate(rutaTemplateCurrent);
            }, [rutaTemplateCurrent]);
            
            // Cargar plantilla al montar
            useEffect(() => {
                if (loadRutaTemplateCurrent) {
                    loadRutaTemplateCurrent();
                }
            }, []);

            const processText = async () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const processedMeds = [];
                
                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return;
                    
                    // Formato CSV: ID,CODIGO,NOMBRE,TIPO o CODIGO,NOMBRE,TIPO o CODIGO,NOMBRE o solo NOMBRE
                    // Manejar comas dentro de comillas si existen
                    const parts = [];
                    let currentPart = '';
                    let insideQuotes = false;
                    
                    for (let i = 0; i < trimmed.length; i++) {
                        const char = trimmed[i];
                        if (char === '"') {
                            insideQuotes = !insideQuotes;
                        } else if (char === ',' && !insideQuotes) {
                            parts.push(currentPart.trim());
                            currentPart = '';
                        } else {
                            currentPart += char;
                        }
                    }
                    parts.push(currentPart.trim()); // Agregar la √∫ltima parte
                    
                    // Limpiar comillas de los valores
                    const cleanParts = parts.map(p => p.replace(/^"|"$/g, '').trim());
                    
                    let med = { id: null, codigo: '', name: '', tipo: 'no cronico' };
                    
                    if (cleanParts.length >= 4) {
                        // Formato completo con ID: ID,CODIGO,NOMBRE,TIPO
                        med.id = cleanParts[0];
                        med.codigo = cleanParts[1].toUpperCase();
                        med.name = cleanParts[2].toUpperCase();
                        const tipo = cleanParts[3].toLowerCase();
                        const tiposValidos = ['controlado', 'cronico', 'no cronico', 'oncologico'];
                        med.tipo = tiposValidos.includes(tipo) ? tipo : 'no cronico';
                    } else if (cleanParts.length === 3) {
                        // Formato: CODIGO,NOMBRE,TIPO
                        med.codigo = cleanParts[0].toUpperCase();
                        med.name = cleanParts[1].toUpperCase();
                        const tipo = cleanParts[2].toLowerCase();
                        const tiposValidos = ['controlado', 'cronico', 'no cronico', 'oncologico'];
                        med.tipo = tiposValidos.includes(tipo) ? tipo : 'no cronico';
                    } else if (cleanParts.length === 2) {
                        // Formato: CODIGO,NOMBRE
                        med.codigo = cleanParts[0].toUpperCase();
                        med.name = cleanParts[1].toUpperCase();
                    } else {
                        // Formato antiguo: solo NOMBRE (compatibilidad)
                        med.name = trimmed.toUpperCase();
                    }
                    
                    processedMeds.push(med);
                });
                
                // Eliminar duplicados y verificar contra medicamentos existentes
                const uniqueMeds = [];
                const seen = new Set();
                const existingMedsMap = new Map();
                
                // Crear mapa de medicamentos existentes por ID, c√≥digo y nombre
                (medicines || []).forEach(m => {
                    if (m.id) existingMedsMap.set(m.id.toLowerCase(), m);
                    if (m.codigo && m.codigo.trim()) existingMedsMap.set(`codigo:${m.codigo.toLowerCase()}`, m);
                    if (m.name && m.name.trim()) existingMedsMap.set(`name:${m.name.toLowerCase()}`, m);
                });
                
                processedMeds.forEach(med => {
                    if (!med.name || !med.name.trim()) return; // Saltar si no tiene nombre
                    
                    let key = '';
                    let existingMed = null;
                    
                    // Prioridad: ID > c√≥digo > nombre
                    if (med.id && med.id.trim()) {
                        key = med.id.toLowerCase();
                        existingMed = existingMedsMap.get(key);
                    } else if (med.codigo && med.codigo.trim()) {
                        key = `codigo:${med.codigo.toLowerCase()}`;
                        existingMed = existingMedsMap.get(key);
                        if (!existingMed) {
                            key = med.codigo.toLowerCase();
                        }
                    } else if (med.name && med.name.trim()) {
                        key = `name:${med.name.toLowerCase()}`;
                        existingMed = existingMedsMap.get(key);
                        if (!existingMed) {
                            key = med.name.toLowerCase();
                        }
                    }
                    
                    // Solo agregar si no se ha procesado antes en esta lista
                    if (key && !seen.has(key)) {
                        seen.add(key);
                        // Si existe en la base de datos, usar el ID existente para actualizaci√≥n
                        if (existingMed && existingMed.id) {
                            med.id = existingMed.id;
                        }
                        uniqueMeds.push(med);
                    }
                });
                
                if(uniqueMeds.length > 0) { 
                    const conId = uniqueMeds.filter(m => m.id).length;
                    const sinId = uniqueMeds.length - conId;
                    await onAddList(uniqueMeds); 
                    setRawText(''); 
                    let mensaje = `Se procesaron ${uniqueMeds.length} medicamento(s).\n`;
                    if (conId > 0) mensaje += `- ${conId} se actualizar√°n (tienen ID)\n`;
                    if (sinId > 0) mensaje += `- ${sinId} se crear√°n como nuevos`;
                    alert(mensaje); 
                } else {
                    alert('No se encontraron medicamentos v√°lidos para procesar.');
                }
            };

            const addSingle = (e) => {
                e.preventDefault();
                if(newMedNombre.trim()) {
                    const med = {
                        codigo: newMedCodigo.trim().toUpperCase() || '',
                        name: newMedNombre.trim().toUpperCase(),
                        tipo: newMedTipo
                    };
                    onAddList([med]);
                    setNewMedCodigo('');
                    setNewMedNombre('');
                    setNewMedTipo('no cronico');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                            <Icons.Settings size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-xl text-slate-800 brand-font">Configuraci√≥n</h3>
                            <p className="text-xs font-semibold text-turquoise-600">Cat√°logos del Sistema</p>
                        </div>
                    </div>
                    
                    <div className="border-b border-slate-100 px-6">
                        <div className="flex gap-4">
                            <button 
                                onClick={() => setActiveTab('medicamentos')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'medicamentos' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Box className="inline mr-2" size={16}/> Medicamentos
                            </button>
                            <button 
                                onClick={() => setActiveTab('plantillas')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'plantillas' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Layout className="inline mr-2" size={16}/> Plantillas
                            </button>
                        </div>
                    </div>
                    
                    <div className="p-6 overflow-y-auto space-y-8">
                        {activeTab === 'medicamentos' && (
                            <div>
                                <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2">
                                    <Icons.Box size={16}/> Medicamentos
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <h4 className="font-bold text-slate-700 mb-3 text-xs uppercase tracking-wider">Agregar Individual</h4>
                                            <form onSubmit={addSingle} className="space-y-3">
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">C√≥digo</label>
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2 rounded-lg border text-sm uppercase outline-none focus:border-turquoise-400" 
                                                        placeholder="C√≥digo del medicamento..." 
                                                        value={newMedCodigo} 
                                                        onChange={e=>setNewMedCodigo(e.target.value)} 
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Nombre del Medicamento *</label>
                                                    <input 
                                                        type="text" 
                                                        className="w-full p-2 rounded-lg border text-sm uppercase outline-none focus:border-turquoise-400" 
                                                        placeholder="Nombre del medicamento..." 
                                                        value={newMedNombre} 
                                                        onChange={e=>setNewMedNombre(e.target.value)} 
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tipo</label>
                                                    <select 
                                                        className="w-full p-2 rounded-lg border text-sm outline-none focus:border-turquoise-400 bg-white" 
                                                        value={newMedTipo} 
                                                        onChange={e=>setNewMedTipo(e.target.value)}
                                                    >
                                                        <option value="no cronico">No Cr√≥nico</option>
                                                        <option value="cronico">Cr√≥nico</option>
                                                        <option value="controlado">Controlado</option>
                                                        <option value="oncologico">Oncol√≥gico</option>
                                                    </select>
                                                </div>
                                                <button type="submit" className="w-full bg-turquoise-600 text-white p-2.5 rounded-lg hover:bg-turquoise-700 btn-hover-effect flex items-center justify-center gap-2 font-bold">
                                                    <Icons.Plus size={18}/> Agregar Medicamento
                                                </button>
                                            </form>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Carga Masiva</h4>
                                            <p className="text-xs text-slate-400 mb-2">Formato CSV: ID,CODIGO,NOMBRE,TIPO o CODIGO,NOMBRE,TIPO (uno por l√≠nea)</p>
                                            <p className="text-xs text-slate-400 mb-2">Tipos v√°lidos: controlado, cronico, no cronico, oncologico</p>
                                            <p className="text-xs text-amber-600 mb-2 font-semibold">üí° Si incluye ID, actualiza el medicamento existente. Si no, crea uno nuevo.</p>
                                            <textarea 
                                                className="w-full h-32 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-turquoise-400" 
                                                placeholder="abc123xyz,ABC123,AMOXICILINA 500MG,no cronico&#10;XYZ789,PARACETAMOL,cronico&#10;DEF456,MORFINA,controlado&#10;GHI012,CISPLATINO,oncologico" 
                                                value={rawText} 
                                                onChange={e => setRawText(e.target.value)}
                                            ></textarea>
                                            <button 
                                                onClick={processText} 
                                                className="mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-slate-900 w-full btn-hover-effect flex justify-center gap-2 items-center"
                                            >
                                                <Icons.Upload size={16}/> Procesar Lista
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Cat√°logo Actual ({medicines.length})</h4>
                                        <div className="h-full max-h-[400px] overflow-y-auto border rounded-xl bg-white p-2 space-y-1">
                                            {medicines.map((m, i) => (
                                                <div key={i} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0">
                                                    <div className="flex items-start justify-between gap-2">
                                                        <div className="flex-1 min-w-0">
                                                            {m.codigo && (
                                                                <span className="text-slate-500 font-mono text-[10px] block mb-1">C√≥digo: {m.codigo}</span>
                                                            )}
                                                            <span className="font-bold text-slate-800 uppercase block">{m.name || m.nombre || '‚Äî'}</span>
                                                            <span className="text-slate-500 text-[10px] mt-1 block">
                                                                Tipo: <span className="font-semibold capitalize">{m.tipo || 'no cronico'}</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'plantillas' && (
                            <div>
                                <div className="flex items-center justify-between mb-4 border-b pb-2">
                                    <h4 className="font-bold text-slate-700 text-xs uppercase tracking-wider flex items-center gap-2">
                                        <Icons.Layout size={16}/> Plantilla RUTA
                                    </h4>
                                    <button
                                        onClick={async () => {
                                            if (loadRutaTemplateCurrent) {
                                                try {
                                                    await loadRutaTemplateCurrent();
                                                    alert('‚úÖ Plantilla recargada desde la base de datos');
                                                } catch (error) {
                                                    console.error('Error recargando plantilla:', error);
                                                    alert('‚ö†Ô∏è Error al recargar plantilla: ' + error.message);
                                                }
                                            }
                                        }}
                                        className="text-xs px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-bold transition flex items-center gap-1"
                                        title="Recargar plantilla desde la base de datos"
                                    >
                                        <Icons.RefreshCw size={12}/> Recargar
                                    </button>
                                </div>
                                <div className="space-y-6">
                                    {/* Estado de conexi√≥n */}
                                    <div className={`p-3 rounded-xl border ${firebaseInitialized && db ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                        <div className="flex items-center gap-2">
                                            <div className={`w-2 h-2 rounded-full ${firebaseInitialized && db ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                            <span className={`text-xs font-bold ${firebaseInitialized && db ? 'text-green-700' : 'text-red-700'}`}>
                                                {firebaseInitialized && db ? '‚úÖ Conectado a la base de datos' : '‚ö†Ô∏è Sin conexi√≥n a la base de datos'}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <h5 className="font-bold text-slate-700 mb-3 text-xs uppercase">Subir Plantilla desde Excel</h5>
                                        <p className="text-xs text-slate-500 mb-4">
                                            Dise√±a tu vi√±eta en Excel (.xlsx) con celdas combinadas, bordes y tokens como {'{'}{'{'}NOMBRE{'}'}{'}'}, {'{'}{'{'}DNI{'}'}{'}'}, {'{'}{'{'}DIRECCION_ENTREGA{'}'}{'}'}, etc.
                                        </p>
                                        <input 
                                            type="file" 
                                            accept=".xlsx,.xls" 
                                            id="rutaTemplateUpload"
                                            className="hidden"
                                            onChange={async (e) => {
                                                const file = e.target.files[0];
                                                if (!file) return;
                                                try {
                                                    if (!firebaseInitialized || !db) {
                                                        throw new Error('No hay conexi√≥n a la base de datos. Por favor, verifique su conexi√≥n.');
                                                    }
                                                    const templateData = await importRutaTemplateFromExcel(file);
                                                    await saveRutaTemplate(templateData, true);
                                                    // Recargar plantilla despu√©s de guardar
                                                    if (loadRutaTemplateCurrent) {
                                                        await loadRutaTemplateCurrent();
                                                    }
                                                    alert('‚úÖ Plantilla RUTA importada y guardada correctamente en la base de datos.');
                                                    e.target.value = '';
                                                } catch (error) {
                                                    console.error('Error importando plantilla:', error);
                                                    alert('‚ùå Error al importar plantilla: ' + error.message);
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                        <button 
                                            onClick={() => document.getElementById('rutaTemplateUpload').click()}
                                            className="w-full bg-turquoise-600 text-white py-3 rounded-lg font-bold text-xs hover:bg-turquoise-700 transition flex items-center justify-center gap-2 shadow-sm"
                                        >
                                            <Icons.Upload size={16}/> Subir Excel (.xlsx)
                                        </button>
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <h5 className="font-bold text-slate-700 mb-3 text-xs uppercase">Subir Plantilla desde Word</h5>
                                        <p className="text-xs text-slate-500 mb-4">
                                            Suba un archivo Word (.docx) con tokens como {'{'}{'{'}NOMBRE{'}'}{'}'}, {'{'}{'{'}DNI{'}'}{'}'}, {'{'}{'{'}DIRECCION_ENTREGA{'}'}{'}'}, etc.
                                        </p>
                                        <input 
                                            type="file" 
                                            accept=".docx" 
                                            id="rutaTemplateUploadWord"
                                            className="hidden"
                                            onChange={async (e) => {
                                                const file = e.target.files[0];
                                                if (!file) return;
                                                try {
                                                    if (!firebaseInitialized || !db) {
                                                        throw new Error('No hay conexi√≥n a la base de datos. Por favor, verifique su conexi√≥n.');
                                                    }
                                                    if (!importRutaTemplateFromWord) {
                                                        throw new Error('Importaci√≥n Word no disponible');
                                                    }
                                                    const templateData = await importRutaTemplateFromWord(file);
                                                    await saveRutaTemplate(templateData, true);
                                                    if (loadRutaTemplateCurrent) {
                                                        await loadRutaTemplateCurrent();
                                                    }
                                                    alert('‚úÖ Plantilla RUTA (Word) importada y guardada correctamente en la base de datos.');
                                                    e.target.value = '';
                                                } catch (error) {
                                                    console.error('Error importando plantilla Word:', error);
                                                    alert('‚ùå Error al importar plantilla Word: ' + error.message);
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                        <button 
                                            onClick={() => document.getElementById('rutaTemplateUploadWord').click()}
                                            className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold text-xs hover:bg-indigo-700 transition flex items-center justify-center gap-2 shadow-sm"
                                        >
                                            <Icons.Upload size={16}/> Subir Word (.docx)
                                        </button>
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <h5 className="font-bold text-slate-700 mb-3 text-xs uppercase">Subir Plantilla desde PDF (con Gemini AI)</h5>
                                        <p className="text-xs text-slate-500 mb-4">
                                            Suba un archivo PDF y Gemini 3.0 analizar√° autom√°ticamente la estructura y tokens. El estilo original se preservar√°.
                                        </p>
                                        <input 
                                            type="file" 
                                            accept=".pdf" 
                                            id="rutaTemplateUploadPDF"
                                            className="hidden"
                                            onChange={async (e) => {
                                                const file = e.target.files[0];
                                                if (!file) return;
                                                try {
                                                    if (!firebaseInitialized || !db) {
                                                        throw new Error('No hay conexi√≥n a la base de datos. Por favor, verifique su conexi√≥n.');
                                                    }
                                                    if (!importRutaTemplateFromPDF) {
                                                        throw new Error('Importaci√≥n PDF no disponible');
                                                    }
                                                    
                                                    // Mostrar loading
                                                    alert('üîÑ Analizando PDF... Esto puede tomar unos segundos.');
                                                    
                                                    const templateData = await importRutaTemplateFromPDF(file);
                                                    await saveRutaTemplate(templateData, true);
                                                    if (loadRutaTemplateCurrent) {
                                                        await loadRutaTemplateCurrent();
                                                    }
                                                    
                                                    const tokensFound = templateData.metadata?.tokensFound || [];
                                                    const tokensList = tokensFound.length > 0 ? tokensFound.join(', ') : 'Ninguno detectado';
                                                    
                                                    // Mostrar mensaje seg√∫n el m√©todo de an√°lisis usado
                                                    if (templateData.metadata?.analysisMethod === 'local') {
                                                        alert(`üìÑ PDF importado en modo local.\n\nTokens detectados: ${tokensList}\n\n${templateData.metadata.aiError ? '‚ö†Ô∏è SDK de IA no disponible: ' + templateData.metadata.aiError : '‚ÑπÔ∏è Se us√≥ an√°lisis local (sin IA).'}\n\nLa plantilla se guard√≥ correctamente en la base de datos.`);
                                                    } else {
                                                        alert(`‚úÖ Plantilla RUTA (PDF) importada y analizada con IA (Gemini).\n\nTokens detectados: ${tokensList}\n\nLa plantilla se guard√≥ correctamente en la base de datos.`);
                                                    }
                                                    e.target.value = '';
                                                } catch (error) {
                                                    console.error('Error importando plantilla PDF:', error);
                                                    alert('‚ùå Error al importar plantilla PDF: ' + error.message);
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                        <button 
                                            onClick={() => document.getElementById('rutaTemplateUploadPDF').click()}
                                            className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold text-xs hover:bg-purple-700 transition flex items-center justify-center gap-2 shadow-sm"
                                        >
                                            <Icons.Upload size={16}/> Subir PDF con Gemini AI (.pdf)
                                        </button>
                                    </div>
                                    
                                    {(localRutaTemplate || rutaTemplateCurrent) && (
                                        <div className="bg-green-50 p-4 rounded-xl border border-green-200">
                                            <div className="flex items-center justify-between mb-2">
                                                <h5 className="font-bold text-green-700 text-xs uppercase">Plantilla Actual Activa</h5>
                                                <span className="bg-green-500 text-white text-[10px] px-2 py-1 rounded-full font-bold">ACTIVA</span>
                                            </div>
                                            <p className="text-xs text-green-600 mb-2">
                                                <strong>Archivo:</strong> {(localRutaTemplate || rutaTemplateCurrent)?.metadata?.sourceFile || 'N/A'}<br/>
                                                <strong>Importada:</strong> {(localRutaTemplate || rutaTemplateCurrent)?.metadata?.importedAt ? new Date((localRutaTemplate || rutaTemplateCurrent).metadata.importedAt).toLocaleString('es-ES') : 'N/A'}<br/>
                                                <strong>Elementos:</strong> {((localRutaTemplate || rutaTemplateCurrent)?.elements?.length || 0)} celdas configuradas
                                            </p>
                                        </div>
                                    )}
                                    
                                    {!localRutaTemplate && !rutaTemplateCurrent && (
                                        <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                            <p className="text-xs text-yellow-700">
                                                ‚ö†Ô∏è No hay plantilla RUTA configurada. Suba un archivo Excel para comenzar.
                                            </p>
                                        </div>
                                    )}
                                    
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <h5 className="font-bold text-slate-700 mb-3 text-xs uppercase">Tokens Disponibles</h5>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}NOMBRE{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}DNI{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}GPS_STATUS{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}TELEFONOS{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}TEL_PERSONAL{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}TEL_FAMILIAR{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}TEL_PERSONAL_BOX{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}TEL_FAMILIAR_BOX{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}MEDS_COUNT{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}DIRECCION_ENTREGA{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}INSTRUCCIONES_ENTREGA{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}CONTACT_CENTER{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}FECHA_ENTREGA{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}REFRIGERADO{'}'}{'}'}</code></div>
                                            <div className="bg-white p-2 rounded border"><code className="text-turquoise-600 font-mono">{'{'}{'{'}QR_MAPS{'}'}{'}'}</code></div>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-3">
                                            Escribe estos tokens exactamente en las celdas de Excel donde quieras que aparezcan los datos.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: USUARIOS ---
        const UserManagementBlock = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [userSearch, setUserSearch] = useState('');
            const [formData, setFormData] = useState({ 
                username: '', 
                password: '', 
                role: 'digitador', 
                nombre: '', 
                departamento: '', 
                rolesDepartamento: [], 
                restriccionHorario: false,
                diasPermitidos: {
                    lunes: false,
                    martes: false,
                    miercoles: false,
                    jueves: false,
                    viernes: false,
                    sabado: false,
                    domingo: false
                },
                horaInicio: '08:00',
                horaFin: '18:00',
                telefono: ''
            });
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            const [showReassignModal, setShowReassignModal] = useState(false);
            const [reassigningUser, setReassigningUser] = useState(null);
            const [reassignTargetUser, setReassignTargetUser] = useState('');
            const [showMassAssignModal, setShowMassAssignModal] = useState(false);

            // Configuraci√≥n de roles por departamento
            const rolesPorDepartamento = {
                'admin': ['superadmin'],
                'farmacia': ['supervisor', 'revision y asignacion', 'despacho medicamentos'],
                'contact center': ['agente contact center', 'supervisor'],
                'operaciones': ['operador de empaque', 'supervisor'],
                'calidad': ['agente de calidad', 'supervisor'],
                'logistica': ['asignador de rutas despacho logistica', 'supervisor'],
                'delivery': ['supervisor', 'motorista']
            };

            const departamentos = Object.keys(rolesPorDepartamento);
            const diasSemana = [
                { key: 'lunes', label: 'Lunes' },
                { key: 'martes', label: 'Martes' },
                { key: 'miercoles', label: 'Mi√©rcoles' },
                { key: 'jueves', label: 'Jueves' },
                { key: 'viernes', label: 'Viernes' },
                { key: 'sabado', label: 'S√°bado' },
                { key: 'domingo', label: 'Domingo' }
            ];

            const openNew = () => { 
                setEditingId(null); 
                const initialRoles = [];
                const initialRole = getSystemRoleFromDepartmentRoles(initialRoles);
                setFormData({ 
                    username: '', 
                    password: '', 
                    role: initialRole, // Inicializar con el rol calculado
                    nombre: '', 
                    departamento: '', 
                    rolesDepartamento: initialRoles, 
                    restriccionHorario: false,
                    diasPermitidos: {
                        lunes: false,
                        martes: false,
                        miercoles: false,
                        jueves: false,
                        viernes: false,
                        sabado: false,
                        domingo: false
                    },
                    horaInicio: '08:00',
                    horaFin: '18:00',
                    telefono: ''
                }); 
                setShowModal(true); 
            };
            
            const openEdit = (u) => { 
                setEditingId(u.id); 
                const rolesDept = u.rolesDepartamento || [];
                // Recalcular el rol del sistema desde los roles del departamento
                const calculatedRole = getSystemRoleFromDepartmentRoles(rolesDept);
                setFormData({
                    ...u,
                    role: calculatedRole, // Asegurar que el rol est√© actualizado
                    rolesDepartamento: rolesDept,
                    restriccionHorario: u.restriccionHorario || false,
                    diasPermitidos: u.diasPermitidos || {
                        lunes: false,
                        martes: false,
                        miercoles: false,
                        jueves: false,
                        viernes: false,
                        sabado: false,
                        domingo: false
                    },
                    horaInicio: u.horaInicio || '08:00',
                    horaFin: u.horaFin || '18:00',
                    telefono: u.telefono || ''
                }); 
                setShowModal(true); 
            };
            
            const closeModal = () => { 
                setShowModal(false); 
                setEditingId(null); 
            };

            const filteredUsers = useMemo(() => {
                const t = (userSearch || '').trim().toLowerCase();
                if (!t) return users || [];
                return (users || []).filter(u => {
                    const nombre = (u.nombre || '').toLowerCase();
                    const username = (u.username || '').toLowerCase();
                    const dept = (u.departamento || '').toLowerCase();
                    const roles = (u.rolesDepartamento || []).map(r => (r || '').toLowerCase());
                    return nombre.includes(t) || username.includes(t) || dept.includes(t) || roles.some(r => r.includes(t));
                });
            }, [users, userSearch]);

            const handleDepartamentoChange = (dept) => {
                const newRoles = []; // Limpiar roles al cambiar departamento
                const systemRole = getSystemRoleFromDepartmentRoles(newRoles);
                setFormData({
                    ...formData,
                    departamento: dept,
                    rolesDepartamento: newRoles,
                    role: systemRole, // Actualizar el rol del sistema
                    telefono: '' // Limpiar tel√©fono al cambiar departamento
                });
            };

            // Mapeo de roles del departamento a roles del sistema
            const getSystemRoleFromDepartmentRoles = (roles) => {
                if (!roles || roles.length === 0) return 'digitador';
                
                // Prioridad: superadmin > admin > supervisor > otros
                if (roles.includes('superadmin')) return 'superadmin';
                if (roles.includes('admin')) return 'admin';
                if (roles.some(r => r.includes('supervisor'))) return 'supervisor';
                
                // Para otros roles, usar 'digitador' como base
                return 'digitador';
            };

            const handleRoleToggle = (role) => {
                const currentRoles = formData.rolesDepartamento || [];
                let newRoles;
                if (currentRoles.includes(role)) {
                    newRoles = currentRoles.filter(r => r !== role);
                } else {
                    newRoles = [...currentRoles, role];
                }
                
                // Determinar el rol del sistema basado en los roles del departamento
                const systemRole = getSystemRoleFromDepartmentRoles(newRoles);
                
                // Si se deselecciona "agente contact center", limpiar el tel√©fono
                const eraAgenteContactCenter = formData.departamento === 'contact center' && 
                                                currentRoles.includes('agente contact center');
                const sigueSiendoAgente = formData.departamento === 'contact center' && 
                                          newRoles.includes('agente contact center');
                
                setFormData({
                    ...formData,
                    rolesDepartamento: newRoles,
                    role: systemRole,
                    telefono: sigueSiendoAgente ? formData.telefono : ''
                });
            };

            const handleDiaToggle = (dia) => {
                setFormData({
                    ...formData,
                    diasPermitidos: {
                        ...formData.diasPermitidos,
                        [dia]: !formData.diasPermitidos[dia]
                    }
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    if (!formData.departamento) {
                        alert('Por favor seleccione un departamento');
                        return;
                    }
                    
                    if (!formData.rolesDepartamento || formData.rolesDepartamento.length === 0) {
                        alert('Por favor seleccione al menos un rol para el departamento');
                        return;
                    }

                    // Validar tel√©fono para agente contact center
                    const esAgenteContactCenter = formData.departamento === 'contact center' && 
                                                  formData.rolesDepartamento.includes('agente contact center');
                    if (esAgenteContactCenter) {
                        if (!formData.telefono || formData.telefono.trim() === '') {
                            alert('Por favor ingrese el n√∫mero de tel√©fono para el agente de contact center');
                            return;
                        }
                        // Validar que tenga exactamente 8 d√≠gitos
                        const telefonoLimpio = formData.telefono.replace(/\D/g, '');
                        if (telefonoLimpio.length !== 8) {
                            alert('El n√∫mero de tel√©fono debe tener exactamente 8 d√≠gitos');
                            return;
                        }
                    }

                    // Validar restricci√≥n de horario
                    if (formData.restriccionHorario) {
                        const diasSeleccionados = Object.values(formData.diasPermitidos).some(v => v);
                        if (!diasSeleccionados) {
                            alert('Por favor seleccione al menos un d√≠a permitido para la restricci√≥n de horario');
                            return;
                        }
                        if (formData.horaInicio >= formData.horaFin) {
                            alert('La hora de inicio debe ser menor que la hora de fin');
                            return;
                        }
                    }
                    
                    // Determinar el rol del sistema desde los roles del departamento
                    const systemRole = getSystemRoleFromDepartmentRoles(formData.rolesDepartamento);
                    
                    // Preparar datos del usuario, asegurando que el rol del sistema est√© correctamente establecido
                    const uData = {
                        username: formData.username,
                        nombre: formData.nombre,
                        departamento: formData.departamento,
                        rolesDepartamento: formData.rolesDepartamento || [],
                        role: systemRole, // Rol del sistema calculado desde roles del departamento
                        restriccionHorario: formData.restriccionHorario || false,
                        diasPermitidos: formData.restriccionHorario ? formData.diasPermitidos : {},
                        horaInicio: formData.restriccionHorario ? formData.horaInicio : '',
                        horaFin: formData.restriccionHorario ? formData.horaFin : '',
                        telefono: formData.telefono || ''
                    };
                    
                    // Solo incluir password si se est√° creando un nuevo usuario o si se proporcion√≥ uno nuevo
                    if (!editingId) {
                        // Crear nuevo usuario - password es obligatorio
                        if (!formData.password || formData.password.trim() === '') {
                            alert('Por favor ingrese una contrase√±a para el nuevo usuario');
                            return;
                        }
                        uData.password = formData.password;
                    } else if (formData.password && formData.password.trim() !== '') {
                        // Editar usuario - solo incluir password si se proporcion√≥ uno nuevo
                        uData.password = formData.password;
                    }
                    // Si editingId existe y no hay password, no se incluye en uData (mantiene la contrase√±a actual)
                    
                    console.log('üíæ Guardando usuario con rol del sistema:', systemRole, 'Roles departamento:', formData.rolesDepartamento);
                    
                    if (editingId) {
                        await onUpdateUser(editingId, uData);
                    } else {
                        await onAddUser(uData);
                    }
                    closeModal();
                } catch (error) {
                    alert('Error al guardar usuario: ' + error.message);
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                                <Icons.UserCog size={24} />
                            </div>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Usuarios</h3>
                                <p className="text-xs font-semibold text-turquoise-600">{users.length} Activos</p>
                            </div>
                        </div>
                        <button onClick={openNew} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                            <Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo Usuario</span>
                        </button>
                    </div>

                    <Modal isOpen={showModal} onClose={closeModal} title={editingId ? "Editar Usuario" : "Nuevo Usuario"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.nombre} 
                                    onChange={e=>setFormData({...formData, nombre:e.target.value})} 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Usuario (Login)</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.username} 
                                    onChange={e=>setFormData({...formData, username:e.target.value.toLowerCase()})} 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Contrase√±a</label>
                                <input 
                                    type="password" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.password} 
                                    onChange={e=>setFormData({...formData, password:e.target.value})} 
                                    placeholder={editingId ? "Dejar vac√≠o para mantener" : ""} 
                                    required={!editingId} 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Departamento</label>
                                <select 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                    value={formData.departamento} 
                                    onChange={e=>handleDepartamentoChange(e.target.value)}
                                    required
                                >
                                    <option value="">Seleccione un departamento</option>
                                    {departamentos.map(dept => (
                                        <option key={dept} value={dept}>{dept.charAt(0).toUpperCase() + dept.slice(1)}</option>
                                    ))}
                                </select>
                            </div>
                            {formData.departamento && (
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-2">Roles en {formData.departamento.charAt(0).toUpperCase() + formData.departamento.slice(1)}</label>
                                    <div className="space-y-2 max-h-48 overflow-y-auto p-2 border border-slate-200 rounded-xl">
                                        {rolesPorDepartamento[formData.departamento]?.map(role => {
                                            const isSelected = formData.rolesDepartamento?.includes(role);
                                            return (
                                                <label 
                                                    key={role} 
                                                    className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${
                                                        isSelected 
                                                            ? 'bg-turquoise-50 border-2 border-turquoise-500' 
                                                            : 'bg-slate-50 border-2 border-transparent hover:bg-slate-100'
                                                    }`}
                                                >
                                                    <input 
                                                        type="checkbox" 
                                                        checked={isSelected}
                                                        onChange={() => handleRoleToggle(role)}
                                                        className="w-4 h-4 text-turquoise-600 border-slate-300 rounded focus:ring-turquoise-500 focus:ring-2"
                                                    />
                                                    <span className={`text-sm font-medium ${isSelected ? 'text-turquoise-700' : 'text-slate-600'}`}>
                                                        {role.charAt(0).toUpperCase() + role.slice(1)}
                                                    </span>
                                                </label>
                                            );
                                        })}
                                    </div>
                                    {formData.rolesDepartamento?.length > 0 && (
                                        <p className="text-xs text-slate-500 mt-1">
                                            {formData.rolesDepartamento.length} rol(es) seleccionado(s)
                                        </p>
                                    )}
                                </div>
                            )}
                            {formData.departamento === 'contact center' && formData.rolesDepartamento?.includes('agente contact center') && (
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">N√∫mero de Tel√©fono</label>
                                    <div className="flex items-center gap-2">
                                        <div className="flex items-center bg-slate-100 border border-slate-200 rounded-xl px-3 py-2.5">
                                            <span className="text-sm font-semibold text-slate-700">+504</span>
                                        </div>
                                        <input 
                                            type="tel" 
                                            className="flex-1 p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                            value={formData.telefono} 
                                            onChange={e=>{
                                                // Solo permitir n√∫meros y limitar a 8 d√≠gitos
                                                const valor = e.target.value.replace(/\D/g, '').slice(0, 8);
                                                setFormData({...formData, telefono: valor});
                                            }}
                                            placeholder="12345678"
                                            maxLength={8}
                                            required
                                        />
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">
                                        Ingrese 8 d√≠gitos del n√∫mero de tel√©fono (sin espacios ni guiones)
                                    </p>
                                </div>
                            )}
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-2">Restricci√≥n de Horario de Acceso</label>
                                <div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-200">
                                    <span className="text-sm font-medium text-slate-700">
                                        {formData.restriccionHorario ? 'Restricci√≥n activa' : 'Sin restricci√≥n de horario'}
                                    </span>
                                    <button
                                        type="button"
                                        onClick={() => setFormData({...formData, restriccionHorario: !formData.restriccionHorario})}
                                        className={`relative inline-flex h-7 w-14 items-center rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-turquoise-500 focus:ring-offset-2 ${
                                            formData.restriccionHorario ? 'bg-turquoise-600' : 'bg-slate-300'
                                        }`}
                                    >
                                        <span
                                            className={`inline-block h-5 w-5 transform rounded-full bg-white transition-transform duration-300 ${
                                                formData.restriccionHorario ? 'translate-x-8' : 'translate-x-1'
                                            }`}
                                        />
                                    </button>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">
                                    {formData.restriccionHorario 
                                        ? 'El usuario tendr√° restricci√≥n de horario de acceso al sistema' 
                                        : 'El usuario podr√° acceder al sistema en cualquier momento'}
                                </p>
                            </div>
                            {formData.restriccionHorario && (
                                <>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-2">D√≠as Permitidos</label>
                                        <div className="grid grid-cols-2 gap-2 p-3 border border-slate-200 rounded-xl bg-slate-50">
                                            {diasSemana.map(dia => (
                                                <label 
                                                    key={dia.key}
                                                    className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${
                                                        formData.diasPermitidos[dia.key]
                                                            ? 'bg-turquoise-50 border-2 border-turquoise-500' 
                                                            : 'bg-white border-2 border-transparent hover:bg-slate-100'
                                                    }`}
                                                >
                                                    <input 
                                                        type="checkbox" 
                                                        checked={formData.diasPermitidos[dia.key]}
                                                        onChange={() => handleDiaToggle(dia.key)}
                                                        className="w-4 h-4 text-turquoise-600 border-slate-300 rounded focus:ring-turquoise-500 focus:ring-2"
                                                    />
                                                    <span className={`text-xs font-medium ${formData.diasPermitidos[dia.key] ? 'text-turquoise-700' : 'text-slate-600'}`}>
                                                        {dia.label}
                                                    </span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Hora Inicio</label>
                                            <input 
                                                type="time" 
                                                className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                                value={formData.horaInicio} 
                                                onChange={e=>setFormData({...formData, horaInicio:e.target.value})} 
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Hora Fin</label>
                                            <input 
                                                type="time" 
                                                className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                                value={formData.horaFin} 
                                                onChange={e=>setFormData({...formData, horaFin:e.target.value})} 
                                                required
                                            />
                                        </div>
                                    </div>
                                </>
                            )}
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-3">
                                <p className="text-xs font-semibold text-blue-800 mb-1">Rol del Sistema:</p>
                                <p className="text-sm text-blue-600 font-medium">
                                    {formData.rolesDepartamento.length > 0 
                                        ? formData.rolesDepartamento.map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ')
                                        : 'Seleccione roles del departamento'}
                                </p>
                                <p className="text-[10px] text-blue-500 mt-1">
                                    El rol del sistema se determina autom√°ticamente desde los roles del departamento seleccionados
                                </p>
                            </div>
                            <button type="submit" className="w-full bg-turquoise-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-turquoise-700 btn-hover-effect mt-4">
                                {editingId ? 'Actualizar' : 'Crear Usuario'}
                            </button>
                        </form>
                    </Modal>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        <div className="mb-4 flex flex-wrap items-center gap-3">
                            <div className="relative flex-1 min-w-[200px] max-w-md">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search size={18}/></span>
                                <input type="text" placeholder="Buscar usuario por nombre, @username, departamento o rol..." value={userSearch} onChange={e=>setUserSearch(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-white rounded-xl border border-slate-200 text-sm outline-none focus:border-indigo-300 focus:ring-1 focus:ring-indigo-200" />
                            </div>
                            <span className="text-sm text-slate-500">{filteredUsers.length} de {(users||[]).length} usuario(s)</span>
                        </div>
                        <div className="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
                            {filteredUsers.map(u => (
                                <div key={u.id} className="p-4 rounded-xl border border-slate-200 flex flex-col gap-3 bg-white hover:shadow-md transition-shadow relative group">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${u.role === 'digitador' ? 'bg-clinical-500' : 'bg-turquoise-600'}`}>
                                            {u.username.substring(0,2).toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-sm text-slate-800 truncate">{u.nombre || u.username}</div>
                                            <div className="text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded w-fit mt-1">
                                                @{u.username} ‚Ä¢ {u.role}
                                            </div>
                                        </div>
                                    </div>
                                    {u.departamento && (
                                        <div className="space-y-1.5">
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase">Departamento:</span>
                                                <span className="text-xs font-semibold text-turquoise-600 bg-turquoise-50 px-2 py-0.5 rounded">
                                                    {u.departamento.charAt(0).toUpperCase() + u.departamento.slice(1)}
                                                </span>
                                            </div>
                                            {u.rolesDepartamento && u.rolesDepartamento.length > 0 && (
                                                <div>
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Roles:</span>
                                                    <div className="flex flex-wrap gap-1">
                                                        {u.rolesDepartamento.map((rol, idx) => (
                                                            <span key={idx} className="text-[10px] text-slate-600 bg-slate-100 px-2 py-0.5 rounded">
                                                                {rol.charAt(0).toUpperCase() + rol.slice(1)}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            {u.departamento === 'contact center' && u.rolesDepartamento?.includes('agente contact center') && u.telefono && (
                                                <div className="flex items-center gap-2 pt-1 border-t border-slate-100">
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase">Tel√©fono:</span>
                                                    <span className="text-xs font-semibold text-turquoise-700 bg-turquoise-50 px-2 py-0.5 rounded flex items-center gap-1">
                                                        <span className="text-[10px]">+504</span>
                                                        <span>{u.telefono}</span>
                                                    </span>
                                                </div>
                                            )}
                                            {u.restriccionHorario && (
                                                <div className="space-y-1.5 pt-1 border-t border-slate-100">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Restricci√≥n:</span>
                                                        <span className="text-xs font-semibold text-orange-600 bg-orange-50 px-2 py-0.5 rounded flex items-center gap-1">
                                                            <span className="w-2 h-2 bg-orange-500 rounded-full"></span>
                                                            Horario limitado
                                                        </span>
                                                    </div>
                                                    {u.diasPermitidos && (
                                                        <div>
                                                            <span className="text-[10px] font-bold text-slate-400 uppercase block mb-1">D√≠as:</span>
                                                            <div className="flex flex-wrap gap-1">
                                                                {Object.entries(u.diasPermitidos).map(([dia, permitido]) => {
                                                                    if (!permitido) return null;
                                                                    const diasLabels = {
                                                                        lunes: 'L',
                                                                        martes: 'M',
                                                                        miercoles: 'X',
                                                                        jueves: 'J',
                                                                        viernes: 'V',
                                                                        sabado: 'S',
                                                                        domingo: 'D'
                                                                    };
                                                                    return (
                                                                        <span key={dia} className="text-[10px] text-orange-700 bg-orange-100 px-1.5 py-0.5 rounded font-semibold">
                                                                            {diasLabels[dia] || dia.charAt(0).toUpperCase()}
                                                                        </span>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {u.horaInicio && u.horaFin && (
                                                        <div className="text-[10px] text-slate-600">
                                                            <span className="font-bold text-slate-400 uppercase">Horario: </span>
                                                            <span className="font-semibold text-orange-700">{u.horaInicio} - {u.horaFin}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className="border-t border-slate-100 pt-2 flex justify-between items-center gap-2">
                                        <div className="flex gap-2">
                                            {(u.departamento === 'contact center' && u.rolesDepartamento?.includes('agente contact center')) || 
                                             (u.departamento === 'farmacia' && u.rolesDepartamento?.includes('revision y asignacion')) ? (
                                                <>
                                                    <button 
                                                        onClick={async () => {
                                                            try {
                                                                const nuevoEstado = !u.trabajoCompartido;
                                                                await onUpdateUser(u.id, { trabajoCompartido: nuevoEstado });
                                                            } catch (error) {
                                                                alert('Error al cambiar estado: ' + (error?.message || error));
                                                            }
                                                        }} 
                                                        className={`p-2 rounded-lg transition-colors ${
                                                            u.trabajoCompartido 
                                                                ? 'bg-green-100 text-green-600 hover:bg-green-200' 
                                                                : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                                        }`}
                                                        title={u.trabajoCompartido ? "Desactivar trabajo compartido" : "Activar trabajo compartido (otros usuarios pueden trabajar en sus asignaciones)"}
                                                    >
                                                        {u.trabajoCompartido ? <Icons.CheckCircle size={18}/> : <Icons.XCircle size={18}/>}
                                                    </button>
                                                    <button 
                                                        onClick={() => {
                                                            setReassigningUser(u);
                                                            setShowReassignModal(true);
                                                        }} 
                                                        className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" 
                                                        title="Reasignar pacientes"
                                                    >
                                                        <Icons.UserCheck size={18}/>
                                                    </button>
                                                </>
                                            ) : null}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => openEdit(u)} className="p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Editar">
                                                <Icons.Edit size={18}/>
                                            </button>
                                            <button onClick={() => setConfirmData({ title: 'Eliminar Usuario', msg: `¬øDesea eliminar a ${u.username}?`, action: () => onDeleteUser(u.id) })} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">
                                                <Icons.Trash size={18}/>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <Modal isOpen={showReassignModal} onClose={() => { setShowReassignModal(false); setReassigningUser(null); setReassignTargetUser(''); }} title="Reasignar Pacientes" maxWidth="max-w-md">
                        {reassigningUser && (
                            <div className="space-y-4">
                                <div className="bg-slate-50 p-3 rounded-xl">
                                    <p className="text-xs text-slate-600 mb-1">Reasignar pacientes de:</p>
                                    <p className="font-bold text-slate-800">{reassigningUser.nombre || reassigningUser.username}</p>
                                    <p className="text-xs text-slate-500">
                                        {reassigningUser.departamento === 'contact center' ? 'Agente Contact Center' : 'Revisi√≥n y Asignaci√≥n'}
                                    </p>
                                </div>
                                
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">
                                        Reasignar a:
                                    </label>
                                    <select 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                        value={reassignTargetUser} 
                                        onChange={e => setReassignTargetUser(e.target.value)}
                                    >
                                        <option value="">Seleccione un usuario</option>
                                        {users
                                            .filter(targetUser => {
                                                if (targetUser.id === reassigningUser.id) return false;
                                                if (reassigningUser.departamento === 'contact center') {
                                                    return targetUser.departamento === 'contact center' && 
                                                           targetUser.rolesDepartamento?.includes('agente contact center');
                                                }
                                                if (reassigningUser.departamento === 'farmacia') {
                                                    return targetUser.departamento === 'farmacia' && 
                                                           targetUser.rolesDepartamento?.includes('revision y asignacion');
                                                }
                                                return false;
                                            })
                                            .map(targetUser => (
                                                <option key={targetUser.id} value={targetUser.id}>
                                                    {targetUser.nombre || targetUser.username}
                                                </option>
                                            ))
                                        }
                                    </select>
                                </div>
                                
                                <button 
                                    onClick={async () => {
                                        if (!reassignTargetUser) {
                                            alert('Por favor seleccione un usuario destino');
                                            return;
                                        }
                                        
                                        const targetUser = users.find(u => u.id === reassignTargetUser);
                                        if (!targetUser) {
                                            alert('Usuario destino no encontrado');
                                            return;
                                        }
                                        
                                        try {
                                            if (!firebaseInitialized || !db) {
                                                throw new Error("Base de datos no disponible");
                                            }
                                            
                                            let fieldToUpdate = '';
                                            if (reassigningUser.departamento === 'contact center') {
                                                fieldToUpdate = 'agenteContactCenter';
                                            } else if (reassigningUser.departamento === 'farmacia') {
                                                fieldToUpdate = 'usuarioRevisionAsignacion';
                                            }
                                            
                                            if (!fieldToUpdate) {
                                                alert('Error: No se pudo determinar el campo a actualizar');
                                                return;
                                            }
                                            
                                            // Buscar todos los pacientes asignados al usuario origen
                                            const patientsSnapshot = await db.collection('prod_patients')
                                                .where(fieldToUpdate, '==', reassigningUser.nombre || reassigningUser.username)
                                                .get();
                                            
                                            if (patientsSnapshot.empty) {
                                                alert('No hay pacientes asignados a este usuario');
                                                setShowReassignModal(false);
                                                return;
                                            }
                                            
                                            // Reasignar todos los pacientes
                                            const batch = db.batch();
                                            let count = 0;
                                            patientsSnapshot.docs.forEach(doc => {
                                                batch.update(doc.ref, { [fieldToUpdate]: targetUser.nombre || targetUser.username });
                                                count++;
                                            });
                                            
                                            await batch.commit();
                                            alert(`‚úÖ ${count} paciente(s) reasignado(s) exitosamente a ${targetUser.nombre || targetUser.username}`);
                                            setShowReassignModal(false);
                                            setReassigningUser(null);
                                            setReassignTargetUser('');
                                        } catch (error) {
                                            console.error('Error reasignando pacientes:', error);
                                            alert('Error al reasignar pacientes: ' + error.message);
                                        }
                                    }}
                                    className="w-full bg-blue-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-blue-700 btn-hover-effect"
                                >
                                    Reasignar Pacientes
                                </button>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [currentUserData, setCurrentUserData] = useState(null);
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [users, setUsers] = useState([]);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); 
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [cacheManager] = useState(new CacheManager());
            const [firebaseStatus, setFirebaseStatus] = useState('Conectando...');
            const [isFirebaseReady, setIsFirebaseReady] = useState(firebaseInitialized);
            
            const [rutaTemplateCurrent, setRutaTemplateCurrent] = useState(null);
            
            const loadRutaTemplateCurrent = async () => {
                try {
                    if (!firebaseInitialized || !db) return;
                    const doc = await db.collection('prod_templates_ruta').doc('current').get();
                    if (doc.exists) setRutaTemplateCurrent(doc.data());
                } catch (error) {
                    console.error('Error cargando plantilla RUTA:', error);
                }
            };
            
            const escapeHtml = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };
            
            const getGpsEnabled = (kitData) => {
                if (!kitData) return false;
                if (kitData.gpsEnabled === true || kitData.gpsEnabled === 'true' || kitData.gpsEnabled === 1) return true;
                if (kitData.gpsEnabled === false || kitData.gpsEnabled === 'false' || kitData.gpsEnabled === 0) return false;
                const gpsStr = String(kitData.gpsEnabled || kitData.tieneGps || kitData.gps || kitData.hasGps || '').toUpperCase();
                if (gpsStr === 'SI' || gpsStr === 'S√ç' || gpsStr === 'TRUE' || gpsStr === '1' || gpsStr === 'YES') return true;
                if (gpsStr === 'NO' || gpsStr === 'FALSE' || gpsStr === '0') return false;
                if (kitData.gpsStatus === 'TIENE GPS') return true;
                return false;
            };
            
            const getGpsCoords = (kitData) => {
                if (!kitData) return null;
                let lat = null, lng = null;
                if (kitData.gpsCoords) {
                    lat = kitData.gpsCoords.lat || kitData.gpsCoords.latitude;
                    lng = kitData.gpsCoords.lng || kitData.gpsCoords.longitude || kitData.gpsCoords.lon;
                } else if (kitData.gpsCoordinates) {
                    lat = kitData.gpsCoordinates.latitude || kitData.gpsCoordinates.lat;
                    lng = kitData.gpsCoordinates.longitude || kitData.gpsCoordinates.lng || kitData.gpsCoordinates.lon;
                } else if (kitData.coordenadasGps) {
                    lat = kitData.coordenadasGps.lat || kitData.coordenadasGps.latitude;
                    lng = kitData.coordenadasGps.lng || kitData.coordenadasGps.longitude || kitData.coordenadasGps.lon;
                } else if (kitData.lat !== undefined && kitData.lng !== undefined) {
                    lat = kitData.lat;
                    lng = kitData.lng;
                } else if (kitData.latitude !== undefined && kitData.longitude !== undefined) {
                    lat = kitData.latitude;
                    lng = kitData.longitude;
                } else if (kitData.gpsValue) {
                    const parts = String(kitData.gpsValue).split(',');
                    if (parts.length >= 2) {
                        lat = parseFloat(parts[0].trim());
                        lng = parseFloat(parts[1].trim());
                    }
                }
                if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        return { lat, lng };
                    }
                }
                return null;
            };
            
            const resolveDeliveryAddressRuta = (kitData) => {
                // En este proyecto la ubicaci√≥n de entrega vive en el KIT (obligatoria en RUTA)
                return String(kitData?.direccionEntrega || '').trim();
            };
            
            const resolveRutaPlaceholders = async (kitData, patientData, users = [], contacts = []) => {
                const gpsEnabled = getGpsEnabled(kitData);
                const gpsCoords = getGpsCoords(kitData);
                const direccionEntrega = resolveDeliveryAddressRuta(kitData);
                const telPersonal = String(patientData?.telefono || '').trim();
                const telFamiliar = String(patientData?.telefonoFamiliar || '').trim();
                const phoneHighlight = String(kitData?.phoneHighlight || '').trim().toLowerCase();
                let telPersonalDisplay = telPersonal;
                let telFamiliarDisplay = telFamiliar;
                if (phoneHighlight === 'personal' && telPersonal) {
                    telPersonalDisplay = '---> ' + telPersonal;
                } else if (phoneHighlight === 'familiar' && telFamiliar) {
                    telFamiliarDisplay = telFamiliar + ' <---';
                }
                const telefonosText = [telPersonalDisplay, telFamiliarDisplay].filter(Boolean).join(' / ');
                
                const renderBox = (text) => {
                    const safe = String(text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return '<span style="display:inline-block;padding:0.6mm 1mm;border:0.6mm solid #000;border-radius:1.2mm;font-weight:900;">' + safe + '</span>';
                };
                const TEL_PERSONAL_BOX = kitData.phoneHighlight === 'personal' ? renderBox(telPersonal) : (telPersonal || '');
                const TEL_FAMILIAR_BOX = kitData.phoneHighlight === 'familiar' ? renderBox(telFamiliar) : (telFamiliar || '');
                
                // Obtener contact center con tel√©fono (EXACTAMENTE igual que ventanilla)
                const sep = ' ----- ';
                const ccRaw = (kitData.contactCenter || patientData?.contactCenter || '').toString().trim();
                const ccNormalized = _vNormalizeCC(ccRaw);
                const agenteName = (patientData?.agenteContactCenter || kitData?.agenteContactCenter || (ccRaw && !ccRaw.includes(' --- ') && !ccRaw.includes(' ----- ') ? ccRaw : '')).toString().trim();
                let contactCenterDisplay = ccNormalized;
                if (!contactCenterDisplay && agenteName) {
                    const fromFirebase = await _vFetchAgentFromFirebase(agenteName);
                    contactCenterDisplay = fromFirebase || _vFormatCC(agenteName, users, contacts);
                } else if (!contactCenterDisplay) {
                    contactCenterDisplay = _vFormatCC(agenteName, users, contacts);
                }
                if (!contactCenterDisplay || contactCenterDisplay === '‚Äî') contactCenterDisplay = agenteName || '‚Äî';
                
                // Asegurar que siempre tenga el formato "NOMBRE ----- TELEFONO"
                if (contactCenterDisplay && !contactCenterDisplay.includes(sep)) {
                    // Si no tiene el separador, buscar el tel√©fono usando _vFormatCC
                    const formatted = _vFormatCC(contactCenterDisplay, users, contacts);
                    if (formatted && formatted.includes(sep)) {
                        contactCenterDisplay = formatted;
                    } else {
                        contactCenterDisplay = contactCenterDisplay + sep;
                    }
                }
                
                let fechaEntrega = '';
                if (kitData.fechaEntregaKit) {
                    const date = new Date(kitData.fechaEntregaKit);
                    if (!isNaN(date.getTime())) {
                        fechaEntrega = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }
                } else if (kitData.fechaArmado) {
                    const date = new Date(kitData.fechaArmado);
                    if (!isNaN(date.getTime())) {
                        fechaEntrega = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    }
                }
                
                // Calcular cantidad de medicamentos (formato dispensados/total)
                const medicamentos = kitData.medicamentos || [];
                const totalMeds = medicamentos.length;
                const dispensadosMeds = medicamentos.filter(m => m.dispensar !== false).length;
                const cantidadMeds = totalMeds > 0 ? `${dispensadosMeds}/${totalMeds}` : '0/0';
                
                // Observaciones de entrega
                const observacionesEntrega = (kitData.observacionesEntrega || kitData.observations || kitData.obsRuta || '').trim().toUpperCase();
                
                // Construir QR_MAPS usando kit.gpsValue directamente (formato corto para QR simple)
                let qrMapsUrl = '';
                if (kitData.gpsValue && String(kitData.gpsValue).trim() !== '') {
                    const gps = String(kitData.gpsValue).trim();
                    // Validar que tenga coma y extraer solo coordenadas para QR m√°s simple
                    if (gps.includes(',')) {
                        // Si es un link, extraer coordenadas; si son coordenadas directas, usarlas tal cual
                        if (gps.startsWith('http://') || gps.startsWith('https://')) {
                            const coordMatch = gps.match(/(?:q=|@|,)(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                            if (coordMatch && coordMatch[1] && coordMatch[2]) {
                                qrMapsUrl = coordMatch[1] + ',' + coordMatch[2];
                            } else {
                                qrMapsUrl = gps; // Si no se pueden extraer, usar link completo
                            }
                        } else {
                            // Ya son coordenadas directas, usar tal cual (formato m√°s corto)
                            qrMapsUrl = gps;
                        }
                    }
                }
                
                return {
                    NOMBRE: (kitData.nombre || patientData?.nombre || '').toUpperCase(),
                    DNI: (kitData.dni || patientData?.dni || '').toUpperCase(),
                    GPS_STATUS: gpsEnabled ? 'TIENE GPS' : '',
                    TELEFONOS: telefonosText.toUpperCase(),
                    TEL_PERSONAL: telPersonal.toUpperCase(),
                    TEL_FAMILIAR: telFamiliar.toUpperCase(),
                    TEL_PERSONAL_BOX: TEL_PERSONAL_BOX,
                    TEL_FAMILIAR_BOX: TEL_FAMILIAR_BOX,
                    MEDS_COUNT: cantidadMeds,
                    DIRECCION_ENTREGA: direccionEntrega.toUpperCase(),
                    INSTRUCCIONES_ENTREGA: observacionesEntrega,
                    OBSERVACIONES: observacionesEntrega,
                    CONTACT_CENTER: contactCenterDisplay.toUpperCase() || '‚Äî',
                    FECHA_ENTREGA: fechaEntrega || '‚Äî',
                    REFRIGERADO: (kitData.refrigerado === true || kitData.isRefrigerated === true) ? 'REFRIGERADO' : '',
                    QR_MAPS: qrMapsUrl,
                    HAS_GPS: gpsEnabled
                };
            };
            
            const renderRutaTemplateToHTML = (template, resolvedData) => {
                if (!template || !template.elements) return '';
                // Funci√≥n helper para escapar HTML (definida localmente para evitar problemas de scope)
                const escapeHtmlLocal = (str) => {
                    if (!str) return '';
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                };
                
                // Crear copia de los elementos para no modificar el original
                const elements = [...template.elements];
                
                // Asegurar que la plantilla tenga el elemento QR_MAPS si no existe
                let qrElement = elements.find(e => e.tokenKey === 'QR_MAPS');
                if (!qrElement && resolvedData.QR_MAPS) {
                    // Crear elemento QR_MAPS con valores por defecto
                    qrElement = {
                        tokenKey: 'QR_MAPS',
                        xMm: 180,
                        yMm: 5,
                        wMm: 25,
                        hMm: 25
                    };
                    // Agregar a la copia de elementos (no modificar el original)
                    elements.push(qrElement);
                }
                
                let elementsHtml = '';
                elements.forEach(element => {
                    const isHtmlToken = element.tokenKey === 'TEL_PERSONAL_BOX' || element.tokenKey === 'TEL_FAMILIAR_BOX';
                    const text = element.tokenKey ? (resolvedData[element.tokenKey] || '') : (element.text || '');
                    const style = element.style || {};
                    const isBold = style.bold ? 'font-weight: 900;' : '';
                    const align = style.align || 'left';
                    const fontSize = style.fontSize || '2mm';
                    const border = element.border ? 'border: 0.5px solid #000;' : '';
                    const cellStyle = 'left: ' + element.xMm + 'mm; top: ' + element.yMm + 'mm; width: ' + element.wMm + 'mm; height: ' + element.hMm + 'mm; ' + border + ' ' + isBold + ' text-align: ' + align + '; font-size: ' + fontSize + '; padding: 0.5mm;';
                    elementsHtml += '<div class="cell" style="' + cellStyle + '">' + (isHtmlToken ? String(text) : escapeHtmlLocal(text)) + '</div>';
                });
                let qrContainerHtml = '';
                let qrScriptHtml = '';
                if (resolvedData.QR_MAPS && qrElement) {
                    // NOTA: Esta funci√≥n se usa para plantillas antiguas
                    // Para la vi√±eta ruta principal, usar printRutaVignette que ya usa QRUtils
                    // Aqu√≠ generamos el QR directamente sin CDN usando QRCode local
                    const qrStyle = 'left: ' + qrElement.xMm + 'mm; top: ' + qrElement.yMm + 'mm; width: ' + qrElement.wMm + 'mm; height: ' + qrElement.hMm + 'mm; text-align: center; padding: 1mm;';
                    qrContainerHtml = '<div class="cell" id="qr-container" style="' + qrStyle + '"></div>';
                    const qrUrl = JSON.stringify(resolvedData.QR_MAPS);
                    // Usar QRCode local (ya cargado, sin CDN)
                    const qrScriptCode = '<script>(function(){try{if(typeof QRCode !== "undefined" && typeof QRCode.toDataURL === "function"){var qrContainer = document.getElementById("qr-container");if(qrContainer){QRCode.toDataURL(' + qrUrl + ', {width: 150, margin: 1}, function(err, url){if(!err && url){var img = document.createElement("img");img.src = url;img.style.maxWidth = "100%";img.style.height = "auto";qrContainer.appendChild(img);}else{console.error("Error generando QR:", err);}});}}else{console.error("QRCode no disponible");}}catch(e){console.error("Error en script QR:", e);}})();<\/script>';
                    qrScriptHtml = qrScriptCode;
                }
                const printHtml = '<!DOCTYPE html>' +
'<html>' +
'<head>' +
'<meta charset="UTF-8">' +
'<title>Vi√±eta Ruta</title>' +
'<style>' +
'@page { size: 210mm 71mm landscape; margin-left: 0.1cm; margin-right: 0.1cm; }' +
'html, body { width: 210mm; height: 71mm; margin: 0; padding: 0; overflow: hidden; }' +
'.ticket { width: 210mm; height: 71mm; position: relative; overflow: hidden; background: #fff; }' +
'* { -webkit-print-color-adjust: exact; print-color-adjust: exact; box-sizing: border-box; text-transform: uppercase; }' +
'.cell { position: absolute; overflow: hidden; word-wrap: break-word; }' +
'</style>' +
'</head>' +
'<body>' +
'<div class="ticket">' +
elementsHtml +
qrContainerHtml +
'</div>' +
qrScriptHtml +
'</body>' +
'</html>';
                return printHtml;
            };
            
            // Funci√≥n para imprimir vi√±eta RUTA con nueva plantilla HTML
            const printRutaVignette = async (kit, patient) => {
                try {
                    // Obtener datos actualizados de la base de datos antes de imprimir
                    let updatedKit = kit;
                    let updatedPatient = patient || {};
                    
                    if (kit && kit.id && firebaseInitialized && db) {
                        try {
                            const kitDoc = await db.collection('prod_kits').doc(kit.id).get();
                            if (kitDoc.exists) {
                                updatedKit = { id: kitDoc.id, ...kitDoc.data() };
                                console.log('‚úÖ Kit actualizado desde base de datos:', updatedKit);
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è No se pudo obtener kit actualizado, usando datos locales:', error);
                        }
                    }
                    
                    // Obtener datos actualizados del paciente si hay patientId
                    if (updatedKit && updatedKit.patientId && firebaseInitialized && db) {
                        try {
                            const patientDoc = await db.collection('prod_patients').doc(updatedKit.patientId).get();
                            if (patientDoc.exists) {
                                updatedPatient = { id: patientDoc.id, ...patientDoc.data() };
                                console.log('‚úÖ Paciente actualizado desde base de datos');
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è No se pudo obtener paciente actualizado, usando datos locales:', error);
                        }
                    }
                    
                    const patientData = updatedPatient;
                    
                    // Resolver placeholders con datos actualizados (pasar users y contacts)
                    const resolvedData = await resolveRutaPlaceholders(updatedKit, patientData, users, contacts);
                    
                    // Verificar si el GPS est√° activado (por el bot√≥n de Contact Center)
                    // El QR solo se muestra si gpsStatus === 'TIENE GPS'
                    const gpsStatus = updatedKit?.gpsStatus || '';
                    const hasGpsActivated = gpsStatus === 'TIENE GPS' || resolvedData.HAS_GPS === true;
                    
                    // Obtener logos
                    const logo1 = (typeof LOGO1_URL !== 'undefined' && LOGO1_URL) ? LOGO1_URL : 'https://raw.githubusercontent.com/jose50440/bita/6a46e7144ce075c219a382364b611fa576fc5e4b/img/logo1.png';
                    const logo2 = (typeof LOGO2_URL !== 'undefined' && LOGO2_URL) ? LOGO2_URL : 'https://raw.githubusercontent.com/jose50440/bita/6a46e7144ce075c219a382364b611fa576fc5e4b/img/logo2.png';
                    
                    // Funci√≥n helper para escapar HTML
                    const _vEsc = (s) => { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); };
                    
                    // Construir HTML de la vi√±eta
                    // Si el GPS est√° activado, usar clase que deja espacio para QR
                    // Si el GPS NO est√° activado, usar clase que ocupa todo el espacio
                    const fechaClass = hasGpsActivated ? 'ruta-fecha-value' : 'ruta-fecha-value-full';
                    
                    // Direcci√≥n y observaciones combinadas
                    const direccionCompleta = resolvedData.DIRECCION_ENTREGA;
                    const observaciones = resolvedData.OBSERVACIONES;
                    const direccionYObs = [direccionCompleta, observaciones].filter(Boolean).join(' | ');
                    
                    // Generar QR usando m√≥dulo local (OFFLINE) - SOLO si el GPS est√° activado
                    // Payload √∫nico: IHSS|KIT=<kitId>|GPS=<gpsValue>|DNI=<dni>|TS=<timestamp>|SIG=<hash>
                    let qrImageHtml = '';
                    
                    // Solo generar QR si el GPS est√° activado por Contact Center
                    if (hasGpsActivated) {
                        try {
                            // Obtener datos para el payload
                            const kitId = updatedKit?.id || updatedKit?.kitId || 'UNKNOWN';
                            const gpsValue = updatedKit?.gpsValue || '';
                            const dni = patientData?.dni || updatedKit?.dni || resolvedData.DNI || 'UNKNOWN';
                            
                            console.log('[QR] Generando QR para kit:', kitId, 'GPS:', gpsValue || 'EMPTY');
                            
                            // Construir URL completa de Google Maps que abrir√° la app de Maps del tel√©fono
                            // El gpsValue puede ser:
                            // 1. Coordenadas: "lat,lon" (ej: "14.0583,-87.2164")
                            // 2. Link de Google Maps: "https://www.google.com/maps?q=..." o "https://maps.google.com/..."
                            let mapsUrlFull = '';
                            
                            if (gpsValue && String(gpsValue).trim() !== '') {
                                const gps = String(gpsValue).trim();
                                
                                // Verificar si ya es un link de Google Maps
                                if (gps.startsWith('http://') || gps.startsWith('https://')) {
                                    // Ya es un link, verificar que sea de Google Maps
                                    if (gps.includes('google.com/maps') || gps.includes('maps.google.com') || gps.includes('goo.gl/maps') || gps.includes('maps.app.goo.gl')) {
                                        mapsUrlFull = gps;
                                        console.log('[QR] Link de Google Maps detectado:', mapsUrlFull);
                                    } else {
                                        // Es un link pero no de Google Maps, usar como est√°
                                        mapsUrlFull = gps;
                                        console.log('[QR] Link no-Maps usado:', mapsUrlFull);
                                    }
                                } else if (gps.includes(',')) {
                                    // Es coordenadas (formato lat,lon) - construir URL de Google Maps
                                    const [lat, lon] = gps.split(',').map(s => s.trim());
                                    if (lat && lon && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lon))) {
                                        // Construir URL completa de Google Maps que abre en la app del tel√©fono
                                        mapsUrlFull = 'https://www.google.com/maps?q=' + lat + ',' + lon;
                                        console.log('[QR] URL de Maps generada desde coordenadas:', mapsUrlFull);
                                    } else {
                                        throw new Error('Coordenadas GPS inv√°lidas');
                                    }
                                } else {
                                    // No es link ni coordenadas, usar como direcci√≥n
                                    const direccion = encodeURIComponent(gps);
                                    mapsUrlFull = 'https://www.google.com/maps/search/?api=1&query=' + direccion;
                                    console.log('[QR] URL de Maps generada desde texto/direcci√≥n:', mapsUrlFull);
                                }
                            } else {
                                // Si no hay GPS pero est√° activado, usar direcci√≥n como fallback
                                if (resolvedData.DIRECCION_ENTREGA) {
                                    const direccion = encodeURIComponent(resolvedData.DIRECCION_ENTREGA);
                                    mapsUrlFull = 'https://www.google.com/maps/search/?api=1&query=' + direccion;
                                    console.log('[QR] URL de Maps generada con direcci√≥n como fallback:', mapsUrlFull);
                                } else {
                                    throw new Error('No hay coordenadas GPS, link de Maps ni direcci√≥n disponible');
                                }
                            }
                            
                            // Acortar URL usando spoo.me para QR m√°s simple (menos saturado)
                            let shortUrl = mapsUrlFull;
                            try {
                                // Acortar URL con spoo.me API v1 - endpoint correcto: /shorten
                                const shortenResponse = await fetch('https://spoo.me/api/v1/shorten', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        long_url: mapsUrlFull  // Campo correcto seg√∫n documentaci√≥n
                                    })
                                });
                                
                                if (shortenResponse.ok) {
                                    const shortenData = await shortenResponse.json();
                                    console.log('[QR] Respuesta completa del acortador:', shortenData);
                                    
                                    // El campo correcto seg√∫n la documentaci√≥n es 'short_url'
                                    if (shortenData.short_url) {
                                        shortUrl = shortenData.short_url;
                                        console.log('[QR] ‚úÖ URL acortada exitosamente:', shortUrl);
                                    } else {
                                        console.warn('[QR] ‚ö†Ô∏è Respuesta sin campo short_url:', JSON.stringify(shortenData));
                                        // Intentar otros campos posibles
                                        if (shortenData.url) {
                                            shortUrl = shortenData.url;
                                            console.log('[QR] ‚úÖ URL acortada (campo url):', shortUrl);
                                        } else {
                                            console.warn('[QR] ‚ö†Ô∏è No se encontr√≥ URL acortada en la respuesta');
                                        }
                                    }
                                } else {
                                    const errorText = await shortenResponse.text();
                                    console.warn('[QR] ‚ö†Ô∏è Error HTTP al acortar URL:', shortenResponse.status, errorText);
                                    
                                    // Si es error 401/403, puede requerir autenticaci√≥n, pero continuamos sin acortar
                                    if (shortenResponse.status === 401 || shortenResponse.status === 403) {
                                        console.warn('[QR] ‚ö†Ô∏è Autenticaci√≥n requerida, usando URL original');
                                    }
                                }
                            } catch (error) {
                                console.error('[QR] ‚ùå Error al acortar URL con spoo.me:', error);
                                console.error('[QR] Detalles del error:', error.message);
                            }
                            
                            // Si despu√©s de todo no se acort√≥, usar URL original
                            if (shortUrl === mapsUrlFull) {
                                console.log('[QR] Usando URL original (no se pudo acortar):', shortUrl);
                            } else {
                                console.log('[QR] ‚úÖ URL final para QR (acortada):', shortUrl);
                            }
                            
                            console.log('[QR] Payload final para QR:', shortUrl);
                            
                            // Generar QR usando QRCode.js local con logo en el centro
                            // URL del logo del proyecto
                            const logoUrl = 'https://i.pinimg.com/736x/b4/5a/93/b45a931f326800d4877d34bbe4800b86.jpg';
                            
                            // Esperar a que QRCode est√© disponible
                            const waitForQRCode = () => {
                                return new Promise((resolve, reject) => {
                                    if (typeof QRCode !== 'undefined' && typeof QRCode.toDataURL === 'function') {
                                        resolve(QRCode);
                                        return;
                                    }
                                    let attempts = 0;
                                    const maxAttempts = 100;
                                    const checkQRCode = () => {
                                        attempts++;
                                        const qrCodeLib = typeof QRCode !== 'undefined' ? QRCode : (typeof window !== 'undefined' && window.QRCode ? window.QRCode : null);
                                        if (qrCodeLib && typeof qrCodeLib.toDataURL === 'function') {
                                            resolve(qrCodeLib);
                                        } else if (attempts >= maxAttempts) {
                                            reject(new Error('QRCode library no se carg√≥'));
                                        } else {
                                            setTimeout(checkQRCode, 50);
                                        }
                                    };
                                    checkQRCode();
                                });
                            };
                            
                            const QRCodeLib = await waitForQRCode();
                            
                            // Generar QR optimizado para impresi√≥n: m√°s grande, menos complejo, logo peque√±o
                            const qrDataUrl = await new Promise((resolve, reject) => {
                                // Generar QR con nivel de correcci√≥n MEDIO (M) para reducir complejidad
                                // Mayor tama√±o para mejor calidad de impresi√≥n
                                QRCodeLib.toDataURL(shortUrl, {
                                    width: 400, // Mayor tama√±o para mejor impresi√≥n
                                    margin: 4, // Mayor margen para mejor escaneo
                                    errorCorrectionLevel: 'M', // Medio (menos complejo que 'H')
                                    color: {
                                        dark: '#000000',
                                        light: '#FFFFFF'
                                    }
                                }, (err, qrUrl) => {
                                    if (err) {
                                        reject(err);
                                        return;
                                    }
                                    
                                    if (!qrUrl || qrUrl.length === 0) {
                                        reject(new Error('QR generado vac√≠o'));
                                        return;
                                    }
                                    
                                    // Cargar el logo y superponerlo en el centro del QR (m√°s peque√±o)
                                    const logoImg = new Image();
                                    logoImg.crossOrigin = 'anonymous';
                                    
                                    logoImg.onload = function() {
                                        // Crear canvas para combinar QR + logo
                                        const qrImg = new Image();
                                        qrImg.onload = function() {
                                            const canvas = document.createElement('canvas');
                                            const size = 400; // Tama√±o del QR (mayor para impresi√≥n)
                                            canvas.width = size;
                                            canvas.height = size;
                                            const ctx = canvas.getContext('2d');
                                            
                                            // Mejorar calidad de renderizado para impresi√≥n
                                            ctx.imageSmoothingEnabled = true;
                                            ctx.imageSmoothingQuality = 'high';
                                            
                                            // Dibujar el QR
                                            ctx.drawImage(qrImg, 0, 0, size, size);
                                            
                                            // Logo m√°s peque√±o (12% del tama√±o) para no interferir con el QR
                                            const logoSize = size * 0.12; // Reducido de 20% a 12%
                                            const logoX = (size - logoSize) / 2;
                                            const logoY = (size - logoSize) / 2;
                                            
                                            // Dibujar fondo blanco redondeado m√°s peque√±o para el logo
                                            ctx.fillStyle = '#FFFFFF';
                                            ctx.beginPath();
                                            const cornerRadius = 6;
                                            ctx.moveTo(logoX + cornerRadius, logoY);
                                            ctx.lineTo(logoX + logoSize - cornerRadius, logoY);
                                            ctx.quadraticCurveTo(logoX + logoSize, logoY, logoX + logoSize, logoY + cornerRadius);
                                            ctx.lineTo(logoX + logoSize, logoY + logoSize - cornerRadius);
                                            ctx.quadraticCurveTo(logoX + logoSize, logoY + logoSize, logoX + logoSize - cornerRadius, logoY + logoSize);
                                            ctx.lineTo(logoX + cornerRadius, logoY + logoSize);
                                            ctx.quadraticCurveTo(logoX, logoY + logoSize, logoX, logoY + logoSize - cornerRadius);
                                            ctx.lineTo(logoX, logoY + cornerRadius);
                                            ctx.quadraticCurveTo(logoX, logoY, logoX + cornerRadius, logoY);
                                            ctx.closePath();
                                            ctx.fill();
                                            
                                            // Dibujar el logo con padding
                                            const padding = logoSize * 0.15;
                                            ctx.drawImage(logoImg, logoX + padding, logoY + padding, logoSize - (padding * 2), logoSize - (padding * 2));
                                            
                                            // Convertir a DataURL con alta calidad para impresi√≥n
                                            const finalDataUrl = canvas.toDataURL('image/png', 1.0);
                                            resolve(finalDataUrl);
                                        };
                                        
                                        qrImg.onerror = function() {
                                            reject(new Error('Error cargando QR generado'));
                                        };
                                        
                                        qrImg.src = qrUrl;
                                    };
                                    
                                    logoImg.onerror = function() {
                                        console.warn('[QR] Error cargando logo, usando QR sin logo');
                                        // Si falla el logo, usar QR sin logo
                                        resolve(qrUrl);
                                    };
                                    
                                    logoImg.src = logoUrl;
                                });
                            });
                            
                            if (qrDataUrl && qrDataUrl.length > 0) {
                                // Crear HTML del QR con leyenda y flecha
                                // El contenedor .ruta-qr-container est√° dentro de .ruta-b2
                                // Solo el QR, la leyenda va en el HTML principal junto a la fecha
                                qrImageHtml = `<div class="ruta-qr-container"><img src="${qrDataUrl}" alt="QR Code" /></div>`;
                                console.log('[QR] ‚úÖ QR generado exitosamente usando API QR Server (nitidez 100%)');
                            } else {
                                throw new Error('QR data URL vac√≠o o inv√°lido');
                            }
                        } catch (error) {
                            console.error('[QR] ‚ö†Ô∏è Error generando QR:', error);
                            // Si hay error, no mostrar QR (dejar espacio para fecha completa)
                            qrImageHtml = '';
                        }
                    } else {
                        // GPS no activado - no mostrar QR, la fecha ocupar√° todo el espacio
                        console.log('[QR] GPS no activado - QR no se mostrar√°');
                        qrImageHtml = '';
                    }
                    
                    const html = `
<div class="ruta-sheet">
    <div class="ruta-header">
        <img src="${_vEsc(logo1)}" alt="Logo 1" class="ruta-logo-header ruta-logo-left" onerror="this.style.display='none'"/>
        <div class="ruta-title">DEPARTAMENTO DE DISPENSASION A DOMICILIO</div>
        <img src="${_vEsc(logo2)}" alt="Logo 2" class="ruta-logo-header ruta-logo-right" onerror="this.style.display='none'"/>
    </div>
    <div class="ruta-content">
        <div class="ruta-lado-a">
            <div class="ruta-box ruta-name">${_vEsc(resolvedData.NOMBRE)}</div>
            <div class="ruta-box ruta-dni">${_vEsc(resolvedData.DNI)}</div>
            <div class="ruta-box ruta-field">
                <div class="ruta-field-label">TELEFONOS DE CONTACTO DEL PACIENTE</div>
                <div class="ruta-field-value">${_vEsc(resolvedData.TELEFONOS)}</div>
            </div>
            <div class="ruta-box ruta-fecha-box">
                <div class="${fechaClass}">${_vEsc(resolvedData.FECHA_ENTREGA)}</div>
            </div>
        </div>
        <div class="ruta-lado-b">
            <div class="ruta-b1">
                <div class="ruta-box-address">
                    <div class="ruta-address-content">
                        <div class="ruta-address-text" id="ruta-address-text">${_vEsc(direccionYObs)}</div>
                    </div>
                </div>
            </div>
            <div class="ruta-b2">
                <div class="ruta-b2-content">
                    <div class="ruta-b2-info-item ruta-b2-meds">
                        <span class="ruta-b2-info-label">MEDICAMENTOS:</span>
                        <span class="ruta-b2-info-value">${_vEsc(resolvedData.MEDS_COUNT)}</span>
                    </div>
                    <div class="ruta-b2-info-item ruta-b2-contact">
                        <span class="ruta-b2-info-label">CONTACT CENTER:</span>
                        <span class="ruta-b2-info-value">${_vEsc(resolvedData.CONTACT_CENTER)}</span>
                    </div>
                </div>
                ${hasGpsActivated ? qrImageHtml : ''}
            </div>
        </div>
    </div>
</div>`;
                    
                    // Script para autoajustar fuente de direcci√≥n centrada con l√≥gica inteligente (poco texto = grande, mucho texto = peque√±o)
                    // Los logos ya no est√°n en la direcci√≥n, as√≠ que usamos todo el espacio disponible
                    let autoAdjustScript = '<script>(function(){function adjustFontSize(){var addressText=document.getElementById("ruta-address-text");if(!addressText)return;var addressContent=addressText.parentElement;var addressBox=addressContent.parentElement;if(!addressBox)return;var marginTop=1;var marginBottom=1;var boxHeight=addressBox.offsetHeight;var availableHeight=boxHeight-marginTop-marginBottom;if(availableHeight<=0)return;addressText.style.textAlign="center";addressText.style.fontFamily="Arial Black, Arial, sans-serif";addressText.style.fontWeight="900";addressText.style.fontSize="1mm";addressText.style.lineHeight="1.4";addressText.style.overflow="hidden";addressText.style.paddingTop=marginTop+"mm";addressText.style.paddingBottom=marginBottom+"mm";var textLength=addressText.textContent.trim().length;var minFontSize=3;var maxFontSize=textLength<30?8:textLength<60?7:textLength<100?6:textLength<150?5:textLength<200?4.5:3.5;var fontSize=minFontSize;var bestFit=minFontSize;var precision=0.1;for(var testSize=minFontSize;testSize<=maxFontSize;testSize+=precision){addressText.style.fontSize=testSize+"mm";var textHeight=addressText.scrollHeight;if(textHeight<=availableHeight){bestFit=testSize;}else{break;}}addressText.style.fontSize=bestFit+"mm";}setTimeout(adjustFontSize,50);setTimeout(adjustFontSize,150);setTimeout(adjustFontSize,300);})();<\/script>';
                    
                    const htmlDoc = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Vi√±eta Ruta</title><style>' + _vCSSRuta() + '</style></head><body>' + html + autoAdjustScript + '</body></html>';
                    
                    // Imprimir usando iframe oculto (evita bloqueos de popups)
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'fixed';
                    iframe.style.right = '0';
                    iframe.style.bottom = '0';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = 'none';
                    document.body.appendChild(iframe);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(htmlDoc);
                    iframeDoc.close();
                    
                    // Bandera para evitar doble impresi√≥n
                    let hasPrinted = false;
                    const doPrint = () => {
                        if (hasPrinted || !iframe.parentNode) return;
                        hasPrinted = true;
                        iframe.contentWindow.focus();
                        iframe.contentWindow.print();
                        // Remover iframe despu√©s de imprimir
                        setTimeout(() => {
                            if (iframe.parentNode) {
                                document.body.removeChild(iframe);
                            }
                        }, 2000);
                    };
                    
                    // Esperar a que cargue y luego imprimir (el QR ya est√° generado, solo esperar carga del iframe)
                    iframe.onload = function() {
                        // El QR ya est√° en el HTML, solo esperar un momento para que el iframe se renderice
                        setTimeout(doPrint, 300);
                    };
                    
                    // Fallback si onload no se dispara
                    setTimeout(doPrint, 800);
                    
                } catch (error) {
                    console.error('Error imprimiendo vi√±eta RUTA:', error);
                    alert('Error al imprimir: ' + error.message);
                }
            };

            const _vEsc = (s) => { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); };
            const _vPw = (html, css, title) => {
                // Usar iframe en lugar de window.open para evitar bloqueos de popups
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);
                
                const full = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+_vEsc(title)+'</title><style>'+css+'</style></head><body>'+html+'</body></html>';
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(full);
                iframeDoc.close();
                
                // Bandera para evitar doble impresi√≥n
                let hasPrinted = false;
                const doPrint = () => {
                    if (hasPrinted || !iframe.parentNode) return;
                    hasPrinted = true;
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                    // Remover iframe despu√©s de imprimir
                    setTimeout(() => {
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                    }, 2000);
                };
                
                // Esperar a que cargue y luego imprimir
                iframe.onload = function() {
                    setTimeout(doPrint, 300);
                };
                
                // Fallback si onload no se dispara (despu√©s de m√°s tiempo)
                setTimeout(doPrint, 800);
            };
            const _vCSSVertical = () => `@page{size:71mm 210mm;margin:0;}*{margin:0;padding:0;box-sizing:border-box;} html,body{width:71mm;height:210mm;font-family:'Segoe UI',Arial;text-transform:uppercase;} .sheet{width:71mm;height:210mm;padding:0.8mm;} .header{display:flex;flex-direction:column;align-items:center;margin-bottom:0.8mm;padding-bottom:0.4mm;border-bottom:0.4mm solid #1a1a1a;} .header-title{font-size:2.2mm;font-weight:700;text-align:center;} .banner{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:1.2mm 0;text-align:center;font-weight:700;font-size:4.5mm;margin:0.8mm 0;border-radius:1mm;} .section{border:0.6mm solid #2c3e50;border-radius:1.5mm;padding:1.2mm;margin:0.4mm 0;} .section-title{font-size:2.4mm;font-weight:700;margin-bottom:0.6mm;} .field-row{display:flex;flex-direction:column;gap:0.3mm;margin:0.4mm 0;} .field-label{font-size:2mm;font-weight:600;} .field-value{font-size:2.6mm;} .field-value-large{font-size:3.8mm;font-weight:700;} .field-value-extra-large{font-size:5mm;font-weight:800;} .refrigerado-box{border:0.6mm dashed #16a085;border-radius:1.5mm;padding:0.8mm 1.5mm;margin-top:0.6mm;font-size:2.4mm;background:#ecf8f6;} .footer{margin-top:auto;padding-top:0.6mm;font-size:1.5mm;text-align:center;} @media print{body*{visibility:hidden;} .sheet,.sheet *{visibility:visible;} .sheet{position:absolute;left:0;top:0;}}`;
            const _vCSSRefri = () => `@page{size:71mm 180mm;margin:0;}*{margin:0;padding:0;} html,body{width:71mm;height:180mm;font-family:Arial;text-transform:uppercase;} .sheet{width:71mm;height:180mm;padding:1mm;} .header{text-align:center;border-bottom:0.5mm solid #1a1a1a;padding:0.6mm;} .header-title{font-size:2.5mm;font-weight:900;} .banner{background:#000;color:#fff;text-align:center;font-weight:900;font-size:5.5mm;padding:1.5mm 0;margin:1mm 0;} .info-box{border:0.8mm solid #000;border-radius:2.5mm;padding:1.5mm;margin:0.6mm 0;} .info-box-title{font-size:2.2mm;font-weight:900;} .info-box-content{font-size:5.5mm;font-weight:900;} .cantidad-box{border:1.5mm solid #000;border-radius:3.5mm;display:flex;align-items:center;justify-content:center;font-size:16mm;font-weight:900;} .footer{font-size:2mm;text-align:center;} @media print{body*{visibility:hidden;} .sheet,.sheet *{visibility:visible;} .sheet{position:absolute;left:0;top:0;}}`;

            const _vCSSVentanilla = () => `@page{size:71mm 165mm;margin:10mm 0;}*{margin:0;padding:0;box-sizing:border-box;}html,body{width:71mm;min-height:145mm;height:145mm;margin:0;padding:0;font-family:'Segoe UI',Arial,Helvetica,sans-serif;text-transform:uppercase;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.sheet{width:71mm;min-height:145mm;height:145mm;padding:0.8mm 0.9mm;overflow:hidden;background:#fff;position:relative;display:flex;flex-direction:column;gap:1.1mm;}.v-logos-row{display:flex;align-items:center;justify-content:space-between;padding:0.8mm 0.9mm;margin:0;border:0.4mm solid #000;border-radius:2.5mm;background:#fff;}.v-logo{width:32mm;height:15mm;object-fit:contain;flex-shrink:0;}.v-title-full{font-size:2.9mm;font-weight:800;text-align:center;color:#000;line-height:1.25;letter-spacing:0.06mm;padding:0.9mm 0.8mm;margin:0;border:0.4mm solid #000;border-radius:2.5mm;background:#f9f9f9;}.v-box{border:0.4mm solid #000;border-radius:2.5mm;padding:0.7mm 0.9mm;margin:0;}.v-name-box{font-family:'Segoe UI',Arial Black,Arial,sans-serif;font-size:7.5mm;font-weight:900;color:#000;line-height:1.15;letter-spacing:0.08mm;word-wrap:break-word;text-align:center;background:#fafafa;}.v-dni-box{font-family:'Segoe UI',Arial Black,Arial,sans-serif;font-size:7.5mm;font-weight:900;color:#000;line-height:1.15;letter-spacing:0.06mm;word-wrap:break-word;text-align:center;background:#fafafa;display:flex;flex-direction:column;gap:0.3mm;}.v-dni-box .v-dni-head{display:flex;align-items:center;justify-content:center;gap:0.5mm;}.v-dni-box .v-dni-label{font-size:2mm;font-weight:800;}.v-fecha-box,.v-cc-box{display:flex;flex-direction:column;gap:0.25mm;}.v-fecha-box,.v-cc-box{align-items:center;text-align:center;}.v-fecha-box .v-box-head,.v-cc-box .v-box-head{justify-content:center;}.v-fecha-box .v-box-label,.v-cc-box .v-box-label{font-size:1.8mm;font-weight:800;color:#000;}.v-fecha-box .v-box-value{font-size:4.2mm;font-weight:700;color:#000;word-wrap:break-word;line-height:1.15;text-align:center;}.v-cc-box .v-box-value{font-size:3mm;font-weight:700;color:#000;word-wrap:break-word;line-height:1.15;text-align:center;}.v-fecha-box .v-box-head,.v-cc-box .v-box-head{display:flex;align-items:center;gap:0.5mm;}.v-meds{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.3mm;}.v-meds .v-meds-label{font-size:2.2mm;font-weight:800;color:#000;text-align:center;}.v-meds .v-meds-value{font-size:6.5mm;font-weight:900;color:#000;text-align:center;letter-spacing:0.1mm;}.v-refri{display:flex;align-items:center;justify-content:center;gap:0.7mm;padding:0.6mm 0.8mm;border:0.4mm solid #000;border-radius:2.5mm;margin:0;background:#fff3cd;font-size:2.8mm;font-weight:900;}.v-refri-icon{width:4mm;height:4mm;flex-shrink:0;stroke-width:1.75;color:#000;}.v-ventanilla{border:1.2mm solid #000;padding:2mm 1.4mm;text-align:center;font-size:7.5mm;font-weight:900;color:#000;margin:0;letter-spacing:0.2mm;background:linear-gradient(to bottom,#f5f5f5 0%,#e8e8e8 100%);display:flex;align-items:center;justify-content:center;gap:1.2mm;border-radius:2.5mm;flex-shrink:0;}.v-ventanilla.has-obs{padding:1.4mm 1.2mm;font-size:6mm;margin:0;}.v-ventanilla .v-icon{width:6mm;height:6mm;margin:0;}.v-ventanilla.has-obs .v-icon{width:5mm;height:5mm;}.v-obs{font-size:1.8mm;font-weight:700;color:#000;line-height:1.3;word-wrap:break-word;padding:0.7mm 0.9mm;margin:0;border:0.4mm solid #000;border-radius:2.5mm;background:#fafafa;text-align:center;}.v-footer{margin-top:auto;padding:1mm 1mm;font-size:2.8mm;text-align:center;color:#000;font-weight:700;border:0.4mm solid #000;border-radius:2.5mm;letter-spacing:0.05mm;line-height:1.35;}.v-icon{width:3.5mm;height:3.5mm;flex-shrink:0;stroke-width:1.75;color:#000;}@media print{body*{visibility:hidden;}.sheet,.sheet *{visibility:visible;}.sheet{position:absolute;left:0;top:0;}}`;

            const _vCSSRuta = () => `@page{size:210mm 71mm landscape;margin:0;}*{margin:0;padding:0;box-sizing:border-box;}html,body{width:210mm;height:71mm;margin:0;padding:0;font-family:'Arial Black','Arial',Helvetica,sans-serif;text-transform:uppercase;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;overflow:hidden;}.ruta-sheet{width:210mm;height:71mm;padding:0;position:relative;display:flex;flex-direction:column;gap:0.5mm;background:#fff;}.ruta-header{display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:1mm;padding:0.5mm 0;border-bottom:0.4mm solid #000;flex-shrink:0;width:100%;margin:0 3mm;box-sizing:border-box;}.ruta-title{font-size:2.2mm;font-weight:900;text-align:center;color:#000;letter-spacing:0.1mm;flex:1;font-family:'Arial Black','Arial',sans-serif;min-width:0;line-height:1.1;}.ruta-logo-header{object-fit:contain;flex-shrink:0;image-rendering:crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:pixelated;filter:contrast(1.1) brightness(0.98);-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-logo-left{width:18mm;height:8mm;max-width:18mm;max-height:8mm;margin-left:-3mm;}.ruta-logo-right{width:18mm;height:8mm;max-width:18mm;max-height:8mm;margin-right:-3mm;}.ruta-content{display:flex;gap:2.5mm;flex:1;min-height:0;margin:0 3mm;box-sizing:border-box;}.ruta-lado-a{width:50%;display:flex;flex-direction:column;gap:1.5mm;padding-right:1.2mm;border-right:0.3mm dashed #ccc;}.ruta-lado-b{width:50%;display:flex;flex-direction:column;gap:1.2mm;min-height:0;position:relative;}.ruta-b1{height:75%;display:flex;flex-direction:column;gap:0.8mm;min-height:0;}.ruta-b2{height:25%;display:flex;flex-direction:row;gap:1.2mm;align-items:flex-start;justify-content:flex-start;min-height:0;padding:0.3mm 0;position:relative;}.ruta-b2-content{display:flex;flex-direction:column;gap:0.8mm;flex:1;min-width:0;justify-content:space-between;height:100%;}.ruta-b2-info-item{display:flex;flex-direction:row;align-items:center;gap:0.8mm;flex-shrink:0;width:100%;}.ruta-b2-meds{justify-content:flex-start;}.ruta-b2-contact{justify-content:flex-start;}.ruta-b2-info-label{font-size:2.8mm;font-weight:900;color:#000;font-family:'Arial Black','Arial',sans-serif;white-space:nowrap;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-b2-info-value{font-size:3.2mm;font-weight:900;color:#000;font-family:'Arial Black','Arial',sans-serif;white-space:nowrap;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-box{border:0.4mm solid #000;border-radius:1.5mm;padding:1.2mm 1.5mm;background:#fafafa;font-family:'Arial Black','Arial',sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-box-address{border:0.6mm solid #000;border-radius:2mm;padding:1.5mm;background:#fff;position:relative;min-height:0;flex:1;display:flex;flex-direction:column;height:100%;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-name{font-size:7.5mm;font-weight:900;color:#000;line-height:1.15;letter-spacing:0.1mm;text-align:center;word-wrap:break-word;font-family:'Arial Black','Arial',sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-dni{font-size:7.5mm;font-weight:900;color:#000;line-height:1.15;letter-spacing:0.08mm;text-align:center;word-wrap:break-word;font-family:'Arial Black','Arial',sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-field{font-size:3.2mm;font-weight:900;color:#000;line-height:1.25;word-wrap:break-word;font-family:'Arial Black','Arial',sans-serif;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-field-label{font-size:3.6mm;font-weight:900;color:#333;margin-bottom:0.4mm;font-family:'Arial Black','Arial',sans-serif;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-field-value{font-size:3.5mm;font-weight:900;color:#000;font-family:'Arial Black','Arial',sans-serif;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-meds{text-align:center;}.ruta-meds-value{font-size:5mm;font-weight:900;color:#000;letter-spacing:0.2mm;font-family:'Arial Black','Arial',sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-address-content{font-weight:900;color:#000;line-height:1.4;word-wrap:break-word;flex:1;overflow:hidden;display:flex;flex-direction:column;justify-content:center;min-height:0;text-align:center;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-address-text{flex:1;min-height:0;overflow:hidden;display:flex;align-items:center;justify-content:center;box-sizing:border-box;text-align:center;font-family:'Arial Black','Arial',sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-address-separator{margin:0.5mm 0;font-weight:900;color:#333;}.ruta-fecha-box{text-align:center;flex-shrink:0;display:flex;align-items:center;justify-content:center;width:100%;padding:0.5mm 0;border:0.4mm solid #000;border-radius:1.5mm;background:#fafafa;font-family:'Arial Black','Arial',sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-fecha-value{font-size:8.5mm;font-weight:900;color:#000;letter-spacing:0.15mm;line-height:1.15;font-family:'Arial Black','Arial',sans-serif;text-transform:uppercase;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-fecha-value.no-qr{font-size:9mm;}.ruta-fecha-value-full{font-size:9mm;font-weight:900;color:#000;letter-spacing:0.15mm;line-height:1.15;font-family:'Arial Black','Arial',sans-serif;width:100%;text-align:center;text-transform:uppercase;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-qr-leyenda{display:flex;align-items:center;justify-content:flex-start;gap:1mm;flex-wrap:wrap;width:100%;flex-shrink:0;padding-top:0.3mm;max-width:100%;box-sizing:border-box;}.ruta-qr-texto{font-size:2.8mm;font-weight:900;color:#000;font-family:'Arial Black','Arial',sans-serif;white-space:nowrap;flex-shrink:0;letter-spacing:0.05mm;line-height:1.2;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-qr-instruction{font-size:2.4mm;font-weight:900;color:#000;font-family:'Arial Black','Arial',sans-serif;flex-shrink:1;min-width:0;letter-spacing:0.03mm;line-height:1.2;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-qr-flecha{font-size:4mm;font-weight:900;color:#000;font-family:'Arial Black','Arial',sans-serif;flex-shrink:0;margin-left:0.5mm;line-height:1;-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-qr-container{width:22mm;height:22mm;display:flex;align-items:center;justify-content:center;border:0.4mm solid #000;border-radius:1.5mm;background:#fff;padding:0.5mm;flex-shrink:0;min-width:22mm;min-height:22mm;position:absolute;top:-8mm;right:0;z-index:10;box-shadow:0 0 0.3mm rgba(0,0,0,0.1);-webkit-print-color-adjust:exact;print-color-adjust:exact;}.ruta-qr-container img{max-width:100%;max-height:100%;width:auto;height:auto;display:block;object-fit:contain;image-rendering:crisp-edges;image-rendering:-webkit-optimize-contrast;image-rendering:pixelated;-webkit-print-color-adjust:exact;print-color-adjust:exact;}@media print{body*{visibility:hidden;}.ruta-sheet,.ruta-sheet *{visibility:visible;}.ruta-sheet{position:absolute;left:0;top:0;}}`;

            const sep = ' ----- ';
            const _vFormatCC = (agenteName, userList, contactList) => {
                const name = (agenteName || '').trim();
                if (!name) return '‚Äî';
                const ulist = userList || [];
                const u = ulist.find(x => { const n = (x.nombre || x.username || x.name || '').trim().toLowerCase(); return n && n === name.toLowerCase(); });
                if (u) {
                    const tel = (u.telefono || u.phone || u.movil || u.tel || '').toString().trim();
                    return tel ? (u.nombre || u.username || u.name || name) + sep + tel : (u.nombre || u.username || u.name || name);
                }
                const clist = contactList || [];
                const c = clist.find(x => (x.name || '').trim().toLowerCase() === name.toLowerCase());
                if (c && (c.phone || '').toString().trim()) return (c.name || name) + sep + (c.phone || '').toString().trim();
                return name;
            };
            const _vNormalizeCC = (raw) => {
                if (!raw || !String(raw).trim()) return '';
                const s = String(raw).trim();
                if (s.includes(' --- ')) { const p = s.split(' --- '); return (p[0]||'').trim() + sep + (p[1]||'').trim(); }
                if (s.includes(sep)) return s;
                if (s.includes('---')) { const p = s.split('---'); return (p[0]||'').trim() + sep + (p[1]||'').trim(); }
                return '';
            };
            const _vFetchAgentFromFirebase = async (agenteName) => {
                const name = (agenteName || '').trim();
                if (!name || !firebaseInitialized || !db) return null;
                try {
                    const byNombre = await db.collection('prod_users').where('nombre', '==', name).limit(1).get();
                    if (!byNombre.empty) {
                        const d = byNombre.docs[0].data();
                        const tel = (d.telefono || d.phone || d.movil || d.tel || '').toString().trim();
                        const displayName = (d.nombre || d.username || d.name || name).trim();
                        return tel ? displayName + sep + tel : displayName;
                    }
                    const byUsername = await db.collection('prod_users').where('username', '==', name).limit(1).get();
                    if (!byUsername.empty) {
                        const d = byUsername.docs[0].data();
                        const tel = (d.telefono || d.phone || d.movil || d.tel || '').toString().trim();
                        const displayName = (d.nombre || d.username || d.name || name).trim();
                        return tel ? displayName + sep + tel : displayName;
                    }
                    const nameLower = name.toLowerCase();
                    const all = await db.collection('prod_users').get();
                    for (const doc of all.docs) {
                        const d = doc.data();
                        const n = (d.nombre || d.username || d.name || '').trim().toLowerCase();
                        if (n && n === nameLower) {
                            const tel = (d.telefono || d.phone || d.movil || d.tel || '').toString().trim();
                            const displayName = (d.nombre || d.username || d.name || name).trim();
                            return tel ? displayName + sep + tel : displayName;
                        }
                    }
                } catch (e) { console.warn('_vFetchAgentFromFirebase:', e); }
                return null;
            };

            const printVentanillaVignette = async (kit, patient) => {
                try {
                    let uk = kit || {}, up = patient || {};
                    if (kit?.id && firebaseInitialized && db) { try { const d = await db.collection('prod_kits').doc(kit.id).get(); if (d.exists) uk = { id: d.id, ...d.data() }; } catch(e) {} }
                    if (uk?.patientId && firebaseInitialized && db) { try { const d = await db.collection('prod_patients').doc(uk.patientId).get(); if (d.exists) up = { id: d.id, ...d.data() }; } catch(e) {} }
                    const nombre = (uk?.nombre || up?.nombre || '').toUpperCase();
                    const dni = (uk?.dni || up?.dni || '').toUpperCase();
                    const fe = uk?.fechaArmado || '';
                    const ccRaw = (uk?.contactCenter || up?.contactCenter || '').toString().trim();
                    const ccNormalized = _vNormalizeCC(ccRaw);
                    const agenteName = (up?.agenteContactCenter || uk?.agenteContactCenter || (ccRaw && !ccRaw.includes(' --- ') && !ccRaw.includes(' ----- ') ? ccRaw : '')).toString().trim();
                    let contactCenterDisplay = ccNormalized;
                    if (!contactCenterDisplay && agenteName) {
                        const fromFirebase = await _vFetchAgentFromFirebase(agenteName);
                        contactCenterDisplay = fromFirebase || _vFormatCC(agenteName, users, contacts);
                    } else if (!contactCenterDisplay) {
                        contactCenterDisplay = _vFormatCC(agenteName, users, contacts);
                    }
                    if (!contactCenterDisplay || contactCenterDisplay === '‚Äî') contactCenterDisplay = agenteName || '‚Äî';
                    const observaciones = (uk?.observations || uk?.observacionesEntrega || '').trim().toUpperCase();
                    const usuarioOperaciones = (uk?.usuarioOperaciones || currentUserForBlocks?.name || currentUserForBlocks?.nombre || currentUserForBlocks?.email || 'OPERADOR').toUpperCase();
                    const medicamentos = uk?.medicamentos || [];
                    const totalMeds = medicamentos.length;
                    const dispensadosMeds = medicamentos.filter(m => m.dispensar !== false).length;
                    const cantidadMeds = totalMeds > 0 ? `${dispensadosMeds}/${totalMeds}` : '0/0';
                    const isRefrigerado = uk?.isRefrigerated || false;
                    const cantRefri = uk?.cantRefriGlobal || (isRefrigerado ? 1 : 0);
                    const logo1 = (typeof LOGO1_URL !== 'undefined' && LOGO1_URL) ? LOGO1_URL : 'https://raw.githubusercontent.com/jose50440/bita/6a46e7144ce075c219a382364b611fa576fc5e4b/img/logo1.png';
                    const logo2 = (typeof LOGO2_URL !== 'undefined' && LOGO2_URL) ? LOGO2_URL : 'https://raw.githubusercontent.com/jose50440/bita/6a46e7144ce075c219a382364b611fa576fc5e4b/img/logo2.png';
                    const obsHtml = observaciones ? '<div class="v-obs">' + _vEsc(observaciones) + '</div>' : '';
                    const hasObs = !!observaciones;
                    const iconId = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>';
                    const iconCalendar = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>';
                    const iconPhone = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>';
                    const iconWindow = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>';
                    const iconMeds = '<svg class="v-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>';
                    const iconRefri = '<svg class="v-refri-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
                    const ventanillaClass = hasObs ? 'v-ventanilla has-obs' : 'v-ventanilla';
                    const nameHtml = '<div class="v-box v-name-box">'+_vEsc(nombre)+'</div>';
                    const dniHtml = '<div class="v-box v-dni-box"><div class="v-dni-head">'+iconId+'<span class="v-dni-label">DNI / AFILIACI√ìN</span></div><div>'+_vEsc(dni)+'</div></div>';
                    const fechaHtml = '<div class="v-box v-fecha-box"><div class="v-box-head">'+iconCalendar+'<span class="v-box-label">FECHA DE ENTREGA</span></div><div class="v-box-value">'+_vEsc(fe)+'</div></div>';
                    const ccHtml = '<div class="v-box v-cc-box"><div class="v-box-head">'+iconPhone+'<span class="v-box-label">CONTACT CENTER</span></div><div class="v-box-value">'+_vEsc(contactCenterDisplay)+'</div></div>';
                    const medsBoxHtml = '<div class="v-box v-meds"><div class="v-meds-label">MEDICAMENTOS</div><div class="v-meds-value">'+_vEsc(cantidadMeds)+'</div></div>';
                    const refriBoxHtml = cantRefri > 0 ? '<div class="v-refri">'+iconRefri+'<span>REFRIGERADO: '+_vEsc(String(cantRefri))+'</span></div>' : '';
                    const html = '<div class="sheet"><div class="v-logos-row"><img src="'+_vEsc(logo1)+'" alt="Logo 1" class="v-logo" onerror="this.style.display=\'none\'"/><img src="'+_vEsc(logo2)+'" alt="Logo 2" class="v-logo" onerror="this.style.display=\'none\'"/></div><div class="v-title-full">DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO</div>'+nameHtml+dniHtml+fechaHtml+ccHtml+medsBoxHtml+refriBoxHtml+'<div class="'+ventanillaClass+'">'+iconWindow+' VENTANILLA</div>'+obsHtml+'<div class="v-footer">OPERADOR DE EMPAQUE: '+_vEsc(usuarioOperaciones)+'</div></div>';
                    _vPw(html, _vCSSVentanilla(), 'Vi√±eta Ventanilla');
                } catch (e) {
                    console.error('Error vi√±eta Ventanilla:', e);
                    throw e;
                }
            };

            const printRefrigeradoVignette = async (kit, patient) => {
                let uk = kit, up = patient || {};
                if (kit?.id && firebaseInitialized && db) { try { const d = await db.collection('prod_kits').doc(kit.id).get(); if (d.exists) uk = { id: d.id, ...d.data() }; } catch(e) {} }
                if (uk?.patientId && firebaseInitialized && db) { try { const d = await db.collection('prod_patients').doc(uk.patientId).get(); if (d.exists) up = { id: d.id, ...d.data() }; } catch(e) {} }
                const dn = (uk?.nombre || up?.nombre || '').toUpperCase(), di = (uk?.dni || up?.dni || '').toUpperCase(), fe = uk?.fechaArmado || '';
                const cr = uk?.isRefrigerated ? (uk?.cantRefriGlobal || 1) : 0;
                const op = (currentUserForBlocks?.name || currentUserForBlocks?.nombre || '').toUpperCase(), tr = new Date().toLocaleString('es-ES',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).toUpperCase();
                const html = '<div class="sheet"><div class="header"><div class="header-title">DISPENSACI√ìN A DOMICILIO</div></div><div class="banner">‚ùÑ REFRIGERADO</div><div class="info-box"><div class="info-box-title">NOMBRE</div><div class="info-box-content">'+_vEsc(dn)+'</div></div><div class="info-box"><div class="info-box-title">DNI</div><div class="info-box-content">'+_vEsc(di)+'</div></div><div class="info-box"><div class="info-box-title">FECHA</div><div class="info-box-content">'+_vEsc(fe)+'</div></div><div class="cantidad-box">'+_vEsc(cr)+'</div><div class="footer">OP: '+_vEsc(op)+' | '+_vEsc(tr)+'</div></div>';
                _vPw(html, _vCSSRefri(), 'Vi√±eta Refrigerado');
            };
            
            // Funci√≥n para importar Excel y convertir a plantilla JSON (movida dentro de App)
            const importRutaTemplateFromExcel = async (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // Buscar hoja "RUTA" o usar la primera
                            let worksheet = workbook.Sheets['RUTA'] || workbook.Sheets[workbook.SheetNames[0]];
                            if (!worksheet) {
                                reject(new Error('No se encontr√≥ ninguna hoja en el archivo Excel'));
                                return;
                            }
                            
                            // Obtener rango y merges
                            const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1:Z100');
                            const merges = worksheet['!merges'] || [];
                            
                            // Dimensiones objetivo: 210mm x 71mm
                            const targetWidthMm = 210;
                            const targetHeightMm = 71;
                            const marginMm = 1; // 0.1cm = 1mm
                            const usableWidthMm = targetWidthMm - (marginMm * 2);
                            const usableHeightMm = targetHeightMm - (marginMm * 2);
                            
                            // Calcular ancho de columna promedio (asumiendo columnas uniformes)
                            const numCols = range.e.c - range.s.c + 1;
                            const numRows = range.e.r - range.s.r + 1;
                            const colWidthMm = usableWidthMm / numCols;
                            const rowHeightMm = usableHeightMm / numRows;
                            
                            const elements = [];
                            const processedCells = new Set();
                            
                            // Procesar merges primero
                            merges.forEach(merge => {
                                const startCell = XLSX.utils.encode_cell({ r: merge.s.r, c: merge.s.c });
                                const endCell = XLSX.utils.encode_cell({ r: merge.e.r, c: merge.e.c });
                                const cell = worksheet[startCell];
                                
                                if (cell && cell.v !== undefined) {
                                    const xMm = marginMm + (merge.s.c * colWidthMm);
                                    const yMm = marginMm + (merge.s.r * rowHeightMm);
                                    const wMm = (merge.e.c - merge.s.c + 1) * colWidthMm;
                                    const hMm = (merge.e.r - merge.s.r + 1) * rowHeightMm;
                                    
                                    // Detectar token
                                    const text = String(cell.v);
                                    let tokenKey = null;
                                    const tokenMatch = text.match(/\{\{(\w+)\}\}/);
                                    if (tokenMatch) {
                                        tokenKey = tokenMatch[1];
                                    }
                                    
                                    // Estilos b√°sicos
                                    const style = {
                                        bold: cell.s?.font?.bold || false,
                                        align: cell.s?.alignment?.horizontal || 'left',
                                        fontSize: cell.s?.font?.sz ? (cell.s.font.sz * 0.35) + 'mm' : '2mm'
                                    };
                                    
                                    elements.push({
                                        id: `cell_${merge.s.r}_${merge.s.c}`,
                                        xMm,
                                        yMm,
                                        wMm,
                                        hMm,
                                        text: tokenKey ? null : text,
                                        tokenKey: tokenKey,
                                        style: style,
                                        border: true
                                    });
                                    
                                    // Marcar celdas procesadas
                                    for (let r = merge.s.r; r <= merge.e.r; r++) {
                                        for (let c = merge.s.c; c <= merge.e.c; c++) {
                                            processedCells.add(`${r}_${c}`);
                                        }
                                    }
                                }
                            });
                            
                            // Procesar celdas no mergeadas
                            for (let r = range.s.r; r <= range.e.r; r++) {
                                for (let c = range.s.c; c <= range.e.c; c++) {
                                    const key = `${r}_${c}`;
                                    if (!processedCells.has(key)) {
                                        const cellAddr = XLSX.utils.encode_cell({ r, c });
                                        const cell = worksheet[cellAddr];
                                        
                                        if (cell && cell.v !== undefined) {
                                            const xMm = marginMm + (c * colWidthMm);
                                            const yMm = marginMm + (r * rowHeightMm);
                                            
                                            const text = String(cell.v);
                                            let tokenKey = null;
                                            const tokenMatch = text.match(/\{\{(\w+)\}\}/);
                                            if (tokenMatch) {
                                                tokenKey = tokenMatch[1];
                                            }
                                            
                                            const style = {
                                                bold: cell.s?.font?.bold || false,
                                                align: cell.s?.alignment?.horizontal || 'left',
                                                fontSize: cell.s?.font?.sz ? (cell.s.font.sz * 0.35) + 'mm' : '2mm'
                                            };
                                            
                                            elements.push({
                                                id: `cell_${r}_${c}`,
                                                xMm,
                                                yMm,
                                                wMm: colWidthMm,
                                                hMm: rowHeightMm,
                                                text: tokenKey ? null : text,
                                                tokenKey: tokenKey,
                                                style: style,
                                                border: true
                                            });
                                        }
                                    }
                                }
                            }
                            
                            resolve({
                                elements: elements,
                                metadata: {
                                    importedAt: new Date().toISOString(),
                                    sourceFile: file.name,
                                    dimensions: { width: targetWidthMm, height: targetHeightMm }
                                }
                            });
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('Error leyendo el archivo'));
                    reader.readAsArrayBuffer(file);
                });
            };

            // Funci√≥n para importar Word (.docx) y convertir a plantilla HTML con tokens {{TOKEN}}
            const importRutaTemplateFromWord = async (file) => {
                if (!file) throw new Error('Archivo no v√°lido');
                if (typeof mammoth === 'undefined') {
                    throw new Error('Mammoth.js no est√° disponible. Verifique su conexi√≥n a internet.');
                }
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer });
                const html = (result && result.value) ? String(result.value) : '';
                if (!html.trim()) {
                    throw new Error('El documento Word no contiene contenido convertible.');
                }
                return {
                    format: 'word',
                    html,
                    elements: [],
                    metadata: {
                        importedAt: new Date().toISOString(),
                        sourceFile: file.name,
                        sourceType: 'word'
                    }
                };
            };
            
            /**
             * Extrae tokens y estructura b√°sica del PDF usando PDF.js (fallback local)
             * No requiere SDK de IA
             */
            const extractPDFTokensLocal = async (pdfDoc, page) => {
                try {
                    // Extraer texto del PDF
                    const textContent = await page.getTextContent();
                    const textItems = textContent.items || [];
                    const fullText = textItems.map(item => item.str).join(' ');
                    
                    // Buscar tokens en formato {{TOKEN}}
                    const tokenPattern = /\{\{(\w+)\}\}/g;
                    const tokenMatches = [...fullText.matchAll(tokenPattern)];
                    const tokensFound = [...new Set(tokenMatches.map(m => `{{${m[1]}}}`))];
                    
                    // Obtener dimensiones de la p√°gina
                    const viewport = page.getViewport({ scale: 1.0 });
                    const widthMm = (viewport.width / 3.779).toFixed(2);
                    const heightMm = (viewport.height / 3.779).toFixed(2);
                    
                    // Crear elementos b√°sicos para cada token encontrado
                    const elements = [];
                    let yOffset = 20; // Posici√≥n inicial en mm
                    
                    tokensFound.forEach((token, idx) => {
                        const cleanToken = token.replace(/[{}]/g, '');
                        elements.push({
                            type: 'text',
                            token: token,
                            position: { 
                                x: 10 + (idx % 3) * 60, // Distribuir en 3 columnas
                                y: yOffset + Math.floor(idx / 3) * 15 
                            },
                            style: { 
                                fontSize: 12, 
                                fontWeight: 'bold', 
                                color: '#000000' 
                            }
                        });
                    });
                    
                    return {
                        tokensFound: tokensFound,
                        structure: `PDF importado en modo local. Dimensiones: ${widthMm}mm x ${heightMm}mm. Se encontraron ${tokensFound.length} tokens.`,
                        dimensions: { 
                            width: parseFloat(widthMm), 
                            height: parseFloat(heightMm) 
                        },
                        elements: elements,
                        fullText: fullText.substring(0, 500) // Primeros 500 caracteres para referencia
                    };
                } catch (error) {
                    console.warn('Error extrayendo tokens localmente:', error);
                    // Retornar estructura m√≠nima
                    return {
                        tokensFound: [],
                        structure: 'Error extrayendo tokens del PDF',
                        dimensions: { width: 210, height: 71 },
                        elements: []
                    };
                }
            };
            
            // Funci√≥n para importar PDF y analizar con Gemini 3.0 para extraer estructura y tokens
            const importRutaTemplateFromPDF = async (file) => {
                if (!file) throw new Error('Archivo no v√°lido');
                
                // Verificar dependencias b√°sicas
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js no est√° disponible. Verifique su conexi√≥n a internet.');
                }
                
                // Variables para tracking
                let useAIAnalysis = false;
                let aiAnalysisError = null;
                let localAnalysis = null;
                
                try {
                    // Configurar PDF.js worker
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    // Leer PDF como arrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const pdfDoc = await pdfjsLib.getDocument({ data: uint8Array }).promise;
                    const page = await pdfDoc.getPage(1);
                    
                    // PRIMERO: Intentar an√°lisis local (siempre funciona)
                    console.log('üìÑ Extrayendo tokens del PDF localmente...');
                    localAnalysis = await extractPDFTokensLocal(pdfDoc, page);
                    console.log(`‚úÖ An√°lisis local completado: ${localAnalysis.tokensFound.length} tokens encontrados`);
                    
                    // SEGUNDO: Intentar an√°lisis con IA (opcional, no bloqueante)
                    try {
                        // Usar el loader singleton robusto
                        if (typeof window.loadGoogleGenerativeAI === 'function') {
                            console.log('ü§ñ Intentando an√°lisis con IA (Gemini)...');
                            const GenAI = await window.loadGoogleGenerativeAI({ timeout: 20000 });
                            
                            if (GenAI && typeof GenAI === 'function') {
                                // Convertir primera p√°gina a imagen para enviar a Gemini
                                const viewport = page.getViewport({ scale: 2.0 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                await page.render({
                                    canvasContext: context,
                                    viewport: viewport
                                }).promise;
                                
                                // Convertir canvas a base64
                                const imageBase64 = canvas.toDataURL('image/png').split(',')[1];
                                
                                // Inicializar Gemini con API key
                                const GEMINI_API_KEY = 'AIzaSyCzWjsek2kIlQfgQwl7BRTt3PtMMgFS9r0';
                                const genAI = new GenAI(GEMINI_API_KEY);
                                const model = genAI.getGenerativeModel({ model: 'gemini-1.5-pro' });
                                
                                // Prompt para Gemini
                                const prompt = `Analiza esta imagen de una vi√±eta/etiqueta de entrega de medicamentos (210mm x 71mm horizontal).

INSTRUCCIONES:
1. Identifica TODOS los tokens que encuentres en el formato {{TOKEN}} (ej: {{NOMBRE}}, {{DNI}}, etc.)
2. Describe la estructura visual del documento (posiciones aproximadas de elementos, fuentes, tama√±os, colores)
3. Identifica √°reas donde deber√≠an ir los datos din√°micos

TOKENS DISPONIBLES que puedes encontrar:
- {{NOMBRE}} - Nombre del paciente
- {{DNI}} - DNI del paciente
- {{GPS_STATUS}} - Estado GPS (TIENE GPS o vac√≠o)
- {{TELEFONOS}} - Tel√©fonos combinados
- {{TEL_PERSONAL}} - Tel√©fono personal
- {{TEL_FAMILIAR}} - Tel√©fono familiar
- {{TEL_PERSONAL_BOX}} - Tel√©fono personal con recuadro (si est√° seleccionado)
- {{TEL_FAMILIAR_BOX}} - Tel√©fono familiar con recuadro (si est√° seleccionado)
- {{MEDS_COUNT}} - Cantidad de medicamentos
- {{DIRECCION_ENTREGA}} - Direcci√≥n de entrega
- {{INSTRUCCIONES_ENTREGA}} - Instrucciones de entrega
- {{OBSERVACIONES}} - Observaciones
- {{CONTACT_CENTER}} - Contact Center
- {{FECHA_ENTREGA}} - Fecha de entrega
- {{REFRIGERADO}} - Si es refrigerado
- {{QR_MAPS}} - QR code para mapa GPS

Responde en formato JSON con esta estructura:
{
  "tokensFound": ["{{NOMBRE}}", "{{DNI}}", ...],
  "structure": "Descripci√≥n de la estructura visual",
  "dimensions": { "width": 210, "height": 71 },
  "elements": [
    {
      "type": "text|image|qr",
      "token": "{{NOMBRE}}",
      "position": { "x": 10, "y": 20 },
      "style": { "fontSize": 12, "fontWeight": "bold", "color": "#000000" }
    }
  ]
}`;
                                
                                // Enviar imagen a Gemini
                                const result = await model.generateContent([
                                    prompt,
                                    {
                                        inlineData: {
                                            data: imageBase64,
                                            mimeType: 'image/png'
                                        }
                                    }
                                ]);
                                
                                const response = await result.response;
                                const text = response.text();
                                
                                // Parsear respuesta de Gemini
                                let jsonText = text.trim();
                                if (jsonText.includes('```json')) {
                                    jsonText = jsonText.split('```json')[1].split('```')[0].trim();
                                } else if (jsonText.includes('```')) {
                                    jsonText = jsonText.split('```')[1].split('```')[0].trim();
                                }
                                
                                let geminiAnalysis;
                                try {
                                    geminiAnalysis = JSON.parse(jsonText);
                                    useAIAnalysis = true;
                                    console.log('‚úÖ An√°lisis con IA completado');
                                } catch (parseError) {
                                    console.warn('‚ö†Ô∏è Gemini no devolvi√≥ JSON v√°lido, usando an√°lisis local:', parseError);
                                    // Usar an√°lisis local como fallback
                                    geminiAnalysis = localAnalysis;
                                }
                                
                                // Convertir PDF completo a base64 para almacenar
                                const pdfBase64 = btoa(String.fromCharCode(...uint8Array));
                                
                                return {
                                    format: 'pdf',
                                    pdfBase64: pdfBase64,
                                    pdfOriginal: uint8Array,
                                    geminiAnalysis: useAIAnalysis ? geminiAnalysis : null,
                                    elements: (useAIAnalysis && geminiAnalysis?.elements) ? geminiAnalysis.elements : localAnalysis.elements,
                                    metadata: {
                                        importedAt: new Date().toISOString(),
                                        sourceFile: file.name,
                                        sourceType: 'pdf',
                                        tokensFound: (useAIAnalysis && geminiAnalysis?.tokensFound) ? geminiAnalysis.tokensFound : localAnalysis.tokensFound,
                                        structure: (useAIAnalysis && geminiAnalysis?.structure) ? geminiAnalysis.structure : localAnalysis.structure,
                                        analysisMethod: useAIAnalysis ? 'ai' : 'local',
                                        aiError: null
                                    }
                                };
                            }
                        }
                    } catch (aiError) {
                        aiAnalysisError = aiError;
                        console.warn('‚ö†Ô∏è An√°lisis con IA no disponible, usando modo local:', aiError.message);
                        // Continuar con an√°lisis local (no lanzar error)
                    }
                    
                    // Si llegamos aqu√≠, usar an√°lisis local
                    const pdfBase64 = btoa(String.fromCharCode(...uint8Array));
                    
                    return {
                        format: 'pdf',
                        pdfBase64: pdfBase64,
                        pdfOriginal: uint8Array,
                        geminiAnalysis: null,
                        elements: localAnalysis.elements,
                        metadata: {
                            importedAt: new Date().toISOString(),
                            sourceFile: file.name,
                            sourceType: 'pdf',
                            tokensFound: localAnalysis.tokensFound,
                            structure: localAnalysis.structure + ' (Modo local: SDK de IA no disponible)',
                            analysisMethod: 'local',
                            aiError: aiAnalysisError ? aiAnalysisError.message : null
                        }
                    };
                    
                } catch (error) {
                    console.error('‚ùå Error procesando PDF:', error);
                    throw new Error('Error al procesar PDF: ' + error.message);
                }
            };
            
            // Funci√≥n para guardar plantilla RUTA (movida dentro de App)
            const saveRutaTemplate = async (templateData, isCurrent = true) => {
                try {
                    if (!firebaseInitialized || !db || !storage) {
                        throw new Error('Firebase no disponible');
                    }
                    
                    const versionId = Date.now().toString();
                    const timestamp = new Date().toISOString();
                    
                    // Guardar JSON en Firestore
                    const templateRef = db.collection('prod_templates_ruta').doc(isCurrent ? 'current' : versionId);
                    await templateRef.set({
                        ...templateData,
                        versionId: isCurrent ? 'current' : versionId,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        savedBy: userName || 'unknown'
                    });
                    
                    // Si es current, tambi√©n guardar en historial
                    if (isCurrent) {
                        await db.collection('prod_templates_ruta').doc(versionId).set({
                            ...templateData,
                            versionId: versionId,
                            savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            savedBy: userName || 'unknown'
                        });
                    }
                    
                    // Cargar plantilla actual
                    if (isCurrent) {
                        await loadRutaTemplateCurrent();
                    }
                    
                    return { success: true, versionId };
                } catch (error) {
                    console.error('Error guardando plantilla RUTA:', error);
                    throw error;
                }
            };

            // Verificar estado de Firebase peri√≥dicamente
            useEffect(() => {
                const handleInitialized = () => {
                    setIsFirebaseReady(true);
                    setFirebaseStatus('Conectado');
                };
                
                const handleError = () => {
                    setIsFirebaseReady(false);
                };
                
                window.addEventListener('firebaseInitialized', handleInitialized);
                window.addEventListener('firebaseError', handleError);
                
                // Verificar estado inicial
                const checkFirebaseStatus = async () => {
                    if (firebaseInitialized) {
                        setIsFirebaseReady(true);
                        const isConnected = await checkFirestoreConnection();
                        setFirebaseStatus(isConnected ? 'Conectado' : 'Desconectado');
                    } else {
                        setIsFirebaseReady(false);
                    }
                };

                checkFirebaseStatus();
                const interval = setInterval(checkFirebaseStatus, 5000); // Verificar cada 5 segundos

                return () => {
                    clearInterval(interval);
                    window.removeEventListener('firebaseInitialized', handleInitialized);
                    window.removeEventListener('firebaseError', handleError);
                };
            }, []);

            const handleLogout = () => { 
                // NO LIMPIAR EL CACHE al cerrar sesi√≥n
                sessionStorage.removeItem('leq_role');
                sessionStorage.removeItem('leq_username');
                sessionStorage.removeItem('leq_userData');
                setRole(null); 
                setUserName(null); 
                setCurrentUserData(null);
            };
            
            const handleLogin = (r, n, userData = null) => { 
                setRole(r); 
                setUserName(n); 
                setCurrentUserData(userData);
                sessionStorage.setItem('leq_role', r); 
                sessionStorage.setItem('leq_username', n); 
                if (userData) {
                    sessionStorage.setItem('leq_userData', JSON.stringify(userData));
                }
            };
            
            // Cargar datos del usuario desde sessionStorage al iniciar (departamento, rolesDepartamento, etc.)
            useEffect(() => {
                const savedUserData = sessionStorage.getItem('leq_userData');
                if (savedUserData) {
                    try {
                        setCurrentUserData(JSON.parse(savedUserData));
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
            }, []);

            const loadMedicines = async () => {
                try {
                    const cachedMedicines = cacheManager.getMedicines();
                    if (cachedMedicines) {
                        setMedicines(cachedMedicines);
                        console.log('‚úÖ Medicamentos cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_medicines').get();
                    const data = querySnapshot.docs.map(d => {
                        const docData = d.data();
                        // Compatibilidad: asegurar que siempre tenga name (puede venir como nombre en documentos antiguos)
                        return { 
                            id: d.id, 
                            ...docData,
                            name: docData.name || docData.nombre || '',
                            codigo: docData.codigo || '',
                            tipo: docData.tipo || 'no cronico'
                        };
                    })
                    .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    
                    cacheManager.saveMedicines(data);
                    setMedicines(data);
                    console.log('üî• Medicamentos cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando medicamentos:', error);
                }
            };

            const loadContacts = async () => {
                try {
                    const cachedContacts = cacheManager.getContacts();
                    if (cachedContacts) {
                        setContacts(cachedContacts);
                        console.log('‚úÖ Contactos cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_contacts').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    cacheManager.saveContacts(data);
                    setContacts(data);
                    console.log('üî• Contactos cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando contactos:', error);
                }
            };

            const needsUsersForTabs = () => {
                const roles = currentUserData?.rolesDepartamento || [];
                return role === 'admin' || role === 'superadmin' ||
                    (roles.includes('revision y asignacion') || roles.includes('agente contact center'));
            };

            const loadUsers = async () => {
                if (!needsUsersForTabs()) return;
                
                try {
                    const cachedUsers = cacheManager.getUsers();
                    if (cachedUsers) {
                        setUsers(cachedUsers);
                        console.log('‚úÖ Usuarios cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_users').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    cacheManager.saveUsers(data);
                    setUsers(data);
                    console.log('üî• Usuarios cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando usuarios:', error);
                    if (error.code === 'permission-denied') {
                        console.warn('‚ö†Ô∏è Permisos insuficientes para cargar usuarios');
                    }
                }
            };

            const loadKits = async () => {
                try {
                    const cachedKits = cacheManager.getKits();
                    if (cachedKits) {
                        setKits(cachedKits);
                        console.log('‚úÖ Kits cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_kits').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                    
                    cacheManager.saveKits(data);
                    setKits(data);
                    console.log('üî• Kits cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando kits:', error);
                }
            };

            const refetchKits = async () => {
                try {
                    if (!firebaseInitialized || !db) return;
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                    const querySnapshot = await db.collection('prod_kits').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => new Date(b.fechaArmado || 0) - new Date(a.fechaArmado || 0));
                    cacheManager.saveKits(data);
                    setKits(data);
                    console.log('üî• Kits refetch desde Firebase');
                } catch (error) {
                    console.error('Error refetch kits:', error);
                }
            };

            const loadPatients = async () => {
                try {
                    if (!firebaseInitialized || !db) return;
                    const querySnapshot = await db.collection('prod_patients').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setPatients(data);
                    console.log('üî• Pacientes cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando pacientes:', error);
                }
            };

            useEffect(() => {
                if (!role || !firebaseInitialized) return;
                
                loadMedicines();
                loadContacts();
                loadUsers();
                loadKits();
                loadPatients();
                loadRutaTemplateCurrent();
                
                // Escuchar cambios en tiempo real solo si Firebase est√° inicializado
                if (firebaseInitialized && db) {
                    const handleSnapshotError = (error, collectionName) => {
                        console.error(`‚ùå Error en snapshot de ${collectionName}:`, error);
                        if (error.code === 'permission-denied') {
                            console.warn(`‚ö†Ô∏è Permisos insuficientes para ${collectionName}`);
                        }
                    };
                    
                    const unsubPatients = db.collection('prod_patients')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                                setPatients(data);
                            },
                            error => handleSnapshotError(error, 'patients')
                        );
                    
                    const unsubMedicines = db.collection('prod_medicines')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => a.name.localeCompare(b.name));
                                setMedicines(data);
                                cacheManager.saveMedicines(data);
                            },
                            error => handleSnapshotError(error, 'medicines')
                        );
                    
                    const unsubContacts = db.collection('prod_contacts')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => a.name.localeCompare(b.name));
                                setContacts(data);
                                cacheManager.saveContacts(data);
                            },
                            error => handleSnapshotError(error, 'contacts')
                        );
                    
                    const unsubKits = db.collection('prod_kits')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                                setKits(data);
                                cacheManager.saveKits(data);
                            },
                            error => handleSnapshotError(error, 'kits')
                        );
                    
                    if (needsUsersForTabs()) {
                        const unsubUsers = db.collection('prod_users')
                            .onSnapshot(
                                s => {
                                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                                    setUsers(data);
                                    cacheManager.saveUsers(data);
                                },
                                error => handleSnapshotError(error, 'users')
                            );
                        
                        return () => {
                            unsubPatients();
                            unsubMedicines();
                            unsubContacts();
                            unsubKits();
                            unsubUsers();
                        };
                    }
                    
                    return () => {
                        unsubPatients();
                        unsubMedicines();
                        unsubContacts();
                        unsubKits();
                    };
                }
            }, [role, firebaseInitialized, currentUserData]);

            // Funci√≥n helper para filtrar solo los campos permitidos en pacientes
            const filterAllowedPatientFields = (data) => {
                const allowedFields = ['dni', 'nAfiliacion', 'nombre', 'telefono', 'familiar', 'telefonoFamiliar', 'direccion', 'descripcionMunicipio', 'tipoAfiliado', 'agenteContactCenter', 'usuarioRevisionAsignacion'];
                const filtered = {};
                
                // Solo incluir campos permitidos
                allowedFields.forEach(field => {
                    if (data.hasOwnProperty(field)) {
                        filtered[field] = data[field] ?? '';
                    }
                });
                
                // Asegurar que nAfiliacion siempre sea igual a dni
                if (filtered.dni) {
                    filtered.nAfiliacion = filtered.dni;
                }
                
                return filtered;
            };

            const addPatient = async (d) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    // Filtrar solo campos permitidos antes de guardar
                    const cleanData = filterAllowedPatientFields(d);
                    
                    const result = await db.collection('prod_patients').add({
                        ...cleanData, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("‚úÖ Paciente guardado con ID: ", result.id);
                    cacheManager.clearPatientCache();
                    return result;
                } catch (error) {
                    console.error("‚ùå Error guardando paciente: ", error);
                    // Manejar errores de permisos espec√≠ficamente
                    if (error.code === 'permission-denied') {
                        throw new Error("Permisos insuficientes. Verifica las reglas de seguridad de Firestore.");
                    }
                    throw error;
                }
            };
            
            const updatePatient = async (id, d) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    // Filtrar solo campos permitidos antes de actualizar
                    const cleanData = filterAllowedPatientFields(d);
                    const docRef = db.collection('prod_patients').doc(id);
                    const docSnap = await docRef.get();
                    
                    if (docSnap.exists) {
                        const updateData = { ...cleanData };
                        updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        await docRef.update(updateData);
                    } else {
                        // Si no existe, crear con solo campos permitidos
                        await docRef.set({
                            ...cleanData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    cacheManager.clearPatientCache(id);
                } catch (error) {
                    console.error("Error updating patient: ", error);
                    throw error;
                }
            };
            
            const deletePatient = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_patients').doc(id).delete();
                    // NO limpiar todo el cache (10,000). Solo invalidar caches de p√°ginas; la UI recarga la p√°gina actual.
                    cacheManager.clearPatientCache(id);
                    // Nota: el cache de p√°ginas se invalida por p√°gina en loadPatients(page, true)
                } catch (error) {
                    console.error("Error deleting patient: ", error);
                    throw error;
                }
            };
            
            const saveKit = async (id, data, pid, isUpdate) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    let resultId = id;
                    if(isUpdate) {
                        await db.collection('prod_kits').doc(id).update(data);
                        console.log("‚úÖ Kit actualizado: ", id);
                        try { await refetchKits(); } catch (e) { console.warn('Refetch kits post-update:', e); }
                    } else {
                        const result = await db.collection('prod_kits').add({
                            ...data, 
                            patientId: pid, 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        resultId = result.id;
                        console.log("‚úÖ Kit guardado con ID: ", resultId);
                    }
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                    return resultId;
                } catch (error) {
                    console.error("‚ùå Error guardando kit: ", error);
                    if (error.code === 'permission-denied') {
                        throw new Error("Permisos insuficientes. Verifica las reglas de seguridad de Firestore.");
                    }
                    throw error;
                }
            };
            
            const deleteKit = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_kits').doc(id).delete();
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                } catch (error) {
                    console.error("Error deleting kit: ", error);
                    throw error;
                }
            };
            
            const addMedsList = async (list) => { 
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const batch = db.batch();
                    let added = 0;
                    let updated = 0;
                    
                    for(const item of list) {
                        // Compatibilidad: si es string, convertir a objeto
                        let medData;
                        if (typeof item === 'string') {
                            medData = { 
                                name: item,
                                codigo: '',
                                tipo: 'no cronico'
                            };
                        } else {
                            // Objeto con id, codigo, name, tipo
                            medData = { 
                                codigo: item.codigo || '',
                                name: item.name || item.nombre || '',
                                tipo: item.tipo || 'no cronico'
                            };
                        }
                        
                        // Si tiene ID, actualizar existente; si no, crear nuevo
                        if (item.id) {
                            const medRef = db.collection('prod_medicines').doc(item.id);
                            batch.update(medRef, medData);
                            updated++;
                        } else {
                            const medRef = db.collection('prod_medicines').doc();
                            batch.set(medRef, medData);
                            added++;
                        }
                    }
                    
                    await batch.commit();
                    
                    if (added > 0 || updated > 0) {
                        const message = `‚úÖ ${added} medicamento(s) agregado(s)${updated > 0 ? `, ${updated} actualizado(s)` : ''}`;
                        console.log(message);
                        
                        // Recargar medicamentos usando loadMedicines
                        try {
                            await loadMedicines();
                        } catch (reloadError) {
                            console.error('Error recargando medicamentos:', reloadError);
                        }
                    }
                } catch (error) {
                    console.error("Error adding/updating medicines: ", error);
                    throw error;
                }
            };
            
            const addContact = async (name, phone) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_contacts').add({ name, phone });
                } catch (error) {
                    console.error("Error adding contact: ", error);
                    throw error;
                }
            };
            
            const deleteContact = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_contacts').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting contact: ", error);
                    throw error;
                }
            };

            const addUser = async (u) => {
                try {
                    // Esperar a que Firebase est√© inicializado si no lo est√°
                    let attempts = 0;
                    while ((!firebaseInitialized || !db) && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        console.error("‚ùå Firebase no disponible despu√©s de esperar");
                        console.error("firebaseInitialized:", firebaseInitialized);
                        console.error("db:", db);
                        throw new Error("Base de datos no disponible. Por favor, recarga la p√°gina.");
                    }
                    
                    console.log("üíæ Guardando usuario en Firestore...");
                    const result = await db.collection('prod_users').add(u);
                    console.log("‚úÖ Usuario guardado con ID:", result.id);
                    return result;
                } catch (error) {
                    console.error("‚ùå Error agregando usuario:", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    if (error.code === 'permission-denied') {
                        throw new Error("Permisos insuficientes. Verifica las reglas de seguridad de Firestore.");
                    }
                    throw error;
                }
            };
            
            const updateUser = async (id, u) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').doc(id).update(u);
                } catch (error) {
                    console.error("Error updating user: ", error);
                    throw error;
                }
            };
            
            const deleteUser = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting user: ", error);
                    throw error;
                }
            };

            // Permisos seg√∫n credencial: se agregan los de TODOS los cargos (rolesDepartamento).
            // Un usuario con varios cargos ve la uni√≥n de interfaces que cada cargo permite.
            const permissions = useMemo(() => {
                const dep = (currentUserData?.departamento || '').toLowerCase();
                const roles = currentUserData?.rolesDepartamento || [];
                const sys = role || '';
                const hasRevAsignacion = dep === 'farmacia' && roles.includes('revision y asignacion');
                const showCalendario = sys === 'admin' || sys === 'superadmin' ||
                    (dep === 'contact center' && roles.includes('agente contact center')) ||
                    hasRevAsignacion;
                const showDespacho = dep === 'farmacia' && roles.includes('despacho medicamentos');
                const onlyDespacho = showDespacho && !hasRevAsignacion;
                const showOperaciones = dep === 'operaciones' && (roles.includes('operador de empaque') || roles.includes('supervisor'));
                const showCalidad = dep === 'calidad' && (roles.includes('agente de calidad') || roles.includes('supervisor'));
                const canViewPacientes = !onlyDespacho && (
                    ['admin', 'superadmin', 'digitador'].includes(sys) || hasRevAsignacion
                );
                const showBitacoraTrabajo = dep === 'contact center' && roles.includes('agente contact center');
                return {
                    showCalendario,
                    showDespacho,
                    onlyDespacho,
                    showOperaciones,
                    showCalidad,
                    canViewReports: sys === 'admin' || sys === 'superadmin' || sys === 'supervisor',
                    canViewConfig: sys === 'admin' || sys === 'superadmin',
                    canViewPacientes,
                    showBitacoraTrabajo,
                };
            }, [currentUserData, role]);
            const { showCalendario, showDespacho, onlyDespacho, showOperaciones, showCalidad, canViewReports, canViewConfig, canViewPacientes, showBitacoraTrabajo } = permissions;
            const currentUserForBlocks = { name: userName, role: role, ...(currentUserData || {}) };
            useEffect(() => {
                if (view === 'reports' && !canViewReports) {
                    setView('dashboard');
                    return;
                }
                if (view === 'calendario' && !showCalendario) {
                    setView('dashboard');
                    return;
                }
                if (view === 'despacho' && !showDespacho) {
                    setView('dashboard');
                    return;
                }
                if (view === 'operaciones' && !showOperaciones) {
                    setView('dashboard');
                    return;
                }
                if (view === 'calidad' && !showCalidad) {
                    setView('dashboard');
                    return;
                }
                if ((view === 'config' || view === 'users') && !canViewConfig) {
                    setView('dashboard');
                    return;
                }
                if (view === 'pacientes' && !canViewPacientes) {
                    setView(onlyDespacho ? 'despacho' : 'dashboard');
                }
                if (view === 'bitacora' && !showBitacoraTrabajo) {
                    setView('dashboard');
                }
            }, [view, role, showCalendario, showDespacho, onlyDespacho, showOperaciones, showCalidad, canViewReports, canViewConfig, canViewPacientes, showBitacoraTrabajo]);

            // Mostrar pantalla de conexi√≥n si Firebase no est√° listo
            if (!isFirebaseReady && firebaseConnectionStatus !== 'connected') {
                return <FirebaseConnectionScreen />;
            }
            
            if (!role) return <LoginBlock onLogin={handleLogin} />;

            const NavItem = ({ id, label, icon: Icon }) => (
                <button 
                    onClick={() => { setView(id); setMobileMenuOpen(false); }} 
                    className={`w-full flex items-center gap-4 px-4 py-3.5 min-h-[48px] rounded-2xl transition-all font-bold group relative overflow-hidden btn-hover-effect touch-manipulation ${view === id ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`}
                >
                    <Icon size={20} className={view === id ? 'text-white' : 'text-turquoise-400 group-hover:text-white shrink-0'} />
                    <span className={`whitespace-nowrap transition-opacity duration-300 text-left ${sidebarCollapsed ? 'hidden opacity-0 w-0' : 'block opacity-100'}`}>
                        {label}
                    </span>
                </button>
            );

            const stats = { 
                totalKits: kits.length, 
                todayKits: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length 
            };

            return (
                <div className="app-layout flex h-screen bg-[#f0fdfa] font-sans overflow-hidden overflow-x-hidden">
                    {mobileMenuOpen && ( 
                        <div className="fixed inset-0 z-[100] bg-turquoise-900/95 backdrop-blur-sm flex flex-col md:hidden animate-in" style={{ paddingTop: 'env(safe-area-inset-top)', paddingBottom: 'env(safe-area-inset-bottom)' }}>
                            <div className="p-4 flex justify-between items-center border-b border-turquoise-800 shrink-0">
                                <div className="font-bold text-white text-xl flex items-center gap-2 brand-font">
                                    <img 
                                        src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" 
                                        alt="IHSS Logo" 
                                        className="w-6 h-6 object-contain"
                                        onError={(e) => {
                                            e.target.style.display = 'none';
                                        }}
                                    />
                                    IHSS A TU CASA
                                </div>
                                <button onClick={() => setMobileMenuOpen(false)} className="text-white p-3 min-w-[44px] min-h-[44px] flex items-center justify-center bg-turquoise-800 rounded-full btn-hover-effect touch-manipulation" aria-label="Cerrar men√∫">
                                    <Icons.X size={24}/>
                                </button>
                            </div>
                            <div className="p-6 space-y-1 overflow-y-auto flex-1">
                                <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                                {canViewReports && <NavItem id="reports" label={role === 'supervisor' ? 'Reportes de mi Dept.' : 'Reportes'} icon={Icons.List} />}
                                {showCalendario && <NavItem id="calendario" label="Calendario" icon={Icons.Calendar} />}
                                {showDespacho && <NavItem id="despacho" label="Lista de espera" icon={Icons.Box} />}
                                {showOperaciones && <NavItem id="operaciones" label="Operaciones" icon={Icons.Box} />}
                                {showCalidad && <NavItem id="calidad" label="Calidad" icon={Icons.Box} />}
                                {showBitacoraTrabajo && <NavItem id="bitacora" label="Bit√°cora de trabajo" icon={Icons.Activity} />}
                                {canViewPacientes && <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />}
                                {canViewConfig && <NavItem id="config" label="Configuraci√≥n" icon={Icons.Settings} />}
                                {canViewConfig && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                                <div className="pt-6 mt-4 border-t border-turquoise-800">
                                    <button onClick={handleLogout} className="w-full flex items-center gap-4 px-4 py-3.5 min-h-[48px] rounded-2xl bg-turquoise-800 text-white font-bold btn-hover-effect touch-manipulation">
                                        <Icons.LogOut size={20}/> Desconectar
                                    </button>
                                </div>
                            </div>
                        </div> 
                    )}
                    
                    <aside className={`${sidebarCollapsed ? 'w-24' : 'w-72'} bg-turquoise-900 text-turquoise-100 flex-col shadow-2xl z-20 hidden md:flex relative transition-all duration-300 ease-in-out`}>
                        <div className={`p-6 pb-2 relative z-10 flex ${sidebarCollapsed ? 'justify-center' : 'justify-between'} items-center`}>
                            {!sidebarCollapsed && (
                                <div className="flex items-center gap-3 text-white">
                                    <div className="w-10 h-10 rounded-xl shadow-lg overflow-hidden bg-white flex items-center justify-center">
                                        <img 
                                            src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" 
                                            alt="IHSS Logo" 
                                            className="w-full h-full object-contain"
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                                e.target.parentElement.className = 'bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg';
                                                e.target.parentElement.innerHTML = '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.384l-4.614-1.76a1 1 0 00-.836 1.838l7 3a1 1 0 00.788 0l7-3a1 1 0 00-.836-1.838L14.394 7.667a.999.999 0 01-.356.384l4.614 1.76a1 1 0 00.836-1.838l-7-3zM3.5 10.5a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1zm5 0a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1zm5 0a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1z"/></svg>';
                                            }}
                                        />
                                    </div>
                                    <span className="font-bold text-2xl brand-font animate-in">IHSS</span>
                                </div>
                            )}
                            {sidebarCollapsed && (
                                <div className="w-10 h-10 rounded-xl shadow-lg overflow-hidden bg-white flex items-center justify-center mb-2">
                                    <img 
                                        src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" 
                                        alt="IHSS Logo" 
                                        className="w-full h-full object-contain"
                                        onError={(e) => {
                                            e.target.style.display = 'none';
                                            e.target.parentElement.className = 'bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg mb-2';
                                            e.target.parentElement.innerHTML = '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.384l-4.614-1.76a1 1 0 00-.836 1.838l7 3a1 1 0 00.788 0l7-3a1 1 0 00-.836-1.838L14.394 7.667a.999.999 0 01-.356.384l4.614 1.76a1 1 0 00.836-1.838l-7-3zM3.5 10.5a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1zm5 0a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1zm5 0a1 1 0 01-1-1v-1a1 1 0 011-1h1a1 1 0 011 1v1a1 1 0 01-1 1h-1z"/></svg>';
                                        }}
                                    />
                                </div>
                            )}
                            <button 
                                onClick={() => setSidebarCollapsed(!sidebarCollapsed)} 
                                className="text-turquoise-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-turquoise-800 absolute right-4 top-6 btn-hover-effect" 
                                style={sidebarCollapsed ? { right: 'auto', top: 'auto', marginTop: '10px', position: 'static' } : {}}
                            >
                                {sidebarCollapsed ? <Icons.ChevronsRight size={20}/> : <Icons.ArrowLeft size={20}/>}
                            </button>
                        </div>
                        {!sidebarCollapsed && (
                            <div className="text-xs font-bold text-turquoise-400 uppercase tracking-widest pl-14 mb-4 animate-in">
                                A TU CASA
                            </div>
                        )}
                        <nav className="flex-1 px-4 py-4 space-y-2 relative z-10 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                            {canViewReports && <NavItem id="reports" label={role === 'supervisor' ? 'Reportes de mi Dept.' : 'Reportes'} icon={Icons.List} />}
                            {showCalendario && <NavItem id="calendario" label="Calendario" icon={Icons.Calendar} />}
                            {showDespacho && <NavItem id="despacho" label="Lista de espera" icon={Icons.Box} />}
                            {showOperaciones && <NavItem id="operaciones" label="Operaciones" icon={Icons.Box} />}
                            {showCalidad && <NavItem id="calidad" label="Calidad" icon={Icons.Box} />}
                            {showBitacoraTrabajo && <NavItem id="bitacora" label="Bit√°cora de trabajo" icon={Icons.Activity} />}
                            {canViewPacientes && <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />}
                            {canViewConfig && <NavItem id="config" label="Configuraci√≥n" icon={Icons.Settings} />}
                            {canViewConfig && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                        </nav>
                        <div className="p-4 mx-4 mb-4 rounded-2xl bg-turquoise-800/50 border border-turquoise-700/50 relative z-10">
                            <div className={`flex items-center gap-3 mb-4 ${sidebarCollapsed ? 'justify-center flex-col' : ''}`}>
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-clinical-400 to-clinical-600 flex items-center justify-center font-bold text-white text-sm shrink-0">
                                    {role==='superadmin'?'SA':role==='admin'?'AD':role==='supervisor'?'SU':'OP'}
                                </div>
                                {!sidebarCollapsed && (
                                    <div className="overflow-hidden">
                                        <div className="text-sm font-bold text-white capitalize truncate">{userName}</div>
                                        <div className="text-[10px] text-turquoise-300 truncate">{firebaseStatus}</div>
                                    </div>
                                )}
                            </div>
                            <button 
                                onClick={handleLogout} 
                                className={`w-full flex items-center gap-2 text-xs font-bold text-turquoise-200 hover:text-white py-2.5 rounded-xl hover:bg-turquoise-700 transition-colors btn-hover-effect ${sidebarCollapsed ? 'justify-center' : 'justify-center'}`} 
                                title="Desconectar"
                            >
                                <Icons.LogOut size={16}/> {!sidebarCollapsed && <span>Salir</span>}
                            </button>
                        </div>
                    </aside>

                    <main className="main-col flex-1 flex flex-col h-full overflow-hidden overflow-x-hidden bg-[#f0fdfa] relative transition-all duration-300 min-w-0">
                        <header className="md:hidden mobile-header-height fixed top-0 left-0 right-0 z-[60] bg-white/95 backdrop-blur-md shadow-sm flex justify-between items-center h-14 shrink-0 border-b border-slate-200" style={{ paddingTop: 'env(safe-area-inset-top)', paddingLeft: 'max(1rem, env(safe-area-inset-left))', paddingRight: 'max(1rem, env(safe-area-inset-right))' }}>
                            <button onClick={() => setMobileMenuOpen(true)} className="text-slate-600 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center -ml-2 btn-hover-effect touch-manipulation rounded-xl" aria-label="Abrir men√∫">
                                <Icons.Menu size={24}/>
                            </button>
                            <div className="font-bold text-slate-800 flex items-center gap-2 brand-font text-base truncate flex-1 justify-center">
                                <img 
                                    src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" 
                                    alt="IHSS Logo" 
                                    className="w-5 h-5 object-contain shrink-0"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                    }}
                                />
                                <span className="truncate">IHSS A TU CASA</span>
                            </div>
                            <div className="w-10 shrink-0" aria-hidden="true"></div>
                        </header>
                        <div className="mobile-content-area flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-8 scroll-smooth relative z-10 min-w-0 mobile-content-pt">
                            {view === 'dashboard' && <DashboardBlock setView={setView} stats={stats} userName={userName} role={role} kits={kits} currentUser={currentUserForBlocks} patients={patients} users={users} permissions={permissions} />}
                            {view === 'reports' && canViewReports && <ReportsBlock kits={kits} patients={patients} userRole={role} userName={userName} setView={setView} currentUser={currentUserForBlocks} users={users} />}
                            {view === 'calendario' && showCalendario && <CalendarioBlock kits={kits} patients={patients} setView={setView} currentUser={currentUserForBlocks} users={users} role={role} onSaveKit={saveKit} permissions={permissions} />}
                            {view === 'despacho' && showDespacho && <DespachoListaEsperaBlock kits={kits} patients={patients} onSaveKit={saveKit} currentUser={currentUserForBlocks} users={users} />}
                            {view === 'operaciones' && showOperaciones && <OperacionesListaEsperaBlock kits={kits} patients={patients} onSaveKit={saveKit} currentUser={currentUserForBlocks} users={users} printRutaVignette={printRutaVignette} printVentanillaVignette={printVentanillaVignette} printRefrigeradoVignette={printRefrigeradoVignette} />}
                            {view === 'calidad' && showCalidad && <CalidadListaEsperaBlock kits={kits} patients={patients} onSaveKit={saveKit} onRefreshKits={refetchKits} currentUser={currentUserForBlocks} users={users} />}
                            {view === 'bitacora' && showBitacoraTrabajo && <BitacoraTrabajoBlock kits={kits} patients={patients} currentUser={currentUserForBlocks} />}
                            {view === 'pacientes' && canViewPacientes && <PatientManagementBlock patients={patients} kits={kits} medicines={medicines} onAddPatient={addPatient} onUpdatePatient={updatePatient} onDeletePatient={deletePatient} onSaveKit={saveKit} onDeleteKit={deleteKit} currentUser={currentUserForBlocks} userRole={role} contacts={contacts} printRutaVignette={printRutaVignette} users={users} />}
                            {view === 'config' && canViewConfig && <ConfigBlock medicines={medicines} onAddList={addMedsList} contacts={contacts} onAddContact={addContact} onDeleteContact={deleteContact} rutaTemplateCurrent={rutaTemplateCurrent} importRutaTemplateFromExcel={importRutaTemplateFromExcel} importRutaTemplateFromWord={importRutaTemplateFromWord} importRutaTemplateFromPDF={importRutaTemplateFromPDF} saveRutaTemplate={saveRutaTemplate} loadRutaTemplateCurrent={loadRutaTemplateCurrent} />}
                            {view === 'users' && canViewConfig && <UserManagementBlock users={users} onAddUser={addUser} onUpdateUser={updateUser} onDeleteUser={deleteUser} />}
                            {((view === 'reports' && !canViewReports) || (view === 'calendario' && !showCalendario) || (view === 'despacho' && !showDespacho) || (view === 'operaciones' && !showOperaciones) || (view === 'calidad' && !showCalidad) || (view === 'bitacora' && !showBitacoraTrabajo) || (view === 'pacientes' && !canViewPacientes) || ((view === 'config' || view === 'users') && !canViewConfig)) && (
                                <div className="flex flex-col items-center justify-center min-h-[40vh] text-slate-500">
                                    <p className="font-bold mb-2">Sin acceso a esta secci√≥n. Redirigiendo‚Ä¶</p>
                                    <button onClick={() => setView(onlyDespacho ? 'despacho' : showOperaciones ? 'operaciones' : showCalidad ? 'calidad' : 'dashboard')} className="px-4 py-2 rounded-xl bg-turquoise-600 text-white font-bold text-sm hover:bg-turquoise-700">Ir al inicio</button>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>