<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bit√°cora de Producci√≥n - Operaciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (Para Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase (Versi√≥n COMPAT - Compatible con API global firebase.*) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        turquoise: { 50:'#f0fdfa', 100:'#ccfbf1', 200:'#99f6e4', 300:'#5eead4', 400:'#2dd4bf', 500:'#14b8a6', 600:'#0d9488', 700:'#0f766e', 800:'#115e59', 900:'#134e4a' },
                        clinical: { 50:'#f0fdf4', 100:'#dcfce7', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#15803d' }
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(20, 184, 166, 0.15)', glow: '0 0 15px rgba(45, 212, 191, 0.3)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdfa; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .row-hover-effect { transition: all 0.2s ease-out; border-left: 3px solid transparent; }
        .row-hover-effect:hover { background-color: white; transform: scale(1.005); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left-color: #0d9488; z-index: 10; position: relative; }

        .group-box { @apply border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4; }
        .group-title { @apply text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1; }

        /* Animaciones */
        @keyframes ekgPulse { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .animate-ekg { animation: ekgPulse 2s infinite ease-in-out; }
        
        /* Impresi√≥n espec√≠fica */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; padding: 0; margin: 0; }
        }
        
        /* Estilos para diferentes orientaciones */
        .print-vertical { width: 71mm; height: 210mm; }
        .print-horizontal { width: 210mm; height: 71mm; }
        
        /* Animaciones para men√∫s flotantes */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-in {
            animation: slideInUp 0.3s ease-out;
        }
        
        /* Estilos para botones flotantes estilo Canva */
        .fab-menu {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .fab-button {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .fab-menu-item {
            margin-bottom: 0.75rem;
            animation: slideInUp 0.2s ease-out;
        }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-turquoise-200 selection:text-turquoise-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        // CONFIGURACI√ìN DE FIREBASE - NUEVA BASE DE DATOS
        const firebaseConfig = {
            apiKey: "AIzaSyBJYFlJFJgrGNKuxshG79zvMifPn57m5X8",
            authDomain: "dataoperativa-c0c3e.firebaseapp.com",
            projectId: "dataoperativa-c0c3e",
            storageBucket: "dataoperativa-c0c3e.firebasestorage.app",
            messagingSenderId: "1041657828353",
            appId: "1:1041657828353:web:99b67aaedd93e583f51c00"
        };

        // Inicializar Firebase - Versi√≥n robusta y funcional
        let app, auth, db, storage;
        let firebaseInitialized = false;
        let firebaseConnectionError = null;
        let firebaseConnectionStatus = 'initializing';
        let firebaseInitPromise = null; // Singleton promise para evitar doble inicializaci√≥n
        
        // Smoke test para verificar conexi√≥n real a Firestore
        // Usa getDoc en lugar de limit(0) porque limit(0) no es v√°lido en Firestore
        const smokeTestFirestore = async (firestoreDb) => {
            try {
                // Test robusto: intentar leer un documento que probablemente no existe
                // Si el doc no existe, NO es error: significa que Firestore respondi√≥ correctamente
                const testDocRef = firestoreDb.collection('_health').doc('ping');
                const testDoc = await testDocRef.get();
                
                // Si llegamos aqu√≠, Firestore est√° conectado (exista o no el documento)
                return { success: true, error: null, isPermissionDenied: false, isNetworkError: false };
            } catch (error) {
                // Clasificar el error seg√∫n su c√≥digo
                if (error.code === 'permission-denied') {
                    // Firebase est√° conectado pero las reglas bloquean
                    console.warn("‚ö†Ô∏è Smoke test: Permisos restringidos (normal en modo prueba)");
                    return { success: true, error: null, isPermissionDenied: true, isNetworkError: false };
                }
                
                // Errores de red reales
                if (error.code === 'unavailable' || error.code === 'network-request-failed' || error.code === 'deadline-exceeded') {
                    console.error("‚ùå Smoke test: Error de red", error.code);
                    return { success: false, error, isPermissionDenied: false, isNetworkError: true };
                }
                
                // failed-precondition (offline persistence) - warning, no error fatal
                if (error.code === 'failed-precondition') {
                    console.warn("‚ö†Ô∏è Smoke test: Persistencia offline no disponible, pero Firebase est√° conectado");
                    return { success: true, error: null, isPermissionDenied: false, isNetworkError: false };
                }
                
                // Otros errores pueden ser de configuraci√≥n, pero no necesariamente de conexi√≥n
                console.warn("‚ö†Ô∏è Smoke test: Error inesperado", error.code, error.message);
                return { success: false, error, isPermissionDenied: false, isNetworkError: false };
            }
        };
        
        // Funci√≥n para inicializar Firebase cuando est√© disponible (singleton)
        const initializeFirebase = async () => {
            // Si ya hay una inicializaci√≥n en curso, retornar esa promise
            if (firebaseInitPromise) {
                return firebaseInitPromise;
            }
            
            // Si ya est√° inicializado, retornar inmediatamente
            if (firebaseInitialized && app && db && auth && storage) {
                return { app, auth, db, storage };
            }
            
            // Crear nueva promise de inicializaci√≥n
            firebaseInitPromise = (async () => {
            try {
                // Verificar que Firebase est√© disponible
                if (typeof firebase === 'undefined') {
                    throw new Error("firebase object no est√° disponible. Verifica que los scripts se carguen correctamente.");
                }
                
                // Verificar servicios necesarios
                if (typeof firebase.initializeApp === 'undefined') {
                    throw new Error("firebase.initializeApp no est√° disponible. Scripts incompletos.");
                }
                if (typeof firebase.firestore === 'undefined') {
                    throw new Error("firebase.firestore no est√° disponible. Scripts incompletos.");
                }
                if (typeof firebase.auth === 'undefined') {
                    throw new Error("firebase.auth no est√° disponible. Scripts incompletos.");
                }
                
                // Verificar si ya existe una app inicializada (evitar doble inicializaci√≥n)
                let existingApp = null;
                if (firebase.apps && Array.isArray(firebase.apps) && firebase.apps.length > 0) {
                    existingApp = firebase.apps.find(a => a.name === '[DEFAULT]');
                }
                
                // Inicializar o usar existente
                if (existingApp) {
                    app = existingApp;
                    console.log("‚úÖ Usando instancia existente de Firebase");
                } else {
                    app = firebase.initializeApp(firebaseConfig);
                    console.log("üöÄ Firebase app inicializada");
                }
                
                // Obtener servicios
                auth = firebase.auth();
                db = firebase.firestore();
                    storage = firebase.storage();
                
                if (!db) {
                    throw new Error("Firestore no se pudo inicializar");
                }
                    if (!storage) {
                        throw new Error("Storage no se pudo inicializar");
                    }
                    
                    // CR√çTICO: Habilitar persistencia ANTES de cualquier uso de Firestore
                    // Esto debe hacerse inmediatamente despu√©s de crear db, antes de cualquier query
                    console.log("üì¶ Habilitando persistencia offline...");
                    if (db && db.enablePersistence) {
                        try {
                            await db.enablePersistence();
                            console.log("‚úÖ Persistencia offline habilitada");
                        } catch (persistenceError) {
                            // Manejar errores de persistencia sin tumbar la inicializaci√≥n
                            if (persistenceError.code === 'failed-precondition') {
                                // M√∫ltiples tabs abiertos - solo uno puede tener persistencia
                                console.warn("‚ö†Ô∏è Persistencia offline no disponible: m√∫ltiples pesta√±as abiertas (normal)");
                            } else if (persistenceError.code === 'unimplemented') {
                                // Navegador no soporta IndexedDB
                                console.warn("‚ö†Ô∏è Persistencia offline no disponible: navegador no soporta IndexedDB");
                            } else {
                                // Otro error de persistencia
                                console.warn("‚ö†Ô∏è Persistencia offline no disponible:", persistenceError.code || persistenceError.message);
                            }
                            // NO lanzar error - la app puede funcionar sin persistencia
                        }
                    } else {
                        console.warn("‚ö†Ô∏è enablePersistence no est√° disponible en esta versi√≥n de Firestore");
                    }
                    
                    // AHORA S√ç: ejecutar smoke test DESPU√âS de habilitar persistencia
                console.log("üîç Ejecutando smoke test de Firestore...");
                const smokeTest = await smokeTestFirestore(db);
                
                if (!smokeTest.success) {
                        // Solo lanzar error si es un problema de red real
                        if (smokeTest.isNetworkError) {
                            throw new Error(`Error de red al conectar con Firestore: ${smokeTest.error?.code || 'network-error'}`);
                        }
                        
                        // Si el error NO es de red ni de permisos, verificar si Firebase est√° realmente inicializado
                        if (!smokeTest.isPermissionDenied) {
                            // Verificar si realmente tenemos acceso a Firebase
                            if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                                throw new Error("Firebase no est√° completamente inicializado. Los scripts pueden no haberse cargado correctamente.");
                            }
                            // Si Firebase est√° inicializado pero el smoke test fall√≥ por otra raz√≥n,
                            // considerar como √©xito (puede ser un problema temporal o de configuraci√≥n)
                            console.warn("‚ö†Ô∏è Smoke test fall√≥ pero Firebase est√° inicializado. Continuando...");
                        }
                    }
                    
                    // Si es permission-denied, mostrar advertencia pero continuar (√©xito)
                    if (smokeTest.isPermissionDenied) {
                        console.warn("‚ö†Ô∏è Firestore conectado pero reglas de seguridad bloquean acceso. Esto es normal si las reglas est√°n restringidas.");
                    }
                    
                    // Si llegamos aqu√≠, el smoke test pas√≥ o fue no cr√≠tico
                    console.log("‚úÖ Smoke test completado exitosamente");
                
                // Si llegamos aqu√≠, Firebase est√° completamente conectado
                firebaseInitialized = true;
                firebaseConnectionStatus = 'connected';
                firebaseConnectionError = null;
                console.log("‚úÖ Firebase completamente inicializado y conectado");
                console.log("‚úÖ Auth:", !!auth);
                console.log("‚úÖ Firestore:", !!db);
                    console.log("‚úÖ Storage:", !!storage);
                
                // Disparar evento personalizado
                window.dispatchEvent(new CustomEvent('firebaseInitialized', { 
                        detail: { app, auth, db, storage } 
                }));
                
                    return { app, auth, db, storage };
                
            } catch (error) {
                console.error("‚ùå Error al inicializar Firebase:", error);
                firebaseInitialized = false;
                firebaseConnectionStatus = 'error';
                firebaseConnectionError = {
                    code: error.code || 'initialization-error',
                    message: error.message || 'Error desconocido al inicializar Firebase',
                    details: error.toString()
                };
                
                window.dispatchEvent(new CustomEvent('firebaseError', { 
                    detail: firebaseConnectionError 
                }));
                    
                    // Limpiar promise para permitir reintento
                    firebaseInitPromise = null;
                    throw error;
                }
            })();
            
            return firebaseInitPromise;
        };
        
        // Funci√≥n de diagn√≥stico para detectar problemas de carga
        const runFirebaseDiagnostics = async () => {
            const diagnostics = {
                online: navigator.onLine,
                firebaseGlobal: typeof firebase !== 'undefined',
                firebaseApps: typeof firebase !== 'undefined' && firebase.apps ? firebase.apps.length : 0,
                scriptsLoaded: [],
                networkTest: null,
                timestamp: new Date().toISOString()
            };
            
            // Verificar recursos de Firebase cargados
            try {
                const resources = performance.getEntriesByType('resource');
                const firebaseResources = resources.filter(r => 
                    r.name.includes('firebasejs') || r.name.includes('gstatic.com/firebasejs')
                );
                diagnostics.scriptsLoaded = firebaseResources.map(r => ({
                    url: r.name,
                    duration: r.duration,
                    status: r.responseStatus || 'unknown',
                    loaded: r.duration > 0
                }));
            } catch (e) {
                diagnostics.scriptsLoaded = [{ error: 'No se pudo verificar recursos' }];
            }
            
            // Test de red a los scripts reales de Firebase (no a la ra√≠z que da 404)
            // Verificar que los scripts espec√≠ficos se cargaron correctamente
            try {
                const testStart = performance.now();
                // Test a uno de los scripts reales que se cargan (firebase-app-compat.js)
                const scriptUrl = 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js';
                const response = await fetch(scriptUrl, { 
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                diagnostics.networkTest = {
                    success: true,
                    duration: performance.now() - testStart,
                    testedUrl: scriptUrl
                };
            } catch (e) {
                diagnostics.networkTest = {
                    success: false,
                    error: e.message || 'Error de red',
                    testedUrl: 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js'
                };
            }
            
            return diagnostics;
        };
        
        // Funci√≥n mejorada para esperar Firebase con timeout robusto y reintento
        let waitAttempts = 0;
        let retryCount = 0;
        const MAX_WAIT_ATTEMPTS = 120; // 12 segundos (120 * 100ms)
        const MAX_RETRIES = 1; // 1 reintento adicional
        
        const waitForFirebase = async (isRetry = false) => {
            waitAttempts++;
            
            // Verificar que Firebase est√© disponible (COMPAT API)
            const isFirebaseReady = typeof firebase !== 'undefined' && 
                typeof firebase.initializeApp !== 'undefined' && 
                typeof firebase.firestore !== 'undefined' &&
                typeof firebase.auth !== 'undefined' &&
                firebase.apps !== undefined;
            
            if (isFirebaseReady) {
                // Verificar que firebase.apps est√© disponible
                if (firebase.apps && Array.isArray(firebase.apps)) {
                    console.log("‚úÖ Firebase scripts detectados correctamente");
                // Firebase est√° listo, inicializar
                    await initializeFirebase();
                    return;
                }
            }
            
            if (waitAttempts >= MAX_WAIT_ATTEMPTS) {
                // Timeout alcanzado - intentar reintento si no es un reintento
                if (!isRetry && retryCount < MAX_RETRIES) {
                    retryCount++;
                    waitAttempts = 0;
                    console.log(`üîÑ Reintentando carga de Firebase (intento ${retryCount + 1}/${MAX_RETRIES + 1})...`);
                    setTimeout(() => waitForFirebase(true), 1000);
                    return;
                }
                
                // Timeout final - ejecutar diagn√≥stico
                console.error("‚ùå Timeout esperando scripts de Firebase");
                const diagnostics = await runFirebaseDiagnostics();
                console.error("üìä Diagn√≥stico:", diagnostics);
                
                // Determinar causa del error
                let errorMessage = 'Los scripts de Firebase no se cargaron en el tiempo esperado';
                let errorDetails = 'Verifica tu conexi√≥n a internet y que los scripts se est√©n cargando correctamente desde gstatic.com';
                
                if (!diagnostics.online) {
                    errorMessage = 'Sin conexi√≥n a internet';
                    errorDetails = 'Tu dispositivo no est√° conectado a internet. Verifica tu conexi√≥n de red.';
                } else if (diagnostics.networkTest && !diagnostics.networkTest.success) {
                    errorMessage = 'Error de red al conectar con Firebase';
                    errorDetails = `No se pudo conectar con los servidores de Firebase (gstatic.com). Posibles causas:\n- Bloqueador de anuncios activo\n- Firewall o proxy bloqueando\n- DNS no resuelve gstatic.com\n\nPrueba en ventana inc√≥gnito o desactiva bloqueadores de anuncios.`;
                } else if (diagnostics.scriptsLoaded.length === 0) {
                    errorMessage = 'Scripts de Firebase no se cargaron';
                    errorDetails = 'Los scripts de Firebase no aparecen en los recursos cargados. Verifica la consola del navegador para errores de red.';
                }
                
                firebaseConnectionStatus = 'error';
                firebaseConnectionError = {
                    code: 'scripts-timeout',
                    message: errorMessage,
                    details: errorDetails,
                    diagnostics: diagnostics
                };
                window.dispatchEvent(new CustomEvent('firebaseError', { 
                    detail: firebaseConnectionError 
                }));
            } else {
                // Reintentar
                setTimeout(() => waitForFirebase(isRetry), 100);
            }
        };
        
        // Iniciar cuando el DOM est√© listo
        const startFirebaseInit = () => {
            // Esperar un poco para que los scripts se carguen
            setTimeout(() => waitForFirebase(false), 500);
        };
        
        if (document.readyState === 'loading') {
            window.addEventListener('load', startFirebaseInit);
        } else {
            startFirebaseInit();
        }
        
        // Funci√≥n global para reintentar manualmente
        window.retryFirebaseConnection = () => {
            waitAttempts = 0;
            retryCount = 0;
            firebaseConnectionStatus = 'initializing';
            firebaseConnectionError = null;
            firebaseInitPromise = null; // Limpiar promise para permitir reinicializaci√≥n
            firebaseInitialized = false; // Resetear estado
            startFirebaseInit();
        };
        
        // Funci√≥n global para ejecutar diagn√≥stico
        window.runFirebaseDiagnostics = runFirebaseDiagnostics;

        // Verificar conexi√≥n a Firestore (smoke test real)
        const checkFirestoreConnection = async () => {
            // Esperar hasta que Firebase est√© inicializado (m√°ximo 3 segundos)
            let attempts = 0;
            while (!firebaseInitialized && attempts < 30) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!firebaseInitialized || !db) {
                return false;
            }
            
            // Smoke test real: usar getDoc en lugar de limit(0) (limit(0) no es v√°lido)
            try {
                const testDocRef = db.collection('_health').doc('ping');
                await testDocRef.get();
                // Si llegamos aqu√≠, Firestore est√° conectado (exista o no el documento)
                return true;
            } catch (error) {
                // Si es error de permisos, Firebase est√° conectado (las reglas est√°n funcionando)
                if (error.code === 'permission-denied') {
                    return true; // Consideramos conectado, las reglas funcionan
                }
                // Errores de red son cr√≠ticos
                if (error.code === 'unavailable' || error.code === 'network-request-failed') {
                    console.warn("‚ö†Ô∏è Smoke test: Error de red", error.code);
                return false;
                }
                // Otros errores pueden ser no cr√≠ticos (persistencia offline, etc.)
                console.warn("‚ö†Ô∏è Smoke test fall√≥:", error.code, "pero Firebase est√° inicializado");
                return true; // Consideramos conectado si Firebase est√° inicializado
            }
        };

        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />,
            Users: (p) => <Icon {...p} path={<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            LogOut: (p) => <Icon {...p} path={<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Settings: (p) => <Icon {...p} path={<circle cx="12" cy="12" r="3"></circle>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash: (p) => <Icon {...p} path={<polyline points="3 6 5 6 21 6"></polyline>} />,
            Printer: (p) => <Icon {...p} path={<polyline points="6 9 6 2 18 2 18 9"></polyline>} />,
            ChevronsRight: (p) => <Icon {...p} path={<polyline points="13 17 18 12 13 7"></polyline>} />,
            UserCog: (p) => <Icon {...p} path={<circle cx="12" cy="7" r="4"></circle>} />,
            Menu: (p) => <Icon {...p} path={<line x1="3" y1="12" x2="21" y2="12"></line>} />,
            X: (p) => <Icon {...p} path={<line x1="18" y1="6" x2="6" y2="18"></line>} />,
            FileText: (p) => <Icon {...p} path={<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            Undo: (p) => <Icon {...p} path={<><polyline points="3 7 3 1 9 1"></polyline><path d="M21 12v6a2 2 0 0 1-2 2H3"></path><path d="M3 12l9-9 9 9"></path></>} />,
            Redo: (p) => <Icon {...p} path={<><polyline points="21 7 21 1 15 1"></polyline><path d="M3 12v6a2 2 0 0 0 2 2h16"></path><path d="M21 12l-9-9-9 9"></path></>} />,
            Minus: (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"></line>} />,
            Folder: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></>} />,
            LayoutDashboard: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Bot: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>} />,
            FolderPlus: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1 2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            FileSpreadsheet: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />,
            Layout: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></>} />,
            Type: (p) => <Icon {...p} path={<><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></>} />,
            Image: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>} />,
            Grid: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></>} />,
            QrCode: (p) => <Icon {...p} path={<><rect x="3" y="3" width="8" height="8"></rect><rect x="13" y="3" width="8" height="8"></rect><rect x="3" y="13" width="8" height="8"></rect><rect x="13" y="13" width="8" height="8"></rect></>} />,
            AlignLeft: (p) => <Icon {...p} path={<><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></>} />,
            AlignCenter: (p) => <Icon {...p} path={<><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></>} />,
            AlignRight: (p) => <Icon {...p} path={<><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></>} />
        };

        // --- COMPONENTS ---

        const AnimatedCounter = ({ value }) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0; const end = parseInt(value, 10);
                if (isNaN(end)) return;
                if (start === end) { setCount(end); return; }
                const duration = 1000; const incrementTime = 20; const stepAmount = Math.ceil(end / (duration / incrementTime));
                let timer = setInterval(() => {
                    start += stepAmount;
                    if (start >= end) { setCount(end); clearInterval(timer); } else { setCount(start); }
                }, incrementTime);
                return () => clearInterval(timer);
            }, [value]);
            return <span>{count}</span>;
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[95vh] modal-animate`}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col modal-animate p-6 text-center">
                        <h3 className="text-lg font-medium text-slate-900 mb-2">{title}</h3>
                        <p className="text-sm text-slate-500 mb-6">{message}</p>
                        <div className="flex justify-center gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-sm">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- EDITOR DE PLANTILLAS ELIMINADO ---
        const TemplateEditorBlock = () => {
            return null;
        };
        
        // C√≥digo del editor eliminado - placeholder para mantener estructura
        const _TemplateEditorBlockOld = ({ kitData, patientData }) => {
            const [elements, setElements] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [dragging, setDragging] = useState(false);
            const [resizing, setResizing] = useState(false);
            const [resizeHandle, setResizeHandle] = useState(null); // 'nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [resizeStart, setResizeStart] = useState({ x: 0, y: 0, width: 0, height: 0 });
            const [templateName, setTemplateName] = useState('Vi√±eta Ruta');
            const [savedTemplates, setSavedTemplates] = useState([]);
            const [showSaveModal, setShowSaveModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [templateHistory, setTemplateHistory] = useState([]);
            const [currentTemplateId, setCurrentTemplateId] = useState(null);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [templateType, setTemplateType] = useState('ruta'); // 'ventanilla', 'ruta', 'refrigerado'
            const [templateOrientation, setTemplateOrientation] = useState('horizontal'); // SOLO 'horizontal' (bloqueado)
            const [imageUploading, setImageUploading] = useState(false);
            const [uploadedImages, setUploadedImages] = useState([]);
            
            // Estados para paneles colapsables (todos contra√≠dos por defecto)
            const [panelElementos, setPanelElementos] = useState(false);
            const [panelCamposKit, setPanelCamposKit] = useState(false);
            const [panelLogos, setPanelLogos] = useState(false);
            const [panelPropiedades, setPanelPropiedades] = useState(false);
            const [panelPlantillas, setPanelPlantillas] = useState(false);
            
            // Estados para zoom y dise√±o estilo Canva
            const [zoomLevel, setZoomLevel] = useState(100); // Porcentaje de zoom
            const [showFloatingMenu, setShowFloatingMenu] = useState(false);
            const [floatingMenuType, setFloatingMenuType] = useState(null); // 'elements', 'fields', 'images', 'templates'
            
            // Estados para transformaci√≥n y rotaci√≥n
            const [rotation, setRotation] = useState(0);
            const [floatingToolbarPosition, setFloatingToolbarPosition] = useState({ x: 0, y: 0 });
            
            // Estados para undo/redo
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            
            // Ref para el contenedor de scroll
            const scrollContainerRef = useRef(null);
            const designAreaRef = useRef(null);
            
            // Funci√≥n para guardar estado en historial
            const saveToHistory = (newElements) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(JSON.parse(JSON.stringify(newElements)));
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
            };
            
            // Funci√≥n para deshacer
            const undo = () => {
                if (historyIndex > 0) {
                    const prevIndex = historyIndex - 1;
                    setHistoryIndex(prevIndex);
                    setElements(JSON.parse(JSON.stringify(history[prevIndex])));
                }
            };
            
            // Funci√≥n para rehacer
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    const nextIndex = historyIndex + 1;
                    setHistoryIndex(nextIndex);
                    setElements(JSON.parse(JSON.stringify(history[nextIndex])));
                }
            };
            
            const elementTypes = [
                { id: 'text', name: 'Texto', icon: Icons.Type, default: { content: 'Texto', fontSize: 12, color: '#000000', fontFamily: 'Arial', bold: false, italic: false, underline: false, strikethrough: false, textShadow: false, textOutline: false, width: 100, height: 30 } },
                { id: 'barcode', name: 'C√≥digo de Barras', icon: Icons.Grid, default: { content: '1234567890', width: 150, height: 50, type: 'code128' } },
                { id: 'qrcode', name: 'QR Code', icon: Icons.QrCode, default: { content: 'https://ejemplo.com', width: 100, height: 100 } },
                { id: 'rectangle', name: 'Rect√°ngulo', icon: Icons.Layout, default: { width: 100, height: 50, color: '#e5e7eb', borderWidth: 1, borderColor: '#000000' } },
                { id: 'line', name: 'L√≠nea', icon: Icons.Minus, default: { width: 150, height: 2, color: '#000000' } },
                { id: 'image', name: 'Imagen', icon: Icons.Image, default: { width: 100, height: 100, url: '', alt: 'Logo' } }
            ];

            // CAMPOS ACTUALIZADOS CON CANTIDAD DE MEDICAMENTOS Y REFRIGERADOS
            // Funci√≥n para obtener campos del kit actualizados (se recalcula cuando cambian kitData o patientData)
            const getKitFields = () => [
                { id: 'nombre', label: 'Nombre Paciente', value: kitData?.nombre || patientData?.nombre || 'NOMBRE PACIENTE' },
                { id: 'dni', label: 'DNI', value: kitData?.dni || patientData?.dni || '00000000' },
                { id: 'direccion', label: 'Direcci√≥n', value: patientData?.direccion || 'DIRECCI√ìN' },
                { id: 'telefono', label: 'Tel√©fono', value: patientData?.telefono || '000-0000' },
                { id: 'fechaArmado', label: 'Fecha Armado', value: kitData?.fechaArmado || '2024-01-01' },
                { id: 'horaOperaciones', label: 'Hora Operaciones', value: kitData?.horaOperaciones || '08:00 AM' },
                { id: 'digitador', label: 'Digitador', value: kitData?.digitador || 'DIGITADOR' },
                { id: 'contactCenter', label: 'Contact Center', value: kitData?.contactCenter || 'CONTACTO' },
                { id: 'deliveryMode', label: 'Modo Entrega', value: kitData?.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA' },
                { id: 'medicamentos', label: 'Medicamentos', value: kitData?.medicamentos?.map(m => m.nombre).join(', ') || 'MEDICAMENTOS' },
                { id: 'observaciones', label: 'Observaciones', value: kitData?.observations || 'OBSERVACIONES' },
                { id: 'gpsStatus', label: 'GPS', value: kitData?.gpsStatus || 'SIN GPS' },
                // NUEVOS CAMPOS
                { id: 'cantMedicamentos', label: 'Cantidad Medicamentos', value: kitData?.medicamentos?.length || 0 },
                { id: 'cantRefrigerados', label: 'Cantidad Refrigerados', value: kitData?.isRefrigerated ? (kitData?.cantRefriGlobal || 1) : 0 },
                { id: 'isRefrigerado', label: 'Es Refrigerado', value: kitData?.isRefrigerated ? 'S√ç' : 'NO' }
            ];

            const kitFields = getKitFields();

            // Tipograf√≠as disponibles
            const fontFamilies = [
                { value: 'Arial', label: 'Arial' },
                { value: 'Times New Roman', label: 'Times New Roman' },
                { value: 'Courier New', label: 'Courier New' },
                { value: 'Helvetica', label: 'Helvetica' },
                { value: 'Georgia', label: 'Georgia' },
                { value: 'Verdana', label: 'Verdana' },
                { value: 'Comic Sans MS', label: 'Comic Sans MS' },
                { value: 'Impact', label: 'Impact' },
                { value: 'Trebuchet MS', label: 'Trebuchet MS' },
                { value: 'Lucida Console', label: 'Lucida Console' },
                { value: 'Tahoma', label: 'Tahoma' },
                { value: 'Palatino', label: 'Palatino' }
            ];

            // Funci√≥n para crear las 3 plantillas PREDETERMINADAS exactas (71mm x 210mm horizontal)
            // Plantillas: RUTA, VENTANILLA, REFRIGERADOS
            const createPredeterminedTemplates = () => {
                const mmToPx = 3.779; // Conversi√≥n mm a px
                
                // PLANTILLA 1: RUTA
                const plantillaRuta = {
                    id: 'plantilla_ruta',
                    name: 'Plantilla Ruta',
                    type: 'ruta',
                    orientation: 'horizontal',
                    elements: [
                        // Encabezado con logos y t√≠tulo
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_ruta', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_ruta', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, content: 'ENTREGA EN RUTA', fontSize: 5.5*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        
                        // NOMBRE DEL DERECHOHABIENTE (muy legible)
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 21*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 25*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        
                        // DNI/ID (muy legible)
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 32*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 36*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        
                        // Tel√©fonos y GPS
                        { id: 'label_tel_principal', type: 'text', x: 2*mmToPx, y: 43*mmToPx, width: 45*mmToPx, height: 3.5*mmToPx, content: 'TEL PRINCIPAL', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_principal', type: 'text', x: 2*mmToPx, y: 47*mmToPx, width: 45*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefono' },
                        
                        { id: 'label_tel_ref', type: 'text', x: 50*mmToPx, y: 43*mmToPx, width: 30*mmToPx, height: 3.5*mmToPx, content: 'TEL REF', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_ref', type: 'text', x: 50*mmToPx, y: 47*mmToPx, width: 30*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefonoRef' },
                        
                        { id: 'label_gps', type: 'text', x: 83*mmToPx, y: 43*mmToPx, width: 25*mmToPx, height: 3.5*mmToPx, content: 'GPS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_gps', type: 'text', x: 83*mmToPx, y: 47*mmToPx, width: 25*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'gpsStatus' },
                        
                        { id: 'label_meds', type: 'text', x: 110*mmToPx, y: 43*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: '# MEDICAMENTOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_meds', type: 'text', x: 110*mmToPx, y: 47*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantMedicamentos' },
                        
                        // CAMPO GRANDE RUTA: Direcci√≥n + Observaciones
                        { id: 'label_direccion', type: 'text', x: 2*mmToPx, y: 52*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'DIRECCI√ìN', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_direccion', type: 'text', x: 2*mmToPx, y: 56*mmToPx, width: 100*mmToPx, height: 8*mmToPx, content: '', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'direccion' },
                        
                        { id: 'label_obs_ruta', type: 'text', x: 2*mmToPx, y: 65*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'OBSERVACIONES DE ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_obs_ruta', type: 'text', x: 2*mmToPx, y: 69*mmToPx, width: 100*mmToPx, height: 4*mmToPx, content: '', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'observaciones' },
                        
                        // Fecha y Refrigerado
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 52*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 56*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                        
                        { id: 'label_refri', type: 'text', x: 160*mmToPx, y: 52*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'REFRIGERADO', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_refri', type: 'text', x: 160*mmToPx, y: 56*mmToPx, width: 48*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantRefrigerados' },
                        
                        // Extra Ruta (editable)
                        { id: 'label_extra_titulo', type: 'text', x: 105*mmToPx, y: 61*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'EXTRA RUTA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_extra_contenido', type: 'text', x: 105*mmToPx, y: 65*mmToPx, width: 103*mmToPx, height: 4*mmToPx, content: '', fontSize: 4*mmToPx, color: '#666666', fontFamily: 'Arial', isField: false }
                    ]
                };
                
                // PLANTILLA 2: VENTANILLA
                const plantillaVentanilla = {
                    id: 'plantilla_ventanilla',
                    name: 'Plantilla Ventanilla',
                    type: 'ventanilla',
                    orientation: 'horizontal',
                    elements: [
                        // Encabezado (igual que Ruta)
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_ventanilla', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_ventanilla', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, content: 'ENTREGA VENTANILLA', fontSize: 5.5*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        
                        // NOMBRE y DNI (igual que Ruta)
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 21*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 25*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 32*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 36*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        
                        // Tel√©fonos, GPS, Meds (igual que Ruta)
                        { id: 'label_tel_principal', type: 'text', x: 2*mmToPx, y: 43*mmToPx, width: 45*mmToPx, height: 3.5*mmToPx, content: 'TEL PRINCIPAL', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_principal', type: 'text', x: 2*mmToPx, y: 47*mmToPx, width: 45*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefono' },
                        { id: 'label_tel_ref', type: 'text', x: 50*mmToPx, y: 43*mmToPx, width: 30*mmToPx, height: 3.5*mmToPx, content: 'TEL REF', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_ref', type: 'text', x: 50*mmToPx, y: 47*mmToPx, width: 30*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefonoRef' },
                        { id: 'label_gps', type: 'text', x: 83*mmToPx, y: 43*mmToPx, width: 25*mmToPx, height: 3.5*mmToPx, content: 'GPS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_gps', type: 'text', x: 83*mmToPx, y: 47*mmToPx, width: 25*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'gpsStatus' },
                        { id: 'label_meds', type: 'text', x: 110*mmToPx, y: 43*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: '# MEDICAMENTOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_meds', type: 'text', x: 110*mmToPx, y: 47*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantMedicamentos' },
                        
                        // CAMPO GRANDE VENTANILLA: "VENTANILLA" grande + Observaciones
                        { id: 'campo_ventanilla', type: 'text', x: 2*mmToPx, y: 52*mmToPx, width: 100*mmToPx, height: 10*mmToPx, content: 'VENTANILLA', fontSize: 18*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_obs_ventanilla', type: 'text', x: 2*mmToPx, y: 63*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'OBSERVACIONES DE VENTANILLA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_obs_ventanilla', type: 'text', x: 2*mmToPx, y: 67*mmToPx, width: 100*mmToPx, height: 4*mmToPx, content: '', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'observaciones' },
                        
                        // Fecha y Refrigerado
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 52*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 56*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_refri', type: 'text', x: 160*mmToPx, y: 52*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'REFRIGERADO', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_refri', type: 'text', x: 160*mmToPx, y: 56*mmToPx, width: 48*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantRefrigerados' }
                    ]
                };
                
                // PLANTILLA 3: REFRIGERADOS
                const plantillaRefrigerados = {
                    id: 'plantilla_refrigerados',
                    name: 'Plantilla Refrigerados',
                    type: 'refrigerado',
                    orientation: 'horizontal',
                    elements: [
                        // Encabezado
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        
                        // Banda grande REFRIGERADO
                        { id: 'banner_refri', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 8*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_refri', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 8*mmToPx, content: 'PRODUCTO REFRIGERADO', fontSize: 10*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        
                        // NOMBRE/ID (legibles)
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 26*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 30*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 37*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 41*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        
                        // Fecha y Cantidad
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 26*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA DESPACHO/ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 30*mmToPx, width: 50*mmToPx, height: 6*mmToPx, content: '', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_cant_refri', type: 'text', x: 160*mmToPx, y: 26*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'CANT REFRIGERADOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_cant_refri', type: 'text', x: 160*mmToPx, y: 30*mmToPx, width: 48*mmToPx, height: 12*mmToPx, content: '', fontSize: 20*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: true, fieldId: 'cantRefrigerados' }
                    ]
                };
                
                return [plantillaRuta, plantillaVentanilla, plantillaRefrigerados];
            };

            // Funci√≥n para cargar plantillas predeterminadas (obsoleta - usar createPredeterminedTemplates)
            const createNewTemplate = (type) => {
                // Convertir mm a px aproximado: 1mm ‚âà 3.779px a 96dpi
                // Para precisi√≥n, usamos coordenadas en mm y luego convertimos
                const mmToPx = 3.779;
                const pageWidth = 210; // mm
                const pageHeight = 71; // mm
                
                // Elementos base comunes para ambas plantillas
                const baseElements = [
                    // T√≠tulo principal - centrado en la parte superior
                    { id: 'title', type: 'text', x: 2, y: 1, width: 206, height: 5, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                    
                    // L√≠nea horizontal divisoria debajo del t√≠tulo
                    { id: 'line_top', type: 'line', x: 0, y: 6, width: 210, height: 0.3, color: '#000000', isField: false },
                    
                    // COLUMNA IZQUIERDA - Informaci√≥n del derechohabiente
                    // Secci√≥n: INFORMACION DE DERECHOHABIENTE (con l√≠nea punteada)
                    { id: 'section1_title', type: 'text', x: 2, y: 7.5, width: 100, height: 4, content: 'INFORMACION DE DERECHOHABIENTE', fontSize: 5.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'line_section1', type: 'line', x: 2, y: 11.5, width: 100, height: 0.2, color: '#000000', isField: false },
                    
                    // NOMBRE DEL DERECHOHABIENTE (2 filas)
                    { id: 'label_nombre', type: 'text', x: 2, y: 12.5, width: 100, height: 3.5, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'field_nombre1', type: 'text', x: 2, y: 16, width: 100, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'nombre' },
                    { id: 'field_nombre2', type: 'text', x: 2, y: 19.5, width: 100, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: false },
                    
                    // ID DEL DERECHOHABIENTE (2 filas)
                    { id: 'label_id', type: 'text', x: 2, y: 23.5, width: 100, height: 3.5, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'field_id1', type: 'text', x: 2, y: 27, width: 100, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'dni' },
                    { id: 'field_id2', type: 'text', x: 2, y: 30.5, width: 100, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: false },
                    
                    // Fila con TELEFONO PRINCIPAL y TELEFONO REF (con checkboxes)
                    { id: 'label_tel_principal', type: 'text', x: 2, y: 34.5, width: 45, height: 3.5, content: 'TELEFONO PRINCIPAL', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'checkbox_tel_principal', type: 'rectangle', x: 48, y: 34.5, width: 2.5, height: 2.5, color: 'transparent', borderWidth: 0.5, borderColor: '#000000', isField: false },
                    
                    { id: 'label_tel_ref', type: 'text', x: 2, y: 38.5, width: 45, height: 3.5, content: 'TELEFONO REF', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'checkbox_tel_ref', type: 'rectangle', x: 48, y: 38.5, width: 2.5, height: 2.5, color: 'transparent', borderWidth: 0.5, borderColor: '#000000', isField: false },
                    
                    // SIN GPS y # MEDICAMENTOS (misma fila que tel√©fonos)
                    { id: 'label_sin_gps', type: 'text', x: 52, y: 34.5, width: 20, height: 3.5, content: 'SIN GPS', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'label_medicamentos', type: 'text', x: 52, y: 38.5, width: 30, height: 3.5, content: '# MEDICAMENTOS', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'field_medicamentos', type: 'text', x: 83, y: 38.5, width: 19, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'cantMedicamentos' },
                    
                    // CONTACTANOS
                    { id: 'label_contactanos', type: 'text', x: 2, y: 43, width: 100, height: 3.5, content: 'CONTACTANOS:', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'field_contactanos', type: 'text', x: 2, y: 46.5, width: 100, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'contactCenter' },
                    
                    // COLUMNA DERECHA - L√≠nea vertical divisoria
                    { id: 'line_vertical', type: 'line', x: 105, y: 6, width: 0.3, height: 65, color: '#000000', isField: false },
                    
                    // √Årea grande en blanco (para mapa/notas) - con borde
                    { id: 'area_blanco', type: 'rectangle', x: 107, y: 7.5, width: 100, height: 50, color: 'transparent', borderWidth: 0.5, borderColor: '#cccccc', isField: false },
                    
                    // Logos en la parte inferior derecha
                    { id: 'logo1_text', type: 'text', x: 107, y: 58, width: 48, height: 5, content: '[LOGO: El IHSS llega a su casa]', fontSize: 4, color: '#999999', fontFamily: 'Arial', isField: false },
                    { id: 'logo2_text', type: 'text', x: 157, y: 58, width: 50, height: 5, content: '[LOGO: IHSS]', fontSize: 4, color: '#999999', fontFamily: 'Arial', isField: false },
                    
                    // FECHA DE ENTREGA (fila inferior derecha)
                    { id: 'label_fecha', type: 'text', x: 107, y: 63.5, width: 48, height: 3.5, content: 'FECHA DE ENTREGA', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'field_fecha', type: 'text', x: 107, y: 67, width: 48, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                    
                    // REFRIGERADO (fila inferior derecha)
                    { id: 'label_refrigerado', type: 'text', x: 157, y: 63.5, width: 50, height: 3.5, content: 'REFRIGERADO', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                    { id: 'field_refrigerado', type: 'text', x: 157, y: 67, width: 50, height: 3.5, content: '', fontSize: 4.5, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'cantRefrigerados' },
                    
                    // YEIMI (digitador) - parte inferior izquierda
                    { id: 'label_digitador', type: 'text', x: 2, y: 63.5, width: 100, height: 3.5, content: '', fontSize: 4, color: '#666666', fontFamily: 'Arial', isField: true, fieldId: 'digitador' }
                ];
                
                // Agregar banner espec√≠fico seg√∫n el tipo
                if (type === 'ruta') {
                    baseElements.splice(1, 0, 
                        { id: 'banner_ruta_bg', type: 'rectangle', x: 0, y: 6, width: 210, height: 2.5, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_ruta', type: 'text', x: 0, y: 6, width: 210, height: 2.5, content: 'ENTREGA EN RUTA', fontSize: 5.5, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false }
                    );
                } else if (type === 'ventanilla') {
                    baseElements.splice(1, 0,
                        { id: 'banner_ventanilla_bg', type: 'rectangle', x: 0, y: 6, width: 210, height: 2.5, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_ventanilla', type: 'text', x: 0, y: 6, width: 210, height: 2.5, content: 'ENTREGA VENTANILLA', fontSize: 5.5, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false }
                    );
                }
                
                // Convertir coordenadas de mm a px para el renderizado
                return baseElements.map(el => ({
                    ...el,
                    x: el.x * mmToPx,
                    y: el.y * mmToPx,
                    width: el.width * mmToPx,
                    height: el.height * mmToPx,
                    fontSize: el.fontSize * mmToPx,
                    borderWidth: el.borderWidth ? el.borderWidth * mmToPx : el.borderWidth
                }));
            };

            // Cargar plantillas guardadas (sin plantillas por defecto)
            useEffect(() => {
                const initializeTemplates = async () => {
                    try {
                        if (!firebaseInitialized || !db) {
                            console.warn('Firebase no disponible para cargar plantillas');
                            setSavedTemplates([]);
                            return;
                        }
                        
                        // Cargar plantillas existentes
                        const snapshot = await db.collection('prod_templates')
                            .orderBy('createdAt', 'desc')
                            .get();
                        const templates = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        setSavedTemplates(templates);
                    } catch (error) {
                        console.error('Error inicializando plantillas:', error);
                        setSavedTemplates([]);
                    }
                };
                
                initializeTemplates();
                loadUploadedImages();
            }, []);

            // Configurar scroll con rueda del mouse (se actualiza cuando cambia fullscreen)
            useEffect(() => {
                const container = scrollContainerRef.current;
                if (!container) return;

                const handleWheel = (e) => {
                    // Si hay scroll horizontal (deltaX), usarlo directamente
                    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                        e.preventDefault();
                        container.scrollLeft += e.deltaX;
                        return;
                    }

                    // Scroll horizontal con Shift + rueda vertical
                    if (e.shiftKey) {
                        e.preventDefault();
                        container.scrollLeft += e.deltaY;
                        return;
                    }

                    // Scroll horizontal con Alt + rueda vertical (alternativa com√∫n)
                    if (e.altKey) {
                        e.preventDefault();
                        container.scrollLeft += e.deltaY;
                        return;
                    }

                    // Scroll vertical normal (permitir comportamiento natural)
                    // No prevenir el comportamiento por defecto para scroll vertical
                };

                container.addEventListener('wheel', handleWheel, { passive: false });
                
                return () => {
                    container.removeEventListener('wheel', handleWheel);
                };
            }, [isFullscreen]); // Se actualiza cuando cambia el modo fullscreen

            // Actualizar elementos que son campos cuando cambian los datos del kit
            useEffect(() => {
                if (kitData || patientData) {
                    setElements(prevElements => prevElements.map(el => {
                        if (el.isField && el.fieldId) {
                            const field = getKitFields().find(f => f.id === el.fieldId);
                            if (field) {
                                return { ...el, content: field.value };
                            }
                        }
                        return el;
                    }));
                }
            }, [kitData, patientData]);

            const loadTemplates = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar plantillas');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_templates')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const templates = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setSavedTemplates(templates);
                } catch (error) {
                    console.error('Error cargando plantillas:', error);
                }
            };

            const loadUploadedImages = async () => {
                // Storage deshabilitado temporalmente
                return;
                
                /* C√≥digo comentado - Storage no disponible por ahora
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar im√°genes');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_images')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const images = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setUploadedImages(images);
                } catch (error) {
                    console.error('Error cargando im√°genes:', error);
                }
                */
            };

            const handleDragStart = (e, type) => {
                e.dataTransfer.setData('elementType', type);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('elementType');
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left - 50;
                const y = e.clientY - rect.top - 25;
                
                const elementType = elementTypes.find(el => el.id === type);
                if (elementType) {
                    const newElement = {
                        id: Date.now().toString(),
                        type,
                        x,
                        y,
                        ...elementType.default
                    };
                    const updatedElements = [...elements, newElement];
                    setElements(updatedElements);
                    setSelectedElement(newElement);
                    setPanelPropiedades(true); // Expandir panel de propiedades al agregar elemento
                    saveToHistory(updatedElements);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleElementMouseDown = (e, element) => {
                e.stopPropagation();
                setSelectedElement(element);
                setPanelPropiedades(true); // Expandir panel de propiedades al seleccionar
                setDragging(true);
                const rect = e.currentTarget.getBoundingClientRect();
                setDragOffset({
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                });
            };

            const handleMouseMove = (e) => {
                if (resizing) {
                    handleResizeMove(e);
                    return;
                }
                
                if (!dragging || !selectedElement) return;
                
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                // L√≠mites del canvas
                const canvasRect = e.currentTarget.getBoundingClientRect();
                const maxX = canvasRect.width - (selectedElement.width || 50);
                const maxY = canvasRect.height - (selectedElement.height || 50);
                
                const boundedX = Math.max(0, Math.min(x, maxX));
                const boundedY = Math.max(0, Math.min(y, maxY));
                
                setElements(elements.map(el => 
                    el.id === selectedElement.id 
                        ? { ...el, x: boundedX, y: boundedY }
                        : el
                ));
                setSelectedElement({ ...selectedElement, x: boundedX, y: boundedY });
            };

            const handleMouseUp = () => {
                if (dragging && selectedElement) {
                    // Guardar en historial cuando termina el drag
                    saveToHistory(elements);
                }
                if (resizing && selectedElement) {
                    // Guardar en historial cuando termina el resize
                    saveToHistory(elements);
                }
                setDragging(false);
                setResizing(false);
            };
            
            // Funciones de resize
            const handleResizeStart = (e, element, handle) => {
                e.stopPropagation();
                setResizing(true);
                setResizeHandle(handle);
                setSelectedElement(element);
                const rect = e.currentTarget.closest('.template-element').getBoundingClientRect();
                const designRect = designAreaRef.current?.getBoundingClientRect();
                setResizeStart({
                    x: e.clientX,
                    y: e.clientY,
                    width: element.width || 100,
                    height: element.height || 50,
                    startX: element.x,
                    startY: element.y
                });
            };
            
            const handleResizeMove = (e) => {
                if (!resizing || !selectedElement || !resizeHandle) return;
                
                const designArea = designAreaRef.current;
                if (!designArea) return;
                
                const designRect = designArea.getBoundingClientRect();
                const zoom = zoomLevel / 100;
                const deltaX = (e.clientX - resizeStart.x) / zoom;
                const deltaY = (e.clientY - resizeStart.y) / zoom;
                
                let newWidth = resizeStart.width;
                let newHeight = resizeStart.height;
                let newX = resizeStart.startX;
                let newY = resizeStart.startY;
                
                // Aplicar cambios seg√∫n el handle
                if (resizeHandle.includes('e')) {
                    newWidth = Math.max(20, resizeStart.width + deltaX);
                }
                if (resizeHandle.includes('w')) {
                    newWidth = Math.max(20, resizeStart.width - deltaX);
                    newX = resizeStart.startX + deltaX;
                }
                if (resizeHandle.includes('s')) {
                    newHeight = Math.max(20, resizeStart.height + deltaY);
                }
                if (resizeHandle.includes('n')) {
                    newHeight = Math.max(20, resizeStart.height - deltaY);
                    newY = resizeStart.startY + deltaY;
                }
                
                // L√≠mites del canvas
                const maxX = (designRect.width / zoom) - newWidth;
                const maxY = (designRect.height / zoom) - newHeight;
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                const updatedElements = elements.map(el => 
                    el.id === selectedElement.id 
                        ? { ...el, x: newX, y: newY, width: newWidth, height: newHeight }
                        : el
                );
                setElements(updatedElements);
                setSelectedElement({ ...selectedElement, x: newX, y: newY, width: newWidth, height: newHeight });
            };

            const updateElement = (updates) => {
                if (!selectedElement) return;
                const updatedElements = elements.map(el => 
                    el.id === selectedElement.id 
                        ? { ...el, ...updates }
                        : el
                );
                setElements(updatedElements);
                setSelectedElement({ ...selectedElement, ...updates });
                saveToHistory(updatedElements);
            };

            const deleteElement = () => {
                if (!selectedElement) return;
                const updatedElements = elements.filter(el => el.id !== selectedElement.id);
                setElements(updatedElements);
                setSelectedElement(null);
                saveToHistory(updatedElements);
            };

            // Listener para teclas Delete, Undo, Redo
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Delete/Backspace para eliminar
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedElement && !e.target.matches('input, textarea, select')) {
                        e.preventDefault();
                        deleteElement();
                    }
                    // Ctrl+Z para deshacer
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey && !e.target.matches('input, textarea')) {
                        e.preventDefault();
                        undo();
                    }
                    // Ctrl+Shift+Z o Ctrl+Y para rehacer
                    if (((e.ctrlKey || e.metaKey) && e.key === 'y') || ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z')) {
                        if (!e.target.matches('input, textarea')) {
                            e.preventDefault();
                            redo();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedElement, elements, historyIndex, history]);

            // Actualizar posici√≥n del toolbar flotante cuando cambia el elemento seleccionado
            useEffect(() => {
                if (!selectedElement || !designAreaRef.current || !scrollContainerRef.current) return;
                
                const updateToolbarPosition = () => {
                    const designArea = designAreaRef.current;
                    const scrollContainer = scrollContainerRef.current;
                    if (!designArea || !scrollContainer) return;
                    
                    const designRect = designArea.getBoundingClientRect();
                    const scrollRect = scrollContainer.getBoundingClientRect();
                    const zoom = zoomLevel / 100;
                    
                    const elementX = (selectedElement.x || 0) * zoom;
                    const elementY = (selectedElement.y || 0) * zoom;
                    const elementWidth = (selectedElement.width || 100) * zoom;
                    const elementHeight = (selectedElement.height || 50) * zoom;
                    
                    // Calcular posici√≥n relativa al viewport del scroll
                    const scrollLeft = scrollContainer.scrollLeft;
                    const scrollTop = scrollContainer.scrollTop;
                    
                    // Posici√≥n absoluta del elemento en el contenedor de scroll
                    const absElementX = designRect.left - scrollRect.left + elementX - scrollLeft;
                    const absElementY = designRect.top - scrollRect.top + elementY - scrollTop;
                    
                    const toolbarWidth = 300;
                    const toolbarHeight = 60;
                    const padding = 10;
                    
                    // Determinar mejor posici√≥n (arriba, abajo, o centrado)
                    const spaceAbove = absElementY;
                    const spaceBelow = scrollRect.height - (absElementY + elementHeight);
                    const spaceRight = scrollRect.width - (absElementX + elementWidth);
                    const spaceLeft = absElementX;
                    
                    let toolbarX, toolbarY;
                    
                    // Prioridad: arriba > abajo > derecha > izquierda
                    if (spaceAbove > toolbarHeight + padding) {
                        // Arriba del elemento
                        toolbarY = absElementY - toolbarHeight - padding;
                        toolbarX = absElementX + (elementWidth / 2) - (toolbarWidth / 2);
                    } else if (spaceBelow > toolbarHeight + padding) {
                        // Abajo del elemento
                        toolbarY = absElementY + elementHeight + padding;
                        toolbarX = absElementX + (elementWidth / 2) - (toolbarWidth / 2);
                    } else if (spaceRight > toolbarWidth + padding) {
                        // A la derecha
                        toolbarX = absElementX + elementWidth + padding;
                        toolbarY = absElementY + (elementHeight / 2) - (toolbarHeight / 2);
                    } else if (spaceLeft > toolbarWidth + padding) {
                        // A la izquierda
                        toolbarX = absElementX - toolbarWidth - padding;
                        toolbarY = absElementY + (elementHeight / 2) - (toolbarHeight / 2);
                    } else {
                        // Centrado sobre el elemento
                        toolbarX = absElementX + (elementWidth / 2) - (toolbarWidth / 2);
                        toolbarY = absElementY + (elementHeight / 2) - (toolbarHeight / 2);
                    }
                    
                    // Asegurar que el toolbar no se salga del viewport
                    toolbarX = Math.max(padding, Math.min(toolbarX, scrollRect.width - toolbarWidth - padding));
                    toolbarY = Math.max(padding, Math.min(toolbarY, scrollRect.height - toolbarHeight - padding));
                    
                    setFloatingToolbarPosition({
                        x: toolbarX,
                        y: toolbarY
                    });
                };
                
                // Actualizar inmediatamente y en cada scroll/zoom
                updateToolbarPosition();
                
                const handleScroll = () => updateToolbarPosition();
                scrollContainerRef.current?.addEventListener('scroll', handleScroll);
                window.addEventListener('resize', updateToolbarPosition);
                
                return () => {
                    scrollContainerRef.current?.removeEventListener('scroll', handleScroll);
                    window.removeEventListener('resize', updateToolbarPosition);
                };
            }, [selectedElement, zoomLevel]);

            const handleImageUpload = async (e) => {
                // Storage deshabilitado temporalmente
                alert('La carga de im√°genes est√° deshabilitada temporalmente. Storage no est√° configurado.');
                return;
                
                /* C√≥digo comentado - Storage no disponible por ahora
                const file = e.target.files[0];
                if (!file) return;
                
                setImageUploading(true);
                try {
                    if (!firebaseInitialized) {
                        throw new Error("Firebase no disponible");
                    }
                    
                    // TODO: Implementar cuando Storage est√© disponible
                    alert('Storage no est√° configurado a√∫n');
                    
                } catch (error) {
                    console.error('Error subiendo imagen:', error);
                    alert('Error al subir la imagen: ' + error.message);
                } finally {
                    setImageUploading(false);
                }
                */
            };

            const saveTemplate = async (saveAsVersion = false) => {
                if (!templateName.trim()) {
                    alert('Por favor ingresa un nombre para la plantilla');
                    return;
                }

                try {
                    if (!firebaseInitialized || !db || !storage) {
                        throw new Error("Firebase no disponible");
                    }
                    
                    let templateId = currentTemplateId;
                    
                    // Guardar en Firestore
                    if (!templateId) {
                        // Nueva plantilla
                        const docRef = await db.collection('prod_templates').add({
                        name: templateName,
                        type: templateType,
                        orientation: templateOrientation,
                        elements,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                        templateId = docRef.id;
                        setCurrentTemplateId(templateId);
                    } else {
                        // Actualizar existente
                        await db.collection('prod_templates').doc(templateId).update({
                            name: templateName,
                            type: templateType,
                            orientation: templateOrientation,
                            elements,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    // Guardar versi√≥n en Storage si se solicita o si es nueva plantilla
                    if (saveAsVersion || !currentTemplateId) {
                        await saveTemplateVersion(templateId);
                    }
                    
                    setShowSaveModal(false);
                    alert('Plantilla guardada correctamente');
                    loadTemplates();
                } catch (error) {
                    console.error('Error guardando plantilla:', error);
                    alert('Error al guardar la plantilla: ' + error.message);
                }
            };

            const saveTemplateVersion = async (templateId) => {
                try {
                    if (!firebaseInitialized || !storage) {
                        throw new Error("Storage no disponible");
                    }
                    
                    const now = new Date();
                    const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
                    
                    const versionData = {
                        templateId,
                        savedAt: now.toISOString(),
                        savedBy: auth?.currentUser?.email || 'anonymous',
                        canvas: {
                            width: templateOrientation === 'horizontal' ? 210 : 71,
                            height: templateOrientation === 'horizontal' ? 71 : 210,
                            orientation: templateOrientation,
                            type: templateType
                        },
                        items: elements
                    };
                    
                    const versionPath = `templates/${templateId}/versions/${timestamp}.json`;
                    const storageRef = storage.ref(versionPath);
                    const jsonBlob = new Blob([JSON.stringify(versionData, null, 2)], { type: 'application/json' });
                    
                    await storageRef.put(jsonBlob);
                    console.log('‚úÖ Versi√≥n guardada en Storage:', versionPath);
                    
                    // Guardar metadata en Firestore para listar r√°pido
                    await db.collection('prod_templates').doc(templateId).collection('history').add({
                        path: versionPath,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        savedBy: auth?.currentUser?.email || 'anonymous',
                        timestamp
                    });
                    
                } catch (error) {
                    console.error('Error guardando versi√≥n:', error);
                    throw error;
                }
            };

            const loadTemplateHistory = async (templateId) => {
                try {
                    if (!firebaseInitialized || !storage || !db) {
                        throw new Error("Firebase no disponible");
                    }
                    
                    // Cargar desde Firestore (m√°s r√°pido)
                    const historySnapshot = await db.collection('prod_templates').doc(templateId).collection('history')
                        .orderBy('savedAt', 'desc')
                        .get();
                    
                    const history = await Promise.all(historySnapshot.docs.map(async (doc) => {
                        const data = doc.data();
                        try {
                            const storageRef = storage.ref(data.path);
                            const metadata = await storageRef.getMetadata();
                            return {
                                id: doc.id,
                                timestamp: data.timestamp,
                                savedAt: data.savedAt?.toDate?.() || new Date(),
                                savedBy: data.savedBy,
                                path: data.path,
                                size: metadata.size || 0
                            };
                        } catch (e) {
                            return {
                                id: doc.id,
                                timestamp: data.timestamp,
                                savedAt: data.savedAt?.toDate?.() || new Date(),
                                savedBy: data.savedBy,
                                path: data.path,
                                size: 0,
                                error: 'No se pudo cargar metadata'
                            };
                        }
                    }));
                    
                    setTemplateHistory(history);
                    setShowHistoryModal(true);
                } catch (error) {
                    console.error('Error cargando historial:', error);
                    alert('Error al cargar el historial: ' + error.message);
                }
            };

            const restoreTemplateVersion = async (versionPath) => {
                try {
                    if (!firebaseInitialized || !storage) {
                        throw new Error("Storage no disponible");
                    }
                    
                    const storageRef = storage.ref(versionPath);
                    const url = await storageRef.getDownloadURL();
                    const response = await fetch(url);
                    const versionData = await response.json();
                    
                    // Restaurar datos
                    setElements(versionData.items || []);
                    setTemplateOrientation(versionData.canvas?.orientation || 'vertical');
                    setTemplateType(versionData.canvas?.type || 'ruta');
                    setSelectedElement(null);
                    
                    setShowHistoryModal(false);
                    alert('Versi√≥n restaurada correctamente');
                } catch (error) {
                    console.error('Error restaurando versi√≥n:', error);
                    alert('Error al restaurar la versi√≥n: ' + error.message);
                }
            };

            const previewTemplateVersion = async (versionPath) => {
                try {
                    if (!firebaseInitialized || !storage) {
                        throw new Error("Storage no disponible");
                    }
                    
                    const storageRef = storage.ref(versionPath);
                    const url = await storageRef.getDownloadURL();
                    const response = await fetch(url);
                    const versionData = await response.json();
                    
                    // Solo previsualizar (no restaurar)
                    const previewWindow = window.open('', '_blank');
                    const orientationStyle = versionData.canvas?.orientation === 'horizontal' 
                        ? `width: 210mm; height: 71mm;` 
                        : `width: 71mm; height: 210mm;`;
                    
                    // Obtener el HTML de forma segura
                    const previewHTML = renderElementsForPreview(versionData.items || []);
                    const templateTypeName = versionData.canvas?.type || 'Plantilla';
                    
                    // Escribir el documento en partes para evitar problemas con template literals
                    previewWindow.document.open();
                    previewWindow.document.write('<!DOCTYPE html><html><head>');
                    previewWindow.document.write('<title>Previsualizaci√≥n - ' + templateTypeName + '</title>');
                    previewWindow.document.write('<style>');
                    previewWindow.document.write('body { margin: 0; padding: 20px; }');
                    previewWindow.document.write('.print-area { ' + orientationStyle + ' border: 1px solid #ccc; position: relative; overflow: hidden; font-family: Arial, sans-serif; }');
                    previewWindow.document.write('.template-element { position: absolute; box-sizing: border-box; }');
                    previewWindow.document.write('</style></head><body>');
                    previewWindow.document.write('<div class="print-area">');
                    previewWindow.document.write(previewHTML);
                    previewWindow.document.write('</div></body></html>');
                    previewWindow.document.close();
                } catch (error) {
                    console.error('Error previsualizando versi√≥n:', error);
                    alert('Error al previsualizar la versi√≥n: ' + error.message);
                }
            };

            const renderElementsForPreview = (items) => {
                return items.map(element => {
                    const textDecoration = element.underline ? 'underline' : element.strikethrough ? 'line-through' : 'none';
                    const textShadow = element.textShadow ? '2px 2px 4px rgba(0,0,0,0.3)' : 'none';
                    const webkitTextStroke = element.textOutline ? '1px #000000' : 'none';
                    const webkitTextFillColor = element.textOutline ? 'transparent' : (element.color || '#000000');
                    
                    const style = `
                        left: ${element.x}px;
                        top: ${element.y}px;
                        width: ${element.width || 'auto'}px;
                        height: ${element.height || 'auto'}px;
                        font-size: ${element.fontSize || 12}px;
                        color: ${element.color || '#000000'};
                        font-family: ${element.fontFamily || 'Arial'};
                        font-weight: ${element.bold ? 'bold' : 'normal'};
                        font-style: ${element.italic ? 'italic' : 'normal'};
                        text-decoration: ${textDecoration};
                        text-shadow: ${textShadow};
                        -webkit-text-stroke: ${webkitTextStroke};
                        -webkit-text-fill-color: ${webkitTextFillColor};
                    `;
                    
                    if (element.type === 'text') {
                        return `<div class="template-element" style="${style}">${element.content || ''}</div>`;
                    } else if (element.type === 'rectangle') {
                        return `<div class="template-element" style="${style}; background: ${element.color || '#e5e7eb'}; border: ${element.borderWidth || 1}px solid ${element.borderColor || '#000000'};"></div>`;
                    } else if (element.type === 'line') {
                        return `<div class="template-element" style="${style}; background: ${element.color || '#000000'};"></div>`;
                    } else if (element.type === 'image' && element.url) {
                        return `<img class="template-element" src="${element.url}" alt="${element.alt || ''}" style="${style}; object-fit: contain;" />`;
                    }
                    return '';
                }).join('');
            };

            const loadTemplate = (template) => {
                const templateElements = template.elements || [];
                setElements(templateElements);
                setTemplateName(template.name);
                setTemplateType(template.type || 'ruta');
                setTemplateOrientation(template.orientation || 'vertical');
                setCurrentTemplateId(template.id);
                setSelectedElement(null);
                // Inicializar historial con el estado inicial
                setHistory([JSON.parse(JSON.stringify(templateElements))]);
                setHistoryIndex(0);
            };

            // Funci√≥n para eliminar todas las plantillas
            const deleteAllTemplates = async () => {
                if (!confirm('¬øEst√° seguro de que desea eliminar TODAS las plantillas? Esta acci√≥n no se puede deshacer.')) {
                    return;
                }

                try {
                    if (!firebaseInitialized || !db) {
                        alert('Firebase no disponible');
                        return;
                    }

                    // Obtener todas las plantillas
                    const snapshot = await db.collection('prod_templates').get();
                    
                    // Eliminar cada plantilla
                    const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
                    await Promise.all(deletePromises);

                    // Limpiar el estado local
                    setSavedTemplates([]);
                    setElements([]);
                    setTemplateName('Nueva Plantilla');
                    setCurrentTemplateId(null);
                    
                    alert('Todas las plantillas han sido eliminadas');
                } catch (error) {
                    console.error('Error eliminando plantillas:', error);
                    alert('Error al eliminar plantillas: ' + error.message);
                }
            };

            // Funci√≥n para subir una imagen como plantilla base
            const handleUploadTemplateImage = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validar que sea una imagen
                if (!file.type.startsWith('image/')) {
                    alert('Por favor seleccione un archivo de imagen');
                    return;
                }

                try {
                    // Leer la imagen como Data URL
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageUrl = event.target.result;
                        
                        // Obtener dimensiones de la imagen
                        const img = new Image();
                        img.onload = async () => {
                            // Calcular dimensiones para el canvas (210x71mm horizontal por defecto)
                            const canvasWidth = 210; // mm
                            const canvasHeight = 71; // mm
                            
                            // Crear un elemento de imagen que cubra todo el canvas
                            const backgroundImage = {
                                id: 'template_background_' + Date.now(),
                                type: 'image',
                                x: 0,
                                y: 0,
                                width: canvasWidth,
                                height: canvasHeight,
                                url: imageUrl,
                                alt: file.name,
                                isField: false
                            };

                            // Establecer la imagen como √∫nico elemento inicial
                            setElements([backgroundImage]);
                            setTemplateName(file.name.replace(/\.[^/.]+$/, '') || 'Nueva Plantilla');
                            setTemplateType('ruta');
                            setTemplateOrientation('horizontal');
                            setCurrentTemplateId(null);
                            setSelectedElement(backgroundImage);
                            
                            // Inicializar historial
                            setHistory([JSON.parse(JSON.stringify([backgroundImage]))]);
                            setHistoryIndex(0);

                            // Cerrar el men√∫ flotante
                            closeFloatingMenu();

                            alert('Imagen cargada como plantilla. Puede editarla y guardarla.');
                        };
                        img.src = imageUrl;
                    };
                    reader.readAsDataURL(file);

                    // Limpiar el input
                    e.target.value = '';
                } catch (error) {
                    console.error('Error cargando imagen como plantilla:', error);
                    alert('Error al cargar la imagen: ' + error.message);
                }
            };

            // Funci√≥n para cargar plantillas predeterminadas en Firebase
            const loadPredeterminedTemplates = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        alert('Firebase no disponible');
                        return;
                    }
                    
                    const templates = createPredeterminedTemplates();
                    
                    // Guardar o reemplazar las 3 plantillas con IDs fijos
                    for (const template of templates) {
                        const templateRef = db.collection('prod_templates').doc(template.id);
                        await templateRef.set({
                            ...template,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                    
                    // Recargar plantillas guardadas
                    await loadTemplates();
                    
                    alert('Plantillas predeterminadas cargadas correctamente');
                } catch (error) {
                    console.error('Error cargando plantillas predeterminadas:', error);
                    alert('Error al cargar plantillas: ' + error.message);
                }
            };

            // Cargar plantilla cuando cambia el tipo y no hay elementos (solo una vez al inicio)
            const [hasInitialized, setHasInitialized] = useState(false);
            useEffect(() => {
                if (!hasInitialized && elements.length === 0 && (templateType === 'ruta' || templateType === 'ventanilla')) {
                    loadNewTemplate(templateType);
                    setHasInitialized(true);
                }
            }, [templateType]);

            // Funciones de fullscreen
            const enterFullscreen = () => {
                setIsFullscreen(true);
            };

            const exitFullscreen = () => {
                setIsFullscreen(false);
            };

            // Manejar ESC para salir de fullscreen
            useEffect(() => {
                if (!isFullscreen) return;
                
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        exitFullscreen();
                    }
                };
                
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [isFullscreen]);

            const insertKitField = (field) => {
                const newElement = {
                    id: Date.now().toString(),
                    type: 'text',
                    x: 50,
                    y: 50,
                    content: field.value,
                    fontSize: 12,
                    color: '#000000',
                    fontFamily: 'Arial',
                    bold: false,
                    italic: false,
                    underline: false,
                    strikethrough: false,
                    textShadow: false,
                    textOutline: false,
                    isField: true,
                    fieldId: field.id
                };
                setElements([...elements, newElement]);
                setSelectedElement(newElement);
                setPanelPropiedades(true); // Expandir panel de propiedades al insertar campo
            };

            // Actualizar elementos que son campos cuando cambian los datos del kit
            useEffect(() => {
                if (kitData || patientData) {
                    setElements(prevElements => prevElements.map(el => {
                        if (el.isField && el.fieldId) {
                            const field = getKitFields().find(f => f.id === el.fieldId);
                            if (field) {
                                return { ...el, content: field.value };
                            }
                        }
                        return el;
                    }));
                }
            }, [kitData, patientData]);

            const handlePrintPreview = () => {
                const printContent = document.getElementById('template-preview');
                if (!printContent) {
                    alert('No hay contenido para imprimir');
                    return;
                }
                
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('No se pudo abrir la ventana de impresi√≥n. Por favor, permite ventanas emergentes.');
                    return;
                }
                
                // Obtener el HTML del contenido de forma segura
                const contentHTML = printContent.innerHTML;
                
                // Escribir el documento en partes para evitar problemas con template literals
                printWindow.document.open();
                printWindow.document.write('<!DOCTYPE html><html><head>');
                printWindow.document.write('<title>Vista Previa - ' + (templateName || 'Plantilla') + '</title>');
                printWindow.document.write('<meta charset="UTF-8">');
                printWindow.document.write('<style>');
                printWindow.document.write('@page { size: 210mm 71mm landscape; margin: 0; padding: 0; }');
                printWindow.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
                printWindow.document.write('body { margin: 0; padding: 0; width: 210mm; height: 71mm; overflow: hidden; }');
                printWindow.document.write('.print-area { width: 210mm; height: 71mm; position: relative; overflow: hidden; font-family: Arial, sans-serif; text-transform: uppercase; background: white; }');
                printWindow.document.write('.template-element { position: absolute; box-sizing: border-box; text-transform: uppercase; margin: 0; padding: 0; }');
                printWindow.document.write('@media print { @page { size: 210mm 71mm landscape; margin: 0; } body { width: 210mm; height: 71mm; margin: 0; padding: 0; } .print-area { width: 210mm; height: 71mm; margin: 0; padding: 0; } }');
                printWindow.document.write('</style></head><body>');
                printWindow.document.write('<div class="print-area">');
                printWindow.document.write(contentHTML);
                printWindow.document.write('</div>');
                // NO ejecutar print autom√°ticamente - el usuario debe hacer clic en el bot√≥n de imprimir del navegador
                // Esto evita que se abra el cuadro de impresi√≥n al recargar la p√°gina principal
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                // Solo enfocar si la ventana se abri√≥ correctamente
                if (printWindow && !printWindow.closed) {
                    printWindow.focus();
                }
            };

            // Dimensiones: SOLO horizontal (71mm x 210mm)
            const getDesignAreaDimensions = () => {
                return { width: '210mm', height: '71mm' }; // Siempre horizontal
            };

            const dimensions = getDesignAreaDimensions();

            // Funci√≥n para auto-ajustar la plantilla al viewport (FIT TO SCREEN)
            const autoFitScale = () => {
                if (!scrollContainerRef.current || !designAreaRef.current) return;
                
                const container = scrollContainerRef.current;
                const designArea = designAreaRef.current;
                
                // Obtener dimensiones del contenedor disponible
                const containerRect = container.getBoundingClientRect();
                const availableWidth = containerRect.width - 32; // Padding
                const availableHeight = containerRect.height - 32; // Padding
                
                // Dimensiones reales del papel en px (210mm x 71mm)
                // 1mm = 3.779px a 96dpi
                const pageWidthPx = 210 * 3.779; // ~793px
                const pageHeightPx = 71 * 3.779; // ~268px
                
                // Calcular escala para que quepa sin deformar
                const scaleX = availableWidth / pageWidthPx;
                const scaleY = availableHeight / pageHeightPx;
                const scale = Math.min(scaleX, scaleY, 1) * 100; // No ampliar m√°s del 100%
                
                // Aplicar escala m√≠nima del 25% para que siempre sea visible
                const finalScale = Math.max(scale, 25);
                
                setZoomLevel(Math.round(finalScale));
            };

            // Funciones de zoom
            const handleZoomIn = () => {
                setZoomLevel(prev => Math.min(prev + 10, 300));
            };

            const handleZoomOut = () => {
                setZoomLevel(prev => Math.max(prev - 10, 25));
            };

            const handleZoomReset = () => {
                autoFitScale(); // Usar auto-fit en lugar de 100%
            };

            const handleZoomChange = (e) => {
                setZoomLevel(parseInt(e.target.value));
            };

            // Auto-ajustar cuando se carga una plantilla o cambia el tama√±o de ventana
            useEffect(() => {
                if (elements.length > 0) {
                    // Peque√±o delay para que el DOM se actualice
                    setTimeout(() => {
                        autoFitScale();
                    }, 100);
                }
            }, [elements.length]);

            // Auto-ajustar al redimensionar ventana
            useEffect(() => {
                const handleResize = () => {
                    if (elements.length > 0) {
                        autoFitScale();
                    }
                };
                
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, [elements.length]);

            // Funciones para men√∫s flotantes
            const toggleFloatingMenu = (type) => {
                if (floatingMenuType === type) {
                    setShowFloatingMenu(false);
                    setFloatingMenuType(null);
                } else {
                    setShowFloatingMenu(true);
                    setFloatingMenuType(type);
                }
            };

            const closeFloatingMenu = () => {
                setShowFloatingMenu(false);
                setFloatingMenuType(null);
            };

            // Render del editor (reutilizable para normal y fullscreen)
            const renderEditor = (isFullscreenMode = false) => (
                <div className={isFullscreenMode ? "fixed inset-0 z-50 bg-white flex flex-col overflow-hidden" : "space-y-6"}>
                    {isFullscreenMode && (
                        <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                            <h4 className="font-bold text-lg">Editor de Plantillas - Modo Pantalla Completa</h4>
                        <div className="flex gap-2">
                                {currentTemplateId && (
                                    <button 
                                        onClick={() => loadTemplateHistory(currentTemplateId)}
                                        className="flex items-center gap-2 bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                    >
                                        <Icons.Folder size={16}/> Historial
                                    </button>
                                )}
                            <button 
                                onClick={handlePrintPreview}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                            >
                                <Icons.Printer size={16}/> Vista Previa
                            </button>
                                <button 
                                    onClick={() => saveTemplate(true)}
                                    className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                >
                                    <Icons.Save size={16}/> Guardar Versi√≥n
                                </button>
                            <button 
                                onClick={() => setShowSaveModal(true)}
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                            >
                                    <Icons.Save size={16}/> Guardar
                            </button>
                                <button 
                                    onClick={exitFullscreen}
                                    className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                >
                                    <Icons.X size={16}/> Salir (ESC)
                                </button>
                                        </div>
                                </div>
                    )}
                    
                    {!isFullscreenMode && (
                    <div className="flex justify-between items-center">
                        <h4 className="font-bold text-lg text-slate-800">Editor de Plantillas</h4>
                        <div className="flex gap-2">
                                {currentTemplateId && (
                                    <button 
                                        onClick={() => loadTemplateHistory(currentTemplateId)}
                                        className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                    >
                                        <Icons.Folder size={16}/> Historial
                                    </button>
                                )}
                                <button 
                                    onClick={enterFullscreen}
                                    className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                                >
                                    <Icons.Layout size={16}/> Pantalla Completa
                                </button>
                            <button 
                                onClick={handlePrintPreview}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                            >
                                <Icons.Printer size={16}/> Vista Previa
                            </button>
                            <button 
                                onClick={() => setShowSaveModal(true)}
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                            >
                                <Icons.Save size={16}/> Guardar Plantilla
                            </button>
                                            </div>
                                    </div>
                    )}


                    <div className={isFullscreenMode ? "flex-1 flex flex-col overflow-hidden" : "grid grid-cols-1 lg:grid-cols-12 gap-6"}>
                        {/* √Årea de dise√±o estilo Canva - Ocupa m√°s espacio */}
                        <div className={isFullscreenMode ? "flex-1 flex flex-col overflow-hidden" : "lg:col-span-9"}>
                            <div className={isFullscreenMode ? "flex-1 flex flex-col overflow-hidden" : "p-4 h-full flex flex-col"}>
                                {/* Barra de herramientas superior estilo Canva */}
                                <div className={`flex justify-between items-center ${isFullscreenMode ? 'mb-2 p-2 bg-slate-50 border-b border-slate-200' : 'mb-4 bg-white p-3 rounded-lg border border-slate-200'}`}>
                                    <div className="flex items-center gap-3">
                                        <h5 className="font-bold text-slate-700 text-sm">√Årea de Dise√±o</h5>
                                        <div className="h-4 w-px bg-slate-300"></div>
                                        {/* Botones Undo/Redo */}
                                        <button
                                            onClick={undo}
                                            disabled={historyIndex <= 0}
                                            className={`p-1 rounded ${historyIndex <= 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-200'}`}
                                            title="Deshacer (Ctrl+Z)"
                                        >
                                            <Icons.Undo size={16} className="text-slate-600"/>
                                        </button>
                                        <button
                                            onClick={redo}
                                            disabled={historyIndex >= history.length - 1}
                                            className={`p-1 rounded ${historyIndex >= history.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-200'}`}
                                            title="Rehacer (Ctrl+Y)"
                                        >
                                            <Icons.Redo size={16} className="text-slate-600"/>
                                        </button>
                                        <div className="h-4 w-px bg-slate-300"></div>
                                        <select 
                                            value={templateType}
                                            onChange={(e) => {
                                                setTemplateType(e.target.value);
                                            }}
                                            className="text-xs border rounded px-2 py-1 bg-white"
                                        >
                                            <option value="ventanilla">Ventanilla</option>
                                            <option value="ruta">Ruta</option>
                                            <option value="refrigerado">Refrigerado</option>
                                        </select>
                                        <div className="h-4 w-px bg-slate-300"></div>
                                        {/* Bot√≥n para cargar plantillas predeterminadas */}
                                        <button
                                            onClick={async () => {
                                                await loadPredeterminedTemplates();
                                            }}
                                            className="px-3 py-1 text-xs bg-purple-600 hover:bg-purple-700 text-white rounded border border-purple-700 font-bold"
                                            title="Cargar las 3 plantillas predeterminadas (RUTA, VENTANILLA, REFRIGERADOS)"
                                        >
                                            üìã Cargar Plantillas
                                        </button>
                                    </div>
                                    
                                    {/* Controles de Zoom estilo Canva */}
                                    <div className="flex items-center gap-2 bg-slate-100 rounded-lg px-2 py-1">
                                        <button
                                            onClick={handleZoomOut}
                                            className="p-1 hover:bg-slate-200 rounded transition-colors"
                                            title="Alejar"
                                        >
                                            <Icons.Minus size={16} className="text-slate-600"/>
                                        </button>
                                        <input
                                            type="range"
                                            min="25"
                                            max="300"
                                            value={zoomLevel}
                                            onChange={handleZoomChange}
                                            className="w-24"
                                        />
                                        <span className="text-xs font-medium text-slate-700 min-w-[3rem] text-center">{zoomLevel}%</span>
                                        <button
                                            onClick={handleZoomIn}
                                            className="p-1 hover:bg-slate-200 rounded transition-colors"
                                            title="Acercar"
                                        >
                                            <Icons.Plus size={16} className="text-slate-600"/>
                                        </button>
                                        <button
                                            onClick={handleZoomReset}
                                            className="px-2 py-1 text-xs font-medium text-slate-700 hover:bg-slate-200 rounded transition-colors"
                                            title="Resetear zoom"
                                        >
                                            Ajustar
                                        </button>
                                </div>
                                </div>
                                
                                {/* Contenedor con scroll y zoom - Sin fondo blanco */}
                                <div 
                                    ref={scrollContainerRef}
                                    className={`flex-1 overflow-auto ${isFullscreenMode ? 'p-4' : 'rounded-lg p-8'}`}
                                    style={{ 
                                        backgroundImage: 'radial-gradient(circle, #e2e8f0 1px, transparent 1px)',
                                        backgroundSize: '20px 20px',
                                        backgroundColor: 'transparent',
                                        display: 'flex',
                                        justifyContent: 'center',
                                        alignItems: 'flex-start'
                                    }}
                                >
                                    <div 
                                        ref={designAreaRef}
                                        className="design-area relative rounded-lg border-2 border-slate-400 shadow-lg bg-white"
                                    onDrop={handleDrop}
                                    onDragOver={handleDragOver}
                                    onMouseMove={handleMouseMove}
                                    onMouseUp={handleMouseUp}
                                    onMouseLeave={handleMouseUp}
                                        style={{
                                            width: '210mm',
                                            height: '71mm',
                                            transform: `scale(${zoomLevel / 100})`,
                                            transformOrigin: 'top center',
                                            transition: 'transform 0.2s ease',
                                            textTransform: 'uppercase',
                                            position: 'relative',
                                            flexShrink: 0
                                        }}
                                >
                                    <div id="template-preview" style={{ width: '100%', height: '100%', position: 'relative' }}>
                                        {elements.map(element => (
                                            <div
                                                key={element.id}
                                                className={`template-element ${selectedElement?.id === element.id ? 'selected' : ''}`}
                                                style={{
                                                    left: `${element.x}px`,
                                                    top: `${element.y}px`,
                                                    width: element.width ? `${element.width}px` : (element.type === 'text' ? '100px' : 'auto'),
                                                    height: element.height ? `${element.height}px` : (element.type === 'text' ? '30px' : 'auto'),
                                                    backgroundColor: element.type === 'rectangle' ? element.color : 'transparent',
                                                    border: element.type === 'line' ? `2px solid ${element.color}` : 
                                                           element.type === 'rectangle' ? `${element.borderWidth || 1}px solid ${element.borderColor || '#000000'}` : 'none',
                                                    fontSize: `${element.fontSize || 12}px`,
                                                    color: element.color || '#000000',
                                                    fontFamily: element.fontFamily || 'Arial',
                                                    fontWeight: element.bold ? 'bold' : 'normal',
                                                    fontStyle: element.italic ? 'italic' : 'normal',
                                                    textDecoration: element.underline ? 'underline' : element.strikethrough ? 'line-through' : 'none',
                                                    textShadow: element.textShadow ? '2px 2px 4px rgba(0,0,0,0.3)' : 'none',
                                                    WebkitTextStroke: element.textOutline ? '1px #000000' : 'none',
                                                    WebkitTextFillColor: element.textOutline ? 'transparent' : (element.color || '#000000'),
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: element.align || 'left',
                                                    minWidth: '20px',
                                                    minHeight: '20px',
                                                    textTransform: 'uppercase'
                                                }}
                                                onMouseDown={(e) => {
                                                    // No iniciar drag si se hace clic en un handle
                                                    if (!e.target.classList.contains('resize-handle')) {
                                                        handleElementMouseDown(e, element);
                                                    }
                                                }}
                                            >
                                                {element.type === 'text' && (
                                                    <div 
                                                        style={{
                                                            width: '100%',
                                                            height: '100%',
                                                            wordWrap: 'break-word',
                                                            overflowWrap: 'break-word',
                                                            whiteSpace: 'pre-wrap',
                                                            overflow: 'hidden'
                                                        }}
                                                    >
                                                        {element.content}
                                                    </div>
                                                )}
                                                {element.type === 'barcode' && (
                                                    <div className="bg-white p-2 border border-slate-300 text-center w-full">
                                                        <div className="text-[10px] text-slate-500">[C√ìDIGO DE BARRAS]</div>
                                                        <div className="text-[8px] text-slate-400">{element.content}</div>
                                                    </div>
                                                )}
                                                {element.type === 'qrcode' && (
                                                    <div className="bg-white p-2 border border-slate-300 text-center w-full">
                                                        <div className="text-[10px] text-slate-500">[QR CODE]</div>
                                                        <div className="text-[8px] text-slate-400 truncate">{element.content}</div>
                                                    </div>
                                                )}
                                                {element.type === 'image' && element.url && (
                                                    <img 
                                                        src={element.url} 
                                                        alt={element.alt}
                                                        className="w-full h-full object-contain"
                                                        style={{ maxWidth: '100%', maxHeight: '100%' }}
                                                    />
                                                )}
                                                {element.type === 'image' && !element.url && (
                                                    <div className="border border-dashed border-slate-300 w-full h-full flex items-center justify-center text-xs text-slate-500">
                                                        [IMAGEN]
                                                    </div>
                                                )}
                                                
                                                {/* Resize handles - mostrar si est√° seleccionado (todos los elementos pueden redimensionarse) */}
                                                {selectedElement?.id === element.id && (
                                                    <>
                                                        <div className="resize-handle nw" onMouseDown={(e) => handleResizeStart(e, element, 'nw')}></div>
                                                        <div className="resize-handle ne" onMouseDown={(e) => handleResizeStart(e, element, 'ne')}></div>
                                                        <div className="resize-handle sw" onMouseDown={(e) => handleResizeStart(e, element, 'sw')}></div>
                                                        <div className="resize-handle se" onMouseDown={(e) => handleResizeStart(e, element, 'se')}></div>
                                                        <div className="resize-handle n" onMouseDown={(e) => handleResizeStart(e, element, 'n')}></div>
                                                        <div className="resize-handle s" onMouseDown={(e) => handleResizeStart(e, element, 's')}></div>
                                                        <div className="resize-handle e" onMouseDown={(e) => handleResizeStart(e, element, 'e')}></div>
                                                        <div className="resize-handle w" onMouseDown={(e) => handleResizeStart(e, element, 'w')}></div>
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Panel flotante tipo Canva - Aparece cuando hay elemento seleccionado */}
                                {selectedElement && scrollContainerRef.current && (
                                    <div 
                                        className="fixed z-[60] bg-white rounded-xl shadow-2xl border border-slate-200 p-2"
                                        style={{
                                            left: `${scrollContainerRef.current.getBoundingClientRect().left + floatingToolbarPosition.x}px`,
                                            top: `${scrollContainerRef.current.getBoundingClientRect().top + floatingToolbarPosition.y}px`,
                                            minWidth: '250px',
                                            maxWidth: '90vw'
                                        }}
                                    >
                                        {selectedElement.type === 'text' && (
                                            <div className="flex items-center gap-2 flex-wrap">
                                                {/* Fuente */}
                                                <select
                                                    value={selectedElement.fontFamily || 'Arial'}
                                                    onChange={(e) => updateElement({ fontFamily: e.target.value })}
                                                    className="text-xs border rounded px-2 py-1 bg-white"
                                                >
                                                    {fontFamilies.map(font => (
                                                        <option key={font.value} value={font.value}>{font.label}</option>
                                                    ))}
                                                </select>
                                                
                                                {/* Tama√±o de fuente */}
                                                <div className="flex items-center gap-1 bg-slate-100 rounded px-1">
                                                    <button
                                                        onClick={() => updateElement({ fontSize: Math.max(8, (selectedElement.fontSize || 12) - 1) })}
                                                        className="p-1 hover:bg-slate-200 rounded text-xs"
                                                    >-</button>
                                                    <input
                                                        type="number"
                                                        value={selectedElement.fontSize || 12}
                                                        onChange={(e) => updateElement({ fontSize: parseInt(e.target.value) || 12 })}
                                                        className="w-12 text-center text-xs border-0 bg-transparent"
                                                        min="8"
                                                        max="200"
                                                    />
                                                    <button
                                                        onClick={() => updateElement({ fontSize: Math.min(200, (selectedElement.fontSize || 12) + 1) })}
                                                        className="p-1 hover:bg-slate-200 rounded text-xs"
                                                    >+</button>
                                                </div>
                                                
                                                {/* Color */}
                                                <input
                                                    type="color"
                                                    value={selectedElement.color || '#000000'}
                                                    onChange={(e) => updateElement({ color: e.target.value })}
                                                    className="w-8 h-8 border border-slate-300 rounded cursor-pointer"
                                                    title="Color de texto"
                                                />
                                                
                                                {/* Estilos de texto */}
                                                <button
                                                    onClick={() => updateElement({ bold: !selectedElement.bold })}
                                                    className={`p-2 rounded ${selectedElement.bold ? 'bg-turquoise-100 text-turquoise-700' : 'hover:bg-slate-100'}`}
                                                    title="Negrita"
                                                >
                                                    <span className="font-bold text-sm">B</span>
                                                </button>
                                                <button
                                                    onClick={() => updateElement({ italic: !selectedElement.italic })}
                                                    className={`p-2 rounded ${selectedElement.italic ? 'bg-turquoise-100 text-turquoise-700' : 'hover:bg-slate-100'}`}
                                                    title="It√°lica"
                                                >
                                                    <span className="italic text-sm">I</span>
                                                </button>
                                                <button
                                                    onClick={() => updateElement({ underline: !selectedElement.underline })}
                                                    className={`p-2 rounded ${selectedElement.underline ? 'bg-turquoise-100 text-turquoise-700' : 'hover:bg-slate-100'}`}
                                                    title="Subrayado"
                                                >
                                                    <span className="underline text-sm">U</span>
                                                </button>
                                                <button
                                                    onClick={() => updateElement({ strikethrough: !selectedElement.strikethrough })}
                                                    className={`p-2 rounded ${selectedElement.strikethrough ? 'bg-turquoise-100 text-turquoise-700' : 'hover:bg-slate-100'}`}
                                                    title="Tachado"
                                                >
                                                    <span className="line-through text-sm">S</span>
                                                </button>
                                                
                                                {/* Efectos */}
                                                <button
                                                    onClick={() => updateElement({ textShadow: !selectedElement.textShadow })}
                                                    className={`p-2 rounded ${selectedElement.textShadow ? 'bg-turquoise-100 text-turquoise-700' : 'hover:bg-slate-100'}`}
                                                    title="Sombra"
                                                >
                                                    <span className="text-xs">Sombra</span>
                                                </button>
                                                <button
                                                    onClick={() => updateElement({ textOutline: !selectedElement.textOutline })}
                                                    className={`p-2 rounded ${selectedElement.textOutline ? 'bg-turquoise-100 text-turquoise-700' : 'hover:bg-slate-100'}`}
                                                    title="Contorno"
                                                >
                                                    <span className="text-xs">Contorno</span>
                                                </button>
                                                
                                                {/* Alineaci√≥n */}
                                                <div className="flex gap-1 border-l border-slate-200 pl-2">
                                                    <button
                                                        onClick={() => updateElement({ align: 'left' })}
                                                        className={`p-1 rounded ${selectedElement.align === 'left' ? 'bg-turquoise-100' : 'hover:bg-slate-100'}`}
                                                        title="Izquierda"
                                                    >
                                                        <Icons.AlignLeft size={14}/>
                                                    </button>
                                                    <button
                                                        onClick={() => updateElement({ align: 'center' })}
                                                        className={`p-1 rounded ${selectedElement.align === 'center' ? 'bg-turquoise-100' : 'hover:bg-slate-100'}`}
                                                        title="Centro"
                                                    >
                                                        <Icons.AlignCenter size={14}/>
                                                    </button>
                                                    <button
                                                        onClick={() => updateElement({ align: 'right' })}
                                                        className={`p-1 rounded ${selectedElement.align === 'right' ? 'bg-turquoise-100' : 'hover:bg-slate-100'}`}
                                                        title="Derecha"
                                                    >
                                                        <Icons.AlignRight size={14}/>
                                                    </button>
                                                </div>
                                                
                                                {/* Eliminar */}
                                                <button
                                                    onClick={deleteElement}
                                                    className="p-2 rounded hover:bg-red-100 text-red-600 ml-auto"
                                                    title="Eliminar (Delete)"
                                                >
                                                    <Icons.Trash size={16}/>
                                                </button>
                                            </div>
                                        )}
                                        
                                        {(selectedElement.type === 'rectangle' || selectedElement.type === 'line' || selectedElement.type === 'image') && (
                                            <div className="flex items-center gap-2 flex-wrap">
                                                {/* Ancho */}
                                                <div className="flex items-center gap-1">
                                                    <span className="text-xs text-slate-500">W:</span>
                                                    <input
                                                        type="number"
                                                        value={selectedElement.width || 100}
                                                        onChange={(e) => updateElement({ width: parseInt(e.target.value) || 100 })}
                                                        className="w-16 text-xs border rounded px-1 py-1"
                                                        min="20"
                                                    />
                                                </div>
                                                
                                                {/* Alto */}
                                                <div className="flex items-center gap-1">
                                                    <span className="text-xs text-slate-500">H:</span>
                                                    <input
                                                        type="number"
                                                        value={selectedElement.height || 100}
                                                        onChange={(e) => updateElement({ height: parseInt(e.target.value) || 100 })}
                                                        className="w-16 text-xs border rounded px-1 py-1"
                                                        min="20"
                                                    />
                                                </div>
                                                
                                                {/* Color (para rectangle y line) */}
                                                {(selectedElement.type === 'rectangle' || selectedElement.type === 'line') && (
                                                    <input
                                                        type="color"
                                                        value={selectedElement.color || '#000000'}
                                                        onChange={(e) => updateElement({ color: e.target.value })}
                                                        className="w-8 h-8 border border-slate-300 rounded cursor-pointer"
                                                        title="Color"
                                                    />
                                                )}
                                                
                                                {/* Eliminar */}
                                                <button
                                                    onClick={deleteElement}
                                                    className="p-2 rounded hover:bg-red-100 text-red-600 ml-auto"
                                                    title="Eliminar (Delete)"
                                                >
                                                    <Icons.Trash size={16}/>
                                                </button>
                                            </div>
                                        )}
                                        
                                        {(selectedElement.type === 'barcode' || selectedElement.type === 'qrcode') && (
                                            <div className="flex items-center gap-2 flex-wrap">
                                                {/* Contenido */}
                                                <input
                                                    type="text"
                                                    value={selectedElement.content || ''}
                                                    onChange={(e) => updateElement({ content: e.target.value })}
                                                    className="flex-1 text-xs border rounded px-2 py-1"
                                                    placeholder="Contenido"
                                                />
                                                
                                                {/* Ancho y Alto */}
                                                <div className="flex items-center gap-1">
                                                    <input
                                                        type="number"
                                                        value={selectedElement.width || 100}
                                                        onChange={(e) => updateElement({ width: parseInt(e.target.value) || 100 })}
                                                        className="w-16 text-xs border rounded px-1 py-1"
                                                        min="50"
                                                    />
                                                    <span className="text-xs text-slate-400">√ó</span>
                                                    <input
                                                        type="number"
                                                        value={selectedElement.height || 100}
                                                        onChange={(e) => updateElement({ height: parseInt(e.target.value) || 100 })}
                                                        className="w-16 text-xs border rounded px-1 py-1"
                                                        min="50"
                                                    />
                                                </div>
                                                
                                                {/* Eliminar */}
                                                <button
                                                    onClick={deleteElement}
                                                    className="p-2 rounded hover:bg-red-100 text-red-600"
                                                    title="Eliminar (Delete)"
                                                >
                                                    <Icons.Trash size={16}/>
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                                
                                {/* Burbujas flotantes apiladas en la derecha estilo Canva */}
                                <div className="fixed top-20 right-8 z-50 flex flex-col gap-3">
                                    {/* Burbuja 1: Elementos */}
                                    <div className="relative">
                                        {showFloatingMenu && floatingMenuType === 'elements' && (
                                            <div className="bg-white rounded-2xl shadow-2xl border border-slate-200 p-4 mb-3 min-w-[220px] max-h-[400px] overflow-y-auto animate-in">
                                                <div className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center justify-between">
                                                    <span>Elementos</span>
                                                    <button onClick={closeFloatingMenu} className="text-slate-400 hover:text-slate-600">
                                                        <Icons.X size={14}/>
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    {elementTypes.map(element => (
                                                        <div
                                                            key={element.id}
                                                            draggable
                                                            onDragStart={(e) => {
                                                                handleDragStart(e, element.id);
                                                                closeFloatingMenu();
                                                            }}
                                                            className="flex items-center gap-3 p-2 rounded-lg hover:bg-turquoise-50 cursor-move transition-colors"
                                                        >
                                                            <element.icon size={18} className="text-turquoise-600"/>
                                                            <span className="text-sm text-slate-700">{element.name}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <button
                                            onClick={() => toggleFloatingMenu('elements')}
                                            className={`w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-all ${floatingMenuType === 'elements' ? 'bg-turquoise-600 text-white scale-110' : 'bg-white text-slate-700 hover:bg-turquoise-50 hover:scale-105'}`}
                                            title="Elementos"
                                        >
                                            <Icons.Type size={24}/>
                                        </button>
                        </div>

                                    {/* Burbuja 2: Campos del Kit */}
                                    <div className="relative">
                                        {showFloatingMenu && floatingMenuType === 'fields' && (
                                            <div className="bg-white rounded-2xl shadow-2xl border border-slate-200 p-4 mb-3 min-w-[280px] max-h-[500px] overflow-y-auto animate-in">
                                                <div className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center justify-between">
                                                    <span>Campos del Kit</span>
                                                    <button onClick={closeFloatingMenu} className="text-slate-400 hover:text-slate-600">
                                                        <Icons.X size={14}/>
                                                    </button>
                                                </div>
                                                <div className="grid grid-cols-1 gap-2">
                                                    {kitFields.map(field => (
                                                        <div
                                                            key={field.id}
                                                            onClick={() => {
                                                                insertKitField(field);
                                                                closeFloatingMenu();
                                                            }}
                                                            className="p-2 border border-slate-200 rounded-lg hover:bg-turquoise-50 hover:border-turquoise-300 cursor-pointer transition-colors"
                                                        >
                                                            <div className="text-xs font-medium text-slate-800">{field.label}</div>
                                                            <div className="text-xs text-slate-500 truncate">{field.value}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <button
                                            onClick={() => toggleFloatingMenu('fields')}
                                            className={`w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-all ${floatingMenuType === 'fields' ? 'bg-turquoise-600 text-white scale-110' : 'bg-white text-slate-700 hover:bg-turquoise-50 hover:scale-105'}`}
                                            title="Campos del Kit"
                                        >
                                            <Icons.FileText size={24}/>
                                        </button>
                                    </div>

                                    {/* Burbuja 3: Im√°genes */}
                                    <div className="relative">
                                        {showFloatingMenu && floatingMenuType === 'images' && (
                                            <div className="bg-white rounded-2xl shadow-2xl border border-slate-200 p-4 mb-3 min-w-[240px] max-h-[400px] overflow-y-auto animate-in">
                                                <div className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center justify-between">
                                                    <span>Im√°genes</span>
                                                    <button onClick={closeFloatingMenu} className="text-slate-400 hover:text-slate-600">
                                                        <Icons.X size={14}/>
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    <div className="relative">
                                                        <input 
                                                            type="file" 
                                                            accept="image/*" 
                                                            onChange={handleImageUpload}
                                                            className="hidden"
                                                            id="image-upload-float"
                                                        />
                                                        <label htmlFor="image-upload-float" className="block p-3 border-2 border-dashed border-turquoise-300 rounded-lg text-center cursor-pointer hover:border-turquoise-500 hover:bg-turquoise-50 transition-colors">
                                                            <Icons.Upload size={20} className="mx-auto mb-2 text-turquoise-600"/>
                                                            <span className="text-xs font-medium text-slate-700">Subir Imagen</span>
                                                        </label>
                                                    </div>
                                                    {uploadedImages.length > 0 && (
                                                        <div className="space-y-2">
                                                            {uploadedImages.map(img => (
                                                                <div 
                                                                    key={img.id}
                                                                    onClick={() => {
                                                                        const newElement = {
                                                                            id: Date.now().toString(),
                                                                            type: 'image',
                                                                            x: 50,
                                                                            y: 50,
                                                                            width: 100,
                                                                            height: 100,
                                                                            url: img.url,
                                                                            alt: img.name
                                                                        };
                                                                        setElements([...elements, newElement]);
                                                                        setSelectedElement(newElement);
                                                                        closeFloatingMenu();
                                                                    }}
                                                                    className="p-2 border border-slate-200 rounded hover:bg-turquoise-50 cursor-pointer"
                                                                >
                                                                    <div className="text-xs truncate font-medium">{img.name}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        <button
                                            onClick={() => toggleFloatingMenu('images')}
                                            className={`w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-all ${floatingMenuType === 'images' ? 'bg-turquoise-600 text-white scale-110' : 'bg-white text-slate-700 hover:bg-turquoise-50 hover:scale-105'}`}
                                            title="Im√°genes"
                                        >
                                            <Icons.Image size={24}/>
                                        </button>
                                    </div>

                                    {/* Burbuja 4: Plantillas Guardadas */}
                                    <div className="relative">
                                        {showFloatingMenu && floatingMenuType === 'templates' && (
                                            <div className="bg-white rounded-2xl shadow-2xl border border-slate-200 p-4 mb-3 min-w-[280px] max-h-[500px] overflow-y-auto animate-in">
                                                <div className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center justify-between">
                                                    <span>Plantillas Guardadas</span>
                                                    <button onClick={closeFloatingMenu} className="text-slate-400 hover:text-slate-600">
                                                        <Icons.X size={14}/>
                                                    </button>
                                                </div>
                                                
                                                {/* Bot√≥n para subir imagen como plantilla */}
                                                <div className="mb-3 pb-3 border-b border-slate-200">
                                                    <input
                                                        type="file"
                                                        id="template-image-upload"
                                                        accept="image/*"
                                                        onChange={handleUploadTemplateImage}
                                                        className="hidden"
                                                    />
                                                    <label
                                                        htmlFor="template-image-upload"
                                                        className="flex items-center justify-center gap-2 w-full p-3 bg-turquoise-600 hover:bg-turquoise-700 text-white rounded-lg cursor-pointer transition-colors text-xs font-bold"
                                                    >
                                                        <Icons.Upload size={16}/>
                                                        <span>Subir Imagen como Plantilla</span>
                                                    </label>
                                                </div>

                                                {/* Lista de plantillas */}
                                                <div className="space-y-2 mb-3">
                                                    {savedTemplates.length === 0 ? (
                                                        <div className="text-xs text-slate-400 text-center py-4">
                                                            No hay plantillas guardadas
                                                        </div>
                                                    ) : (
                                                        savedTemplates.map(template => (
                                                            <div
                                                                key={template.id}
                                                                onClick={() => {
                                                                    loadTemplate(template);
                                                                    closeFloatingMenu();
                                                                }}
                                                                className="p-3 border border-slate-200 rounded-lg hover:bg-turquoise-50 hover:border-turquoise-300 cursor-pointer transition-colors"
                                                            >
                                                                <div className="font-medium text-slate-800 text-sm">{template.name}</div>
                                                                <div className="text-xs text-slate-500 flex justify-between mt-1">
                                                                    <span className="capitalize">{template.type} - {template.orientation || 'vertical'}</span>
                                                                    <span>{template.elements?.length || 0} elementos</span>
                                                                </div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>

                                                {/* Bot√≥n para eliminar todas las plantillas */}
                                                {savedTemplates.length > 0 && (
                                                    <div className="pt-3 border-t border-slate-200">
                                                        <button
                                                            onClick={deleteAllTemplates}
                                                            className="flex items-center justify-center gap-2 w-full p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors text-xs font-bold"
                                                        >
                                                            <Icons.Trash size={14}/>
                                                            <span>Eliminar Todas las Plantillas</span>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        <button
                                            onClick={() => toggleFloatingMenu('templates')}
                                            className={`w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-all ${floatingMenuType === 'templates' ? 'bg-turquoise-600 text-white scale-110' : 'bg-white text-slate-700 hover:bg-turquoise-50 hover:scale-105'}`}
                                            title="Plantillas Guardadas"
                                        >
                                            <Icons.Folder size={24}/>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Panel de propiedades - Solo mostrar si hay elemento seleccionado y NO est√° en fullscreen */}
                        {selectedElement && !isFullscreenMode && (
                            <div className="lg:col-span-3">
                                <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                                    <div 
                                        onClick={() => setPanelPropiedades(!panelPropiedades)}
                                        className="p-4 cursor-pointer hover:bg-slate-50 transition-colors flex items-center justify-between"
                                    >
                                        <h5 className="font-bold text-slate-700 text-sm">
                                            Propiedades del Elemento
                                        </h5>
                                        <Icons.ChevronsRight 
                                            size={16} 
                                            className={`text-slate-400 transition-transform ${panelPropiedades ? 'rotate-90' : ''}`}
                                        />
                                    </div>
                                    
                                    {panelPropiedades && (
                                        <div className="px-4 pb-4 pt-0 border-t border-slate-100">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">Tipo</label>
                                            <div className="text-sm text-slate-700 capitalize">{selectedElement.type}</div>
                                        </div>
                                        
                                        {selectedElement.type === 'text' && (
                                            <>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Texto</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.content}
                                                        onChange={(e) => updateElement({ content: e.target.value })}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Tama√±o</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.fontSize}
                                                            onChange={(e) => updateElement({ fontSize: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Color</label>
                                                        <input
                                                            type="color"
                                                            className="w-full h-10 border border-slate-300 rounded"
                                                            value={selectedElement.color}
                                                            onChange={(e) => updateElement({ color: e.target.value })}
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Tipograf√≠a</label>
                                                    <select
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.fontFamily || 'Arial'}
                                                        onChange={(e) => updateElement({ fontFamily: e.target.value })}
                                                    >
                                                        {fontFamilies.map(font => (
                                                            <option key={font.value} value={font.value}>{font.label}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.bold || false}
                                                            onChange={(e) => updateElement({ bold: e.target.checked })}
                                                        />
                                                        <span className="text-xs">Negrita</span>
                                                    </label>
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.italic || false}
                                                            onChange={(e) => updateElement({ italic: e.target.checked })}
                                                        />
                                                        <span className="text-xs">It√°lica</span>
                                                    </label>
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.underline || false}
                                                            onChange={(e) => updateElement({ underline: e.target.checked })}
                                                        />
                                                        <span className="text-xs">Subrayado</span>
                                                    </label>
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.strikethrough || false}
                                                            onChange={(e) => updateElement({ strikethrough: e.target.checked })}
                                                        />
                                                        <span className="text-xs">Tachado</span>
                                                    </label>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.textShadow || false}
                                                            onChange={(e) => updateElement({ textShadow: e.target.checked })}
                                                        />
                                                        <span className="text-xs">Sombra</span>
                                                    </label>
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.textOutline || false}
                                                            onChange={(e) => updateElement({ textOutline: e.target.checked })}
                                                        />
                                                        <span className="text-xs">Contorno</span>
                                                    </label>
                                                </div>
                                            </>
                                        )}
                                        
                                        {(selectedElement.type === 'barcode' || selectedElement.type === 'qrcode') && (
                                            <>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Contenido</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.content}
                                                        onChange={(e) => updateElement({ content: e.target.value })}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.width}
                                                            onChange={(e) => updateElement({ width: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Alto</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.height}
                                                            onChange={(e) => updateElement({ height: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                        
                                        {(selectedElement.type === 'rectangle' || selectedElement.type === 'line') && (
                                            <>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.width}
                                                            onChange={(e) => updateElement({ width: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Alto</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.height}
                                                            onChange={(e) => updateElement({ height: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Color</label>
                                                    <input
                                                        type="color"
                                                        className="w-full h-10 border border-slate-300 rounded"
                                                        value={selectedElement.color}
                                                        onChange={(e) => updateElement({ color: e.target.value })}
                                                    />
                                                </div>
                                            </>
                                        )}
                                        
                                        {selectedElement.type === 'image' && (
                                            <>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.width}
                                                            onChange={(e) => updateElement({ width: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Alto</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.height}
                                                            onChange={(e) => updateElement({ height: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">URL de Imagen</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.url}
                                                        onChange={(e) => updateElement({ url: e.target.value })}
                                                        placeholder="URL o subir imagen"
                                                    />
                                                </div>
                                            </>
                                        )}
                                        
                                        {/* Posici√≥n y tama√±o */}
                                        <div className="grid grid-cols-2 gap-2 pt-4 border-t border-slate-200">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Posici√≥n X</label>
                                                <input
                                                    type="number"
                                                    className="w-full p-2 border border-slate-300 rounded text-sm"
                                                    value={selectedElement.x}
                                                    onChange={(e) => updateElement({ x: parseInt(e.target.value) })}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Posici√≥n Y</label>
                                                <input
                                                    type="number"
                                                    className="w-full p-2 border border-slate-300 rounded text-sm"
                                                    value={selectedElement.y}
                                                    onChange={(e) => updateElement({ y: parseInt(e.target.value) })}
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="pt-4 border-t border-slate-200">
                                            <button
                                                onClick={deleteElement}
                                                className="w-full bg-red-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-red-700"
                                            >
                                                <Icons.Trash size={16} className="inline mr-2"/> Eliminar Elemento
                                            </button>
                                        </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Si est√° en modo fullscreen, renderizar solo el editor
            if (isFullscreen) {
                return (
                    <>
                        {renderEditor(true)}
                        <Modal isOpen={showHistoryModal} onClose={() => setShowHistoryModal(false)} title="Historial de Versiones" maxWidth="max-w-2xl">
                            <div className="space-y-4">
                                {templateHistory.length === 0 ? (
                                    <div className="text-center py-8 text-slate-500">
                                        No hay versiones guardadas a√∫n
                                    </div>
                                ) : (
                                    <div className="space-y-2 max-h-96 overflow-y-auto">
                                        {templateHistory.map((version) => (
                                            <div
                                                key={version.id}
                                                className="border border-slate-200 rounded-lg p-4 hover:bg-slate-50"
                                            >
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="font-medium text-slate-800">
                                                            {new Date(version.savedAt).toLocaleString('es-ES', {
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </div>
                                                        <div className="text-xs text-slate-500 mt-1">
                                                            Por: {version.savedBy || 'anonymous'}
                                                        </div>
                                                        <div className="text-xs text-slate-400 mt-1">
                                                            Tama√±o: {version.size ? (version.size / 1024).toFixed(2) + ' KB' : 'N/A'}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => previewTemplateVersion(version.path)}
                                                            className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                                                        >
                                                            Previsualizar
                                                        </button>
                                                        <button
                                                            onClick={() => restoreTemplateVersion(version.path)}
                                                            className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                                                        >
                                                            Restaurar
                                                        </button>
                                                    </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                )}
                            </div>
                        </Modal>
                    </>
                );
            }

            return (
                <>
                    {renderEditor(false)}
                    {/* Modal para guardar plantilla */}
                    <Modal isOpen={showSaveModal} onClose={() => setShowSaveModal(false)} title="Guardar Plantilla" maxWidth="max-w-md">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Nombre de la Plantilla</label>
                                <input
                                    type="text"
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateName}
                                    onChange={(e) => setTemplateName(e.target.value)}
                                    placeholder="Ej: Vi√±eta Ruta 2024"
                                />
                        </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Tipo de Plantilla</label>
                                <select
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateType}
                                    onChange={(e) => setTemplateType(e.target.value)}
                                >
                                    <option value="ventanilla">Ventanilla</option>
                                    <option value="ruta">Ruta</option>
                                    <option value="refrigerado">Refrigerado</option>
                                </select>
                    </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Orientaci√≥n</label>
                                <select
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateOrientation}
                                    onChange={(e) => setTemplateOrientation(e.target.value)}
                                >
                                    <option value="vertical">Vertical (71x210mm)</option>
                                    <option value="horizontal">Horizontal (210x71mm)</option>
                                </select>
                            </div>
                            <div className="flex justify-end gap-3 pt-4">
                                <button
                                    onClick={() => setShowSaveModal(false)}
                                    className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
                                >
                                    Cancelar
                                </button>
                                {currentTemplateId && (
                                <button
                                        onClick={() => {
                                            setShowSaveModal(false);
                                            saveTemplate(true);
                                        }}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold"
                                    >
                                        Guardar Versi√≥n
                                    </button>
                                )}
                                <button
                                    onClick={() => saveTemplate(false)}
                                    className="px-4 py-2 bg-turquoise-600 text-white rounded-lg hover:bg-turquoise-700 font-bold"
                                >
                                    Guardar
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Modal de historial de versiones */}
                    <Modal isOpen={showHistoryModal} onClose={() => setShowHistoryModal(false)} title="Historial de Versiones" maxWidth="max-w-2xl">
                        <div className="space-y-4">
                            {templateHistory.length === 0 ? (
                                <div className="text-center py-8 text-slate-500">
                                    No hay versiones guardadas a√∫n
                                </div>
                            ) : (
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {templateHistory.map((version) => (
                                        <div
                                            key={version.id}
                                            className="border border-slate-200 rounded-lg p-4 hover:bg-slate-50"
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="font-medium text-slate-800">
                                                        {new Date(version.savedAt).toLocaleString('es-ES', {
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1">
                                                        Por: {version.savedBy || 'anonymous'}
                                                    </div>
                                                    <div className="text-xs text-slate-400 mt-1">
                                                        Tama√±o: {version.size ? (version.size / 1024).toFixed(2) + ' KB' : 'N/A'}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => previewTemplateVersion(version.path)}
                                                        className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                                                    >
                                                        Previsualizar
                                                    </button>
                                                    <button
                                                        onClick={() => restoreTemplateVersion(version.path)}
                                                        className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                                                    >
                                                        Restaurar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </Modal>
                </>
            );

            // Si est√° en modo fullscreen, renderizar solo el editor
            if (isFullscreen) {
                return (
                    <>
                        {renderEditor(true)}
                        <Modal isOpen={showHistoryModal} onClose={() => setShowHistoryModal(false)} title="Historial de Versiones" maxWidth="max-w-2xl">
                            <div className="space-y-4">
                                {templateHistory.length === 0 ? (
                                    <div className="text-center py-8 text-slate-500">
                                        No hay versiones guardadas a√∫n
                                    </div>
                                ) : (
                                    <div className="space-y-2 max-h-96 overflow-y-auto">
                                        {templateHistory.map((version) => (
                                            <div
                                                key={version.id}
                                                className="border border-slate-200 rounded-lg p-4 hover:bg-slate-50"
                                            >
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="font-medium text-slate-800">
                                                            {new Date(version.savedAt).toLocaleString('es-ES', {
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </div>
                                                        <div className="text-xs text-slate-500 mt-1">
                                                            Por: {version.savedBy || 'anonymous'}
                                                        </div>
                                                        <div className="text-xs text-slate-400 mt-1">
                                                            Tama√±o: {version.size ? (version.size / 1024).toFixed(2) + ' KB' : 'N/A'}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => previewTemplateVersion(version.path)}
                                                            className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                                                        >
                                                            Previsualizar
                                                        </button>
                                                        <button
                                                            onClick={() => restoreTemplateVersion(version.path)}
                                                            className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                                                        >
                                                            Restaurar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </Modal>
                    </>
                );
            }

            return (
                <>
                    {renderEditor(false)}
                    {/* Modal para guardar plantilla */}
                    <Modal isOpen={showSaveModal} onClose={() => setShowSaveModal(false)} title="Guardar Plantilla" maxWidth="max-w-md">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Nombre de la Plantilla</label>
                                <input
                                    type="text"
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateName}
                                    onChange={(e) => setTemplateName(e.target.value)}
                                    placeholder="Ej: Vi√±eta Ruta 2024"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Tipo de Plantilla</label>
                                <select
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateType}
                                    onChange={(e) => setTemplateType(e.target.value)}
                                >
                                    <option value="ventanilla">Ventanilla</option>
                                    <option value="ruta">Ruta</option>
                                    <option value="refrigerado">Refrigerado</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Orientaci√≥n</label>
                                <select
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateOrientation}
                                    onChange={(e) => setTemplateOrientation(e.target.value)}
                                >
                                    <option value="vertical">Vertical (71x210mm)</option>
                                    <option value="horizontal">Horizontal (210x71mm)</option>
                                </select>
                            </div>
                            <div className="flex justify-end gap-3 pt-4">
                                <button
                                    onClick={() => setShowSaveModal(false)}
                                    className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
                                >
                                    Cancelar
                                </button>
                                {currentTemplateId && (
                                <button
                                        onClick={() => {
                                            setShowSaveModal(false);
                                            saveTemplate(true);
                                        }}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold"
                                    >
                                        Guardar Versi√≥n
                                    </button>
                                )}
                                <button
                                    onClick={() => saveTemplate(false)}
                                    className="px-4 py-2 bg-turquoise-600 text-white rounded-lg hover:bg-turquoise-700 font-bold"
                                >
                                    Guardar
                                </button>
                            </div>
                        </div>
                    </Modal>

                    {/* Modal de historial de versiones */}
                    <Modal isOpen={showHistoryModal} onClose={() => setShowHistoryModal(false)} title="Historial de Versiones" maxWidth="max-w-2xl">
                        <div className="space-y-4">
                            {templateHistory.length === 0 ? (
                                <div className="text-center py-8 text-slate-500">
                                    No hay versiones guardadas a√∫n
                </div>
                            ) : (
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {templateHistory.map((version) => (
                                        <div
                                            key={version.id}
                                            className="border border-slate-200 rounded-lg p-4 hover:bg-slate-50"
                                        >
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="font-medium text-slate-800">
                                                        {new Date(version.savedAt).toLocaleString('es-ES', {
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1">
                                                        Por: {version.savedBy || 'anonymous'}
                                                    </div>
                                                    <div className="text-xs text-slate-400 mt-1">
                                                        Tama√±o: {version.size ? (version.size / 1024).toFixed(2) + ' KB' : 'N/A'}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => previewTemplateVersion(version.path)}
                                                        className="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"
                                                    >
                                                        Previsualizar
                                                    </button>
                                                    <button
                                                        onClick={() => restoreTemplateVersion(version.path)}
                                                        className="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"
                                                    >
                                                        Restaurar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </Modal>
                </>
            );
        };

        // --- SISTEMA DE CACHE MEJORADO ---
        class CacheManager {
            constructor() {
                this.PATIENT_CACHE_PREFIX = 'patient_cache_';
                this.PATIENT_LIST_CACHE_KEY = 'patient_list_cache';
                this.MEDICINES_CACHE_KEY = 'medicines_cache';
                this.CONTACTS_CACHE_KEY = 'contacts_cache';
                this.USERS_CACHE_KEY = 'users_cache';
                this.TEMPLATES_CACHE_KEY = 'templates_cache';
                this.KITS_CACHE_KEY = 'kits_cache';
                this.CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
            }
            
            getFromCache(key) {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;
                    
                    const { data, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    
                    if (now - timestamp > this.CACHE_DURATION) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error reading cache:', error);
                    return null;
                }
            }
            
            saveToCache(key, data) {
                try {
                    const cacheData = {
                        data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(key, JSON.stringify(cacheData));
                } catch (error) {
                    console.error('Error saving to cache:', error);
                }
            }
            
            clearCache(key) {
                localStorage.removeItem(key);
            }
            
            clearPatientCache(patientId = null) {
                if (patientId) {
                    localStorage.removeItem(`${this.PATIENT_CACHE_PREFIX}${patientId}`);
                } else {
                    localStorage.removeItem(this.PATIENT_LIST_CACHE_KEY);
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(this.PATIENT_CACHE_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                }
            }
            
            getPatient(patientId) {
                return this.getFromCache(`${this.PATIENT_CACHE_PREFIX}${patientId}`);
            }
            
            savePatient(patientId, patientData) {
                this.saveToCache(`${this.PATIENT_CACHE_PREFIX}${patientId}`, patientData);
            }
            
            getPatientList() {
                return this.getFromCache(this.PATIENT_LIST_CACHE_KEY);
            }
            
            savePatientList(patientList) {
                this.saveToCache(this.PATIENT_LIST_CACHE_KEY, patientList);
            }
            
            getMedicines() {
                return this.getFromCache(this.MEDICINES_CACHE_KEY);
            }
            
            saveMedicines(medicines) {
                this.saveToCache(this.MEDICINES_CACHE_KEY, medicines);
            }
            
            getContacts() {
                return this.getFromCache(this.CONTACTS_CACHE_KEY);
            }
            
            saveContacts(contacts) {
                this.saveToCache(this.CONTACTS_CACHE_KEY, contacts);
            }
            
            getUsers() {
                return this.getFromCache(this.USERS_CACHE_KEY);
            }
            
            saveUsers(users) {
                this.saveToCache(this.USERS_CACHE_KEY, users);
            }
            
            getKits() {
                return this.getFromCache(this.KITS_CACHE_KEY);
            }
            
            saveKits(kits) {
                this.saveToCache(this.KITS_CACHE_KEY, kits);
            }
            
            getTemplates() {
                return this.getFromCache(this.TEMPLATES_CACHE_KEY);
            }
            
            saveTemplates(templates) {
                this.saveToCache(this.TEMPLATES_CACHE_KEY, templates);
            }
            
            isValid(key) {
                const cached = localStorage.getItem(key);
                if (!cached) return false;
                
                try {
                    const { timestamp } = JSON.parse(cached);
                    return Date.now() - timestamp < this.CACHE_DURATION;
                } catch {
                    return false;
                }
            }
        }

        // --- BLOCK: LOGIN ---
        // --- FIREBASE CONNECTION SCREEN ---
        const FirebaseConnectionScreen = () => {
            const [status, setStatus] = useState(firebaseConnectionStatus);
            const [error, setError] = useState(firebaseConnectionError);
            
            useEffect(() => {
                const handleInitialized = () => {
                    setStatus('connected');
                    setError(null);
                };
                
                const handleError = (e) => {
                    setStatus('error');
                    setError(e.detail);
                };
                
                window.addEventListener('firebaseInitialized', handleInitialized);
                window.addEventListener('firebaseError', handleError);
                
                // Verificar estado inicial
                if (firebaseInitialized) {
                    setStatus('connected');
                }
                
                return () => {
                    window.removeEventListener('firebaseInitialized', handleInitialized);
                    window.removeEventListener('firebaseError', handleError);
                };
            }, []);
            
            if (status === 'connected') {
                return null;
            }
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6">
                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-md border-white/50 text-center">
                        <div className="mb-8">
                            {status === 'initializing' ? (
                                <div className="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-pulse">
                                    <Icons.Activity size={40} />
                                </div>
                            ) : (
                                <div className="bg-gradient-to-tr from-red-500 to-orange-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white">
                                    <Icons.AlertCircle size={40} />
                                </div>
                            )}
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font mb-2">
                                {status === 'initializing' ? 'Conectando...' : 'Error de Conexi√≥n'}
                            </h1>
                            <p className="text-sm text-slate-500">
                                {status === 'initializing' 
                                    ? 'Inicializando Firebase...' 
                                    : 'No se pudo conectar con la base de datos'}
                            </p>
                        </div>
                        
                        {status === 'initializing' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-center gap-2 text-sm text-slate-600">
                                    <div className="w-2 h-2 bg-turquoise-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                    <div className="w-2 h-2 bg-turquoise-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                    <div className="w-2 h-2 bg-turquoise-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                </div>
                                <p className="text-xs text-slate-400">Por favor espera...</p>
                            </div>
                        )}
                        
                        {status === 'error' && error && (
                            <div className="space-y-4 text-left">
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="font-bold text-red-700 mb-2">‚ùå Error de conexi√≥n</div>
                                    <div className="text-xs text-red-600 whitespace-pre-line">
                                        {error.message || error.details || 'Error desconocido'}
                                    </div>
                                </div>
                                
                                {error.code && (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                        <div className="text-xs font-mono text-slate-600">
                                            <div><strong>C√≥digo:</strong> {error.code}</div>
                                        </div>
                                    </div>
                                )}
                                
                                {error.diagnostics && (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 max-h-48 overflow-y-auto">
                                        <div className="text-xs font-mono text-slate-600">
                                            <div className="font-bold mb-2">üìä Diagn√≥stico:</div>
                                            <div><strong>Online:</strong> {error.diagnostics.online ? '‚úÖ S√≠' : '‚ùå No'}</div>
                                            <div><strong>Firebase Global:</strong> {error.diagnostics.firebaseGlobal ? '‚úÖ S√≠' : '‚ùå No'}</div>
                                            <div><strong>Apps Inicializadas:</strong> {error.diagnostics.firebaseApps}</div>
                                            <div><strong>Scripts Cargados:</strong> {error.diagnostics.scriptsLoaded.length}</div>
                                            {error.diagnostics.networkTest && (
                                                <div><strong>Test de Red:</strong> {error.diagnostics.networkTest.success ? '‚úÖ OK' : '‚ùå Fall√≥'}</div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => {
                                            if (window.retryFirebaseConnection) {
                                                window.retryFirebaseConnection();
                                            } else {
                                                window.location.reload();
                                            }
                                        }}
                                        className="flex-1 bg-gradient-to-r from-turquoise-500 to-clinical-400 text-white px-6 py-3 rounded-xl font-bold text-sm hover:shadow-lg transition-all"
                                    >
                                        üîÑ Reintentar
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            if (window.runFirebaseDiagnostics) {
                                                const diag = await window.runFirebaseDiagnostics();
                                                console.log("üìä Diagn√≥stico completo:", diag);
                                                alert(`Diagn√≥stico:\n\nOnline: ${diag.online ? 'S√≠' : 'No'}\nFirebase Global: ${diag.firebaseGlobal ? 'S√≠' : 'No'}\nScripts Cargados: ${diag.scriptsLoaded.length}\nTest de Red: ${diag.networkTest?.success ? 'OK' : 'Fall√≥'}\n\nVer consola para m√°s detalles.`);
                                            } else {
                                                alert("Funci√≥n de diagn√≥stico no disponible. Ver consola del navegador.");
                                            }
                                        }}
                                        className="flex-1 bg-gradient-to-r from-slate-500 to-slate-600 text-white px-6 py-3 rounded-xl font-bold text-sm hover:shadow-lg transition-all"
                                    >
                                        üîç Diagn√≥stico
                                    </button>
                                </div>
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="flex-1 bg-slate-200 text-slate-700 px-6 py-2 rounded-xl font-bold text-xs hover:bg-slate-300 transition-all"
                                    >
                                        üîÉ Recargar P√°gina
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [firebaseStatus, setFirebaseStatus] = useState('Conectando...');

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // Verificar estado de Firebase peri√≥dicamente hasta que est√© listo
                let isChecking = false;
                let checkCount = 0;
                const checkFirebase = async () => {
                    if (isChecking) return;
                    
                    checkCount++;
                    try {
                        isChecking = true;
                        
                        // Verificaci√≥n directa del estado
                        if (firebaseInitialized && db) {
                            setFirebaseStatus('Conectado');
                            if (checkCount === 1) {
                                console.log("‚úÖ Firebase conectado correctamente");
                                console.log("‚ÑπÔ∏è Las colecciones se crear√°n autom√°ticamente al guardar datos");
                            }
                            isChecking = false;
                            return;
                        }
                        
                        // Si no est√° inicializado, intentar verificaci√≥n completa
                        const isConnected = await checkFirestoreConnection();
                        if (isConnected) {
                            setFirebaseStatus('Conectado');
                            console.log("‚úÖ Firebase conectado correctamente");
                            console.log("‚ÑπÔ∏è Las colecciones se crear√°n autom√°ticamente al guardar datos");
                            isChecking = false;
                        } else {
                            setFirebaseStatus('Conectando...');
                            isChecking = false;
                            // Reintentar despu√©s de 500ms (m√°ximo 20 intentos = 10 segundos)
                            if (checkCount < 20) {
                                setTimeout(checkFirebase, 500);
                            } else {
                                setFirebaseStatus('Error de conexi√≥n');
                                console.error("‚ùå No se pudo conectar a Firebase despu√©s de m√∫ltiples intentos");
                            }
                        }
                    } catch (err) {
                        console.warn("‚ö†Ô∏è Error verificando Firebase:", err);
                        setFirebaseStatus('Conectando...');
                        isChecking = false;
                        // Reintentar despu√©s de 1 segundo
                        if (checkCount < 20) {
                            setTimeout(checkFirebase, 1000);
                        } else {
                            setFirebaseStatus('Error de conexi√≥n');
                        }
                    }
                };
                
                // Escuchar evento de inicializaci√≥n de Firebase
                const handleFirebaseReady = () => {
                    setFirebaseStatus('Conectado');
                    console.log("‚úÖ Firebase detectado como inicializado");
                };
                window.addEventListener('firebaseInitialized', handleFirebaseReady);
                
                // Iniciar verificaci√≥n inmediatamente
                checkFirebase();
                
                // Verificar peri√≥dicamente cada 2 segundos
                const checkInterval = setInterval(() => {
                    if (firebaseStatus !== 'Conectado') {
                        checkFirebase();
                    }
                }, 2000);
                
                // Limpiar al desmontar
                return () => {
                    clearInterval(checkInterval);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    window.removeEventListener('firebaseInitialized', handleFirebaseReady);
                };
            }, []);
            
            const handleLogin = async (e) => {
                e.preventDefault(); 
                setError(''); 
                setLoading(true);
                
                // Usuario admin de emergencia
                if (username.trim().toLowerCase() === 'admin' && password === 'superadmin') { 
                    onLogin('superadmin', 'Super Usuario'); 
                    setLoading(false);
                    return; 
                }
                
                // Verificar si Firebase est√° disponible
                if (!firebaseInitialized || !db) {
                    setError('No se pudo conectar con la base de datos. Por favor, recarga la p√°gina.');
                    setLoading(false);
                    return;
                }
                
                const userKey = username.trim().toLowerCase();
                
                try {
                    const querySnapshot = await db.collection('prod_users')
                        .where('username', '==', userKey)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                            onLogin(userData.role, userData.nombre || userData.username);
                        } else { 
                            setError("Contrase√±a incorrecta."); 
                            setLoading(false); 
                        }
                    } else { 
                        setError("Usuario no encontrado."); 
                        setLoading(false); 
                    }
                } catch (err) { 
                    console.error('‚ùå Error en login:', err);
                    console.error('Error code:', err.code);
                    console.error('Error message:', err.message);
                    
                    // Manejar errores espec√≠ficos sin congelar la app
                    if (err.code === 'permission-denied') {
                        setError('‚ö†Ô∏è Error de permisos: Las reglas de seguridad de Firestore est√°n bloqueando el acceso. Verifica las reglas en Firebase Console.'); 
                    } else if (err.code === 'unavailable' || err.code === 'deadline-exceeded') {
                        setError('‚ö†Ô∏è Error de conexi√≥n: No se pudo conectar con Firebase. Verifica tu conexi√≥n a internet.'); 
                    } else if (err.code === 'failed-precondition') {
                        setError('‚ö†Ô∏è Error: La base de datos no est√° disponible en este momento.'); 
                    } else {
                        setError(`‚ö†Ô∏è Error de conexi√≥n: ${err.message || 'Error desconocido'}`); 
                    }
                    setLoading(false); 
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6 relative">
                    <div className="absolute top-6 right-6 flex flex-col gap-2">
                        <div className={`px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-sm transition-all ${isOnline ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                            {isOnline ? <Icons.Wifi size={16}/> : <Icons.WifiOff size={16}/>}
                            {isOnline ? 'Conectado a Internet' : 'Sin Conexi√≥n'}
                        </div>
                        <div className={`px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 ${firebaseStatus === 'Conectado' ? 'bg-green-100 text-green-700 border border-green-200' : firebaseStatus === 'Conectando...' ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                            {firebaseStatus === 'Conectado' ? '‚úÖ Base de datos' : firebaseStatus === 'Conectando...' ? 'üîÑ Conectando...' : '‚ùå Base de datos'}
                        </div>
                    </div>

                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50 relative z-10">
                        <div className="text-center mb-10">
                            <div className="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-ekg">
                                <Icons.Activity size={40} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font">Bit√°cora <span className="text-turquoise-600">Producci√≥n</span></h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Dpto. Operaciones</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold border border-red-100">{error}</div>}
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Usuario</label>
                                    <input 
                                        type="text" 
                                        className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contrase√±a</label>
                                    <input 
                                        type="password" 
                                        className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        required 
                                    />
                                </div>
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full bg-gradient-to-r from-turquoise-500 to-clinical-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect"
                            >
                                {loading ? 'Verificando...' : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- BLOCK: DASHBOARD ---
        const DashboardBlock = ({ setView, stats, userName, role }) => { 
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(()=>setTime(new Date()),1000); return ()=>clearInterval(t); }, []);
            
            const allCards = [
                { id: 'reports', label: 'Reportes y Carpetas', icon: Icons.List, color: 'bg-amber-500', desc: 'Ver kits por fecha', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'pacientes', label: 'Gesti√≥n de Pacientes', icon: Icons.Users, color: 'bg-turquoise-500', desc: 'Crear kits por DH', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'config', label: 'Configuraci√≥n', icon: Icons.Settings, color: 'bg-slate-500', desc: 'Cat√°logos del Sistema', allowed: ['admin', 'superadmin'] },
                { id: 'users', label: 'Gesti√≥n de Usuarios', icon: Icons.UserCog, color: 'bg-indigo-500', desc: 'Control de accesos', allowed: ['admin', 'superadmin'] },
            ];

            const visibleCards = allCards.filter(c => c.allowed.includes(role));

            return (
                <div className="w-full max-w-6xl mx-auto space-y-8 animate-in">
                    <div className="bg-gradient-to-r from-turquoise-600 to-clinical-600 rounded-3xl p-8 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10">
                            <h1 className="text-3xl font-bold brand-font mb-2">¬°Hola, {userName}!</h1>
                            <p className="opacity-90 text-sm font-medium uppercase tracking-wider">Operaciones - Bit√°cora de Producci√≥n</p>
                        </div>
                        <div className="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform origin-bottom-right"></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex flex-col justify-center items-center text-center">
                            <div className="text-5xl font-mono font-bold text-slate-700 tracking-widest mb-2">{time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <div className="text-sm text-slate-400 font-medium uppercase">{time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'})}</div>
                        </div>
                        <div className="md:col-span-2 grid grid-cols-2 gap-4">
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-turquoise-50 text-turquoise-600 rounded-2xl"><Icons.Box size={32}/></div>
                                <div>
                                    <div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.totalKits}/></div>
                                    <div className="text-xs text-slate-400 font-bold uppercase">Kits Totales</div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-clinical-50 text-clinical-600 rounded-2xl"><Icons.Calendar size={32}/></div>
                                <div>
                                    <div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.todayKits}/></div>
                                    <div className="text-xs text-slate-400 font-bold uppercase">Armados Hoy</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-700 brand-font mt-8">Accesos Directos</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {visibleCards.map(c => (
                            <button 
                                key={c.id} 
                                onClick={() => setView(c.id)} 
                                className="group relative bg-white p-6 rounded-3xl shadow-soft border border-slate-100 hover:shadow-xl transition-all duration-300 text-left hover:-translate-y-1 overflow-hidden"
                            >
                                <div className={`absolute top-0 right-0 w-24 h-24 ${c.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                <div className={`w-12 h-12 rounded-2xl ${c.color} flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`}>
                                    <c.icon size={24} />
                                </div>
                                <h4 className="font-bold text-lg text-slate-800 mb-1 group-hover:text-turquoise-600 transition-colors">{c.label}</h4>
                                <p className="text-xs text-slate-400">{c.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- BLOCK: REPORTES ---
        const ReportsBlock = ({ kits, patients, userRole, userName, setView }) => {
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedDay, setSelectedDay] = useState(null);
            const [selectedKit, setSelectedKit] = useState(null);
            const [showKitModal, setShowKitModal] = useState(false);
            const [kitToEdit, setKitToEdit] = useState(null);
            
            const groupedByMonth = useMemo(() => {
                const groups = {};
                kits.forEach(kit => {
                    if (!kit.fechaArmado) return;
                    const date = new Date(kit.fechaArmado);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const dayKey = kit.fechaArmado;
                    
                    if (!groups[monthKey]) {
                        groups[monthKey] = {
                            name: monthKey,
                            display: date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }),
                            days: {}
                        };
                    }
                    
                    if (!groups[monthKey].days[dayKey]) {
                        groups[monthKey].days[dayKey] = {
                            date: dayKey,
                            display: date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }),
                            kits: []
                        };
                    }
                    
                    groups[monthKey].days[dayKey].kits.push(kit);
                });
                return groups;
            }, [kits]);

            const downloadDayExcel = (dayKits) => {
                if (!dayKits || dayKits.length === 0) {
                    alert('No hay kits para este d√≠a');
                    return;
                }

                const excelData = dayKits.map(kit => ({
                    'DNI/ID': kit.dni || '',
                    'Nombre': kit.nombre || '',
                    'Cantidad Medicamentos': kit.medicamentos?.length || 0,
                    'Cantidad Refrigerados': kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    'Fecha Armado Kit': kit.fechaArmado || '',
                    'Digitador': kit.digitador || '',
                    'Fecha Entrega Kit': kit.fechaEntregaKit || '',
                    'Modo Entrega': kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla',
                    'Contact Center': kit.contactCenter || '',
                    'GPS': kit.gpsStatus || 'SIN GPS'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Kits del D√≠a");
                
                const fileName = `kits_${selectedDay}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            const handleBack = () => {
                if (selectedKit) {
                    setSelectedKit(null);
                } else if (selectedDay) {
                    setSelectedDay(null);
                } else if (selectedMonth) {
                    setSelectedMonth(null);
                }
            };

            const handleEditKitFromReports = (kit) => {
                setKitToEdit(kit);
                const patient = patients.find(p => p.dni === kit.dni);
                if (patient) {
                    sessionStorage.setItem('editKitFromReports', JSON.stringify({
                        kitId: kit.id,
                        patientId: patient.id,
                        kitData: kit
                    }));
                    setView('pacientes');
                } else {
                    alert('No se encontr√≥ el paciente asociado a este kit');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={handleBack} className={`p-2 rounded-xl transition-colors ${selectedMonth ? 'hover:bg-slate-100 text-slate-500' : 'opacity-0 pointer-events-none'}`}>
                                <Icons.ArrowLeft size={20}/>
                            </button>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">
                                    {selectedKit ? 'Detalle del Kit' : 
                                     selectedDay ? `Kits del ${selectedDay}` :
                                     selectedMonth ? groupedByMonth[selectedMonth]?.display :
                                     'Reportes y Carpetas'}
                                </h3>
                                <p className="text-xs font-semibold text-turquoise-600">
                                    {selectedKit ? 'Informaci√≥n completa' :
                                     selectedDay ? `${groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.length || 0} Kits` :
                                     selectedMonth ? `${Object.keys(groupedByMonth[selectedMonth]?.days || {}).length} d√≠as` :
                                     `${Object.keys(groupedByMonth).length} meses, ${kits.length} kits totales`}
                                </p>
                            </div>
                        </div>
                        
                        {(userRole === 'admin' || userRole === 'superadmin') && selectedDay && (
                            <button 
                                onClick={() => downloadDayExcel(groupedByMonth[selectedMonth]?.days[selectedDay]?.kits)} 
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect"
                            >
                                <Icons.Download size={16}/> Descargar Excel
                            </button>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {selectedKit ? (
                            <div className="text-center py-10 text-slate-400">
                                Redirigiendo a modal de detalles...
                            </div>
                        ) : selectedDay ? (
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.map(kit => (
                                        <div 
                                            key={kit.id} 
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:shadow-md transition-all"
                                        >
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="font-bold text-slate-800 text-sm truncate">{kit.nombre}</div>
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${kit.deliveryMode === 'ruta' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla'}
                                                </span>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                <div className="text-xs text-slate-500 flex items-center gap-2">
                                                    <span className="font-mono bg-slate-100 px-2 py-0.5 rounded">{kit.dni}</span>
                                                    <span className="text-turquoise-600 font-bold">{kit.medicamentos?.length || 0} meds</span>
                                                </div>
                                                <div className="text-xs text-slate-400 flex justify-between">
                                                    <span>{kit.horaOperaciones || '--:--'}</span>
                                                    <span>{kit.digitador}</span>
                                                </div>
                                                {kit.isRefrigerated && (
                                                    <div className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado: {kit.cantRefriGlobal || 1}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 pt-2 border-t border-slate-100">
                                                <button 
                                                    onClick={() => { setSelectedKit(kit); setShowKitModal(true); }}
                                                    className="flex-1 bg-slate-100 text-slate-700 py-1.5 rounded text-xs font-medium hover:bg-slate-200 transition-colors"
                                                >
                                                    Ver
                                                </button>
                                                <button 
                                                    onClick={() => handleEditKitFromReports(kit)}
                                                    className="flex-1 bg-orange-600 text-white py-1.5 rounded text-xs font-medium hover:bg-orange-700 transition-colors flex items-center justify-center gap-1"
                                                >
                                                    <Icons.Edit size={12}/> Editar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : selectedMonth ? (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    {Object.entries(groupedByMonth[selectedMonth]?.days || {}).sort((a, b) => b[0].localeCompare(a[0])).map(([date, dayData]) => (
                                        <div 
                                            key={date} 
                                            onClick={() => setSelectedDay(date)}
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer flex flex-col items-center text-center gap-3 transition-all group"
                                        >
                                            <div className="bg-turquoise-100 p-3 rounded-full text-turquoise-600 group-hover:scale-110 transition-transform">
                                                <Icons.Calendar size={24}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-sm text-slate-700">{dayData.display}</h4>
                                                <p className="text-[10px] text-slate-400 mt-1">{dayData.kits.length} Kits</p>
                                            </div>
                                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); downloadDayExcel(dayData.kits); }}
                                                    className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full hover:bg-green-200 transition-colors"
                                                >
                                                    <Icons.Download size={10}/> Excel
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                    {Object.entries(groupedByMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([monthKey, monthData]) => (
                                        <div 
                                            key={monthKey} 
                                            onClick={() => setSelectedMonth(monthKey)}
                                            className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-turquoise-400 hover:shadow-lg cursor-pointer flex flex-col items-center text-center gap-4 transition-all group"
                                        >
                                            <div className="bg-gradient-to-br from-turquoise-500 to-clinical-500 p-4 rounded-2xl text-white group-hover:scale-110 transition-transform">
                                                <Icons.Folder size={32}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-lg text-slate-800">{monthData.display}</h4>
                                                <p className="text-sm text-slate-400 mt-1">
                                                    {Object.keys(monthData.days).length} d√≠as ‚Ä¢ {Object.values(monthData.days).reduce((acc, day) => acc + day.kits.length, 0)} kits
                                                </p>
                                            </div>
                                            <div className="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                                {monthKey === `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}` ? 'MES ACTUAL' : 'HIST√ìRICO'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: PACIENTES ---
        const PatientManagementBlock = ({ medicines, onAddPatient, onUpdatePatient, onDeletePatient, onSaveKit, onDeleteKit, currentUser, userRole, contacts }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [selectedPatientFullData, setSelectedPatientFullData] = useState(null);
            const [showPatientForm, setShowPatientForm] = useState(false);
            const [editingPatientId, setEditingPatientId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const [patientsPerPage] = useState(50);
            const [loadingPatients, setLoadingPatients] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [patientCache] = useState(new CacheManager());
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [isViewMode, setIsViewMode] = useState(false);
            const [printTemplates, setPrintTemplates] = useState([]);
            const [selectedPrintTemplate, setSelectedPrintTemplate] = useState(null);
            const [kitData, setKitData] = useState({ 
                fechaArmado: new Date().toISOString().split('T')[0], 
                fechaEntregaLogistica: '', 
                fechaEntregaKit: '', 
                horaOperaciones: '', 
                contactCenter: '', 
                triggerMeds: '', 
                medicamentos: [],
                digitador: '',
                deliveryMode: '', 
                selectedPhones: [], 
                otherPhoneEnabled: false, 
                otherPhone: '',
                addressConfirmed: true, 
                secondaryAddress: '',
                gpsStatus: 'SIN GPS', 
                observationsEnabled: false,
                observations: '',
                isRefrigerated: false, 
                cantRefriGlobal: '' 
            });
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);
            const [patientSnapshotUnsubscribe, setPatientSnapshotUnsubscribe] = useState(null);
            const [patientForm, setPatientForm] = useState({ 
                dni: '', 
                nombre: '', 
                telefono: '', 
                direccion: '', 
                familiar: '', 
                telefonoFamiliar: '', 
                descripcionMunicipio: '', 
                tipoAfiliado: 'AFILIADO DIRECTO',
                nAfiliacion: '' 
            });

            // Cargar plantillas de impresi√≥n
            const loadPrintTemplates = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar plantillas de impresi√≥n');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_templates').get();
                    const templates = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setPrintTemplates(templates);
                    
                    // Si no hay plantillas, cargar las predeterminadas autom√°ticamente
                    if (templates.length === 0) {
                        const predeterminedTemplates = createPredeterminedTemplatesForPrint();
                        for (const template of predeterminedTemplates) {
                            const templateRef = db.collection('prod_templates').doc(template.id);
                            await templateRef.set({
                                ...template,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        }
                        // Recargar
                        const newSnapshot = await db.collection('prod_templates').get();
                        const newTemplates = newSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setPrintTemplates(newTemplates);
                    }
                } catch (error) {
                    console.error('Error cargando plantillas de impresi√≥n:', error);
                }
            };
            
            // Funci√≥n para crear las 3 plantillas PREDETERMINADAS (disponible en ambos bloques)
            const createPredeterminedTemplatesForPrint = () => {
                const mmToPx = 3.779; // Conversi√≥n mm a px
                
                // PLANTILLA 1: RUTA
                const plantillaRuta = {
                    id: 'plantilla_ruta',
                    name: 'Plantilla Ruta',
                    type: 'ruta',
                    orientation: 'horizontal',
                    elements: [
                        // Encabezado con logos y t√≠tulo
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_ruta', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_ruta', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, content: 'ENTREGA EN RUTA', fontSize: 5.5*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 21*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 25*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 32*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 36*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        { id: 'label_tel_principal', type: 'text', x: 2*mmToPx, y: 43*mmToPx, width: 45*mmToPx, height: 3.5*mmToPx, content: 'TEL PRINCIPAL', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_principal', type: 'text', x: 2*mmToPx, y: 47*mmToPx, width: 45*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefono' },
                        { id: 'label_tel_ref', type: 'text', x: 50*mmToPx, y: 43*mmToPx, width: 30*mmToPx, height: 3.5*mmToPx, content: 'TEL REF', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_ref', type: 'text', x: 50*mmToPx, y: 47*mmToPx, width: 30*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefonoRef' },
                        { id: 'label_gps', type: 'text', x: 83*mmToPx, y: 43*mmToPx, width: 25*mmToPx, height: 3.5*mmToPx, content: 'GPS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_gps', type: 'text', x: 83*mmToPx, y: 47*mmToPx, width: 25*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'gpsStatus' },
                        { id: 'label_meds', type: 'text', x: 110*mmToPx, y: 43*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: '# MEDICAMENTOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_meds', type: 'text', x: 110*mmToPx, y: 47*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantMedicamentos' },
                        { id: 'label_direccion', type: 'text', x: 2*mmToPx, y: 52*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'DIRECCI√ìN', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_direccion', type: 'text', x: 2*mmToPx, y: 56*mmToPx, width: 100*mmToPx, height: 8*mmToPx, content: '', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'direccion' },
                        { id: 'label_obs_ruta', type: 'text', x: 2*mmToPx, y: 65*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'OBSERVACIONES DE ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_obs_ruta', type: 'text', x: 2*mmToPx, y: 69*mmToPx, width: 100*mmToPx, height: 4*mmToPx, content: '', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'observaciones' },
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 52*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 56*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_refri', type: 'text', x: 160*mmToPx, y: 52*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'REFRIGERADO', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_refri', type: 'text', x: 160*mmToPx, y: 56*mmToPx, width: 48*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantRefrigerados' },
                        { id: 'label_extra_titulo', type: 'text', x: 105*mmToPx, y: 61*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'EXTRA RUTA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_extra_contenido', type: 'text', x: 105*mmToPx, y: 65*mmToPx, width: 103*mmToPx, height: 4*mmToPx, content: '', fontSize: 4*mmToPx, color: '#666666', fontFamily: 'Arial', isField: false }
                    ]
                };
                
                // PLANTILLA 2: VENTANILLA
                const plantillaVentanilla = {
                    id: 'plantilla_ventanilla',
                    name: 'Plantilla Ventanilla',
                    type: 'ventanilla',
                    orientation: 'horizontal',
                    elements: [
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_ventanilla', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_ventanilla', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 3*mmToPx, content: 'ENTREGA VENTANILLA', fontSize: 5.5*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 21*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 25*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 32*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID DEL DERECHOHABIENTE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 36*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        { id: 'label_tel_principal', type: 'text', x: 2*mmToPx, y: 43*mmToPx, width: 45*mmToPx, height: 3.5*mmToPx, content: 'TEL PRINCIPAL', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_principal', type: 'text', x: 2*mmToPx, y: 47*mmToPx, width: 45*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefono' },
                        { id: 'label_tel_ref', type: 'text', x: 50*mmToPx, y: 43*mmToPx, width: 30*mmToPx, height: 3.5*mmToPx, content: 'TEL REF', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_tel_ref', type: 'text', x: 50*mmToPx, y: 47*mmToPx, width: 30*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'telefonoRef' },
                        { id: 'label_gps', type: 'text', x: 83*mmToPx, y: 43*mmToPx, width: 25*mmToPx, height: 3.5*mmToPx, content: 'GPS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_gps', type: 'text', x: 83*mmToPx, y: 47*mmToPx, width: 25*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'gpsStatus' },
                        { id: 'label_meds', type: 'text', x: 110*mmToPx, y: 43*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: '# MEDICAMENTOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_meds', type: 'text', x: 110*mmToPx, y: 47*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantMedicamentos' },
                        { id: 'campo_ventanilla', type: 'text', x: 2*mmToPx, y: 52*mmToPx, width: 100*mmToPx, height: 10*mmToPx, content: 'VENTANILLA', fontSize: 18*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_obs_ventanilla', type: 'text', x: 2*mmToPx, y: 63*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'OBSERVACIONES DE VENTANILLA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_obs_ventanilla', type: 'text', x: 2*mmToPx, y: 67*mmToPx, width: 100*mmToPx, height: 4*mmToPx, content: '', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'observaciones' },
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 52*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 56*mmToPx, width: 50*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_refri', type: 'text', x: 160*mmToPx, y: 52*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'REFRIGERADO', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_refri', type: 'text', x: 160*mmToPx, y: 56*mmToPx, width: 48*mmToPx, height: 4*mmToPx, content: '', fontSize: 5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'cantRefrigerados' }
                    ]
                };
                
                // PLANTILLA 3: REFRIGERADOS
                const plantillaRefrigerados = {
                    id: 'plantilla_refrigerados',
                    name: 'Plantilla Refrigerados',
                    type: 'refrigerado',
                    orientation: 'horizontal',
                    elements: [
                        { id: 'header', type: 'text', x: 2*mmToPx, y: 1*mmToPx, width: 206*mmToPx, height: 5*mmToPx, content: 'DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'logo1', type: 'text', x: 5*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 1]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'logo2', type: 'text', x: 175*mmToPx, y: 7*mmToPx, width: 30*mmToPx, height: 8*mmToPx, content: '[LOGO 2]', fontSize: 4*mmToPx, color: '#999999', fontFamily: 'Arial', isField: false },
                        { id: 'banner_refri', type: 'rectangle', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 8*mmToPx, color: '#000000', borderWidth: 0, borderColor: '#000000', isField: false },
                        { id: 'banner_text_refri', type: 'text', x: 0, y: 16*mmToPx, width: 210*mmToPx, height: 8*mmToPx, content: 'PRODUCTO REFRIGERADO', fontSize: 10*mmToPx, color: '#FFFFFF', fontFamily: 'Arial', bold: true, align: 'center', isField: false },
                        { id: 'label_nombre', type: 'text', x: 2*mmToPx, y: 26*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'NOMBRE', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_nombre', type: 'text', x: 2*mmToPx, y: 30*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'nombre' },
                        { id: 'label_dni', type: 'text', x: 2*mmToPx, y: 37*mmToPx, width: 100*mmToPx, height: 3.5*mmToPx, content: 'ID', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_dni', type: 'text', x: 2*mmToPx, y: 41*mmToPx, width: 100*mmToPx, height: 6*mmToPx, content: '', fontSize: 7*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'dni' },
                        { id: 'label_fecha', type: 'text', x: 105*mmToPx, y: 26*mmToPx, width: 50*mmToPx, height: 3.5*mmToPx, content: 'FECHA DESPACHO/ENTREGA', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_fecha', type: 'text', x: 105*mmToPx, y: 30*mmToPx, width: 50*mmToPx, height: 6*mmToPx, content: '', fontSize: 6*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: true, fieldId: 'fechaArmado' },
                        { id: 'label_cant_refri', type: 'text', x: 160*mmToPx, y: 26*mmToPx, width: 48*mmToPx, height: 3.5*mmToPx, content: 'CANT REFRIGERADOS', fontSize: 4.5*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, isField: false },
                        { id: 'field_cant_refri', type: 'text', x: 160*mmToPx, y: 30*mmToPx, width: 48*mmToPx, height: 12*mmToPx, content: '', fontSize: 20*mmToPx, color: '#000000', fontFamily: 'Arial', bold: true, align: 'center', isField: true, fieldId: 'cantRefrigerados' }
                    ]
                };
                
                return [plantillaRuta, plantillaVentanilla, plantillaRefrigerados];
            };

            // Funci√≥n para cargar plantillas predeterminadas (desde el bloque de pacientes)
            const loadPredeterminedTemplatesFromPatientBlock = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        alert('Firebase no disponible');
                        return;
                    }
                    
                    const templates = createPredeterminedTemplatesForPrint();
                    
                    // Guardar o reemplazar las 3 plantillas con IDs fijos
                    for (const template of templates) {
                        const templateRef = db.collection('prod_templates').doc(template.id);
                        await templateRef.set({
                            ...template,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                    
                    // Recargar plantillas
                    await loadPrintTemplates();
                    
                    alert('Plantillas predeterminadas cargadas correctamente');
                } catch (error) {
                    console.error('Error cargando plantillas predeterminadas:', error);
                    alert('Error al cargar plantillas: ' + error.message);
                }
            };

            const loadPatients = async () => {
                setLoadingPatients(true);
                setLoadingProgress(0);
                
                try {
                    const cachedPatients = patientCache.getPatientList();
                    if (cachedPatients && cachedPatients.length > 0) {
                        setPatients(cachedPatients);
                        setLoadingPatients(false);
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_patients')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const allPatients = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        dni: doc.data().dni || '',
                        nombre: doc.data().nombre || '',
                        tipoAfiliado: doc.data().tipoAfiliado || 'AFILIADO DIRECTO',
                        createdAt: doc.data().createdAt
                    }));
                    
                    patientCache.savePatientList(allPatients);
                    setPatients(allPatients);
                    
                } catch (error) {
                    console.error('Error cargando pacientes:', error);
                    alert('Error al cargar pacientes: ' + error.message);
                } finally {
                    setLoadingProgress(100);
                    setTimeout(() => setLoadingPatients(false), 500);
                }
            };

            const loadKits = async () => {
                try {
                    const cachedKits = patientCache.getKits();
                    if (cachedKits) {
                        setKits(cachedKits);
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const kitsSnapshot = await db.collection('prod_kits').get();
                    const kitsData = kitsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                    
                    patientCache.saveKits(kitsData);
                    setKits(kitsData);
                } catch (error) {
                    console.error('Error cargando kits:', error);
                }
            };

            useEffect(() => {
                loadPatients();
                loadKits();
                loadPrintTemplates();
            }, []);

            useEffect(() => {
                const editKitData = sessionStorage.getItem('editKitFromReports');
                if (editKitData) {
                    const { kitData, patientId } = JSON.parse(editKitData);
                    const patient = patients.find(p => p.id === patientId);
                    if (patient && kitData) {
                        handleSelectPatient(patient);
                        setKitData({...kitData, otherPhoneEnabled: !!kitData.otherPhone});
                        setEditingKitId(kitData.id);
                        setIsViewMode(false);
                        setShowKitForm(true);
                    }
                    sessionStorage.removeItem('editKitFromReports');
                }
            }, [patients]);

            const loadPatientFullData = async (patientId) => {
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                }
                
                try {
                    const cachedPatient = patientCache.getPatient(patientId);
                    if (cachedPatient) {
                        setSelectedPatientFullData(cachedPatient);
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const patientDoc = await db.collection('prod_patients').doc(patientId).get();
                    if (patientDoc.exists) {
                        const fullData = { id: patientDoc.id, ...patientDoc.data() };
                        setSelectedPatientFullData(fullData);
                        patientCache.savePatient(patientId, fullData);
                        
                        const unsubscribe = db.collection('prod_patients').doc(patientId)
                            .onSnapshot((doc) => {
                                if (doc.exists) {
                                    const updatedData = { id: doc.id, ...doc.data() };
                                    setSelectedPatientFullData(updatedData);
                                    patientCache.savePatient(patientId, updatedData);
                                }
                            });
                        
                        setPatientSnapshotUnsubscribe(() => unsubscribe);
                    }
                } catch (error) {
                    console.error("Error cargando datos del paciente:", error);
                }
            };

            const handleSelectPatient = async (patient) => {
                setSelectedPatient(patient);
                await loadPatientFullData(patient.id);
            };

            useEffect(() => {
                return () => {
                    if (patientSnapshotUnsubscribe) {
                        patientSnapshotUnsubscribe();
                    }
                };
            }, [patientSnapshotUnsubscribe]);

            const filteredPatients = useMemo(() => {
                return patients.filter(p => 
                    (p.nombre?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                     p.dni?.includes(searchTerm))
                );
            }, [patients, searchTerm]);

            const indexOfLastPatient = currentPage * patientsPerPage;
            const indexOfFirstPatient = indexOfLastPatient - patientsPerPage;
            const currentPatients = filteredPatients.slice(indexOfFirstPatient, indexOfLastPatient);
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);

            const patientKits = selectedPatient ? kits.filter(k => k.patientId === selectedPatient.id) : [];

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);
                    
                    let added = 0;
                    let skipped = 0;
                    let updated = 0;

                    for (const row of data) {
                        const pData = {
                            dni: String(row['DNI'] || row['dni'] || '').trim(),
                            nombre: String(row['NOMBRE'] || row['nombre'] || '').toUpperCase().trim(),
                            telefono: String(row['TELEFONO'] || row['telefono'] || '').trim(),
                            direccion: String(row['DIRECCION'] || row['direccion'] || '').toUpperCase().trim(),
                            familiar: String(row['FAMILIAR'] || row['familiar'] || '').toUpperCase().trim(),
                            telefonoFamiliar: String(row['TELEFONOFAMILIAR'] || row['telefonofamiliar'] || '').trim(),
                            descripcionMunicipio: String(row['DESCRIPCION_MUNICIPIO'] || row['descripcion_municipio'] || '').toUpperCase().trim(),
                            tipoAfiliado: String(row['TIPOAFILIADO'] || row['tipoafiliado'] || 'AFILIADO DIRECTO').toUpperCase().trim(),
                            nAfiliacion: String(row['DNI'] || row['dni'] || '').trim() 
                        };

                        if (!pData.dni) continue;

                        const existingPatient = patients.find(p => p.dni === pData.dni);

                        if (existingPatient) {
                            let needsUpdate = false;
                            const updates = {};
                            const checkAndFill = (field) => {
                                const dbValue = existingPatient[field];
                                const excelValue = pData[field];
                                if ((!dbValue || dbValue.trim() === '') && (excelValue && excelValue.trim() !== '')) {
                                    updates[field] = excelValue;
                                    needsUpdate = true;
                                }
                            };
                            checkAndFill('nombre'); checkAndFill('telefono'); checkAndFill('direccion');
                            checkAndFill('familiar'); checkAndFill('telefonoFamiliar'); checkAndFill('descripcionMunicipio');
                            
                            if ((!existingPatient.tipoAfiliado || existingPatient.tipoAfiliado === 'AFILIADO DIRECTO') && pData.tipoAfiliado && pData.tipoAfiliado !== 'AFILIADO DIRECTO') {
                                 updates.tipoAfiliado = pData.tipoAfiliado; needsUpdate = true;
                            }

                            if (needsUpdate) { 
                                await onUpdatePatient(existingPatient.id, updates); 
                                patientCache.clearPatientCache(existingPatient.id);
                                updated++; 
                            } else { skipped++; }
                        } else {
                            const result = await onAddPatient(pData);
                            patientCache.clearPatientCache();
                            added++;
                        }
                    }
                    
                    await loadPatients();
                    
                    alert(`Resumen de Carga:\n\n‚úÖ Pacientes Agregados: ${added}\nüîÑ Pacientes Modificados: ${updated}\n‚è≠Ô∏è Pacientes Omitidos: ${skipped}`);
                };
                reader.readAsBinaryString(file);
                e.target.value = null; 
            };

            const handlePatientSubmit = async (e) => { 
                e.preventDefault(); 
                try {
                    if (editingPatientId) {
                        await onUpdatePatient(editingPatientId, patientForm); 
                        patientCache.clearPatientCache(editingPatientId);
                    } else {
                        await onAddPatient(patientForm);
                        patientCache.clearPatientCache();
                    }
                    await loadPatients();
                    closePatientForm();
                } catch (error) {
                    alert('Error al guardar paciente: ' + error.message);
                }
            };
            
            const closePatientForm = () => { 
                setPatientForm({ 
                    dni: '', 
                    nombre: '', 
                    telefono: '', 
                    direccion: '', 
                    familiar: '', 
                    telefonoFamiliar: '', 
                    descripcionMunicipio: '', 
                    tipoAfiliado: 'AFILIADO DIRECTO',
                    nAfiliacion: '' 
                }); 
                setEditingPatientId(null); 
                setShowPatientForm(false); 
            };
            
            const openEditPatient = async (e, p) => { 
                e.stopPropagation(); 
                try {
                    const cachedPatient = patientCache.getPatient(p.id);
                    if (cachedPatient) {
                        setPatientForm(cachedPatient);
                    } else {
                        if (!firebaseInitialized || !db) {
                            throw new Error("Base de datos no disponible");
                        }
                        const patientDoc = await db.collection('prod_patients').doc(p.id).get();
                        if (patientDoc.exists) {
                            setPatientForm({ id: p.id, ...patientDoc.data() });
                        } else {
                            setPatientForm(p);
                        }
                    }
                } catch (error) {
                    console.error("Error cargando paciente:", error);
                    setPatientForm(p);
                }
                setEditingPatientId(p.id); 
                setShowPatientForm(true); 
            };

            const handleKitSubmit = async (e) => {
                e.preventDefault();
                if (isViewMode) { closeKitForm(); return; } 
                
                try {
                    const finalData = { 
                        ...kitData, 
                        digitador: currentUser.name, 
                        dni: selectedPatient.dni, 
                        nombre: selectedPatient.nombre,
                        patientId: selectedPatient.id
                    }; 
                    
                    if (!editingKitId && !finalData.horaOperaciones) {
                        finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
                    }
                    
                    const kitId = await onSaveKit(editingKitId, finalData, selectedPatient.id, !!editingKitId);
                    
                    patientCache.clearPatientCache(selectedPatient.id);
                    patientCache.clearCache(patientCache.KITS_CACHE_KEY);
                    
                    if (editingKitId) {
                        ['ventanilla', 'ruta', 'refri'].forEach(mode => {
                            localStorage.removeItem(`vineta_${editingKitId}_${mode}`);
                        });
                    }
                    
                    await loadKits();
                    closeKitForm();
                } catch (error) {
                    alert('Error al guardar kit: ' + error.message);
                }
            };
            
            const closeKitForm = () => { 
                setKitData({ 
                    fechaArmado: new Date().toISOString().split('T')[0], 
                    fechaEntregaLogistica: '', 
                    fechaEntregaKit: '', 
                    horaOperaciones: '', 
                    contactCenter: '', 
                    triggerMeds: '', 
                    medicamentos: [],
                    digitador: '',
                    deliveryMode: '', 
                    selectedPhones: [], 
                    otherPhoneEnabled: false, 
                    otherPhone: '',
                    addressConfirmed: true, 
                    secondaryAddress: '',
                    gpsStatus: 'SIN GPS', 
                    observationsEnabled: false,
                    observations: '',
                    isRefrigerated: false, 
                    cantRefriGlobal: '' 
                }); 
                setEditingKitId(null); 
                setShowKitForm(false); 
                setIsViewMode(false); 
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };
            
            const openNewKit = () => {
                setKitData({ 
                    fechaArmado: new Date().toISOString().split('T')[0], 
                    fechaEntregaLogistica: '', 
                    fechaEntregaKit: '', 
                    horaOperaciones: '', 
                    contactCenter: '', 
                    triggerMeds: '', 
                    medicamentos: [],
                    digitador: currentUser.name,
                    deliveryMode: '', 
                    selectedPhones: [], 
                    otherPhoneEnabled: false, 
                    otherPhone: '',
                    addressConfirmed: true, 
                    secondaryAddress: '',
                    gpsStatus: 'SIN GPS', 
                    observationsEnabled: false,
                    observations: '',
                    isRefrigerated: false, 
                    cantRefriGlobal: '' 
                });
                setIsViewMode(false);
                setShowKitForm(true);
            };
            
            const openEditKit = (k, viewOnly = false) => { 
                setKitData({...k, otherPhoneEnabled: !!k.otherPhone}); 
                setEditingKitId(k.id); 
                setIsViewMode(viewOnly);
                setShowKitForm(true); 
            };

            const handleMedChange = (idx, field, val) => {
                const newMeds = [...kitData.medicamentos];
                newMeds[idx] = { ...newMeds[idx], [field]: val };
                setKitData({...kitData, medicamentos: newMeds});
            };
            
            const handleTriggerMeds = (val) => {
                const parsed = parseInt(val, 10);
                const count = isNaN(parsed) ? 0 : parsed;
                const safeCount = Math.min(Math.max(count, 0), 30);
                const currentMeds = kitData.medicamentos || [];
                let newMeds = [];
                if (safeCount > currentMeds.length) {
                    newMeds = [...currentMeds, ...Array(safeCount - currentMeds.length).fill({ nombre: '', idReceta: '', cantidad: '', cantRefri: '' })];
                } else {
                    newMeds = currentMeds.slice(0, safeCount);
                }
                setKitData({...kitData, triggerMeds: val, medicamentos: newMeds});
            };

            const togglePhoneSelection = (phone) => {
                const current = kitData.selectedPhones || [];
                if(current.includes(phone)) {
                    setKitData({...kitData, selectedPhones: current.filter(p => p !== phone)});
                } else {
                    setKitData({...kitData, selectedPhones: [...current, phone]});
                }
            };

            const handleBackToList = () => {
                setSelectedPatient(null);
                setSelectedPatientFullData(null);
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };


            // Funci√≥n para imprimir vi√±eta
            const handlePrintVineta = (kit) => {
                // Actualizar kitData con los valores del kit actual para que los botones se habiliten correctamente
                // Si kit ya tiene deliveryMode e isRefrigerated, usarlos; si no, usar los valores de kitData actual
                const updatedKitData = {
                    ...kitData,
                    deliveryMode: kit.deliveryMode || kitData.deliveryMode || '',
                    isRefrigerated: kit.isRefrigerated !== undefined ? kit.isRefrigerated : (kitData.isRefrigerated || false),
                    cantRefriGlobal: kit.cantRefriGlobal || kitData.cantRefriGlobal || '',
                    cantRefrigerados: (kit.isRefrigerated || kitData.isRefrigerated) ? (kit.cantRefriGlobal || kitData.cantRefriGlobal || 1) : 0
                };
                
                setKitData(updatedKitData);
                
                // Filtrar plantillas seg√∫n el tipo de kit
                let availableTemplates = printTemplates;
                
                const deliveryMode = kit.deliveryMode || kitData.deliveryMode;
                const isRefrigerated = kit.isRefrigerated !== undefined ? kit.isRefrigerated : (kitData.isRefrigerated || false);
                
                if (deliveryMode === 'ruta') {
                    availableTemplates = printTemplates.filter(t => t.type === 'ruta');
                } else if (deliveryMode === 'ventanilla') {
                    availableTemplates = printTemplates.filter(t => t.type === 'ventanilla');
                }
                
                if (isRefrigerated) {
                    availableTemplates = printTemplates.filter(t => t.type === 'refrigerado');
                }
                
                setSelectedPrintTemplate(availableTemplates[0] || null);
                setShowPrintModal(true);
            };

            // Funci√≥n para generar contenido de impresi√≥n (con may√∫sculas y bindings correctos)
            const generatePrintContent = (kit, template) => {
                if (!template) return '';
                
                // Preparar datos en may√∫sculas
                const data = {
                    derechohabienteNombre: (kit.nombre || selectedPatientFullData?.nombre || '').toUpperCase(),
                    derechohabienteId: (kit.dni || selectedPatientFullData?.dni || '').toUpperCase(),
                    telefonoPrincipal: (selectedPatientFullData?.telefono || '').toUpperCase(),
                    telefonoRef: (selectedPatientFullData?.telefonoRef || '').toUpperCase(),
                    gpsStatus: (kit.gpsStatus || 'SIN GPS').toUpperCase(), // Literal: GPS, SIN GPS, GPS PENDIENTE
                    numMedicamentos: kit.medicamentos?.length || 0,
                    direccion: (selectedPatientFullData?.direccion || '').toUpperCase(),
                    observacionesEntrega: (kit.observations || kit.observacionesEntrega || '').toUpperCase(),
                    observacionesVentanilla: (kit.observacionesVentanilla || kit.observations || '').toUpperCase(),
                    fechaEntrega: (kit.fechaArmado || '').toUpperCase(),
                    refrigerado: kit.isRefrigerated ? 'S√ç' : 'NO',
                    cantRefrigerados: kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    contactoTexto: (kit.contactCenter || '').toUpperCase(),
                    digitador: (kit.digitador || '').toUpperCase(),
                    extraRutaTitulo: 'EXTRA RUTA',
                    extraRutaContenido: ''
                };
                
                // Reemplazar campos en los elementos
                const elementsWithData = template.elements.map(element => {
                    let content = element.content || '';
                    
                    // Reemplazar campos din√°micos
                    if (element.isField) {
                        switch(element.fieldId) {
                            case 'nombre':
                                content = data.derechohabienteNombre;
                                break;
                            case 'dni':
                                content = data.derechohabienteId;
                                break;
                            case 'direccion':
                                content = data.direccion;
                                break;
                            case 'telefono':
                                content = data.telefonoPrincipal;
                                break;
                            case 'telefonoRef':
                                content = data.telefonoRef;
                                break;
                            case 'fechaArmado':
                                content = data.fechaEntrega;
                                break;
                            case 'digitador':
                                content = data.digitador;
                                break;
                            case 'contactCenter':
                                content = data.contactoTexto;
                                break;
                            case 'gpsStatus':
                                content = data.gpsStatus; // Literal: GPS, SIN GPS, GPS PENDIENTE
                                break;
                            case 'cantMedicamentos':
                                content = data.numMedicamentos;
                                break;
                            case 'cantRefrigerados':
                                content = data.cantRefrigerados;
                                break;
                            case 'observaciones':
                                // Si es RUTA: observacionesEntrega, si es VENTANILLA: observacionesVentanilla
                                if (template.type === 'ruta') {
                                    content = data.observacionesEntrega;
                                } else if (template.type === 'ventanilla') {
                                    content = data.observacionesVentanilla;
                                } else {
                                    content = data.observacionesEntrega;
                                }
                                break;
                            case 'direccion':
                                // Solo mostrar direcci√≥n si es RUTA
                                if (template.type === 'ruta') {
                                    content = data.direccion;
                                } else {
                                    content = '';
                                }
                                break;
                            default:
                                content = element.content || '';
                        }
                    }
                    
                    // Aplicar may√∫sculas a todo el contenido
                    if (typeof content === 'string') {
                        content = content.toUpperCase();
                    }
                    
                    return {
                        ...element,
                        content: content.toString()
                    };
                });
                
                // Generar HTML para impresi√≥n (71mm x 210mm horizontal, m√°rgenes laterales 0.1cm)
                return `
                    <div class="print-area print-horizontal relative" style="
                        width: 210mm; 
                        height: 71mm; 
                        margin-left: 0.1cm; 
                        margin-right: 0.1cm;
                        font-family: Arial, sans-serif;
                        text-transform: uppercase;
                        position: relative;
                    ">
                        ${elementsWithData.map(element => {
                            // Ajustar tama√±o de fuente para legibilidad (campo grande)
                            let fontSize = element.fontSize || 12;
                            if (element.fieldId === 'direccion' || element.fieldId === 'observaciones') {
                                // Auto-ajustar entre 10px y 18px seg√∫n el tama√±o del contenedor
                                const containerHeight = element.height || 30;
                                fontSize = Math.max(10, Math.min(18, containerHeight * 0.4));
                            }
                            
                            return `
                            <div style="
                                position: absolute;
                                left: ${element.x}px;
                                top: ${element.y}px;
                                width: ${element.width || 'auto'}px;
                                height: ${element.height || 'auto'}px;
                                font-size: ${fontSize}px;
                                color: ${element.color || '#000000'};
                                font-family: ${element.fontFamily || 'Arial'};
                                font-weight: ${element.bold ? 'bold' : 'normal'};
                                font-style: ${element.italic ? 'italic' : 'normal'};
                                background-color: ${element.type === 'rectangle' ? element.color : 'transparent'};
                                border: ${element.type === 'line' ? `2px solid ${element.color}` : 
                                       element.type === 'rectangle' ? `${element.borderWidth || 1}px solid ${element.borderColor || '#000000'}` : 'none'};
                                display: flex;
                                align-items: center;
                                justify-content: ${element.align || 'left'};
                                text-transform: uppercase;
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                                white-space: pre-wrap;
                                overflow: hidden;
                            ">
                                ${element.type === 'text' ? element.content : ''}
                                ${element.type === 'barcode' ? `<div style="background: white; padding: 5px; text-align: center; width: 100%;">[C√ìDIGO DE BARRAS]<br/><small>${element.content}</small></div>` : ''}
                                ${element.type === 'qrcode' ? `<div style="background: white; padding: 5px; text-align: center; width: 100%;">[QR CODE]<br/><small>${element.content}</small></div>` : ''}
                                ${element.type === 'image' && element.url ? `<img src="${element.url}" alt="${element.alt}" style="max-width: 100%; max-height: 100%;">` : ''}
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            };

            // Funci√≥n helper para escapar HTML
            const escapeHtml = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            // Funci√≥n helper para auto-ajustar texto
            const autoFitText = (element, maxPx = 18, minPx = 8) => {
                if (!element) return;
                const container = element;
                const text = container.textContent || '';
                if (!text.trim()) return;
                
                let fontSize = maxPx;
                container.style.fontSize = fontSize + 'px';
                
                while (container.scrollHeight > container.clientHeight && fontSize > minPx) {
                    fontSize -= 0.5;
                    container.style.fontSize = fontSize + 'px';
                }
            };

            // Helper para construir ventana de impresi√≥n
            const buildPrintWindow = (html, css, title = 'Imprimir Vi√±eta', onAfterPrintClose = true) => {
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('No se pudo abrir la ventana de impresi√≥n. Por favor, permite ventanas emergentes.');
                    return null;
                }
                
                const fullHtml = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${escapeHtml(title)}</title>
    <style>${css}</style>
</head>
<body>
    ${html}
    <script>
        (function() {
            try {
                if (window.opener && window.opener !== window && window.opener.location) {
                    window.addEventListener("load", function() {
                        setTimeout(function() { 
                            window.print(); 
                        }, 500);
                        ${onAfterPrintClose ? `setTimeout(function() { window.close(); }, 2000);` : ''}
                    });
                }
            } catch(e) { 
                console.log("Print error:", e); 
            }
        })();
    <\/script>
</body>
</html>`;
                
                printWindow.document.open();
                printWindow.document.write(fullHtml);
                printWindow.document.close();
                
                if (printWindow && !printWindow.closed) {
                    printWindow.focus();
                }
                
                return printWindow;
            };

            // CSS base para impresi√≥n de vi√±etas
            const getPrintVignetteCSS = () => `
                @page { 
                    size: 210mm 71mm; 
                    margin: 0; 
                }
                * { 
                    margin: 0; 
                    padding: 0; 
                    box-sizing: border-box; 
                }
                html, body { 
                    width: 210mm; 
                    height: 71mm; 
                    margin: 0; 
                    padding: 0; 
                    font-family: Arial, sans-serif;
                    text-transform: uppercase;
                }
                .sheet { 
                    box-sizing: border-box; 
                    width: 210mm; 
                    height: 71mm; 
                    padding: 1mm 0.5mm; 
                    overflow: hidden;
                    background: white;
                    position: relative;
                }
                .header { 
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between; 
                    margin-bottom: 1mm; 
                    padding-bottom: 0.5mm;
                    border-bottom: 0.3mm solid #000;
                }
                .header-title { 
                    font-size: 3.5mm; 
                    font-weight: bold; 
                    text-align: center; 
                    flex: 1;
                }
                .logo-placeholder { 
                    width: 15mm; 
                    height: 8mm; 
                    border: 0.2mm dashed #999; 
                    font-size: 2mm; 
                    color: #999; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                }
                .banner { 
                    background: #000; 
                    color: #fff; 
                    padding: 1mm 0; 
                    text-align: center; 
                    font-weight: bold; 
                    font-size: 4mm; 
                    margin: 1mm 0;
                }
                .section { 
                    border: 0.5mm solid #000; 
                    border-radius: 1mm; 
                    padding: 1mm; 
                    margin: 0.5mm 0;
                }
                .section-title { 
                    font-size: 2.5mm; 
                    font-weight: bold; 
                    margin-bottom: 0.5mm;
                    border-bottom: 0.2mm solid #000;
                    padding-bottom: 0.3mm;
                }
                .field-row { 
                    display: flex; 
                    gap: 1mm; 
                    margin: 0.3mm 0;
                }
                .field-label { 
                    font-size: 2mm; 
                    font-weight: bold; 
                    min-width: 20mm;
                }
                .field-value { 
                    font-size: 2.5mm; 
                    flex: 1;
                }
                .field-value-large { 
                    font-size: 4mm; 
                    font-weight: bold;
                }
                .field-value-extra-large { 
                    font-size: 6mm; 
                    font-weight: bold;
                }
                .dashed-box { 
                    border: 0.5mm dashed #000; 
                    border-radius: 1mm; 
                    padding: 2mm; 
                    text-align: center; 
                    font-size: 8mm; 
                    font-weight: bold;
                    margin: 1mm 0;
                }
                .gps-status { 
                    border: 0.5mm solid #000; 
                    border-radius: 1mm; 
                    padding: 0.5mm 1mm; 
                    font-size: 2.5mm; 
                    font-weight: bold;
                    display: inline-block;
                }
                .refrigerado-box { 
                    border: 0.5mm dashed #000; 
                    border-radius: 1mm; 
                    padding: 0.5mm 1mm; 
                    margin-top: 1mm;
                    font-size: 2.5mm;
                }
                .footer { 
                    margin-top: 0.5mm; 
                    font-size: 1.8mm; 
                    text-align: right; 
                    color: #666;
                }
                @media print { 
                    body * { visibility: hidden; } 
                    .sheet, .sheet * { visibility: visible; } 
                    .sheet { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                    } 
                }
            `;

            // Funci√≥n para imprimir vi√±eta RUTA
            const printRutaVignette = (kit, patient) => {
                const patientData = patient || selectedPatientFullData || {};
                const operatorName = currentUser?.name || currentUser?.email || auth?.currentUser?.email || 'OPERADOR';
                const printedAt = new Date().toLocaleString('es-ES', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const data = {
                    nombre: (kit.nombre || patientData.nombre || '').toUpperCase(),
                    dni: (kit.dni || patientData.dni || '').toUpperCase(),
                    fechaEntrega: kit.fechaArmado || '',
                    telefonoPrincipal: (patientData.telefono || '').toUpperCase(),
                    telefonoRef: (patientData.telefonoFamiliar || '').toUpperCase(),
                    medicamentos: `${kit.medicamentos?.length || 0}`,
                    contactCenter: (kit.contactCenter || '').toUpperCase(),
                    direccion: (patientData.direccion || patientData.secondaryAddress || kit.secondaryAddress || '').toUpperCase(),
                    observaciones: (kit.observations || '').toUpperCase(),
                    gpsStatus: (kit.gpsStatus || 'SIN GPS').toUpperCase(),
                    refrigerado: kit.isRefrigerated || false,
                    cantRefrigerados: kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    operatorName: operatorName.toUpperCase(),
                    printedAt: printedAt.toUpperCase()
                };
                
                const html = `
                    <div class="sheet">
                        <div class="header">
                            <div class="logo-placeholder">LOGO 1</div>
                            <div class="header-title">DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO</div>
                            <div class="logo-placeholder">LOGO 2</div>
                        </div>
                        <div class="banner">ENTREGA EN RUTA</div>
                        
                        <div class="section">
                            <div class="section-title">INFORMACI√ìN DE DERECHOHABIENTE</div>
                            <div class="field-row">
                                <div class="field-label">NOMBRE:</div>
                                <div class="field-value-extra-large">${escapeHtml(data.nombre) || '‚Äî'}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">DNI/AFILIACI√ìN:</div>
                                <div class="field-value-large">${escapeHtml(data.dni) || '‚Äî'}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">FECHA ENTREGA:</div>
                                <div class="field-value">${escapeHtml(data.fechaEntrega) || '‚Äî'}</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">CONTACTO Y SEGUIMIENTO</div>
                            <div class="field-row">
                                <div class="field-label">TEL√âFONOS:</div>
                                <div class="field-value">${escapeHtml(data.telefonoPrincipal || '')} ${data.telefonoRef ? '/ ' + escapeHtml(data.telefonoRef) : ''}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">MEDICAMENTOS:</div>
                                <div class="field-value">${data.medicamentos}</div>
                            </div>
                            ${data.contactCenter ? `
                            <div class="field-row">
                                <div class="field-label">CONTACT CENTER:</div>
                                <div class="field-value">${escapeHtml(data.contactCenter)}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="section">
                            <div class="section-title">DIRECCI√ìN DE ENTREGA</div>
                            <div class="field-value" style="font-size: 3mm; min-height: 8mm; word-wrap: break-word;">${escapeHtml(data.direccion) || '‚Äî'}</div>
                            ${data.observaciones ? `
                            <div style="margin-top: 0.5mm; font-size: 2.5mm; font-weight: bold;">OBSERVACIONES:</div>
                            <div class="field-value" style="font-size: 2.5mm; min-height: 4mm; word-wrap: break-word;">${escapeHtml(data.observaciones)}</div>
                            ` : ''}
                        </div>
                        
                        <div style="margin: 0.5mm 0;">
                            <span class="field-label">ESTADO GPS:</span>
                            <span class="gps-status">${escapeHtml(data.gpsStatus)}</span>
                        </div>
                        
                        ${data.refrigerado ? `
                        <div class="refrigerado-box">
                            <strong>CONTIENE REFRIGERADO</strong> - CANTIDAD: ${data.cantRefrigerados}
                        </div>
                        ` : ''}
                        
                        <div class="footer">OP: ${escapeHtml(data.operatorName)} | ${escapeHtml(data.printedAt)}</div>
                    </div>
                `;
                
                buildPrintWindow(html, getPrintVignetteCSS(), 'Imprimir Vi√±eta Ruta');
            };

            // Funci√≥n para imprimir vi√±eta VENTANILLA
            const printVentanillaVignette = (kit, patient) => {
                const patientData = patient || selectedPatientFullData || {};
                const operatorName = currentUser?.name || currentUser?.email || auth?.currentUser?.email || 'OPERADOR';
                const printedAt = new Date().toLocaleString('es-ES', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const data = {
                    nombre: (kit.nombre || patientData.nombre || '').toUpperCase(),
                    dni: (kit.dni || patientData.dni || '').toUpperCase(),
                    fechaEntrega: kit.fechaArmado || '',
                    telefonoPrincipal: (patientData.telefono || '').toUpperCase(),
                    telefonoRef: (patientData.telefonoFamiliar || '').toUpperCase(),
                    medicamentos: `${kit.medicamentos?.length || 0}`,
                    contactCenter: (kit.contactCenter || '').toUpperCase(),
                    observaciones: (kit.observations || '').toUpperCase(),
                    refrigerado: kit.isRefrigerated || false,
                    cantRefrigerados: kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    operatorName: operatorName.toUpperCase(),
                    printedAt: printedAt.toUpperCase()
                };
                
                const html = `
                    <div class="sheet">
                        <div class="header">
                            <div class="logo-placeholder">LOGO 1</div>
                            <div class="header-title">DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO</div>
                            <div class="logo-placeholder">LOGO 2</div>
                        </div>
                        <div class="banner">ENTREGA VENTANILLA</div>
                        
                        <div class="section">
                            <div class="section-title">INFORMACI√ìN DE DERECHOHABIENTE</div>
                            <div class="field-row">
                                <div class="field-label">NOMBRE:</div>
                                <div class="field-value-extra-large">${escapeHtml(data.nombre) || '‚Äî'}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">DNI/AFILIACI√ìN:</div>
                                <div class="field-value-large">${escapeHtml(data.dni) || '‚Äî'}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">FECHA ENTREGA:</div>
                                <div class="field-value">${escapeHtml(data.fechaEntrega) || '‚Äî'}</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">CONTACTO Y SEGUIMIENTO</div>
                            <div class="field-row">
                                <div class="field-label">TEL√âFONOS:</div>
                                <div class="field-value">${escapeHtml(data.telefonoPrincipal || '')} ${data.telefonoRef ? '/ ' + escapeHtml(data.telefonoRef) : ''}</div>
                            </div>
                            <div class="field-row">
                                <div class="field-label">MEDICAMENTOS:</div>
                                <div class="field-value">${data.medicamentos}</div>
                            </div>
                            ${data.contactCenter ? `
                            <div class="field-row">
                                <div class="field-label">CONTACT CENTER:</div>
                                <div class="field-value">${escapeHtml(data.contactCenter)}</div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="dashed-box">VENTANILLA</div>
                        
                        ${data.observaciones ? `
                        <div class="section" style="margin-top: 0.5mm;">
                            <div class="section-title">OBSERVACIONES</div>
                            <div class="field-value" style="font-size: 2.5mm; min-height: 4mm; word-wrap: break-word;">${escapeHtml(data.observaciones)}</div>
                        </div>
                        ` : ''}
                        
                        ${data.refrigerado ? `
                        <div class="refrigerado-box">
                            <strong>CONTIENE REFRIGERADO</strong> - CANTIDAD: ${data.cantRefrigerados}
                        </div>
                        ` : ''}
                        
                        <div class="footer">OP: ${escapeHtml(data.operatorName)} | ${escapeHtml(data.printedAt)}</div>
                    </div>
                `;
                
                buildPrintWindow(html, getPrintVignetteCSS(), 'Imprimir Vi√±eta Ventanilla');
            };

            // Funci√≥n para imprimir vi√±eta REFRIGERADO
            const printRefrigeradoVignette = (kit, patient) => {
                const patientData = patient || selectedPatientFullData || {};
                const operatorName = currentUser?.name || currentUser?.email || auth?.currentUser?.email || 'OPERADOR';
                const printedAt = new Date().toLocaleString('es-ES', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const data = {
                    nombre: (kit.nombre || patientData.nombre || '').toUpperCase(),
                    dni: (kit.dni || patientData.dni || '').toUpperCase(),
                    fechaEntrega: kit.fechaArmado || '',
                    cantRefrigerados: kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    operatorName: operatorName.toUpperCase(),
                    printedAt: printedAt.toUpperCase()
                };
                
                const html = `
                    <div class="sheet">
                        <div class="header">
                            <div class="logo-placeholder">LOGO 1</div>
                            <div class="header-title">DEPARTAMENTO DE DISPENSACI√ìN DE MEDICAMENTOS A DOMICILIO</div>
                            <div class="logo-placeholder">LOGO 2</div>
                        </div>
                        <div class="banner" style="font-size: 5mm; padding: 1.5mm 0;">PRODUCTO REFRIGERADO</div>
                        
                        <div style="display: flex; gap: 2mm; margin-top: 1mm;">
                            <div style="flex: 1;">
                                <div class="field-row">
                                    <div class="field-label">NOMBRE:</div>
                                    <div class="field-value-large">${escapeHtml(data.nombre) || '‚Äî'}</div>
                                </div>
                                <div class="field-row" style="margin-top: 1mm;">
                                    <div class="field-label">ID:</div>
                                    <div class="field-value-large">${escapeHtml(data.dni) || '‚Äî'}</div>
                                </div>
                                <div class="field-row" style="margin-top: 1mm;">
                                    <div class="field-label">FECHA:</div>
                                    <div class="field-value">${escapeHtml(data.fechaEntrega) || '‚Äî'}</div>
                                </div>
                            </div>
                            <div style="width: 35mm; border: 0.8mm solid #000; border-radius: 2mm; display: flex; align-items: center; justify-content: center; font-size: 12mm; font-weight: bold;">
                                ${data.cantRefrigerados}
                            </div>
                        </div>
                        
                        <div class="footer" style="margin-top: 1mm;">OP: ${escapeHtml(data.operatorName)} | ${escapeHtml(data.printedAt)}</div>
                    </div>
                `;
                
                buildPrintWindow(html, getPrintVignetteCSS(), 'Imprimir Vi√±eta Refrigerado');
            };

            // Funci√≥n para imprimir (mantener compatibilidad)
            const handlePrint = (kit, templateOverride = null) => {
                const template = templateOverride || selectedPrintTemplate;
                if (!template) {
                    alert('No hay plantilla seleccionada');
                    return;
                }
                
                const printContent = generatePrintContent(kit, template);
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('No se pudo abrir la ventana de impresi√≥n');
                    return;
                }
                
                const kitNombre = escapeHtml(kit.nombre || 'Vi√±eta');
                
                // Template literal √∫nico y seguro - NO escapar printContent porque ya es HTML v√°lido
                const printHtml = `<!DOCTYPE html>
<html>
<head>
    <title>Imprimir Vi√±eta - ${kitNombre}</title>
    <style>
        @page { size: 210mm 71mm; margin-left: 0.1cm; margin-right: 0.1cm; }
        body { margin: 0; padding: 0; }
        @media print { 
            body * { visibility: hidden; } 
            .print-area, .print-area * { visibility: visible; } 
            .print-area { position: absolute; left: 0; top: 0; padding: 0; margin-left: 0.1cm; margin-right: 0.1cm; } 
        }
        .print-horizontal { width: 210mm; height: 71mm; }
        * { text-transform: uppercase; }
    </style>
</head>
<body>
    ${printContent}
    <script>
        (function() {
            try {
                if (window.opener && window.opener !== window && window.opener.location) {
                    window.addEventListener("load", function() {
                        setTimeout(function() { window.print(); }, 500);
                        setTimeout(function() { window.close(); }, 2000);
                    });
                }
            } catch(e) { 
                console.log("Print error:", e); 
            }
        })();
    <\/script>
</body>
</html>`;
                
                printWindow.document.open();
                printWindow.document.write(printHtml);
                printWindow.document.close();
                
                if (printWindow && !printWindow.closed) {
                    printWindow.focus();
                }
            };

            if (loadingPatients) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                        <div className="flex-1 flex items-center justify-center">
                            <div className="text-center">
                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-turquoise-600 mb-4"></div>
                                <h3 className="text-lg font-bold text-slate-700 mb-2">Cargando pacientes...</h3>
                                <p className="text-sm text-slate-500 mb-4">Optimizando datos para mejor rendimiento</p>
                                <div className="w-64 bg-slate-200 rounded-full h-2 mx-auto">
                                    <div 
                                        className="bg-turquoise-600 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${loadingProgress}%` }}
                                    ></div>
                                </div>
                                <p className="text-xs text-slate-400 mt-2">{loadingProgress}% completado</p>
                            </div>
                        </div>
                    </div>
                );
            }


            if (selectedPatient) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft h-full flex flex-col animate-in border-0 bg-white">
                        
                        <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                        
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={handleBackToList} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect">
                                    <Icons.ArrowLeft size={20} />
                                </button>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 brand-font leading-none">{selectedPatient.nombre}</h3>
                                    <p className="text-[10px] text-slate-400 font-mono mt-0.5">DNI: {selectedPatient.dni}</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={openNewKit} className="flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect bg-turquoise-600 hover:bg-turquoise-700 text-white">
                                    <Icons.FolderPlus size={16}/> Nuevo Kit
                                </button>
                            </div>
                        </div>

                        {/* Modal para imprimir */}
                        <Modal isOpen={showPrintModal} onClose={() => setShowPrintModal(false)} title="Imprimir Vi√±eta" maxWidth="max-w-md">
                            <div className="space-y-4">
                                {!kitData.deliveryMode && (
                                    <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs text-yellow-800">
                                        Seleccione modo de env√≠o en el Kit (Ruta o Ventanilla)
                                    </div>
                                )}
                                
                                {/* Bot√≥n para cargar plantillas predeterminadas si no existen */}
                                {(printTemplates.length === 0 || !printTemplates.find(t => t.id === 'plantilla_ruta')) && (
                                    <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <p className="text-xs text-blue-800 mb-2">No se encontraron plantillas. Cargue las plantillas predeterminadas:</p>
                                        <button
                                            onClick={loadPredeterminedTemplatesFromPatientBlock}
                                            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-xs flex items-center justify-center gap-2"
                                        >
                                            <Icons.FolderPlus size={16}/> Cargar Plantillas Predeterminadas
                                        </button>
                                    </div>
                                )}
                                
                                <div className="space-y-2">
                                    <button
                                        onClick={() => {
                                            printRutaVignette(kitData, selectedPatientFullData);
                                        }}
                                        disabled={kitData.deliveryMode !== 'ruta'}
                                        className="w-full px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir Ruta
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            printVentanillaVignette(kitData, selectedPatientFullData);
                                        }}
                                        disabled={kitData.deliveryMode !== 'ventanilla'}
                                        className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir Ventanilla
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            printRefrigeradoVignette(kitData, selectedPatientFullData);
                                        }}
                                        disabled={!kitData.isRefrigerated && !(kitData.cantRefriGlobal && parseInt(kitData.cantRefriGlobal) > 0)}
                                        className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir Refrigerados
                                    </button>
                                </div>
                                
                                <div className="flex justify-end gap-3 pt-4 border-t border-slate-200">
                                    <button
                                        onClick={() => setShowPrintModal(false)}
                                        className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
                                    >
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </Modal>

                        <Modal isOpen={showKitForm} onClose={closeKitForm} title={isViewMode ? "Detalle del Kit" : (editingKitId ? "Editar Kit" : "Nuevo Kit de Producci√≥n")} maxWidth="max-w-4xl">
                            <form onSubmit={handleKitSubmit} className="space-y-6">
                                <fieldset disabled={isViewMode} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b border-slate-100 pb-4 bg-slate-50 p-4 rounded-xl">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI del Paciente</label>
                                            <input type="text" value={selectedPatient.dni} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Paciente</label>
                                            <input type="text" value={selectedPatient.nombre} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                    </div>

                                    <div className="flex gap-4 justify-center pb-4 border-b border-slate-100">
                                        <button type="button" onClick={()=>setKitData({...kitData, deliveryMode: 'ventanilla'})} className={`px-6 py-2 rounded-lg font-bold transition-all ${kitData.deliveryMode === 'ventanilla' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>Ventanilla</button>
                                        <button type="button" onClick={()=>setKitData({...kitData, deliveryMode: 'ruta'})} className={`px-6 py-2 rounded-lg font-bold transition-all ${kitData.deliveryMode === 'ruta' ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>Ruta</button>
                                    </div>

                                    <div className={`transition-all duration-300 ${kitData.deliveryMode === 'ventanilla' ? 'opacity-40 pointer-events-none grayscale' : ''}`}>
                                        <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Confirmar Datos de Contacto</h5>
                                            <div className="space-y-2 mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block">Seleccionar Tel√©fonos a Llamar:</label>
                                                {selectedPatientFullData?.telefono && (
                                                    <label className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200 cursor-pointer">
                                                        <input type="checkbox" checked={kitData.selectedPhones?.includes(selectedPatientFullData.telefono)} onChange={()=>togglePhoneSelection(selectedPatientFullData.telefono)} />
                                                        <span className="text-sm">{selectedPatientFullData.telefono} (Personal)</span>
                                                    </label>
                                                )}
                                                {selectedPatientFullData?.telefonoFamiliar && (
                                                    <label className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200 cursor-pointer">
                                                        <input type="checkbox" checked={kitData.selectedPhones?.includes(selectedPatientFullData.telefonoFamiliar)} onChange={()=>togglePhoneSelection(selectedPatientFullData.telefonoFamiliar)} />
                                                        <span className="text-sm">{selectedPatientFullData.telefonoFamiliar} (Familiar)</span>
                                                    </label>
                                                )}
                                                <div className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200">
                                                    <input type="checkbox" checked={kitData.otherPhoneEnabled} onChange={(e) => setKitData({...kitData, otherPhoneEnabled: e.target.checked, otherPhone: e.target.checked ? kitData.otherPhone : ''})} />
                                                    <span className="text-sm whitespace-nowrap">Otro:</span>
                                                    <input type="text" className={`w-full p-1 border-b border-slate-300 outline-none text-sm ${!kitData.otherPhoneEnabled ? 'bg-slate-50 text-slate-400 cursor-not-allowed' : ''}`} placeholder="Ingresar otro n√∫mero" value={kitData.otherPhone} onChange={e=>setKitData({...kitData, otherPhone:e.target.value})} disabled={!kitData.otherPhoneEnabled} />
                                                </div>
                                            </div>
                                            <div className="mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Confirmar Ubicaci√≥n (Primaria: {selectedPatientFullData?.direccion || 'No disponible'})</label>
                                                <div className="flex items-center gap-4 mb-2">
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" name="addrConf" checked={kitData.addressConfirmed === true} onChange={()=>setKitData({...kitData, addressConfirmed: true})} /> 
                                                        <span className="text-sm font-bold text-green-600">S√≠, es correcta</span>
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" name="addrConf" checked={kitData.addressConfirmed === false} onChange={()=>setKitData({...kitData, addressConfirmed: false})} /> 
                                                        <span className="text-sm font-bold text-red-500">No, nueva direcci√≥n</span>
                                                    </label>
                                                </div>
                                                {!kitData.addressConfirmed && (
                                                    <div className="animate-in mb-3">
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Direcci√≥n Secundaria (Ruta)</label>
                                                        <textarea className="w-full p-2 border rounded text-sm bg-white" rows="2" value={kitData.secondaryAddress} onChange={e=>setKitData({...kitData, secondaryAddress:e.target.value})} placeholder="Ingrese la nueva direcci√≥n de entrega..."></textarea>
                                                    </div>
                                                )}
                                                
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Estado GPS</label>
                                                    <select className="w-full p-2 border rounded text-sm bg-white font-bold text-slate-700" value={kitData.gpsStatus} onChange={e=>setKitData({...kitData, gpsStatus:e.target.value})}>
                                                        <option value="TIENE GPS">TIENE GPS</option>
                                                        <option value="GPS PENDIENTE">GPS PENDIENTE</option>
                                                        <option value="SIN GPS">SIN GPS</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                                    <input type="checkbox" checked={kitData.observationsEnabled} onChange={e=>setKitData({...kitData, observationsEnabled:e.target.checked})} />
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Agregar Observaciones de Entrega</span>
                                                </label>
                                                {kitData.observationsEnabled && (
                                                    <textarea className="w-full p-2 border rounded text-sm bg-amber-50 border-amber-200" rows="2" value={kitData.observations} onChange={e=>setKitData({...kitData, observations:e.target.value})} placeholder="Ej: Casa de color verde, port√≥n negro..."></textarea>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Log√≠stica</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Armado</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaArmado} onChange={e=>setKitData({...kitData, fechaArmado:e.target.value})} required />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega a Log√≠stica</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntregaLogistica} onChange={e=>setKitData({...kitData, fechaEntregaLogistica:e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega de Kit (Paciente)</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntregaKit} onChange={e=>setKitData({...kitData, fechaEntregaKit:e.target.value})} />
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center</label>
                                                <select className="w-full p-2 border rounded text-sm bg-white" value={kitData.contactCenter} onChange={e=>setKitData({...kitData, contactCenter:e.target.value})}>
                                                    <option value="">Seleccione...</option>
                                                    {contacts && contacts.map(c => (
                                                        <option key={c.id} value={`${c.name} --- ${c.phone}`}>{c.name} --- {c.phone}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Digitador</label>
                                                <input type="text" className="w-full p-2 border rounded text-sm bg-slate-200 text-slate-500" value={currentUser.name} disabled />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                        <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-1">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Medicamentos</h5>
                                            <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" checked={kitData.isRefrigerated} onChange={e=>setKitData({...kitData, isRefrigerated: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">Refrigerado</span>
                                                </label>
                                                {kitData.isRefrigerated && (
                                                    <input type="number" placeholder="Cant." className="w-16 p-1 border rounded text-center text-xs bg-blue-50 border-blue-200 text-blue-700 font-bold outline-none" value={kitData.cantRefriGlobal} onChange={e=>setKitData({...kitData, cantRefriGlobal: e.target.value})} />
                                                )}
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500">% Medicamentos:</label>
                                                    <input type="text" className="w-20 p-1 border rounded text-center font-bold bg-white" value={kitData.triggerMeds} onChange={e=>handleTriggerMeds(e.target.value)} placeholder="Ej: 6/9" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            {kitData.medicamentos.map((med, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-lg border shadow-sm flex flex-col md:flex-row gap-2 items-end">
                                                    <div className="flex-1 w-full">
                                                        <label className="text-[10px] font-bold text-slate-400 block">Medicamento</label>
                                                        <input list="medsList" className="w-full p-1.5 border rounded text-xs" value={med.nombre} onChange={e => handleMedChange(idx, 'nombre', e.target.value)} placeholder="Buscar..." />
                                                    </div>
                                                    <div className="w-24">
                                                        <label className="text-[10px] font-bold text-slate-400 block">ID Receta</label>
                                                        <input type="text" className="w-full p-1.5 border rounded text-xs" value={med.idReceta} onChange={e => handleMedChange(idx, 'idReceta', e.target.value)} />
                                                    </div>
                                                    <div className="w-20">
                                                        <label className="text-[10px] font-bold text-slate-400 block">Cant.</label>
                                                        <input type="number" className="w-full p-1.5 border rounded text-xs" value={med.cantidad} onChange={e => handleMedChange(idx, 'cantidad', e.target.value)} />
                                                    </div>
                                                </div>
                                            ))}
                                            {kitData.medicamentos.length === 0 && <div className="text-center text-xs text-slate-400 italic py-4">Ingrese cantidad (ej: 6 o 6/9) para agregar l√≠neas.</div>}
                                        </div>
                                    </div>
                                </fieldset>
                                
                                {!isViewMode ? (
                                    <div className="flex gap-3">
                                        <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar Kit</button>
                                        {editingKitId && (
                                            <button 
                                                type="button"
                                                onClick={() => handlePrintVineta(kitData)}
                                                className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-colors btn-hover-effect flex items-center gap-2"
                                            >
                                                <Icons.Printer size={16}/> Imprimir
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    <div className="flex gap-3">
                                        <button type="button" onClick={closeKitForm} className="flex-1 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                        <button 
                                            type="button"
                                            onClick={() => handlePrintVineta(kitData)}
                                            className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-colors btn-hover-effect flex items-center gap-2"
                                        >
                                            <Icons.Printer size={16}/> Imprimir
                                        </button>
                                    </div>
                                )}
                            </form>
                            <datalist id="medsList">
                                {medicines.map((m, i) => <option key={i} value={m.name} />)}
                            </datalist>
                        </Modal>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 p-5 relative z-10">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                                    <h2 className="text-xl font-bold text-slate-800">Historial de Producci√≥n</h2>
                                    <div className="text-2xl font-bold text-turquoise-600">{patientKits.length} <span className="text-sm text-slate-400 font-normal">Kits</span></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span className="text-[10px] font-bold text-slate-400 block">Tipo Afiliado</span>
                                        {selectedPatientFullData?.tipoAfiliado || selectedPatient.tipoAfiliado}
                                    </div>
                                    <div className="md:col-span-3">
                                        <span className="text-[10px] font-bold text-slate-400 block">Domicilio</span>
                                        {selectedPatientFullData?.direccion || 'Cargando...'}
                                    </div>
                                </div>
                                {selectedPatientFullData && (
                                    <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span className="text-[10px] font-bold text-slate-400 block">Tel√©fono</span>
                                            {selectedPatientFullData.telefono || 'No disponible'}
                                        </div>
                                        <div>
                                            <span className="text-[10px] font-bold text-slate-400 block">Tel. Familiar</span>
                                            {selectedPatientFullData.telefonoFamiliar || 'No disponible'}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="grid gap-3">
                                {patientKits.map(kit => (
                                    <div key={kit.id} className="p-4 rounded-xl border border-slate-100 bg-white shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4 relative group">
                                        <div className="flex-1">
                                            <div className="flex flex-wrap items-center gap-2 mb-2">
                                                <span className="bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold border border-turquoise-100">
                                                    <Icons.Calendar size={12} className="inline mr-1"/> {kit.fechaArmado}
                                                </span>
                                                <span className={`px-2 py-1 rounded text-xs font-bold border ${kit.deliveryMode==='ruta'?'bg-emerald-50 text-emerald-700 border-emerald-100':'bg-indigo-50 text-indigo-700 border-indigo-100'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA'}
                                                </span>
                                                <span className="text-xs text-slate-400 font-mono">Hora Ops: {kit.horaOperaciones || '--:--'}</span>
                                                {kit.isRefrigerated && (
                                                    <span className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado
                                                    </span>
                                                )}
                                            </div>
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {kit.medicamentos?.slice(0,4).map((m,i) => (
                                                    <span key={i} className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border">
                                                        {m.nombre} ({m.cantidad})
                                                    </span>
                                                ))}
                                                {(kit.medicamentos?.length > 4) && <span className="text-[10px] text-slate-400 px-1">...</span>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end sm:justify-center items-start">
                                            <button onClick={() => openEditKit(kit, true)} className="text-slate-300 hover:text-blue-500 p-2 btn-hover-effect" title="Ver Detalle">
                                                <Icons.Search size={18}/>
                                            </button>
                                            <button onClick={() => openEditKit(kit, false)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect" title="Editar">
                                                <Icons.Edit size={18}/>
                                            </button>
                                            <button 
                                                onClick={() => handlePrintVineta(kit)}
                                                className="text-slate-300 hover:text-blue-600 p-2 btn-hover-effect"
                                                title="Imprimir Vi√±eta"
                                            >
                                                <Icons.Printer size={18}/>
                                            </button>
                                            {(userRole==='superadmin'||userRole==='admin') && (
                                                <button onClick={() => {if(confirm("¬øEliminar Kit?")) onDeleteKit(kit.id);}} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect">
                                                    <Icons.Trash size={18}/>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                {patientKits.length === 0 && (
                                    <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                                        No hay kits registrados para este paciente.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/50 backdrop-blur-md">
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                                <Icons.Users size={24}/>
                            </div>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Gesti√≥n de Pacientes</h3>
                                <p className="text-xs font-semibold text-turquoise-600">{filteredPatients.length} Registros</p>
                            </div>
                        </div>
                        <div className="flex gap-3 w-full md:w-auto items-center">
                            <div className="relative w-full sm:w-64">
                                <div className="absolute left-3 top-2.5 text-slate-400">
                                    <Icons.Search size={16}/>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar DNI o Nombre..." 
                                    className="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:border-turquoise-200 transition-all focus:shadow-sm" 
                                    value={searchTerm} 
                                    onChange={e=>setSearchTerm(e.target.value)} 
                                />
                            </div>
                            
                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                <div className="relative overflow-hidden">
                                    <button className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                        <Icons.FileSpreadsheet size={16}/> <span className="hidden sm:inline">Cargar DH</span>
                                    </button>
                                    <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                            )}

                            <button onClick={()=>setShowPatientForm(true)} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                <Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo</span>
                            </button>
                        </div>
                    </div>
                    
                    <Modal isOpen={showPatientForm} onClose={closePatientForm} title={editingPatientId ? "Editar Paciente" : "Nuevo Derechohabiente"} maxWidth="max-w-2xl">
                        <form onSubmit={handlePatientSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">DNI <span className="text-red-500">*</span></label>
                                    <input 
                                        type="text" 
                                        required 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.dni} 
                                        onChange={e=>setPatientForm({...patientForm, dni:e.target.value, nAfiliacion:e.target.value})} 
                                        maxLength={15} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">N¬∞ Afiliaci√≥n</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-slate-50" 
                                        value={patientForm.nAfiliacion} 
                                        onChange={e=>setPatientForm({...patientForm, nAfiliacion:e.target.value})} 
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo <span className="text-red-500">*</span></label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                    value={patientForm.nombre} 
                                    onChange={e=>setPatientForm({...patientForm, nombre:e.target.value.toUpperCase()})} 
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tel√©fono</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.telefono} 
                                        onChange={e=>setPatientForm({...patientForm, telefono:e.target.value})} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Municipio</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.descripcionMunicipio} 
                                        onChange={e=>setPatientForm({...patientForm, descripcionMunicipio:e.target.value})} 
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Direcci√≥n</label>
                                <textarea 
                                    rows="2" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm resize-none" 
                                    value={patientForm.direccion} 
                                    onChange={e=>setPatientForm({...patientForm, direccion:e.target.value})}
                                ></textarea>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Familiar</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.familiar} 
                                        onChange={e=>setPatientForm({...patientForm, familiar:e.target.value})} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Tel. Familiar</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.telefonoFamiliar} 
                                        onChange={e=>setPatientForm({...patientForm, telefonoFamiliar:e.target.value})} 
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tipo Afiliaci√≥n</label>
                                <select 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white" 
                                    value={patientForm.tipoAfiliado} 
                                    onChange={e=>setPatientForm({...patientForm, tipoAfiliado:e.target.value})}
                                >
                                    <option value="AFILIADO DIRECTO">AFILIADO DIRECTO</option>
                                    <option value="JUBILADO">JUBILADO</option>
                                    <option value="PENSIONADO">PENSIONADO</option>
                                    <option value="BENEFICIARIO PADRE">BENEFICIARIO PADRE</option>
                                    <option value="BENEFICIARIO COMPA√ëERO(O)">BENEFICIARIO COMPA√ëERO(O)</option>
                                    <option value="BENEFICIARIO ESPOSO(A)">BENEFICIARIO ESPOSO(A)</option>
                                    <option value="BENEFICIARIO HIJO(A)">BENEFICIARIO HIJO(A)</option>
                                </select>
                            </div>

                            <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg mt-2 btn-hover-effect">
                                {editingPatientId ? 'Actualizar' : 'Guardar'}
                            </button>
                        </form>
                    </Modal>

                    <div className="h-full overflow-y-auto bg-white p-6">
                        {filteredPatients.length > patientsPerPage && (
                            <div className="mb-4 flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="text-sm text-slate-600">
                                    Mostrando {indexOfFirstPatient + 1}-{Math.min(indexOfLastPatient, filteredPatients.length)} de {filteredPatients.length} pacientes
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                        disabled={currentPage === 1}
                                        className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                    >
                                        Anterior
                                    </button>
                                    <span className="px-3 py-1 text-sm text-slate-700">
                                        P√°gina {currentPage} de {totalPages}
                                    </span>
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                        disabled={currentPage === totalPages}
                                        className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                    >
                                        Siguiente
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse min-w-[800px]">
                                <thead className="bg-slate-50/80 sticky top-0 z-10">
                                    <tr className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                        <th className="px-6 py-4 pl-8">Paciente</th>
                                        <th className="px-6 py-4">Identificaci√≥n</th>
                                        <th className="px-6 py-4 text-center">N¬∞ Kits</th>
                                        <th className="px-6 py-4 text-right pr-8">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {currentPatients.map(p => {
                                        const countKits = kits.filter(k => k.patientId === p.id).length;
                                        return (
                                            <tr key={p.id} onClick={() => handleSelectPatient(p)} className={`row-hover-effect cursor-pointer`}>
                                                <td className="px-6 py-5 pl-8">
                                                    <div className="font-bold text-base text-slate-800 tracking-tight">{p.nombre}</div>
                                                    <div className="text-xs text-turquoise-600 font-medium mt-1 flex items-center gap-1">
                                                        Ver Detalle <Icons.ChevronsRight size={14}/>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-5">
                                                    <div className="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit mb-1 font-bold">{p.dni}</div>
                                                    <div className="text-xs text-slate-400">{p.tipoAfiliado}</div>
                                                </td>
                                                <td className="px-6 py-5 text-center">
                                                    <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">{countKits}</span>
                                                </td>
                                                <td className="px-6 py-5 text-right pr-8" onClick={(e)=>e.stopPropagation()}>
                                                    <div className="flex justify-end gap-2">
                                                        <button onClick={(e) => openEditPatient(e, p)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect">
                                                            <Icons.Edit size={20}/>
                                                        </button>
                                                        {(userRole==='superadmin'||userRole==='admin') && (
                                                            <button onClick={()=>setConfirmData({ title: 'Eliminar', msg: `¬øEliminar a ${p.nombre}?`, action: () => onDeletePatient(p.id) })} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect">
                                                                <Icons.Trash size={20}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        {filteredPatients.length > patientsPerPage && (
                            <div className="mt-4 flex justify-center">
                                <div className="flex gap-1">
                                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                                        let pageNum;
                                        if (totalPages <= 5) {
                                            pageNum = i + 1;
                                        } else if (currentPage <= 3) {
                                            pageNum = i + 1;
                                        } else if (currentPage >= totalPages - 2) {
                                            pageNum = totalPages - 4 + i;
                                        } else {
                                            pageNum = currentPage - 2 + i;
                                        }
                                        
                                        return (
                                            <button
                                                key={pageNum}
                                                onClick={() => setCurrentPage(pageNum)}
                                                className={`w-8 h-8 rounded-lg text-sm font-medium ${currentPage === pageNum ? 'bg-turquoise-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                            >
                                                {pageNum}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: CONFIGURACION ---
        const ConfigBlock = ({ medicines, onAddList, contacts, onAddContact, onDeleteContact }) => {
            const [rawText, setRawText] = useState('');
            const [newMed, setNewMed] = useState(''); 
            const [cName, setCName] = useState('');
            const [cPhone, setCPhone] = useState('');
            const [activeTab, setActiveTab] = useState('medicamentos');

            const processText = () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const uniqueMeds = [...new Set(lines.map(l => l.trim().toUpperCase()))];
                if(uniqueMeds.length > 0) { 
                    onAddList(uniqueMeds); 
                    setRawText(''); 
                    alert(`Se procesaron ${uniqueMeds.length} medicamentos.`); 
                }
            };

            const addSingle = (e) => {
                e.preventDefault();
                if(newMed.trim()) {
                    onAddList([newMed.trim().toUpperCase()]);
                    setNewMed('');
                }
            };

            const handleAddContact = (e) => {
                e.preventDefault();
                if(cName.trim() && cPhone.trim()) {
                    onAddContact(cName, cPhone);
                    setCName('');
                    setCPhone('');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                            <Icons.Settings size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-xl text-slate-800 brand-font">Configuraci√≥n</h3>
                            <p className="text-xs font-semibold text-turquoise-600">Cat√°logos del Sistema</p>
                        </div>
                    </div>
                    
                    <div className="border-b border-slate-100 px-6">
                        <div className="flex gap-4">
                            <button 
                                onClick={() => setActiveTab('medicamentos')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'medicamentos' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Box className="inline mr-2" size={16}/> Medicamentos
                            </button>
                            <button 
                                onClick={() => setActiveTab('contactos')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'contactos' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Phone className="inline mr-2" size={16}/> Contact Center
                            </button>
                            <button 
                                onClick={() => setActiveTab('plantillas')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'plantillas' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Layout className="inline mr-2" size={16}/> Plantillas
                            </button>
                        </div>
                    </div>
                    
                    <div className="p-6 overflow-y-auto space-y-8">
                        {activeTab === 'medicamentos' && (
                            <div>
                                <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2">
                                    <Icons.Box size={16}/> Medicamentos
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Agregar Individual</h4>
                                            <form onSubmit={addSingle} className="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    className="flex-1 p-2 rounded-lg border text-sm uppercase outline-none focus:border-turquoise-400" 
                                                    placeholder="Nombre del medicamento..." 
                                                    value={newMed} 
                                                    onChange={e=>setNewMed(e.target.value)} 
                                                />
                                                <button type="submit" className="bg-turquoise-600 text-white p-2 rounded-lg hover:bg-turquoise-700 btn-hover-effect">
                                                    <Icons.Plus size={20}/>
                                                </button>
                                            </form>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Carga Masiva</h4>
                                            <p className="text-xs text-slate-400 mb-2">Pegue la lista de medicamentos (uno por l√≠nea).</p>
                                            <textarea 
                                                className="w-full h-32 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-turquoise-400" 
                                                placeholder="AMOXICILINA 500MG&#10;PARACETAMOL&#10;..." 
                                                value={rawText} 
                                                onChange={e => setRawText(e.target.value)}
                                            ></textarea>
                                            <button 
                                                onClick={processText} 
                                                className="mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-slate-900 w-full btn-hover-effect flex justify-center gap-2 items-center"
                                            >
                                                <Icons.Upload size={16}/> Procesar Lista
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Cat√°logo Actual ({medicines.length})</h4>
                                        <div className="h-full max-h-[400px] overflow-y-auto border rounded-xl bg-white p-2 space-y-1">
                                            {medicines.map((m, i) => (
                                                <div key={i} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 uppercase">
                                                    {m.name}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'contactos' && (
                            <div>
                                <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2">
                                    <Icons.Phone size={16}/> Contact Center
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 h-fit">
                                        <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider">Nuevo Agente</h4>
                                        <form onSubmit={handleAddContact} className="space-y-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre</label>
                                                <input 
                                                    type="text" 
                                                    value={cName} 
                                                    onChange={e=>setCName(e.target.value)} 
                                                    className="w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400" 
                                                    placeholder="Ej: Karla" 
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tel√©fono</label>
                                                <input 
                                                    type="text" 
                                                    value={cPhone} 
                                                    onChange={e=>setCPhone(e.target.value)} 
                                                    className="w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400" 
                                                    placeholder="Ej: 9988-7766" 
                                                    required
                                                />
                                            </div>
                                            <button type="submit" className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-xs hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm">
                                                <Icons.Save size={16}/> Guardar Agente
                                            </button>
                                        </form>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Agentes Activos ({contacts?.length || 0})</h4>
                                        <div className="border rounded-xl bg-white p-2 max-h-60 overflow-y-auto space-y-1">
                                            {contacts && contacts.map(c => (
                                                <div key={c.id} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 flex justify-between items-center group">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-[10px]">
                                                            {c.name.substring(0,2).toUpperCase()}
                                                        </div>
                                                        <span className="font-medium text-slate-700">{c.name} <span className="text-slate-400 mx-1">---</span> {c.phone}</span>
                                                    </div>
                                                    <button onClick={()=>onDeleteContact(c.id)} className="text-slate-300 hover:text-red-500 p-1 rounded hover:bg-red-50 transition">
                                                        <Icons.Trash size={14}/>
                                                    </button>
                                                </div>
                                            ))}
                                            {(!contacts || contacts.length === 0) && (
                                                <div className="text-center text-slate-300 text-xs py-4 italic">
                                                    No hay agentes configurados
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'plantillas' && (
                            <div className="p-6 text-center text-slate-500">
                                <p>El editor de plantillas ha sido eliminado.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: USUARIOS ---
        const UserManagementBlock = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [formData, setFormData] = useState({ username: '', password: '', role: 'digitador', nombre: '' });
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);

            const openNew = () => { 
                setEditingId(null); 
                setFormData({ username: '', password: '', role: 'digitador', nombre: '' }); 
                setShowModal(true); 
            };
            
            const openEdit = (u) => { 
                setEditingId(u.id); 
                setFormData(u); 
                setShowModal(true); 
            };
            
            const closeModal = () => { 
                setShowModal(false); 
                setEditingId(null); 
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const uData = {...formData, departamento: 'Operaciones'};
                    if (editingId) {
                        await onUpdateUser(editingId, uData);
                    } else {
                        await onAddUser(uData);
                    }
                    closeModal();
                } catch (error) {
                    alert('Error al guardar usuario: ' + error.message);
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                                <Icons.UserCog size={24} />
                            </div>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Usuarios</h3>
                                <p className="text-xs font-semibold text-turquoise-600">{users.length} Activos</p>
                            </div>
                        </div>
                        <button onClick={openNew} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                            <Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo Usuario</span>
                        </button>
                    </div>

                    <Modal isOpen={showModal} onClose={closeModal} title={editingId ? "Editar Usuario" : "Nuevo Usuario"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.nombre} 
                                    onChange={e=>setFormData({...formData, nombre:e.target.value})} 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Usuario (Login)</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.username} 
                                    onChange={e=>setFormData({...formData, username:e.target.value.toLowerCase()})} 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Contrase√±a</label>
                                    <input 
                                    type="password" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.password} 
                                    onChange={e=>setFormData({...formData, password:e.target.value})} 
                                    placeholder={editingId ? "Dejar vac√≠o para mantener" : ""} 
                                    required={!editingId} 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Rol</label>
                                <select 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                    value={formData.role} 
                                    onChange={e=>setFormData({...formData, role:e.target.value})}
                                >
                                    <option value="digitador">Digitador</option>
                                    <option value="admin">Administrador</option>
                                    <option value="superadmin">Super Admin</option>
                                </select>
                            </div>
                            <button type="submit" className="w-full bg-turquoise-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-turquoise-700 btn-hover-effect mt-4">
                                {editingId ? 'Actualizar' : 'Crear Usuario'}
                            </button>
                        </form>
                    </Modal>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        <div className="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
                            {users.map(u => (
                                <div key={u.id} className="p-4 rounded-xl border border-slate-200 flex flex-col gap-3 bg-white hover:shadow-md transition-shadow relative group">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${u.role === 'digitador' ? 'bg-clinical-500' : 'bg-turquoise-600'}`}>
                                            {u.username.substring(0,2).toUpperCase()}
                                        </div>
                                        <div>
                                            <div className="font-bold text-sm text-slate-800">{u.nombre || u.username}</div>
                                            <div className="text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded w-fit mt-1">
                                                @{u.username} ‚Ä¢ {u.role}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="border-t border-slate-100 pt-2 flex justify-end gap-2">
                                        <button onClick={() => openEdit(u)} className="p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Editar">
                                            <Icons.Edit size={18}/>
                                        </button>
                                        <button onClick={() => setConfirmData({ title: 'Eliminar Usuario', msg: `¬øDesea eliminar a ${u.username}?`, action: () => onDeleteUser(u.id) })} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">
                                            <Icons.Trash size={18}/>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [users, setUsers] = useState([]);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); 
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [cacheManager] = useState(new CacheManager());
            const [firebaseStatus, setFirebaseStatus] = useState('Conectando...');
            const [isFirebaseReady, setIsFirebaseReady] = useState(firebaseInitialized);

            // Verificar estado de Firebase peri√≥dicamente
            useEffect(() => {
                const handleInitialized = () => {
                    setIsFirebaseReady(true);
                    setFirebaseStatus('Conectado');
                };
                
                const handleError = () => {
                    setIsFirebaseReady(false);
                };
                
                window.addEventListener('firebaseInitialized', handleInitialized);
                window.addEventListener('firebaseError', handleError);
                
                // Verificar estado inicial
                const checkFirebaseStatus = async () => {
                    if (firebaseInitialized) {
                        setIsFirebaseReady(true);
                        const isConnected = await checkFirestoreConnection();
                        setFirebaseStatus(isConnected ? 'Conectado' : 'Desconectado');
                    } else {
                        setIsFirebaseReady(false);
                    }
                };

                checkFirebaseStatus();
                const interval = setInterval(checkFirebaseStatus, 5000); // Verificar cada 5 segundos

                return () => {
                    clearInterval(interval);
                    window.removeEventListener('firebaseInitialized', handleInitialized);
                    window.removeEventListener('firebaseError', handleError);
                };
            }, []);

            const handleLogout = () => { 
                // NO LIMPIAR EL CACHE al cerrar sesi√≥n
                sessionStorage.removeItem('leq_role');
                sessionStorage.removeItem('leq_username');
                setRole(null); 
                setUserName(null); 
            };
            
            const handleLogin = (r, n) => { 
                setRole(r); 
                setUserName(n); 
                sessionStorage.setItem('leq_role', r); 
                sessionStorage.setItem('leq_username', n); 
            };

            const loadMedicines = async () => {
                try {
                    const cachedMedicines = cacheManager.getMedicines();
                    if (cachedMedicines) {
                        setMedicines(cachedMedicines);
                        console.log('‚úÖ Medicamentos cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_medicines').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    cacheManager.saveMedicines(data);
                    setMedicines(data);
                    console.log('üî• Medicamentos cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando medicamentos:', error);
                }
            };

            const loadContacts = async () => {
                try {
                    const cachedContacts = cacheManager.getContacts();
                    if (cachedContacts) {
                        setContacts(cachedContacts);
                        console.log('‚úÖ Contactos cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_contacts').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    cacheManager.saveContacts(data);
                    setContacts(data);
                    console.log('üî• Contactos cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando contactos:', error);
                }
            };

            const loadUsers = async () => {
                if (!(role === 'admin' || role === 'superadmin')) return;
                
                try {
                    const cachedUsers = cacheManager.getUsers();
                    if (cachedUsers) {
                        setUsers(cachedUsers);
                        console.log('‚úÖ Usuarios cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_users').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    cacheManager.saveUsers(data);
                    setUsers(data);
                    console.log('üî• Usuarios cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando usuarios:', error);
                    // No congelar la app - mostrar error pero continuar
                    if (error.code === 'permission-denied') {
                        console.warn('‚ö†Ô∏è Permisos insuficientes para cargar usuarios');
                    }
                }
            };

            const loadKits = async () => {
                try {
                    const cachedKits = cacheManager.getKits();
                    if (cachedKits) {
                        setKits(cachedKits);
                        console.log('‚úÖ Kits cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_kits').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                    
                    cacheManager.saveKits(data);
                    setKits(data);
                    console.log('üî• Kits cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando kits:', error);
                }
            };

            useEffect(() => {
                if (!role || !firebaseInitialized) return;
                
                loadMedicines();
                loadContacts();
                loadUsers();
                loadKits();
                
                // Escuchar cambios en tiempo real solo si Firebase est√° inicializado
                if (firebaseInitialized && db) {
                    const handleSnapshotError = (error, collectionName) => {
                        console.error(`‚ùå Error en snapshot de ${collectionName}:`, error);
                        if (error.code === 'permission-denied') {
                            console.warn(`‚ö†Ô∏è Permisos insuficientes para ${collectionName}`);
                        }
                    };
                    
                    const unsubMedicines = db.collection('prod_medicines')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => a.name.localeCompare(b.name));
                                setMedicines(data);
                                cacheManager.saveMedicines(data);
                            },
                            error => handleSnapshotError(error, 'medicines')
                        );
                    
                    const unsubContacts = db.collection('prod_contacts')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => a.name.localeCompare(b.name));
                                setContacts(data);
                                cacheManager.saveContacts(data);
                            },
                            error => handleSnapshotError(error, 'contacts')
                        );
                    
                    const unsubKits = db.collection('prod_kits')
                        .onSnapshot(
                            s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                                setKits(data);
                                cacheManager.saveKits(data);
                            },
                            error => handleSnapshotError(error, 'kits')
                        );
                    
                    if (role === 'admin' || role === 'superadmin') {
                        const unsubUsers = db.collection('prod_users')
                            .onSnapshot(
                                s => {
                                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                                    setUsers(data);
                                    cacheManager.saveUsers(data);
                                },
                                error => handleSnapshotError(error, 'users')
                            );
                        
                        return () => {
                            unsubMedicines();
                            unsubContacts();
                            unsubKits();
                            unsubUsers();
                        };
                    }
                    
                    return () => {
                        unsubMedicines();
                        unsubContacts();
                        unsubKits();
                    };
                }
            }, [role, firebaseInitialized]);

            const addPatient = async (d) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    const result = await db.collection('prod_patients').add({
                        ...d, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("‚úÖ Paciente guardado con ID: ", result.id);
                    cacheManager.clearPatientCache();
                    return result;
                } catch (error) {
                    console.error("‚ùå Error guardando paciente: ", error);
                    // Manejar errores de permisos espec√≠ficamente
                    if (error.code === 'permission-denied') {
                        throw new Error("Permisos insuficientes. Verifica las reglas de seguridad de Firestore.");
                    }
                    throw error;
                }
            };
            
            const updatePatient = async (id, d) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_patients').doc(id).update(d);
                    cacheManager.clearPatientCache(id);
                } catch (error) {
                    console.error("Error updating patient: ", error);
                    throw error;
                }
            };
            
            const deletePatient = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_patients').doc(id).delete();
                    cacheManager.clearPatientCache(id);
                } catch (error) {
                    console.error("Error deleting patient: ", error);
                    throw error;
                }
            };
            
            const saveKit = async (id, data, pid, isUpdate) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    let resultId = id;
                    if(isUpdate) {
                        await db.collection('prod_kits').doc(id).update(data);
                        console.log("‚úÖ Kit actualizado: ", id);
                    } else {
                        const result = await db.collection('prod_kits').add({
                            ...data, 
                            patientId: pid, 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        resultId = result.id;
                        console.log("‚úÖ Kit guardado con ID: ", resultId);
                    }
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                    return resultId;
                } catch (error) {
                    console.error("‚ùå Error guardando kit: ", error);
                    if (error.code === 'permission-denied') {
                        throw new Error("Permisos insuficientes. Verifica las reglas de seguridad de Firestore.");
                    }
                    throw error;
                }
            };
            
            const deleteKit = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_kits').doc(id).delete();
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                } catch (error) {
                    console.error("Error deleting kit: ", error);
                    throw error;
                }
            };
            
            const addMedsList = async (list) => { 
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    for(const name of list) {
                        await db.collection('prod_medicines').add({ name });
                    }
                } catch (error) {
                    console.error("Error adding medicines: ", error);
                    throw error;
                }
            };
            
            const addContact = async (name, phone) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_contacts').add({ name, phone });
                } catch (error) {
                    console.error("Error adding contact: ", error);
                    throw error;
                }
            };
            
            const deleteContact = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_contacts').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting contact: ", error);
                    throw error;
                }
            };

            const addUser = async (u) => {
                try {
                    // Esperar a que Firebase est√© inicializado si no lo est√°
                    let attempts = 0;
                    while ((!firebaseInitialized || !db) && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        console.error("‚ùå Firebase no disponible despu√©s de esperar");
                        console.error("firebaseInitialized:", firebaseInitialized);
                        console.error("db:", db);
                        throw new Error("Base de datos no disponible. Por favor, recarga la p√°gina.");
                    }
                    
                    console.log("üíæ Guardando usuario en Firestore...");
                    const result = await db.collection('prod_users').add(u);
                    console.log("‚úÖ Usuario guardado con ID:", result.id);
                    return result;
                } catch (error) {
                    console.error("‚ùå Error agregando usuario:", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    if (error.code === 'permission-denied') {
                        throw new Error("Permisos insuficientes. Verifica las reglas de seguridad de Firestore.");
                    }
                    throw error;
                }
            };
            
            const updateUser = async (id, u) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').doc(id).update(u);
                } catch (error) {
                    console.error("Error updating user: ", error);
                    throw error;
                }
            };
            
            const deleteUser = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting user: ", error);
                    throw error;
                }
            };

            // Mostrar pantalla de conexi√≥n si Firebase no est√° listo
            if (!isFirebaseReady && firebaseConnectionStatus !== 'connected') {
                return <FirebaseConnectionScreen />;
            }
            
            if (!role) return <LoginBlock onLogin={handleLogin} />;

            const NavItem = ({ id, label, icon: Icon }) => (
                <button 
                    onClick={() => { setView(id); setMobileMenuOpen(false); }} 
                    className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold group relative overflow-hidden btn-hover-effect ${view === id ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`}
                >
                    <Icon size={20} className={view === id ? 'text-white' : 'text-turquoise-400 group-hover:text-white'} />
                    <span className={`whitespace-nowrap transition-opacity duration-300 ${sidebarCollapsed ? 'hidden opacity-0 w-0' : 'block opacity-100'}`}>
                        {label}
                    </span>
                </button>
            );

            const stats = { 
                totalKits: kits.length, 
                todayKits: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length 
            };

            return (
                <div className="flex h-screen bg-[#f0fdfa] font-sans overflow-hidden">
                    {mobileMenuOpen && ( 
                        <div className="fixed inset-0 z-50 bg-turquoise-900/95 backdrop-blur-sm flex flex-col md:hidden animate-in">
                            <div className="p-4 flex justify-between items-center border-b border-turquoise-800">
                                <div className="font-bold text-white text-xl flex items-center gap-2 brand-font">
                                    <Icons.Activity/> Bit√°cora Producci√≥n
                                </div>
                                <button onClick={() => setMobileMenuOpen(false)} className="text-white p-2 bg-turquoise-800 rounded-full btn-hover-effect">
                                    <Icons.X size={24}/>
                                </button>
                            </div>
                            <div className="p-6 space-y-4">
                                <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                                <NavItem id="reports" label="Reportes" icon={Icons.List} />
                                <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />
                                {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuraci√≥n" icon={Icons.Settings} />}
                                {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                                <div className="pt-8 border-t border-turquoise-800">
                                    <button onClick={handleLogout} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl bg-turquoise-800 text-white font-bold btn-hover-effect">
                                        <Icons.LogOut size={20}/> Desconectar
                                    </button>
                                </div>
                            </div>
                        </div> 
                    )}
                    
                    <aside className={`${sidebarCollapsed ? 'w-24' : 'w-72'} bg-turquoise-900 text-turquoise-100 flex-col shadow-2xl z-20 hidden md:flex relative transition-all duration-300 ease-in-out`}>
                        <div className={`p-6 pb-2 relative z-10 flex ${sidebarCollapsed ? 'justify-center' : 'justify-between'} items-center`}>
                            {!sidebarCollapsed && (
                                <div className="flex items-center gap-3 text-white">
                                    <div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg">
                                        <Icons.Activity size={24} className="text-white"/>
                                    </div>
                                    <span className="font-bold text-2xl brand-font animate-in">Bit√°cora</span>
                                </div>
                            )}
                            {sidebarCollapsed && (
                                <div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg mb-2">
                                    <Icons.Activity size={24} className="text-white"/>
                                </div>
                            )}
                            <button 
                                onClick={() => setSidebarCollapsed(!sidebarCollapsed)} 
                                className="text-turquoise-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-turquoise-800 absolute right-4 top-6 btn-hover-effect" 
                                style={sidebarCollapsed ? { right: 'auto', top: 'auto', marginTop: '10px', position: 'static' } : {}}
                            >
                                {sidebarCollapsed ? <Icons.ChevronsRight size={20}/> : <Icons.ArrowLeft size={20}/>}
                            </button>
                        </div>
                        {!sidebarCollapsed && (
                            <div className="text-xs font-bold text-turquoise-400 uppercase tracking-widest pl-14 mb-4 animate-in">
                                Producci√≥n
                            </div>
                        )}
                        <nav className="flex-1 px-4 py-4 space-y-2 relative z-10 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                            <NavItem id="reports" label="Reportes" icon={Icons.List} />
                            <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuraci√≥n" icon={Icons.Settings} />}
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                        </nav>
                        <div className="p-4 mx-4 mb-4 rounded-2xl bg-turquoise-800/50 border border-turquoise-700/50 relative z-10">
                            <div className={`flex items-center gap-3 mb-4 ${sidebarCollapsed ? 'justify-center flex-col' : ''}`}>
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-clinical-400 to-clinical-600 flex items-center justify-center font-bold text-white text-sm shrink-0">
                                    {role==='admin'?'AD':'OP'}
                                </div>
                                {!sidebarCollapsed && (
                                    <div className="overflow-hidden">
                                        <div className="text-sm font-bold text-white capitalize truncate">{userName}</div>
                                        <div className="text-[10px] text-turquoise-300 truncate">{firebaseStatus}</div>
                                    </div>
                                )}
                            </div>
                            <button 
                                onClick={handleLogout} 
                                className={`w-full flex items-center gap-2 text-xs font-bold text-turquoise-200 hover:text-white py-2.5 rounded-xl hover:bg-turquoise-700 transition-colors btn-hover-effect ${sidebarCollapsed ? 'justify-center' : 'justify-center'}`} 
                                title="Desconectar"
                            >
                                <Icons.LogOut size={16}/> {!sidebarCollapsed && <span>Salir</span>}
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-full overflow-hidden bg-[#f0fdfa] relative transition-all duration-300">
                        <div className="md:hidden bg-white/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center z-20">
                            <button onClick={() => setMobileMenuOpen(true)} className="text-slate-600 p-1 btn-hover-effect">
                                <Icons.Menu size={24}/>
                            </button>
                            <div className="font-bold text-slate-800 flex items-center gap-2 brand-font">
                                <Icons.Activity size={18} className="text-turquoise-600"/> Bit√°cora Producci√≥n
                            </div>
                            <div className="w-8"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative z-10">
                            {view === 'dashboard' && <DashboardBlock setView={setView} stats={stats} userName={userName} role={role} />}
                            {view === 'reports' && <ReportsBlock kits={kits} patients={patients} userRole={role} userName={userName} setView={setView} />}
                            {view === 'pacientes' && <PatientManagementBlock patients={patients} kits={kits} medicines={medicines} onAddPatient={addPatient} onUpdatePatient={updatePatient} onDeletePatient={deletePatient} onSaveKit={saveKit} onDeleteKit={deleteKit} currentUser={{name: userName, role: role}} userRole={role} contacts={contacts} />}
                            {view === 'config' && (role === 'admin' || role === 'superadmin') && <ConfigBlock medicines={medicines} onAddList={addMedsList} contacts={contacts} onAddContact={addContact} onDeleteContact={deleteContact} />}
                            {view === 'users' && (role === 'admin' || role === 'superadmin') && <UserManagementBlock users={users} onAddUser={addUser} onUpdateUser={updateUser} onDeleteUser={deleteUser} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>