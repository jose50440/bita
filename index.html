<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Producción - Operaciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (Para Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        turquoise: { 50:'#f0fdfa', 100:'#ccfbf1', 200:'#99f6e4', 300:'#5eead4', 400:'#2dd4bf', 500:'#14b8a6', 600:'#0d9488', 700:'#0f766e', 800:'#115e59', 900:'#134e4a' },
                        clinical: { 50:'#f0fdf4', 100:'#dcfce7', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#15803d' }
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(20, 184, 166, 0.15)', glow: '0 0 15px rgba(45, 212, 191, 0.3)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdfa; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .row-hover-effect { transition: all 0.2s ease-out; border-left: 3px solid transparent; }
        .row-hover-effect:hover { background-color: white; transform: scale(1.005); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left-color: #0d9488; z-index: 10; position: relative; }

        .group-box { @apply border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4; }
        .group-title { @apply text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1; }

        /* Animaciones */
        @keyframes ekgPulse { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .animate-ekg { animation: ekgPulse 2s infinite ease-in-out; }
        
        /* Impresión específica */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 71mm; height: 210mm; padding: 0; margin: 0; }
            @page { size: 71mm 210mm; margin: 10mm 1mm; }
        }
        
        /* Estilos de impresión vertical */
        .print-vertical { width: 71mm; height: 210mm; }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-turquoise-200 selection:text-turquoise-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, getDocs, enableIndexedDbPersistence, orderBy, limit, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            Users: (p) => <Icon {...p} path={<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            LogOut: (p) => <Icon {...p} path={<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Settings: (p) => <Icon {...p} path={<circle cx="12" cy="12" r="3"></circle>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash: (p) => <Icon {...p} path={<polyline points="3 6 5 6 21 6"></polyline>} />,
            Printer: (p) => <Icon {...p} path={<polyline points="6 9 6 2 18 2 18 9"></polyline>} />,
            ChevronsRight: (p) => <Icon {...p} path={<polyline points="13 17 18 12 13 7"></polyline>} />,
            UserCog: (p) => <Icon {...p} path={<circle cx="12" cy="7" r="4"></circle>} />,
            Menu: (p) => <Icon {...p} path={<line x1="3" y1="12" x2="21" y2="12"></line>} />,
            X: (p) => <Icon {...p} path={<line x1="18" y1="6" x2="6" y2="18"></line>} />,
            FileText: (p) => <Icon {...p} path={<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            Minus: (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"></line>} />,
            Folder: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></>} />,
            LayoutDashboard: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Bot: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>} />,
            FolderPlus: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            FileSpreadsheet: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />
        };

        // --- FIREBASE CONFIG (bitacora-217cf) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHrnTnsXg4P6faYSfP51gORVKPy-ExEw4",
            authDomain: "bitacora-217cf.firebaseapp.com",
            projectId: "bitacora-217cf",
            storageBucket: "bitacora-217cf.firebasestorage.app",
            messagingSenderId: "1080043869360",
            appId: "1:1080043869360:web:5932f72c30d8bb376cd775"
        };

        let app, auth, db;
        try { 
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app); 
            db = getFirestore(app); 
            enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err.code));
        } catch (err) { console.error("Firebase Init Error:", err); }

        // --- COMPONENTS ---

        const AnimatedCounter = ({ value }) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0; const end = parseInt(value, 10);
                if (isNaN(end)) return;
                if (start === end) { setCount(end); return; }
                const duration = 1000; const incrementTime = 20; const stepAmount = Math.ceil(end / (duration / incrementTime));
                let timer = setInterval(() => {
                    start += stepAmount;
                    if (start >= end) { setCount(end); clearInterval(timer); } else { setCount(start); }
                }, incrementTime);
                return () => clearInterval(timer);
            }, [value]);
            return <span>{count}</span>;
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[95vh] modal-animate`}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col modal-animate p-6 text-center">
                        <h3 className="text-lg font-medium text-slate-900 mb-2">{title}</h3>
                        <p className="text-sm text-slate-500 mb-6">{message}</p>
                        <div className="flex justify-center gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-sm">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- BLOCK: LOGIN (INTACTO) ---
        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            const handleLogin = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                const userKey = username.trim().toLowerCase();
                
                if (userKey === 'superadmin' && password === 'superadmin') { 
                    proceedLogin('superadmin', 'Super Usuario', 'Operaciones'); return; 
                }
                
                try {
                    const q = query(collection(db, 'prod_users'), where('username', '==', userKey));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                             proceedLogin(userData.role, userData.nombre || userData.username, 'Operaciones');
                        } else { setError("Contraseña incorrecta."); setLoading(false); }
                    } else { setError("Usuario no encontrado."); setLoading(false); }
                } catch (err) { 
                    console.error(err);
                    setError("Error de conexión. Verifique su red."); setLoading(false); 
                }
            };
            
            const proceedLogin = async (role, name, dept) => {
                 try { await addDoc(collection(db, 'prod_access_logs'), { username: name, role: role, timestamp: serverTimestamp() }); } catch (e) {}
                 onLogin(role, name, dept);
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6 relative">
                    <div className={`absolute top-6 right-6 px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-sm transition-all ${isOnline ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                        {isOnline ? <Icons.Wifi size={16}/> : <Icons.WifiOff size={16}/>}
                        {isOnline ? 'Conectado' : 'Sin Conexión'}
                    </div>

                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50 relative z-10">
                        <div className="text-center mb-10">
                            <div className="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-ekg"><Icons.Activity size={40} /></div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font">Bitácora <span className="text-turquoise-600">Producción</span></h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Dpto. Operaciones</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold border border-red-100">{error}</div>}
                            <div className="space-y-4">
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Usuario</label><input type="text" className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" value={username} onChange={(e) => setUsername(e.target.value)} required /></div>
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contraseña</label><input type="password" className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" value={password} onChange={(e) => setPassword(e.target.value)} required /></div>
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-turquoise-500 to-clinical-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect">{loading ? 'Verificando...' : 'Iniciar Sesión'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- BLOCK: CONFIGURACION (INTACTO) ---
        const ConfigBlock = ({ medicines, onAddList, contacts, onAddContact, onDeleteContact }) => {
            const [rawText, setRawText] = useState('');
            const [newMed, setNewMed] = useState(''); 
            // Estado para Contact Center
            const [cName, setCName] = useState('');
            const [cPhone, setCPhone] = useState('');

            const processText = () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const uniqueMeds = [...new Set(lines.map(l => l.trim().toUpperCase()))];
                if(uniqueMeds.length > 0) { onAddList(uniqueMeds); setRawText(''); alert(`Se procesaron ${uniqueMeds.length} medicamentos.`); }
            };

            const addSingle = (e) => {
                e.preventDefault();
                if(newMed.trim()) {
                    onAddList([newMed.trim().toUpperCase()]);
                    setNewMed('');
                }
            };

            const handleAddContact = (e) => {
                e.preventDefault();
                if(cName.trim() && cPhone.trim()) {
                    onAddContact(cName, cPhone);
                    setCName('');
                    setCPhone('');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"><Icons.Settings size={24} /></div>
                        <div><h3 className="font-bold text-xl text-slate-800 brand-font">Configuración</h3><p className="text-xs font-semibold text-turquoise-600">Catálogos del Sistema</p></div>
                    </div>
                    <div className="p-6 overflow-y-auto space-y-8">
                        
                        {/* SECCIÓN MEDICAMENTOS */}
                        <div>
                            <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2"><Icons.Box size={16}/> Medicamentos</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Agregar Individual</h4>
                                        <form onSubmit={addSingle} className="flex gap-2">
                                            <input type="text" className="flex-1 p-2 rounded-lg border text-sm uppercase outline-none focus:border-turquoise-400" placeholder="Nombre del medicamento..." value={newMed} onChange={e=>setNewMed(e.target.value)} />
                                            <button type="submit" className="bg-turquoise-600 text-white p-2 rounded-lg hover:bg-turquoise-700 btn-hover-effect"><Icons.Plus size={20}/></button>
                                        </form>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Carga Masiva</h4>
                                        <p className="text-xs text-slate-400 mb-2">Pegue la lista de medicamentos (uno por línea).</p>
                                        <textarea className="w-full h-32 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-turquoise-400" placeholder="AMOXICILINA 500MG&#10;PARACETAMOL&#10;..." value={rawText} onChange={e => setRawText(e.target.value)}></textarea>
                                        <button onClick={processText} className="mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-slate-900 w-full btn-hover-effect flex justify-center gap-2 items-center"><Icons.Upload size={16}/> Procesar Lista</button>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Catálogo Actual ({medicines.length})</h4>
                                    <div className="h-full max-h-[400px] overflow-y-auto border rounded-xl bg-white p-2 space-y-1">
                                        {medicines.map((m, i) => <div key={i} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 uppercase">{m.name}</div>)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* SECCIÓN CONTACT CENTER (NUEVA) */}
                        <div>
                            <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2"><Icons.Phone size={16}/> Contact Center</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 h-fit">
                                    <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider">Nuevo Agente</h4>
                                    <form onSubmit={handleAddContact} className="space-y-4">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre</label>
                                            <input type="text" value={cName} onChange={e=>setCName(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400" placeholder="Ej: Karla" required/>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Teléfono</label>
                                            <input type="text" value={cPhone} onChange={e=>setCPhone(e.target.value)} className="w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400" placeholder="Ej: 9988-7766" required/>
                                        </div>
                                        <button type="submit" className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-xs hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm">
                                            <Icons.Save size={16}/> Guardar Agente
                                        </button>
                                    </form>
                                </div>
                                <div>
                                    <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Agentes Activos ({contacts?.length || 0})</h4>
                                    <div className="border rounded-xl bg-white p-2 max-h-60 overflow-y-auto space-y-1">
                                        {contacts && contacts.map(c => (
                                            <div key={c.id} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 flex justify-between items-center group">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-[10px]">{c.name.substring(0,2).toUpperCase()}</div>
                                                    <span className="font-medium text-slate-700">{c.name} <span className="text-slate-400 mx-1">---</span> {c.phone}</span>
                                                </div>
                                                <button onClick={()=>onDeleteContact(c.id)} className="text-slate-300 hover:text-red-500 p-1 rounded hover:bg-red-50 transition"><Icons.Trash size={14}/></button>
                                            </div>
                                        ))}
                                        {(!contacts || contacts.length === 0) && <div className="text-center text-slate-300 text-xs py-4 italic">No hay agentes configurados</div>}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- BLOCK: USUARIOS (INTACTO) ---
        const UserManagementBlock = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [formData, setFormData] = useState({ username: '', password: '', role: 'digitador', nombre: '' });
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);

            const openNew = () => { setEditingId(null); setFormData({ username: '', password: '', role: 'digitador', nombre: '' }); setShowModal(true); };
            const openEdit = (u) => { setEditingId(u.id); setFormData(u); setShowModal(true); };
            const closeModal = () => { setShowModal(false); setEditingId(null); };

            const handleSubmit = (e) => {
                e.preventDefault();
                const uData = {...formData, departamento: 'Operaciones'};
                if (editingId) {
                    onUpdateUser(editingId, uData);
                } else {
                    onAddUser(uData);
                }
                closeModal();
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"><Icons.UserCog size={24} /></div>
                            <div><h3 className="font-bold text-xl text-slate-800 brand-font">Usuarios</h3><p className="text-xs font-semibold text-turquoise-600">{users.length} Activos</p></div>
                        </div>
                        <button onClick={openNew} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"><Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo Usuario</span></button>
                    </div>

                    <Modal isOpen={showModal} onClose={closeModal} title={editingId ? "Editar Usuario" : "Nuevo Usuario"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" value={formData.nombre} onChange={e=>setFormData({...formData, nombre:e.target.value})} required /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Usuario (Login)</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" value={formData.username} onChange={e=>setFormData({...formData, username:e.target.value.toLowerCase()})} required /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Contraseña</label><input type="password" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" value={formData.password} onChange={e=>setFormData({...formData, password:e.target.value})} placeholder={editingId ? "Dejar vacío para mantener" : ""} required={!editingId} /></div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Rol</label><select className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" value={formData.role} onChange={e=>setFormData({...formData, role:e.target.value})}><option value="digitador">Digitador</option><option value="admin">Administrador</option><option value="superadmin">Super Admin</option></select></div>
                            <button type="submit" className="w-full bg-turquoise-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-turquoise-700 btn-hover-effect mt-4">{editingId ? 'Actualizar' : 'Crear Usuario'}</button>
                        </form>
                    </Modal>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        <div className="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
                            {users.map(u => (
                                <div key={u.id} className="p-4 rounded-xl border border-slate-200 flex flex-col gap-3 bg-white hover:shadow-md transition-shadow relative group">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${u.role === 'digitador' ? 'bg-clinical-500' : 'bg-turquoise-600'}`}>{u.username.substring(0,2).toUpperCase()}</div>
                                        <div><div className="font-bold text-sm text-slate-800">{u.nombre || u.username}</div><div className="text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded w-fit mt-1">@{u.username} • {u.role}</div></div>
                                    </div>
                                    <div className="border-t border-slate-100 pt-2 flex justify-end gap-2">
                                        <button onClick={() => openEdit(u)} className="p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Editar"><Icons.Edit size={18}/></button>
                                        <button onClick={() => setConfirmData({ title: 'Eliminar Usuario', msg: `¿Desea eliminar a ${u.username}?`, action: () => onDeleteUser(u.id) })} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar"><Icons.Trash size={18}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- BLOCK: DASHBOARD (INTACTO) ---
        const DashboardBlock = ({ setView, stats, userName, role }) => { 
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(()=>setTime(new Date()),1000); return ()=>clearInterval(t); }, []);
            
            // Definición de tarjetas con permisos
            const allCards = [
                { id: 'reports', label: 'Reportes y Carpetas', icon: Icons.List, color: 'bg-amber-500', desc: 'Ver kits por fecha', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'pacientes', label: 'Gestión de Pacientes', icon: Icons.Users, color: 'bg-turquoise-500', desc: 'Crear kits por DH', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'config', label: 'Configuración', icon: Icons.Settings, color: 'bg-slate-500', desc: 'Catálogos del Sistema', allowed: ['admin', 'superadmin'] },
                { id: 'users', label: 'Gestión de Usuarios', icon: Icons.UserCog, color: 'bg-indigo-500', desc: 'Control de accesos', allowed: ['admin', 'superadmin'] },
            ];

            const visibleCards = allCards.filter(c => c.allowed.includes(role));

            return (
                <div className="w-full max-w-6xl mx-auto space-y-8 animate-in">
                    <div className="bg-gradient-to-r from-turquoise-600 to-clinical-600 rounded-3xl p-8 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10"><h1 className="text-3xl font-bold brand-font mb-2">¡Hola, {userName}!</h1><p className="opacity-90 text-sm font-medium uppercase tracking-wider">Operaciones - Bitácora de Producción</p></div>
                        <div className="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform origin-bottom-right"></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex flex-col justify-center items-center text-center">
                            <div className="text-5xl font-mono font-bold text-slate-700 tracking-widest mb-2">{time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <div className="text-sm text-slate-400 font-medium uppercase">{time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'})}</div>
                        </div>
                        <div className="md:col-span-2 grid grid-cols-2 gap-4">
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-turquoise-50 text-turquoise-600 rounded-2xl"><Icons.Box size={32}/></div>
                                <div><div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.totalKits}/></div><div className="text-xs text-slate-400 font-bold uppercase">Kits Totales</div></div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-clinical-50 text-clinical-600 rounded-2xl"><Icons.Calendar size={32}/></div>
                                <div><div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.todayKits}/></div><div className="text-xs text-slate-400 font-bold uppercase">Armados Hoy</div></div>
                            </div>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-700 brand-font mt-8">Accesos Directos</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {visibleCards.map(c => (
                            <button key={c.id} onClick={() => setView(c.id)} className="group relative bg-white p-6 rounded-3xl shadow-soft border border-slate-100 hover:shadow-xl transition-all duration-300 text-left hover:-translate-y-1 overflow-hidden">
                                <div className={`absolute top-0 right-0 w-24 h-24 ${c.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                <div className={`w-12 h-12 rounded-2xl ${c.color} flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`}><c.icon size={24} /></div>
                                <h4 className="font-bold text-lg text-slate-800 mb-1 group-hover:text-turquoise-600 transition-colors">{c.label}</h4>
                                <p className="text-xs text-slate-400">{c.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- BLOCK: REPORTES (ACTUALIZADO) ---
        const ReportsBlock = ({ kits, patients, userRole, userName, setView }) => {
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedDay, setSelectedDay] = useState(null);
            const [selectedKit, setSelectedKit] = useState(null);
            const [showKitModal, setShowKitModal] = useState(false);
            
            // Estados para el kit que se quiere editar desde reportes
            const [kitToEdit, setKitToEdit] = useState(null);
            
            // Agrupar kits por mes y día
            const groupedByMonth = useMemo(() => {
                const groups = {};
                kits.forEach(kit => {
                    if (!kit.fechaArmado) return;
                    const date = new Date(kit.fechaArmado);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const dayKey = kit.fechaArmado;
                    
                    if (!groups[monthKey]) {
                        groups[monthKey] = {
                            name: monthKey,
                            display: date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }),
                            days: {}
                        };
                    }
                    
                    if (!groups[monthKey].days[dayKey]) {
                        groups[monthKey].days[dayKey] = {
                            date: dayKey,
                            display: date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }),
                            kits: []
                        };
                    }
                    
                    groups[monthKey].days[dayKey].kits.push(kit);
                });
                return groups;
            }, [kits]);

            // Función para descargar Excel del día seleccionado (solo admin)
            const downloadDayExcel = (dayKits) => {
                if (!dayKits || dayKits.length === 0) {
                    alert('No hay kits para este día');
                    return;
                }

                // Crear datos con las columnas especificadas
                const excelData = dayKits.map(kit => ({
                    'DNI/ID': kit.dni || '',
                    'Nombre': kit.nombre || '',
                    'Cantidad Medicamentos': kit.medicamentos?.length || 0,
                    'Cantidad Refrigerados': kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    'Fecha Armado Kit': kit.fechaArmado || '',
                    'Digitador': kit.digitador || '',
                    'Fecha Entrega Kit': kit.fechaEntregaKit || '',
                    'Modo Entrega': kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla',
                    'Contact Center': kit.contactCenter || '',
                    'GPS': kit.gpsStatus || 'SIN GPS'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Kits del Día");
                
                const fileName = `kits_${selectedDay}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            // Función para imprimir desde reportes
            const printKitFromReports = (kit, mode) => {
                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'absolute';
                printFrame.style.width = '0';
                printFrame.style.height = '0';
                printFrame.style.border = '0';
                
                document.body.appendChild(printFrame);
                
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            @media print {
                                @page {
                                    size: 71mm 210mm;
                                    margin: 10mm 1mm;
                                }
                                body {
                                    font-family: Arial, sans-serif;
                                    margin: 0;
                                    padding: 0;
                                    width: 69mm;
                                    height: 190mm;
                                    font-size: 10px;
                                }
                                .header {
                                    text-align: center;
                                    border-bottom: 2px solid #000;
                                    padding-bottom: 2mm;
                                    margin-bottom: 3mm;
                                }
                                .header h1 {
                                    font-size: 12px;
                                    font-weight: bold;
                                    margin: 0;
                                }
                                .section {
                                    margin-bottom: 3mm;
                                }
                                .section-title {
                                    background: #000;
                                    color: #fff;
                                    text-align: center;
                                    font-weight: bold;
                                    padding: 1mm;
                                    margin-bottom: 2mm;
                                    font-size: 10px;
                                }
                                .patient-info {
                                    border: 1px solid #000;
                                    padding: 2mm;
                                    margin-bottom: 3mm;
                                }
                                .info-row {
                                    display: flex;
                                    margin-bottom: 1mm;
                                }
                                .info-label {
                                    font-weight: bold;
                                    width: 25mm;
                                }
                                .info-value {
                                    flex: 1;
                                }
                                .highlight {
                                    font-weight: bold;
                                    font-size: 11px;
                                    background: #f0f0f0;
                                    padding: 1mm;
                                    border: 1px solid #ccc;
                                }
                                .delivery-mode {
                                    text-align: center;
                                    font-size: 14px;
                                    font-weight: bold;
                                    border: 2px solid #000;
                                    padding: 3mm;
                                    margin: 3mm 0;
                                }
                                .footer {
                                    margin-top: 5mm;
                                    border-top: 1px solid #000;
                                    padding-top: 1mm;
                                    font-size: 8px;
                                    text-align: center;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>BITÁCORA DE PRODUCCIÓN</h1>
                            <div>${mode === 'ruta' ? 'ENTREGA EN RUTA' : 'VENTANILLA'}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">INFORMACIÓN DEL PACIENTE</div>
                            <div class="patient-info">
                                <div class="info-row">
                                    <div class="info-label">NOMBRE:</div>
                                    <div class="info-value highlight">${kit.nombre || ''}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">DNI/ID:</div>
                                    <div class="info-value highlight">${kit.dni || ''}</div>
                                </div>
                                ${kit.deliveryMode === 'ruta' ? `
                                <div class="info-row">
                                    <div class="info-label">DIRECCIÓN:</div>
                                    <div class="info-value highlight">${patients.find(p => p.dni === kit.dni)?.direccion || ''}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">DETALLES DEL KIT</div>
                            <div class="info-row">
                                <div class="info-label">FECHA ARMADO:</div>
                                <div class="info-value">${kit.fechaArmado || ''}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">MEDICAMENTOS:</div>
                                <div class="info-value">${kit.medicamentos?.length || 0}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">REFRIGERADOS:</div>
                                <div class="info-value">${kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">DIGITADOR:</div>
                                <div class="info-value">${kit.digitador || ''}</div>
                            </div>
                        </div>
                        
                        <div class="delivery-mode">
                            ${mode === 'ruta' ? 'ENTREGA EN RUTA' : 'VENTANILLA'}
                        </div>
                        
                        <div class="footer">
                            Generado el ${new Date().toLocaleDateString('es-ES')} | Bitácora Producción
                        </div>
                    </body>
                    </html>
                `;
                
                printFrame.contentDocument.write(printContent);
                printFrame.contentDocument.close();
                
                setTimeout(() => {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                    
                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                    }, 100);
                }, 500);
            };

            // Navegación
            const handleBack = () => {
                if (selectedKit) {
                    setSelectedKit(null);
                } else if (selectedDay) {
                    setSelectedDay(null);
                } else if (selectedMonth) {
                    setSelectedMonth(null);
                }
            };

            // Función para manejar edición de kit desde reportes
            const handleEditKitFromReports = (kit) => {
                setKitToEdit(kit);
                // Buscar el paciente asociado al kit
                const patient = patients.find(p => p.dni === kit.dni);
                if (patient) {
                    // Guardar en sessionStorage para que PatientManagementBlock lo pueda usar
                    sessionStorage.setItem('editKitFromReports', JSON.stringify({
                        kitId: kit.id,
                        patientId: patient.id,
                        kitData: kit
                    }));
                    // Cambiar a vista de pacientes
                    setView('pacientes');
                } else {
                    alert('No se encontró el paciente asociado a este kit');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    {/* Header */}
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={handleBack} className={`p-2 rounded-xl transition-colors ${selectedMonth ? 'hover:bg-slate-100 text-slate-500' : 'opacity-0 pointer-events-none'}`}>
                                <Icons.ArrowLeft size={20}/>
                            </button>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">
                                    {selectedKit ? 'Detalle del Kit' : 
                                     selectedDay ? `Kits del ${selectedDay}` :
                                     selectedMonth ? groupedByMonth[selectedMonth]?.display :
                                     'Reportes y Carpetas'}
                                </h3>
                                <p className="text-xs font-semibold text-turquoise-600">
                                    {selectedKit ? 'Información completa' :
                                     selectedDay ? `${groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.length || 0} Kits` :
                                     selectedMonth ? `${Object.keys(groupedByMonth[selectedMonth]?.days || {}).length} días` :
                                     `${Object.keys(groupedByMonth).length} meses, ${kits.length} kits totales`}
                                </p>
                            </div>
                        </div>
                        
                        {/* Botón para descargar Excel del día (solo admin) */}
                        {(userRole === 'admin' || userRole === 'superadmin') && selectedDay && (
                            <button 
                                onClick={() => downloadDayExcel(groupedByMonth[selectedMonth]?.days[selectedDay]?.kits)} 
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect"
                            >
                                <Icons.Download size={16}/> Descargar Excel
                            </button>
                        )}
                    </div>

                    {/* Modal detalle del Kit */}
                    <Modal isOpen={showKitModal} onClose={() => setShowKitModal(false)} title="Detalles Completos del Kit" maxWidth="max-w-4xl">
                        {selectedKit && (
                            <div className="space-y-6">
                                {/* Información básica */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-4 rounded-xl">
                                        <label className="text-xs font-bold text-slate-400 uppercase block mb-1">Paciente</label>
                                        <div className="text-lg font-bold text-slate-800">{selectedKit.nombre}</div>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-xl">
                                        <label className="text-xs font-bold text-slate-400 uppercase block mb-1">DNI/Afiliación</label>
                                        <div className="text-lg font-mono text-slate-800">{selectedKit.dni}</div>
                                    </div>
                                </div>
                                
                                {/* Fechas y logística */}
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="bg-turquoise-50 p-3 rounded-lg">
                                        <label className="text-xs font-bold text-turquoise-600 uppercase block mb-1">Fecha Armado</label>
                                        <div className="font-medium">{selectedKit.fechaArmado}</div>
                                    </div>
                                    <div className="bg-amber-50 p-3 rounded-lg">
                                        <label className="text-xs font-bold text-amber-600 uppercase block mb-1">Entrega Logística</label>
                                        <div className="font-medium">{selectedKit.fechaEntregaLogistica || 'Pendiente'}</div>
                                    </div>
                                    <div className="bg-green-50 p-3 rounded-lg">
                                        <label className="text-xs font-bold text-green-600 uppercase block mb-1">Entrega Kit</label>
                                        <div className="font-medium">{selectedKit.fechaEntregaKit || 'Pendiente'}</div>
                                    </div>
                                </div>
                                
                                {/* Detalles de entrega */}
                                <div className="border border-slate-200 rounded-xl p-4">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><Icons.Box size={16}/> Detalles de Entrega</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 block mb-1">Modo de Entrega</label>
                                            <div className={`px-3 py-1 rounded-full text-xs font-bold inline-block ${selectedKit.deliveryMode === 'ruta' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                                {selectedKit.deliveryMode === 'ruta' ? 'ENTREGA EN RUTA' : 'VENTANILLA'}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 block mb-1">Estado GPS</label>
                                            <div className={`px-3 py-1 rounded-full text-xs font-bold inline-block ${selectedKit.gpsStatus === 'TIENE GPS' ? 'bg-green-100 text-green-700' : selectedKit.gpsStatus === 'GPS PENDIENTE' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
                                                {selectedKit.gpsStatus || 'SIN GPS'}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 block mb-1">Contact Center</label>
                                            <div className="font-medium">{selectedKit.contactCenter || 'No asignado'}</div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 block mb-1">Digitador</label>
                                            <div className="font-medium">{selectedKit.digitador}</div>
                                        </div>
                                    </div>
                                    
                                    {selectedKit.observations && (
                                        <div className="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-100">
                                            <label className="text-xs font-bold text-amber-600 block mb-1">Observaciones</label>
                                            <div className="text-sm">{selectedKit.observations}</div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Medicamentos */}
                                <div className="border border-slate-200 rounded-xl p-4">
                                    <h4 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2"><Icons.Box size={16}/> Medicamentos ({selectedKit.triggerMeds})</h4>
                                    <div className="space-y-2">
                                        {selectedKit.medicamentos?.map((med, idx) => (
                                            <div key={idx} className="flex items-center gap-4 p-3 bg-white border border-slate-100 rounded-lg">
                                                <div className="flex-1">
                                                    <div className="font-medium text-slate-800 text-sm">{med.nombre || 'Sin nombre'}</div>
                                                    <div className="text-xs text-slate-500 mt-1">ID Receta: {med.idReceta || 'N/A'}</div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-lg font-bold text-turquoise-600">{med.cantidad || '0'}</div>
                                                    <div className="text-xs text-slate-400">cantidad</div>
                                                </div>
                                            </div>
                                        ))}
                                        {(!selectedKit.medicamentos || selectedKit.medicamentos.length === 0) && (
                                            <div className="text-center text-slate-400 py-4 italic">No hay medicamentos registrados</div>
                                        )}
                                    </div>
                                    
                                    {selectedKit.isRefrigerated && (
                                        <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center justify-between">
                                            <div>
                                                <div className="font-bold text-blue-700 flex items-center gap-2">
                                                    <Icons.Box size={16}/> CONTIENE REFRIGERADO
                                                </div>
                                                <div className="text-xs text-blue-600">Mantener cadena de frío</div>
                                            </div>
                                            <div className="text-2xl font-bold text-blue-700">{selectedKit.cantRefriGlobal || '1'}</div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Botones de acción */}
                                <div className="flex gap-3 pt-4 border-t border-slate-200">
                                    <button 
                                        onClick={() => printKitFromReports(selectedKit, selectedKit.deliveryMode)}
                                        className="flex-1 bg-slate-700 text-white py-2.5 rounded-lg font-medium flex items-center justify-center gap-2"
                                    >
                                        <Icons.Printer size={16}/> Imprimir
                                    </button>
                                    <button 
                                        onClick={() => handleEditKitFromReports(selectedKit)}
                                        className="flex-1 bg-orange-600 text-white py-2.5 rounded-lg font-medium flex items-center justify-center gap-2"
                                    >
                                        <Icons.Edit size={16}/> Editar Kit
                                    </button>
                                </div>
                            </div>
                        )}
                    </Modal>

                    {/* Contenido principal */}
                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {selectedKit ? (
                            // Vista de detalle del kit (ya manejada por el modal)
                            <div className="text-center py-10 text-slate-400">
                                Redirigiendo a modal de detalles...
                            </div>
                        ) : selectedDay ? (
                            // Lista de kits del día seleccionado
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.map(kit => (
                                        <div 
                                            key={kit.id} 
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:shadow-md transition-all"
                                        >
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="font-bold text-slate-800 text-sm truncate">{kit.nombre}</div>
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${kit.deliveryMode === 'ruta' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla'}
                                                </span>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                <div className="text-xs text-slate-500 flex items-center gap-2">
                                                    <span className="font-mono bg-slate-100 px-2 py-0.5 rounded">{kit.dni}</span>
                                                    <span className="text-turquoise-600 font-bold">{kit.medicamentos?.length || 0} meds</span>
                                                </div>
                                                <div className="text-xs text-slate-400 flex justify-between">
                                                    <span>{kit.horaOperaciones || '--:--'}</span>
                                                    <span>{kit.digitador}</span>
                                                </div>
                                                {kit.isRefrigerated && (
                                                    <div className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado: {kit.cantRefriGlobal || 1}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 pt-2 border-t border-slate-100">
                                                <button 
                                                    onClick={() => { setSelectedKit(kit); setShowKitModal(true); }}
                                                    className="flex-1 bg-slate-100 text-slate-700 py-1.5 rounded text-xs font-medium hover:bg-slate-200 transition-colors"
                                                >
                                                    Ver
                                                </button>
                                                <button 
                                                    onClick={() => printKitFromReports(kit, kit.deliveryMode)}
                                                    className="flex-1 bg-slate-700 text-white py-1.5 rounded text-xs font-medium hover:bg-slate-800 transition-colors flex items-center justify-center gap-1"
                                                >
                                                    <Icons.Printer size={12}/> Imprimir
                                                </button>
                                                <button 
                                                    onClick={() => handleEditKitFromReports(kit)}
                                                    className="flex-1 bg-orange-600 text-white py-1.5 rounded text-xs font-medium hover:bg-orange-700 transition-colors flex items-center justify-center gap-1"
                                                >
                                                    <Icons.Edit size={12}/> Editar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : selectedMonth ? (
                            // Vista de días del mes seleccionado
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    {Object.entries(groupedByMonth[selectedMonth]?.days || {}).sort((a, b) => b[0].localeCompare(a[0])).map(([date, dayData]) => (
                                        <div 
                                            key={date} 
                                            onClick={() => setSelectedDay(date)}
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer flex flex-col items-center text-center gap-3 transition-all group"
                                        >
                                            <div className="bg-turquoise-100 p-3 rounded-full text-turquoise-600 group-hover:scale-110 transition-transform">
                                                <Icons.Calendar size={24}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-sm text-slate-700">{dayData.display}</h4>
                                                <p className="text-[10px] text-slate-400 mt-1">{dayData.kits.length} Kits</p>
                                            </div>
                                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); downloadDayExcel(dayData.kits); }}
                                                    className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full hover:bg-green-200 transition-colors"
                                                >
                                                    <Icons.Download size={10}/> Excel
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            // Vista principal - Carpetas por mes
                            <div className="space-y-6">
                                {/* Carpeta de meses */}
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                    {Object.entries(groupedByMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([monthKey, monthData]) => (
                                        <div 
                                            key={monthKey} 
                                            onClick={() => setSelectedMonth(monthKey)}
                                            className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-turquoise-400 hover:shadow-lg cursor-pointer flex flex-col items-center text-center gap-4 transition-all group"
                                        >
                                            <div className="bg-gradient-to-br from-turquoise-500 to-clinical-500 p-4 rounded-2xl text-white group-hover:scale-110 transition-transform">
                                                <Icons.Folder size={32}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-lg text-slate-800">{monthData.display}</h4>
                                                <p className="text-sm text-slate-400 mt-1">
                                                    {Object.keys(monthData.days).length} días • {Object.values(monthData.days).reduce((acc, day) => acc + day.kits.length, 0)} kits
                                                </p>
                                            </div>
                                            <div className="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                                {monthKey === `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}` ? 'MES ACTUAL' : 'HISTÓRICO'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: PACIENTES (MODIFICADO - LECTURAS CONTROLADAS) ---
        const PatientManagementBlock = ({ patients, kits, medicines, onAddPatient, onUpdatePatient, onDeletePatient, onSaveKit, onDeleteKit, currentUser, userRole, contacts }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [selectedPatientFullData, setSelectedPatientFullData] = useState(null);
            const [showPatientForm, setShowPatientForm] = useState(false);
            const [editingPatientId, setEditingPatientId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            
            // Estados para paginación
            const [currentPage, setCurrentPage] = useState(1);
            const [patientsPerPage] = useState(50);
            
            // Estados para Impresión (ACTUALIZADO solo vertical)
            const [printKitData, setPrintKitData] = useState(null);
            const [printMode, setPrintMode] = useState(null);
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [vinetaCacheKey, setVinetaCacheKey] = useState(null);

            // Estados para visualización
            const [isViewMode, setIsViewMode] = useState(false);

            // Kit Form State
            const initialKit = { 
                fechaArmado: new Date().toISOString().split('T')[0], 
                fechaEntregaLogistica: '', 
                fechaEntregaKit: '', 
                horaOperaciones: '', 
                contactCenter: '', 
                triggerMeds: '', 
                medicamentos: [],
                digitador: '',
                deliveryMode: '', 
                selectedPhones: [], 
                otherPhoneEnabled: false, 
                otherPhone: '',
                addressConfirmed: true, 
                secondaryAddress: '',
                gpsStatus: 'SIN GPS', 
                observationsEnabled: false,
                observations: '',
                isRefrigerated: false, 
                cantRefriGlobal: '' 
            };
            const [kitData, setKitData] = useState(initialKit);
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);
            const [patientSnapshotUnsubscribe, setPatientSnapshotUnsubscribe] = useState(null);

            // Patient Form State
            const initialPatient = { 
                dni: '', 
                nombre: '', 
                telefono: '', 
                direccion: '', 
                familiar: '', 
                telefonoFamiliar: '', 
                descripcionMunicipio: '', 
                tipoAfiliado: 'AFILIADO DIRECTO',
                nAfiliacion: '' 
            };
            const [patientForm, setPatientForm] = useState(initialPatient);

            // Verificar si hay un kit para editar desde reportes
            useEffect(() => {
                const editKitData = sessionStorage.getItem('editKitFromReports');
                if (editKitData) {
                    const { kitData, patientId } = JSON.parse(editKitData);
                    const patient = patients.find(p => p.id === patientId);
                    if (patient && kitData) {
                        handleSelectPatient(patient);
                        setKitData({...kitData, otherPhoneEnabled: !!kitData.otherPhone});
                        setEditingKitId(kitData.id);
                        setIsViewMode(false);
                        setShowKitForm(true);
                    }
                    sessionStorage.removeItem('editKitFromReports');
                }
            }, [patients]);

            // Función para cargar datos completos del paciente con lectura controlada
            const loadPatientFullData = async (patientId) => {
                // Limpiar suscripción anterior si existe
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                }
                
                try {
                    const patientDoc = await getDoc(doc(db, 'prod_patients', patientId));
                    if (patientDoc.exists()) {
                        const fullData = { id: patientDoc.id, ...patientDoc.data() };
                        setSelectedPatientFullData(fullData);
                        
                        // Crear una suscripción en tiempo real SOLO para este paciente
                        const unsubscribe = onSnapshot(doc(db, 'prod_patients', patientId), (doc) => {
                            if (doc.exists()) {
                                setSelectedPatientFullData({ id: doc.id, ...doc.data() });
                            }
                        });
                        
                        setPatientSnapshotUnsubscribe(() => unsubscribe);
                    }
                } catch (error) {
                    console.error("Error cargando datos del paciente:", error);
                }
            };

            // Manejar selección de paciente
            const handleSelectPatient = async (patient) => {
                setSelectedPatient(patient);
                // Cargar datos completos del paciente
                await loadPatientFullData(patient.id);
            };

            // Limpiar suscripción cuando se deselecciona el paciente
            useEffect(() => {
                return () => {
                    if (patientSnapshotUnsubscribe) {
                        patientSnapshotUnsubscribe();
                    }
                };
            }, [patientSnapshotUnsubscribe]);

            // Filtrar pacientes con paginación
            const filteredPatients = useMemo(() => {
                return patients.filter(p => 
                    (p.nombre?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                     p.dni?.includes(searchTerm))
                );
            }, [patients, searchTerm]);

            // Calcular pacientes para la página actual
            const indexOfLastPatient = currentPage * patientsPerPage;
            const indexOfFirstPatient = indexOfLastPatient - patientsPerPage;
            const currentPatients = filteredPatients.slice(indexOfFirstPatient, indexOfLastPatient);
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);

            const patientKits = selectedPatient ? kits.filter(k => k.patientId === selectedPatient.id) : [];

            // Excel Upload Handler
            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);
                    
                    let added = 0;
                    let skipped = 0;
                    let updated = 0;

                    for (const row of data) {
                        const pData = {
                            dni: String(row['DNI'] || row['dni'] || '').trim(),
                            nombre: String(row['NOMBRE'] || row['nombre'] || '').toUpperCase().trim(),
                            telefono: String(row['TELEFONO'] || row['telefono'] || '').trim(),
                            direccion: String(row['DIRECCION'] || row['direccion'] || '').toUpperCase().trim(),
                            familiar: String(row['FAMILIAR'] || row['familiar'] || '').toUpperCase().trim(),
                            telefonoFamiliar: String(row['TELEFONOFAMILIAR'] || row['telefonofamiliar'] || '').trim(),
                            descripcionMunicipio: String(row['DESCRIPCION_MUNICIPIO'] || row['descripcion_municipio'] || '').toUpperCase().trim(),
                            tipoAfiliado: String(row['TIPOAFILIADO'] || row['tipoafiliado'] || 'AFILIADO DIRECTO').toUpperCase().trim(),
                            nAfiliacion: String(row['DNI'] || row['dni'] || '').trim() 
                        };

                        if (!pData.dni) continue;

                        const existingPatient = patients.find(p => p.dni === pData.dni);

                        if (existingPatient) {
                            let needsUpdate = false;
                            const updates = {};
                            const checkAndFill = (field) => {
                                const dbValue = existingPatient[field];
                                const excelValue = pData[field];
                                if ((!dbValue || dbValue.trim() === '') && (excelValue && excelValue.trim() !== '')) {
                                    updates[field] = excelValue;
                                    needsUpdate = true;
                                }
                            };
                            checkAndFill('nombre'); checkAndFill('telefono'); checkAndFill('direccion');
                            checkAndFill('familiar'); checkAndFill('telefonoFamiliar'); checkAndFill('descripcionMunicipio');
                            
                            if ((!existingPatient.tipoAfiliado || existingPatient.tipoAfiliado === 'AFILIADO DIRECTO') && pData.tipoAfiliado && pData.tipoAfiliado !== 'AFILIADO DIRECTO') {
                                 updates.tipoAfiliado = pData.tipoAfiliado; needsUpdate = true;
                            }

                            if (needsUpdate) { await onUpdatePatient(existingPatient.id, updates); updated++; } 
                            else { skipped++; }
                        } else {
                            await onAddPatient(pData); added++;
                        }
                    }
                    alert(`Resumen de Carga:\n\n✅ Pacientes Agregados: ${added}\n🔄 Pacientes Modificados: ${updated}\n⏭️ Pacientes Omitidos: ${skipped}`);
                };
                reader.readAsBinaryString(file);
                e.target.value = null; 
            };

            // Handlers
            const handlePatientSubmit = (e) => { 
                e.preventDefault(); 
                if (editingPatientId) onUpdatePatient(editingPatientId, patientForm); 
                else onAddPatient(patientForm); 
                closePatientForm(); 
            };
            const closePatientForm = () => { setPatientForm(initialPatient); setEditingPatientId(null); setShowPatientForm(false); };
            const openEditPatient = async (e, p) => { 
                e.stopPropagation(); 
                // Cargar datos completos del paciente
                try {
                    const patientDoc = await getDoc(doc(db, 'prod_patients', p.id));
                    if (patientDoc.exists()) {
                        setPatientForm({ id: p.id, ...patientDoc.data() });
                    } else {
                        setPatientForm(p);
                    }
                } catch (error) {
                    console.error("Error cargando paciente:", error);
                    setPatientForm(p);
                }
                setEditingPatientId(p.id); 
                setShowPatientForm(true); 
            };

            const handleKitSubmit = async (e) => {
                e.preventDefault();
                if (isViewMode) { closeKitForm(); return; } 
                const finalData = { ...kitData, digitador: currentUser.name, dni: selectedPatient.dni, nombre: selectedPatient.nombre }; 
                if (!editingKitId && !finalData.horaOperaciones) {
                    finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
                }
                
                const kitId = await onSaveKit(editingKitId, finalData, selectedPatient.id, !!editingKitId);
                // Si es una edición, eliminamos las viñetas cacheadas para este kit
                if (editingKitId) {
                    // Eliminar viñetas cacheadas para todos los modos
                    ['ventanilla', 'ruta', 'refri'].forEach(mode => {
                        localStorage.removeItem(`vineta_${editingKitId}_${mode}`);
                    });
                }
                closeKitForm();
            };
            const closeKitForm = () => { 
                setKitData(initialKit); 
                setEditingKitId(null); 
                setShowKitForm(false); 
                setIsViewMode(false); 
                // Limpiar suscripción del paciente cuando se cierra el formulario
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };
            const openNewKit = () => {
                setKitData({ ...initialKit, fechaArmado: new Date().toISOString().split('T')[0] });
                setIsViewMode(false);
                setShowKitForm(true);
            };
            const openEditKit = (k, viewOnly = false) => { 
                setKitData({...k, otherPhoneEnabled: !!k.otherPhone}); 
                setEditingKitId(k.id); 
                setIsViewMode(viewOnly);
                setShowKitForm(true); 
            };

            // Print Logic ACTUALIZADA solo vertical
            const openPrintModal = (kit) => {
                setPrintKitData(kit);
                setShowPrintModal(true);
                // Generar clave para el cache
                const cacheKey = `vineta_${kit.id}`;
                setVinetaCacheKey(cacheKey);
            };

            const triggerPrint = (mode) => {
                setPrintMode(mode);
                
                // Verificar si hay caché de viñeta
                const cacheKey = `vineta_${printKitData.id}_${mode}`;
                const cachedVineta = localStorage.getItem(cacheKey);
                
                let printContent;
                
                if (cachedVineta) {
                    // Usar caché
                    printContent = cachedVineta;
                } else {
                    // Generar nuevo contenido
                    const isRefri = mode === 'refri';
                    
                    printContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <title>Impresión Kit - ${mode === 'ventanilla' ? 'Ventanilla' : mode === 'ruta' ? 'Ruta' : 'Refrigerado'}</title>
                            <style>
                                @media print {
                                    @page {
                                        size: 71mm 210mm;
                                        margin: 10mm 1mm;
                                    }
                                    body {
                                        font-family: 'Arial', sans-serif;
                                        margin: 0;
                                        padding: 0;
                                        width: 69mm;
                                        height: 190mm;
                                        font-size: 9px;
                                        color: #000;
                                        background: white;
                                        box-sizing: border-box;
                                    }
                                    .container {
                                        width: 100%;
                                        height: 100%;
                                        padding: 1mm;
                                        box-sizing: border-box;
                                        position: relative;
                                    }
                                    .header {
                                        text-align: center;
                                        border-bottom: 1px solid #000;
                                        padding-bottom: 1.5mm;
                                        margin-bottom: 2mm;
                                    }
                                    .logo-section {
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 1.5mm;
                                    }
                                    .logo {
                                        width: 15mm;
                                        height: 15mm;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    }
                                    .logo img {
                                        max-width: 100%;
                                        max-height: 100%;
                                        object-fit: contain;
                                    }
                                    .header-title {
                                        flex: 1;
                                        text-align: center;
                                        font-weight: bold;
                                        font-size: 8px;
                                        line-height: 1.2;
                                        padding: 0 2mm;
                                    }
                                    .section-title {
                                        background: #000;
                                        color: white;
                                        text-align: center;
                                        font-weight: bold;
                                        font-size: 8px;
                                        padding: 1mm;
                                        margin: 2mm 0;
                                        border-radius: 1mm;
                                    }
                                    .patient-info {
                                        border: 1px solid #000;
                                        border-radius: 1.5mm;
                                        padding: 2mm;
                                        margin-bottom: 2mm;
                                    }
                                    .info-label {
                                        font-weight: bold;
                                        font-size: 7px;
                                        color: #666;
                                        display: block;
                                        margin-bottom: 0.5mm;
                                    }
                                    .info-value {
                                        font-size: 10px;
                                        font-weight: bold;
                                        color: #000;
                                        margin-bottom: 1.5mm;
                                    }
                                    .highlight {
                                        font-size: 11px;
                                        font-weight: bold;
                                        color: #000;
                                        background: #f5f5f5;
                                        padding: 1.5mm;
                                        border-radius: 1mm;
                                        margin: 1.5mm 0;
                                    }
                                    .contact-info {
                                        border: 1px solid #000;
                                        border-radius: 1.5mm;
                                        padding: 2mm;
                                        margin-bottom: 2mm;
                                    }
                                    .delivery-display {
                                        font-size: 14px;
                                        font-weight: bold;
                                        text-align: center;
                                        border: 2px dashed #000;
                                        padding: 3mm;
                                        margin: 3mm 0;
                                        border-radius: 2mm;
                                    }
                                    .refrigerado-alert {
                                        border: 2px solid #0066cc;
                                        background: #e6f7ff;
                                        border-radius: 2mm;
                                        padding: 2mm;
                                        text-align: center;
                                        margin: 2mm 0;
                                    }
                                    .footer {
                                        position: absolute;
                                        bottom: 0;
                                        left: 0;
                                        right: 0;
                                        border-top: 1px solid #000;
                                        padding-top: 1mm;
                                        font-size: 7px;
                                        text-align: center;
                                        color: #666;
                                    }
                                    .grid-2 {
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 2mm;
                                        margin: 2mm 0;
                                    }
                                    .address-section {
                                        background: #f9f9f9;
                                        border: 1px solid #ccc;
                                        border-radius: 1.5mm;
                                        padding: 2mm;
                                        margin: 2mm 0;
                                    }
                                    .address-title {
                                        font-weight: bold;
                                        font-size: 9px;
                                        color: #333;
                                        margin-bottom: 1mm;
                                    }
                                    .address-content {
                                        font-size: 10px;
                                        font-weight: bold;
                                        color: #000;
                                        line-height: 1.3;
                                    }
                                    .observations-section {
                                        background: #fff8e1;
                                        border: 1px solid #ffd54f;
                                        border-radius: 1.5mm;
                                        padding: 2mm;
                                        margin: 2mm 0;
                                        font-size: 8px;
                                    }
                                    .important-note {
                                        font-weight: bold;
                                        color: #d32f2f;
                                        font-size: 8px;
                                        text-align: center;
                                        margin: 1.5mm 0;
                                    }
                                    .patient-name-large {
                                        font-size: 12px;
                                        font-weight: bold;
                                        text-align: center;
                                        margin-bottom: 1.5mm;
                                        background: #e3f2fd;
                                        padding: 1.5mm;
                                        border-radius: 1mm;
                                    }
                                    .patient-dni-large {
                                        font-size: 11px;
                                        font-family: 'Courier New', monospace;
                                        text-align: center;
                                        margin-bottom: 2mm;
                                        background: #f3e5f5;
                                        padding: 1.5mm;
                                        border-radius: 1mm;
                                    }
                                    .medicamentos-count {
                                        font-size: 16px;
                                        font-weight: bold;
                                        text-align: center;
                                        color: #1976d2;
                                        margin: 2mm 0;
                                    }
                                    .contact-center {
                                        background: #e8f5e9;
                                        border: 1px solid #4caf50;
                                        border-radius: 1.5mm;
                                        padding: 1.5mm;
                                        margin: 1.5mm 0;
                                        font-size: 8px;
                                        text-align: center;
                                    }
                                    .gps-status {
                                        background: #fff3e0;
                                        border: 1px solid #ff9800;
                                        border-radius: 1.5mm;
                                        padding: 1.5mm;
                                        margin: 1.5mm 0;
                                        font-size: 9px;
                                        font-weight: bold;
                                        text-align: center;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <!-- HEADER CON LOGOS -->
                                <div class="header">
                                    <div class="logo-section">
                                        <div class="logo">
                                            <img src="https://raw.githubusercontent.com/jose50440/bita/ae8b4188532504b6c4057505172b68be697b2851/img/logo1.png" 
                                                 alt="Logo IHSS">
                                        </div>
                                        <div class="header-title">
                                            DEPARTAMENTO DE DISPENSACIÓN<br>
                                            DE MEDICAMENTOS A DOMICILIO<br>
                                            <strong>${mode === 'ventanilla' ? 'VENTANILLA' : mode === 'ruta' ? 'ENTREGA EN RUTA' : 'REFRIGERADO'}</strong>
                                        </div>
                                        <div class="logo">
                                            <img src="https://raw.githubusercontent.com/jose50440/bita/ae8b4188532504b6c4057505172b68be697b2851/img/logo2.png" 
                                                 alt="Logo Logística">
                                        </div>
                                    </div>
                                </div>

                                <!-- CONTENIDO SEGÚN MODO -->
                                ${isRefri ? `
                                    <!-- PLANTILLA REFRIGERADO -->
                                    <div class="section-title">❄️ REFRIGERADO ❄️</div>
                                    <div class="patient-info">
                                        <div class="patient-name-large">${printKitData.nombre}</div>
                                        <div class="patient-dni-large">${printKitData.dni}</div>
                                        <div class="grid-2">
                                            <div>
                                                <div class="info-label">FECHA ARMADO</div>
                                                <div class="info-value">${printKitData.fechaArmado}</div>
                                            </div>
                                            <div>
                                                <div class="info-label">CANTIDAD</div>
                                                <div class="medicamentos-count">${printKitData.cantRefriGlobal || '1'}</div>
                                            </div>
                                        </div>
                                        <div class="important-note">MANTENER CADENA DE FRÍO</div>
                                    </div>
                                    <div class="refrigerado-alert">
                                        <div style="font-size: 10px; font-weight: bold;">CONTENIDO REFRIGERADO</div>
                                        <div style="font-size: 14px; font-weight: bold; margin: 2mm 0;">CANTIDAD: ${printKitData.cantRefriGlobal || '1'}</div>
                                    </div>
                                ` : `
                                    <!-- PLANTILLA VENTANILLA/RUTA -->
                                    <div class="section-title">${mode === 'ventanilla' ? 'ENTREGA EN VENTANILLA' : 'ENTREGA EN RUTA'}</div>
                                    
                                    <!-- INFORMACIÓN DEL PACIENTE -->
                                    <div class="patient-info">
                                        <div class="patient-name-large">${printKitData.nombre}</div>
                                        <div class="patient-dni-large">${printKitData.dni}</div>
                                        
                                        ${mode === 'ruta' ? `
                                        <div class="address-section">
                                            <div class="address-title">DIRECCIÓN DE ENTREGA:</div>
                                            <div class="address-content">${printKitData.addressConfirmed ? (selectedPatientFullData?.direccion || '') : printKitData.secondaryAddress}</div>
                                        </div>
                                        ` : ''}
                                        
                                        <div class="grid-2">
                                            <div>
                                                <div class="info-label">FECHA ARMADO</div>
                                                <div class="info-value">${printKitData.fechaArmado}</div>
                                            </div>
                                            <div>
                                                <div class="info-label">FECHA ENTREGA KIT</div>
                                                <div class="info-value">${printKitData.fechaEntregaKit || 'PENDIENTE'}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CONTACTOS Y SEGUIMIENTO -->
                                    <div class="contact-info">
                                        <div class="info-label">TELÉFONOS DE CONTACTO</div>
                                        <div style="margin-bottom: 1.5mm;">
                                            ${(printKitData.selectedPhones?.length > 0 || printKitData.otherPhone) ? 
                                                [...(printKitData.selectedPhones || []), printKitData.otherPhone].filter(Boolean).map(phone => 
                                                    `<div style="margin: 0.5mm 0; font-size: 9px;">📞 ${phone}</div>`
                                                ).join('') : '<div style="font-size: 8px; color: #666;">No hay teléfonos registrados</div>'}
                                        </div>
                                        
                                        ${printKitData.contactCenter ? `
                                        <div class="contact-center">
                                            <div class="info-label">CONTACT CENTER</div>
                                            <div style="font-weight: bold; font-size: 9px;">${printKitData.contactCenter}</div>
                                        </div>
                                        ` : ''}
                                    </div>

                                    <!-- MODO DE ENTREGA -->
                                    <div class="delivery-display">
                                        ${mode === 'ventanilla' ? '📦 VENTANILLA' : '🚚 ENTREGA EN RUTA'}
                                    </div>

                                    ${mode === 'ruta' ? `
                                    <!-- INFORMACIÓN ADICIONAL PARA RUTA -->
                                    <div class="gps-status">
                                        <div class="info-label">ESTADO GPS</div>
                                        <div style="font-size: 10px;">${printKitData.gpsStatus || 'SIN GPS'}</div>
                                    </div>
                                    
                                    ${printKitData.observations ? `
                                    <div class="observations-section">
                                        <div class="info-label">OBSERVACIONES DE ENTREGA</div>
                                        <div style="font-size: 9px; font-style: italic; line-height: 1.3;">${printKitData.observations}</div>
                                    </div>
                                    ` : ''}
                                    ` : ''}

                                    <!-- INFORMACIÓN DE MEDICAMENTOS -->
                                    <div style="border: 1px solid #ccc; border-radius: 1.5mm; padding: 2mm; margin: 2mm 0;">
                                        <div class="info-label">MEDICAMENTOS</div>
                                        <div class="medicamentos-count">${printKitData.triggerMeds || printKitData.medicamentos?.length || '0'}</div>
                                        ${printKitData.medicamentos?.slice(0, 3).map(med => 
                                            `<div style="font-size: 8px; margin: 0.5mm 0;">• ${med.nombre || 'Sin nombre'} (${med.cantidad || '0'})</div>`
                                        ).join('')}
                                        ${printKitData.medicamentos?.length > 3 ? 
                                            `<div style="font-size: 7px; color: #666; margin-top: 1mm;">+ ${printKitData.medicamentos.length - 3} medicamentos más</div>` : ''}
                                    </div>

                                    ${printKitData.isRefrigerated ? `
                                    <div class="refrigerado-alert">
                                        <div style="font-size: 9px; font-weight: bold;">❄️ CONTIENE REFRIGERADO ❄️</div>
                                        <div style="font-size: 11px; font-weight: bold; margin: 1mm 0;">CANTIDAD: ${printKitData.cantRefriGlobal || '1'}</div>
                                        <div style="font-size: 8px;">Mantener cadena de frío</div>
                                    </div>
                                    ` : ''}
                                `}

                                <!-- FOOTER -->
                                <div class="footer">
                                    <div>DIGITADOR: ${printKitData.digitador}</div>
                                    <div>${new Date().toLocaleDateString('es-ES')} ${new Date().toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})}</div>
                                    <div style="font-size: 6px; margin-top: 0.5mm;">Impreso desde Bitácora de Producción</div>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Guardar en caché
                    localStorage.setItem(cacheKey, printContent);
                }
                
                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'absolute';
                printFrame.style.width = '0';
                printFrame.style.height = '0';
                printFrame.style.border = '0';
                
                document.body.appendChild(printFrame);
                
                printFrame.contentDocument.write(printContent);
                printFrame.contentDocument.close();
                
                setTimeout(() => {
                    printFrame.contentWindow.focus();
                    printFrame.contentWindow.print();
                    
                    // Limpiar
                    setTimeout(() => {
                        document.body.removeChild(printFrame);
                        setShowPrintModal(false);
                        setPrintMode(null);
                    }, 100);
                }, 500);
            };

            const handleMedChange = (idx, field, val) => {
                const newMeds = [...kitData.medicamentos];
                newMeds[idx] = { ...newMeds[idx], [field]: val };
                setKitData({...kitData, medicamentos: newMeds});
            };
            const handleTriggerMeds = (val) => {
                const parsed = parseInt(val, 10);
                const count = isNaN(parsed) ? 0 : parsed;
                const safeCount = Math.min(Math.max(count, 0), 30);
                const currentMeds = kitData.medicamentos || [];
                let newMeds = [];
                if (safeCount > currentMeds.length) {
                    newMeds = [...currentMeds, ...Array(safeCount - currentMeds.length).fill({ nombre: '', idReceta: '', cantidad: '', cantRefri: '' })];
                } else {
                    newMeds = currentMeds.slice(0, safeCount);
                }
                setKitData({...kitData, triggerMeds: val, medicamentos: newMeds});
            };

            const togglePhoneSelection = (phone) => {
                const current = kitData.selectedPhones || [];
                if(current.includes(phone)) setKitData({...kitData, selectedPhones: current.filter(p => p !== phone)});
                else setKitData({...kitData, selectedPhones: [...current, phone]});
            };

            // Función para refrescar viñeta - CORREGIDA
            const refreshVineta = () => {
                if (printKitData && printMode) {
                    const cacheKey = `vineta_${printKitData.id}_${printMode}`;
                    localStorage.removeItem(cacheKey);
                    triggerPrint(printMode);
                }
            };

            // Función para volver a la lista de pacientes
            const handleBackToList = () => {
                setSelectedPatient(null);
                setSelectedPatientFullData(null);
                // Limpiar suscripción
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };

            if (selectedPatient) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft h-full flex flex-col animate-in border-0 bg-white">
                        
                        <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                        
                        {/* MODAL DE SELECCIÓN DE IMPRESIÓN ACTUALIZADO */}
                        {showPrintModal && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-xs text-center">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center justify-center gap-2"><Icons.Printer/> Imprimir Kit</h3>
                                    
                                    <div className="mb-4">
                                        <p className="text-sm font-bold text-slate-600 mb-2">Orientación: Vertical</p>
                                        <p className="text-xs text-slate-500">Tamaño papel: 71mm x 210mm</p>
                                        <p className="text-xs text-slate-400 mt-1">Márgenes: 1cm arriba/abajo, 0.1cm lados</p>
                                    </div>
                                    
                                    <div className="space-y-3 mb-4">
                                        <button 
                                            onClick={() => triggerPrint('ventanilla')} 
                                            disabled={printKitData.deliveryMode !== 'ventanilla'}
                                            className={`w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 ${printKitData.deliveryMode === 'ventanilla' ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}`}
                                        >
                                            <div className="w-6 h-6 bg-white rounded flex items-center justify-center text-indigo-600">📦</div>
                                            <span>Ventanilla</span>
                                        </button>
                                        <button 
                                            onClick={() => triggerPrint('ruta')} 
                                            disabled={printKitData.deliveryMode !== 'ruta'}
                                            className={`w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 ${printKitData.deliveryMode === 'ruta' ? 'bg-emerald-600 text-white hover:bg-emerald-700 shadow-md' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}`}
                                        >
                                            <div className="w-6 h-6 bg-white rounded flex items-center justify-center text-emerald-600">🚚</div>
                                            <span>Ruta</span>
                                        </button>
                                        <button 
                                            onClick={() => triggerPrint('refri')} 
                                            disabled={!printKitData.isRefrigerated}
                                            className={`w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 ${printKitData.isRefrigerated ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}`}
                                        >
                                            <div className="w-6 h-6 bg-white rounded flex items-center justify-center text-blue-600">❄️</div>
                                            <span>Refrigerado</span>
                                        </button>
                                    </div>
                                    
                                    {/* Botón para refrescar viñeta - SOLO VISIBLE CUANDO HAY UN MODO SELECCIONADO */}
                                    {printMode && (
                                        <button 
                                            onClick={refreshVineta}
                                            className="w-full py-2.5 bg-amber-600 text-white rounded-lg font-bold text-xs hover:bg-amber-700 transition flex items-center justify-center gap-2 shadow-sm mb-3"
                                        >
                                            <Icons.RefreshCw size={14}/> Refrescar Viñeta
                                        </button>
                                    )}
                                    
                                    <button onClick={() => setShowPrintModal(false)} className="text-sm text-slate-500 hover:text-slate-800 underline">Cancelar</button>
                                </div>
                            </div>
                        )}

                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={handleBackToList} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect"><Icons.ArrowLeft size={20} /></button>
                                <div><h3 className="font-bold text-lg text-slate-800 brand-font leading-none">{selectedPatient.nombre}</h3><p className="text-[10px] text-slate-400 font-mono mt-0.5">DNI: {selectedPatient.dni}</p></div>
                            </div>
                            <button onClick={openNewKit} className="flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect bg-turquoise-600 hover:bg-turquoise-700 text-white"><Icons.FolderPlus size={16}/> Nuevo Kit</button>
                        </div>

                        <Modal isOpen={showKitForm} onClose={closeKitForm} title={isViewMode ? "Detalle del Kit" : (editingKitId ? "Editar Kit" : "Nuevo Kit de Producción")} maxWidth="max-w-4xl">
                            {/* FORMULARIO KIT */}
                            <form onSubmit={handleKitSubmit} className="space-y-6">
                                <fieldset disabled={isViewMode} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b border-slate-100 pb-4 bg-slate-50 p-4 rounded-xl">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI del Paciente</label>
                                            <input type="text" value={selectedPatient.dni} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Paciente</label>
                                            <input type="text" value={selectedPatient.nombre} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                    </div>

                                    <div className="flex gap-4 justify-center pb-4 border-b border-slate-100">
                                        <button type="button" onClick={()=>setKitData({...kitData, deliveryMode: 'ventanilla'})} className={`px-6 py-2 rounded-lg font-bold transition-all ${kitData.deliveryMode === 'ventanilla' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>Ventanilla</button>
                                        <button type="button" onClick={()=>setKitData({...kitData, deliveryMode: 'ruta'})} className={`px-6 py-2 rounded-lg font-bold transition-all ${kitData.deliveryMode === 'ruta' ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>Ruta</button>
                                    </div>

                                    <div className={`transition-all duration-300 ${kitData.deliveryMode === 'ventanilla' ? 'opacity-40 pointer-events-none grayscale' : ''}`}>
                                        <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Confirmar Datos de Contacto</h5>
                                            <div className="space-y-2 mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block">Seleccionar Teléfonos a Llamar:</label>
                                                {selectedPatientFullData?.telefono && (
                                                    <label className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200 cursor-pointer">
                                                        <input type="checkbox" checked={kitData.selectedPhones?.includes(selectedPatientFullData.telefono)} onChange={()=>togglePhoneSelection(selectedPatientFullData.telefono)} />
                                                        <span className="text-sm">{selectedPatientFullData.telefono} (Personal)</span>
                                                    </label>
                                                )}
                                                {selectedPatientFullData?.telefonoFamiliar && (
                                                    <label className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200 cursor-pointer">
                                                        <input type="checkbox" checked={kitData.selectedPhones?.includes(selectedPatientFullData.telefonoFamiliar)} onChange={()=>togglePhoneSelection(selectedPatientFullData.telefonoFamiliar)} />
                                                        <span className="text-sm">{selectedPatientFullData.telefonoFamiliar} (Familiar)</span>
                                                    </label>
                                                )}
                                                <div className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200">
                                                    <input type="checkbox" checked={kitData.otherPhoneEnabled} onChange={(e) => setKitData({...kitData, otherPhoneEnabled: e.target.checked, otherPhone: e.target.checked ? kitData.otherPhone : ''})} />
                                                    <span className="text-sm whitespace-nowrap">Otro:</span>
                                                    <input type="text" className={`w-full p-1 border-b border-slate-300 outline-none text-sm ${!kitData.otherPhoneEnabled ? 'bg-slate-50 text-slate-400 cursor-not-allowed' : ''}`} placeholder="Ingresar otro número" value={kitData.otherPhone} onChange={e=>setKitData({...kitData, otherPhone:e.target.value})} disabled={!kitData.otherPhoneEnabled} />
                                                </div>
                                            </div>
                                            <div className="mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Confirmar Ubicación (Primaria: {selectedPatientFullData?.direccion || 'No disponible'})</label>
                                                <div className="flex items-center gap-4 mb-2">
                                                    <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="addrConf" checked={kitData.addressConfirmed === true} onChange={()=>setKitData({...kitData, addressConfirmed: true})} /> <span className="text-sm font-bold text-green-600">Sí, es correcta</span></label>
                                                    <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="addrConf" checked={kitData.addressConfirmed === false} onChange={()=>setKitData({...kitData, addressConfirmed: false})} /> <span className="text-sm font-bold text-red-500">No, nueva dirección</span></label>
                                                </div>
                                                {!kitData.addressConfirmed && (
                                                    <div className="animate-in mb-3">
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Dirección Secundaria (Ruta)</label>
                                                        <textarea className="w-full p-2 border rounded text-sm bg-white" rows="2" value={kitData.secondaryAddress} onChange={e=>setKitData({...kitData, secondaryAddress:e.target.value})} placeholder="Ingrese la nueva dirección de entrega..."></textarea>
                                                    </div>
                                                )}
                                                
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Estado GPS</label>
                                                    <select className="w-full p-2 border rounded text-sm bg-white font-bold text-slate-700" value={kitData.gpsStatus} onChange={e=>setKitData({...kitData, gpsStatus:e.target.value})}>
                                                        <option value="TIENE GPS">TIENE GPS</option>
                                                        <option value="GPS PENDIENTE">GPS PENDIENTE</option>
                                                        <option value="SIN GPS">SIN GPS</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                                    <input type="checkbox" checked={kitData.observationsEnabled} onChange={e=>setKitData({...kitData, observationsEnabled:e.target.checked})} />
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Agregar Observaciones de Entrega</span>
                                                </label>
                                                {kitData.observationsEnabled && (
                                                    <textarea className="w-full p-2 border rounded text-sm bg-amber-50 border-amber-200" rows="2" value={kitData.observations} onChange={e=>setKitData({...kitData, observations:e.target.value})} placeholder="Ej: Casa de color verde, portón negro..."></textarea>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Logística</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Armado</label><input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaArmado} onChange={e=>setKitData({...kitData, fechaArmado:e.target.value})} required /></div>
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega a Logística</label><input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntregaLogistica} onChange={e=>setKitData({...kitData, fechaEntregaLogistica:e.target.value})} /></div>
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega de Kit (Paciente)</label><input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntregaKit} onChange={e=>setKitData({...kitData, fechaEntregaKit:e.target.value})} /></div>
                                            <div className="md:col-span-3">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center</label>
                                                <select className="w-full p-2 border rounded text-sm bg-white" value={kitData.contactCenter} onChange={e=>setKitData({...kitData, contactCenter:e.target.value})}>
                                                    <option value="">Seleccione...</option>
                                                    {contacts && contacts.map(c => (
                                                        <option key={c.id} value={`${c.name} --- ${c.phone}`}>{c.name} --- {c.phone}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="md:col-span-3"><label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Digitador</label><input type="text" className="w-full p-2 border rounded text-sm bg-slate-200 text-slate-500" value={currentUser.name} disabled /></div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                        <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-1">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Medicamentos</h5>
                                            <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" checked={kitData.isRefrigerated} onChange={e=>setKitData({...kitData, isRefrigerated: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">Refrigerado</span>
                                                </label>
                                                {kitData.isRefrigerated && (
                                                    <input type="number" placeholder="Cant." className="w-16 p-1 border rounded text-center text-xs bg-blue-50 border-blue-200 text-blue-700 font-bold outline-none" value={kitData.cantRefriGlobal} onChange={e=>setKitData({...kitData, cantRefriGlobal: e.target.value})} />
                                                )}
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500">% Medicamentos:</label>
                                                    <input type="text" className="w-20 p-1 border rounded text-center font-bold bg-white" value={kitData.triggerMeds} onChange={e=>handleTriggerMeds(e.target.value)} placeholder="Ej: 6/9" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            {kitData.medicamentos.map((med, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-lg border shadow-sm flex flex-col md:flex-row gap-2 items-end">
                                                    <div className="flex-1 w-full"><label className="text-[10px] font-bold text-slate-400 block">Medicamento</label><input list="medsList" className="w-full p-1.5 border rounded text-xs" value={med.nombre} onChange={e => handleMedChange(idx, 'nombre', e.target.value)} placeholder="Buscar..." /></div>
                                                    <div className="w-24"><label className="text-[10px] font-bold text-slate-400 block">ID Receta</label><input type="text" className="w-full p-1.5 border rounded text-xs" value={med.idReceta} onChange={e => handleMedChange(idx, 'idReceta', e.target.value)} /></div>
                                                    <div className="w-20"><label className="text-[10px] font-bold text-slate-400 block">Cant.</label><input type="number" className="w-full p-1.5 border rounded text-xs" value={med.cantidad} onChange={e => handleMedChange(idx, 'cantidad', e.target.value)} /></div>
                                                </div>
                                            ))}
                                            {kitData.medicamentos.length === 0 && <div className="text-center text-xs text-slate-400 italic py-4">Ingrese cantidad (ej: 6 o 6/9) para agregar líneas.</div>}
                                        </div>
                                    </div>
                                </fieldset>
                                
                                {!isViewMode ? (
                                    <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar Kit</button>
                                ) : (
                                    <button type="button" onClick={closeKitForm} className="w-full py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar Visualización</button>
                                )}
                            </form>
                            <datalist id="medsList">{medicines.map((m, i) => <option key={i} value={m.name} />)}</datalist>
                        </Modal>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 p-5 relative z-10">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3"><h2 className="text-xl font-bold text-slate-800">Historial de Producción</h2><div className="text-2xl font-bold text-turquoise-600">{patientKits.length} <span className="text-sm text-slate-400 font-normal">Kits</span></div></div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div><span className="text-[10px] font-bold text-slate-400 block">Tipo Afiliado</span>{selectedPatientFullData?.tipoAfiliado || selectedPatient.tipoAfiliado}</div>
                                    <div className="md:col-span-3"><span className="text-[10px] font-bold text-slate-400 block">Domicilio</span>{selectedPatientFullData?.direccion || 'Cargando...'}</div>
                                </div>
                                {selectedPatientFullData && (
                                    <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
                                        <div><span className="text-[10px] font-bold text-slate-400 block">Teléfono</span>{selectedPatientFullData.telefono || 'No disponible'}</div>
                                        <div><span className="text-[10px] font-bold text-slate-400 block">Tel. Familiar</span>{selectedPatientFullData.telefonoFamiliar || 'No disponible'}</div>
                                    </div>
                                )}
                            </div>
                            <div className="grid gap-3">
                                {patientKits.map(kit => (
                                    <div key={kit.id} className="p-4 rounded-xl border border-slate-100 bg-white shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4 relative group">
                                        <div className="flex-1">
                                            <div className="flex flex-wrap items-center gap-2 mb-2">
                                                <span className="bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold border border-turquoise-100"><Icons.Calendar size={12} className="inline mr-1"/> {kit.fechaArmado}</span>
                                                <span className={`px-2 py-1 rounded text-xs font-bold border ${kit.deliveryMode==='ruta'?'bg-emerald-50 text-emerald-700 border-emerald-100':'bg-indigo-50 text-indigo-700 border-indigo-100'}`}>{kit.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA'}</span>
                                                <span className="text-xs text-slate-400 font-mono">Hora Ops: {kit.horaOperaciones || '--:--'}</span>
                                            </div>
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {kit.medicamentos?.slice(0,4).map((m,i) => <span key={i} className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border">{m.nombre} ({m.cantidad})</span>)}
                                                {(kit.medicamentos?.length > 4) && <span className="text-[10px] text-slate-400 px-1">...</span>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end sm:justify-center items-start">
                                            <button onClick={() => openEditKit(kit, true)} className="text-slate-300 hover:text-blue-500 p-2 btn-hover-effect" title="Ver Detalle"><Icons.Search size={18}/></button>
                                            <button onClick={() => openPrintModal(kit)} className="text-slate-300 hover:text-slate-700 p-2 btn-hover-effect" title="Imprimir"><Icons.Printer size={18}/></button>
                                            <button onClick={() => openEditKit(kit, false)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect" title="Editar"><Icons.Edit size={18}/></button>
                                            {(userRole==='superadmin'||userRole==='admin') && <button onClick={() => {if(confirm("¿Eliminar Kit?")) onDeleteKit(kit.id);}} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect"><Icons.Trash size={18}/></button>}
                                        </div>
                                    </div>
                                ))}
                                {patientKits.length === 0 && <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">No hay kits registrados para este paciente.</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/50 backdrop-blur-md">
                        <div className="flex items-center gap-4 w-full md:w-auto"><div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"><Icons.Users size={24}/></div><div><h3 className="font-bold text-xl text-slate-800 brand-font">Gestión de Pacientes</h3><p className="text-xs font-semibold text-turquoise-600">{filteredPatients.length} Registros</p></div></div>
                        <div className="flex gap-3 w-full md:w-auto items-center">
                            <div className="relative w-full sm:w-64"><div className="absolute left-3 top-2.5 text-slate-400"><Icons.Search size={16}/></div><input type="text" placeholder="Buscar DNI o Nombre..." className="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:border-turquoise-200 transition-all focus:shadow-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                            
                            {/* Botón Cargar DH (Solo Admin) */}
                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                <div className="relative overflow-hidden">
                                    <button className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                        <Icons.FileSpreadsheet size={16}/> <span className="hidden sm:inline">Cargar DH</span>
                                    </button>
                                    <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                            )}

                            <button onClick={()=>setShowPatientForm(true)} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"><Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo</span></button>
                        </div>
                    </div>
                    
                    <Modal isOpen={showPatientForm} onClose={closePatientForm} title={editingPatientId ? "Editar Paciente" : "Nuevo Derechohabiente"} maxWidth="max-w-2xl">
                        <form onSubmit={handlePatientSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">DNI <span className="text-red-500">*</span></label><input type="text" required className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.dni} onChange={e=>setPatientForm({...patientForm, dni:e.target.value, nAfiliacion:e.target.value})} maxLength={15} /></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">N° Afiliación</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-slate-50" value={patientForm.nAfiliacion} onChange={e=>setPatientForm({...patientForm, nAfiliacion:e.target.value})} /></div>
                            </div>
                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo <span className="text-red-500">*</span></label><input type="text" required className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.nombre} onChange={e=>setPatientForm({...patientForm, nombre:e.target.value.toUpperCase()})} /></div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Teléfono</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.telefono} onChange={e=>setPatientForm({...patientForm, telefono:e.target.value})} /></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Municipio</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.descripcionMunicipio} onChange={e=>setPatientForm({...patientForm, descripcionMunicipio:e.target.value})} /></div>
                            </div>

                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Dirección</label><textarea rows="2" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm resize-none" value={patientForm.direccion} onChange={e=>setPatientForm({...patientForm, direccion:e.target.value})}></textarea></div>

                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Familiar</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.familiar} onChange={e=>setPatientForm({...patientForm, familiar:e.target.value})} /></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tel. Familiar</label><input type="text" className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" value={patientForm.telefonoFamiliar} onChange={e=>setPatientForm({...patientForm, telefonoFamiliar:e.target.value})} /></div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tipo Afiliación</label>
                                <select className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white" value={patientForm.tipoAfiliado} onChange={e=>setPatientForm({...patientForm, tipoAfiliado:e.target.value})}>
                                    <option value="AFILIADO DIRECTO">AFILIADO DIRECTO</option>
                                    <option value="JUBILADO">JUBILADO</option>
                                    <option value="PENSIONADO">PENSIONADO</option>
                                    <option value="BENEFICIARIO PADRE">BENEFICIARIO PADRE</option>
                                    <option value="BENEFICIARIO COMPAÑERO(O)">BENEFICIARIO COMPAÑERO(O)</option>
                                    <option value="BENEFICIARIO ESPOSO(A)">BENEFICIARIO ESPOSO(A)</option>
                                    <option value="BENEFICIARIO HIJO(A)">BENEFICIARIO HIJO(A)</option>
                                </select>
                            </div>

                            <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg mt-2 btn-hover-effect">{editingPatientId ? 'Actualizar' : 'Guardar'}</button>
                        </form>
                    </Modal>

                    <div className="h-full overflow-y-auto bg-white p-6">
                        {/* Controles de paginación */}
                        {filteredPatients.length > patientsPerPage && (
                            <div className="mb-4 flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="text-sm text-slate-600">
                                    Mostrando {indexOfFirstPatient + 1}-{Math.min(indexOfLastPatient, filteredPatients.length)} de {filteredPatients.length} pacientes
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                        disabled={currentPage === 1}
                                        className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                    >
                                        Anterior
                                    </button>
                                    <span className="px-3 py-1 text-sm text-slate-700">
                                        Página {currentPage} de {totalPages}
                                    </span>
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                        disabled={currentPage === totalPages}
                                        className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                    >
                                        Siguiente
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse min-w-[800px]">
                                <thead className="bg-slate-50/80 sticky top-0 z-10">
                                    <tr className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                        <th className="px-6 py-4 pl-8">Paciente</th>
                                        <th className="px-6 py-4">Identificación</th>
                                        <th className="px-6 py-4 text-center">N° Kits</th>
                                        <th className="px-6 py-4 text-right pr-8">Acción</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {currentPatients.map(p => {
                                        const countKits = kits.filter(k => k.patientId === p.id).length;
                                        return (
                                            <tr key={p.id} onClick={() => handleSelectPatient(p)} className={`row-hover-effect cursor-pointer`}>
                                                <td className="px-6 py-5 pl-8">
                                                    <div className="font-bold text-base text-slate-800 tracking-tight">{p.nombre}</div>
                                                    <div className="text-xs text-turquoise-600 font-medium mt-1 flex items-center gap-1">Ver Detalle <Icons.ChevronsRight size={14}/></div>
                                                </td>
                                                <td className="px-6 py-5">
                                                    <div className="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit mb-1 font-bold">{p.dni}</div>
                                                    <div className="text-xs text-slate-400">{p.tipoAfiliado}</div>
                                                </td>
                                                <td className="px-6 py-5 text-center">
                                                    <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">{countKits}</span>
                                                </td>
                                                <td className="px-6 py-5 text-right pr-8" onClick={(e)=>e.stopPropagation()}>
                                                    <div className="flex justify-end gap-2">
                                                        <button onClick={(e) => openEditPatient(e, p)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect"><Icons.Edit size={20}/></button>
                                                        {(userRole==='superadmin'||userRole==='admin') && <button onClick={()=>setConfirmData({ title: 'Eliminar', msg: `¿Eliminar a ${p.nombre}?`, action: () => onDeletePatient(p.id) })} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect"><Icons.Trash size={20}/></button>}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        {/* Controles de paginación al final */}
                        {filteredPatients.length > patientsPerPage && (
                            <div className="mt-4 flex justify-center">
                                <div className="flex gap-1">
                                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                                        let pageNum;
                                        if (totalPages <= 5) {
                                            pageNum = i + 1;
                                        } else if (currentPage <= 3) {
                                            pageNum = i + 1;
                                        } else if (currentPage >= totalPages - 2) {
                                            pageNum = totalPages - 4 + i;
                                        } else {
                                            pageNum = currentPage - 2 + i;
                                        }
                                        
                                        return (
                                            <button
                                                key={pageNum}
                                                onClick={() => setCurrentPage(pageNum)}
                                                className={`w-8 h-8 rounded-lg text-sm font-medium ${currentPage === pageNum ? 'bg-turquoise-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                            >
                                                {pageNum}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [view, setView] = useState('dashboard');
            
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [users, setUsers] = useState([]);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); 
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            const handleLogout = () => { 
                signOut(auth); 
                // NO LIMPIAR EL CACHE al cerrar sesión
                sessionStorage.removeItem('leq_role');
                sessionStorage.removeItem('leq_username');
                setRole(null); 
                setUserName(null); 
            };
            const handleLogin = (r, n) => { 
                setRole(r); 
                setUserName(n); 
                sessionStorage.setItem('leq_role', r); 
                sessionStorage.setItem('leq_username', n); 
            };

            // Función para cargar datos con caché mejorado
            const loadWithCache = async (collectionName, setState, cacheKey, fields = []) => {
                try {
                    const now = Date.now();
                    const sevenDays = 7 * 24 * 60 * 60 * 1000; // 7 días
                    
                    // Intentar cargar desde caché
                    const cachedData = localStorage.getItem(`cache_${cacheKey}`);
                    const cacheTime = localStorage.getItem(`cache_time_${cacheKey}`);
                    
                    if (cachedData && cacheTime && (now - parseInt(cacheTime)) < sevenDays) {
                        // Usar datos en caché (menos de 7 días)
                        setState(JSON.parse(cachedData));
                        console.log(`✅ ${collectionName} cargado desde caché`);
                        return true;
                    } else {
                        // Cargar desde Firebase
                        const querySnapshot = await getDocs(collection(db, collectionName));
                        let data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        
                        // Filtrar campos si se especifican
                        if (fields.length > 0) {
                            data = data.map(item => {
                                const filteredItem = {};
                                fields.forEach(field => {
                                    if (item[field] !== undefined) filteredItem[field] = item[field];
                                });
                                filteredItem.id = item.id;
                                return filteredItem;
                            });
                        }
                        
                        // Ordenar según la colección
                        let sortedData = data;
                        if (collectionName === 'prod_patients') {
                            sortedData = data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        } else if (collectionName === 'prod_kits') {
                            sortedData = data.sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                        } else if (collectionName === 'prod_medicines') {
                            sortedData = data.sort((a, b) => a.name.localeCompare(b.name));
                        } else if (collectionName === 'prod_contacts') {
                            sortedData = data.sort((a, b) => a.name.localeCompare(b.name));
                        }
                        
                        setState(sortedData);
                        
                        // Guardar en caché por 7 días
                        localStorage.setItem(`cache_${cacheKey}`, JSON.stringify(sortedData));
                        localStorage.setItem(`cache_time_${cacheKey}`, now.toString());
                        console.log(`🔥 ${collectionName} cargado desde Firebase y guardado en caché (7 días)`);
                        return false;
                    }
                } catch (error) {
                    console.error(`Error cargando ${collectionName}:`, error);
                    return false;
                }
            };

            // Cargar datos con caché mejorado
            useEffect(() => {
                if (!role || !db) return;
                
                // Cargar datos estáticos con caché de 7 días
                // Para pacientes: solo cargar datos básicos inicialmente
                loadWithCache('prod_patients', setPatients, 'patients', ['id', 'dni', 'nombre', 'tipoAfiliado', 'createdAt']);
                
                // Para kits: cargar todos los datos (necesarios para reportes)
                loadWithCache('prod_kits', setKits, 'kits');
                
                // Catálogos estáticos
                loadWithCache('prod_medicines', setMedicines, 'medicines');
                loadWithCache('prod_contacts', setContacts, 'contacts');
                
                // Para usuarios (solo admin/superadmin)
                if (role === 'admin' || role === 'superadmin') {
                    loadWithCache('prod_users', setUsers, 'users');
                }
                
                // Escuchar cambios en tiempo real solo para actualizaciones críticas
                const unsubPatients = onSnapshot(collection(db, 'prod_patients'), s => {
                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    
                    // Filtrar para mantener solo datos básicos en el estado principal
                    const basicData = data.map(p => ({
                        id: p.id,
                        dni: p.dni,
                        nombre: p.nombre,
                        tipoAfiliado: p.tipoAfiliado,
                        createdAt: p.createdAt
                    }));
                    
                    setPatients(basicData);
                    
                    // Actualizar caché completo cada 24 horas
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    const lastFullCache = localStorage.getItem('cache_time_full_patients') || '0';
                    
                    if (now - parseInt(lastFullCache) > oneDay) {
                        localStorage.setItem('cache_full_patients', JSON.stringify(data));
                        localStorage.setItem('cache_time_full_patients', now.toString());
                    }
                });
                
                const unsubKits = onSnapshot(collection(db, 'prod_kits'), s => {
                    const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                    setKits(data);
                    
                    // Actualizar caché cada 12 horas para kits
                    const now = Date.now();
                    const twelveHours = 12 * 60 * 60 * 1000;
                    const lastKitCache = localStorage.getItem('cache_time_kits') || '0';
                    
                    if (now - parseInt(lastKitCache) > twelveHours) {
                        localStorage.setItem('cache_kits', JSON.stringify(data));
                        localStorage.setItem('cache_time_kits', now.toString());
                    }
                });
                
                return () => {
                    unsubPatients();
                    unsubKits();
                };
            }, [role]);

            const addPatient = async (d) => {
                const result = await addDoc(collection(db, 'prod_patients'), {...d, createdAt:serverTimestamp()});
                // Invalidar cache de pacientes
                localStorage.removeItem('cache_patients');
                localStorage.removeItem('cache_time_patients');
                return result;
            };
            const updatePatient = async (id, d) => {
                await updateDoc(doc(db, 'prod_patients', id), d);
                // Invalidar cache de pacientes
                localStorage.removeItem('cache_patients');
                localStorage.removeItem('cache_time_patients');
            };
            const deletePatient = async (id) => {
                await deleteDoc(doc(db, 'prod_patients', id));
                // Invalidar cache de pacientes
                localStorage.removeItem('cache_patients');
                localStorage.removeItem('cache_time_patients');
            };
            
            const saveKit = async (id, data, pid, isUpdate) => {
                let resultId = id;
                if(isUpdate) {
                    await updateDoc(doc(db, 'prod_kits', id), data);
                } else {
                    const result = await addDoc(collection(db, 'prod_kits'), {...data, patientId: pid, createdAt: serverTimestamp()});
                    resultId = result.id;
                }
                // Invalidar cache de kits
                localStorage.removeItem('cache_kits');
                localStorage.removeItem('cache_time_kits');
                return resultId;
            };
            const deleteKit = async (id) => {
                await deleteDoc(doc(db, 'prod_kits', id));
                // Invalidar cache de kits
                localStorage.removeItem('cache_kits');
                localStorage.removeItem('cache_time_kits');
            };
            const addMedsList = async (list) => { 
                for(const name of list) await addDoc(collection(db, 'prod_medicines'), { name }); 
                // Invalidar caché de medicamentos
                localStorage.removeItem('cache_medicines');
                localStorage.removeItem('cache_time_medicines');
            };
            
            const addContact = async (name, phone) => {
                await addDoc(collection(db, 'prod_contacts'), { name, phone });
                // Invalidar caché de contactos
                localStorage.removeItem('cache_contacts');
                localStorage.removeItem('cache_time_contacts');
            };
            const deleteContact = async (id) => {
                await deleteDoc(doc(db, 'prod_contacts', id));
                // Invalidar caché de contactos
                localStorage.removeItem('cache_contacts');
                localStorage.removeItem('cache_time_contacts');
            };

            const addUser = async (u) => {
                await addDoc(collection(db, 'prod_users'), u);
                // Invalidar cache de usuarios
                localStorage.removeItem('cache_users');
                localStorage.removeItem('cache_time_users');
            };
            const updateUser = async (id, u) => {
                await updateDoc(doc(db, 'prod_users', id), u);
                // Invalidar cache de usuarios
                localStorage.removeItem('cache_users');
                localStorage.removeItem('cache_time_users');
            };
            const deleteUser = async (id) => {
                await deleteDoc(doc(db, 'prod_users', id));
                // Invalidar cache de usuarios
                localStorage.removeItem('cache_users');
                localStorage.removeItem('cache_time_users');
            };

            if (!role) return <LoginBlock onLogin={handleLogin} />;

            const NavItem = ({ id, label, icon: Icon }) => (
                <button onClick={() => { setView(id); setMobileMenuOpen(false); }} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold group relative overflow-hidden btn-hover-effect ${view === id ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`}>
                    <Icon size={20} className={view === id ? 'text-white' : 'text-turquoise-400 group-hover:text-white'} /><span className={`whitespace-nowrap transition-opacity duration-300 ${sidebarCollapsed ? 'hidden opacity-0 w-0' : 'block opacity-100'}`}>{label}</span>
                </button>
            );

            const stats = { totalKits: kits.length, todayKits: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length };

            return (
                <div className="flex h-screen bg-[#f0fdfa] font-sans overflow-hidden">
                    {/* Mobile Header */}
                    {mobileMenuOpen && ( <div className="fixed inset-0 z-50 bg-turquoise-900/95 backdrop-blur-sm flex flex-col md:hidden animate-in"><div className="p-4 flex justify-between items-center border-b border-turquoise-800"><div className="font-bold text-white text-xl flex items-center gap-2 brand-font"><Icons.Activity/> LEQ Móvil</div><button onClick={() => setMobileMenuOpen(false)} className="text-white p-2 bg-turquoise-800 rounded-full btn-hover-effect"><Icons.X size={24}/></button></div><div className="p-6 space-y-4"><NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} /><NavItem id="reports" label="Reportes" icon={Icons.List} /><NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />{(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuración" icon={Icons.Settings} />}{(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}<div className="pt-8 border-t border-turquoise-800"><button onClick={handleLogout} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl bg-turquoise-800 text-white font-bold btn-hover-effect"><Icons.LogOut size={20}/> Desconectar</button></div></div></div> )}
                    
                    {/* Sidebar */}
                    <aside className={`${sidebarCollapsed ? 'w-24' : 'w-72'} bg-turquoise-900 text-turquoise-100 flex-col shadow-2xl z-20 hidden md:flex relative transition-all duration-300 ease-in-out`}>
                        <div className={`p-6 pb-2 relative z-10 flex ${sidebarCollapsed ? 'justify-center' : 'justify-between'} items-center`}>{!sidebarCollapsed && <div className="flex items-center gap-3 text-white"><div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg"><Icons.Activity size={24} className="text-white"/></div><span className="font-bold text-2xl brand-font animate-in">Bitácora</span></div>}{sidebarCollapsed && <div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg mb-2"><Icons.Activity size={24} className="text-white"/></div>}<button onClick={() => setSidebarCollapsed(!sidebarCollapsed)} className="text-turquoise-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-turquoise-800 absolute right-4 top-6 btn-hover-effect" style={sidebarCollapsed ? { right: 'auto', top: 'auto', marginTop: '10px', position: 'static' } : {}}>{sidebarCollapsed ? <Icons.ChevronsRight size={20}/> : <Icons.ArrowLeft size={20}/>}</button></div>
                        {!sidebarCollapsed && <div className="text-xs font-bold text-turquoise-400 uppercase tracking-widest pl-14 mb-4 animate-in">Producción</div>}
                        <nav className="flex-1 px-4 py-4 space-y-2 relative z-10 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                            <NavItem id="reports" label="Reportes" icon={Icons.List} />
                            <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuración" icon={Icons.Settings} />}
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                        </nav>
                        <div className="p-4 mx-4 mb-4 rounded-2xl bg-turquoise-800/50 border border-turquoise-700/50 relative z-10">
                            <div className={`flex items-center gap-3 mb-4 ${sidebarCollapsed ? 'justify-center flex-col' : ''}`}><div className="w-10 h-10 rounded-full bg-gradient-to-br from-clinical-400 to-clinical-600 flex items-center justify-center font-bold text-white text-sm shrink-0">{role==='admin'?'AD':'OP'}</div>{!sidebarCollapsed && <div className="overflow-hidden"><div className="text-sm font-bold text-white capitalize truncate">{userName}</div><div className="text-[10px] text-turquoise-300 truncate">En línea</div></div>}</div>
                            <button onClick={handleLogout} className={`w-full flex items-center gap-2 text-xs font-bold text-turquoise-200 hover:text-white py-2.5 rounded-xl hover:bg-turquoise-700 transition-colors btn-hover-effect ${sidebarCollapsed ? 'justify-center' : 'justify-center'}`} title="Desconectar"><Icons.LogOut size={16}/> {!sidebarCollapsed && <span>Salir</span>}</button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden bg-[#f0fdfa] relative transition-all duration-300">
                        <div className="md:hidden bg-white/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center z-20"><button onClick={() => setMobileMenuOpen(true)} className="text-slate-600 p-1 btn-hover-effect"><Icons.Menu size={24}/></button><div className="font-bold text-slate-800 flex items-center gap-2 brand-font"><Icons.Activity size={18} className="text-turquoise-600"/> LEQ Móvil</div><div className="w-8"></div></div>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative z-10">
                            {view === 'dashboard' && <DashboardBlock setView={setView} stats={stats} userName={userName} role={role} />}
                            {view === 'reports' && <ReportsBlock kits={kits} patients={patients} userRole={role} userName={userName} setView={setView} />}
                            {view === 'pacientes' && <PatientManagementBlock patients={patients} kits={kits} medicines={medicines} onAddPatient={addPatient} onUpdatePatient={updatePatient} onDeletePatient={deletePatient} onSaveKit={saveKit} onDeleteKit={deleteKit} currentUser={{name: userName, role: role}} userRole={role} contacts={contacts} />}
                            {view === 'config' && (role === 'admin' || role === 'superadmin') && <ConfigBlock medicines={medicines} onAddList={addMedsList} contacts={contacts} onAddContact={addContact} onDeleteContact={deleteContact} />}
                            {view === 'users' && (role === 'admin' || role === 'superadmin') && <UserManagementBlock users={users} onAddUser={addUser} onUpdateUser={updateUser} onDeleteUser={deleteUser} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
