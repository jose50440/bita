<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Producción - Operaciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#eef2ff', 100:'#e0e7ff', 500:'#6366f1', 600:'#4f46e5', 700:'#4338ca', 800:'#3730a3', 900:'#312e81' }, // Indigo theme
                        accent: { 50:'#f0fdfa', 500:'#14b8a6', 600:'#0d9488' } // Teal accent
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(99, 102, 241, 0.15)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .toggle-switch { display: flex; align-items: center; cursor: pointer; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 2px; background: white; transition: all 0.2s; }
        .toggle-switch.active { border-color: #4f46e5; background: #eef2ff; }
        .toggle-option { padding: 2px 8px; font-size: 10px; font-weight: 700; border-radius: 0.3rem; transition: all 0.2s; }
        .toggle-switch .on { background: #4f46e5; color: white; }
        .toggle-switch .off { background: #e2e8f0; color: #64748b; }
        .toggle-switch.active .on { opacity: 1; }
        .toggle-switch.active .off { background: transparent; color: #4f46e5; }
        .toggle-switch:not(.active) .on { background: transparent; color: #94a3b8; }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-brand-200 selection:text-brand-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, getDocs, enableIndexedDbPersistence, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            Users: (p) => <Icon {...p} path={<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            LogOut: (p) => <Icon {...p} path={<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Settings: (p) => <Icon {...p} path={<circle cx="12" cy="12" r="3"></circle>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash: (p) => <Icon {...p} path={<polyline points="3 6 5 6 21 6"></polyline>} />,
            Printer: (p) => <Icon {...p} path={<polyline points="6 9 6 2 18 2 18 9"></polyline>} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"></polyline>} />,
            UserCog: (p) => <Icon {...p} path={<circle cx="12" cy="7" r="4"></circle>} />,
            Menu: (p) => <Icon {...p} path={<line x1="3" y1="12" x2="21" y2="12"></line>} />,
            X: (p) => <Icon {...p} path={<line x1="18" y1="6" x2="6" y2="18"></line>} />,
            FileText: (p) => <Icon {...p} path={<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />
        };

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHrnTnsXg4P6faYSfP51gORVKPy-ExEw4",
            authDomain: "bitacora-217cf.firebaseapp.com",
            projectId: "bitacora-217cf",
            storageBucket: "bitacora-217cf.firebasestorage.app",
            messagingSenderId: "1080043869360",
            appId: "1:1080043869360:web:5932f72c30d8bb376cd775"
        };

        let app, auth, db;
        try { 
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app); 
            db = getFirestore(app); 
            enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err.code));
        } catch (err) { console.error("Firebase Init Error:", err); }

        // --- COMPONENTS ---

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[95vh] modal-animate`}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); const [password, setPassword] = useState(''); const [loading, setLoading] = useState(false); const [error, setError] = useState('');
            
            const handleLogin = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                const userKey = username.trim().toLowerCase();
                
                // Superadmin backdoor for initial setup if needed (optional)
                if (userKey === 'superadmin' && password === 'admin123') { 
                    proceedLogin('superadmin', 'Super Usuario', 'Operaciones'); return; 
                }
                
                try {
                    const q = query(collection(db, 'users'), where('username', '==', userKey));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                             proceedLogin(userData.role, userData.nombre || userData.username, 'Operaciones');
                        } else { setError("Contraseña incorrecta."); setLoading(false); }
                    } else { setError("Usuario no encontrado."); setLoading(false); }
                } catch (err) { 
                    console.error(err);
                    setError("Error de conexión. Verifique su red."); setLoading(false); 
                }
            };
            
            const proceedLogin = async (role, name, dept) => {
                 try {
                     await addDoc(collection(db, 'access_logs'), { username: name, role: role, timestamp: serverTimestamp() });
                 } catch (e) {}
                 onLogin(role, name, dept);
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-brand-50 to-accent-50 p-6">
                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50">
                        <div className="text-center mb-10">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" className="w-24 h-24 mx-auto mb-4 rounded-full shadow-lg object-cover" />
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font">Bitácora <span className="text-brand-600">Producción</span></h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Dpto. Operaciones</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold">{error}</div>}
                            <div className="space-y-4">
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Usuario</label><input type="text" className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-brand-500 transition-colors" value={username} onChange={(e) => setUsername(e.target.value)} required /></div>
                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contraseña</label><input type="password" className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-brand-500 transition-colors" value={password} onChange={(e) => setPassword(e.target.value)} required /></div>
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect transition-colors">{loading ? 'Verificando...' : 'Iniciar Sesión'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const ConfigBlock = ({ medicines, onAddList }) => {
            const [rawText, setRawText] = useState('');
            
            const processText = () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const uniqueMeds = [...new Set(lines)];
                if(uniqueMeds.length > 0) {
                    onAddList(uniqueMeds);
                    setRawText('');
                    alert(`Se procesaron ${uniqueMeds.length} medicamentos.`);
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-brand-100 p-3 rounded-2xl text-brand-600"><Icons.Settings size={24} /></div>
                        <div><h3 className="font-bold text-xl text-slate-800 brand-font">Configuración</h3><p className="text-xs font-semibold text-brand-600">Catálogo de Medicamentos</p></div>
                    </div>
                    <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto">
                        <div>
                            <h4 className="font-bold text-slate-700 mb-2">Carga Masiva</h4>
                            <p className="text-xs text-slate-400 mb-4">Pegue la lista de medicamentos (uno por línea) desde Excel o CSV.</p>
                            <textarea className="w-full h-64 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-brand-400" placeholder="AMOXICILINA 500MG&#10;PARACETAMOL&#10;..." value={rawText} onChange={e => setRawText(e.target.value)}></textarea>
                            <button onClick={processText} className="mt-4 bg-brand-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-brand-700 w-full btn-hover-effect flex justify-center gap-2 items-center"><Icons.Upload size={16}/> Procesar Lista</button>
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-700 mb-2">Catálogo Actual ({medicines.length})</h4>
                            <div className="h-64 overflow-y-auto border rounded-xl bg-white p-2 space-y-1">
                                {medicines.map((m, i) => (
                                    <div key={i} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0">{m.name}</div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const UserManagementBlock = ({ users, onAddUser, onDeleteUser }) => {
            const [formData, setFormData] = useState({ username: '', password: '', role: 'digitador', nombre: '' });
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAddUser({...formData, departamento: 'Operaciones'}); // Forzamos Operaciones
                setFormData({ username: '', password: '', role: 'digitador', nombre: '' });
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-brand-100 p-3 rounded-2xl text-brand-600"><Icons.UserCog size={24} /></div>
                        <div><h3 className="font-bold text-xl text-slate-800 brand-font">Usuarios</h3><p className="text-xs font-semibold text-brand-600">Control de Acceso</p></div>
                    </div>
                    <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 overflow-y-auto">
                        <div className="md:col-span-1">
                            <form onSubmit={handleSubmit} className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3">
                                <h4 className="font-bold text-sm text-slate-700">Nuevo Usuario</h4>
                                <input type="text" placeholder="Nombre Completo" className="w-full p-2 rounded-lg border text-sm" value={formData.nombre} onChange={e=>setFormData({...formData, nombre:e.target.value})} required />
                                <input type="text" placeholder="Usuario (Login)" className="w-full p-2 rounded-lg border text-sm" value={formData.username} onChange={e=>setFormData({...formData, username:e.target.value.toLowerCase()})} required />
                                <input type="password" placeholder="Contraseña" className="w-full p-2 rounded-lg border text-sm" value={formData.password} onChange={e=>setFormData({...formData, password:e.target.value})} required />
                                <select className="w-full p-2 rounded-lg border text-sm bg-white" value={formData.role} onChange={e=>setFormData({...formData, role:e.target.value})}>
                                    <option value="digitador">Digitador</option>
                                    <option value="admin">Administrador</option>
                                    <option value="superadmin">Super Admin</option>
                                </select>
                                <button type="submit" className="w-full bg-brand-600 text-white py-2 rounded-lg text-sm font-bold shadow hover:bg-brand-700">Crear Usuario</button>
                            </form>
                        </div>
                        <div className="md:col-span-2 grid gap-3 sm:grid-cols-2">
                            {users.map(u => (
                                <div key={u.id} className="p-3 rounded-xl border border-slate-100 flex justify-between items-center bg-white hover:shadow-md transition-shadow">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-xs ${u.role === 'digitador' ? 'bg-accent-500' : 'bg-brand-600'}`}>{u.username.substring(0,2).toUpperCase()}</div>
                                        <div>
                                            <div className="font-bold text-sm text-slate-800">{u.nombre}</div>
                                            <div className="text-[10px] text-slate-400 font-mono">@{u.username} • {u.role}</div>
                                        </div>
                                    </div>
                                    <button onClick={() => onDeleteUser(u.id)} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash size={16}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ProductionManagement = ({ kits, medicines, onCreateKit, onUpdateKit, onDeleteKit, currentUser }) => {
            const [view, setView] = useState('list'); // list, form, date_folder
            const [selectedDate, setSelectedDate] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingKit, setEditingKit] = useState(null);

            // Form State
            const initialForm = {
                dni: '', nombre: '', telefono1: '', telefonoRef: '', 
                fechaArmado: new Date().toISOString().split('T')[0], 
                fechaEntrega: '', horaOperaciones: '', fechaEnvio: '',
                contactCenter: '', triggerMeds: 0,
                medicamentos: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            // Group by Date logic
            const dates = useMemo(() => {
                const map = {};
                kits.forEach(k => {
                    const d = k.fechaArmado || 'Sin Fecha';
                    if(!map[d]) map[d] = 0;
                    map[d]++;
                });
                return Object.entries(map).sort((a,b) => b[0].localeCompare(a[0]));
            }, [kits]);

            const filteredKits = useMemo(() => {
                let data = kits;
                if(selectedDate) data = data.filter(k => k.fechaArmado === selectedDate);
                if(searchTerm) {
                    const low = searchTerm.toLowerCase();
                    data = data.filter(k => k.nombre.toLowerCase().includes(low) || k.dni.includes(low));
                }
                return data;
            }, [kits, selectedDate, searchTerm]);

            // Form Handlers
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                
                // Trigger logic for medicines rows
                if (name === 'triggerMeds') {
                    const count = parseInt(value) || 0;
                    const newMeds = Array(count).fill({ nombre: '', idReceta: '', cantidad: '', refrigerado: false, cantRefri: '' });
                    setFormData(prev => ({ ...prev, triggerMeds: value, medicamentos: newMeds }));
                }
            };

            const handleMedChange = (index, field, val) => {
                const newMeds = [...formData.medicamentos];
                newMeds[index] = { ...newMeds[index], [field]: val };
                setFormData(prev => ({ ...prev, medicamentos: newMeds }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const dataToSave = { ...formData, digitador: currentUser.name }; // Auto-fill Digitizer
                if (editingKit) onUpdateKit(editingKit.id, dataToSave);
                else onCreateKit(dataToSave);
                setView('list');
                setEditingKit(null);
                setFormData(initialForm);
            };

            const openEdit = (kit) => {
                setFormData(kit);
                setEditingKit(kit);
                setView('form');
            };

            // Views
            if (view === 'form') {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft h-full flex flex-col bg-white overflow-hidden animate-in">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800">{editingKit ? 'Editar Kit' : 'Nuevo Kit de Producción'}</h3>
                            <button onClick={() => setView('list')} className="text-slate-500 hover:text-brand-600 font-bold text-xs">Cancelar</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <form onSubmit={handleSubmit} className="space-y-6 max-w-4xl mx-auto">
                                {/* Parent Data */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="md:col-span-3 font-bold text-brand-600 text-xs uppercase tracking-widest border-b pb-1 mb-1">Datos del Derechohabiente</div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">DNI</label><input name="dni" type="text" className="w-full p-2 border rounded text-sm" value={formData.dni} onChange={handleInputChange} required /></div>
                                    <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase block">Nombre Completo</label><input name="nombre" type="text" className="w-full p-2 border rounded text-sm" value={formData.nombre} onChange={handleInputChange} required /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">Teléfono 1</label><input name="telefono1" type="text" className="w-full p-2 border rounded text-sm" value={formData.telefono1} onChange={handleInputChange} /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">Teléfono Ref</label><input name="telefonoRef" type="text" className="w-full p-2 border rounded text-sm" value={formData.telefonoRef} onChange={handleInputChange} /></div>
                                </div>

                                {/* Logistics Data */}
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="md:col-span-4 font-bold text-brand-600 text-xs uppercase tracking-widest border-b pb-1 mb-1">Logística</div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">Fecha Armado</label><input name="fechaArmado" type="date" className="w-full p-2 border rounded text-sm" value={formData.fechaArmado} onChange={handleInputChange} required /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">Fecha Entrega</label><input name="fechaEntrega" type="date" className="w-full p-2 border rounded text-sm" value={formData.fechaEntrega} onChange={handleInputChange} /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">Hora Operaciones</label><input name="horaOperaciones" type="time" className="w-full p-2 border rounded text-sm" value={formData.horaOperaciones} onChange={handleInputChange} /></div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase block">Contact Center</label>
                                        <select name="contactCenter" className="w-full p-2 border rounded text-sm bg-white" value={formData.contactCenter} onChange={handleInputChange}>
                                            <option value="">Seleccione...</option>
                                            <option value="Agente 1">Agente 1</option>
                                            <option value="Agente 2">Agente 2</option>
                                        </select>
                                    </div>
                                    <div className="md:col-span-4"><label className="text-[10px] font-bold text-slate-400 uppercase block">Digitador (Auto)</label><input type="text" className="w-full p-2 border rounded text-sm bg-slate-200 text-slate-500" value={currentUser.name} disabled /></div>
                                </div>

                                {/* Trigger & Children */}
                                <div className="bg-brand-50/50 p-4 rounded-xl border border-brand-100">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="font-bold text-brand-600 text-xs uppercase tracking-widest">Medicamentos</div>
                                        <div className="flex items-center gap-2">
                                            <label className="text-xs font-bold text-slate-500">% Medicamentos:</label>
                                            <input name="triggerMeds" type="number" min="0" max="10" className="w-16 p-1 border rounded text-center font-bold" value={formData.triggerMeds} onChange={handleInputChange} />
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {formData.medicamentos.map((med, idx) => (
                                            <div key={idx} className="bg-white p-3 rounded-lg border shadow-sm flex flex-col md:flex-row gap-2 items-end">
                                                <div className="flex-1 w-full">
                                                    <label className="text-[10px] font-bold text-slate-400 block">Medicamento</label>
                                                    <input list="medsList" className="w-full p-1.5 border rounded text-xs" value={med.nombre} onChange={e => handleMedChange(idx, 'nombre', e.target.value)} placeholder="Buscar..." />
                                                </div>
                                                <div className="w-24">
                                                    <label className="text-[10px] font-bold text-slate-400 block">ID Receta</label>
                                                    <input type="text" className="w-full p-1.5 border rounded text-xs" value={med.idReceta} onChange={e => handleMedChange(idx, 'idReceta', e.target.value)} />
                                                </div>
                                                <div className="w-20">
                                                    <label className="text-[10px] font-bold text-slate-400 block">Cant.</label>
                                                    <input type="number" className="w-full p-1.5 border rounded text-xs" value={med.cantidad} onChange={e => handleMedChange(idx, 'cantidad', e.target.value)} />
                                                </div>
                                                <div className="flex items-center gap-1 h-8 bg-slate-50 px-2 rounded border">
                                                    <input type="checkbox" checked={med.refrigerado} onChange={e => handleMedChange(idx, 'refrigerado', e.target.checked)} />
                                                    <span className="text-[10px] font-bold text-slate-500">Refri</span>
                                                </div>
                                                {med.refrigerado && (
                                                    <div className="w-20">
                                                        <label className="text-[10px] font-bold text-slate-400 block">Cant. Ref</label>
                                                        <input type="number" className="w-full p-1.5 border rounded text-xs bg-blue-50 border-blue-200" value={med.cantRefri} onChange={e => handleMedChange(idx, 'cantRefri', e.target.value)} />
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        {formData.medicamentos.length === 0 && <div className="text-center text-xs text-slate-400 italic py-4">Ingrese un número en % Medicamentos para agregar líneas.</div>}
                                    </div>
                                </div>

                                <button type="submit" className="w-full py-3 bg-brand-600 text-white font-bold rounded-xl shadow-lg hover:bg-brand-700 transition-colors btn-hover-effect">Guardar Kit de Producción</button>
                            </form>
                            <datalist id="medsList">
                                {medicines.map((m, i) => <option key={i} value={m.name} />)}
                            </datalist>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="bg-brand-100 p-3 rounded-2xl text-brand-600"><Icons.Box size={24}/></div>
                            <div><h3 className="font-bold text-xl text-slate-800 brand-font">Producción</h3><p className="text-xs font-semibold text-brand-600">{filteredKits.length} Kits Registrados</p></div>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            {selectedDate && <button onClick={() => setSelectedDate(null)} className="px-3 py-2 bg-slate-100 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-200">Ver Todos</button>}
                            <input type="text" placeholder="Buscar DNI o Nombre..." className="p-2.5 rounded-xl border text-sm outline-none focus:border-brand-300 w-full" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            <button onClick={() => { setEditingKit(null); setFormData(initialForm); setView('form'); }} className="flex items-center gap-2 bg-brand-600 hover:bg-brand-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap btn-hover-effect"><Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo Kit</span></button>
                        </div>
                    </div>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar Folders (Dates) */}
                        <div className="w-48 bg-slate-50 border-r border-slate-100 overflow-y-auto p-4 hidden md:block">
                            <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Carpetas por Fecha</h4>
                            <div className="space-y-1">
                                {dates.map(([date, count]) => (
                                    <button key={date} onClick={() => setSelectedDate(date)} className={`w-full text-left p-2 rounded-lg text-xs flex justify-between items-center ${selectedDate === date ? 'bg-white shadow-sm text-brand-600 font-bold border border-slate-100' : 'text-slate-500 hover:bg-slate-100'}`}>
                                        <div className="flex items-center gap-2"><Icons.Calendar size={14}/> {date}</div>
                                        <span className="bg-slate-200 text-slate-600 px-1.5 rounded-full text-[9px]">{count}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* List */}
                        <div className="flex-1 overflow-y-auto p-4">
                            {filteredKits.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-300">
                                    <Icons.Box size={48} className="mb-2 opacity-50"/>
                                    <p>No hay kits registrados.</p>
                                </div>
                            ) : (
                                <div className="grid gap-3">
                                    {filteredKits.map(kit => (
                                        <div key={kit.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4 group">
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div className="font-bold text-slate-800">{kit.nombre}</div>
                                                        <div className="text-xs text-brand-600 font-mono font-semibold">{kit.dni}</div>
                                                    </div>
                                                    <div className="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold">{kit.fechaArmado}</div>
                                                </div>
                                                <div className="text-xs text-slate-500 flex flex-wrap gap-2 items-center">
                                                    <span className="bg-slate-50 border px-1.5 rounded">Tel: {kit.telefono1}</span>
                                                    <span className="bg-slate-50 border px-1.5 rounded">Meds: {kit.triggerMeds}</span>
                                                    <span className="text-slate-300">|</span>
                                                    <span className="italic">Digitado por: {kit.digitador}</span>
                                                </div>
                                                {/* Preview Meds */}
                                                <div className="mt-2 flex flex-wrap gap-1">
                                                    {kit.medicamentos?.slice(0,3).map((m,i) => (
                                                        <span key={i} className="text-[9px] bg-brand-50 text-brand-700 px-1.5 py-0.5 rounded border border-brand-100">{m.nombre} ({m.cantidad})</span>
                                                    ))}
                                                    {(kit.medicamentos?.length > 3) && <span className="text-[9px] text-slate-400">+{kit.medicamentos.length - 3} más...</span>}
                                                </div>
                                            </div>
                                            <div className="flex md:flex-col gap-2 justify-center border-t md:border-t-0 md:border-l pt-2 md:pt-0 md:pl-2 border-slate-100">
                                                <button onClick={() => openEdit(kit)} className="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"><Icons.UserCog size={16}/></button>
                                                <button onClick={() => window.print()} className="p-2 text-slate-400 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors"><Icons.Printer size={16}/></button>
                                                <button onClick={() => { if(confirm("¿Eliminar Kit?")) onDeleteKit(kit.id); }} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Icons.Trash size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [view, setView] = useState('dashboard');
            
            // Data States
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [users, setUsers] = useState([]);

            const handleLogout = () => {
                signOut(auth);
                sessionStorage.clear();
                setRole(null); setUserName(null);
            };

            const handleLogin = (r, n) => {
                setRole(r); setUserName(n);
                sessionStorage.setItem('leq_role', r);
                sessionStorage.setItem('leq_username', n);
            };

            // Listeners
            useEffect(() => {
                if (!role || !db) return;
                
                const unsubKits = onSnapshot(collection(db, 'kits'), s => setKits(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> new Date(b.fechaArmado) - new Date(a.fechaArmado))));
                const unsubMeds = onSnapshot(collection(db, 'medicines'), s => setMedicines(s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.name.localeCompare(b.name))));
                
                let unsubUsers = () => {};
                if (role === 'admin' || role === 'superadmin') {
                    unsubUsers = onSnapshot(collection(db, 'users'), s => setUsers(s.docs.map(d=>({id:d.id, ...d.data()}))));
                }

                return () => { unsubKits(); unsubMeds(); unsubUsers(); };
            }, [role]);

            // Actions
            const addKit = async (d) => await addDoc(collection(db, 'kits'), {...d, createdAt: serverTimestamp()});
            const updateKit = async (id, d) => await updateDoc(doc(db, 'kits', id), d);
            const deleteKit = async (id) => await deleteDoc(doc(db, 'kits', id));
            
            const addMedsList = async (list) => {
                const batch = []; // Firestore batch or simple loop (using loop for simplicity here)
                // Note: Real batching recommended for large lists, here simple iteration
                for(const name of list) {
                    await addDoc(collection(db, 'medicines'), { name });
                }
            };
            
            const addUser = async (u) => await addDoc(collection(db, 'users'), u);
            const deleteUser = async (id) => await deleteDoc(doc(db, 'users', id));

            if (!role) return <LoginBlock onLogin={handleLogin} />;

            const NavItem = ({ id, label, icon: Icon }) => (
                <button onClick={() => setView(id)} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold group relative overflow-hidden btn-hover-effect ${view === id ? 'bg-gradient-to-r from-brand-600 to-brand-700 text-white shadow-lg' : 'hover:bg-brand-50 text-slate-500'}`}>
                    <Icon size={20} className={view === id ? 'text-white' : 'text-slate-400 group-hover:text-brand-600'} />
                    <span>{label}</span>
                </button>
            );

            // Dashboard Stats Calculation
            const stats = {
                total: kits.length,
                today: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length,
                meds: medicines.length
            };

            return (
                <div className="flex h-screen bg-[#f8fafc] font-sans overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col z-20">
                        <div className="p-6 pb-2 flex items-center gap-3">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQYufSdSImxYEfwI_evtM1JJJUn3n4ETVT5GA&s" className="w-10 h-10 rounded-full shadow-md object-cover" />
                            <div><div className="font-bold text-lg brand-font text-slate-800">Bitácora</div><div className="text-[10px] uppercase font-bold text-brand-600">Producción</div></div>
                        </div>
                        <nav className="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                            <NavItem id="dashboard" label="Dashboard" icon={Icons.Activity} />
                            <NavItem id="produccion" label="Producción" icon={Icons.Box} />
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuración" icon={Icons.Settings} />}
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.Users} />}
                        </nav>
                        <div className="p-4 m-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 rounded-full bg-brand-600 flex items-center justify-center text-white font-bold text-xs">{userName?.substring(0,2).toUpperCase()}</div>
                                <div className="overflow-hidden">
                                    <div className="font-bold text-xs text-slate-700 truncate">{userName}</div>
                                    <div className="text-[10px] text-slate-400 capitalize">{role}</div>
                                </div>
                            </div>
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 text-xs font-bold text-red-400 hover:text-red-500 py-2 rounded-lg hover:bg-red-50 transition-colors"><Icons.LogOut size={14}/> Cerrar Sesión</button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative">
                         <div className="flex-1 overflow-y-auto p-4 md:p-8 relative z-10">
                            {view === 'dashboard' && (
                                <div className="space-y-6 animate-in max-w-5xl mx-auto">
                                    <h2 className="text-2xl font-bold text-slate-800 brand-font">Resumen Operativo</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-brand-50 text-brand-600 rounded-xl"><Icons.Box size={32}/></div>
                                            <div><div className="text-3xl font-bold text-slate-800">{stats.total}</div><div className="text-xs text-slate-400 font-bold uppercase">Kits Totales</div></div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-accent-50 text-accent-600 rounded-xl"><Icons.Calendar size={32}/></div>
                                            <div><div className="text-3xl font-bold text-slate-800">{stats.today}</div><div className="text-xs text-slate-400 font-bold uppercase">Armados Hoy</div></div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-soft border border-slate-100 flex items-center gap-4">
                                            <div className="p-4 bg-indigo-50 text-indigo-600 rounded-xl"><Icons.FileText size={32}/></div>
                                            <div><div className="text-3xl font-bold text-slate-800">{stats.meds}</div><div className="text-xs text-slate-400 font-bold uppercase">Medicamentos</div></div>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-gradient-to-br from-brand-600 to-brand-800 rounded-3xl p-8 text-white relative overflow-hidden">
                                            <div className="relative z-10">
                                                <h3 className="text-xl font-bold mb-2">Ingreso Rápido</h3>
                                                <p className="opacity-80 text-sm mb-6">Acceda directamente al formulario de producción.</p>
                                                <button onClick={()=>setView('produccion')} className="bg-white text-brand-700 px-6 py-2 rounded-xl font-bold text-sm hover:bg-brand-50 transition-colors shadow-lg">Ir a Producción</button>
                                            </div>
                                            <div className="absolute right-0 bottom-0 opacity-10 transform translate-x-10 translate-y-10"><Icons.Box size={180}/></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'produccion' && <ProductionManagement kits={kits} medicines={medicines} onCreateKit={addKit} onUpdateKit={updateKit} onDeleteKit={deleteKit} currentUser={{name: userName, role: role}} />}
                            
                            {view === 'config' && (role === 'admin' || role === 'superadmin') && <ConfigBlock medicines={medicines} onAddList={addMedsList} />}
                            
                            {view === 'users' && (role === 'admin' || role === 'superadmin') && <UserManagementBlock users={users} onAddUser={addUser} onDeleteUser={deleteUser} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
