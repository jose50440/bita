<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bit√°cora de Producci√≥n - Operaciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (Para Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase (Versi√≥n CDN completa) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        turquoise: { 50:'#f0fdfa', 100:'#ccfbf1', 200:'#99f6e4', 300:'#5eead4', 400:'#2dd4bf', 500:'#14b8a6', 600:'#0d9488', 700:'#0f766e', 800:'#115e59', 900:'#134e4a' },
                        clinical: { 50:'#f0fdf4', 100:'#dcfce7', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#15803d' }
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(20, 184, 166, 0.15)', glow: '0 0 15px rgba(45, 212, 191, 0.3)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdfa; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .row-hover-effect { transition: all 0.2s ease-out; border-left: 3px solid transparent; }
        .row-hover-effect:hover { background-color: white; transform: scale(1.005); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left-color: #0d9488; z-index: 10; position: relative; }

        .group-box { @apply border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4; }
        .group-title { @apply text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1; }

        /* Animaciones */
        @keyframes ekgPulse { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .animate-ekg { animation: ekgPulse 2s infinite ease-in-out; }
        
        /* Impresi√≥n espec√≠fica */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; padding: 0; margin: 0; }
        }
        
        /* Estilos para diferentes orientaciones */
        .print-vertical { width: 71mm; height: 210mm; }
        .print-horizontal { width: 210mm; height: 71mm; }
        
        /* Editor de plantillas */
        .template-editor { min-height: 500px; }
        .template-preview { border: 2px dashed #ccc; min-height: 300px; padding: 20px; }
        .draggable-item { cursor: move; padding: 8px; border: 1px solid #e5e7eb; background: white; margin: 4px 0; border-radius: 6px; }
        .draggable-item:hover { background: #f3f4f6; border-color: #14b8a6; }
        
        /* Estilos espec√≠ficos para el editor de plantillas */
        .drop-zone { min-height: 400px; background: #fafafa; border: 2px dashed #cbd5e1; }
        .template-element { position: absolute; cursor: move; user-select: none; }
        .template-element.selected { outline: 2px solid #14b8a6; z-index: 100; }
        .element-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .element-barcode { background: white; padding: 5px; text-align: center; }
        
        /* √Årea de dise√±o de plantilla */
        .design-area { 
            background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                              linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                              linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-turquoise-200 selection:text-turquoise-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        // CONFIGURACI√ìN MEJORADA DE FIREBASE - NUEVA BASE DE DATOS
        const firebaseConfig = {
            apiKey: "AIzaSyChbdbjQaPkoSj7wXhUrO_ZDG0cJ_RYfFk",
            authDomain: "operacionesbita.firebaseapp.com",
            projectId: "operacionesbita",
            storageBucket: "operacionesbita.firebasestorage.app",
            messagingSenderId: "734557088994",
            appId: "1:734557088994:web:113a9e29320568760602bb"
        };

        // Inicializar Firebase con manejo de errores mejorado
        let app, auth, db, storage;
        let firebaseInitialized = false;
        
        try {
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length === 0) {
                app = firebase.initializeApp(firebaseConfig);
                console.log("üöÄ Firebase inicializando...");
            } else if (firebase.apps && firebase.apps.length > 0) {
                app = firebase.app();
            }
            
            if (app) {
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                firebaseInitialized = true;
                console.log("‚úÖ Firebase inicializado correctamente");
                
                // Configurar persistencia offline
                if (db) {
                    db.enablePersistence()
                        .then(() => console.log("üì¶ Persistencia offline habilitada"))
                        .catch(err => {
                            console.warn("‚ö†Ô∏è Persistencia offline no disponible:", err.code);
                        });
                }
            }
        } catch (error) {
            console.error("‚ùå Error cr√≠tico al inicializar Firebase:", error);
            firebaseInitialized = false;
        }

        // Verificar conexi√≥n a Firestore
        const checkFirestoreConnection = async () => {
            // Solo verificar que Firebase est√© inicializado
            // Firestore crear√° las colecciones autom√°ticamente al escribir datos
            // No intentar leer colecciones que pueden no existir
            return firebaseInitialized && db !== null && db !== undefined;
        };

        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Activity: (p) => <Icon {...p} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            Users: (p) => <Icon {...p} path={<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>} />,
            LogOut: (p) => <Icon {...p} path={<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Settings: (p) => <Icon {...p} path={<circle cx="12" cy="12" r="3"></circle>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash: (p) => <Icon {...p} path={<polyline points="3 6 5 6 21 6"></polyline>} />,
            Printer: (p) => <Icon {...p} path={<polyline points="6 9 6 2 18 2 18 9"></polyline>} />,
            ChevronsRight: (p) => <Icon {...p} path={<polyline points="13 17 18 12 13 7"></polyline>} />,
            UserCog: (p) => <Icon {...p} path={<circle cx="12" cy="7" r="4"></circle>} />,
            Menu: (p) => <Icon {...p} path={<line x1="3" y1="12" x2="21" y2="12"></line>} />,
            X: (p) => <Icon {...p} path={<line x1="18" y1="6" x2="6" y2="18"></line>} />,
            FileText: (p) => <Icon {...p} path={<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></>} />,
            Minus: (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"></line>} />,
            Folder: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></>} />,
            LayoutDashboard: (p) => <Icon {...p} path={<><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Bot: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>} />,
            FolderPlus: (p) => <Icon {...p} path={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            WifiOff: (p) => <Icon {...p} path={<><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></>} />,
            Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1 2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            FileSpreadsheet: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></>} />,
            RefreshCw: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />,
            Layout: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></>} />,
            Type: (p) => <Icon {...p} path={<><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></>} />,
            Image: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>} />,
            Grid: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></>} />,
            QrCode: (p) => <Icon {...p} path={<><rect x="3" y="3" width="8" height="8"></rect><rect x="13" y="3" width="8" height="8"></rect><rect x="3" y="13" width="8" height="8"></rect><rect x="13" y="13" width="8" height="8"></rect></>} />
        };

        // --- COMPONENTS ---

        const AnimatedCounter = ({ value }) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0; const end = parseInt(value, 10);
                if (isNaN(end)) return;
                if (start === end) { setCount(end); return; }
                const duration = 1000; const incrementTime = 20; const stepAmount = Math.ceil(end / (duration / incrementTime));
                let timer = setInterval(() => {
                    start += stepAmount;
                    if (start >= end) { setCount(end); clearInterval(timer); } else { setCount(start); }
                }, incrementTime);
                return () => clearInterval(timer);
            }, [value]);
            return <span>{count}</span>;
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className={`bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[95vh] modal-animate`}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="font-bold text-lg text-slate-800 brand-font">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col modal-animate p-6 text-center">
                        <h3 className="text-lg font-medium text-slate-900 mb-2">{title}</h3>
                        <p className="text-sm text-slate-500 mb-6">{message}</p>
                        <div className="flex justify-center gap-3">
                            <button onClick={onClose} className="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-sm">Cancelar</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- EDITOR DE PLANTILLAS MEJORADO ---
        const TemplateEditorBlock = ({ kitData, patientData }) => {
            const [elements, setElements] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [dragging, setDragging] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [templateName, setTemplateName] = useState('Vi√±eta Ruta');
            const [savedTemplates, setSavedTemplates] = useState([]);
            const [showSaveModal, setShowSaveModal] = useState(false);
            const [templateType, setTemplateType] = useState('ruta'); // 'ventanilla', 'ruta', 'refrigerado'
            const [templateOrientation, setTemplateOrientation] = useState('vertical'); // 'vertical', 'horizontal'
            const [imageUploading, setImageUploading] = useState(false);
            const [uploadedImages, setUploadedImages] = useState([]);
            
            const elementTypes = [
                { id: 'text', name: 'Texto', icon: Icons.Type, default: { content: 'Texto', fontSize: 12, color: '#000000', fontFamily: 'Arial', bold: false, italic: false } },
                { id: 'barcode', name: 'C√≥digo de Barras', icon: Icons.Grid, default: { content: '1234567890', width: 150, height: 50, type: 'code128' } },
                { id: 'qrcode', name: 'QR Code', icon: Icons.QrCode, default: { content: 'https://ejemplo.com', width: 100, height: 100 } },
                { id: 'rectangle', name: 'Rect√°ngulo', icon: Icons.Layout, default: { width: 100, height: 50, color: '#e5e7eb', borderWidth: 1, borderColor: '#000000' } },
                { id: 'line', name: 'L√≠nea', icon: Icons.Minus, default: { width: 150, height: 2, color: '#000000' } },
                { id: 'image', name: 'Imagen', icon: Icons.Image, default: { width: 100, height: 100, url: '', alt: 'Logo' } }
            ];

            // CAMPOS ACTUALIZADOS CON CANTIDAD DE MEDICAMENTOS Y REFRIGERADOS
            const kitFields = [
                { id: 'nombre', label: 'Nombre Paciente', value: kitData?.nombre || patientData?.nombre || 'NOMBRE PACIENTE' },
                { id: 'dni', label: 'DNI', value: kitData?.dni || patientData?.dni || '00000000' },
                { id: 'direccion', label: 'Direcci√≥n', value: patientData?.direccion || 'DIRECCI√ìN' },
                { id: 'telefono', label: 'Tel√©fono', value: patientData?.telefono || '000-0000' },
                { id: 'fechaArmado', label: 'Fecha Armado', value: kitData?.fechaArmado || '2024-01-01' },
                { id: 'horaOperaciones', label: 'Hora Operaciones', value: kitData?.horaOperaciones || '08:00 AM' },
                { id: 'digitador', label: 'Digitador', value: kitData?.digitador || 'DIGITADOR' },
                { id: 'contactCenter', label: 'Contact Center', value: kitData?.contactCenter || 'CONTACTO' },
                { id: 'deliveryMode', label: 'Modo Entrega', value: kitData?.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA' },
                { id: 'medicamentos', label: 'Medicamentos', value: kitData?.medicamentos?.map(m => m.nombre).join(', ') || 'MEDICAMENTOS' },
                { id: 'observaciones', label: 'Observaciones', value: kitData?.observations || 'OBSERVACIONES' },
                { id: 'gpsStatus', label: 'GPS', value: kitData?.gpsStatus || 'SIN GPS' },
                // NUEVOS CAMPOS
                { id: 'cantMedicamentos', label: 'Cantidad Medicamentos', value: kitData?.medicamentos?.length || 0 },
                { id: 'cantRefrigerados', label: 'Cantidad Refrigerados', value: kitData?.isRefrigerated ? (kitData?.cantRefriGlobal || 1) : 0 },
                { id: 'isRefrigerado', label: 'Es Refrigerado', value: kitData?.isRefrigerated ? 'S√ç' : 'NO' }
            ];

            // Cargar plantillas guardadas
            useEffect(() => {
                loadTemplates();
                loadUploadedImages();
            }, []);

            const loadTemplates = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar plantillas');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_templates')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const templates = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setSavedTemplates(templates);
                } catch (error) {
                    console.error('Error cargando plantillas:', error);
                }
            };

            const loadUploadedImages = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar im√°genes');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_images')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const images = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setUploadedImages(images);
                } catch (error) {
                    console.error('Error cargando im√°genes:', error);
                }
            };

            const handleDragStart = (e, type) => {
                e.dataTransfer.setData('elementType', type);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('elementType');
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left - 50;
                const y = e.clientY - rect.top - 25;
                
                const elementType = elementTypes.find(el => el.id === type);
                if (elementType) {
                    const newElement = {
                        id: Date.now().toString(),
                        type,
                        x,
                        y,
                        ...elementType.default
                    };
                    setElements([...elements, newElement]);
                    setSelectedElement(newElement);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const handleElementMouseDown = (e, element) => {
                e.stopPropagation();
                setSelectedElement(element);
                setDragging(true);
                const rect = e.currentTarget.getBoundingClientRect();
                setDragOffset({
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                });
            };

            const handleMouseMove = (e) => {
                if (!dragging || !selectedElement) return;
                
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;
                
                setElements(elements.map(el => 
                    el.id === selectedElement.id 
                        ? { ...el, x: Math.max(0, x), y: Math.max(0, y) }
                        : el
                ));
            };

            const handleMouseUp = () => {
                setDragging(false);
            };

            const updateElement = (updates) => {
                if (!selectedElement) return;
                setElements(elements.map(el => 
                    el.id === selectedElement.id 
                        ? { ...el, ...updates }
                        : el
                ));
                setSelectedElement({ ...selectedElement, ...updates });
            };

            const deleteElement = () => {
                if (!selectedElement) return;
                setElements(elements.filter(el => el.id !== selectedElement.id));
                setSelectedElement(null);
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setImageUploading(true);
                try {
                    if (!firebaseInitialized || !storage) {
                        throw new Error("Firebase Storage no disponible");
                    }
                    
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`templates/${Date.now()}_${file.name}`);
                    await imageRef.put(file);
                    const downloadURL = await imageRef.getDownloadURL();
                    
                    // Guardar referencia en Firestore
                    await db.collection('prod_images').add({
                        name: file.name,
                        url: downloadURL,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Agregar como elemento de imagen
                    const newElement = {
                        id: Date.now().toString(),
                        type: 'image',
                        x: 50,
                        y: 50,
                        width: 100,
                        height: 100,
                        url: downloadURL,
                        alt: file.name
                    };
                    
                    setElements([...elements, newElement]);
                    setSelectedElement(newElement);
                    loadUploadedImages();
                    
                } catch (error) {
                    console.error('Error subiendo imagen:', error);
                    alert('Error al subir la imagen: ' + error.message);
                } finally {
                    setImageUploading(false);
                }
            };

            const saveTemplate = async () => {
                if (!templateName.trim()) {
                    alert('Por favor ingresa un nombre para la plantilla');
                    return;
                }

                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Firebase no disponible");
                    }
                    
                    await db.collection('prod_templates').add({
                        name: templateName,
                        type: templateType,
                        orientation: templateOrientation,
                        elements,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setShowSaveModal(false);
                    alert('Plantilla guardada correctamente');
                    loadTemplates();
                } catch (error) {
                    console.error('Error guardando plantilla:', error);
                    alert('Error al guardar la plantilla: ' + error.message);
                }
            };

            const loadTemplate = (template) => {
                setElements(template.elements || []);
                setTemplateName(template.name);
                setTemplateType(template.type || 'ruta');
                setTemplateOrientation(template.orientation || 'vertical');
                setSelectedElement(null);
            };

            const insertKitField = (field) => {
                const newElement = {
                    id: Date.now().toString(),
                    type: 'text',
                    x: 50,
                    y: 50,
                    content: field.value,
                    fontSize: 12,
                    color: '#000000',
                    fontFamily: 'Arial',
                    bold: false,
                    italic: false,
                    isField: true,
                    fieldId: field.id
                };
                setElements([...elements, newElement]);
                setSelectedElement(newElement);
            };

            const handlePrintPreview = () => {
                const printContent = document.getElementById('template-preview');
                const printWindow = window.open('', '_blank');
                
                const orientationStyle = templateOrientation === 'horizontal' 
                    ? `width: 210mm; height: 71mm;` 
                    : `width: 71mm; height: 210mm;`;
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Vista Previa - ${templateName}</title>
                        <style>
                            body { margin: 0; padding: 0; }
                            .print-area { 
                                ${orientationStyle}
                                border: 1px solid #ccc; 
                                position: relative; 
                                overflow: hidden;
                                font-family: Arial, sans-serif;
                            }
                            .template-element {
                                position: absolute;
                                box-sizing: border-box;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-area">
                            ${printContent.innerHTML}
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
            };

            // Dimensiones seg√∫n orientaci√≥n
            const getDesignAreaDimensions = () => {
                return templateOrientation === 'horizontal' 
                    ? { width: '210mm', height: '71mm' }
                    : { width: '71mm', height: '210mm' };
            };

            const dimensions = getDesignAreaDimensions();

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h4 className="font-bold text-lg text-slate-800">Editor de Plantillas</h4>
                        <div className="flex gap-2">
                            <button 
                                onClick={handlePrintPreview}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                            >
                                <Icons.Printer size={16}/> Vista Previa
                            </button>
                            <button 
                                onClick={() => setShowSaveModal(true)}
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm"
                            >
                                <Icons.Save size={16}/> Guardar Plantilla
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        {/* Panel de elementos y campos */}
                        <div className="lg:col-span-1 space-y-4">
                            <div className="bg-white p-4 rounded-xl border border-slate-200">
                                <h5 className="font-bold text-slate-700 mb-4 text-sm">Elementos Disponibles</h5>
                                <div className="space-y-2">
                                    {elementTypes.map(element => (
                                        <div
                                            key={element.id}
                                            draggable
                                            onDragStart={(e) => handleDragStart(e, element.id)}
                                            className="draggable-item flex items-center gap-3"
                                        >
                                            <element.icon size={18} className="text-turquoise-600"/>
                                            <span>{element.name}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Campos del Kit */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200">
                                <h5 className="font-bold text-slate-700 mb-4 text-sm">Campos del Kit</h5>
                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {kitFields.map(field => (
                                        <div
                                            key={field.id}
                                            onClick={() => insertKitField(field)}
                                            className="p-2 border border-slate-200 rounded hover:bg-slate-50 cursor-pointer"
                                        >
                                            <div className="text-xs font-medium text-slate-800">{field.label}</div>
                                            <div className="text-xs text-slate-500 truncate">{field.value}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Im√°genes subidas */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200">
                                <h5 className="font-bold text-slate-700 mb-4 text-sm">Im√°genes</h5>
                                <div className="space-y-2">
                                    <div className="relative">
                                        <input 
                                            type="file" 
                                            accept="image/*" 
                                            onChange={handleImageUpload}
                                            className="hidden"
                                            id="image-upload"
                                        />
                                        <label htmlFor="image-upload" className="block p-2 border-2 border-dashed border-slate-300 rounded-lg text-center cursor-pointer hover:border-turquoise-500 transition-colors">
                                            <Icons.Upload size={20} className="mx-auto mb-2 text-slate-400"/>
                                            <span className="text-xs text-slate-600">Subir Imagen</span>
                                        </label>
                                    </div>
                                    <div className="max-h-40 overflow-y-auto space-y-2">
                                        {uploadedImages.map(img => (
                                            <div 
                                                key={img.id}
                                                onClick={() => {
                                                    const newElement = {
                                                        id: Date.now().toString(),
                                                        type: 'image',
                                                        x: 50,
                                                        y: 50,
                                                        width: 100,
                                                        height: 100,
                                                        url: img.url,
                                                        alt: img.name
                                                    };
                                                    setElements([...elements, newElement]);
                                                    setSelectedElement(newElement);
                                                }}
                                                className="p-2 border border-slate-200 rounded hover:bg-slate-50 cursor-pointer"
                                            >
                                                <div className="text-xs truncate">{img.name}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* √Årea de dise√±o */}
                        <div className="lg:col-span-2">
                            <div className="bg-white p-4 rounded-xl border border-slate-200 h-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h5 className="font-bold text-slate-700 text-sm">√Årea de Dise√±o ({templateOrientation === 'horizontal' ? '210mm x 71mm' : '71mm x 210mm'})</h5>
                                    <div className="flex gap-2">
                                        <select 
                                            value={templateType}
                                            onChange={(e) => setTemplateType(e.target.value)}
                                            className="text-xs border rounded px-2 py-1"
                                        >
                                            <option value="ventanilla">Ventanilla</option>
                                            <option value="ruta">Ruta</option>
                                            <option value="refrigerado">Refrigerado</option>
                                        </select>
                                        <select 
                                            value={templateOrientation}
                                            onChange={(e) => setTemplateOrientation(e.target.value)}
                                            className="text-xs border rounded px-2 py-1"
                                        >
                                            <option value="vertical">Vertical</option>
                                            <option value="horizontal">Horizontal</option>
                                        </select>
                                    </div>
                                </div>
                                <div 
                                    className="design-area relative rounded-lg border-2 border-slate-300"
                                    onDrop={handleDrop}
                                    onDragOver={handleDragOver}
                                    onMouseMove={handleMouseMove}
                                    onMouseUp={handleMouseUp}
                                    onMouseLeave={handleMouseUp}
                                    style={dimensions}
                                >
                                    <div id="template-preview" style={{ width: '100%', height: '100%', position: 'relative' }}>
                                        {elements.map(element => (
                                            <div
                                                key={element.id}
                                                className={`template-element ${selectedElement?.id === element.id ? 'selected' : ''}`}
                                                style={{
                                                    left: `${element.x}px`,
                                                    top: `${element.y}px`,
                                                    width: element.width ? `${element.width}px` : 'auto',
                                                    height: element.height ? `${element.height}px` : 'auto',
                                                    backgroundColor: element.type === 'rectangle' ? element.color : 'transparent',
                                                    border: element.type === 'line' ? `2px solid ${element.color}` : 
                                                           element.type === 'rectangle' ? `${element.borderWidth || 1}px solid ${element.borderColor || '#000000'}` : 'none',
                                                    fontSize: `${element.fontSize || 12}px`,
                                                    color: element.color || '#000000',
                                                    fontFamily: element.fontFamily || 'Arial',
                                                    fontWeight: element.bold ? 'bold' : 'normal',
                                                    fontStyle: element.italic ? 'italic' : 'normal',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: element.align || 'left'
                                                }}
                                                onMouseDown={(e) => handleElementMouseDown(e, element)}
                                            >
                                                {element.type === 'text' && (
                                                    <div className="whitespace-nowrap overflow-hidden">
                                                        {element.content}
                                                    </div>
                                                )}
                                                {element.type === 'barcode' && (
                                                    <div className="bg-white p-2 border border-slate-300 text-center w-full">
                                                        <div className="text-[10px] text-slate-500">[C√ìDIGO DE BARRAS]</div>
                                                        <div className="text-[8px] text-slate-400">{element.content}</div>
                                                    </div>
                                                )}
                                                {element.type === 'qrcode' && (
                                                    <div className="bg-white p-2 border border-slate-300 text-center w-full">
                                                        <div className="text-[10px] text-slate-500">[QR CODE]</div>
                                                        <div className="text-[8px] text-slate-400 truncate">{element.content}</div>
                                                    </div>
                                                )}
                                                {element.type === 'image' && element.url && (
                                                    <img 
                                                        src={element.url} 
                                                        alt={element.alt}
                                                        className="w-full h-full object-contain"
                                                        style={{ maxWidth: '100%', maxHeight: '100%' }}
                                                    />
                                                )}
                                                {element.type === 'image' && !element.url && (
                                                    <div className="border border-dashed border-slate-300 w-full h-full flex items-center justify-center text-xs text-slate-500">
                                                        [IMAGEN]
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Panel de propiedades */}
                        <div className="lg:col-span-1">
                            <div className="bg-white p-4 rounded-xl border border-slate-200">
                                <h5 className="font-bold text-slate-700 mb-4 text-sm">
                                    {selectedElement ? 'Propiedades del Elemento' : 'Selecciona un elemento'}
                                </h5>
                                
                                {selectedElement && (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">Tipo</label>
                                            <div className="text-sm text-slate-700 capitalize">{selectedElement.type}</div>
                                        </div>
                                        
                                        {selectedElement.type === 'text' && (
                                            <>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Texto</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.content}
                                                        onChange={(e) => updateElement({ content: e.target.value })}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Tama√±o</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.fontSize}
                                                            onChange={(e) => updateElement({ fontSize: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Color</label>
                                                        <input
                                                            type="color"
                                                            className="w-full h-10 border border-slate-300 rounded"
                                                            value={selectedElement.color}
                                                            onChange={(e) => updateElement({ color: e.target.value })}
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.bold}
                                                            onChange={(e) => updateElement({ bold: e.target.checked })}
                                                        />
                                                        <span className="text-xs">Negrita</span>
                                                    </label>
                                                    <label className="flex items-center gap-1">
                                                        <input
                                                            type="checkbox"
                                                            checked={selectedElement.italic}
                                                            onChange={(e) => updateElement({ italic: e.target.checked })}
                                                        />
                                                        <span className="text-xs">It√°lica</span>
                                                    </label>
                                                </div>
                                            </>
                                        )}
                                        
                                        {(selectedElement.type === 'barcode' || selectedElement.type === 'qrcode') && (
                                            <>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Contenido</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.content}
                                                        onChange={(e) => updateElement({ content: e.target.value })}
                                                    />
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.width}
                                                            onChange={(e) => updateElement({ width: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Alto</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.height}
                                                            onChange={(e) => updateElement({ height: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                        
                                        {(selectedElement.type === 'rectangle' || selectedElement.type === 'line') && (
                                            <>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.width}
                                                            onChange={(e) => updateElement({ width: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Alto</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.height}
                                                            onChange={(e) => updateElement({ height: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">Color</label>
                                                    <input
                                                        type="color"
                                                        className="w-full h-10 border border-slate-300 rounded"
                                                        value={selectedElement.color}
                                                        onChange={(e) => updateElement({ color: e.target.value })}
                                                    />
                                                </div>
                                            </>
                                        )}
                                        
                                        {selectedElement.type === 'image' && (
                                            <>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Ancho</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.width}
                                                            onChange={(e) => updateElement({ width: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-500 mb-1">Alto</label>
                                                        <input
                                                            type="number"
                                                            className="w-full p-2 border border-slate-300 rounded text-sm"
                                                            value={selectedElement.height}
                                                            onChange={(e) => updateElement({ height: parseInt(e.target.value) })}
                                                        />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">URL de Imagen</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-slate-300 rounded text-sm"
                                                        value={selectedElement.url}
                                                        onChange={(e) => updateElement({ url: e.target.value })}
                                                        placeholder="URL o subir imagen"
                                                    />
                                                </div>
                                            </>
                                        )}
                                        
                                        {/* Posici√≥n y tama√±o */}
                                        <div className="grid grid-cols-2 gap-2 pt-4 border-t border-slate-200">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Posici√≥n X</label>
                                                <input
                                                    type="number"
                                                    className="w-full p-2 border border-slate-300 rounded text-sm"
                                                    value={selectedElement.x}
                                                    onChange={(e) => updateElement({ x: parseInt(e.target.value) })}
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Posici√≥n Y</label>
                                                <input
                                                    type="number"
                                                    className="w-full p-2 border border-slate-300 rounded text-sm"
                                                    value={selectedElement.y}
                                                    onChange={(e) => updateElement({ y: parseInt(e.target.value) })}
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="pt-4 border-t border-slate-200">
                                            <button
                                                onClick={deleteElement}
                                                className="w-full bg-red-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-red-700"
                                            >
                                                <Icons.Trash size={16} className="inline mr-2"/> Eliminar Elemento
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Plantillas guardadas */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200 mt-4">
                                <h5 className="font-bold text-slate-700 mb-4 text-sm">Plantillas Guardadas</h5>
                                <div className="space-y-2 max-h-60 overflow-y-auto">
                                    {savedTemplates.map(template => (
                                        <div
                                            key={template.id}
                                            onClick={() => loadTemplate(template)}
                                            className="p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer"
                                        >
                                            <div className="font-medium text-slate-800">{template.name}</div>
                                            <div className="text-xs text-slate-500 flex justify-between">
                                                <span className="capitalize">{template.type} - {template.orientation || 'vertical'}</span>
                                                <span>{template.elements?.length || 0} elementos</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Modal para guardar plantilla */}
                    <Modal isOpen={showSaveModal} onClose={() => setShowSaveModal(false)} title="Guardar Plantilla" maxWidth="max-w-md">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Nombre de la Plantilla</label>
                                <input
                                    type="text"
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateName}
                                    onChange={(e) => setTemplateName(e.target.value)}
                                    placeholder="Ej: Vi√±eta Ruta 2024"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Tipo de Plantilla</label>
                                <select
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateType}
                                    onChange={(e) => setTemplateType(e.target.value)}
                                >
                                    <option value="ventanilla">Ventanilla</option>
                                    <option value="ruta">Ruta</option>
                                    <option value="refrigerado">Refrigerado</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Orientaci√≥n</label>
                                <select
                                    className="w-full p-3 border border-slate-300 rounded-lg"
                                    value={templateOrientation}
                                    onChange={(e) => setTemplateOrientation(e.target.value)}
                                >
                                    <option value="vertical">Vertical (71x210mm)</option>
                                    <option value="horizontal">Horizontal (210x71mm)</option>
                                </select>
                            </div>
                            <div className="flex justify-end gap-3 pt-4">
                                <button
                                    onClick={() => setShowSaveModal(false)}
                                    className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={saveTemplate}
                                    className="px-4 py-2 bg-turquoise-600 text-white rounded-lg hover:bg-turquoise-700 font-bold"
                                >
                                    Guardar
                                </button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        // --- SISTEMA DE CACHE MEJORADO ---
        class CacheManager {
            constructor() {
                this.PATIENT_CACHE_PREFIX = 'patient_cache_';
                this.PATIENT_LIST_CACHE_KEY = 'patient_list_cache';
                this.MEDICINES_CACHE_KEY = 'medicines_cache';
                this.CONTACTS_CACHE_KEY = 'contacts_cache';
                this.USERS_CACHE_KEY = 'users_cache';
                this.TEMPLATES_CACHE_KEY = 'templates_cache';
                this.KITS_CACHE_KEY = 'kits_cache';
                this.CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
            }
            
            getFromCache(key) {
                try {
                    const cached = localStorage.getItem(key);
                    if (!cached) return null;
                    
                    const { data, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    
                    if (now - timestamp > this.CACHE_DURATION) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error reading cache:', error);
                    return null;
                }
            }
            
            saveToCache(key, data) {
                try {
                    const cacheData = {
                        data,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(key, JSON.stringify(cacheData));
                } catch (error) {
                    console.error('Error saving to cache:', error);
                }
            }
            
            clearCache(key) {
                localStorage.removeItem(key);
            }
            
            clearPatientCache(patientId = null) {
                if (patientId) {
                    localStorage.removeItem(`${this.PATIENT_CACHE_PREFIX}${patientId}`);
                } else {
                    localStorage.removeItem(this.PATIENT_LIST_CACHE_KEY);
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(this.PATIENT_CACHE_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                }
            }
            
            getPatient(patientId) {
                return this.getFromCache(`${this.PATIENT_CACHE_PREFIX}${patientId}`);
            }
            
            savePatient(patientId, patientData) {
                this.saveToCache(`${this.PATIENT_CACHE_PREFIX}${patientId}`, patientData);
            }
            
            getPatientList() {
                return this.getFromCache(this.PATIENT_LIST_CACHE_KEY);
            }
            
            savePatientList(patientList) {
                this.saveToCache(this.PATIENT_LIST_CACHE_KEY, patientList);
            }
            
            getMedicines() {
                return this.getFromCache(this.MEDICINES_CACHE_KEY);
            }
            
            saveMedicines(medicines) {
                this.saveToCache(this.MEDICINES_CACHE_KEY, medicines);
            }
            
            getContacts() {
                return this.getFromCache(this.CONTACTS_CACHE_KEY);
            }
            
            saveContacts(contacts) {
                this.saveToCache(this.CONTACTS_CACHE_KEY, contacts);
            }
            
            getUsers() {
                return this.getFromCache(this.USERS_CACHE_KEY);
            }
            
            saveUsers(users) {
                this.saveToCache(this.USERS_CACHE_KEY, users);
            }
            
            getKits() {
                return this.getFromCache(this.KITS_CACHE_KEY);
            }
            
            saveKits(kits) {
                this.saveToCache(this.KITS_CACHE_KEY, kits);
            }
            
            getTemplates() {
                return this.getFromCache(this.TEMPLATES_CACHE_KEY);
            }
            
            saveTemplates(templates) {
                this.saveToCache(this.TEMPLATES_CACHE_KEY, templates);
            }
            
            isValid(key) {
                const cached = localStorage.getItem(key);
                if (!cached) return false;
                
                try {
                    const { timestamp } = JSON.parse(cached);
                    return Date.now() - timestamp < this.CACHE_DURATION;
                } catch {
                    return false;
                }
            }
        }

        // --- BLOCK: LOGIN ---
        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [firebaseStatus, setFirebaseStatus] = useState('Conectando...');

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // Verificar estado de Firebase
                const checkFirebase = async () => {
                    if (firebaseInitialized && db) {
                        try {
                            // Verificar conexi√≥n sin depender de colecciones existentes
                            // Firestore crea colecciones autom√°ticamente al guardar datos
                            const isConnected = await checkFirestoreConnection();
                            setFirebaseStatus(isConnected ? 'Conectado' : 'Error de conexi√≥n');
                        } catch (err) {
                            // Si Firebase est√° inicializado, considerarlo conectado
                            // Las colecciones se crear√°n autom√°ticamente al guardar datos
                            setFirebaseStatus('Conectado');
                            console.log("‚ÑπÔ∏è Firebase listo - Las colecciones se crear√°n autom√°ticamente al guardar datos");
                        }
                    } else {
                        setFirebaseStatus('No inicializado');
                    }
                };
                
                checkFirebase();
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            const handleLogin = async (e) => {
                e.preventDefault(); 
                setError(''); 
                setLoading(true);
                
                // Usuario admin de emergencia
                if (username.trim().toLowerCase() === 'admin' && password === 'superadmin') { 
                    onLogin('superadmin', 'Super Usuario'); 
                    setLoading(false);
                    return; 
                }
                
                // Verificar si Firebase est√° disponible
                if (!firebaseInitialized || !db) {
                    setError('No se pudo conectar con la base de datos. Por favor, recarga la p√°gina.');
                    setLoading(false);
                    return;
                }
                
                const userKey = username.trim().toLowerCase();
                
                try {
                    const querySnapshot = await db.collection('prod_users')
                        .where('username', '==', userKey)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                            onLogin(userData.role, userData.nombre || userData.username);
                        } else { 
                            setError("Contrase√±a incorrecta."); 
                            setLoading(false); 
                        }
                    } else { 
                        setError("Usuario no encontrado."); 
                        setLoading(false); 
                    }
                } catch (err) { 
                    console.error('Error en login:', err);
                    setError(`Error de conexi√≥n: ${err.message}`); 
                    setLoading(false); 
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6 relative">
                    <div className="absolute top-6 right-6 flex flex-col gap-2">
                        <div className={`px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-sm transition-all ${isOnline ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                            {isOnline ? <Icons.Wifi size={16}/> : <Icons.WifiOff size={16}/>}
                            {isOnline ? 'Conectado a Internet' : 'Sin Conexi√≥n'}
                        </div>
                        <div className={`px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 ${firebaseStatus === 'Conectado' ? 'bg-green-100 text-green-700 border border-green-200' : firebaseStatus === 'Conectando...' ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' : 'bg-red-100 text-red-700 border border-red-200'}`}>
                            {firebaseStatus === 'Conectado' ? '‚úÖ Base de datos' : firebaseStatus === 'Conectando...' ? 'üîÑ Conectando...' : '‚ùå Base de datos'}
                        </div>
                    </div>

                    <div className="glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50 relative z-10">
                        <div className="text-center mb-10">
                            <div className="bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-ekg">
                                <Icons.Activity size={40} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight brand-font">Bit√°cora <span className="text-turquoise-600">Producci√≥n</span></h1>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Dpto. Operaciones</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold border border-red-100">{error}</div>}
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Usuario</label>
                                    <input 
                                        type="text" 
                                        className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Contrase√±a</label>
                                    <input 
                                        type="password" 
                                        className="w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        required 
                                    />
                                </div>
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading} 
                                className="w-full bg-gradient-to-r from-turquoise-500 to-clinical-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect"
                            >
                                {loading ? 'Verificando...' : 'Iniciar Sesi√≥n'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- BLOCK: DASHBOARD ---
        const DashboardBlock = ({ setView, stats, userName, role }) => { 
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(()=>setTime(new Date()),1000); return ()=>clearInterval(t); }, []);
            
            const allCards = [
                { id: 'reports', label: 'Reportes y Carpetas', icon: Icons.List, color: 'bg-amber-500', desc: 'Ver kits por fecha', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'pacientes', label: 'Gesti√≥n de Pacientes', icon: Icons.Users, color: 'bg-turquoise-500', desc: 'Crear kits por DH', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'config', label: 'Configuraci√≥n', icon: Icons.Settings, color: 'bg-slate-500', desc: 'Cat√°logos del Sistema', allowed: ['admin', 'superadmin'] },
                { id: 'users', label: 'Gesti√≥n de Usuarios', icon: Icons.UserCog, color: 'bg-indigo-500', desc: 'Control de accesos', allowed: ['admin', 'superadmin'] },
            ];

            const visibleCards = allCards.filter(c => c.allowed.includes(role));

            return (
                <div className="w-full max-w-6xl mx-auto space-y-8 animate-in">
                    <div className="bg-gradient-to-r from-turquoise-600 to-clinical-600 rounded-3xl p-8 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10">
                            <h1 className="text-3xl font-bold brand-font mb-2">¬°Hola, {userName}!</h1>
                            <p className="opacity-90 text-sm font-medium uppercase tracking-wider">Operaciones - Bit√°cora de Producci√≥n</p>
                        </div>
                        <div className="absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform origin-bottom-right"></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex flex-col justify-center items-center text-center">
                            <div className="text-5xl font-mono font-bold text-slate-700 tracking-widest mb-2">{time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            <div className="text-sm text-slate-400 font-medium uppercase">{time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'})}</div>
                        </div>
                        <div className="md:col-span-2 grid grid-cols-2 gap-4">
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-turquoise-50 text-turquoise-600 rounded-2xl"><Icons.Box size={32}/></div>
                                <div>
                                    <div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.totalKits}/></div>
                                    <div className="text-xs text-slate-400 font-bold uppercase">Kits Totales</div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4">
                                <div className="p-4 bg-clinical-50 text-clinical-600 rounded-2xl"><Icons.Calendar size={32}/></div>
                                <div>
                                    <div className="text-3xl font-bold text-slate-800"><AnimatedCounter value={stats.todayKits}/></div>
                                    <div className="text-xs text-slate-400 font-bold uppercase">Armados Hoy</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-700 brand-font mt-8">Accesos Directos</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {visibleCards.map(c => (
                            <button 
                                key={c.id} 
                                onClick={() => setView(c.id)} 
                                className="group relative bg-white p-6 rounded-3xl shadow-soft border border-slate-100 hover:shadow-xl transition-all duration-300 text-left hover:-translate-y-1 overflow-hidden"
                            >
                                <div className={`absolute top-0 right-0 w-24 h-24 ${c.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`}></div>
                                <div className={`w-12 h-12 rounded-2xl ${c.color} flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`}>
                                    <c.icon size={24} />
                                </div>
                                <h4 className="font-bold text-lg text-slate-800 mb-1 group-hover:text-turquoise-600 transition-colors">{c.label}</h4>
                                <p className="text-xs text-slate-400">{c.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- BLOCK: REPORTES ---
        const ReportsBlock = ({ kits, patients, userRole, userName, setView }) => {
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedDay, setSelectedDay] = useState(null);
            const [selectedKit, setSelectedKit] = useState(null);
            const [showKitModal, setShowKitModal] = useState(false);
            const [kitToEdit, setKitToEdit] = useState(null);
            
            const groupedByMonth = useMemo(() => {
                const groups = {};
                kits.forEach(kit => {
                    if (!kit.fechaArmado) return;
                    const date = new Date(kit.fechaArmado);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const dayKey = kit.fechaArmado;
                    
                    if (!groups[monthKey]) {
                        groups[monthKey] = {
                            name: monthKey,
                            display: date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }),
                            days: {}
                        };
                    }
                    
                    if (!groups[monthKey].days[dayKey]) {
                        groups[monthKey].days[dayKey] = {
                            date: dayKey,
                            display: date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }),
                            kits: []
                        };
                    }
                    
                    groups[monthKey].days[dayKey].kits.push(kit);
                });
                return groups;
            }, [kits]);

            const downloadDayExcel = (dayKits) => {
                if (!dayKits || dayKits.length === 0) {
                    alert('No hay kits para este d√≠a');
                    return;
                }

                const excelData = dayKits.map(kit => ({
                    'DNI/ID': kit.dni || '',
                    'Nombre': kit.nombre || '',
                    'Cantidad Medicamentos': kit.medicamentos?.length || 0,
                    'Cantidad Refrigerados': kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : 0,
                    'Fecha Armado Kit': kit.fechaArmado || '',
                    'Digitador': kit.digitador || '',
                    'Fecha Entrega Kit': kit.fechaEntregaKit || '',
                    'Modo Entrega': kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla',
                    'Contact Center': kit.contactCenter || '',
                    'GPS': kit.gpsStatus || 'SIN GPS'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Kits del D√≠a");
                
                const fileName = `kits_${selectedDay}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            const handleBack = () => {
                if (selectedKit) {
                    setSelectedKit(null);
                } else if (selectedDay) {
                    setSelectedDay(null);
                } else if (selectedMonth) {
                    setSelectedMonth(null);
                }
            };

            const handleEditKitFromReports = (kit) => {
                setKitToEdit(kit);
                const patient = patients.find(p => p.dni === kit.dni);
                if (patient) {
                    sessionStorage.setItem('editKitFromReports', JSON.stringify({
                        kitId: kit.id,
                        patientId: patient.id,
                        kitData: kit
                    }));
                    setView('pacientes');
                } else {
                    alert('No se encontr√≥ el paciente asociado a este kit');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={handleBack} className={`p-2 rounded-xl transition-colors ${selectedMonth ? 'hover:bg-slate-100 text-slate-500' : 'opacity-0 pointer-events-none'}`}>
                                <Icons.ArrowLeft size={20}/>
                            </button>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">
                                    {selectedKit ? 'Detalle del Kit' : 
                                     selectedDay ? `Kits del ${selectedDay}` :
                                     selectedMonth ? groupedByMonth[selectedMonth]?.display :
                                     'Reportes y Carpetas'}
                                </h3>
                                <p className="text-xs font-semibold text-turquoise-600">
                                    {selectedKit ? 'Informaci√≥n completa' :
                                     selectedDay ? `${groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.length || 0} Kits` :
                                     selectedMonth ? `${Object.keys(groupedByMonth[selectedMonth]?.days || {}).length} d√≠as` :
                                     `${Object.keys(groupedByMonth).length} meses, ${kits.length} kits totales`}
                                </p>
                            </div>
                        </div>
                        
                        {(userRole === 'admin' || userRole === 'superadmin') && selectedDay && (
                            <button 
                                onClick={() => downloadDayExcel(groupedByMonth[selectedMonth]?.days[selectedDay]?.kits)} 
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect"
                            >
                                <Icons.Download size={16}/> Descargar Excel
                            </button>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        {selectedKit ? (
                            <div className="text-center py-10 text-slate-400">
                                Redirigiendo a modal de detalles...
                            </div>
                        ) : selectedDay ? (
                            <div className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.map(kit => (
                                        <div 
                                            key={kit.id} 
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:shadow-md transition-all"
                                        >
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="font-bold text-slate-800 text-sm truncate">{kit.nombre}</div>
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${kit.deliveryMode === 'ruta' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla'}
                                                </span>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                <div className="text-xs text-slate-500 flex items-center gap-2">
                                                    <span className="font-mono bg-slate-100 px-2 py-0.5 rounded">{kit.dni}</span>
                                                    <span className="text-turquoise-600 font-bold">{kit.medicamentos?.length || 0} meds</span>
                                                </div>
                                                <div className="text-xs text-slate-400 flex justify-between">
                                                    <span>{kit.horaOperaciones || '--:--'}</span>
                                                    <span>{kit.digitador}</span>
                                                </div>
                                                {kit.isRefrigerated && (
                                                    <div className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado: {kit.cantRefriGlobal || 1}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 pt-2 border-t border-slate-100">
                                                <button 
                                                    onClick={() => { setSelectedKit(kit); setShowKitModal(true); }}
                                                    className="flex-1 bg-slate-100 text-slate-700 py-1.5 rounded text-xs font-medium hover:bg-slate-200 transition-colors"
                                                >
                                                    Ver
                                                </button>
                                                <button 
                                                    onClick={() => handleEditKitFromReports(kit)}
                                                    className="flex-1 bg-orange-600 text-white py-1.5 rounded text-xs font-medium hover:bg-orange-700 transition-colors flex items-center justify-center gap-1"
                                                >
                                                    <Icons.Edit size={12}/> Editar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : selectedMonth ? (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    {Object.entries(groupedByMonth[selectedMonth]?.days || {}).sort((a, b) => b[0].localeCompare(a[0])).map(([date, dayData]) => (
                                        <div 
                                            key={date} 
                                            onClick={() => setSelectedDay(date)}
                                            className="bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer flex flex-col items-center text-center gap-3 transition-all group"
                                        >
                                            <div className="bg-turquoise-100 p-3 rounded-full text-turquoise-600 group-hover:scale-110 transition-transform">
                                                <Icons.Calendar size={24}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-sm text-slate-700">{dayData.display}</h4>
                                                <p className="text-[10px] text-slate-400 mt-1">{dayData.kits.length} Kits</p>
                                            </div>
                                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); downloadDayExcel(dayData.kits); }}
                                                    className="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full hover:bg-green-200 transition-colors"
                                                >
                                                    <Icons.Download size={10}/> Excel
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                    {Object.entries(groupedByMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([monthKey, monthData]) => (
                                        <div 
                                            key={monthKey} 
                                            onClick={() => setSelectedMonth(monthKey)}
                                            className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-turquoise-400 hover:shadow-lg cursor-pointer flex flex-col items-center text-center gap-4 transition-all group"
                                        >
                                            <div className="bg-gradient-to-br from-turquoise-500 to-clinical-500 p-4 rounded-2xl text-white group-hover:scale-110 transition-transform">
                                                <Icons.Folder size={32}/>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-lg text-slate-800">{monthData.display}</h4>
                                                <p className="text-sm text-slate-400 mt-1">
                                                    {Object.keys(monthData.days).length} d√≠as ‚Ä¢ {Object.values(monthData.days).reduce((acc, day) => acc + day.kits.length, 0)} kits
                                                </p>
                                            </div>
                                            <div className="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                                {monthKey === `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}` ? 'MES ACTUAL' : 'HIST√ìRICO'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: PACIENTES ---
        const PatientManagementBlock = ({ medicines, onAddPatient, onUpdatePatient, onDeletePatient, onSaveKit, onDeleteKit, currentUser, userRole, contacts }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [selectedPatientFullData, setSelectedPatientFullData] = useState(null);
            const [showPatientForm, setShowPatientForm] = useState(false);
            const [editingPatientId, setEditingPatientId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const [patientsPerPage] = useState(50);
            const [loadingPatients, setLoadingPatients] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [patientCache] = useState(new CacheManager());
            const [showPrintModal, setShowPrintModal] = useState(false);
            const [showTemplateEditor, setShowTemplateEditor] = useState(false);
            const [isViewMode, setIsViewMode] = useState(false);
            const [printTemplates, setPrintTemplates] = useState([]);
            const [selectedPrintTemplate, setSelectedPrintTemplate] = useState(null);
            const [kitData, setKitData] = useState({ 
                fechaArmado: new Date().toISOString().split('T')[0], 
                fechaEntregaLogistica: '', 
                fechaEntregaKit: '', 
                horaOperaciones: '', 
                contactCenter: '', 
                triggerMeds: '', 
                medicamentos: [],
                digitador: '',
                deliveryMode: '', 
                selectedPhones: [], 
                otherPhoneEnabled: false, 
                otherPhone: '',
                addressConfirmed: true, 
                secondaryAddress: '',
                gpsStatus: 'SIN GPS', 
                observationsEnabled: false,
                observations: '',
                isRefrigerated: false, 
                cantRefriGlobal: '' 
            });
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);
            const [patientSnapshotUnsubscribe, setPatientSnapshotUnsubscribe] = useState(null);
            const [patientForm, setPatientForm] = useState({ 
                dni: '', 
                nombre: '', 
                telefono: '', 
                direccion: '', 
                familiar: '', 
                telefonoFamiliar: '', 
                descripcionMunicipio: '', 
                tipoAfiliado: 'AFILIADO DIRECTO',
                nAfiliacion: '' 
            });

            // Cargar plantillas de impresi√≥n
            const loadPrintTemplates = async () => {
                try {
                    if (!firebaseInitialized || !db) {
                        console.warn('Firebase no disponible para cargar plantillas de impresi√≥n');
                        return;
                    }
                    
                    const snapshot = await db.collection('prod_templates').get();
                    const templates = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setPrintTemplates(templates);
                } catch (error) {
                    console.error('Error cargando plantillas de impresi√≥n:', error);
                }
            };

            const loadPatients = async () => {
                setLoadingPatients(true);
                setLoadingProgress(0);
                
                try {
                    const cachedPatients = patientCache.getPatientList();
                    if (cachedPatients && cachedPatients.length > 0) {
                        setPatients(cachedPatients);
                        setLoadingPatients(false);
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_patients')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    const allPatients = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        dni: doc.data().dni || '',
                        nombre: doc.data().nombre || '',
                        tipoAfiliado: doc.data().tipoAfiliado || 'AFILIADO DIRECTO',
                        createdAt: doc.data().createdAt
                    }));
                    
                    patientCache.savePatientList(allPatients);
                    setPatients(allPatients);
                    
                } catch (error) {
                    console.error('Error cargando pacientes:', error);
                    alert('Error al cargar pacientes: ' + error.message);
                } finally {
                    setLoadingProgress(100);
                    setTimeout(() => setLoadingPatients(false), 500);
                }
            };

            const loadKits = async () => {
                try {
                    const cachedKits = patientCache.getKits();
                    if (cachedKits) {
                        setKits(cachedKits);
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const kitsSnapshot = await db.collection('prod_kits').get();
                    const kitsData = kitsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                    
                    patientCache.saveKits(kitsData);
                    setKits(kitsData);
                } catch (error) {
                    console.error('Error cargando kits:', error);
                }
            };

            useEffect(() => {
                loadPatients();
                loadKits();
                loadPrintTemplates();
            }, []);

            useEffect(() => {
                const editKitData = sessionStorage.getItem('editKitFromReports');
                if (editKitData) {
                    const { kitData, patientId } = JSON.parse(editKitData);
                    const patient = patients.find(p => p.id === patientId);
                    if (patient && kitData) {
                        handleSelectPatient(patient);
                        setKitData({...kitData, otherPhoneEnabled: !!kitData.otherPhone});
                        setEditingKitId(kitData.id);
                        setIsViewMode(false);
                        setShowKitForm(true);
                    }
                    sessionStorage.removeItem('editKitFromReports');
                }
            }, [patients]);

            const loadPatientFullData = async (patientId) => {
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                }
                
                try {
                    const cachedPatient = patientCache.getPatient(patientId);
                    if (cachedPatient) {
                        setSelectedPatientFullData(cachedPatient);
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const patientDoc = await db.collection('prod_patients').doc(patientId).get();
                    if (patientDoc.exists) {
                        const fullData = { id: patientDoc.id, ...patientDoc.data() };
                        setSelectedPatientFullData(fullData);
                        patientCache.savePatient(patientId, fullData);
                        
                        const unsubscribe = db.collection('prod_patients').doc(patientId)
                            .onSnapshot((doc) => {
                                if (doc.exists) {
                                    const updatedData = { id: doc.id, ...doc.data() };
                                    setSelectedPatientFullData(updatedData);
                                    patientCache.savePatient(patientId, updatedData);
                                }
                            });
                        
                        setPatientSnapshotUnsubscribe(() => unsubscribe);
                    }
                } catch (error) {
                    console.error("Error cargando datos del paciente:", error);
                }
            };

            const handleSelectPatient = async (patient) => {
                setSelectedPatient(patient);
                await loadPatientFullData(patient.id);
            };

            useEffect(() => {
                return () => {
                    if (patientSnapshotUnsubscribe) {
                        patientSnapshotUnsubscribe();
                    }
                };
            }, [patientSnapshotUnsubscribe]);

            const filteredPatients = useMemo(() => {
                return patients.filter(p => 
                    (p.nombre?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                     p.dni?.includes(searchTerm))
                );
            }, [patients, searchTerm]);

            const indexOfLastPatient = currentPage * patientsPerPage;
            const indexOfFirstPatient = indexOfLastPatient - patientsPerPage;
            const currentPatients = filteredPatients.slice(indexOfFirstPatient, indexOfLastPatient);
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);

            const patientKits = selectedPatient ? kits.filter(k => k.patientId === selectedPatient.id) : [];

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws);
                    
                    let added = 0;
                    let skipped = 0;
                    let updated = 0;

                    for (const row of data) {
                        const pData = {
                            dni: String(row['DNI'] || row['dni'] || '').trim(),
                            nombre: String(row['NOMBRE'] || row['nombre'] || '').toUpperCase().trim(),
                            telefono: String(row['TELEFONO'] || row['telefono'] || '').trim(),
                            direccion: String(row['DIRECCION'] || row['direccion'] || '').toUpperCase().trim(),
                            familiar: String(row['FAMILIAR'] || row['familiar'] || '').toUpperCase().trim(),
                            telefonoFamiliar: String(row['TELEFONOFAMILIAR'] || row['telefonofamiliar'] || '').trim(),
                            descripcionMunicipio: String(row['DESCRIPCION_MUNICIPIO'] || row['descripcion_municipio'] || '').toUpperCase().trim(),
                            tipoAfiliado: String(row['TIPOAFILIADO'] || row['tipoafiliado'] || 'AFILIADO DIRECTO').toUpperCase().trim(),
                            nAfiliacion: String(row['DNI'] || row['dni'] || '').trim() 
                        };

                        if (!pData.dni) continue;

                        const existingPatient = patients.find(p => p.dni === pData.dni);

                        if (existingPatient) {
                            let needsUpdate = false;
                            const updates = {};
                            const checkAndFill = (field) => {
                                const dbValue = existingPatient[field];
                                const excelValue = pData[field];
                                if ((!dbValue || dbValue.trim() === '') && (excelValue && excelValue.trim() !== '')) {
                                    updates[field] = excelValue;
                                    needsUpdate = true;
                                }
                            };
                            checkAndFill('nombre'); checkAndFill('telefono'); checkAndFill('direccion');
                            checkAndFill('familiar'); checkAndFill('telefonoFamiliar'); checkAndFill('descripcionMunicipio');
                            
                            if ((!existingPatient.tipoAfiliado || existingPatient.tipoAfiliado === 'AFILIADO DIRECTO') && pData.tipoAfiliado && pData.tipoAfiliado !== 'AFILIADO DIRECTO') {
                                 updates.tipoAfiliado = pData.tipoAfiliado; needsUpdate = true;
                            }

                            if (needsUpdate) { 
                                await onUpdatePatient(existingPatient.id, updates); 
                                patientCache.clearPatientCache(existingPatient.id);
                                updated++; 
                            } else { skipped++; }
                        } else {
                            const result = await onAddPatient(pData);
                            patientCache.clearPatientCache();
                            added++;
                        }
                    }
                    
                    await loadPatients();
                    
                    alert(`Resumen de Carga:\n\n‚úÖ Pacientes Agregados: ${added}\nüîÑ Pacientes Modificados: ${updated}\n‚è≠Ô∏è Pacientes Omitidos: ${skipped}`);
                };
                reader.readAsBinaryString(file);
                e.target.value = null; 
            };

            const handlePatientSubmit = async (e) => { 
                e.preventDefault(); 
                try {
                    if (editingPatientId) {
                        await onUpdatePatient(editingPatientId, patientForm); 
                        patientCache.clearPatientCache(editingPatientId);
                    } else {
                        await onAddPatient(patientForm);
                        patientCache.clearPatientCache();
                    }
                    await loadPatients();
                    closePatientForm();
                } catch (error) {
                    alert('Error al guardar paciente: ' + error.message);
                }
            };
            
            const closePatientForm = () => { 
                setPatientForm({ 
                    dni: '', 
                    nombre: '', 
                    telefono: '', 
                    direccion: '', 
                    familiar: '', 
                    telefonoFamiliar: '', 
                    descripcionMunicipio: '', 
                    tipoAfiliado: 'AFILIADO DIRECTO',
                    nAfiliacion: '' 
                }); 
                setEditingPatientId(null); 
                setShowPatientForm(false); 
            };
            
            const openEditPatient = async (e, p) => { 
                e.stopPropagation(); 
                try {
                    const cachedPatient = patientCache.getPatient(p.id);
                    if (cachedPatient) {
                        setPatientForm(cachedPatient);
                    } else {
                        if (!firebaseInitialized || !db) {
                            throw new Error("Base de datos no disponible");
                        }
                        const patientDoc = await db.collection('prod_patients').doc(p.id).get();
                        if (patientDoc.exists) {
                            setPatientForm({ id: p.id, ...patientDoc.data() });
                        } else {
                            setPatientForm(p);
                        }
                    }
                } catch (error) {
                    console.error("Error cargando paciente:", error);
                    setPatientForm(p);
                }
                setEditingPatientId(p.id); 
                setShowPatientForm(true); 
            };

            const handleKitSubmit = async (e) => {
                e.preventDefault();
                if (isViewMode) { closeKitForm(); return; } 
                
                try {
                    const finalData = { 
                        ...kitData, 
                        digitador: currentUser.name, 
                        dni: selectedPatient.dni, 
                        nombre: selectedPatient.nombre,
                        patientId: selectedPatient.id
                    }; 
                    
                    if (!editingKitId && !finalData.horaOperaciones) {
                        finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
                    }
                    
                    const kitId = await onSaveKit(editingKitId, finalData, selectedPatient.id, !!editingKitId);
                    
                    patientCache.clearPatientCache(selectedPatient.id);
                    patientCache.clearCache(patientCache.KITS_CACHE_KEY);
                    
                    if (editingKitId) {
                        ['ventanilla', 'ruta', 'refri'].forEach(mode => {
                            localStorage.removeItem(`vineta_${editingKitId}_${mode}`);
                        });
                    }
                    
                    await loadKits();
                    closeKitForm();
                } catch (error) {
                    alert('Error al guardar kit: ' + error.message);
                }
            };
            
            const closeKitForm = () => { 
                setKitData({ 
                    fechaArmado: new Date().toISOString().split('T')[0], 
                    fechaEntregaLogistica: '', 
                    fechaEntregaKit: '', 
                    horaOperaciones: '', 
                    contactCenter: '', 
                    triggerMeds: '', 
                    medicamentos: [],
                    digitador: '',
                    deliveryMode: '', 
                    selectedPhones: [], 
                    otherPhoneEnabled: false, 
                    otherPhone: '',
                    addressConfirmed: true, 
                    secondaryAddress: '',
                    gpsStatus: 'SIN GPS', 
                    observationsEnabled: false,
                    observations: '',
                    isRefrigerated: false, 
                    cantRefriGlobal: '' 
                }); 
                setEditingKitId(null); 
                setShowKitForm(false); 
                setIsViewMode(false); 
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };
            
            const openNewKit = () => {
                setKitData({ 
                    fechaArmado: new Date().toISOString().split('T')[0], 
                    fechaEntregaLogistica: '', 
                    fechaEntregaKit: '', 
                    horaOperaciones: '', 
                    contactCenter: '', 
                    triggerMeds: '', 
                    medicamentos: [],
                    digitador: currentUser.name,
                    deliveryMode: '', 
                    selectedPhones: [], 
                    otherPhoneEnabled: false, 
                    otherPhone: '',
                    addressConfirmed: true, 
                    secondaryAddress: '',
                    gpsStatus: 'SIN GPS', 
                    observationsEnabled: false,
                    observations: '',
                    isRefrigerated: false, 
                    cantRefriGlobal: '' 
                });
                setIsViewMode(false);
                setShowKitForm(true);
            };
            
            const openEditKit = (k, viewOnly = false) => { 
                setKitData({...k, otherPhoneEnabled: !!k.otherPhone}); 
                setEditingKitId(k.id); 
                setIsViewMode(viewOnly);
                setShowKitForm(true); 
            };

            const handleMedChange = (idx, field, val) => {
                const newMeds = [...kitData.medicamentos];
                newMeds[idx] = { ...newMeds[idx], [field]: val };
                setKitData({...kitData, medicamentos: newMeds});
            };
            
            const handleTriggerMeds = (val) => {
                const parsed = parseInt(val, 10);
                const count = isNaN(parsed) ? 0 : parsed;
                const safeCount = Math.min(Math.max(count, 0), 30);
                const currentMeds = kitData.medicamentos || [];
                let newMeds = [];
                if (safeCount > currentMeds.length) {
                    newMeds = [...currentMeds, ...Array(safeCount - currentMeds.length).fill({ nombre: '', idReceta: '', cantidad: '', cantRefri: '' })];
                } else {
                    newMeds = currentMeds.slice(0, safeCount);
                }
                setKitData({...kitData, triggerMeds: val, medicamentos: newMeds});
            };

            const togglePhoneSelection = (phone) => {
                const current = kitData.selectedPhones || [];
                if(current.includes(phone)) {
                    setKitData({...kitData, selectedPhones: current.filter(p => p !== phone)});
                } else {
                    setKitData({...kitData, selectedPhones: [...current, phone]});
                }
            };

            const handleBackToList = () => {
                setSelectedPatient(null);
                setSelectedPatientFullData(null);
                if (patientSnapshotUnsubscribe) {
                    patientSnapshotUnsubscribe();
                    setPatientSnapshotUnsubscribe(null);
                }
            };

            // Funci√≥n para editar plantillas
            const handleEditTemplate = () => {
                setShowTemplateEditor(true);
            };

            // Funci√≥n para imprimir vi√±eta
            const handlePrintVineta = (kit) => {
                // Filtrar plantillas seg√∫n el tipo de kit
                let availableTemplates = printTemplates;
                
                if (kit.deliveryMode === 'ruta') {
                    availableTemplates = printTemplates.filter(t => t.type === 'ruta');
                } else if (kit.deliveryMode === 'ventanilla') {
                    availableTemplates = printTemplates.filter(t => t.type === 'ventanilla');
                }
                
                if (kit.isRefrigerated) {
                    availableTemplates = printTemplates.filter(t => t.type === 'refrigerado');
                }
                
                setSelectedPrintTemplate(availableTemplates[0] || null);
                setShowPrintModal(true);
            };

            // Funci√≥n para generar contenido de impresi√≥n
            const generatePrintContent = (kit, template) => {
                if (!template) return '';
                
                const orientationClass = template.orientation === 'horizontal' ? 'print-horizontal' : 'print-vertical';
                
                // Reemplazar campos en los elementos
                const elementsWithData = template.elements.map(element => {
                    let content = element.content || '';
                    
                    // Reemplazar campos din√°micos
                    if (element.isField) {
                        switch(element.fieldId) {
                            case 'nombre':
                                content = kit.nombre || '';
                                break;
                            case 'dni':
                                content = kit.dni || '';
                                break;
                            case 'direccion':
                                content = selectedPatientFullData?.direccion || '';
                                break;
                            case 'telefono':
                                content = selectedPatientFullData?.telefono || '';
                                break;
                            case 'fechaArmado':
                                content = kit.fechaArmado || '';
                                break;
                            case 'horaOperaciones':
                                content = kit.horaOperaciones || '';
                                break;
                            case 'digitador':
                                content = kit.digitador || '';
                                break;
                            case 'contactCenter':
                                content = kit.contactCenter || '';
                                break;
                            case 'deliveryMode':
                                content = kit.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA';
                                break;
                            case 'medicamentos':
                                content = kit.medicamentos?.map(m => m.nombre).join(', ') || '';
                                break;
                            case 'observaciones':
                                content = kit.observations || '';
                                break;
                            case 'gpsStatus':
                                content = kit.gpsStatus || 'SIN GPS';
                                break;
                            case 'cantMedicamentos':
                                content = kit.medicamentos?.length || 0;
                                break;
                            case 'cantRefrigerados':
                                // Solo mostrar si es refrigerado
                                content = kit.isRefrigerated ? (kit.cantRefriGlobal || 1) : '';
                                break;
                            case 'isRefrigerado':
                                content = kit.isRefrigerated ? 'S√ç' : 'NO';
                                break;
                            default:
                                content = element.content || '';
                        }
                    }
                    
                    return {
                        ...element,
                        content: content.toString()
                    };
                });
                
                // Generar HTML para impresi√≥n
                return `
                    <div class="print-area ${orientationClass} p-4 relative" style="font-family: Arial, sans-serif;">
                        ${elementsWithData.map(element => `
                            <div style="
                                position: absolute;
                                left: ${element.x}px;
                                top: ${element.y}px;
                                width: ${element.width || 'auto'}px;
                                height: ${element.height || 'auto'}px;
                                font-size: ${element.fontSize || 12}px;
                                color: ${element.color || '#000000'};
                                font-family: ${element.fontFamily || 'Arial'};
                                font-weight: ${element.bold ? 'bold' : 'normal'};
                                font-style: ${element.italic ? 'italic' : 'normal'};
                                background-color: ${element.type === 'rectangle' ? element.color : 'transparent'};
                                border: ${element.type === 'line' ? `2px solid ${element.color}` : 
                                       element.type === 'rectangle' ? `${element.borderWidth || 1}px solid ${element.borderColor || '#000000'}` : 'none'};
                                display: flex;
                                align-items: center;
                                justify-content: ${element.align || 'left'};
                            ">
                                ${element.type === 'text' ? element.content : ''}
                                ${element.type === 'barcode' ? `<div style="background: white; padding: 5px; text-align: center; width: 100%;">[C√ìDIGO DE BARRAS]<br/><small>${element.content}</small></div>` : ''}
                                ${element.type === 'qrcode' ? `<div style="background: white; padding: 5px; text-align: center; width: 100%;">[QR CODE]<br/><small>${element.content}</small></div>` : ''}
                                ${element.type === 'image' && element.url ? `<img src="${element.url}" alt="${element.alt}" style="max-width: 100%; max-height: 100%;">` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            // Funci√≥n para imprimir
            const handlePrint = (kit) => {
                const template = selectedPrintTemplate;
                if (!template) {
                    alert('No hay plantilla seleccionada');
                    return;
                }
                
                const printContent = generatePrintContent(kit, template);
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Imprimir Vi√±eta - ${kit.nombre}</title>
                        <style>
                            body { margin: 0; padding: 0; }
                            @media print {
                                body * { visibility: hidden; }
                                .print-area, .print-area * { visibility: visible; }
                                .print-area { position: absolute; left: 0; top: 0; padding: 0; margin: 0; }
                            }
                            .print-vertical { width: 71mm; height: 210mm; }
                            .print-horizontal { width: 210mm; height: 71mm; }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            }
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            };

            if (loadingPatients) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                        <div className="flex-1 flex items-center justify-center">
                            <div className="text-center">
                                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-turquoise-600 mb-4"></div>
                                <h3 className="text-lg font-bold text-slate-700 mb-2">Cargando pacientes...</h3>
                                <p className="text-sm text-slate-500 mb-4">Optimizando datos para mejor rendimiento</p>
                                <div className="w-64 bg-slate-200 rounded-full h-2 mx-auto">
                                    <div 
                                        className="bg-turquoise-600 h-2 rounded-full transition-all duration-300"
                                        style={{ width: `${loadingProgress}%` }}
                                    ></div>
                                </div>
                                <p className="text-xs text-slate-400 mt-2">{loadingProgress}% completado</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showTemplateEditor) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white/50 backdrop-blur-md">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setShowTemplateEditor(false)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect">
                                    <Icons.ArrowLeft size={20} />
                                </button>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Editor de Plantillas</h3>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6">
                            <TemplateEditorBlock 
                                kitData={kitData}
                                patientData={selectedPatientFullData}
                            />
                        </div>
                    </div>
                );
            }

            if (selectedPatient) {
                return (
                    <div className="glass-panel rounded-3xl shadow-soft h-full flex flex-col animate-in border-0 bg-white">
                        
                        <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                        
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={handleBackToList} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect">
                                    <Icons.ArrowLeft size={20} />
                                </button>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 brand-font leading-none">{selectedPatient.nombre}</h3>
                                    <p className="text-[10px] text-slate-400 font-mono mt-0.5">DNI: {selectedPatient.dni}</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                {(userRole === 'admin' || userRole === 'superadmin') && (
                                    <button onClick={handleEditTemplate} className="flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect bg-purple-600 hover:bg-purple-700 text-white">
                                        <Icons.Edit size={16}/> Editar Plantilla
                                    </button>
                                )}
                                <button onClick={openNewKit} className="flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect bg-turquoise-600 hover:bg-turquoise-700 text-white">
                                    <Icons.FolderPlus size={16}/> Nuevo Kit
                                </button>
                            </div>
                        </div>

                        {/* Modal para imprimir */}
                        <Modal isOpen={showPrintModal} onClose={() => setShowPrintModal(false)} title="Imprimir Vi√±eta" maxWidth="max-w-md">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Seleccionar Plantilla</label>
                                    <select 
                                        className="w-full p-3 border border-slate-300 rounded-lg"
                                        value={selectedPrintTemplate?.id || ''}
                                        onChange={(e) => {
                                            const template = printTemplates.find(t => t.id === e.target.value);
                                            setSelectedPrintTemplate(template);
                                        }}
                                    >
                                        <option value="">Seleccione una plantilla</option>
                                        {printTemplates
                                            .filter(t => {
                                                // Filtrar seg√∫n el tipo de kit
                                                if (kitData.deliveryMode === 'ruta') {
                                                    return t.type === 'ruta';
                                                } else if (kitData.deliveryMode === 'ventanilla') {
                                                    return t.type === 'ventanilla';
                                                }
                                                if (kitData.isRefrigerated) {
                                                    return t.type === 'refrigerado';
                                                }
                                                return true;
                                            })
                                            .map(template => (
                                                <option key={template.id} value={template.id}>
                                                    {template.name} ({template.type} - {template.orientation || 'vertical'})
                                                </option>
                                            ))
                                        }
                                    </select>
                                </div>
                                
                                {selectedPrintTemplate && (
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <div className="text-sm font-bold text-slate-700 mb-2">{selectedPrintTemplate.name}</div>
                                        <div className="text-xs text-slate-500">
                                            Tipo: {selectedPrintTemplate.type} | 
                                            Orientaci√≥n: {selectedPrintTemplate.orientation || 'vertical'} | 
                                            Elementos: {selectedPrintTemplate.elements?.length || 0}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex justify-end gap-3 pt-4">
                                    <button
                                        onClick={() => setShowPrintModal(false)}
                                        className="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={() => handlePrint(kitData)}
                                        disabled={!selectedPrintTemplate}
                                        className="px-4 py-2 bg-turquoise-600 text-white rounded-lg hover:bg-turquoise-700 font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <Icons.Printer size={16} className="inline mr-2"/> Imprimir
                                    </button>
                                </div>
                            </div>
                        </Modal>

                        <Modal isOpen={showKitForm} onClose={closeKitForm} title={isViewMode ? "Detalle del Kit" : (editingKitId ? "Editar Kit" : "Nuevo Kit de Producci√≥n")} maxWidth="max-w-4xl">
                            <form onSubmit={handleKitSubmit} className="space-y-6">
                                <fieldset disabled={isViewMode} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b border-slate-100 pb-4 bg-slate-50 p-4 rounded-xl">
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">DNI del Paciente</label>
                                            <input type="text" value={selectedPatient.dni} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Nombre del Paciente</label>
                                            <input type="text" value={selectedPatient.nombre} disabled className="w-full p-2.5 border border-slate-200 rounded-lg text-sm bg-white text-slate-700 font-bold" />
                                        </div>
                                    </div>

                                    <div className="flex gap-4 justify-center pb-4 border-b border-slate-100">
                                        <button type="button" onClick={()=>setKitData({...kitData, deliveryMode: 'ventanilla'})} className={`px-6 py-2 rounded-lg font-bold transition-all ${kitData.deliveryMode === 'ventanilla' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>Ventanilla</button>
                                        <button type="button" onClick={()=>setKitData({...kitData, deliveryMode: 'ruta'})} className={`px-6 py-2 rounded-lg font-bold transition-all ${kitData.deliveryMode === 'ruta' ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>Ruta</button>
                                    </div>

                                    <div className={`transition-all duration-300 ${kitData.deliveryMode === 'ventanilla' ? 'opacity-40 pointer-events-none grayscale' : ''}`}>
                                        <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Confirmar Datos de Contacto</h5>
                                            <div className="space-y-2 mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block">Seleccionar Tel√©fonos a Llamar:</label>
                                                {selectedPatientFullData?.telefono && (
                                                    <label className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200 cursor-pointer">
                                                        <input type="checkbox" checked={kitData.selectedPhones?.includes(selectedPatientFullData.telefono)} onChange={()=>togglePhoneSelection(selectedPatientFullData.telefono)} />
                                                        <span className="text-sm">{selectedPatientFullData.telefono} (Personal)</span>
                                                    </label>
                                                )}
                                                {selectedPatientFullData?.telefonoFamiliar && (
                                                    <label className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200 cursor-pointer">
                                                        <input type="checkbox" checked={kitData.selectedPhones?.includes(selectedPatientFullData.telefonoFamiliar)} onChange={()=>togglePhoneSelection(selectedPatientFullData.telefonoFamiliar)} />
                                                        <span className="text-sm">{selectedPatientFullData.telefonoFamiliar} (Familiar)</span>
                                                    </label>
                                                )}
                                                <div className="flex items-center gap-2 p-2 bg-white rounded border border-slate-200">
                                                    <input type="checkbox" checked={kitData.otherPhoneEnabled} onChange={(e) => setKitData({...kitData, otherPhoneEnabled: e.target.checked, otherPhone: e.target.checked ? kitData.otherPhone : ''})} />
                                                    <span className="text-sm whitespace-nowrap">Otro:</span>
                                                    <input type="text" className={`w-full p-1 border-b border-slate-300 outline-none text-sm ${!kitData.otherPhoneEnabled ? 'bg-slate-50 text-slate-400 cursor-not-allowed' : ''}`} placeholder="Ingresar otro n√∫mero" value={kitData.otherPhone} onChange={e=>setKitData({...kitData, otherPhone:e.target.value})} disabled={!kitData.otherPhoneEnabled} />
                                                </div>
                                            </div>
                                            <div className="mb-4">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Confirmar Ubicaci√≥n (Primaria: {selectedPatientFullData?.direccion || 'No disponible'})</label>
                                                <div className="flex items-center gap-4 mb-2">
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" name="addrConf" checked={kitData.addressConfirmed === true} onChange={()=>setKitData({...kitData, addressConfirmed: true})} /> 
                                                        <span className="text-sm font-bold text-green-600">S√≠, es correcta</span>
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" name="addrConf" checked={kitData.addressConfirmed === false} onChange={()=>setKitData({...kitData, addressConfirmed: false})} /> 
                                                        <span className="text-sm font-bold text-red-500">No, nueva direcci√≥n</span>
                                                    </label>
                                                </div>
                                                {!kitData.addressConfirmed && (
                                                    <div className="animate-in mb-3">
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Direcci√≥n Secundaria (Ruta)</label>
                                                        <textarea className="w-full p-2 border rounded text-sm bg-white" rows="2" value={kitData.secondaryAddress} onChange={e=>setKitData({...kitData, secondaryAddress:e.target.value})} placeholder="Ingrese la nueva direcci√≥n de entrega..."></textarea>
                                                    </div>
                                                )}
                                                
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Estado GPS</label>
                                                    <select className="w-full p-2 border rounded text-sm bg-white font-bold text-slate-700" value={kitData.gpsStatus} onChange={e=>setKitData({...kitData, gpsStatus:e.target.value})}>
                                                        <option value="TIENE GPS">TIENE GPS</option>
                                                        <option value="GPS PENDIENTE">GPS PENDIENTE</option>
                                                        <option value="SIN GPS">SIN GPS</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="flex items-center gap-2 cursor-pointer mb-2">
                                                    <input type="checkbox" checked={kitData.observationsEnabled} onChange={e=>setKitData({...kitData, observationsEnabled:e.target.checked})} />
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Agregar Observaciones de Entrega</span>
                                                </label>
                                                {kitData.observationsEnabled && (
                                                    <textarea className="w-full p-2 border rounded text-sm bg-amber-50 border-amber-200" rows="2" value={kitData.observations} onChange={e=>setKitData({...kitData, observations:e.target.value})} placeholder="Ej: Casa de color verde, port√≥n negro..."></textarea>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 border-b border-slate-200 pb-1">Log√≠stica</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Fecha Armado</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaArmado} onChange={e=>setKitData({...kitData, fechaArmado:e.target.value})} required />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega a Log√≠stica</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntregaLogistica} onChange={e=>setKitData({...kitData, fechaEntregaLogistica:e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Entrega de Kit (Paciente)</label>
                                                <input type="date" className="w-full p-2 border rounded text-sm bg-white" value={kitData.fechaEntregaKit} onChange={e=>setKitData({...kitData, fechaEntregaKit:e.target.value})} />
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Contact Center</label>
                                                <select className="w-full p-2 border rounded text-sm bg-white" value={kitData.contactCenter} onChange={e=>setKitData({...kitData, contactCenter:e.target.value})}>
                                                    <option value="">Seleccione...</option>
                                                    {contacts && contacts.map(c => (
                                                        <option key={c.id} value={`${c.name} --- ${c.phone}`}>{c.name} --- {c.phone}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Digitador</label>
                                                <input type="text" className="w-full p-2 border rounded text-sm bg-slate-200 text-slate-500" value={currentUser.name} disabled />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border border-slate-200 rounded-xl p-4 bg-slate-50/50 mb-4">
                                        <div className="flex justify-between items-center mb-4 border-b border-slate-200 pb-1">
                                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Medicamentos</h5>
                                            <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" checked={kitData.isRefrigerated} onChange={e=>setKitData({...kitData, isRefrigerated: e.target.checked})} className="rounded border-slate-300 text-turquoise-600 focus:ring-turquoise-500" />
                                                    <span className="text-[10px] font-bold text-slate-500 uppercase">Refrigerado</span>
                                                </label>
                                                {kitData.isRefrigerated && (
                                                    <input type="number" placeholder="Cant." className="w-16 p-1 border rounded text-center text-xs bg-blue-50 border-blue-200 text-blue-700 font-bold outline-none" value={kitData.cantRefriGlobal} onChange={e=>setKitData({...kitData, cantRefriGlobal: e.target.value})} />
                                                )}
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500">% Medicamentos:</label>
                                                    <input type="text" className="w-20 p-1 border rounded text-center font-bold bg-white" value={kitData.triggerMeds} onChange={e=>handleTriggerMeds(e.target.value)} placeholder="Ej: 6/9" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="space-y-3">
                                            {kitData.medicamentos.map((med, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-lg border shadow-sm flex flex-col md:flex-row gap-2 items-end">
                                                    <div className="flex-1 w-full">
                                                        <label className="text-[10px] font-bold text-slate-400 block">Medicamento</label>
                                                        <input list="medsList" className="w-full p-1.5 border rounded text-xs" value={med.nombre} onChange={e => handleMedChange(idx, 'nombre', e.target.value)} placeholder="Buscar..." />
                                                    </div>
                                                    <div className="w-24">
                                                        <label className="text-[10px] font-bold text-slate-400 block">ID Receta</label>
                                                        <input type="text" className="w-full p-1.5 border rounded text-xs" value={med.idReceta} onChange={e => handleMedChange(idx, 'idReceta', e.target.value)} />
                                                    </div>
                                                    <div className="w-20">
                                                        <label className="text-[10px] font-bold text-slate-400 block">Cant.</label>
                                                        <input type="number" className="w-full p-1.5 border rounded text-xs" value={med.cantidad} onChange={e => handleMedChange(idx, 'cantidad', e.target.value)} />
                                                    </div>
                                                </div>
                                            ))}
                                            {kitData.medicamentos.length === 0 && <div className="text-center text-xs text-slate-400 italic py-4">Ingrese cantidad (ej: 6 o 6/9) para agregar l√≠neas.</div>}
                                        </div>
                                    </div>
                                </fieldset>
                                
                                {!isViewMode ? (
                                    <div className="flex gap-3">
                                        <button type="submit" className="flex-1 py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg hover:bg-turquoise-700 transition-colors btn-hover-effect">Guardar Kit</button>
                                        {editingKitId && (
                                            <button 
                                                type="button"
                                                onClick={() => handlePrintVineta(kitData)}
                                                className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-colors btn-hover-effect flex items-center gap-2"
                                            >
                                                <Icons.Printer size={16}/> Imprimir
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    <div className="flex gap-3">
                                        <button type="button" onClick={closeKitForm} className="flex-1 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 transition-colors btn-hover-effect">Cerrar</button>
                                        <button 
                                            type="button"
                                            onClick={() => handlePrintVineta(kitData)}
                                            className="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-colors btn-hover-effect flex items-center gap-2"
                                        >
                                            <Icons.Printer size={16}/> Imprimir
                                        </button>
                                    </div>
                                )}
                            </form>
                            <datalist id="medsList">
                                {medicines.map((m, i) => <option key={i} value={m.name} />)}
                            </datalist>
                        </Modal>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 p-5 relative z-10">
                                <div className="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                                    <h2 className="text-xl font-bold text-slate-800">Historial de Producci√≥n</h2>
                                    <div className="text-2xl font-bold text-turquoise-600">{patientKits.length} <span className="text-sm text-slate-400 font-normal">Kits</span></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span className="text-[10px] font-bold text-slate-400 block">Tipo Afiliado</span>
                                        {selectedPatientFullData?.tipoAfiliado || selectedPatient.tipoAfiliado}
                                    </div>
                                    <div className="md:col-span-3">
                                        <span className="text-[10px] font-bold text-slate-400 block">Domicilio</span>
                                        {selectedPatientFullData?.direccion || 'Cargando...'}
                                    </div>
                                </div>
                                {selectedPatientFullData && (
                                    <div className="mt-4 grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span className="text-[10px] font-bold text-slate-400 block">Tel√©fono</span>
                                            {selectedPatientFullData.telefono || 'No disponible'}
                                        </div>
                                        <div>
                                            <span className="text-[10px] font-bold text-slate-400 block">Tel. Familiar</span>
                                            {selectedPatientFullData.telefonoFamiliar || 'No disponible'}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="grid gap-3">
                                {patientKits.map(kit => (
                                    <div key={kit.id} className="p-4 rounded-xl border border-slate-100 bg-white shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4 relative group">
                                        <div className="flex-1">
                                            <div className="flex flex-wrap items-center gap-2 mb-2">
                                                <span className="bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold border border-turquoise-100">
                                                    <Icons.Calendar size={12} className="inline mr-1"/> {kit.fechaArmado}
                                                </span>
                                                <span className={`px-2 py-1 rounded text-xs font-bold border ${kit.deliveryMode==='ruta'?'bg-emerald-50 text-emerald-700 border-emerald-100':'bg-indigo-50 text-indigo-700 border-indigo-100'}`}>
                                                    {kit.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA'}
                                                </span>
                                                <span className="text-xs text-slate-400 font-mono">Hora Ops: {kit.horaOperaciones || '--:--'}</span>
                                                {kit.isRefrigerated && (
                                                    <span className="text-xs text-blue-600 font-bold flex items-center gap-1">
                                                        <Icons.Box size={12}/> Refrigerado
                                                    </span>
                                                )}
                                            </div>
                                            <div className="mt-2 flex flex-wrap gap-1">
                                                {kit.medicamentos?.slice(0,4).map((m,i) => (
                                                    <span key={i} className="text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border">
                                                        {m.nombre} ({m.cantidad})
                                                    </span>
                                                ))}
                                                {(kit.medicamentos?.length > 4) && <span className="text-[10px] text-slate-400 px-1">...</span>}
                                            </div>
                                        </div>
                                        <div className="flex gap-2 justify-end sm:justify-center items-start">
                                            <button onClick={() => openEditKit(kit, true)} className="text-slate-300 hover:text-blue-500 p-2 btn-hover-effect" title="Ver Detalle">
                                                <Icons.Search size={18}/>
                                            </button>
                                            <button onClick={() => openEditKit(kit, false)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect" title="Editar">
                                                <Icons.Edit size={18}/>
                                            </button>
                                            <button 
                                                onClick={() => handlePrintVineta(kit)}
                                                className="text-slate-300 hover:text-blue-600 p-2 btn-hover-effect"
                                                title="Imprimir Vi√±eta"
                                            >
                                                <Icons.Printer size={18}/>
                                            </button>
                                            {(userRole==='superadmin'||userRole==='admin') && (
                                                <button onClick={() => {if(confirm("¬øEliminar Kit?")) onDeleteKit(kit.id);}} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect">
                                                    <Icons.Trash size={18}/>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                {patientKits.length === 0 && (
                                    <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                                        No hay kits registrados para este paciente.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/50 backdrop-blur-md">
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                                <Icons.Users size={24}/>
                            </div>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Gesti√≥n de Pacientes</h3>
                                <p className="text-xs font-semibold text-turquoise-600">{filteredPatients.length} Registros</p>
                            </div>
                        </div>
                        <div className="flex gap-3 w-full md:w-auto items-center">
                            <div className="relative w-full sm:w-64">
                                <div className="absolute left-3 top-2.5 text-slate-400">
                                    <Icons.Search size={16}/>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="Buscar DNI o Nombre..." 
                                    className="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:border-turquoise-200 transition-all focus:shadow-sm" 
                                    value={searchTerm} 
                                    onChange={e=>setSearchTerm(e.target.value)} 
                                />
                            </div>
                            
                            {(userRole === 'admin' || userRole === 'superadmin') && (
                                <div className="relative overflow-hidden">
                                    <button className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                        <Icons.FileSpreadsheet size={16}/> <span className="hidden sm:inline">Cargar DH</span>
                                    </button>
                                    <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                            )}

                            <button onClick={()=>setShowPatientForm(true)} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                                <Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo</span>
                            </button>
                        </div>
                    </div>
                    
                    <Modal isOpen={showPatientForm} onClose={closePatientForm} title={editingPatientId ? "Editar Paciente" : "Nuevo Derechohabiente"} maxWidth="max-w-2xl">
                        <form onSubmit={handlePatientSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">DNI <span className="text-red-500">*</span></label>
                                    <input 
                                        type="text" 
                                        required 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.dni} 
                                        onChange={e=>setPatientForm({...patientForm, dni:e.target.value, nAfiliacion:e.target.value})} 
                                        maxLength={15} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">N¬∞ Afiliaci√≥n</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-slate-50" 
                                        value={patientForm.nAfiliacion} 
                                        onChange={e=>setPatientForm({...patientForm, nAfiliacion:e.target.value})} 
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo <span className="text-red-500">*</span></label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                    value={patientForm.nombre} 
                                    onChange={e=>setPatientForm({...patientForm, nombre:e.target.value.toUpperCase()})} 
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tel√©fono</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.telefono} 
                                        onChange={e=>setPatientForm({...patientForm, telefono:e.target.value})} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Municipio</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.descripcionMunicipio} 
                                        onChange={e=>setPatientForm({...patientForm, descripcionMunicipio:e.target.value})} 
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Direcci√≥n</label>
                                <textarea 
                                    rows="2" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm resize-none" 
                                    value={patientForm.direccion} 
                                    onChange={e=>setPatientForm({...patientForm, direccion:e.target.value})}
                                ></textarea>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Familiar</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.familiar} 
                                        onChange={e=>setPatientForm({...patientForm, familiar:e.target.value})} 
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Tel. Familiar</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2.5 rounded-xl border border-slate-200 text-sm" 
                                        value={patientForm.telefonoFamiliar} 
                                        onChange={e=>setPatientForm({...patientForm, telefonoFamiliar:e.target.value})} 
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tipo Afiliaci√≥n</label>
                                <select 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white" 
                                    value={patientForm.tipoAfiliado} 
                                    onChange={e=>setPatientForm({...patientForm, tipoAfiliado:e.target.value})}
                                >
                                    <option value="AFILIADO DIRECTO">AFILIADO DIRECTO</option>
                                    <option value="JUBILADO">JUBILADO</option>
                                    <option value="PENSIONADO">PENSIONADO</option>
                                    <option value="BENEFICIARIO PADRE">BENEFICIARIO PADRE</option>
                                    <option value="BENEFICIARIO COMPA√ëERO(O)">BENEFICIARIO COMPA√ëERO(O)</option>
                                    <option value="BENEFICIARIO ESPOSO(A)">BENEFICIARIO ESPOSO(A)</option>
                                    <option value="BENEFICIARIO HIJO(A)">BENEFICIARIO HIJO(A)</option>
                                </select>
                            </div>

                            <button type="submit" className="w-full py-3 bg-turquoise-600 text-white font-bold rounded-xl shadow-lg mt-2 btn-hover-effect">
                                {editingPatientId ? 'Actualizar' : 'Guardar'}
                            </button>
                        </form>
                    </Modal>

                    <div className="h-full overflow-y-auto bg-white p-6">
                        {filteredPatients.length > patientsPerPage && (
                            <div className="mb-4 flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="text-sm text-slate-600">
                                    Mostrando {indexOfFirstPatient + 1}-{Math.min(indexOfLastPatient, filteredPatients.length)} de {filteredPatients.length} pacientes
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                                        disabled={currentPage === 1}
                                        className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                    >
                                        Anterior
                                    </button>
                                    <span className="px-3 py-1 text-sm text-slate-700">
                                        P√°gina {currentPage} de {totalPages}
                                    </span>
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                                        disabled={currentPage === totalPages}
                                        className={`px-3 py-1 rounded-lg text-sm font-medium ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                    >
                                        Siguiente
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse min-w-[800px]">
                                <thead className="bg-slate-50/80 sticky top-0 z-10">
                                    <tr className="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                        <th className="px-6 py-4 pl-8">Paciente</th>
                                        <th className="px-6 py-4">Identificaci√≥n</th>
                                        <th className="px-6 py-4 text-center">N¬∞ Kits</th>
                                        <th className="px-6 py-4 text-right pr-8">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {currentPatients.map(p => {
                                        const countKits = kits.filter(k => k.patientId === p.id).length;
                                        return (
                                            <tr key={p.id} onClick={() => handleSelectPatient(p)} className={`row-hover-effect cursor-pointer`}>
                                                <td className="px-6 py-5 pl-8">
                                                    <div className="font-bold text-base text-slate-800 tracking-tight">{p.nombre}</div>
                                                    <div className="text-xs text-turquoise-600 font-medium mt-1 flex items-center gap-1">
                                                        Ver Detalle <Icons.ChevronsRight size={14}/>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-5">
                                                    <div className="text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit mb-1 font-bold">{p.dni}</div>
                                                    <div className="text-xs text-slate-400">{p.tipoAfiliado}</div>
                                                </td>
                                                <td className="px-6 py-5 text-center">
                                                    <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">{countKits}</span>
                                                </td>
                                                <td className="px-6 py-5 text-right pr-8" onClick={(e)=>e.stopPropagation()}>
                                                    <div className="flex justify-end gap-2">
                                                        <button onClick={(e) => openEditPatient(e, p)} className="text-slate-300 hover:text-orange-500 p-2 btn-hover-effect">
                                                            <Icons.Edit size={20}/>
                                                        </button>
                                                        {(userRole==='superadmin'||userRole==='admin') && (
                                                            <button onClick={()=>setConfirmData({ title: 'Eliminar', msg: `¬øEliminar a ${p.nombre}?`, action: () => onDeletePatient(p.id) })} className="text-slate-300 hover:text-red-500 p-2 btn-hover-effect">
                                                                <Icons.Trash size={20}/>
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        {filteredPatients.length > patientsPerPage && (
                            <div className="mt-4 flex justify-center">
                                <div className="flex gap-1">
                                    {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                                        let pageNum;
                                        if (totalPages <= 5) {
                                            pageNum = i + 1;
                                        } else if (currentPage <= 3) {
                                            pageNum = i + 1;
                                        } else if (currentPage >= totalPages - 2) {
                                            pageNum = totalPages - 4 + i;
                                        } else {
                                            pageNum = currentPage - 2 + i;
                                        }
                                        
                                        return (
                                            <button
                                                key={pageNum}
                                                onClick={() => setCurrentPage(pageNum)}
                                                className={`w-8 h-8 rounded-lg text-sm font-medium ${currentPage === pageNum ? 'bg-turquoise-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                            >
                                                {pageNum}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: CONFIGURACION ---
        const ConfigBlock = ({ medicines, onAddList, contacts, onAddContact, onDeleteContact }) => {
            const [rawText, setRawText] = useState('');
            const [newMed, setNewMed] = useState(''); 
            const [cName, setCName] = useState('');
            const [cPhone, setCPhone] = useState('');
            const [activeTab, setActiveTab] = useState('medicamentos');

            const processText = () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const uniqueMeds = [...new Set(lines.map(l => l.trim().toUpperCase()))];
                if(uniqueMeds.length > 0) { 
                    onAddList(uniqueMeds); 
                    setRawText(''); 
                    alert(`Se procesaron ${uniqueMeds.length} medicamentos.`); 
                }
            };

            const addSingle = (e) => {
                e.preventDefault();
                if(newMed.trim()) {
                    onAddList([newMed.trim().toUpperCase()]);
                    setNewMed('');
                }
            };

            const handleAddContact = (e) => {
                e.preventDefault();
                if(cName.trim() && cPhone.trim()) {
                    onAddContact(cName, cPhone);
                    setCName('');
                    setCPhone('');
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4">
                        <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                            <Icons.Settings size={24} />
                        </div>
                        <div>
                            <h3 className="font-bold text-xl text-slate-800 brand-font">Configuraci√≥n</h3>
                            <p className="text-xs font-semibold text-turquoise-600">Cat√°logos del Sistema</p>
                        </div>
                    </div>
                    
                    <div className="border-b border-slate-100 px-6">
                        <div className="flex gap-4">
                            <button 
                                onClick={() => setActiveTab('medicamentos')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'medicamentos' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Box className="inline mr-2" size={16}/> Medicamentos
                            </button>
                            <button 
                                onClick={() => setActiveTab('contactos')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'contactos' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Phone className="inline mr-2" size={16}/> Contact Center
                            </button>
                            <button 
                                onClick={() => setActiveTab('plantillas')} 
                                className={`px-4 py-3 text-sm font-bold border-b-2 transition-all ${activeTab === 'plantillas' ? 'border-turquoise-500 text-turquoise-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}
                            >
                                <Icons.Layout className="inline mr-2" size={16}/> Plantillas
                            </button>
                        </div>
                    </div>
                    
                    <div className="p-6 overflow-y-auto space-y-8">
                        {activeTab === 'medicamentos' && (
                            <div>
                                <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2">
                                    <Icons.Box size={16}/> Medicamentos
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Agregar Individual</h4>
                                            <form onSubmit={addSingle} className="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    className="flex-1 p-2 rounded-lg border text-sm uppercase outline-none focus:border-turquoise-400" 
                                                    placeholder="Nombre del medicamento..." 
                                                    value={newMed} 
                                                    onChange={e=>setNewMed(e.target.value)} 
                                                />
                                                <button type="submit" className="bg-turquoise-600 text-white p-2 rounded-lg hover:bg-turquoise-700 btn-hover-effect">
                                                    <Icons.Plus size={20}/>
                                                </button>
                                            </form>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Carga Masiva</h4>
                                            <p className="text-xs text-slate-400 mb-2">Pegue la lista de medicamentos (uno por l√≠nea).</p>
                                            <textarea 
                                                className="w-full h-32 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-turquoise-400" 
                                                placeholder="AMOXICILINA 500MG&#10;PARACETAMOL&#10;..." 
                                                value={rawText} 
                                                onChange={e => setRawText(e.target.value)}
                                            ></textarea>
                                            <button 
                                                onClick={processText} 
                                                className="mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-slate-900 w-full btn-hover-effect flex justify-center gap-2 items-center"
                                            >
                                                <Icons.Upload size={16}/> Procesar Lista
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Cat√°logo Actual ({medicines.length})</h4>
                                        <div className="h-full max-h-[400px] overflow-y-auto border rounded-xl bg-white p-2 space-y-1">
                                            {medicines.map((m, i) => (
                                                <div key={i} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 uppercase">
                                                    {m.name}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'contactos' && (
                            <div>
                                <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2">
                                    <Icons.Phone size={16}/> Contact Center
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 h-fit">
                                        <h4 className="font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider">Nuevo Agente</h4>
                                        <form onSubmit={handleAddContact} className="space-y-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre</label>
                                                <input 
                                                    type="text" 
                                                    value={cName} 
                                                    onChange={e=>setCName(e.target.value)} 
                                                    className="w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400" 
                                                    placeholder="Ej: Karla" 
                                                    required
                                                />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Tel√©fono</label>
                                                <input 
                                                    type="text" 
                                                    value={cPhone} 
                                                    onChange={e=>setCPhone(e.target.value)} 
                                                    className="w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400" 
                                                    placeholder="Ej: 9988-7766" 
                                                    required
                                                />
                                            </div>
                                            <button type="submit" className="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-xs hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm">
                                                <Icons.Save size={16}/> Guardar Agente
                                            </button>
                                        </form>
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider">Agentes Activos ({contacts?.length || 0})</h4>
                                        <div className="border rounded-xl bg-white p-2 max-h-60 overflow-y-auto space-y-1">
                                            {contacts && contacts.map(c => (
                                                <div key={c.id} className="text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 flex justify-between items-center group">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-[10px]">
                                                            {c.name.substring(0,2).toUpperCase()}
                                                        </div>
                                                        <span className="font-medium text-slate-700">{c.name} <span className="text-slate-400 mx-1">---</span> {c.phone}</span>
                                                    </div>
                                                    <button onClick={()=>onDeleteContact(c.id)} className="text-slate-300 hover:text-red-500 p-1 rounded hover:bg-red-50 transition">
                                                        <Icons.Trash size={14}/>
                                                    </button>
                                                </div>
                                            ))}
                                            {(!contacts || contacts.length === 0) && (
                                                <div className="text-center text-slate-300 text-xs py-4 italic">
                                                    No hay agentes configurados
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'plantillas' && (
                            <TemplateEditorBlock />
                        )}
                    </div>
                </div>
            );
        };

        // --- BLOCK: USUARIOS ---
        const UserManagementBlock = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [formData, setFormData] = useState({ username: '', password: '', role: 'digitador', nombre: '' });
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);

            const openNew = () => { 
                setEditingId(null); 
                setFormData({ username: '', password: '', role: 'digitador', nombre: '' }); 
                setShowModal(true); 
            };
            
            const openEdit = (u) => { 
                setEditingId(u.id); 
                setFormData(u); 
                setShowModal(true); 
            };
            
            const closeModal = () => { 
                setShowModal(false); 
                setEditingId(null); 
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const uData = {...formData, departamento: 'Operaciones'};
                    if (editingId) {
                        await onUpdateUser(editingId, uData);
                    } else {
                        await onAddUser(uData);
                    }
                    closeModal();
                } catch (error) {
                    alert('Error al guardar usuario: ' + error.message);
                }
            };

            return (
                <div className="glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white">
                    <ConfirmModal isOpen={!!confirmData} onClose={()=>setConfirmData(null)} onConfirm={confirmData?.action} title={confirmData?.title} message={confirmData?.msg} />
                    
                    <div className="p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="bg-turquoise-100 p-3 rounded-2xl text-turquoise-600">
                                <Icons.UserCog size={24} />
                            </div>
                            <div>
                                <h3 className="font-bold text-xl text-slate-800 brand-font">Usuarios</h3>
                                <p className="text-xs font-semibold text-turquoise-600">{users.length} Activos</p>
                            </div>
                        </div>
                        <button onClick={openNew} className="flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect">
                            <Icons.Plus size={16}/> <span className="hidden sm:inline">Nuevo Usuario</span>
                        </button>
                    </div>

                    <Modal isOpen={showModal} onClose={closeModal} title={editingId ? "Editar Usuario" : "Nuevo Usuario"}>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Nombre Completo</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.nombre} 
                                    onChange={e=>setFormData({...formData, nombre:e.target.value})} 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Usuario (Login)</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.username} 
                                    onChange={e=>setFormData({...formData, username:e.target.value.toLowerCase()})} 
                                    required 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Contrase√±a</label>
                                    <input 
                                    type="password" 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500" 
                                    value={formData.password} 
                                    onChange={e=>setFormData({...formData, password:e.target.value})} 
                                    placeholder={editingId ? "Dejar vac√≠o para mantener" : ""} 
                                    required={!editingId} 
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1">Rol</label>
                                <select 
                                    className="w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500" 
                                    value={formData.role} 
                                    onChange={e=>setFormData({...formData, role:e.target.value})}
                                >
                                    <option value="digitador">Digitador</option>
                                    <option value="admin">Administrador</option>
                                    <option value="superadmin">Super Admin</option>
                                </select>
                            </div>
                            <button type="submit" className="w-full bg-turquoise-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-turquoise-700 btn-hover-effect mt-4">
                                {editingId ? 'Actualizar' : 'Crear Usuario'}
                            </button>
                        </form>
                    </Modal>

                    <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                        <div className="grid gap-3 sm:grid-cols-2 md:grid-cols-3">
                            {users.map(u => (
                                <div key={u.id} className="p-4 rounded-xl border border-slate-200 flex flex-col gap-3 bg-white hover:shadow-md transition-shadow relative group">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${u.role === 'digitador' ? 'bg-clinical-500' : 'bg-turquoise-600'}`}>
                                            {u.username.substring(0,2).toUpperCase()}
                                        </div>
                                        <div>
                                            <div className="font-bold text-sm text-slate-800">{u.nombre || u.username}</div>
                                            <div className="text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded w-fit mt-1">
                                                @{u.username} ‚Ä¢ {u.role}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="border-t border-slate-100 pt-2 flex justify-end gap-2">
                                        <button onClick={() => openEdit(u)} className="p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors" title="Editar">
                                            <Icons.Edit size={18}/>
                                        </button>
                                        <button onClick={() => setConfirmData({ title: 'Eliminar Usuario', msg: `¬øDesea eliminar a ${u.username}?`, action: () => onDeleteUser(u.id) })} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">
                                            <Icons.Trash size={18}/>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [view, setView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [users, setUsers] = useState([]);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); 
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [cacheManager] = useState(new CacheManager());
            const [firebaseStatus, setFirebaseStatus] = useState('Conectando...');

            // Verificar estado de Firebase peri√≥dicamente
            useEffect(() => {
                const checkFirebaseStatus = async () => {
                    const isConnected = await checkFirestoreConnection();
                    setFirebaseStatus(isConnected ? 'Conectado' : 'Desconectado');
                };

                checkFirebaseStatus();
                const interval = setInterval(checkFirebaseStatus, 30000); // Verificar cada 30 segundos

                return () => clearInterval(interval);
            }, []);

            const handleLogout = () => { 
                // NO LIMPIAR EL CACHE al cerrar sesi√≥n
                sessionStorage.removeItem('leq_role');
                sessionStorage.removeItem('leq_username');
                setRole(null); 
                setUserName(null); 
            };
            
            const handleLogin = (r, n) => { 
                setRole(r); 
                setUserName(n); 
                sessionStorage.setItem('leq_role', r); 
                sessionStorage.setItem('leq_username', n); 
            };

            const loadMedicines = async () => {
                try {
                    const cachedMedicines = cacheManager.getMedicines();
                    if (cachedMedicines) {
                        setMedicines(cachedMedicines);
                        console.log('‚úÖ Medicamentos cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_medicines').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    cacheManager.saveMedicines(data);
                    setMedicines(data);
                    console.log('üî• Medicamentos cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando medicamentos:', error);
                }
            };

            const loadContacts = async () => {
                try {
                    const cachedContacts = cacheManager.getContacts();
                    if (cachedContacts) {
                        setContacts(cachedContacts);
                        console.log('‚úÖ Contactos cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_contacts').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    cacheManager.saveContacts(data);
                    setContacts(data);
                    console.log('üî• Contactos cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando contactos:', error);
                }
            };

            const loadUsers = async () => {
                if (!(role === 'admin' || role === 'superadmin')) return;
                
                try {
                    const cachedUsers = cacheManager.getUsers();
                    if (cachedUsers) {
                        setUsers(cachedUsers);
                        console.log('‚úÖ Usuarios cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_users').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    cacheManager.saveUsers(data);
                    setUsers(data);
                    console.log('üî• Usuarios cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando usuarios:', error);
                }
            };

            const loadKits = async () => {
                try {
                    const cachedKits = cacheManager.getKits();
                    if (cachedKits) {
                        setKits(cachedKits);
                        console.log('‚úÖ Kits cargados desde cache');
                        return;
                    }
                    
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    
                    const querySnapshot = await db.collection('prod_kits').get();
                    const data = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                        .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                    
                    cacheManager.saveKits(data);
                    setKits(data);
                    console.log('üî• Kits cargados desde Firebase');
                } catch (error) {
                    console.error('Error cargando kits:', error);
                }
            };

            useEffect(() => {
                if (!role || !firebaseInitialized) return;
                
                loadMedicines();
                loadContacts();
                loadUsers();
                loadKits();
                
                // Escuchar cambios en tiempo real solo si Firebase est√° inicializado
                if (firebaseInitialized && db) {
                    const unsubMedicines = db.collection('prod_medicines')
                        .onSnapshot(s => {
                            const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                .sort((a, b) => a.name.localeCompare(b.name));
                            setMedicines(data);
                            cacheManager.saveMedicines(data);
                        });
                    
                    const unsubContacts = db.collection('prod_contacts')
                        .onSnapshot(s => {
                            const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                .sort((a, b) => a.name.localeCompare(b.name));
                            setContacts(data);
                            cacheManager.saveContacts(data);
                        });
                    
                    const unsubKits = db.collection('prod_kits')
                        .onSnapshot(s => {
                            const data = s.docs.map(d => ({ id: d.id, ...d.data() }))
                                .sort((a, b) => new Date(b.fechaArmado) - new Date(a.fechaArmado));
                            setKits(data);
                            cacheManager.saveKits(data);
                        });
                    
                    if (role === 'admin' || role === 'superadmin') {
                        const unsubUsers = db.collection('prod_users')
                            .onSnapshot(s => {
                                const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                                setUsers(data);
                                cacheManager.saveUsers(data);
                            });
                        
                        return () => {
                            unsubMedicines();
                            unsubContacts();
                            unsubKits();
                            unsubUsers();
                        };
                    }
                    
                    return () => {
                        unsubMedicines();
                        unsubContacts();
                        unsubKits();
                    };
                }
            }, [role, firebaseInitialized]);

            const addPatient = async (d) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    const result = await db.collection('prod_patients').add({
                        ...d, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log("Patient added with ID: ", result.id);
                    cacheManager.clearPatientCache();
                    return result;
                } catch (error) {
                    console.error("Error adding patient: ", error);
                    throw error;
                }
            };
            
            const updatePatient = async (id, d) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_patients').doc(id).update(d);
                    cacheManager.clearPatientCache(id);
                } catch (error) {
                    console.error("Error updating patient: ", error);
                    throw error;
                }
            };
            
            const deletePatient = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_patients').doc(id).delete();
                    cacheManager.clearPatientCache(id);
                } catch (error) {
                    console.error("Error deleting patient: ", error);
                    throw error;
                }
            };
            
            const saveKit = async (id, data, pid, isUpdate) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    let resultId = id;
                    if(isUpdate) {
                        await db.collection('prod_kits').doc(id).update(data);
                    } else {
                        const result = await db.collection('prod_kits').add({
                            ...data, 
                            patientId: pid, 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        resultId = result.id;
                    }
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                    return resultId;
                } catch (error) {
                    console.error("Error saving kit: ", error);
                    throw error;
                }
            };
            
            const deleteKit = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_kits').doc(id).delete();
                    cacheManager.clearCache(cacheManager.KITS_CACHE_KEY);
                } catch (error) {
                    console.error("Error deleting kit: ", error);
                    throw error;
                }
            };
            
            const addMedsList = async (list) => { 
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    for(const name of list) {
                        await db.collection('prod_medicines').add({ name });
                    }
                } catch (error) {
                    console.error("Error adding medicines: ", error);
                    throw error;
                }
            };
            
            const addContact = async (name, phone) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_contacts').add({ name, phone });
                } catch (error) {
                    console.error("Error adding contact: ", error);
                    throw error;
                }
            };
            
            const deleteContact = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_contacts').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting contact: ", error);
                    throw error;
                }
            };

            const addUser = async (u) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').add(u);
                } catch (error) {
                    console.error("Error adding user: ", error);
                    throw error;
                }
            };
            
            const updateUser = async (id, u) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').doc(id).update(u);
                } catch (error) {
                    console.error("Error updating user: ", error);
                    throw error;
                }
            };
            
            const deleteUser = async (id) => {
                try {
                    if (!firebaseInitialized || !db) {
                        throw new Error("Base de datos no disponible");
                    }
                    await db.collection('prod_users').doc(id).delete();
                } catch (error) {
                    console.error("Error deleting user: ", error);
                    throw error;
                }
            };

            if (!role) return <LoginBlock onLogin={handleLogin} />;

            const NavItem = ({ id, label, icon: Icon }) => (
                <button 
                    onClick={() => { setView(id); setMobileMenuOpen(false); }} 
                    className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold group relative overflow-hidden btn-hover-effect ${view === id ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`}
                >
                    <Icon size={20} className={view === id ? 'text-white' : 'text-turquoise-400 group-hover:text-white'} />
                    <span className={`whitespace-nowrap transition-opacity duration-300 ${sidebarCollapsed ? 'hidden opacity-0 w-0' : 'block opacity-100'}`}>
                        {label}
                    </span>
                </button>
            );

            const stats = { 
                totalKits: kits.length, 
                todayKits: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length 
            };

            return (
                <div className="flex h-screen bg-[#f0fdfa] font-sans overflow-hidden">
                    {mobileMenuOpen && ( 
                        <div className="fixed inset-0 z-50 bg-turquoise-900/95 backdrop-blur-sm flex flex-col md:hidden animate-in">
                            <div className="p-4 flex justify-between items-center border-b border-turquoise-800">
                                <div className="font-bold text-white text-xl flex items-center gap-2 brand-font">
                                    <Icons.Activity/> Bit√°cora Producci√≥n
                                </div>
                                <button onClick={() => setMobileMenuOpen(false)} className="text-white p-2 bg-turquoise-800 rounded-full btn-hover-effect">
                                    <Icons.X size={24}/>
                                </button>
                            </div>
                            <div className="p-6 space-y-4">
                                <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                                <NavItem id="reports" label="Reportes" icon={Icons.List} />
                                <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />
                                {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuraci√≥n" icon={Icons.Settings} />}
                                {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                                <div className="pt-8 border-t border-turquoise-800">
                                    <button onClick={handleLogout} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl bg-turquoise-800 text-white font-bold btn-hover-effect">
                                        <Icons.LogOut size={20}/> Desconectar
                                    </button>
                                </div>
                            </div>
                        </div> 
                    )}
                    
                    <aside className={`${sidebarCollapsed ? 'w-24' : 'w-72'} bg-turquoise-900 text-turquoise-100 flex-col shadow-2xl z-20 hidden md:flex relative transition-all duration-300 ease-in-out`}>
                        <div className={`p-6 pb-2 relative z-10 flex ${sidebarCollapsed ? 'justify-center' : 'justify-between'} items-center`}>
                            {!sidebarCollapsed && (
                                <div className="flex items-center gap-3 text-white">
                                    <div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg">
                                        <Icons.Activity size={24} className="text-white"/>
                                    </div>
                                    <span className="font-bold text-2xl brand-font animate-in">Bit√°cora</span>
                                </div>
                            )}
                            {sidebarCollapsed && (
                                <div className="bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg mb-2">
                                    <Icons.Activity size={24} className="text-white"/>
                                </div>
                            )}
                            <button 
                                onClick={() => setSidebarCollapsed(!sidebarCollapsed)} 
                                className="text-turquoise-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-turquoise-800 absolute right-4 top-6 btn-hover-effect" 
                                style={sidebarCollapsed ? { right: 'auto', top: 'auto', marginTop: '10px', position: 'static' } : {}}
                            >
                                {sidebarCollapsed ? <Icons.ChevronsRight size={20}/> : <Icons.ArrowLeft size={20}/>}
                            </button>
                        </div>
                        {!sidebarCollapsed && (
                            <div className="text-xs font-bold text-turquoise-400 uppercase tracking-widest pl-14 mb-4 animate-in">
                                Producci√≥n
                            </div>
                        )}
                        <nav className="flex-1 px-4 py-4 space-y-2 relative z-10 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" label="Dashboard" icon={Icons.LayoutDashboard} />
                            <NavItem id="reports" label="Reportes" icon={Icons.List} />
                            <NavItem id="pacientes" label="Pacientes" icon={Icons.Users} />
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="config" label="Configuraci√≥n" icon={Icons.Settings} />}
                            {(role === 'admin' || role === 'superadmin') && <NavItem id="users" label="Usuarios" icon={Icons.UserCog} />}
                        </nav>
                        <div className="p-4 mx-4 mb-4 rounded-2xl bg-turquoise-800/50 border border-turquoise-700/50 relative z-10">
                            <div className={`flex items-center gap-3 mb-4 ${sidebarCollapsed ? 'justify-center flex-col' : ''}`}>
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-clinical-400 to-clinical-600 flex items-center justify-center font-bold text-white text-sm shrink-0">
                                    {role==='admin'?'AD':'OP'}
                                </div>
                                {!sidebarCollapsed && (
                                    <div className="overflow-hidden">
                                        <div className="text-sm font-bold text-white capitalize truncate">{userName}</div>
                                        <div className="text-[10px] text-turquoise-300 truncate">{firebaseStatus}</div>
                                    </div>
                                )}
                            </div>
                            <button 
                                onClick={handleLogout} 
                                className={`w-full flex items-center gap-2 text-xs font-bold text-turquoise-200 hover:text-white py-2.5 rounded-xl hover:bg-turquoise-700 transition-colors btn-hover-effect ${sidebarCollapsed ? 'justify-center' : 'justify-center'}`} 
                                title="Desconectar"
                            >
                                <Icons.LogOut size={16}/> {!sidebarCollapsed && <span>Salir</span>}
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-full overflow-hidden bg-[#f0fdfa] relative transition-all duration-300">
                        <div className="md:hidden bg-white/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center z-20">
                            <button onClick={() => setMobileMenuOpen(true)} className="text-slate-600 p-1 btn-hover-effect">
                                <Icons.Menu size={24}/>
                            </button>
                            <div className="font-bold text-slate-800 flex items-center gap-2 brand-font">
                                <Icons.Activity size={18} className="text-turquoise-600"/> Bit√°cora Producci√≥n
                            </div>
                            <div className="w-8"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative z-10">
                            {view === 'dashboard' && <DashboardBlock setView={setView} stats={stats} userName={userName} role={role} />}
                            {view === 'reports' && <ReportsBlock kits={kits} patients={patients} userRole={role} userName={userName} setView={setView} />}
                            {view === 'pacientes' && <PatientManagementBlock patients={patients} kits={kits} medicines={medicines} onAddPatient={addPatient} onUpdatePatient={updatePatient} onDeletePatient={deletePatient} onSaveKit={saveKit} onDeleteKit={deleteKit} currentUser={{name: userName, role: role}} userRole={role} contacts={contacts} />}
                            {view === 'config' && (role === 'admin' || role === 'superadmin') && <ConfigBlock medicines={medicines} onAddList={addMedsList} contacts={contacts} onAddContact={addContact} onDeleteContact={deleteContact} />}
                            {view === 'users' && (role === 'admin' || role === 'superadmin') && <UserManagementBlock users={users} onAddUser={addUser} onUpdateUser={updateUser} onDeleteUser={deleteUser} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
