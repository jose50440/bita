<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Producción - Operaciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (Para Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Poppins', 'sans-serif'] },
                    colors: {
                        turquoise: { 50:'#f0fdfa', 100:'#ccfbf1', 200:'#99f6e4', 300:'#5eead4', 400:'#2dd4bf', 500:'#14b8a6', 600:'#0d9488', 700:'#0f766e', 800:'#115e59', 900:'#134e4a' },
                        clinical: { 50:'#f0fdf4', 100:'#dcfce7', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#15803d' }
                    },
                    boxShadow: { soft: '0 4px 20px -2px rgba(20, 184, 166, 0.15)', glow: '0 0 15px rgba(45, 212, 191, 0.3)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdfa; }
        h1, h2, h3, h4, .brand-font { font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover-effect { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover-effect:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-hover-effect:active { transform: translateY(0) scale(0.95); }
        
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s ease-out forwards; }
        
        .row-hover-effect { transition: all 0.2s ease-out; border-left: 3px solid transparent; }
        .row-hover-effect:hover { background-color: white; transform: scale(1.005); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-left-color: #0d9488; z-index: 10; position: relative; }

        .group-box { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; background-color: rgba(248, 250, 252, 0.5); margin-bottom: 1rem; }
        .group-title { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25rem; }

        /* Animaciones */
        @keyframes ekgPulse { 0% { transform: scale(1); } 15% { transform: scale(1.15); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } 100% { transform: scale(1); } }
        .animate-ekg { animation: ekgPulse 2s infinite ease-in-out; }
    </style>
</head>
<body class="text-slate-600 h-screen overflow-hidden selection:bg-turquoise-200 selection:text-turquoise-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHrnTnsXg4P6faYSfP51gORVKPy-ExEw4",
            authDomain: "bitacora-217cf.firebaseapp.com",
            projectId: "bitacora-217cf",
            storageBucket: "bitacora-217cf.firebasestorage.app",
            messagingSenderId: "1080043869360",
            appId: "1:1080043869360:web:5932f72c30d8bb376cd775"
        };

        // Inicializar Firebase
        let app, auth, db;
        if (typeof firebase !== 'undefined' && firebase.initializeApp) {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                // Habilitar persistencia offline
                db.enablePersistence()
                    .catch(err => {
                        console.warn("Error de persistencia Firebase:", err);
                    });
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
            }
        }

        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- ICONS ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: size,
            height: size,
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            className: className,
            dangerouslySetInnerHTML: { __html: path }
        });
        
        const Icons = {
            Activity: (p) => React.createElement(Icon, { ...p, path: '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>' }),
            Users: (p) => React.createElement(Icon, { ...p, path: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>' }),
            Search: (p) => React.createElement(Icon, { ...p, path: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>' }),
            LogOut: (p) => React.createElement(Icon, { ...p, path: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>' }),
            Box: (p) => React.createElement(Icon, { ...p, path: '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7 4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line>' }),
            Calendar: (p) => React.createElement(Icon, { ...p, path: '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>' }),
            Settings: (p) => React.createElement(Icon, { ...p, path: '<circle cx="12" cy="12" r="3"></circle>' }),
            Plus: (p) => React.createElement(Icon, { ...p, path: '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>' }),
            Trash: (p) => React.createElement(Icon, { ...p, path: '<polyline points="3 6 5 6 21 6"></polyline>' }),
            Printer: (p) => React.createElement(Icon, { ...p, path: '<polyline points="6 9 6 2 18 2 18 9"></polyline>' }),
            ChevronsRight: (p) => React.createElement(Icon, { ...p, path: '<polyline points="13 17 18 12 13 7"></polyline>' }),
            UserCog: (p) => React.createElement(Icon, { ...p, path: '<circle cx="12" cy="7" r="4"></circle>' }),
            Menu: (p) => React.createElement(Icon, { ...p, path: '<line x1="3" y1="12" x2="21" y2="12"></line>' }),
            X: (p) => React.createElement(Icon, { ...p, path: '<line x1="18" y1="6" x2="6" y2="18"></line>' }),
            FileText: (p) => React.createElement(Icon, { ...p, path: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>' }),
            Upload: (p) => React.createElement(Icon, { ...p, path: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>' }),
            Edit: (p) => React.createElement(Icon, { ...p, path: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>' }),
            ArrowLeft: (p) => React.createElement(Icon, { ...p, path: '<line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>' }),
            ArrowRight: (p) => React.createElement(Icon, { ...p, path: '<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>' }),
            Minus: (p) => React.createElement(Icon, { ...p, path: '<line x1="5" y1="12" x2="19" y2="12"></line>' }),
            Folder: (p) => React.createElement(Icon, { ...p, path: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>' }),
            LayoutDashboard: (p) => React.createElement(Icon, { ...p, path: '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>' }),
            List: (p) => React.createElement(Icon, { ...p, path: '<line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line>' }),
            Download: (p) => React.createElement(Icon, { ...p, path: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>' }),
            Bot: (p) => React.createElement(Icon, { ...p, path: '<rect x="3" y="11" width="18" height="10" rx="2"></rect><circle cx="12" cy="5" r="2"></circle><path d="M12 7v4"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="16" y1="16" x2="16" y2="16"></line>' }),
            Lock: (p) => React.createElement(Icon, { ...p, path: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>' }),
            FolderPlus: (p) => React.createElement(Icon, { ...p, path: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line>' }),
            Wifi: (p) => React.createElement(Icon, { ...p, path: '<path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line>' }),
            WifiOff: (p) => React.createElement(Icon, { ...p, path: '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line>' }),
            Phone: (p) => React.createElement(Icon, { ...p, path: '<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>' }),
            Save: (p) => React.createElement(Icon, { ...p, path: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>' }),
            FileSpreadsheet: (p) => React.createElement(Icon, { ...p, path: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path>' })
        };

        // --- COMPONENTS ---

        const AnimatedCounter = ({ value }) => {
            const [count, setCount] = useState(0);
            useEffect(() => {
                let start = 0; const end = parseInt(value, 10);
                if (isNaN(end)) return;
                if (start === end) { setCount(end); return; }
                const duration = 1000; const incrementTime = 20; const stepAmount = Math.ceil(end / (duration / incrementTime));
                let timer = setInterval(() => {
                    start += stepAmount;
                    if (start >= end) { setCount(end); clearInterval(timer); } else { setCount(start); }
                }, incrementTime);
                return () => clearInterval(timer);
            }, [value]);
            return React.createElement('span', null, count);
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return React.createElement('div', {
                className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in"
            }, React.createElement('div', {
                className: `bg-white rounded-2xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[95vh] modal-animate`
            }, [
                React.createElement('div', {
                    key: 'header',
                    className: "px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"
                }, [
                    React.createElement('h3', { key: 'title', className: "font-bold text-lg text-slate-800 brand-font" }, title),
                    React.createElement('button', {
                        key: 'close',
                        onClick: onClose,
                        className: "p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"
                    }, React.createElement(Icons.X, { size: 20 }))
                ]),
                React.createElement('div', { key: 'content', className: "p-6 overflow-y-auto" }, children)
            ]));
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return React.createElement('div', {
                className: "fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in"
            }, React.createElement('div', {
                className: "bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col modal-animate p-6 text-center"
            }, [
                React.createElement('h3', { key: 'title', className: "text-lg font-medium text-slate-900 mb-2" }, title),
                React.createElement('p', { key: 'message', className: "text-sm text-slate-500 mb-6" }, message),
                React.createElement('div', {
                    key: 'buttons',
                    className: "flex justify-center gap-3"
                }, [
                    React.createElement('button', {
                        key: 'cancel',
                        onClick: onClose,
                        className: "px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-sm"
                    }, 'Cancelar'),
                    React.createElement('button', {
                        key: 'confirm',
                        onClick: () => { onConfirm(); onClose(); },
                        className: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm"
                    }, 'Confirmar')
                ])
            ]));
        };

        // --- BLOCK: LOGIN ---
        const LoginBlock = ({ onLogin }) => {
            const [username, setUsername] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState('');
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);
            
            const handleLogin = async (e) => {
                e.preventDefault(); 
                setError(''); 
                setLoading(true);
                
                // Verificar conexión a Firebase
                if (!db) {
                    setError("Error de conexión a la base de datos. Verifique su conexión a internet.");
                    setLoading(false);
                    return;
                }
                
                const userKey = username.trim().toLowerCase();
                
                if (userKey === 'superadmin' && password === 'superadmin') { 
                    onLogin('superadmin', 'Super Usuario', 'Operaciones'); 
                    setLoading(false);
                    return; 
                }
                
                try {
                    const q = firebase.firestore().collection('prod_users').where('username', '==', userKey);
                    const querySnapshot = await q.get();
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.password === password) {
                            try {
                                await firebase.firestore().collection('prod_access_logs').add({
                                    username: userData.nombre || userData.username,
                                    role: userData.role,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            } catch (e) {
                                console.log("Log de acceso no guardado:", e);
                            }
                            onLogin(userData.role, userData.nombre || userData.username, 'Operaciones');
                        } else { 
                            setError("Contraseña incorrecta."); 
                            setLoading(false); 
                        }
                    } else { 
                        setError("Usuario no encontrado."); 
                        setLoading(false); 
                    }
                } catch (err) { 
                    console.error("Error en login:", err);
                    setError("Error de conexión. Verifique su red."); 
                    setLoading(false); 
                }
            };
            
            return React.createElement('div', {
                className: "min-h-screen flex items-center justify-center bg-gradient-to-br from-turquoise-50 to-clinical-50 p-6 relative"
            }, [
                React.createElement('div', {
                    key: 'status',
                    className: `absolute top-6 right-6 px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-sm transition-all ${isOnline ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`
                }, [
                    isOnline ? React.createElement(Icons.Wifi, { key: 'wifi', size: 16 }) : React.createElement(Icons.WifiOff, { key: 'wifi-off', size: 16 }),
                    isOnline ? 'Conectado' : 'Sin Conexión'
                ]),
                React.createElement('div', {
                    key: 'form',
                    className: "glass-panel p-10 rounded-3xl shadow-soft w-full max-w-sm border-white/50 relative z-10"
                }, [
                    React.createElement('div', {
                        key: 'header',
                        className: "text-center mb-10"
                    }, [
                        React.createElement('div', {
                            key: 'icon',
                            className: "bg-gradient-to-tr from-turquoise-500 to-clinical-400 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-glow text-white animate-ekg"
                        }, React.createElement(Icons.Activity, { size: 40 })),
                        React.createElement('h1', {
                            key: 'title',
                            className: "text-2xl font-bold text-slate-800 tracking-tight brand-font"
                        }, 'Bitácora ', React.createElement('span', { className: "text-turquoise-600" }, 'Producción')),
                        React.createElement('p', {
                            key: 'subtitle',
                            className: "text-xs text-slate-400 font-bold uppercase tracking-widest mt-1"
                        }, 'Dpto. Operaciones')
                    ]),
                    React.createElement('form', {
                        key: 'login-form',
                        onSubmit: handleLogin,
                        className: "space-y-6"
                    }, [
                        error && React.createElement('div', {
                            key: 'error',
                            className: "bg-red-50 text-red-500 p-3 rounded-lg text-xs text-center font-bold border border-red-100"
                        }, error),
                        React.createElement('div', {
                            key: 'fields',
                            className: "space-y-4"
                        }, [
                            React.createElement('div', { key: 'username' }, [
                                React.createElement('label', {
                                    className: "block text-xs font-bold text-slate-400 uppercase mb-2"
                                }, 'Usuario'),
                                React.createElement('input', {
                                    type: "text",
                                    className: "w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors",
                                    value: username,
                                    onChange: (e) => setUsername(e.target.value),
                                    required: true
                                })
                            ]),
                            React.createElement('div', { key: 'password' }, [
                                React.createElement('label', {
                                    className: "block text-xs font-bold text-slate-400 uppercase mb-2"
                                }, 'Contraseña'),
                                React.createElement('input', {
                                    type: "password",
                                    className: "w-full px-4 py-3 bg-white/50 border border-slate-200 rounded-xl outline-none focus:border-turquoise-500 transition-colors",
                                    value: password,
                                    onChange: (e) => setPassword(e.target.value),
                                    required: true
                                })
                            ])
                        ]),
                        React.createElement('button', {
                            key: 'submit',
                            type: "submit",
                            disabled: loading,
                            className: "w-full bg-gradient-to-r from-turquoise-500 to-clinical-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-hover-effect"
                        }, loading ? 'Verificando...' : 'Iniciar Sesión')
                    ])
                ])
            ]);
        };

        // --- BLOCK: CONFIGURACION ---
        const ConfigBlock = ({ medicines, onAddList, contacts, onAddContact, onDeleteContact }) => {
            const [rawText, setRawText] = useState('');
            const [newMed, setNewMed] = useState(''); 
            const [cName, setCName] = useState('');
            const [cPhone, setCPhone] = useState('');

            const processText = () => {
                const lines = rawText.split(/\r?\n/).filter(line => line.trim() !== '');
                const uniqueMeds = [...new Set(lines.map(l => l.trim().toUpperCase()))];
                if(uniqueMeds.length > 0) { 
                    onAddList(uniqueMeds); 
                    setRawText(''); 
                    alert(`Se procesaron ${uniqueMeds.length} medicamentos.`); 
                }
            };

            const addSingle = (e) => {
                e.preventDefault();
                if(newMed.trim()) {
                    onAddList([newMed.trim().toUpperCase()]);
                    setNewMed('');
                }
            };

            const handleAddContact = (e) => {
                e.preventDefault();
                if(cName.trim() && cPhone.trim()) {
                    onAddContact(cName, cPhone);
                    setCName('');
                    setCPhone('');
                }
            };

            return React.createElement('div', {
                className: "glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white"
            }, [
                React.createElement('div', {
                    key: 'header',
                    className: "p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex items-center gap-4"
                }, [
                    React.createElement('div', {
                        key: 'icon',
                        className: "bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"
                    }, React.createElement(Icons.Settings, { size: 24 })),
                    React.createElement('div', { key: 'title' }, [
                        React.createElement('h3', {
                            className: "font-bold text-xl text-slate-800 brand-font"
                        }, 'Configuración'),
                        React.createElement('p', {
                            className: "text-xs font-semibold text-turquoise-600"
                        }, 'Catálogos del Sistema')
                    ])
                ]),
                React.createElement('div', {
                    key: 'content',
                    className: "p-6 overflow-y-auto space-y-8"
                }, [
                    // SECCIÓN MEDICAMENTOS
                    React.createElement('div', { key: 'medicines' }, [
                        React.createElement('h4', {
                            className: "font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2"
                        }, [
                            React.createElement(Icons.Box, { key: 'icon', size: 16 }),
                            ' Medicamentos'
                        ]),
                        React.createElement('div', {
                            className: "grid grid-cols-1 md:grid-cols-2 gap-8"
                        }, [
                            React.createElement('div', {
                                key: 'add',
                                className: "space-y-6"
                            }, [
                                React.createElement('div', {
                                    className: "bg-slate-50 p-4 rounded-xl border border-slate-100"
                                }, [
                                    React.createElement('h4', {
                                        className: "font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider"
                                    }, 'Agregar Individual'),
                                    React.createElement('form', {
                                        onSubmit: addSingle,
                                        className: "flex gap-2"
                                    }, [
                                        React.createElement('input', {
                                            key: 'input',
                                            type: "text",
                                            className: "flex-1 p-2 rounded-lg border text-sm uppercase outline-none focus:border-turquoise-400",
                                            placeholder: "Nombre del medicamento...",
                                            value: newMed,
                                            onChange: e => setNewMed(e.target.value)
                                        }),
                                        React.createElement('button', {
                                            key: 'button',
                                            type: "submit",
                                            className: "bg-turquoise-600 text-white p-2 rounded-lg hover:bg-turquoise-700 btn-hover-effect"
                                        }, React.createElement(Icons.Plus, { size: 20 }))
                                    ])
                                ]),
                                React.createElement('div', { key: 'bulk' }, [
                                    React.createElement('h4', {
                                        className: "font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider"
                                    }, 'Carga Masiva'),
                                    React.createElement('p', {
                                        className: "text-xs text-slate-400 mb-2"
                                    }, 'Pegue la lista de medicamentos (uno por línea).'),
                                    React.createElement('textarea', {
                                        className: "w-full h-32 p-4 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:border-turquoise-400",
                                        placeholder: "AMOXICILINA 500MG\nPARACETAMOL\n...",
                                        value: rawText,
                                        onChange: e => setRawText(e.target.value)
                                    }),
                                    React.createElement('button', {
                                        onClick: processText,
                                        className: "mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-slate-900 w-full btn-hover-effect flex justify-center gap-2 items-center"
                                    }, [
                                        React.createElement(Icons.Upload, { key: 'icon', size: 16 }),
                                        ' Procesar Lista'
                                    ])
                                ])
                            ]),
                            React.createElement('div', { key: 'list' }, [
                                React.createElement('h4', {
                                    className: "font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider"
                                }, `Catálogo Actual (${medicines.length})`),
                                React.createElement('div', {
                                    className: "h-full max-h-[400px] overflow-y-auto border rounded-xl bg-white p-2 space-y-1"
                                }, medicines.map((m, i) => 
                                    React.createElement('div', {
                                        key: i,
                                        className: "text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 uppercase"
                                    }, m.name)
                                ))
                            ])
                        ])
                    ]),
                    // SECCIÓN CONTACT CENTER
                    React.createElement('div', { key: 'contacts' }, [
                        React.createElement('h4', {
                            className: "font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider flex items-center gap-2 border-b pb-2"
                        }, [
                            React.createElement(Icons.Phone, { key: 'icon', size: 16 }),
                            ' Contact Center'
                        ]),
                        React.createElement('div', {
                            className: "grid grid-cols-1 md:grid-cols-2 gap-8"
                        }, [
                            React.createElement('div', {
                                className: "bg-slate-50 p-4 rounded-xl border border-slate-100 h-fit"
                            }, [
                                React.createElement('h4', {
                                    className: "font-bold text-slate-700 mb-4 text-xs uppercase tracking-wider"
                                }, 'Nuevo Agente'),
                                React.createElement('form', {
                                    onSubmit: handleAddContact,
                                    className: "space-y-4"
                                }, [
                                    React.createElement('div', { key: 'name' }, [
                                        React.createElement('label', {
                                            className: "text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1"
                                        }, 'Nombre'),
                                        React.createElement('input', {
                                            type: "text",
                                            value: cName,
                                            onChange: e => setCName(e.target.value),
                                            className: "w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400",
                                            placeholder: "Ej: Karla",
                                            required: true
                                        })
                                    ]),
                                    React.createElement('div', { key: 'phone' }, [
                                        React.createElement('label', {
                                            className: "text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1"
                                        }, 'Teléfono'),
                                        React.createElement('input', {
                                            type: "text",
                                            value: cPhone,
                                            onChange: e => setCPhone(e.target.value),
                                            className: "w-full p-2.5 rounded-lg border border-slate-200 text-sm outline-none focus:border-turquoise-400",
                                            placeholder: "Ej: 9988-7766",
                                            required: true
                                        })
                                    ]),
                                    React.createElement('button', {
                                        type: "submit",
                                        className: "w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-xs hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm"
                                    }, [
                                        React.createElement(Icons.Save, { key: 'icon', size: 16 }),
                                        ' Guardar Agente'
                                    ])
                                ])
                            ]),
                            React.createElement('div', { key: 'contacts-list' }, [
                                React.createElement('h4', {
                                    className: "font-bold text-slate-700 mb-2 text-xs uppercase tracking-wider"
                                }, `Agentes Activos (${contacts?.length || 0})`),
                                React.createElement('div', {
                                    className: "border rounded-xl bg-white p-2 max-h-60 overflow-y-auto space-y-1"
                                }, contacts && contacts.length > 0 ? contacts.map(c => 
                                    React.createElement('div', {
                                        key: c.id,
                                        className: "text-xs p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0 flex justify-between items-center group"
                                    }, [
                                        React.createElement('div', {
                                            key: 'info',
                                            className: "flex items-center gap-2"
                                        }, [
                                            React.createElement('div', {
                                                className: "w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-[10px]"
                                            }, c.name.substring(0,2).toUpperCase()),
                                            React.createElement('span', {
                                                className: "font-medium text-slate-700"
                                            }, `${c.name} `, React.createElement('span', { className: "text-slate-400 mx-1" }, '---'), ` ${c.phone}`)
                                        ]),
                                        React.createElement('button', {
                                            key: 'delete',
                                            onClick: () => onDeleteContact(c.id),
                                            className: "text-slate-300 hover:text-red-500 p-1 rounded hover:bg-red-50 transition"
                                        }, React.createElement(Icons.Trash, { size: 14 }))
                                    ])
                                ) : React.createElement('div', {
                                    className: "text-center text-slate-300 text-xs py-4 italic"
                                }, 'No hay agentes configurados'))
                            ])
                        ])
                    ])
                ])
            ]);
        };

        // --- BLOCK: USUARIOS ---
        const UserManagementBlock = ({ users, onAddUser, onUpdateUser, onDeleteUser }) => {
            const [formData, setFormData] = useState({ username: '', password: '', role: 'digitador', nombre: '' });
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);

            const openNew = () => { 
                setEditingId(null); 
                setFormData({ username: '', password: '', role: 'digitador', nombre: '' }); 
                setShowModal(true); 
            };
            
            const openEdit = (u) => { 
                setEditingId(u.id); 
                setFormData(u); 
                setShowModal(true); 
            };
            
            const closeModal = () => { 
                setShowModal(false); 
                setEditingId(null); 
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const uData = {...formData, departamento: 'Operaciones'};
                if (editingId) {
                    onUpdateUser(editingId, uData);
                } else {
                    onAddUser(uData);
                }
                closeModal();
            };

            return React.createElement('div', {
                className: "glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white"
            }, [
                React.createElement(ConfirmModal, {
                    key: 'confirm-modal',
                    isOpen: !!confirmData,
                    onClose: () => setConfirmData(null),
                    onConfirm: confirmData?.action,
                    title: confirmData?.title,
                    message: confirmData?.msg
                }),
                React.createElement('div', {
                    key: 'header',
                    className: "p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center"
                }, [
                    React.createElement('div', {
                        className: "flex items-center gap-4"
                    }, [
                        React.createElement('div', {
                            className: "bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"
                        }, React.createElement(Icons.UserCog, { size: 24 })),
                        React.createElement('div', null, [
                            React.createElement('h3', {
                                className: "font-bold text-xl text-slate-800 brand-font"
                            }, 'Usuarios'),
                            React.createElement('p', {
                                className: "text-xs font-semibold text-turquoise-600"
                            }, `${users.length} Activos`)
                        ])
                    ]),
                    React.createElement('button', {
                        onClick: openNew,
                        className: "flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"
                    }, [
                        React.createElement(Icons.Plus, { key: 'icon', size: 16 }),
                        React.createElement('span', { key: 'text', className: "hidden sm:inline" }, 'Nuevo Usuario')
                    ])
                ]),
                React.createElement(Modal, {
                    key: 'user-modal',
                    isOpen: showModal,
                    onClose: closeModal,
                    title: editingId ? "Editar Usuario" : "Nuevo Usuario"
                }, React.createElement('form', {
                    onSubmit: handleSubmit,
                    className: "space-y-4"
                }, [
                    React.createElement('div', { key: 'nombre' }, [
                        React.createElement('label', {
                            className: "text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1"
                        }, 'Nombre Completo'),
                        React.createElement('input', {
                            type: "text",
                            className: "w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500",
                            value: formData.nombre,
                            onChange: e => setFormData({...formData, nombre: e.target.value}),
                            required: true
                        })
                    ]),
                    React.createElement('div', { key: 'username' }, [
                        React.createElement('label', {
                            className: "text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1"
                        }, 'Usuario (Login)'),
                        React.createElement('input', {
                            type: "text",
                            className: "w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500",
                            value: formData.username,
                            onChange: e => setFormData({...formData, username: e.target.value.toLowerCase()}),
                            required: true
                        })
                    ]),
                    React.createElement('div', { key: 'password' }, [
                        React.createElement('label', {
                            className: "text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1"
                        }, 'Contraseña'),
                        React.createElement('input', {
                            type: "password",
                            className: "w-full p-2.5 rounded-xl border border-slate-200 text-sm outline-none focus:border-turquoise-500",
                            value: formData.password,
                            onChange: e => setFormData({...formData, password: e.target.value}),
                            placeholder: editingId ? "Dejar vacío para mantener" : "",
                            required: !editingId
                        })
                    ]),
                    React.createElement('div', { key: 'role' }, [
                        React.createElement('label', {
                            className: "text-[10px] font-bold text-slate-400 uppercase tracking-wide block mb-1"
                        }, 'Rol'),
                        React.createElement('select', {
                            className: "w-full p-2.5 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:border-turquoise-500",
                            value: formData.role,
                            onChange: e => setFormData({...formData, role: e.target.value})
                        }, [
                            React.createElement('option', { key: 'digitador', value: "digitador" }, 'Digitador'),
                            React.createElement('option', { key: 'admin', value: "admin" }, 'Administrador'),
                            React.createElement('option', { key: 'superadmin', value: "superadmin" }, 'Super Admin')
                        ])
                    ]),
                    React.createElement('button', {
                        type: "submit",
                        className: "w-full bg-turquoise-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-turquoise-700 btn-hover-effect mt-4"
                    }, editingId ? 'Actualizar' : 'Crear Usuario')
                ])),
                React.createElement('div', {
                    key: 'content',
                    className: "flex-1 overflow-y-auto p-6 bg-slate-50"
                }, React.createElement('div', {
                    className: "grid gap-3 sm:grid-cols-2 md:grid-cols-3"
                }, users.map(u => 
                    React.createElement('div', {
                        key: u.id,
                        className: "p-4 rounded-xl border border-slate-200 flex flex-col gap-3 bg-white hover:shadow-md transition-shadow relative group"
                    }, [
                        React.createElement('div', {
                            key: 'header',
                            className: "flex items-center gap-3"
                        }, [
                            React.createElement('div', {
                                className: `w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${u.role === 'digitador' ? 'bg-clinical-500' : 'bg-turquoise-600'}`
                            }, u.username.substring(0,2).toUpperCase()),
                            React.createElement('div', { key: 'info' }, [
                                React.createElement('div', {
                                    className: "font-bold text-sm text-slate-800"
                                }, u.nombre || u.username),
                                React.createElement('div', {
                                    className: "text-[10px] text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded w-fit mt-1"
                                }, `@${u.username} • ${u.role}`)
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'actions',
                            className: "border-t border-slate-100 pt-2 flex justify-end gap-2"
                        }, [
                            React.createElement('button', {
                                key: 'edit',
                                onClick: () => openEdit(u),
                                className: "p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-lg transition-colors",
                                title: "Editar"
                            }, React.createElement(Icons.Edit, { size: 18 })),
                            React.createElement('button', {
                                key: 'delete',
                                onClick: () => setConfirmData({ 
                                    title: 'Eliminar Usuario', 
                                    msg: `¿Desea eliminar a ${u.username}?`, 
                                    action: () => onDeleteUser(u.id) 
                                }),
                                className: "p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors",
                                title: "Eliminar"
                            }, React.createElement(Icons.Trash, { size: 18 }))
                        ])
                    ])
                )))
            ]);
        };

        // --- BLOCK: DASHBOARD ---
        const DashboardBlock = ({ setView, stats, userName, role }) => { 
            const [time, setTime] = useState(new Date());
            useEffect(() => { 
                const t = setInterval(() => setTime(new Date()), 1000); 
                return () => clearInterval(t); 
            }, []);
            
            const allCards = [
                { id: 'reports', label: 'Reportes y Carpetas', icon: Icons.List, color: 'bg-amber-500', desc: 'Ver kits por fecha', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'pacientes', label: 'Gestión de Pacientes', icon: Icons.Users, color: 'bg-turquoise-500', desc: 'Crear kits por DH', allowed: ['admin', 'superadmin', 'digitador'] },
                { id: 'config', label: 'Configuración', icon: Icons.Settings, color: 'bg-slate-500', desc: 'Catálogos del Sistema', allowed: ['admin', 'superadmin'] },
                { id: 'users', label: 'Gestión de Usuarios', icon: Icons.UserCog, color: 'bg-indigo-500', desc: 'Control de accesos', allowed: ['admin', 'superadmin'] },
            ];

            const visibleCards = allCards.filter(c => c.allowed.includes(role));

            return React.createElement('div', {
                className: "w-full max-w-6xl mx-auto space-y-8 animate-in"
            }, [
                React.createElement('div', {
                    key: 'header',
                    className: "bg-gradient-to-r from-turquoise-600 to-clinical-600 rounded-3xl p-8 text-white shadow-lg relative overflow-hidden"
                }, [
                    React.createElement('div', {
                        key: 'content',
                        className: "relative z-10"
                    }, [
                        React.createElement('h1', {
                            key: 'title',
                            className: "text-3xl font-bold brand-font mb-2"
                        }, `¡Hola, ${userName}!`),
                        React.createElement('p', {
                            key: 'subtitle',
                            className: "opacity-90 text-sm font-medium uppercase tracking-wider"
                        }, 'Operaciones - Bitácora de Producción')
                    ]),
                    React.createElement('div', {
                        key: 'decoration',
                        className: "absolute right-0 top-0 h-full w-1/2 bg-white/10 skew-x-12 transform origin-bottom-right"
                    })
                ]),
                React.createElement('div', {
                    key: 'stats',
                    className: "grid grid-cols-1 md:grid-cols-3 gap-6"
                }, [
                    React.createElement('div', {
                        key: 'time',
                        className: "bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex flex-col justify-center items-center text-center"
                    }, [
                        React.createElement('div', {
                            key: 'clock',
                            className: "text-5xl font-mono font-bold text-slate-700 tracking-widest mb-2"
                        }, time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})),
                        React.createElement('div', {
                            key: 'date',
                            className: "text-sm text-slate-400 font-medium uppercase"
                        }, time.toLocaleDateString([], {weekday:'long', day:'numeric', month:'long'}))
                    ]),
                    React.createElement('div', {
                        key: 'kits-stats',
                        className: "md:col-span-2 grid grid-cols-2 gap-4"
                    }, [
                        React.createElement('div', {
                            key: 'total',
                            className: "bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4"
                        }, [
                            React.createElement('div', {
                                key: 'icon',
                                className: "p-4 bg-turquoise-50 text-turquoise-600 rounded-2xl"
                            }, React.createElement(Icons.Box, { size: 32 })),
                            React.createElement('div', { key: 'numbers' }, [
                                React.createElement('div', {
                                    key: 'value',
                                    className: "text-3xl font-bold text-slate-800"
                                }, React.createElement(AnimatedCounter, { value: stats.totalKits })),
                                React.createElement('div', {
                                    key: 'label',
                                    className: "text-xs text-slate-400 font-bold uppercase"
                                }, 'Kits Totales')
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'today',
                            className: "bg-white p-6 rounded-3xl shadow-soft border border-slate-100 flex items-center gap-4"
                        }, [
                            React.createElement('div', {
                                key: 'icon',
                                className: "p-4 bg-clinical-50 text-clinical-600 rounded-2xl"
                            }, React.createElement(Icons.Calendar, { size: 32 })),
                            React.createElement('div', { key: 'numbers' }, [
                                React.createElement('div', {
                                    key: 'value',
                                    className: "text-3xl font-bold text-slate-800"
                                }, React.createElement(AnimatedCounter, { value: stats.todayKits })),
                                React.createElement('div', {
                                    key: 'label',
                                    className: "text-xs text-slate-400 font-bold uppercase"
                                }, 'Armados Hoy')
                            ])
                        ])
                    ])
                ]),
                React.createElement('h3', {
                    key: 'shortcuts-title',
                    className: "text-xl font-bold text-slate-700 brand-font mt-8"
                }, 'Accesos Directos'),
                React.createElement('div', {
                    key: 'shortcuts',
                    className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
                }, visibleCards.map(c => 
                    React.createElement('button', {
                        key: c.id,
                        onClick: () => setView(c.id),
                        className: "group relative bg-white p-6 rounded-3xl shadow-soft border border-slate-100 hover:shadow-xl transition-all duration-300 text-left hover:-translate-y-1 overflow-hidden"
                    }, [
                        React.createElement('div', {
                            key: 'decoration',
                            className: `absolute top-0 right-0 w-24 h-24 ${c.color} opacity-10 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110`
                        }),
                        React.createElement('div', {
                            key: 'icon',
                            className: `w-12 h-12 rounded-2xl ${c.color} flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`
                        }, React.createElement(c.icon, { size: 24 })),
                        React.createElement('h4', {
                            key: 'title',
                            className: "font-bold text-lg text-slate-800 mb-1 group-hover:text-turquoise-600 transition-colors"
                        }, c.label),
                        React.createElement('p', {
                            key: 'desc',
                            className: "text-xs text-slate-400"
                        }, c.desc)
                    ])
                ))
            ]);
        };

        // --- BLOCK: REPORTES ---
        const ReportsBlock = ({ kits, patients, userRole, userName }) => {
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedDay, setSelectedDay] = useState(null);
            const [selectedKit, setSelectedKit] = useState(null);
            const [showKitModal, setShowKitModal] = useState(false);
            
            const [showAIModal, setShowAIModal] = useState(false);
            const [prompt, setPrompt] = useState('');
            const [generating, setGenerating] = useState(false);
            const [savedReports, setSavedReports] = useState([]);
            const [aiStatus, setAiStatus] = useState('');

            const groupedByMonth = useMemo(() => {
                const groups = {};
                kits.forEach(kit => {
                    if (!kit.fechaArmado) return;
                    const date = new Date(kit.fechaArmado);
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const dayKey = kit.fechaArmado;
                    
                    if (!groups[monthKey]) {
                        groups[monthKey] = {
                            name: monthKey,
                            display: date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }),
                            days: {}
                        };
                    }
                    
                    if (!groups[monthKey].days[dayKey]) {
                        groups[monthKey].days[dayKey] = {
                            date: dayKey,
                            display: date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' }),
                            kits: []
                        };
                    }
                    
                    groups[monthKey].days[dayKey].kits.push(kit);
                });
                return groups;
            }, [kits]);

            // Cargar reportes guardados
            useEffect(() => {
                if (userRole === 'admin' || userRole === 'superadmin') {
                    const unsub = db.collection('prod_reports').onSnapshot(snapshot => {
                        const reports = snapshot.docs.map(doc => ({ 
                            id: doc.id, 
                            ...doc.data(),
                            createdAtFormatted: doc.data().createdAt?.toDate?.().toLocaleDateString('es-ES') 
                        })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        setSavedReports(reports);
                    });
                    return () => unsub();
                }
            }, [userRole]);

            const handleBack = () => {
                if (selectedKit) {
                    setSelectedKit(null);
                } else if (selectedDay) {
                    setSelectedDay(null);
                } else if (selectedMonth) {
                    setSelectedMonth(null);
                }
            };

            const currentMonth = `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`;

            return React.createElement('div', {
                className: "glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white"
            }, [
                // Header
                React.createElement('div', {
                    key: 'header',
                    className: "p-6 border-b border-slate-100 bg-white/50 backdrop-blur-md flex justify-between items-center"
                }, [
                    React.createElement('div', {
                        key: 'title',
                        className: "flex items-center gap-4"
                    }, [
                        React.createElement('button', {
                            key: 'back',
                            onClick: handleBack,
                            className: `p-2 rounded-xl transition-colors ${selectedMonth ? 'hover:bg-slate-100 text-slate-500' : 'opacity-0 pointer-events-none'}`
                        }, React.createElement(Icons.ArrowLeft, { size: 20 })),
                        React.createElement('div', { key: 'text' }, [
                            React.createElement('h3', {
                                key: 'title-text',
                                className: "font-bold text-xl text-slate-800 brand-font"
                            }, selectedKit ? 'Detalle del Kit' : 
                               selectedDay ? `Kits del ${selectedDay}` :
                               selectedMonth ? (groupedByMonth[selectedMonth]?.display || '') :
                               'Reportes y Carpetas'),
                            React.createElement('p', {
                                key: 'subtitle',
                                className: "text-xs font-semibold text-turquoise-600"
                            }, selectedKit ? 'Información completa' :
                               selectedDay ? `${groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.length || 0} Kits` :
                               selectedMonth ? `${Object.keys(groupedByMonth[selectedMonth]?.days || {}).length} días` :
                               `${Object.keys(groupedByMonth).length} meses, ${kits.length} kits totales`)
                        ])
                    ]),
                    (userRole === 'admin' || userRole === 'superadmin') && !selectedKit && !selectedDay && 
                    React.createElement('button', {
                        key: 'ai-button',
                        onClick: () => setShowAIModal(true),
                        className: "flex items-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect"
                    }, [
                        React.createElement(Icons.Bot, { key: 'icon', size: 16 }),
                        ' Generar con IA'
                    ])
                ]),
                
                // Contenido principal
                React.createElement('div', {
                    key: 'content',
                    className: "flex-1 overflow-y-auto p-6 bg-slate-50"
                }, selectedKit ? 
                    // Vista de detalle del kit
                    React.createElement('div', {
                        className: "text-center py-10 text-slate-400"
                    }, 'Redirigiendo a modal de detalles...')
                : selectedDay ? 
                    // Lista de kits del día seleccionado
                    React.createElement('div', {
                        className: "space-y-4"
                    }, React.createElement('div', {
                        className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                    }, groupedByMonth[selectedMonth]?.days[selectedDay]?.kits.map(kit => 
                        React.createElement('div', {
                            key: kit.id,
                            onClick: () => { setSelectedKit(kit); setShowKitModal(true); },
                            className: "bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer transition-all group"
                        }, [
                            React.createElement('div', {
                                key: 'header',
                                className: "flex justify-between items-start mb-3"
                            }, [
                                React.createElement('div', {
                                    key: 'name',
                                    className: "font-bold text-slate-800 text-sm truncate"
                                }, kit.nombre),
                                React.createElement('span', {
                                    key: 'mode',
                                    className: `px-2 py-1 rounded text-xs font-bold ${kit.deliveryMode === 'ruta' ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`
                                }, kit.deliveryMode === 'ruta' ? 'Ruta' : 'Ventanilla')
                            ]),
                            React.createElement('div', {
                                key: 'details',
                                className: "space-y-2"
                            }, [
                                React.createElement('div', {
                                    key: 'id',
                                    className: "text-xs text-slate-500 flex items-center gap-2"
                                }, [
                                    React.createElement('span', {
                                        key: 'dni',
                                        className: "font-mono bg-slate-100 px-2 py-0.5 rounded"
                                    }, kit.dni),
                                    React.createElement('span', {
                                        key: 'meds',
                                        className: "text-turquoise-600 font-bold"
                                    }, `${kit.triggerMeds} meds`)
                                ]),
                                React.createElement('div', {
                                    key: 'footer',
                                    className: "text-xs text-slate-400 flex justify-between"
                                }, [
                                    React.createElement('span', { key: 'time' }, kit.horaOperaciones || '--:--'),
                                    React.createElement('span', { key: 'digitador' }, kit.digitador)
                                ]),
                                kit.isRefrigerated && React.createElement('div', {
                                    key: 'refri',
                                    className: "text-xs text-blue-600 font-bold flex items-center gap-1"
                                }, [
                                    React.createElement(Icons.Box, { key: 'icon', size: 12 }),
                                    ' Refrigerado'
                                ])
                            ])
                        ])
                    ))
                : selectedMonth ? 
                    // Vista de días del mes seleccionado
                    React.createElement('div', {
                        className: "space-y-6"
                    }, React.createElement('div', {
                        className: "grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"
                    }, Object.entries(groupedByMonth[selectedMonth]?.days || {}).sort((a, b) => b[0].localeCompare(a[0])).map(([date, dayData]) => 
                        React.createElement('div', {
                            key: date,
                            onClick: () => setSelectedDay(date),
                            className: "bg-white p-4 rounded-xl border border-slate-200 hover:border-turquoise-400 hover:shadow-md cursor-pointer flex flex-col items-center text-center gap-3 transition-all group"
                        }, [
                            React.createElement('div', {
                                key: 'icon',
                                className: "bg-turquoise-100 p-3 rounded-full text-turquoise-600 group-hover:scale-110 transition-transform"
                            }, React.createElement(Icons.Calendar, { size: 24 })),
                            React.createElement('div', { key: 'info' }, [
                                React.createElement('h4', {
                                    key: 'date',
                                    className: "font-bold text-sm text-slate-700"
                                }, dayData.display),
                                React.createElement('p', {
                                    key: 'count',
                                    className: "text-[10px] text-slate-400 mt-1"
                                }, `${dayData.kits.length} Kits`)
                            ])
                        ])
                    ))
                : 
                    // Vista principal - Carpetas por mes
                    React.createElement('div', {
                        className: "space-y-6"
                    }, [
                        React.createElement('div', {
                            key: 'months',
                            className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
                        }, Object.entries(groupedByMonth).sort((a, b) => b[0].localeCompare(a[0])).map(([monthKey, monthData]) => 
                            React.createElement('div', {
                                key: monthKey,
                                onClick: () => setSelectedMonth(monthKey),
                                className: "bg-white p-6 rounded-2xl border border-slate-200 hover:border-turquoise-400 hover:shadow-lg cursor-pointer flex flex-col items-center text-center gap-4 transition-all group"
                            }, [
                                React.createElement('div', {
                                    key: 'icon',
                                    className: "bg-gradient-to-br from-turquoise-500 to-clinical-500 p-4 rounded-2xl text-white group-hover:scale-110 transition-transform"
                                }, React.createElement(Icons.Folder, { size: 32 })),
                                React.createElement('div', { key: 'info' }, [
                                    React.createElement('h4', {
                                        key: 'title',
                                        className: "font-bold text-lg text-slate-800"
                                    }, monthData.display),
                                    React.createElement('p', {
                                        key: 'stats',
                                        className: "text-sm text-slate-400 mt-1"
                                    }, `${Object.keys(monthData.days).length} días • ${Object.values(monthData.days).reduce((acc, day) => acc + day.kits.length, 0)} kits`)
                                ]),
                                React.createElement('div', {
                                    key: 'tag',
                                    className: "text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full"
                                }, monthKey === currentMonth ? 'MES ACTUAL' : 'HISTÓRICO')
                            ])
                        ))
                    ])
                )
            ]);
        };

        // --- BLOCK: PACIENTES ---
        const PatientManagementBlock = ({ patients, kits, medicines, onAddPatient, onUpdatePatient, onDeletePatient, onSaveKit, onDeleteKit, currentUser, userRole, contacts }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [showPatientForm, setShowPatientForm] = useState(false);
            const [editingPatientId, setEditingPatientId] = useState(null);
            const [confirmData, setConfirmData] = useState(null);
            
            // Estados para Impresión
            const [printKitData, setPrintKitData] = useState(null);
            const [printMode, setPrintMode] = useState(null);
            const [printOrientation, setPrintOrientation] = useState('vertical');
            const [showPrintModal, setShowPrintModal] = useState(false);

            // Estados para visualización
            const [isViewMode, setIsViewMode] = useState(false);

            // Kit Form State
            const initialKit = { 
                fechaArmado: new Date().toISOString().split('T')[0], 
                fechaEntregaLogistica: '', 
                fechaEntregaKit: '', 
                horaOperaciones: '', 
                contactCenter: '', 
                triggerMeds: '', 
                medicamentos: [],
                digitador: '',
                deliveryMode: '', 
                selectedPhones: [], 
                otherPhoneEnabled: false, 
                otherPhone: '',
                addressConfirmed: true, 
                secondaryAddress: '',
                gpsStatus: 'SIN GPS', 
                observationsEnabled: false,
                observations: '',
                isRefrigerated: false, 
                cantRefriGlobal: '' 
            };
            const [kitData, setKitData] = useState(initialKit);
            const [showKitForm, setShowKitForm] = useState(false);
            const [editingKitId, setEditingKitId] = useState(null);

            // Patient Form State
            const initialPatient = { 
                dni: '', 
                nombre: '', 
                telefono: '', 
                direccion: '', 
                familiar: '', 
                telefonoFamiliar: '', 
                descripcionMunicipio: '', 
                tipoAfiliado: 'AFILIADO DIRECTO',
                nAfiliacion: '' 
            };
            const [patientForm, setPatientForm] = useState(initialPatient);

            const filteredPatients = patients.filter(p => 
                (p.nombre?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                 p.dni?.includes(searchTerm))
            );
            const patientKits = selectedPatient ? kits.filter(k => k.patientId === selectedPatient.id) : [];

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = window.XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = window.XLSX.utils.sheet_to_json(ws);
                        
                        let added = 0;
                        let skipped = 0;
                        let updated = 0;

                        for (const row of data) {
                            const pData = {
                                dni: String(row['DNI'] || row['dni'] || '').trim(),
                                nombre: String(row['NOMBRE'] || row['nombre'] || '').toUpperCase().trim(),
                                telefono: String(row['TELEFONO'] || row['telefono'] || '').trim(),
                                direccion: String(row['DIRECCION'] || row['direccion'] || '').toUpperCase().trim(),
                                familiar: String(row['FAMILIAR'] || row['familiar'] || '').toUpperCase().trim(),
                                telefonoFamiliar: String(row['TELEFONOFAMILIAR'] || row['telefonofamiliar'] || '').trim(),
                                descripcionMunicipio: String(row['DESCRIPCION_MUNICIPIO'] || row['descripcion_municipio'] || '').toUpperCase().trim(),
                                tipoAfiliado: String(row['TIPOAFILIADO'] || row['tipoafiliado'] || 'AFILIADO DIRECTO').toUpperCase().trim(),
                                nAfiliacion: String(row['DNI'] || row['dni'] || '').trim() 
                            };

                            if (!pData.dni) continue;

                            const existingPatient = patients.find(p => p.dni === pData.dni);

                            if (existingPatient) {
                                let needsUpdate = false;
                                const updates = {};
                                const checkAndFill = (field) => {
                                    const dbValue = existingPatient[field];
                                    const excelValue = pData[field];
                                    if ((!dbValue || dbValue.trim() === '') && (excelValue && excelValue.trim() !== '')) {
                                        updates[field] = excelValue;
                                        needsUpdate = true;
                                    }
                                };
                                checkAndFill('nombre'); checkAndFill('telefono'); checkAndFill('direccion');
                                checkAndFill('familiar'); checkAndFill('telefonoFamiliar'); checkAndFill('descripcionMunicipio');
                                
                                if ((!existingPatient.tipoAfiliado || existingPatient.tipoAfiliado === 'AFILIADO DIRECTO') && pData.tipoAfiliado && pData.tipoAfiliado !== 'AFILIADO DIRECTO') {
                                    updates.tipoAfiliado = pData.tipoAfiliado; 
                                    needsUpdate = true;
                                }

                                if (needsUpdate) { 
                                    await onUpdatePatient(existingPatient.id, updates); 
                                    updated++; 
                                } else { 
                                    skipped++; 
                                }
                            } else {
                                await onAddPatient(pData); 
                                added++;
                            }
                        }
                        alert(`Resumen de Carga:\n\n✅ Pacientes Agregados: ${added}\n🔄 Pacientes Modificados: ${updated}\n⏭️ Pacientes Omitidos: ${skipped}`);
                    } catch (error) {
                        console.error('Error procesando Excel:', error);
                        alert('Error al procesar el archivo Excel. Verifique el formato.');
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = null; 
            };

            const handlePatientSubmit = (e) => { 
                e.preventDefault(); 
                if (editingPatientId) {
                    onUpdatePatient(editingPatientId, patientForm); 
                } else {
                    onAddPatient(patientForm); 
                }
                closePatientForm(); 
            };
            
            const closePatientForm = () => { 
                setPatientForm(initialPatient); 
                setEditingPatientId(null); 
                setShowPatientForm(false); 
            };
            
            const openEditPatient = (e, p) => { 
                e.stopPropagation(); 
                setPatientForm(p); 
                setEditingPatientId(p.id); 
                setShowPatientForm(true); 
            };

            const handleKitSubmit = (e) => {
                e.preventDefault();
                if (isViewMode) { 
                    closeKitForm(); 
                    return; 
                } 
                const finalData = { 
                    ...kitData, 
                    digitador: currentUser.name, 
                    dni: selectedPatient.dni, 
                    nombre: selectedPatient.nombre 
                }; 
                
                if (!editingKitId && !finalData.horaOperaciones) {
                    finalData.horaOperaciones = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
                }
                
                if (editingKitId) {
                    onSaveKit(editingKitId, finalData, selectedPatient.id, true);
                } else {
                    onSaveKit(null, finalData, selectedPatient.id, false);
                }
                closeKitForm();
            };
            
            const closeKitForm = () => { 
                setKitData(initialKit); 
                setEditingKitId(null); 
                setShowKitForm(false); 
                setIsViewMode(false); 
            };
            
            const openNewKit = () => {
                setKitData({ ...initialKit, fechaArmado: new Date().toISOString().split('T')[0] });
                setIsViewMode(false);
                setShowKitForm(true);
            };
            
            const openEditKit = (k, viewOnly = false) => { 
                setKitData({...k, otherPhoneEnabled: !!k.otherPhone}); 
                setEditingKitId(k.id); 
                setIsViewMode(viewOnly);
                setShowKitForm(true); 
            };

            const openPrintModal = (kit) => {
                setPrintKitData(kit);
                setShowPrintModal(true);
            };

            const handleMedChange = (idx, field, val) => {
                const newMeds = [...kitData.medicamentos];
                newMeds[idx] = { ...newMeds[idx], [field]: val };
                setKitData({...kitData, medicamentos: newMeds});
            };
            
            const handleTriggerMeds = (val) => {
                const parsed = parseInt(val, 10);
                const count = isNaN(parsed) ? 0 : parsed;
                const safeCount = Math.min(Math.max(count, 0), 30);
                const currentMeds = kitData.medicamentos || [];
                let newMeds = [];
                if (safeCount > currentMeds.length) {
                    newMeds = [...currentMeds, ...Array(safeCount - currentMeds.length).fill({ nombre: '', idReceta: '', cantidad: '', cantRefri: '' })];
                } else {
                    newMeds = currentMeds.slice(0, safeCount);
                }
                setKitData({...kitData, triggerMeds: val, medicamentos: newMeds});
            };

            const togglePhoneSelection = (phone) => {
                const current = kitData.selectedPhones || [];
                if(current.includes(phone)) {
                    setKitData({...kitData, selectedPhones: current.filter(p => p !== phone)});
                } else {
                    setKitData({...kitData, selectedPhones: [...current, phone]});
                }
            };

            if (selectedPatient) {
                return React.createElement('div', {
                    className: "glass-panel rounded-3xl shadow-soft h-full flex flex-col animate-in border-0 bg-white"
                }, [
                    React.createElement(ConfirmModal, {
                        key: 'confirm-modal',
                        isOpen: !!confirmData,
                        onClose: () => setConfirmData(null),
                        onConfirm: confirmData?.action,
                        title: confirmData?.title,
                        message: confirmData?.msg
                    }),
                    
                    // Header
                    React.createElement('div', {
                        key: 'header',
                        className: "px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20"
                    }, [
                        React.createElement('div', {
                            key: 'back',
                            className: "flex items-center gap-3"
                        }, [
                            React.createElement('button', {
                                onClick: () => setSelectedPatient(null),
                                className: "p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors btn-hover-effect"
                            }, React.createElement(Icons.ArrowLeft, { size: 20 })),
                            React.createElement('div', { key: 'title' }, [
                                React.createElement('h3', {
                                    className: "font-bold text-lg text-slate-800 brand-font leading-none"
                                }, selectedPatient.nombre),
                                React.createElement('p', {
                                    className: "text-[10px] text-slate-400 font-mono mt-0.5"
                                }, `DNI: ${selectedPatient.dni}`)
                            ])
                        ]),
                        React.createElement('button', {
                            key: 'new-kit',
                            onClick: openNewKit,
                            className: "flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-xs shadow-md transition-all btn-hover-effect bg-turquoise-600 hover:bg-turquoise-700 text-white"
                        }, [
                            React.createElement(Icons.FolderPlus, { key: 'icon', size: 16 }),
                            ' Nuevo Kit'
                        ])
                    ]),

                    // Contenido principal
                    React.createElement('div', {
                        key: 'content',
                        className: "flex-1 overflow-y-auto p-6 bg-slate-50/50"
                    }, [
                        React.createElement('div', {
                            key: 'patient-info',
                            className: "bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 p-5 relative z-10"
                        }, [
                            React.createElement('div', {
                                key: 'header',
                                className: "flex justify-between items-center mb-4 border-b border-slate-100 pb-3"
                            }, [
                                React.createElement('h2', {
                                    key: 'title',
                                    className: "text-xl font-bold text-slate-800"
                                }, 'Historial de Producción'),
                                React.createElement('div', {
                                    key: 'count',
                                    className: "text-2xl font-bold text-turquoise-600"
                                }, `${patientKits.length} `, React.createElement('span', {
                                    className: "text-sm text-slate-400 font-normal"
                                }, 'Kits'))
                            ]),
                            React.createElement('div', {
                                key: 'details',
                                className: "grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"
                            }, [
                                React.createElement('div', { key: 'type' }, [
                                    React.createElement('span', {
                                        className: "text-[10px] font-bold text-slate-400 block"
                                    }, 'Tipo Afiliado'),
                                    selectedPatient.tipoAfiliado
                                ]),
                                React.createElement('div', {
                                    key: 'address',
                                    className: "md:col-span-3"
                                }, [
                                    React.createElement('span', {
                                        className: "text-[10px] font-bold text-slate-400 block"
                                    }, 'Domicilio'),
                                    selectedPatient.direccion
                                ])
                            ])
                        ]),
                        React.createElement('div', {
                            key: 'kits-list',
                            className: "grid gap-3"
                        }, patientKits.length > 0 ? patientKits.map(kit => 
                            React.createElement('div', {
                                key: kit.id,
                                className: "p-4 rounded-xl border border-slate-100 bg-white shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-4 relative group"
                            }, [
                                React.createElement('div', {
                                    key: 'info',
                                    className: "flex-1"
                                }, [
                                    React.createElement('div', {
                                        key: 'badges',
                                        className: "flex flex-wrap items-center gap-2 mb-2"
                                    }, [
                                        React.createElement('span', {
                                            key: 'date',
                                            className: "bg-turquoise-50 text-turquoise-700 px-2 py-1 rounded text-xs font-bold border border-turquoise-100"
                                        }, [
                                            React.createElement(Icons.Calendar, { key: 'icon', size: 12, className: "inline mr-1" }),
                                            ` ${kit.fechaArmado}`
                                        ]),
                                        React.createElement('span', {
                                            key: 'mode',
                                            className: `px-2 py-1 rounded text-xs font-bold border ${kit.deliveryMode==='ruta'?'bg-emerald-50 text-emerald-700 border-emerald-100':'bg-indigo-50 text-indigo-700 border-indigo-100'}`
                                        }, kit.deliveryMode === 'ruta' ? 'RUTA' : 'VENTANILLA'),
                                        React.createElement('span', {
                                            key: 'time',
                                            className: "text-xs text-slate-400 font-mono"
                                        }, `Hora Ops: ${kit.horaOperaciones || '--:--'}`)
                                    ]),
                                    React.createElement('div', {
                                        key: 'meds',
                                        className: "mt-2 flex flex-wrap gap-1"
                                    }, kit.medicamentos?.slice(0,4).map((m,i) => 
                                        React.createElement('span', {
                                            key: i,
                                            className: "text-[10px] bg-slate-50 text-slate-600 px-2 py-0.5 rounded border"
                                        }, `${m.nombre} (${m.cantidad})`)
                                    ), (kit.medicamentos?.length > 4) && 
                                        React.createElement('span', {
                                            key: 'more',
                                            className: "text-[10px] text-slate-400 px-1"
                                        }, '...'))
                                ]),
                                React.createElement('div', {
                                    key: 'actions',
                                    className: "flex gap-2 justify-end sm:justify-center items-start"
                                }, [
                                    React.createElement('button', {
                                        key: 'view',
                                        onClick: () => openEditKit(kit, true),
                                        className: "text-slate-300 hover:text-blue-500 p-2 btn-hover-effect",
                                        title: "Ver Detalle"
                                    }, React.createElement(Icons.Search, { size: 18 })),
                                    React.createElement('button', {
                                        key: 'print',
                                        onClick: () => openPrintModal(kit),
                                        className: "text-slate-300 hover:text-slate-700 p-2 btn-hover-effect",
                                        title: "Imprimir"
                                    }, React.createElement(Icons.Printer, { size: 18 })),
                                    React.createElement('button', {
                                        key: 'edit',
                                        onClick: () => openEditKit(kit, false),
                                        className: "text-slate-300 hover:text-orange-500 p-2 btn-hover-effect",
                                        title: "Editar"
                                    }, React.createElement(Icons.Edit, { size: 18 })),
                                    (userRole==='superadmin'||userRole==='admin') && 
                                    React.createElement('button', {
                                        key: 'delete',
                                        onClick: () => { if(window.confirm("¿Eliminar Kit?")) onDeleteKit(kit.id); },
                                        className: "text-slate-300 hover:text-red-500 p-2 btn-hover-effect",
                                        title: "Eliminar"
                                    }, React.createElement(Icons.Trash, { size: 18 }))
                                ])
                            ])
                        ) : React.createElement('div', {
                            key: 'empty',
                            className: "text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"
                        }, 'No hay kits registrados para este paciente.'))
                    ])
                ]);
            }

            return React.createElement('div', {
                className: "glass-panel rounded-3xl shadow-soft flex flex-col h-full animate-in overflow-hidden border-0 bg-white"
            }, [
                React.createElement(ConfirmModal, {
                    key: 'confirm-modal',
                    isOpen: !!confirmData,
                    onClose: () => setConfirmData(null),
                    onConfirm: confirmData?.action,
                    title: confirmData?.title,
                    message: confirmData?.msg
                }),
                React.createElement('div', {
                    key: 'header',
                    className: "p-6 border-b border-slate-100 flex flex-col md:flex-row gap-4 justify-between items-center bg-white/50 backdrop-blur-md"
                }, [
                    React.createElement('div', {
                        key: 'title',
                        className: "flex items-center gap-4 w-full md:w-auto"
                    }, [
                        React.createElement('div', {
                            className: "bg-turquoise-100 p-3 rounded-2xl text-turquoise-600"
                        }, React.createElement(Icons.Users, { size: 24 })),
                        React.createElement('div', null, [
                            React.createElement('h3', {
                                className: "font-bold text-xl text-slate-800 brand-font"
                            }, 'Gestión de Pacientes'),
                            React.createElement('p', {
                                className: "text-xs font-semibold text-turquoise-600"
                            }, `${filteredPatients.length} Registros`)
                        ])
                    ]),
                    React.createElement('div', {
                        key: 'actions',
                        className: "flex gap-3 w-full md:w-auto items-center"
                    }, [
                        React.createElement('div', {
                            key: 'search',
                            className: "relative w-full sm:w-64"
                        }, [
                            React.createElement('div', {
                                className: "absolute left-3 top-2.5 text-slate-400"
                            }, React.createElement(Icons.Search, { size: 16 })),
                            React.createElement('input', {
                                type: "text",
                                placeholder: "Buscar DNI o Nombre...",
                                className: "w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl text-sm outline-none border border-transparent focus:border-turquoise-200 transition-all focus:shadow-sm",
                                value: searchTerm,
                                onChange: e => setSearchTerm(e.target.value)
                            })
                        ]),
                        (userRole === 'admin' || userRole === 'superadmin') && 
                        React.createElement('div', {
                            key: 'upload',
                            className: "relative overflow-hidden"
                        }, [
                            React.createElement('button', {
                                key: 'button',
                                className: "flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"
                            }, [
                                React.createElement(Icons.FileSpreadsheet, { key: 'icon', size: 16 }),
                                React.createElement('span', { key: 'text', className: "hidden sm:inline" }, 'Cargar DH')
                            ]),
                            React.createElement('input', {
                                key: 'file-input',
                                type: "file",
                                accept: ".xlsx, .xls",
                                onChange: handleExcelUpload,
                                className: "absolute inset-0 opacity-0 cursor-pointer"
                            })
                        ]),
                        React.createElement('button', {
                            key: 'new',
                            onClick: () => setShowPatientForm(true),
                            className: "flex items-center gap-2 bg-turquoise-600 hover:bg-turquoise-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs shadow-md whitespace-nowrap transition-all btn-hover-effect"
                        }, [
                            React.createElement(Icons.Plus, { key: 'icon', size: 16 }),
                            React.createElement('span', { key: 'text', className: "hidden sm:inline" }, 'Nuevo')
                        ])
                    ])
                ]),
                React.createElement('div', {
                    key: 'content',
                    className: "h-full overflow-y-auto bg-white p-6"
                }, React.createElement('div', {
                    className: "overflow-x-auto"
                }, React.createElement('table', {
                    className: "w-full text-left border-collapse min-w-[800px]"
                }, [
                    React.createElement('thead', {
                        key: 'thead',
                        className: "bg-slate-50/80 sticky top-0 z-10"
                    }, React.createElement('tr', {
                        className: "text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100"
                    }, [
                        React.createElement('th', { key: 'name', className: "px-6 py-4 pl-8" }, 'Paciente'),
                        React.createElement('th', { key: 'id', className: "px-6 py-4" }, 'Identificación'),
                        React.createElement('th', { key: 'kits', className: "px-6 py-4 text-center" }, 'N° Kits'),
                        React.createElement('th', { key: 'actions', className: "px-6 py-4 text-right pr-8" }, 'Acción')
                    ])),
                    React.createElement('tbody', {
                        key: 'tbody',
                        className: "divide-y divide-slate-50"
                    }, filteredPatients.map(p => {
                        const countKits = kits.filter(k => k.patientId === p.id).length;
                        return React.createElement('tr', {
                            key: p.id,
                            onClick: () => setSelectedPatient(p),
                            className: "row-hover-effect cursor-pointer"
                        }, [
                            React.createElement('td', {
                                key: 'name',
                                className: "px-6 py-5 pl-8"
                            }, [
                                React.createElement('div', {
                                    key: 'name-text',
                                    className: "font-bold text-base text-slate-800 tracking-tight"
                                }, p.nombre),
                                React.createElement('div', {
                                    key: 'detail-link',
                                    className: "text-xs text-turquoise-600 font-medium mt-1 flex items-center gap-1"
                                }, [
                                    'Ver Detalle ',
                                    React.createElement(Icons.ChevronsRight, { key: 'icon', size: 14 })
                                ])
                            ]),
                            React.createElement('td', {
                                key: 'id',
                                className: "px-6 py-5"
                            }, [
                                React.createElement('div', {
                                    key: 'dni',
                                    className: "text-xs font-mono text-slate-600 bg-slate-100 px-2 py-1 rounded w-fit mb-1 font-bold"
                                }, p.dni),
                                React.createElement('div', {
                                    key: 'type',
                                    className: "text-xs text-slate-400"
                                }, p.tipoAfiliado)
                            ]),
                            React.createElement('td', {
                                key: 'kits-count',
                                className: "px-6 py-5 text-center"
                            }, React.createElement('span', {
                                className: "bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold"
                            }, countKits)),
                            React.createElement('td', {
                                key: 'actions',
                                className: "px-6 py-5 text-right pr-8",
                                onClick: e => e.stopPropagation()
                            }, React.createElement('div', {
                                className: "flex justify-end gap-2"
                            }, [
                                React.createElement('button', {
                                    key: 'edit',
                                    onClick: (e) => openEditPatient(e, p),
                                    className: "text-slate-300 hover:text-orange-500 p-2 btn-hover-effect"
                                }, React.createElement(Icons.Edit, { size: 20 })),
                                (userRole==='superadmin'||userRole==='admin') && 
                                React.createElement('button', {
                                    key: 'delete',
                                    onClick: () => setConfirmData({ 
                                        title: 'Eliminar', 
                                        msg: `¿Eliminar a ${p.nombre}?`, 
                                        action: () => onDeletePatient(p.id) 
                                    }),
                                    className: "text-slate-300 hover:text-red-500 p-2 btn-hover-effect"
                                }, React.createElement(Icons.Trash, { size: 20 }))
                            ]))
                        ]);
                    }))
                ])))
            ]);
        };

        // --- MAIN APP ---
        const App = () => {
            const [role, setRole] = useState(sessionStorage.getItem('leq_role'));
            const [userName, setUserName] = useState(sessionStorage.getItem('leq_username'));
            const [view, setView] = useState('dashboard');
            
            const [patients, setPatients] = useState([]);
            const [kits, setKits] = useState([]);
            const [medicines, setMedicines] = useState([]);
            const [contacts, setContacts] = useState([]);
            const [users, setUsers] = useState([]);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); 
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            const handleLogout = () => { 
                if (auth) auth.signOut(); 
                sessionStorage.clear(); 
                setRole(null); 
                setUserName(null); 
            };
            
            const handleLogin = (r, n) => { 
                setRole(r); 
                setUserName(n); 
                sessionStorage.setItem('leq_role', r); 
                sessionStorage.setItem('leq_username', n); 
            };

            useEffect(() => {
                if (!role || !db) return;
                
                const unsubPatients = db.collection('prod_patients').onSnapshot(s => 
                    setPatients(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)))
                );
                
                const unsubKits = db.collection('prod_kits').onSnapshot(s => 
                    setKits(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.fechaArmado) - new Date(a.fechaArmado)))
                );
                
                const unsubMeds = db.collection('prod_medicines').onSnapshot(s => 
                    setMedicines(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name)))
                );
                
                const unsubContacts = db.collection('prod_contacts').onSnapshot(s => 
                    setContacts(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name)))
                );
                
                let unsubUsers = () => {};
                if (role === 'admin' || role === 'superadmin') {
                    unsubUsers = db.collection('prod_users').onSnapshot(s => 
                        setUsers(s.docs.map(d => ({id: d.id, ...d.data()})))
                    );
                }
                
                return () => {
                    unsubPatients();
                    unsubKits();
                    unsubMeds();
                    unsubContacts();
                    unsubUsers();
                };
            }, [role]);

            const addPatient = async (d) => {
                try {
                    const docRef = await db.collection('prod_patients').add({
                        ...d, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return docRef.id;
                } catch (error) {
                    console.error("Error añadiendo paciente:", error);
                    throw error;
                }
            };
            
            const updatePatient = async (id, d) => {
                try {
                    await db.collection('prod_patients').doc(id).update(d);
                } catch (error) {
                    console.error("Error actualizando paciente:", error);
                    throw error;
                }
            };
            
            const deletePatient = async (id) => {
                try {
                    await db.collection('prod_patients').doc(id).delete();
                } catch (error) {
                    console.error("Error eliminando paciente:", error);
                    throw error;
                }
            };
            
            const saveKit = async (id, data, pid, isUpdate) => {
                try {
                    if (isUpdate) {
                        await db.collection('prod_kits').doc(id).update(data);
                    } else {
                        await db.collection('prod_kits').add({
                            ...data, 
                            patientId: pid, 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } catch (error) {
                    console.error("Error guardando kit:", error);
                    throw error;
                }
            };
            
            const deleteKit = async (id) => {
                try {
                    await db.collection('prod_kits').doc(id).delete();
                } catch (error) {
                    console.error("Error eliminando kit:", error);
                    throw error;
                }
            };
            
            const addMedsList = async (list) => {
                try {
                    for (const name of list) {
                        await db.collection('prod_medicines').add({ name });
                    }
                } catch (error) {
                    console.error("Error añadiendo medicamentos:", error);
                    throw error;
                }
            };
            
            const addContact = async (name, phone) => {
                try {
                    await db.collection('prod_contacts').add({ name, phone });
                } catch (error) {
                    console.error("Error añadiendo contacto:", error);
                    throw error;
                }
            };
            
            const deleteContact = async (id) => {
                try {
                    await db.collection('prod_contacts').doc(id).delete();
                } catch (error) {
                    console.error("Error eliminando contacto:", error);
                    throw error;
                }
            };

            const addUser = async (u) => {
                try {
                    await db.collection('prod_users').add(u);
                } catch (error) {
                    console.error("Error añadiendo usuario:", error);
                    throw error;
                }
            };
            
            const updateUser = async (id, u) => {
                try {
                    await db.collection('prod_users').doc(id).update(u);
                } catch (error) {
                    console.error("Error actualizando usuario:", error);
                    throw error;
                }
            };
            
            const deleteUser = async (id) => {
                try {
                    await db.collection('prod_users').doc(id).delete();
                } catch (error) {
                    console.error("Error eliminando usuario:", error);
                    throw error;
                }
            };

            if (!role) {
                return React.createElement(LoginBlock, { onLogin: handleLogin });
            }

            const stats = { 
                totalKits: kits.length, 
                todayKits: kits.filter(k => k.fechaArmado === new Date().toISOString().split('T')[0]).length 
            };

            return React.createElement('div', {
                className: "flex h-screen bg-[#f0fdfa] font-sans overflow-hidden"
            }, [
                // Mobile Header
                mobileMenuOpen && React.createElement('div', {
                    key: 'mobile-menu',
                    className: "fixed inset-0 z-50 bg-turquoise-900/95 backdrop-blur-sm flex flex-col md:hidden animate-in"
                }, [
                    React.createElement('div', {
                        key: 'mobile-header',
                        className: "p-4 flex justify-between items-center border-b border-turquoise-800"
                    }, [
                        React.createElement('div', {
                            key: 'title',
                            className: "font-bold text-white text-xl flex items-center gap-2 brand-font"
                        }, [
                            React.createElement(Icons.Activity, { key: 'icon' }),
                            ' LEQ Móvil'
                        ]),
                        React.createElement('button', {
                            key: 'close',
                            onClick: () => setMobileMenuOpen(false),
                            className: "text-white p-2 bg-turquoise-800 rounded-full btn-hover-effect"
                        }, React.createElement(Icons.X, { size: 24 }))
                    ]),
                    React.createElement('div', {
                        key: 'mobile-nav',
                        className: "p-6 space-y-4"
                    }, [
                        React.createElement('button', {
                            key: 'dashboard',
                            onClick: () => { setView('dashboard'); setMobileMenuOpen(false); },
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold ${view === 'dashboard' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'}`
                        }, [
                            React.createElement(Icons.LayoutDashboard, { key: 'icon', size: 20 }),
                            'Dashboard'
                        ]),
                        React.createElement('button', {
                            key: 'reports',
                            onClick: () => { setView('reports'); setMobileMenuOpen(false); },
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold ${view === 'reports' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'}`
                        }, [
                            React.createElement(Icons.List, { key: 'icon', size: 20 }),
                            'Reportes'
                        ]),
                        React.createElement('button', {
                            key: 'pacientes',
                            onClick: () => { setView('pacientes'); setMobileMenuOpen(false); },
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold ${view === 'pacientes' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'}`
                        }, [
                            React.createElement(Icons.Users, { key: 'icon', size: 20 }),
                            'Pacientes'
                        ]),
                        (role === 'admin' || role === 'superadmin') && 
                        React.createElement('button', {
                            key: 'config',
                            onClick: () => { setView('config'); setMobileMenuOpen(false); },
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold ${view === 'config' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'}`
                        }, [
                            React.createElement(Icons.Settings, { key: 'icon', size: 20 }),
                            'Configuración'
                        ]),
                        (role === 'admin' || role === 'superadmin') && 
                        React.createElement('button', {
                            key: 'users',
                            onClick: () => { setView('users'); setMobileMenuOpen(false); },
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold ${view === 'users' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'}`
                        }, [
                            React.createElement(Icons.UserCog, { key: 'icon', size: 20 }),
                            'Usuarios'
                        ]),
                        React.createElement('div', {
                            key: 'logout-mobile',
                            className: "pt-8 border-t border-turquoise-800"
                        }, React.createElement('button', {
                            onClick: handleLogout,
                            className: "w-full flex items-center gap-4 px-4 py-3 rounded-2xl bg-turquoise-800 text-white font-bold btn-hover-effect"
                        }, [
                            React.createElement(Icons.LogOut, { key: 'icon', size: 20 }),
                            ' Desconectar'
                        ]))
                    ])
                ]),
                
                // Sidebar
                React.createElement('aside', {
                    key: 'sidebar',
                    className: `${sidebarCollapsed ? 'w-24' : 'w-72'} bg-turquoise-900 text-turquoise-100 flex-col shadow-2xl z-20 hidden md:flex relative transition-all duration-300 ease-in-out`
                }, [
                    React.createElement('div', {
                        key: 'sidebar-header',
                        className: `p-6 pb-2 relative z-10 flex ${sidebarCollapsed ? 'justify-center' : 'justify-between'} items-center`
                    }, [
                        !sidebarCollapsed && React.createElement('div', {
                            key: 'logo',
                            className: "flex items-center gap-3 text-white"
                        }, [
                            React.createElement('div', {
                                className: "bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg"
                            }, React.createElement(Icons.Activity, { size: 24, className: "text-white" })),
                            React.createElement('span', {
                                className: "font-bold text-2xl brand-font animate-in"
                            }, 'Bitácora')
                        ]),
                        sidebarCollapsed && React.createElement('div', {
                            key: 'logo-collapsed',
                            className: "bg-gradient-to-br from-turquoise-400 to-clinical-400 p-2 rounded-xl shadow-lg mb-2"
                        }, React.createElement(Icons.Activity, { size: 24, className: "text-white" })),
                        React.createElement('button', {
                            key: 'toggle',
                            onClick: () => setSidebarCollapsed(!sidebarCollapsed),
                            className: "text-turquoise-400 hover:text-white transition-colors p-1 rounded-lg hover:bg-turquoise-800 absolute right-4 top-6 btn-hover-effect",
                            style: sidebarCollapsed ? { right: 'auto', top: 'auto', marginTop: '10px', position: 'static' } : {}
                        }, sidebarCollapsed ? 
                            React.createElement(Icons.ChevronsRight, { size: 20 }) : 
                            React.createElement(Icons.ArrowLeft, { size: 20 })
                        )
                    ]),
                    !sidebarCollapsed && React.createElement('div', {
                        key: 'sidebar-title',
                        className: "text-xs font-bold text-turquoise-400 uppercase tracking-widest pl-14 mb-4 animate-in"
                    }, 'Producción'),
                    React.createElement('nav', {
                        key: 'nav',
                        className: "flex-1 px-4 py-4 space-y-2 relative z-10 overflow-y-auto overflow-x-hidden"
                    }, [
                        React.createElement('button', {
                            key: 'nav-dashboard',
                            onClick: () => setView('dashboard'),
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold relative overflow-hidden btn-hover-effect ${view === 'dashboard' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`
                        }, [
                            React.createElement(Icons.LayoutDashboard, {
                                size: 20,
                                className: view === 'dashboard' ? 'text-white' : 'text-turquoise-400'
                            }),
                            !sidebarCollapsed && React.createElement('span', {
                                className: "whitespace-nowrap transition-opacity duration-300 block opacity-100"
                            }, 'Dashboard')
                        ]),
                        React.createElement('button', {
                            key: 'nav-reports',
                            onClick: () => setView('reports'),
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold relative overflow-hidden btn-hover-effect ${view === 'reports' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`
                        }, [
                            React.createElement(Icons.List, {
                                size: 20,
                                className: view === 'reports' ? 'text-white' : 'text-turquoise-400'
                            }),
                            !sidebarCollapsed && React.createElement('span', {
                                className: "whitespace-nowrap transition-opacity duration-300 block opacity-100"
                            }, 'Reportes')
                        ]),
                        React.createElement('button', {
                            key: 'nav-pacientes',
                            onClick: () => setView('pacientes'),
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold relative overflow-hidden btn-hover-effect ${view === 'pacientes' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`
                        }, [
                            React.createElement(Icons.Users, {
                                size: 20,
                                className: view === 'pacientes' ? 'text-white' : 'text-turquoise-400'
                            }),
                            !sidebarCollapsed && React.createElement('span', {
                                className: "whitespace-nowrap transition-opacity duration-300 block opacity-100"
                            }, 'Pacientes')
                        ]),
                        (role === 'admin' || role === 'superadmin') && 
                        React.createElement('button', {
                            key: 'nav-config',
                            onClick: () => setView('config'),
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold relative overflow-hidden btn-hover-effect ${view === 'config' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`
                        }, [
                            React.createElement(Icons.Settings, {
                                size: 20,
                                className: view === 'config' ? 'text-white' : 'text-turquoise-400'
                            }),
                            !sidebarCollapsed && React.createElement('span', {
                                className: "whitespace-nowrap transition-opacity duration-300 block opacity-100"
                            }, 'Configuración')
                        ]),
                        (role === 'admin' || role === 'superadmin') && 
                        React.createElement('button', {
                            key: 'nav-users',
                            onClick: () => setView('users'),
                            className: `w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl transition-all font-bold relative overflow-hidden btn-hover-effect ${view === 'users' ? 'bg-gradient-to-r from-turquoise-500 to-turquoise-600 text-white shadow-lg' : 'hover:bg-turquoise-800/50 text-turquoise-300'} ${sidebarCollapsed ? 'justify-center' : ''}`
                        }, [
                            React.createElement(Icons.UserCog, {
                                size: 20,
                                className: view === 'users' ? 'text-white' : 'text-turquoise-400'
                            }),
                            !sidebarCollapsed && React.createElement('span', {
                                className: "whitespace-nowrap transition-opacity duration-300 block opacity-100"
                            }, 'Usuarios')
                        ])
                    ]),
                    React.createElement('div', {
                        key: 'sidebar-footer',
                        className: "p-4 mx-4 mb-4 rounded-2xl bg-turquoise-800/50 border border-turquoise-700/50 relative z-10"
                    }, [
                        React.createElement('div', {
                            key: 'user-info',
                            className: `flex items-center gap-3 mb-4 ${sidebarCollapsed ? 'justify-center flex-col' : ''}`
                        }, [
                            React.createElement('div', {
                                className: "w-10 h-10 rounded-full bg-gradient-to-br from-clinical-400 to-clinical-600 flex items-center justify-center font-bold text-white text-sm shrink-0"
                            }, role === 'admin' ? 'AD' : 'OP'),
                            !sidebarCollapsed && React.createElement('div', {
                                className: "overflow-hidden"
                            }, [
                                React.createElement('div', {
                                    className: "text-sm font-bold text-white capitalize truncate"
                                }, userName),
                                React.createElement('div', {
                                    className: "text-[10px] text-turquoise-300 truncate"
                                }, 'En línea')
                            ])
                        ]),
                        React.createElement('button', {
                            key: 'logout',
                            onClick: handleLogout,
                            className: `w-full flex items-center gap-2 text-xs font-bold text-turquoise-200 hover:text-white py-2.5 rounded-xl hover:bg-turquoise-700 transition-colors btn-hover-effect ${sidebarCollapsed ? 'justify-center' : 'justify-center'}`,
                            title: "Desconectar"
                        }, [
                            React.createElement(Icons.LogOut, { key: 'icon', size: 16 }),
                            !sidebarCollapsed && React.createElement('span', { key: 'text' }, 'Salir')
                        ])
                    ])
                ]),
                
                // Main Content
                React.createElement('main', {
                    key: 'main',
                    className: "flex-1 flex flex-col h-full overflow-hidden bg-[#f0fdfa] relative transition-all duration-300"
                }, [
                    React.createElement('div', {
                        key: 'mobile-topbar',
                        className: "md:hidden bg-white/80 backdrop-blur-md p-4 shadow-sm flex justify-between items-center z-20"
                    }, [
                        React.createElement('button', {
                            key: 'menu',
                            onClick: () => setMobileMenuOpen(true),
                            className: "text-slate-600 p-1 btn-hover-effect"
                        }, React.createElement(Icons.Menu, { size: 24 })),
                        React.createElement('div', {
                            key: 'mobile-title',
                            className: "font-bold text-slate-800 flex items-center gap-2 brand-font"
                        }, [
                            React.createElement(Icons.Activity, { key: 'icon', size: 18, className: "text-turquoise-600" }),
                            ' LEQ Móvil'
                        ]),
                        React.createElement('div', { key: 'spacer', className: "w-8" })
                    ]),
                    React.createElement('div', {
                        key: 'content',
                        className: "flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative z-10"
                    }, 
                        view === 'dashboard' ? 
                            React.createElement(DashboardBlock, {
                                key: 'dashboard',
                                setView: setView,
                                stats: stats,
                                userName: userName,
                                role: role
                            }) : 
                        view === 'reports' ? 
                            React.createElement(ReportsBlock, {
                                key: 'reports',
                                kits: kits,
                                patients: patients,
                                userRole: role,
                                userName: userName
                            }) : 
                        view === 'pacientes' ? 
                            React.createElement(PatientManagementBlock, {
                                key: 'pacientes',
                                patients: patients,
                                kits: kits,
                                medicines: medicines,
                                onAddPatient: addPatient,
                                onUpdatePatient: updatePatient,
                                onDeletePatient: deletePatient,
                                onSaveKit: saveKit,
                                onDeleteKit: deleteKit,
                                currentUser: {name: userName, role: role},
                                userRole: role,
                                contacts: contacts
                            }) : 
                        view === 'config' && (role === 'admin' || role === 'superadmin') ? 
                            React.createElement(ConfigBlock, {
                                key: 'config',
                                medicines: medicines,
                                onAddList: addMedsList,
                                contacts: contacts,
                                onAddContact: addContact,
                                onDeleteContact: deleteContact
                            }) : 
                        view === 'users' && (role === 'admin' || role === 'superadmin') ? 
                            React.createElement(UserManagementBlock, {
                                key: 'users',
                                users: users,
                                onAddUser: addUser,
                                onUpdateUser: updateUser,
                                onDeleteUser: deleteUser
                            }) : 
                            null
                    )
                ])
            ]);
        };

        // Renderizar la aplicación
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
